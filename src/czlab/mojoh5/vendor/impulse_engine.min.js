!function(t){"use strict";if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/impulse_engine/core"]=function(){return function(i,s){const o=t["io/czlab/mcfud/geo2d"](),e=t["io/czlab/mcfud/math"](),n=t["io/czlab/mcfud/gfx"](),{u:r,is:l}=i;class c{constructor(t,i,s,o){this.m00=t,this.m01=i,this.m10=s,this.m11=o,void 0===t&&this.set(0)}clone(){return new c(this.m00,this.m01,this.m10,this.m11)}set(t){let i=Math.cos(t),s=Math.sin(t);return this.m00=i,this.m01=-s,this.m10=s,this.m11=i,this}abs(){return new c(Math.abs(this.m00),Math.abs(this.m01),Math.abs(this.m10),Math.abs(this.m11))}axisX(){return s.vec(this.m00,this.m10)}axisY(){return s.vec(this.m01,this.m11)}transpose(){return new c(this.m00,this.m10,this.m01,this.m11)}}c.mul=function(t,i){return l.vec(i)?s.vec(t.m00*i[0]+t.m01*i[1],t.m10*i[0]+t.m11*i[1]):new c(t.m00*i.m00+t.m01*i.m10,t.m00*i.m01+t.m01*i.m11,t.m10*i.m00+t.m11*i.m10,t.m10*i.m01+t.m11*i.m11)};const h={ePoly:100,eCircle:200,Mat2:c,dt:1/60,gravity:s.vec(0,50)};return t["io/czlab/impulse_engine/shape"](h,i,e,s,n,o),t["io/czlab/impulse_engine/body"](h,i,e,s),t["io/czlab/impulse_engine/manifold"](h,i,e,s),t["io/czlab/impulse_engine/collision"](h,i,e,s),t["io/czlab/impulse_engine/scene"](h,i,e,s,n,o),h}(t["io/czlab/mcfud/core"](),t["io/czlab/mcfud/vec2"]())}}(this),function(t){"use strict";if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/impulse_engine/shape"]=function(t,i,s,o,e,n){return function(t,i,s,o,e,n){const{Mat2:r}=t,{u:l}=i;class c{constructor(){this.body=null,this.u=new r}isCircular(){return!1}}class h extends c{constructor(t){super(),this.radius=t}isCircular(){return!0}getAABB(){let t=this.body.position[0]+this.radius,i=this.body.position[0]-this.radius,s=this.body.position[1]+this.radius,o=this.body.position[1]-this.radius;return new n.Rect(i,o,t-i,s-o)}clone(){return new h(this.radius)}initialize(){this.computeMass(1)}computeMass(t){let i=this.radius*this.radius;this.body.m=Math.PI*i*t,this.body.I=this.body.m*i,this.body.im=this.body.m?1/this.body.m:0,this.body.iI=this.body.I?1/this.body.I:0}setOrient(t){return this.u.set(t),this}draw(t){t.save(),t.strokeStyle=this.body.rgb,e.drawCircle(t,this.body.position[0],this.body.position[1],this.radius);let i=r.mul(this.u,o.vec(1,0));i=o.mul(i,this.radius),i=o.add(i,this.body.position),t.strokeStyle="green",e.drawLine(t,this.body.position[0],this.body.position[1],i[0],i[1]),t.restore()}getType(){return t.eCircle}}class u extends c{constructor(){super(),this.points=[],this.normals=[]}getAABB(){let t=this._calcPoints(),i=1/0,s=1/0,o=-1/0,e=-1/0;for(let n,r=0;r<t.length;++r)n=t[r],n[0]<i&&(i=n[0]),n[0]>o&&(o=n[0]),n[1]<s&&(s=n[1]),n[1]>e&&(e=n[1]);return new n.Rect(i,s,o-i,e-s)}initialize(){return this.computeMass(1),this}clone(){let t=new u;t.u=this.u.clone();for(let i=0;i<this.points.length;++i)t.points[i]=o.clone(this.points[i]),t.normals[i]=o.clone(this.normals[i]);return t}computeMass(t){let i=o.vec(),s=0,e=0;const n=1/3,r=this.points.length;for(let t=0;t<r;++t){let l=this.points[t],c=(t+1)%r,h=this.points[c],u=o.cross(l,h),a=.5*u;s+=a,i=o.add(i,o.mul(o.add(l,h),a*n)),e+=.25*n*u*(l[0]*l[0]+h[0]*l[0]+h[0]*h[0]+(l[1]*l[1]+h[1]*l[1]+h[1]*h[1]))}i=o.mul(i,1/s);for(let t=0;t<r;++t)o.sub$(this.points[t],i);return this.body.m=t*s,this.body.im=this.body.m?1/this.body.m:0,this.body.I=e*t,this.body.iI=this.body.I?1/this.body.I:0,this}setOrient(t){return this.u.set(t),this}_calcPoints(){let t=[];for(let i=0;i<this.points.length;++i)t.push(o.add(this.body.position,r.mul(this.u,this.points[i])));return t}draw(t){t.save(),t.strokeStyle=this.body.rgb,e.drawPoints(t,this._calcPoints()),t.restore()}getType(){return t.ePoly}setBox(t,i){return this.normals.length=0,this.points.length=0,this.points[0]=o.vec(-t,-i),this.points[1]=o.vec(t,-i),this.points[2]=o.vec(t,i),this.points[3]=o.vec(-t,i),this.normals[0]=o.vec(0,-1),this.normals[1]=o.vec(1,0),this.normals[2]=o.vec(0,1),this.normals[3]=o.vec(-1,0),this}set(t){let i=t.length;l.assert(i>2&&i<=64);let e=0,n=t[0][0];for(let o,r=1;r<i;++r)o=t[r][0],o>n?(n=o,e=r):s.fuzzyEq(o,n)&&t[r][1]<t[e][1]&&(e=r);let r=new Array(64),c=0,h=e;for(;;){r[c]=h;let n=0;for(let e=1;e<i;++e){if(n===h){n=e;continue}let i=o.sub(t[n],t[r[c]]),l=o.sub(t[e],t[r[c]]),u=o.cross(i,l);u<0&&(n=e),s.fuzzyZero(u)&&o.len2(l)>o.len2(i)&&(n=e)}if(++c,h=n,n===e)break}this.normals.length=0,this.points.length=0;for(let i=0;i<c;++i)this.points[i]=t[r[i]].slice();for(let t=0;t<c;++t){let i=(t+1)%c,e=o.sub(this.points[i],this.points[t]);o.len2(e)>s.EPSILON*s.EPSILON&&l.assert(!1,"face too short"),this.normals[t]=o.unit(o.vec(e[1],-e[0]))}return this}getSupport(t){let i,s=-1/0;for(let e,n,r=0;r<this.points.length;++r)n=this.points[r],e=o.dot(n,t),e>s&&(i=n,s=e);return i}}return l.inject(t,{Circle:h,Polygon:u})}(t,i,s,o,e,n)}}(this),function(t){"use strict";if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/impulse_engine/body"]=function(t,i,s,o){return function(t,i,s,o){const{u:e}=i;return e.inject(t,{Body:class{constructor(t,i,s){this.shape=t,this.shape.body=this,this.position=o.vec(i,s),this.velocity=o.vec(),this.angularVelocity=0,this.torque=0,this.rgb="blue",this.force=o.vec(),this.staticFriction=.5,this.dynamicFriction=.3,this.restitution=.2,this.orient=e.randFloat(-Math.PI,Math.PI),this.shape.isCircular()&&(this.rgb="magenta"),this.shape.initialize()}applyForce(t){return this.force=o.add(this.force,t),this}applyImpulse(t,i){return o.add$(this.velocity,o.mul(t,this.im)),this.angularVelocity+=this.iI*o.cross(i,t),this}setStatic(){return this.I=0,this.iI=0,this.m=0,this.im=0,this}setOrient(t){return this.orient=t,this.shape.setOrient(t),this}}})}(t,i,0,o)}}(this),function(t){"use strict";if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/impulse_engine/manifold"]=function(t,i,s,o){return function(t,i,s,o){const{u:e}=i;return e.inject(t,{Manifold:class{constructor(t,i){this.A=t,this.B=i,this.penetration=0,this.normal=o.vec(),this.contacts=[o.vec(),o.vec()],this.contact_count=0,this.e=0,this.df=0,this.sf=0}solve(){return t.dispatch(this.A.shape.getType(),this.B.shape.getType()).call(t,this,this.A,this.B),this}initialize(){this.e=Math.min(this.A.restitution,this.B.restitution),this.sf=Math.sqrt(this.A.staticFriction*this.B.staticFriction),this.df=Math.sqrt(this.A.dynamicFriction*this.B.dynamicFriction);for(let i=0;i<this.contact_count;++i){let e=o.sub(this.contacts[i],this.A.position),n=o.sub(this.contacts[i],this.B.position),r=o.add(this.B.velocity,o.cross(this.B.angularVelocity,n));r=o.sub(o.sub(r,this.A.velocity),o.cross(this.A.angularVelocity,e)),o.len2(r)<o.len2(o.mul(t.gravity,t.dt))+s.EPSILON&&(this.e=0)}return this}applyImpulse(){if(s.fuzzyZero(this.A.im+this.B.im))return this.infiniteMassCorrection(),this;for(let t=0;t<this.contact_count;++t){let i=o.sub(this.contacts[t],this.A.position),e=o.sub(this.contacts[t],this.B.position),n=o.add(this.B.velocity,o.cross(this.B.angularVelocity,e));n=o.sub(o.sub(n,this.A.velocity),o.cross(this.A.angularVelocity,i));let r=o.dot(n,this.normal);if(r>0)return this;let l=o.cross(i,this.normal),c=o.cross(e,this.normal),h=this.A.im+this.B.im+l*l*this.A.iI+c*c*this.B.iI,u=-(1+this.e)*r;u/=h,u/=this.contact_count;let a=o.mul(this.normal,u);this.A.applyImpulse(o.flip(a),i),this.B.applyImpulse(a,e),n=o.add(this.B.velocity,o.cross(this.B.angularVelocity,e)),n=o.sub(o.sub(n,this.A.velocity),o.cross(this.A.angularVelocity,i));let d=o.sub(n,o.mul(this.normal,o.dot(n,this.normal)));d=o.unit(d);let m,p=-o.dot(n,d);if(p/=h,p/=this.contact_count,s.fuzzyZero(p))return this;m=Math.abs(p)<u*this.sf?o.mul(d,p):o.mul(d,-u*this.df),this.A.applyImpulse(o.flip(m),i),this.B.applyImpulse(m,e)}return this}positionalCorrection(){let t=o.mul(this.normal,Math.max(this.penetration-.05,0)/(this.A.im+this.B.im)*.4);return o.sub$(this.A.position,o.mul(t,this.A.im)),o.add$(this.B.position,o.mul(t,this.B.im)),this}infiniteMassCorrection(){return o.copy(this.A.velocity,0,0),o.copy(this.B.velocity,0,0),this}}})}(t,i,s,o)}}(this),function(t){"use strict";function i(t,i,s,o){const{Mat2:e}=t,{u:n}=i,r={dispatch:function(i,s){return i===t.eCircle?s===t.eCircle?this.circleCircle:this.circlePolygon:i===t.ePoly?s===t.eCircle?this.polygonCircle:this.polygonPolygon:void 0},circleCircle:function(t,i,e){let n=i.shape,r=e.shape,l=o.sub(e.position,i.position),c=o.len2(l),h=n.radius+r.radius;if(c>=h*h)return void(t.contact_count=0);let u=Math.sqrt(c);t.contact_count=1,s.fuzzyZero(u)?(t.penetration=n.radius,t.normal=o.vec(1,0),o.set(t.contacts[0],i.position)):(t.penetration=h-u,t.normal=o.div(l,u),o.set(t.contacts[0],o.add(o.mul(t.normal,n.radius),i.position)))},circlePolygon:function(i,s,n){let r=s.shape,l=n.shape;i.contact_count=0;let c=e.mul(l.u.transpose(),o.sub(s.position,n.position)),h=-1/0,u=0;for(let t=0;t<l.points.length;++t){let i=o.dot(l.normals[t],o.sub(c,l.points[t]));if(i>r.radius)return;i>h&&(h=i,u=t)}let a=l.points[u],d=(u+1)%l.points.length,m=l.points[d];if(h<t.EPSILON)return i.contact_count=1,i.normal=o.flip(e.mul(l.u,l.normals[u])),o.set(i.contacts[0],o.add(o.mul(i.normal,r.radius),s.position)),void(i.penetration=r.radius);let p=o.dot(o.sub(c,a),o.sub(m,a)),f=o.dot(o.sub(c,m),o.sub(a,m));if(i.penetration=r.radius-h,p<=0){if(o.dist2(c,a)>r.radius*r.radius)return;i.contact_count=1;let t=o.sub(a,c);i.normal=o.unit(e.mul(l.u,t)),o.set(i.contacts[0],o.add(e.mul(l.u,a),n.position))}else if(f<=0){if(o.dist2(c,m)>r.radius*r.radius)return;i.contact_count=1;let t=o.sub(m,c);i.normal=o.unit(e.mul(l.u,t)),o.set(i.contacts[0],o.add(e.mul(l.u,m),n.position))}else{let t=l.normals[u];if(o.dot(o.sub(c,a),t)>r.radius)return;i.normal=o.flip(e.mul(l.u,t)),o.set(i.contacts[0],o.add(o.mul(i.normal,r.radius),s.position)),i.contact_count=1}}};function l(t,i){let s,n=-1/0;for(let r=0;r<t.points.length;++r){let l=t.normals[r],c=t.points[r],h=e.mul(t.u,l),u=i.u.transpose();l=e.mul(u,h);let a=i.getSupport(o.flip(l));c=o.add(e.mul(t.u,c),t.body.position),o.sub$(c,i.body.position),c=e.mul(u,c);let d=o.dot(l,o.sub(a,c));d>n&&(n=d,s=r)}return[n,s]}function c(t,i,s){let e=[s[0],s[1]],r=0,l=o.dot(t,s[0])-i,c=o.dot(t,s[1])-i;if(l<=0&&(e[r++]=s[0]),c<=0&&(e[r++]=s[1]),l*c<0){let t=l/(l-c);e[r]=o.add(s[0],o.mul(o.sub(s[1],s[0]),t)),++r}return s[0]=e[0],s[1]=e[1],n.assert(3!=r),r}return t.polygonCircle=function(t,i,s){this.circlePolygon(t,s,i),o.flip$(t.normal)},t.polygonPolygon=function(t,i,n){let r=i.shape,h=n.shape;t.contact_count=0;let[u,a]=l(r,h);if(u>=0)return;let d,m,p,f,[y,b]=l(h,r);if(y>=0)return;s.biasGreater(u,y)?(d=r,m=h,p=a,f=!1):(d=h,m=r,p=b,f=!0);let g=function(t,i,s){let n=t.normals[s];n=e.mul(t.u,n),n=e.mul(i.u.transpose(),n);let r=0,l=1/0;for(let t,s=0;s<i.points.length;++s)t=o.dot(n,i.normals[s]),t<l&&(l=t,r=s);let c=o.add(e.mul(i.u,i.points[r]),i.body.position);return r=(r+1)%i.points.length,[c,o.add(e.mul(i.u,i.points[r]),i.body.position)]}(d,m,p),v=d.points[p];p=(p+1)%d.points.length;let z=d.points[p];v=o.add(e.mul(d.u,v),d.body.position),z=o.add(e.mul(d.u,z),d.body.position);let w=o.unit(o.sub(z,v)),B=o.vec(w[1],-w[0]),_=o.dot(B,v),A=-o.dot(w,v),I=o.dot(w,z);if(c(o.flip(w),A,g)<2)return;if(c(w,I,g)<2)return;t.normal=f?o.flip(B):B;let M=0,P=o.dot(B,g[0])-_;P<=0?(t.contacts[M]=g[0],t.penetration=-P,++M):t.penetration=0,P=o.dot(B,g[1])-_,P<=0&&(t.contacts[M]=g[1],t.penetration+=-P,++M,t.penetration/=M),t.contact_count=M},n.inject(t,r)}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/impulse_engine/collision"]=function(t,s,o,e){return i(t,s,o,e)}}(this),function(t){"use strict";function i(t,i,s,o,e,n){const{u:r}=i;function l(i,e){if(!s.fuzzyZero(i.im)){let s=e/2;o.add$(i.velocity,o.mul(o.add(o.mul(i.force,i.im),t.gravity),s)),i.angularVelocity+=i.torque*i.iI*s}}return r.inject(t,{World:class{constructor(t,i){this.dt=t,this.bodies=[],this.contacts=[],this.tries=i}step(){this.contacts.length=0;for(let i,o=0;o<this.bodies.length;++o){i=this.bodies[o];for(let e,n,r=o+1;r<this.bodies.length;++r)n=this.bodies[r],s.fuzzyZero(i.im)&&s.fuzzyZero(n.im)||(e=new t.Manifold(i,n).solve(),e.contact_count>0&&this.contacts.push(e))}this.bodies.forEach(t=>l(t,this.dt)),this.contacts.forEach(t=>t.initialize());for(let t=0;t<this.tries;++t)this.contacts.forEach(t=>t.applyImpulse());this.bodies.forEach(t=>function(t,i){s.fuzzyZero(t.im)||(o.add$(t.position,o.mul(t.velocity,i)),t.orient+=t.angularVelocity*i,t.setOrient(t.orient),l(t,i))}(t,this.dt)),this.contacts.forEach(t=>t.positionalCorrection()),this.bodies.forEach(t=>{o.copy(t.force,0,0),t.torque=0})}render(t){this.bodies.forEach(i=>i.shape.draw(t))}add(i,s,o){let e=new t.Body(i,s,o);return this.bodies.push(e),e}}})}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/impulse_engine/scene"]=function(t,s,o,e,n,r){return i(t,s,o,e)}}(this);