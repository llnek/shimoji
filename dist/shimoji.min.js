!function(t){"use strict";const e=["jpg","png","jpeg","gif"],i=["ttf","otf","ttc","woff"],s=["mp3","wav","ogg"],n=1/15;function r(r,o,a,h){const{EventBus:l,dom:c,is:d,u:u}=t["io/czlab/mcfud/core"](),p=t["io/czlab/mcfud/vec2"](),g=t["io/czlab/mcfud/math"](),m=l(),f=Math.floor,x=console;let y=!1;class w extends PIXI.Container{constructor(){super(),this.m5={stage:!0}}onResize(t,e){this.children.forEach((i=>{i instanceof t.Scenes.SceneWrapper&&(i=i.children[0]),i.onCanvasResize(e)})),t.Input.resize()}}function v(){return t.innerWidth}function b(){return t.innerHeight}function T(t){const e=new F.Scenes.Scene("loader",{setup(){t.init.call(this)}},{});return F.stage.addChild(e),e.runOnce(),e}function S(t){const[e,i]=[t.offsetHeight,t.offsetWidth],[s,n]=[b(),v()],r=Math.min(n/i,s/e),[o,a]=[e*r,i*r];if(c.css(t,{transformOrigin:"0 0",transform:`scale(${r})`}),i>e?a<n:!(o>s)){const e=f((n-a)/2);c.css(t,{marginTop:"0px",marginBottom:"0px",marginLeft:`${e}px`,marginRight:`${e}px`})}else{const e=f((s-o)/2);c.css(t,{marginLeft:"0px",marginRight:"0px",marginTop:`${e}px`,marginBottom:`${e}px`})}return c.css(t,{display:"block",paddingLeft:"0px",paddingRight:"0px",paddingTop:"0px",paddingBottom:"0px"}),c.css(document.body,"backgroundColor",F.scaledBgColor),r}function I(t,e,i,n){const{Sound:r}=t;let o,h=0;function l(){a.forEach((t=>c.css(t,"display","none"))),e&&t.delBgTask(e),u.delay(0,(()=>{t.Scenes.removeScene(i),n?u.error("Cannot load game!"):t.u.start(t)}))}function d(t){0==--h&&l()}n||u.doseq(t.assets,((t,e)=>{o=u.fileExt(e),u.has(s,o)&&(h+=1,r.decodeData(t.name,t.url,t.xhr.response,d))})),0===h&&l()}function _(t,e){let n=u.map(t.u.assetFiles,(e=>t.assetPath(e))),r=u.findFiles(n,i);const{PXLR:h,PXLoader:l}=t;let g,m,y,w;if(r.forEach((t=>{w=c.newElm("style"),y=c.newElm("span"),g=t.split("/").pop().split(".")[0],m=`@font-face {font-family: '${g}'; src: url('${t}');}`,o.push(g),c.conj(w,c.newTxt(m)),c.conj(document.head,w),y.innerHTML="?",c.css(y,"fontFamily",g),c.conj(document.body,y),c.css(y,{display:"block",opacity:"0"}),a.push(y)})),s.forEach((t=>{h.setExtensionLoadType(t,h.LOAD_TYPE.XHR),h.setExtensionXhrType(t,h.XHR_RESPONSE_TYPE.BUFFER)})),l.reset(),n.length>0){let i=t.u.load;if(e?i?(i=null,x.log("FatalError: can't proceed.")):i=function(t){const e=t.getScaleFactor(),i=f(t.height/2),s=f(t.width/2),n=f(t.width/4),{Sprites:r}=t,o=2*n,a=24*e,h=i-a/2;return{init(){this.fg=r.rect(s,a,16747008),this.bg=r.rect(s,a,4210752),this.perc=r.text("0%",{fontSize:f(a/2),fill:"black",fontFamily:"sans-serif"}),p.set(this.bg,s-n,h),p.set(this.fg,s-n,h),p.set(this.perc,s-n+10,f(i-this.perc.height/2)),this.insert(this.bg),this.insert(this.fg),this.insert(this.perc)},update(t,e){this.fg.width=o*(e/100),this.perc.text=`${Math.round(e)}%`,x.log(`file= ${t}, progr= ${e}`)}}}(t):i||(i=function(t){const{Sprites:e}=t;return{init(){let i=e.sprite("boot/ZotohLab_x1240.png"),s=e.sprite("boot/preloader_bar.png"),[n,r]=t.scaleXY([i.width,i.height],[t.width,t.height]),o=t.getScaleFactor(),a=n>r?r:n;a*=.2,p.set(s.scale,a,a),p.set(i.scale,a,a),e.pinCenter(this,i),e.pinBottom(i,s,4*o),s.visible=!1,this.g.pbar=s,this.g.pbar_width=s.width,this.insert(i),this.insert(s)},update(t,e){this.g.pbar.visible||(this.g.pbar.visible=!0),this.g.pbar.width=this.g.pbar_width*(e/100)}}}(t)),i){let e=0,s=[],r=[],o=T(i);l.add(n),l.onError.add(((t,i,s)=>{++e,x.log(`${t}`)})),l.onProgress.add(((t,e)=>{s.unshift(e.url),r.unshift(t.progress)})),l.load((()=>{0===e&&x.log("asset loaded!")})),t.addBgTask({update(){let n=s.pop(),a=r.pop();n&&d.num(a)&&i.update.call(o,n,a),(u.feq(a,100)||a>99.95)&&I(t,this,o,e>0)}})}}else I(t);return t.start()}u.patch(r,{assetFiles:[],logos:[],fps:60});const P={width:0,height:0},E={width:1,height:1};function C(t){let e={outline:"none"};!1!==t.rendering&&(e["image-rendering"]=t.rendering),c.css(F.canvas,e),c.attrs(F.canvas,"tabindex","0")}const X=u.jsMap();function M(t){F._curFPS=F.calcFPS(t),h.forEach((e=>e.update&&e.update(t))),y||F.stageCS((e=>e.update&&e.update(t))),F.ctx.render(F.stage)}function D(e){return t.requestAnimationFrame(e)}class O{constructor(t){this.uid=t}playSound(){}uuid(){return this.uid}pokeMove(){this.onPoke()}pokeWait(){this.onWait()}stateValue(){u.assert(!1,"implement stateValue!")}}const F={Bot:class extends O{constructor(t="p2"){super(t)}onPoke(){}onWait(){}},Local:class extends O{constructor(t="p1"){super(t)}onPoke(){F.Input.resume()}onWait(){F.Input.pause()}},Mediator:class{constructor(){this.players=[],this.state=null,this.pcur,this.end,this.pwin,this._pcnt=0}cur(){return this.pcur}add(t){return t.pnum=++this._pcnt,t.owner=this,this.players.push(t),this}winner(){return this.pwin}isGameOver(){return this.end}gameState(t){return t&&(this.state=t),this.state}gameOver(t){return F.Input.resume(),this.pwin=t,this.end=!0}start(t){u.assert(t,"bad player to start with"),this.end=!1,this.pcur=t,this._turn()}other(){return this.pcur===this.players[0]?this.players[1]:this.pcur===this.players[1]?this.players[0]:void 0}_turn(){this.players.forEach((t=>{t!==this.pcur&&t.pokeWait()})),this.pcur.pokeMove()}redoTurn(){this.pcur.pokeMove()}postMove(t,e){u.assert(!1,"implement postMove!")}updateState(t,e){u.assert(!1,"implement updateState!")}updateSound(t){}updateMove(t,e){this.end||(this.updateState(t,e),this.updateSound(t),u.delay(0,(()=>this.postMove(t,e))))}takeTurn(){this.end||(this.pcur===this.players[0]?this.pcur=this.players[1]:this.pcur===this.players[1]&&(this.pcur=this.players[0]),this._turn())}},EVERY:1,SOME:2,CENTER:3,TOP:4,LEFT:5,RIGHT:6,BOTTOM:7,UP:8,DOWN:9,NW:10,NE:11,SW:12,SE:13,NONE:100,PI_90:Math.PI/2,PI_180:Math.PI,PI_270:1.5*Math.PI,PI_360:2*Math.PI,v2:p,math:g,ute:u,is:d,dom:c,u:r,Game:{mode:1},MODE_ONE:1,MODE_TWO:2,MODE_NET:3,CON:console,noop:()=>{},PXContainer:PIXI.Container,PXGraphics:PIXI.Graphics,PXTexture:PIXI.Texture,PXFilters:PIXI.filters,PXLR:PIXI.LoaderResource,PXLoader:PIXI.Loader.shared,PXObservablePoint:PIXI.ObservablePoint,accel:(t,e,i)=>t+e*i,on:(...t)=>m.sub(...t),emit:(...t)=>m.pub(...t),off:(...t)=>m.unsub(...t),sideRight:t=>t===F.RIGHT||t===F.NE||t===F.SE,sideLeft:t=>t===F.LEFT||t===F.NW||t===F.SW,sideTop:t=>t===F.UP||t===F.TOP||t===F.NW||t===F.NE,sideBottom:t=>t===F.DOWN||t===F.BOTTOM||t===F.SW||t===F.SE,overlap:(t,e)=>!(t.x2<e.x1||e.x2<t.x1||t.y2<e.y1||e.y2<t.y1),hasClass:(t,e)=>new RegExp(`(\\s|^)${e}(\\s|$)`).test(t.className),addClass:(t,e)=>(u.hasClass(t,e)||(t.className+=`${e}`),t),removeClass:(t,e)=>(u.hasClass(t,e)&&(t.className=t.className.replace(new RegExp(`(\\s|^)${e}(\\s|$)`),"")),t),wrapv:(t,e,i)=>t<e?i:t>i?e:t,defMixin(t,e){if(u.has(X,t))throw`MixinError: "${t}" already defined.`;u.assert(d.fun(e),"mixin must be a function"),u.assoc(X,t,e)},addMixin:(t,e,...i)=>function(t,e,i,...s){return u.assert(!u.has(t,e),`Fatal: mixin ${e} unavailable.`),t[e]=i(t,...s),t}(t,e,X.get(e),...i),get assets(){return PIXI.Loader.shared.resources},get designSize(){return this.u.arena},get width(){return this.canvas.width},get height(){return this.canvas.height},stageCS(t){F.stage.children.forEach((e=>{e instanceof F.Scenes.SceneWrapper&&(e=e.children[0]),t(e)}))},scroll(e,i){t.scrollTo(e||0,i||1)},portrait:()=>F.height>F.width,screenCenter:()=>u.v2(f(F.width/2),f(F.height/2)),scaleXY:(t,e)=>[e[0]/t[0],e[1]/t[1]],makeAnchor(t,e){return new F.PXObservablePoint(F.noop,this,t,e)},mockStage(t=0,e=0,i,s){let n=d.obj(t)?t:{x:t,y:e,width:u.nor(i,F.width),height:u.nor(s,F.height)};return n.getGlobalPosition=()=>({x:this.x,y:this.y}),n.anchor=F.makeAnchor(0,0),n.m5={stage:!0},n},getIndex(t,e,i,s,n){if(t<0||e<0)throw`IndexError: ${t},${e}, wanted +ve values`;return f(t/i)+f(e/s)*n},tcached(t){return u.inst(this.PXTexture,t)?t:d.str(t)?PIXI.utils.TextureCache[t]||PIXI.utils.TextureCache[this.assetPath(t)]:void 0},splitXY:(t,e)=>[t%e,f(t/e)],rect:(t,e,i,s)=>new F.PXRectangle(t,e,i,s),scaleSZ:(t,e)=>({width:e.width/t.width,height:e.height/t.height}),id(t){return this.image(t)},image(t){return this.tcached(t)||u.assert(!1,`${t} not loaded.`)},xml(t){return(this.assets[t]||u.assert(!1,`${t} not loaded.`)).data},json(t){return(this.assets[t]||u.assert(!1,`${t} not loaded.`)).data},assetPath(t){if(t.includes("/"))return t;let n="data",r=u.fileExt(t);return u.has(e,r)?n="images":"fnt"==r||u.has(i,r)?n="fonts":u.has(s,r)&&(n="audio"),`${n}/${t}`},contentScaleFactor(){return P.height=F.height,P.width=F.width,"max"!==r.scaleToWindow?E:this.scaleSZ(this.designSize,P)},getScaleFactor(t){if(t||"max"==r.scaleToWindow){P.height=F.height,P.width=F.width;let t=this.scaleSZ(this.designSize,P);return"x"==r.scaleFit?t.width:"y"==r.scaleFit?t.height:Math.min(t.width,t.height)}return 1},resource(t,e){return(t?this.assets[t]||this.assets[this.assetPath(t)]:null)||(e?u.assert(!1,`no such resource ${t}.`):void 0)},calcFPS:t=>t>0?f(1/t):0,degToRad:t=>t*(Math.PI/180),radToDeg:t=>t*(180/Math.PI),delBgTask(t){t&&u.disj(h,t)},addBgTask(t){h.push(t)},resume(){y=!1},pause(){y=!0},start(){let t=F.frame,e=u.now(),i=0,s=function(){let r=u.now(),o=(r-e)/1e3;for(o>n&&(o=n),i+=o;i>=t;i-=t)M(o);e=r,D(s)};return D(s)}};return function(e){let i=e.stage=new w,s=r.arena,n=!1;return u.assert(s,"design resolution req'd."),"max"==r.scaleToWindow&&(n=!0,s={width:v(),height:b()},1===r.arena.scale&&(n=!1,r.arena=s,r.scaleToWindow="win")),r.logos||(r.logos=new Array),e.touchDevice=!!("ontouchstart"in document),e.ctx=PIXI.autoDetectRenderer(u.inject(s,{antialias:!0})),e.ctx.bgColor=16777215,e.canvas=e.ctx.view,e.canvas.id="mojo",e.maxed=n,e.scale=1,e.frame=1/r.fps,e.scaledBgColor="#323232",["Sprites","Input","Scenes","Sound","FX","2d","Tiles","Touch"].forEach((i=>{x.log(`installing module ${i}...`);let s=t[`io/czlab/mojoh5/${i}`](e);s.assets&&s.assets.forEach((t=>e.u.assetFiles.unshift(t)))})),h.push(e.FX,e.Input),c.conj(document.body,e.canvas),function(){const t=c.newElm("style");c.conj(t,c.newTxt("body, * {padding: 0; margin: 0; height:100%; overflow:hidden}")),c.conj(document.head,t)}(),C(r),u.has(r,"border")&&c.css(e.canvas,"border",r.border),u.has(r,"bgColor")&&(e.ctx.backgroundColor=e.Sprites.color(r.bgColor)),!0===r.scaleToWindow&&(e.scale=S(e.canvas)),e.mouse=e.Input.pointer(),!0===r.resize&&(u.addEvent("resize",t,u.debounce((()=>{const[t,i]=[e.width,e.height];e.ctx.resize(v(),b()),e.emit(["canvas.resize"],[t,i])}),r.debounceRate||150)),e.on(["canvas.resize"],(t=>i.onResize(e,t)))),e.touchDevice&&e.scroll(),e.canvas.focus(),function(t){const{PXLoader:e}=t;t.u.load||(t.u.logos=["boot/preloader_bar.png","boot/ZotohLab_x1240.png"]);let i=t.u.logos,s=0;return i=i.map((e=>t.assetPath(e))),0===i.length?_(t):(e.reset(),e.add(i),e.onError.add(((t,e,i)=>{++s,x.log(`${t}`)})),e.load((()=>{u.delay(0,(()=>_(t,s>0))),0===s&&x.log("logo files loaded!")}))),t}(e)}(F)}if("object"==typeof module&&module.exports)throw"Panic: browser only!";t.MojoH5=function(t){return r(t,[],[],[])}}(this),function(t){"use strict";function e(e){const{Stack:i,StdCompare:s}=t["io/czlab/mcfud/algo_basic"](),{is:n,ute:r}=e,o=Math.floor;class a{constructor(t,e){r.assert(t<=e,"bad interval1D"),r.feq0(t)&&(t=0),r.feq0(e)&&(e=0),this.min=t,this.max=e}min(){return this.min}max(){return this.max}intersects(t){return!(this.max<t.min||t.max<this.min)}contains(t){return this.min<=t&&t<=this.max}length(){return this.max-this.min}static MinEndpointComparator(t,e){return t.min<e.min?-1:t.min>e.min?1:t.max<e.max?-1:t.max>e.max?1:0}static MaxEndpointComparator(t,e){return t.max<e.max?-1:t.max>e.max?1:t.min<e.min?-1:t.min>e.min?1:0}static LengthComparator(t,e){let i=t.length(),s=e.length();return i<s?-1:i>s?1:0}static test(){let t=[new a(15,33),new a(45,60),new a(20,70),new a(46,55)];console.log("Unsorted"),t.forEach((t=>console.log(`min=${t.min}, max=${t.max}`))),console.log("Sort by min endpoint"),t.sort(a.MinEndpointComparator),t.forEach((t=>console.log(`min=${t.min}, max=${t.max}`))),console.log("Sort by max endpoint"),t.sort(a.MaxEndpointComparator),t.forEach((t=>console.log(`min=${t.min}, max=${t.max}`))),console.log("Sort by length"),t.sort(a.LengthComparator),t.forEach((t=>console.log(`min=${t.min}, max=${t.max}`)))}}class h{static theta(t){return Math.atan2(t[1],t[0])}static angleTo(t,e){return Math.atan2(e[1]-t[1],e[0]-t[0])}static ccw(t,e,i){let s=(e[0]-t[0])*(i[1]-t[1])-(e[1]-t[1])*(i[0]-t[0]);return s<0?-1:s>0?1:0}static area2(t,e,i){return(e[0]-t[0])*(i[1]-t[1])-(e[1]-t[1])*(i[0]-t[0])}static distanceTo(t,e){let i=t[0]-e[0],s=t[1]-e[1];return Math.sqrt(i*i+s*s)}static distanceSquaredTo(t,e){let i=t[0]-e[0],s=t[1]-e[1];return i*i+s*s}static compareTo(t,e){return t[1]<e[1]?-1:t[1]>e[1]?1:t[0]<e[0]?-1:t[0]>e[0]?1:0}static XOrderComparator(t,e){return t[0]<e[0]?-1:t[0]>e[0]?1:0}static YOrderComparator(t,e){return t[1]<e[1]?-1:t[1]>e[1]?1:0}static ROrderComparator(t,e){let i=t[0]*t[0]+t[1]*t[1]-(e[0]*e[0]+e[1]*e[1]);return i<0?-1:i>0?1:0}static Atan2OrderComparator(t,e){let i=h.angleTo(t),s=h.angleTo(e);return i<s?-1:i>s?1:0}static PolarOrderComparator(t){return(e,i)=>{let s=e[0]-t[0],n=e[1]-t[1],o=i[0]-t[0],a=i[1]-t[1];return n>=0&&a<0?-1:a>=0&&n<0?1:r.feq0(n)&&r.feq0(a)?s>=0&&o<0?-1:o>=0&&s<0?1:0:-h.ccw(t,e,i)}}static DistanceToOrderComparator(t,e){let i=h.distanceSquaredTo(t),s=h.distanceSquaredTo(e);return i<s?-1:i>s?1:0}static equals(t,e){return e===t||!!e&&(t[0]==e[0]&&t[1]==e[1])}static farthestPair(t){let e,i=[0,0],s=[0,0],n=0,r=-1/0,o=h.calcConvexHull(t);if(!1===o||t.length<=1)return!1;if(e=o.length,o.unshift(null),2==e)i=o[1],s=o[2],n=h.distanceTo(i,s);else{let t,n=2;for(;h.area2(o[e],o[1],o[n+1])>h.area2(o[e],o[1],o[n]);)++n;t=n;for(let a,l=1;l<=n&&t<=e;++l)for(h.distanceSquaredTo(o[l],o[t])>r&&(r=h.distanceSquaredTo(o[l],o[t]),_V.copy(i,o[l]),_V.copy(s,o[t]));t<e&&h.area2(o[l],o[l+1],o[t+1])>h.area2(o[l],o[l+1],o[t]);)++t,a=h.distanceSquaredTo(o[l],o[t]),a>r&&(r=h.distanceSquaredTo(o[l],o[t]),_V.copy(i,o[l]),_V.copy(s,o[t]))}return{best1:i,best2:s,bestDistance:Math.sqrt(r)}}static closestPair(t){let e=[0,0],i=[0,0],s=1/0,n=t.slice();const a=t.length;n.sort(h.YOrderComparator),n.sort(h.XOrderComparator);for(let t=0;t<a-1;++t)if(h.equals(n[t],n[t+1]))return _V.copy(e,n[t]),_V.copy(i,n[t+1]),{bestDistance:0,best1:e,best2:i};let l=n.slice();return function t(n,r,a,l,c){if(c<=l)return 1/0;let d=l+o((c-l)/2),u=n[d],p=t(n,r,a,l,d),g=t(n,r,a,d+1,c),m=Math.min(p,g);!function(t,e,i,s,n){for(let s=i;s<=n;++s)_V.copy(e[s],t[s]);let r=i,o=s+1;for(let a=i;a<=n;++a)r>s?_V.copy(t[a],e[o++]):o>n?_V.copy(t[a],e[r++]):h.compareTo(e[o],e[r])<0?_V.copy(t[a],e[o++]):_V.copy(t[a],e[r++])}(r,a,l,d,c);let f=0;for(let t=l;t<=c;++t)Math.abs(r[t][0]-u[0])<m&&_V.copy(a[f++],r[t]);for(let t=0;t<f;++t)for(let n,r=t+1;r<f&&a[r][1]-a[t][1]<m;++r)n=h.distanceTo(a[t],a[r]),n<m&&(m=n,n<s&&(s=m,_V.copy(e,a[t]),_V.copy(i,a[r])));return m}(n,l,r.fill(a,(()=>[0,0])),0,a-1),{bestDistance:s,best1:e,best2:i}}static calcConvexHull(t){r.assert(t&&t.length>0,"invalid points");let e,s,n,o=t.length,a=r.deepCopyArray(t),l=new i;for(a.sort(h.compareTo),e=a[0],a.shift(),a.sort(h.PolarOrderComparator(e)),a.unshift(e),l.push(a[0]),s=1;s<o&&h.equals(a[0],a[s]);++s);if(s==o)return!1;for(n=s+1;n<o&&0==h.ccw(a[0],a[s],a[n]);++n);l.push(a[n-1]);for(let t,e=n;e<o;++e){for(t=l.pop();h.ccw(l.peek(),t,a[e])<=0;)t=l.pop();l.push(t),l.push(a[e])}let c=new i;for(let t=l.iterator();t.hasNext();)c.push(t.next());o=c.size(),t=[];for(let e=c.iterator();e.hasNext();)t.push(_V.clone(e.next()));if(o>2)for(let e=0;e<o;++e)if(h.ccw(t[e],t[(e+1)%o],t[(e+2)%o])<=0)return!1;return t}static test_convexHull(){let t="9230 13137 4096 24064 8192 26112 22016  9344 4440  8028 6505 31422 28462 32343 17152 19200 9561 11599\n               4096 20992 21538  2430 21903 23677 17152 16128 7168 25088 10162 18638 822 32301 16128 12032 18989  3797\n               8192 28160 16128 20224 14080 20224 26112  7296 20367 20436 7486   422 17835  2689 22016  3200 22016  5248\n               24650 16886 15104 20224 25866  4204 13056 15104 13662 10301 17152 20224 15104 12032 6144 20992 26112  3200\n               6144 29184 13056 12032 8128 20992 5076 19172 17152 17152 823 15895 25216  3200 6071 29161 5120 20992\n               10324 22176 29900  9390 27424  7945 4096 23040 12831 27971 29860 12437 28668  2061 1429 12561 29413   596\n               17152 18176 8192 27136 5120 29184 22016 11392 1444 10362 32011  3140 15731 32661 26112  4224 13120 20224\n               30950  2616 4096 22016 4096 25088 24064  3200 26112  5248 4862 30650 5570  8885 21784 18853 23164 32371\n               4160 29184 13056 13056 8192 29184 23040  7296 5120 25088 22016  7296 7168 29184 25216  7296 23040  3200\n               4718  4451 14080 16128 7168 20992 19546 17728 13056 16128 17947 17017 26112  6272 20658  1204 23553 13965\n               13056 14080 14080 12032 24064  7296 21377 26361 17088\n               12032 16128 16128 30875 28560 2542 26201 8192 25088 11444 16973".split(/\s+/).map((t=>+t)),e=[];for(let i=0;i<t.length;i+=2)e.push([t[i],t[i+1]]);e=[[5,15],[5,-20],[-60,10],[70,-10],[-60,-10],[70,10]];let i=h.calcConvexHull(e);!1===i||i.length!=e.length?console.log("not convex!"):i.forEach((t=>{console.log(`${t[0]}, ${t[1]}`)}))}static test_closestPair(){let t="954 11163 1125 11331 1296 11499 1467 11667 1657 11796 1847 11925 2037 12054 2238 12207 2439 12360\n               2640 12513 2878 12523 3116 12533 3354 12543 3518 12493 3682 12443 3846 12393\n               8463 7794 8022 7527 7581 7260 7140 6993 6731 6624 6322 6255 5913 5886\n               5521 5494 5129 5102 4737 4710 4599 5158".split(/\s+/).map((t=>+t)),e=[];for(let i=0;i<t.length;i+=2)e.push([t[i],t[i+1]]);let{bestDistance:i,best1:s,best2:n}=h.closestPair(e);console.log(`bestDist=${i}, p1=${s}, p2=${n}`)}static test_farthestPair(){let t="9230 13137 4096 24064 8192 26112 22016  9344 4440  8028 6505 31422 28462 32343 17152 19200 9561 11599 4096 20992 21538  2430\n               21903 23677 17152 16128 7168 25088 10162 18638 822 32301 16128 12032 18989  3797 8192 28160 16128 20224 14080 20224 26112  7296\n               20367 20436 7486   422 17835  2689 22016  3200 22016  5248 24650 16886 15104 20224 25866  4204 13056 15104 13662 10301 17152 20224\n               15104 12032 6144 20992 26112  3200 6144 29184 13056 12032 8128 20992 5076 19172 17152 17152 823 15895 25216  3200 6071 29161\n               5120 20992 10324 22176 29900  9390 27424  7945 4096 23040 12831 27971 29860 12437 28668  2061 1429 12561 29413   596 17152 18176\n               8192 27136 5120 29184 22016 11392 1444 10362 32011  3140 15731 32661 26112  4224 13120 20224 30950  2616 4096 22016\n               4096 25088 24064  3200 26112  5248 4862 30650 5570  8885 21784 18853 23164 32371 4160 29184 13056 13056 8192 29184 23040  7296\n               5120 25088 22016  7296 7168 29184 25216  7296 23040  3200 4718  4451 14080 16128 7168 20992 19546 17728 13056 16128 17947 17017\n               26112  6272 20658  1204 23553 13965 13056 14080 14080 12032 24064  7296 21377 26361 17088 12032 16128 16128\n               30875 28560 2542 26201 8192 25088 11444 16973".split(/\s+/).map((t=>+t)),e=[];for(let i=0;i<t.length;i+=2)e.push([t[i],t[i+1]]);let{bestDistance:i,best1:s,best2:n}=h.farthestPair(e);console.log(`bestDist=${i}, p1=${s}, p2=${n}`)}}const l={Point2D:h,Interval1D:a,Interval2D:class{constructor(t,e){this.x=t,this.y=e}intersects(t){return!!this.x.intersects(t.x)&&!!this.y.intersects(t.y)}contains(t){return x.contains(t[0])&&y.contains(t[1])}area(){return x.length()*y.length()}static test(){}}};return e.util=l}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/util"]=t=>t.util?t.util:e(t)}(this),function(t){"use strict";const e={blue:"#319bd5",green:"#78c03f",yellow:"#f9ef50",red:"#eb2224",orange:"#f48917",grey:"#848685",purple:"#a6499a"},i={aqua:"#00FFFF",black:"#000000",blue:"#0000FF",brown:"#A52A2A",crimson:"#DC143C",cyan:"#00FFFF",fuchsia:"#FF00FF",gray:"#808080",green:"#008000",grey:"#808080",lavender:"#E6E6FA",lime:"#00FF00",magenta:"#FF00FF",maroon:"#800000",navy:"#000080",olive:"#808000",orange:"#FFA500",purple:"#800080",red:"#FF0000",silver:"#C0C0C0",teal:"#008080",turquoise:"#40E0D0",wheat:"#F5DEB3",white:"#FFFFFF",yellow:"#FFFF00"};function s(s){const n=t["io/czlab/mcfud/geo2d"](),r=t["io/czlab/mcfud/vec2"](),{ute:o,is:a,dom:h}=s,l=(Math.abs,Math.floor);function c(t,e,i,n){0===(n=n||t.getLocalBounds(null,!0)).width&&(n.width=1),0===n.height&&(n.height=1);let r=PIXI.Matrix.TEMP_MATRIX,o=PIXI.RenderTexture.create({width:0|n.width,height:0|n.height,scaleMode:e,resolution:i});return r.tx=-n.x,r.ty=-n.y,s.ctx.render(t,o,!1,r,!!t.parent),o}var d,u,p;function g(t,e){let i,n;return o.inst(s.PXGraphics,t)&&(t=c(t)),o.inst(s.PXTexture,t)?n=t:a.vec(t)?i=function(t){return o.assert(a.vec(t),"bad arg to animFromVec"),a.str(t[0])&&(t=s.tcached(t[0])?t.map((t=>s.tcached(t))):t.map((t=>s.assetPath(t)))),o.inst(s.PXTexture,t[0])?new s.PXASprite(t):s.PXASprite.fromImages(t)}(t):a.str(t)&&(n=s.tcached(t)||function(t){return s.PXTexture.from(s.assetPath(t))}(t)),n&&(i=e(n)),o.assert(i,`SpriteError: ${t} not found`)&&i}function m(t,e,i,s,n,r){const o=[];let a=e,h=t;for(let e,l,c,d=0;d<i;++d){c=[];for(let t=0;t<s;++t)l=a+r,e=h+n,c.push({x1:h,x2:e,y1:a,y2:l}),h=e;a=l,h=t,o.push(c)}return o}function f(t,e,i=null){let n,r=null;return e.m5.stage?n={x1:0,y1:0,x2:s.width,y2:s.height}:(r=e.parent,n=t.getBBox(e)),i&&r===i&&(n.x1+=i.x,n.x2+=i.x,n.y1+=i.y,n.y2+=i.y),[n,l((n.x2-n.x1)/2),l((n.y2-n.y1)/2),l((n.x1+n.x2)/2),l((n.y1+n.y2)/2)]}function x(t,e,i){if(e.m5.static)r.sub$(t.m5.vel,r.mul(i.overlapN,2*r.dot(t.m5.vel,i.overlapN)));else{let s=r.mul$(r.sub(e.m5.vel,t.m5.vel),i.overlapN),n=-2*(s[0]+s[1])/(t.m5.invMass+e.m5.invMass);r.sub$(t.m5.vel,r.mul$(r.div(i.overlapN,t.m5.mass),n)),r.add$(e.m5.vel,r.mul$(r.div(i.overlapN,e.m5.mass),n))}}function y(t,e,i){const s=t.toShape(e),r=t.toShape(i);let o;return o=e.m5.circle?i.m5.circle?n.hitCircleCircle(s,r):n.hitCirclePolygon(s,r):i.m5.circle?n.hitPolygonCircle(s,r):n.hitPolygonPolygon(s,r),o&&(o.A=e,o.B=i),o}d=new PIXI.Container,(u=new PIXI.Graphics).clear(),u.beginFill(0),u.drawCircle(0,0,4),u.endFill(),p=new PIXI.Sprite(c(u)),["m5","tiled","collideXY","getGuid","getBBox","getSpatial"].forEach((t=>{[[d,"Container"],[u,"Graphics"],[p,"Sprite"]].forEach((e=>{o.assertNot(o.has(e[0],t),`PIXI ${e[1]} has ${t} property!`)}))})),o.inject(s,{PXMatrix:PIXI.Matrix.TEMP_MATRIX,PXRTexture:PIXI.RenderTexture,PXRect:PIXI.Rectangle,PXBText:PIXI.BitmapText,PXSprite:PIXI.Sprite,PXGraphics:PIXI.Graphics,PXText:PIXI.Text,PXTSprite:PIXI.TilingSprite,PXASprite:PIXI.AnimatedSprite,PXPContainer:PIXI.ParticleContainer});r.vec();const w={SomeColors:i,BtnColors:e,assets:["boot/tap-touch.png","boot/unscii.fnt","boot/doki.fnt","boot/riffic.fnt","boot/kenney_high.fnt","boot/NineteenOhFive.fnt","boot/BIG_SHOUT_BOB.fnt"],assertCenter:t=>o.assert(t.anchor&&t.anchor.x>.3&&t.anchor.x<.7&&t.anchor.y>.3&&t.anchor.y<.7,"not center'ed"),empty:t=>0===t.children.length,sizeXY:(t,e,i)=>(a.num(i)&&(t.height=i),a.num(e)&&(t.width=e),t),scaleXY:(t,e,i)=>(a.num(e)&&(t.scale.x=e),a.num(i)&&(t.scale.y=i),t),scaleBy:(t,e,i)=>(a.num(e)&&(t.scale.x*=e),a.num(i)&&(t.scale.y*=i),t),isVX:t=>!o.feq0(t.m5.vel[0]),isVY:t=>!o.feq0(t.m5.vel[1]),halfSize:t=>({width:l(t.width/2),height:l(t.height/2)}),centerAnchor:t=>(t.anchor&&t.anchor.set(.5,.5),t),topLeftAnchor:t=>(t.anchor&&t.anchor.set(0,0),t),topLeftOffsetXY(t){return this.isTopLeft(t)?r.vec():r.vec(-l(t.width*(t.anchor?t.anchor.x:0)),-l(t.height*(t.anchor?t.anchor.y:0)))},centerOffsetXY(t){return this.isCenter(t)?r.vec():r.vec(l(t.width/2)-l((t.anchor?t.anchor.x:0)*t.width),l(t.height/2)-l((t.anchor?t.anchor.y:0)*t.height))},extend(t){if(!t.m5){let e=this;t.g={},t.m5={uuid:o.nextId(),circle:!1,stage:!1,drag:!1,dead:!1,angVel:0,friction:r.vec(1,1),gravity:r.vec(),vel:r.vec(),acc:r.vec(),static:!1,sensor:!1,sgrid:{},mass:1,type:0,cmask:0,speed:0,heading:s.RIGHT,get invMass(){return o.feq0(t.m5.mass)?0:1/t.m5.mass}},t.m5.resize=function(i,s,n,r){e.resize(t,i,s,n,r)},t.m5.getImageOffsets=function(){return{x1:0,x2:0,y1:0,y2:0}},t.m5.getContactPoints=function(){return function(t,e,i){let s=[r.vec(e,i),r.vec(e,0),r.vec(0,0),r.vec(0,i)];return t||(t={x:0,y:0}),s.forEach((s=>{s[0]-=l(e*t.x),s[1]-=l(i*t.y)})),s}(t.anchor,t.width,t.height)},t.getGuid=function(){return t.m5.uuid},t.getSpatial=function(){return t.m5.sgrid},t.getBBox=function(){return o.feq0(t.angle)?e.getBBox(t):e.boundingBox(t)}}return t},toPolygon:t=>new n.Polygon(t.x,t.y).setOrient(t.rotation).set(t.m5.getContactPoints()),toCircle(t){return this.assertCenter(t)&&new n.Circle(l(t.width/2)).setPos(t.x,t.y).setOrient(t.rotation)},toShape(t){return t.m5.circle?this.toCircle(t):this.toPolygon(t)},gposXY(t){const{x:e,y:i}=t.getGlobalPosition();return r.vec(e,i)},isTopLeft:t=>!t.anchor||t.anchor.x<.3&&t.anchor.y<.3,isCenter:t=>!!t.anchor&&(t.anchor.x>.3&&t.anchor.x<.7&&t.anchor.y>.3&&t.anchor.y<.7),centerXY(t){let e;if(this.isCenter(t))e=r.vec(t.x,t.y);else{let[i,s]=this.centerOffsetXY(t);e=r.vec(t.x+i,t.y+s)}return e},setScaleModeNearest:(t,e)=>(t.texture.baseTexture.scaleMode=e?PIXI.SCALE_MODES.NEAREST:PIXI.SCALE_MODES.LINEAR,t),angle(t,e){return r.angle(this.centerXY(t),this.centerXY(e))},move:(t,e)=>(e=o.nor(e,1),r.add$(t,r.mul(t.m5.vel,e))),leftSide(t){let e=t.x,i=t.width,s=t.anchor?t.anchor.x:0;return s>.7?e-=i:s>0&&(e-=l(i/2)),e},rightSide(t){return this.leftSide(t)+t.width},topSide(t){let e=t.y,i=t.height,s=t.anchor?t.anchor.y:0;return s>.7?e-=i:s>0&&(e-=l(i/2)),e},bottomSide(t){return this.topSide(t)+t.height},getBBox(t){let e={x1:this.leftSide(t),x2:this.rightSide(t),y1:this.topSide(t),y2:this.bottomSide(t)};return o.assert(e.y1<=e.y2,"bbox bad y values")&&e},bbox4:(t,e,i,s)=>o.assert(i<=s,"bad bbox")&&{x1:t,x2:e,y1:i,y2:s},bboxCenter(t){if(a.num(t.x1))return r.vec(l((t.x1+t.x2)/2),l((t.y1+t.y2)/2))},bboxFrame(t,e=16,i="#dedede"){let s=this.graphics(),{x1:n,x2:r,y1:o,y2:a}=t,h=r-n,c=a-o;s.lineStyle(e,this.color(i)),s.drawRoundedRect(0,0,h+e,c+e,l(e/4));let d=this.sprite(s);return d.x=n-e,d.y=o-e,d},bboxSize:t=>r.vec(t.x2-t.x1,t.y2-t.y1),pointInBBox:(t,e,i)=>t>i.x1&&t<i.x2&&e>i.y1&&e<i.y2,boundingBox(t){let e,i,s=[],n=[],r=l(t.width/2),a=l(t.height/2),h=Math.tanh(a/r),c=Math.sqrt(r*r+a*a);return o.feq0(t.rotation)||o.assert(this.isCenter(t),"wanted center anchor"),i=2*Math.PI-h+t.rotation,n.push(c*Math.sin(i)),s.push(c*Math.cos(i)),i=h+t.rotation,n.push(c*Math.sin(i)),s.push(c*Math.cos(i)),i=Math.PI-h+t.rotation,n.push(c*Math.sin(i)),s.push(c*Math.cos(i)),i=Math.PI+h+t.rotation,n.push(c*Math.sin(i)),s.push(c*Math.cos(i)),e=this.centerXY(t),n.sort(((t,e)=>t-e)),s.sort(((t,e)=>t-e)),{x1:l(s[0]+e[0]),x2:l(s[3]+e[0]),y1:l(n[0]+e[1]),y2:l(n[3]+e[1])}},hitTestPoint(t,e,i){let s=this.toShape(i);return i.m5.circle?n.hitTestPointCircle(t,e,s):n.hitTestPointPolygon(t,e,s)},lineOfSight(t,e,i,s=32){let n=this.centerXY(t),o=this.centerXY(e),a=r.vecAB(n,o),h=r.vec(),c=!1,d=r.len(a),u=r.div(a,d);for(let t,e=l(d/s),o=1;o<=e&&!c;++o)t=s*o,r.copy(h,r.add(n,r.mul(u,t))),c=i.some((t=>this.hitTestPoint(h[0],h[1],t)));return!c},distance(t,e){return r.dist(this.centerXY(t),this.centerXY(e))},scaleContent(...t){1===t.length&&a.vec(t[0])&&(t=t[0]);let e=s.getScaleFactor();t.forEach((t=>{t.scale.x=e,t.scale.y=e}))},scaleToCanvas:t=>(t.height=s.height,t.width=s.width,t),uuid:(t,e)=>(t.m5.uuid=e,t),opacity:(t,e)=>(t.alpha=e,t),tint:(t,e)=>(t.tint=e,t),manifest:(t,e=!0)=>(t.visible=e,t),pset:(t,e,i)=>(t.g[e]=i,t),pget:(t,e)=>t.g[e],container(t){let e=new s.PXContainer;return e=this.extend(e),t&&t(e),e},sprite(t,e=!1,i=0,n=0){let h=g(t,(t=>new s.PXSprite(t)));return h=this.extend(h),r.set(h,i,n),e&&this.centerAnchor(h),o.inst(s.PXASprite,h)?function(t){let e,i=[0,0,0,0];function s(){return e=o.clear(e),t}function n(){i[2]<i[3]+1?(t.gotoAndStop(t.currentFrame+1),i[2]+=1):t.loop?(t.gotoAndStop(i[0]),i[2]=1):(s(),t.onComplete&&t.onComplete())}return o.inject(t.m5,{stopFrames(){s()&&t.gotoAndStop(t.currentFrame)},showFrame(e){s()&&t.gotoAndStop(e)},playFrames(r){s(),i[0]=0,i[1]=t.totalFrames-1,a.vec(r)&&r.length>1&&(i[0]=r[0],i[1]=r[1]),i[3]=i[1]-i[0],t.gotoAndStop(i[0]),i[2]=1,e=o.timer(n,1e3/12,!0)}}),t}(h):h},tilingSprite(t,e=!1,i=0,n=0){let o=g(t,(t=>new s.PXTSprite(t,t.width,t.height)));return o=this.extend(o),e&&this.centerAnchor(o),r.set(o,i,n)},repeatSprite(t,e=!0,i=!0,n,r){let o,a=()=>{let e=this.extend(g(t,(t=>new s.PXSprite(t)))),i=s.getScaleFactor();return i=1,e.width*=1,e.height*=1,e},h=0,l=0,c=0,d=0,u=[];if(e){for(;c<n;)u.push(o=a()),o.x=h,o.y=l,c+=o.width,h+=o.width,c>=n&&d<r&&i&&(d+=o.height,l+=o.height,h=0,c=0);i=!1}if(i){for(;d<r;)u.push(o=a()),o.x=h,o.y=l,d+=o.height,l+=o.height,d>=r&&c<n&&e&&(c+=o.width,h+=o.width,h=l,c=d);e=!1}return u},animation(t,e,i,n=0){let o=s.tcached(t);if(!o)throw`SpriteError: ${t} not loaded.`;let a=l(o.width/e),h=[],c=a*l(o.height/i);for(let t,s,o=0;o<c;++o)t=o%a*e,s=l(o/a)*i,n>0&&(t+=n+n*o%a,s+=n+n*l(o/a)),h.push(r.vec(t,s));return this.sprite(((t,e,i,n)=>n.map((n=>new s.PXTexture(t.baseTexture,new s.PXRect(n[0],n[1],e,i)))))(o,e,i,h))},frame(t,e,i,n,r){const o=s.tcached(t);return this.sprite(new s.PXTexture(o.baseTexture,new s.PXRect(n,r,e,i)))},frameSelect(t,e,i,n){const r=s.tcached(t);return n.map((t=>new s.PXTexture(r.baseTexture,new s.PXRect(t[0],t[1],e,i))))},frames(t,e,i,n=0,r=0,o=0,a=0){let h=s.tcached(t),c=e+n,d=i+r,u=[],p=l(h.height/d),g=l((h.width+n)/c);for(let t,n=0;n<p;++n){t=a+i*n;for(let n,r=0;r<g;++r)n=o+e*r,u.push(new s.PXTexture(h.baseTexture,new s.PXRect(n,t,e,i)))}return u},frameImages:(...t)=>(1===t.length&&a.vec(t[0])&&(t=t[0]),t.map((t=>s.tcached(t)))),spriteFrom(...t){return this.sprite(this.frameImages(...t))},text(t,e,i=0,n=0){return r.set(this.extend(new s.PXText(t,e)),i,n)},bitmapText(t,e,i=0,n=0){return e.fill&&(e.tint=this.color(e.fill)),e.fontName||(e.fontName="unscii"),e.align||(e.align="center"),r.set(this.extend(new s.PXBText(t,e)),i,n)},triangle(t,e,i,n=16777215,o=16777215,h=0,c=0,d=0){let u=this.graphics(),p=1,g=l(t/2),m=this.color(o),f=i<.5?0:i>.5?t:g,x=[{x:0,y:0},{x:f,y:-e},{x:t,y:0},{x:0,y:0}];!1!==n&&(a.vec(n)&&(p=n[1],n=n[0]),u.beginFill(this.color(n),p)),h>0&&u.lineStyle(h,m,1),u.drawPolygon(...x),!1!==n&&u.endFill();let y=new s.PXSprite(this.genTexture(u));return y=this.extend(y),y.m5.getContactPoints=e<0?()=>[[f,-e],[t,0],[0,0]]:()=>[[t,e],[f,0],[0,e]],r.set(y,c,d)},rect(t,e,i=16777215,n=16777215,o=1,h=0,l=0){let c,d=this.graphics(),u=this.color(n);!1!==i&&(a.vec(i)?(c=i[1],i=i[0]):c=1,d.beginFill(this.color(i),c)),o>0&&d.lineStyle(o,u,1),d.drawRect(0,0,t,e),!1!==i&&d.endFill();let p=new s.PXSprite(this.genTexture(d));return p=this.extend(p),r.set(p,h,l)},drawBody(t,...e){let i=this.graphics();return t.apply(this,[i].concat(e)),this.extend(new s.PXSprite(this.genTexture(i)))},circle(t,e=16777215,i=16777215,n=1,o=0,a=0){let h=this.graphics(),l=this.color(i);!1!==e&&h.beginFill(this.color(e)),n>0&&h.lineStyle(n,l,1),h.drawCircle(0,0,t),!1!==e&&h.endFill();let c=new s.PXSprite(this.genTexture(h));return c=this.extend(c),r.set(c,o,a),(c.m5.circle=!0)&&this.centerAnchor(c)},line(t,e,i,s){let n=this.graphics(),a=r.clone(i),h=r.clone(s),l=this.color(t);function c(){n.clear(),n.lineStyle(e,l,1),n.moveTo(a[0],a[1]),n.lineTo(h[0],h[1])}c();let d=this.extend(n);return d.m5.ptA=function(t,e){return void 0!==t&&(a[0]=t,a[1]=o.nor(e,t),c()),a},d.m5.ptB=function(t,e){return void 0!==t&&(h[0]=t,h[1]=o.nor(e,t),c()),h},d},isMoving:t=>!o.feq0(t.m5.vel[0])||!o.feq0(t.m5.vel[1]),makeCells(t,e,i,s,n,r){let o=l((i-t)/n);return m(t,e,l((s-t)/r),o,n,r)},gridBox(t=.9,e=.9,i=null){let n=o.nor(i,s),r=l(n.height*e),a=l(n.width*t),h=l((n.width-a)/2),c=l((n.height-r)/2);return{x1:h,y1:c,x2:h+a,y2:c+r}},gridSQ(t,e=.6,i=null){let n=e*(s.height<s.width?s.height:s.width),r=l(n/t),a=r;o.isEven(r)||--r,a=r,n=t*r;let h=l((s.height-n)/2),c=l((s.width-n)/2),d=c,u=h;return i&&(i.height=n,i.width=n,void 0!==i.x&&(d=i.x),void 0!==i.y&&(u=i.y),i.x=c,i.y=h,i.x1=c,i.y1=h,i.x2=c+n,i.y2=h+n),m(d,u,t,t,r,a)},divXY([t,e],i=.9,n=.9,r=null){let o,a,h,c,d=l(s.height*n),u=l(s.width*i),p=l(u/t),g=l(d/e);return d=e*g,u=t*p,h=l((s.height-d)/2),c=l((s.width-u)/2),o=c,a=h,r&&(r.height=d,r.width=u,void 0!==r.x&&(o=r.x),void 0!==r.y&&(a=r.y),r.x=c,r.y=h,r.x1=c,r.y1=h,r.x2=c+u,r.y2=h+d),m(o,a,e,t,p,g)},gridXY([t,e],i=.9,n=.9,r=null){let a,h,c,d,u=l(s.height*n),p=l(s.width*i),g=l(p/t),f=l(u/e),x=g>f?f:g;return o.isEven(x)||x--,u=e*x,p=t*x,c=l((s.height-u)/2),d=l((s.width-p)/2),a=d,h=c,r&&(r.height=u,r.width=p,void 0!==r.x&&(a=r.x),void 0!==r.y&&(h=r.y),r.x=d,r.y=c,r.x1=d,r.y1=c,r.x2=d+p,r.y2=c+u),m(a,h,e,t,x,x)},gridBBox(t,e,i){let s=i[0].length,n=i[0][0],r=i[i.length-1][s-1];return{x1:t+n.x1,x2:t+r.x2,y1:e+n.y1,y2:e+r.y2}},graphics(t=null){let e=new s.PXGraphics;return(e.m5={uuid:`${t||o.nextId()}`})&&e},drawGridBox(t,e=1,i="white",s=null){return s||(s=this.graphics()),s.lineStyle(e,this.color(i)),s.drawRect(t.x1,t.y1,t.x2-t.x1,t.y2-t.y1),s},drawGridBoxEx(t,e=1,i="white",s=1,n=null){return n||(n=this.graphics()),n.lineStyle(e,this.color(i)),n.drawRoundedRect(t.x1,t.y1,t.x2-t.x1,t.y2-t.y1,s),n},drawGridLines(t,e,i,s,n,r=null){let o=i.length,a=i[0].length;r||(r=this.graphics()),r.lineStyle(s,this.color(n));for(let s,n=1;n<o;++n)s=i[n],r.moveTo(t+s[0].x1,e+s[0].y1),r.lineTo(t+s[a-1].x2,e+s[a-1].y1);for(let s,n=1;n<a;++n)s=i[0],r.moveTo(t+s[n].x1,e+s[n].y1),s=i[o-1],r.lineTo(t+s[n].x1,e+s[n].y2);return r},shoot(t,e,i,s,n,o){let a=this.topLeftOffsetXY(t),h=s();return r.add$(a,[n,o]),r.copy(h,r.add(t,a)),r.set(h.m5.vel,Math.cos(e)*i,Math.sin(e)*i),h},group(...t){return 1===t.length&&a.vec(t[0])&&(t=t[0]),this.container((e=>t.forEach((t=>e.addChild(t)))))},add:(t,...e)=>(e.forEach((e=>e&&t.addChild(e))),t),remove(...t){1===t.length&&a.vec(t[0])&&(t=t[0]),o.doseqEx(t,(t=>{t.parent&&(o.inst(s.Scenes.Scene,t.parent)?t.parent.remove(t):t.parent.removeChild(t)),s.off(t),t.m5.dispose&&t.m5.dispose(),s.emit(["post.remove",t])}))},centerObj:t=>(t.x=s.width/2,t.y=s.height/2,t.anchor.x<.3?(t.x-=t.width/2,t.y-=t.height/2):t.anchor<.7||o.assert(!1,"bad anchor to center"),t),fillMax:t=>(t.anchor&&o.assert(t.anchor.x<.3,"wanted top left anchor"),t.height=s.height,t.width=s.width,t.x=0,t.y=0,t),colorToRgbA(t){if(!t||!a.str(t)||0===t.length)return;let e=t.toLowerCase(),s=i[e];if(s&&(t=s),"#"==t[0])return t.length<7&&(t=`#${t[1]}${t[1]}${t[2]}${t[2]}${t[3]}${t[3]}${t.length>4?t[4]+t[4]:""}`),[parseInt(t.substr(1,2),16),parseInt(t.substr(3,2),16),parseInt(t.substr(5,2),16),t.length>7?parseInt(t.substr(7,2),16)/255:1];if("transparent"==e)return[0,0,0,0];if(0===e.indexOf("rgb"))return e.indexOf("rgba")<0&&(e+=",1"),e.match(/[\.\d]+/g).map((t=>+t));throw`Error: Bad color: ${t}`},byteToHex:t=>("0"+t.toString(16)).slice(-2),colorToHex(t){const e=this.colorToRgbA(t);return"0x"+[0,1,2].map((t=>this.byteToHex(e[t]))).join("")},color3(t,e,i){return parseInt(["0x",this.byteToHex(t),this.byteToHex(e),this.byteToHex(i)].join(""))},color(t){return isNaN(t)?parseInt(this.colorToHex(t)):t},rgba(t){return o.assert(a.vec(t),"wanted rgba array"),parseInt("0x"+[0,1,2].map((e=>this.byteToHex(t[e]))).join(""))},hsla(t,e,i,s){function n(t){return Math.min(1,Math.max(0,t))}function r(t){return 6*(t=t<0?t+1:t>1?t-1:t)<1?a+(o-a)*t*6:2*t<1?o:3*t<2?a+(o-a)*(2/3-t)*6:a}t=t%360/360,e=n(e),i=n(i),s=n(s);let o=i<=.5?i*(e+1):i+e-i*e,a=2*i-o;return this.rgba([255*r(t+1/3),255*r(t),255*r(t-1/3),s])},resize(t,e,i,s,n){t&&o.doseqEx(t.children,(e=>e.m5&&e.m5.resize&&e.m5.resize(t.x,t.y,t.width,t.height)))},pinTop(t,e,i=10,s=.5){let[n,o,a,h,l]=f(this,t),[c,d,u,p,g]=f(this,e,t),m=n.y1-i-(c.y2-c.y1),x=s<.3?n.x1:s<.7?h-d:n.x2-(c.x2-c.x1);e.y=!e.anchor||e.anchor.y<.3?m:e.anchor.y<.7?m+u:m+(c.y2-c.y1),e.x=!e.anchor||e.anchor.x<.3?x:e.anchor.x<.7?x+d:x+(c.x2-c.x1),e.parent===t&&r.sub$(e,t)},pinBottom(t,e,i=10,s=.5){let[n,o,a,h,l]=f(this,t),[c,d,u,p,g]=f(this,e,t),m=n.y2+i,x=s<.3?n.x1:s<.7?h-d:n.x2-(c.x2-c.x1);e.y=!e.anchor||e.anchor.y<.3?m:e.anchor.y<.7?m+u:m+(c.y2-c.y1),e.x=!e.anchor||e.anchor.x<.3?x:e.anchor.x<.7?x+d:x+(c.x2-c.x1),e.parent===t&&r.sub$(e,t)},pinCenter(t,e){let[i,s,n,o,a]=f(this,t),[h,l,c,d,u]=f(this,e,t),p=o-l,g=a-c;e.y=!e.anchor||e.anchor.y<.3?g:e.anchor.y<.7?g+c:g+(h.y2-h.y1),e.x=!e.anchor||e.anchor.x<.3?p:e.anchor.x<.7?p+l:p+(h.x2-h.x1),(t.m5.stage||e.parent===t)&&r.sub$(e,t)},pinLeft(t,e,i=10,s=.5){let[n,o,a,h,l]=f(this,t),[c,d,u,p,g]=f(this,e,t),m=n.x1-i-(c.x2-c.x1),x=s<.3?n.y1:s<.7?l-u:n.y2-(c.y2-c.y1);e.y=!e.anchor||e.anchor.y<.3?x:e.anchor.y<.7?x+u:x+(c.y2-c.y1),e.x=!e.anchor||e.anchor.x<.3?m:e.anchor.x<.7?m+d:m+(c.x2-c.x1),e.parent===t&&r.sub$(e,t)},pinRight(t,e,i=10,s=.5){let[n,o,a,h,l]=f(this,t),[c,d,u,p,g]=f(this,e,t),m=n.x2+i,x=s<.3?n.y1:s<.7?l-u:n.y2-(c.y2-c.y1);e.y=!e.anchor||e.anchor.y<.3?x:e.anchor.y<.7?x+u:x+(c.y2-c.y1),e.x=!e.anchor||e.anchor.x<.3?m:e.anchor.x<.7?m+d:m+(c.x2-c.x1),e.parent===t&&r.sub$(e,t)},setMass(t,e){t.m5.mass=e},genTexture:(t,e,i,s)=>c(t,e,i,s),bounceOff:t=>x(t.A,t.B,t),hit(t,e){let i=y(this,t,e);return i&&(s.emit(["hit",t],i),s.emit(["hit",e],i.swap())),i},collide(t,e,i=!0){let n=function(t,e,i,s=!0){let n=y(t,e,i);if(n){if(i.m5.static)r.sub$(e,n.overlapV);else{let t=r.div(n.overlapV,2);r.sub$(e,t),r.add$(i,t)}s&&x(e,i,n)}return n}(this,t,e,i);return n&&function(t){const e=new Set;return t.overlapN[1]<-.3&&e.add(s.TOP),t.overlapN[1]>.3&&e.add(s.BOTTOM),t.overlapN[0]<-.3&&e.add(s.LEFT),t.overlapN[0]>.3&&e.add(s.RIGHT),e}(n)},hitTest(t,e){return y(this,t,e)},clamp(t,e,i=!1,r=null){let h,l,c,d,u,p;a.vec(e)&&(h=e[1].left,l=e[1].right,c=e[1].top,d=e[1].bottom,e=e[0]),l=!1!==l,h=!1!==h,c=!1!==c,d=!1!==d,e instanceof s.Scenes.Scene?p=s.mockStage():e.m5&&e.m5.stage?p=e:void 0!==e.x2&&void 0!==e.y2?(p=e,u=!0):(e.isSprite?o.assert(t.parent===e):o.assert(!1,"Error: clamp() using bad container"),o.assert(o.feq0(e.rotation),"Error: clamp() container can't rotate"),o.assert(o.feq0(e.anchor.x),"Error: clamp() container anchor.x !==0"),o.assert(o.feq0(e.anchor.y),"Error: clamp() container anchor.y !==0"),p=e);let g=u?[0,0]:this.topLeftOffsetXY(p),m=new Set,f=!1,x=!1,y=n.getAABB(this.toShape(t)),w=u?p.x1:p.x+g[0],v=w+(u?p.x2-p.x1:p.width),b=u?p.y1:p.y+g[1],T=b+(u?p.y2-p.y1:p.height),[S,I]=y.pos;return h&&S<w&&(t.x+=w-S,f=!0,m.add(s.LEFT)),l&&S+y.width>v&&(t.x-=S+y.width-v,f=!0,m.add(s.RIGHT)),c&&I<b&&(t.y+=b-I,x=!0,m.add(s.TOP)),d&&I+y.height>T&&(t.y-=I+y.height-T,x=!0,m.add(s.BOTTOM)),m.size>0?(f&&(t.m5.vel[0]/=t.m5.mass,i&&(t.m5.vel[0]*=-1)),x&&(t.m5.vel[1]/=t.m5.mass,i&&(t.m5.vel[1]*=-1)),r&&r(m)):m=null,m},dbgShowDir(t){let e="?";switch(t){case s.NE:e="top-right";break;case s.NW:e="top-left";break;case s.TOP:case s.UP:e="top";break;case s.LEFT:e="left";break;case s.RIGHT:e="right";break;case s.BOTTOM:case s.DOWN:e="bottom";break;case s.SE:e="bottom-right";break;case s.SW:e="bottom-left"}return e},dbgShowCol(t){let e=[];if(a.set(t))for(let i of t.values())e.push(this.dbgShowDir(i));return e.join(",")}};return w.bmpText=w.bitmapText,s.Sprites=w}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Sprites"]=function(t){return t.Sprites?t.Sprites:s(t)}}(this),function(t){"use strict";function e(e,i){const s=t["io/czlab/mcfud/spatial"](),{ute:n,is:r}=e,o=Math.floor;function a(t){return t.startsWith("scene::")?t:`scene::${t}`}function h(t){t&&(t.dispose&&t.dispose(),t.parent.removeChild(t))}class l extends e.PXContainer{constructor(t){super(),this.addChild(t),this.name=t.name,this.m5={stage:!0}}dispose(){h(this.children[0])}update(t){this.children[0].update(t)}}class c extends e.PXContainer{constructor(t,e,i){if(super(),this.name=a(t),this.g={},this.m5={sid:t,index:{},queue:[],garbo:[],options:i,stage:!0,sgrid:s.spatialGrid(i.sgridX||320,i.sgridY||320)},r.fun(e))this.m5.setup=e.bind(this);else if(r.obj(e)){let t=n.dissoc(e,"setup");n.inject(this,e),t&&(this.m5.setup=t.bind(this))}}_hitObjects(t,i,s,n=3){let r=n;for(let n,o,a=0,h=s.length;a<h&&(o=s[a],!(i!==o&&!o.m5.dead&&i.m5.cmask&o.m5.type&&(n=e.Sprites.hitTest(i,o),n&&(e.emit(["hit",i],n),n.B.m5.static||e.emit(["hit",n.B],n.swap()),t.engrid(i),0==--r))));++a);}collideXY(t){this._hitObjects(this.m5.sgrid,t,this.m5.sgrid.search(t))}onCanvasResize([t,i]){e.Sprites.resize({x:0,y:0,width:t,height:i,children:this.children})}future(t,i){this.m5.queue.push([t,o(e._curFPS*i/1e3)])}XXfuture(t,e){this.m5.queue.push([t,e])}getChildById(t){return t&&this.m5.index[t]}remove(t){r.str(t)&&(t=this.getChildById(t)),t&&(this.removeChild(t),t.m5._engrid&&this.m5.sgrid.degrid(t),t.m5.drag&&e.Input.undoDrag(t),t.m5.button&&e.Input.undoButton(t),e.off(t),n.dissoc(this.m5.index,t.m5.uuid))}degrid(t){return t&&this.m5.sgrid.degrid(t),t}engrid(t){return t&&t.m5._engrid&&this.m5.sgrid.engrid(t),t}insert(t,e=!1){return this.insertAt(t,null,e)}insertAt(t,e,i=!1){return t=this._addit(t,e),i&&(t instanceof PIXI.TilingSprite||(t.m5._engrid=!0,t.visible&&this.m5.sgrid.engrid(t))),t}_addit(t,e){return r.num(e)&&e>=0&&e<this.children.length?this.addChildAt(t,e):this.addChild(t),this.m5.index[t.m5.uuid]=t}dispose(){e.off(this),this.m5.dead=!0,function t(i){if(i){i.children.length>0&&i.children.forEach((e=>t(e)));const s=e.Input;i.m5&&(i.m5.drag&&s.undoDrag(i),i.m5.button&&s.undoButton(i))}}(this),this.removeChildren()}_tick(t,i){t.forEach((t=>{t.visible&&t.m5&&t.m5.tick&&(t.m5.tick(i),"x"==t.m5.flip&&(t.scale.x*=-1),"y"==t.m5.flip&&(t.scale.y*=-1),t.m5.flip=!1,e.emit(["post.tick",t],i),t.m5._engrid&&this.m5.sgrid.engrid(t)),t.children.length>0&&this._tick(t.children,i)}))}searchSGrid(t,e=!1){return this.m5.sgrid.search(t,e)}queueForRemoval(t){return this.m5.garbo.push(t),t}update(t){if(this.m5.dead)return;let e,i=this.m5.queue.filter((t=>(t[1]-=1,t[1]<=0)));for(;i.length>0;)n.disj(this.m5.queue,e=i.shift()),e[0]();this.preUpdate&&this.preUpdate(t),this._tick(this.children,t),this.postUpdate&&this.postUpdate(t),this.m5.garbo.forEach((t=>this.remove(t))),this.m5.garbo.length=0}runOnce(){this.m5.setup&&(this.m5.setup(this.m5.options),delete this.m5.setup)}}function d(t,i,s){const{Sprites:a}=e,h=e.getScaleFactor();if(0===t.length)return;let l,c,d,u=(i=n.patch(i,{bg:0,padding:10,fit:20,borderWidth:4,border:16777215})).borderWidth*h,p=i.group||a.group(),g=i.padding*h,m=2*(i.fit*h);!function(t,i,s,r,o){let a,h=0,l=-1;i.forEach(((i,s)=>{r===e.DOWN?i.width>l&&(h=s,l=i.width):i.height>l&&(h=s,l=i.height),o||t.addChild(i),n.assert(i.anchor.x<.3&&i.anchor.y<.3,"wanted topleft anchor")})),a=i[h];for(let t,n=h-1;n>=0;--n)t=i[n],e.Sprites[r===e.DOWN?"pinTop":"pinLeft"](a,t,s),a=t;a=i[h];for(let t,n=h+1;n<i.length;++n)t=i[n],e.Sprites[r===e.DOWN?"pinBottom":"pinRight"](a,t,s),a=t}(p,t,g,s,i.skipAdd),c=p.width,d=p.height,l=n.tail(t);{let t=a.rect(c+m,d+m,i.bg,i.border,u);p.addChildAt(t,0),r.vec(i.bg)||(t.alpha=0===i.opacity?0:i.opacity||.5,"transparent"==i.bg&&(t.alpha=0))}d=p.height,c=p.width;let[f,x]=[o(c/2),o(d/2)];if(s===e.DOWN){t.forEach((t=>t.x=f-o(t.width/2)));let e=d-(l.y+l.height);e=o(e/2),t.forEach((t=>t.y+=e))}else{t.forEach((t=>t.y=x-o(t.height/2)));let e=c-(l.x+l.width);e=o(e/2),t.forEach((t=>t.x+=e))}return d=p.height,c=p.width,p.x=n.nor(i.x,o((e.width-c)/2)),p.y=n.nor(i.y,o((e.height-d)/2)),p}function u(t,i,s){const n=e.Sprites.color(i.selectedColor),r=e.Sprites.color(i.disabledColor);let o;t.forEach((t=>{t.m5.uuid==i.defaultChoice?(o=t,t.tint=n):t.tint=r,e.Input.mkBtn(t),t.m5.press=t=>{t!==o&&(o.tint=r,t.tint=n,o=t,i.onClick&&i.onClick(t))}})),o||(o=t[0],o.tint=n);let a=d(t,i,s);return a.getSelectedChoice=function(){return o.m5.uuid},a}const p={Scene:c,SceneWrapper:l,layoutX:(t,i)=>d(t,i,e.RIGHT),layoutY:(t,i)=>d(t,i,e.DOWN),choiceMenuX:(t,i)=>u(t,i,e.RIGHT),choiceMenuY:(t,i)=>u(t,i,e.DOWN),defScene(t,e,s){r.fun(e)&&(e={setup:e}),i[t]=[e,s]},replaceScene(t,i,s){const n=a(r.str(t)?t:t.name),o=e.stage.getChildByName(n);if(!o)throw`Fatal: no such scene: ${n}`;return this.runScene(i,e.stage.getChildIndex(o),s)},removeScene(...t){1===t.length&&r.vec(t[0])&&(t=t[0]),t.forEach((t=>{r.str(t)?h(e.stage.getChildByName(a(t))):t&&h(t)}))},removeScenes(){for(;e.stage.children.length>0;)h(e.stage.children[e.stage.children.length-1]);e.mouse.reset(),e.Input.reset()},findScene:t=>e.stage.getChildByName(a(t)),runSceneEx(t,e,i){this.removeScenes(),this.runScene(t,e,i)},runSceneSeq(...t){t.forEach((t=>{n.assert(r.vec(t),"Expecting array"),this.runScene(t[0],t[1],t[2])}))},runScene(t,s,o){let a,d,u,p=i[t];if(!p)throw`Fatal: unknown scene: ${t}`;if(r.obj(s)&&(o=s,s=n.dissoc(o,"slot")),o=n.inject({},p[1],o),u=n.inject({},p[0]),r.undef(s)&&(s=o.slot||-1),o.tiled?(n.assert(o.tiled.name,"no tmx file!"),d=new e.Tiles.TiledScene(t,u,o)):d=new c(t,u,o),a=d,o.centerStage&&(a=new l(d)),s>=0&&s<e.stage.children.length){let t=e.stage.getChildAt(s);e.stage.addChildAt(a,s),h(t)}else e.stage.addChild(a);return d.runOnce(),d}};return e.Scenes=p}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Scenes"]=function(t){return t.Scenes?t.Scenes:e(t,{})}}(this),function(t){"use strict";if(!t.AudioContext)throw"Fatal: no audio.";const e=console;Math.floor;function i(i,s){const{ute:n,is:r}=i,o=new Map;let a=1;function h(t,e,r){let h=0,l=1;const c={sids:new Map,buffer:null,loop:!1,src:r,name:e,get pan(){return h},set pan(t){h=t},get volume(){return l},set volume(t){l=t},play(){if(!i.Sound.sfx())return;const e=n.now();if(!function(t,e,i){let s;return o.has(t)&&o.get(t)>e?s=!0:i?o.set(t,e+i):o.delete(t),s}(this.name,e)){let e=a++,i=1e3*this.buffer.duration,s=t.ctx.createGain(),r=t.ctx.createStereoPanner(),o=t.ctx.createBufferSource();o.buffer=this.buffer,o.connect(s),s.connect(r),r.connect(t.ctx.destination),this.loop?o.loop=!0:n.delay(i,(()=>this.sids.delete(e))),r.pan.value=h,s.gain.value=l,o.start(0),this.sids.set(e,o)}},stop(){this.sids.forEach((t=>t.stop(0))),this.sids.length=0}};return s[e]=c}const l={ctx:new t.AudioContext,_mute:0,init(){n.delay(0,(()=>{"suspended"==this.ctx.state&&this.ctx.resume()}))},sfx(){return 0===this._mute},mute(){return this._mute=1,this},unmute(){return this._mute=0,this},decodeData(t,i,s,n,r){let o=h(this,t,i);return this.ctx.decodeAudioData(s,(t=>{n(o.buffer=t),e.log(`decoded sound file:${i}`)}),(t=>{r&&r(i,t)})),o},decodeUrl(t,e,i,s){let n=new XMLHttpRequest,r=h(this,t,e);return n.open("GET",e,!0),n.responseType="arraybuffer",n.addEventListener("load",(()=>{this.decodeData(e,n.response,i,s)})),n.send(),r}};return i.sound=function(t){return s[i.assetPath(t)]||n.assert(!1,`Sound: ${t} not loaded.`)},i.Sound=l}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Sound"]=function(t){return t.Sound?t.Sound:i(t,{})}}(this),function(t){"use strict";function e(e){const i=t["io/czlab/mcfud/geo2d"](),s=t["io/czlab/mcfud/vec2"](),{ute:n,is:r}=e,o=[];function a(){return o[0]}function h(t={}){function o(e){t.keyInputs.set(e.keyCode,!1),t.shiftKey=e.shiftKey,t.ctrlKey=e.ctrlKey,t.altKey=e.altKey,e.preventDefault()}function a(e){t.keyInputs.set(e.keyCode,!0),t.ctrlKey=!1,t.altKey=!1,t.shiftKey=!1,e.preventDefault()}return n.inject(t,{keyInputs:n.jsMap(),pauseInput:!1,ctrlKey:!1,altKey:!1,shiftKey:!1,ptr:null,dispose(){this.ptr.dispose(),e.touchDevice||n.delEvent([["keyup",window,o,!1],["keydown",window,a,!1]])},pointer(){return this.ptr||(this.ptr=function(t){let r={ActiveDragsID:n.jsMap(),ActiveDrags:n.jsMap(),ActiveTouches:n.jsMap(),Hotspots:[],Buttons:[],DragDrops:[],state:[!1,!0],touchZeroID:0,_visible:!0,_x:0,_y:0,width:1,height:1,downTime:0,downAt:[0,0],elapsedTime:0,dragged:null,dragOffsetX:0,dragOffsetY:0,anchor:e.makeAnchor(.5,.5),get cursor(){return e.canvas.style.cursor},set cursor(t){e.canvas.style.cursor=t},get x(){return this._x/e.scale},get y(){return this._y/e.scale},get visible(){return this._visible},get isUp(){return this.state[1]},get isDown(){return this.state[0]},set visible(t){this.cursor=t?"auto":"none",this._visible=t},update(t){e.touchDevice?this.updateMultiDrags(t):this.updateDrags(t)},updateMultiDrags(t){let e=r;for(let t,i,r=0;r<e.ActiveTouches.length;++r){i=e.ActiveTouches[r];for(let r,o,a=e.DragDrops.length-1;a>=0;--a){if(o=e.DragDrops[a],r=e.ActiveDrags.get(o.m5.uuid),r){s.set(r.dragged,r.dragStartX+(i.x-r.dragPtrX),r.dragStartY+(i.y-r.dragPtrY));break}if(o.m5.drag&&e._test(o,i.x,i.y)){n.assoc(e.ActiveDrags,o.m5.uuid,r={dragStartX:o.x,dragStartY:o.y,dragPtrX:i.x,dragPtrY:i.y,dragged:o,id:i.id}),n.assoc(e.ActiveDragsID,i.id,r),t=o.parent.children,n.disj(t,o),t.push(o);break}}}},updateDrags(t){if(this.state[0])if(this.dragged)s.set(this.dragged,this.dragStartX+(this.x-this.dragPtrX),this.dragStartY+(this.y-this.dragPtrY));else for(let t,e,i=this.DragDrops.length-1;i>=0;--i)if(e=this.DragDrops[i],e.m5.drag&&this.hitTest(e)){this.dragStartX=e.x,this.dragStartY=e.y,this.dragPtrX=this.x,this.dragPtrY=this.y,this.dragged=e,t=e.parent.children,n.disj(t,e),t.push(e);break}this.state[1]&&(this.dragged&&this.dragged.m5.onDragDropped&&this.dragged.m5.onDragDropped(),this.dragged=null)},getGlobalPosition(){return{x:this.x,y:this.y}},_press(){if(!t.pauseInput)for(let t,e=0,i=this.Buttons.length;e<i;++e)if(t=this.Buttons[e],t.m5.press&&this.hitTest(t)){t.m5.press(t);break}},_doMDown(t){let e,i=r;for(let s,n=0;n<i.Hotspots.length;++n)if(s=i.Hotspots[n],s.m5.touch&&i.hitTest(s)){s.m5.touch(s,t),e=!0;break}return e},mouseDown(i){let s=r,o=n.now();0===i.button&&(i.preventDefault(),s._x=i.pageX-i.target.offsetLeft,s._y=i.pageY-i.target.offsetTop,n.setVec(s.state,!0,!1),s.downTime=o,s.downAt[0]=s._x,s.downAt[1]=s._y,e.Sound.init(),t.pauseInput||(e.emit(["mousedown"]),s._doMDown(!0)))},mouseMove(i){let s=r;s._x=i.pageX-i.target.offsetLeft,s._y=i.pageY-i.target.offsetTop,t.pauseInput||e.emit(["mousemove"])},mouseUp(i){let o=r,a=n.now();if(0===i.button&&(i.preventDefault(),o.elapsedTime=Math.max(0,a-o.downTime),o._x=i.pageX-i.target.offsetLeft,o._y=i.pageY-i.target.offsetTop,n.setVec(o.state,!1,!0),!t.pauseInput&&(e.emit(["mouseup"]),!o._doMDown(!1)))){let t=s.vecAB(o.downAt,o),i=s.len2(t);i<400&&o.elapsedTime<200?(e.emit(["single.tap"]),o._press()):o._swipeMotion(t,i,o.elapsedTime)}},_swipeMotion(t,i,n,r){let o,a=s.unit$(s.normal(t));i>400&&n<1e3&&(Math.abs(a[0])>.8||Math.abs(a[1])>.8)&&(a[0]>.8&&(o="swipe.down"),a[0]<-.8&&(o="swipe.up"),a[1]>.8&&(o="swipe.left"),a[1]<-.8&&(o="swipe.right")),o&&e.emit([o],r)},_doMTouch(t,e){let i=r,s=n.jsMap();for(let n,r=0;r<t.length;++r){n=t[r];for(let t,r=0;r<i.Hotspots.length;++r)if(t=i.Hotspots[r],t.m5.touch&&i._test(t,n.x,n.y)){t.m5.touch(t,e),s.set(n.id,1);break}}return s},_doMDrag(t,e){let i=r;for(let s,n,r=0;r<t.length;++r)n=t[r],e.get(n.id)||(s=i.ActiveDragsID.get(n.id),s&&(e.set(n.id,1),s.dragged.m5.onDragDropped&&s.dragged.m5.onDragDropped(),i.ActiveDragsID.delete(n.id),i.ActiveDrags.delete(s.dragged.m5.uuid)));return e},touchCancel(t){console.warn("received touchCancel event!"),this.freeTouches()},touchStart(i){let s=r,o=i.target,a=[],h=n.now(),l=i.targetTouches,c=s.ActiveTouches;i.preventDefault();for(let t,i,r,d,u,p=0;p<l.length;++p)u=l[p],d=u.identifier,i=u.pageX-o.offsetLeft,r=u.pageY-o.offsetTop,n.assoc(c,d,t={id:d,_x:i,_y:r,downTime:h,downAt:[i,r],x:i/e.scale,y:r/e.scale}),a.push(t),0===p&&(s.touchZeroID=d,s._x=i,s._y=r,s.downTime=h,s.downAt=[i,r],n.setVec(s.state,!0,!1));e.Sound.init(),t.pauseInput||(e.emit(["touchstart"],a),s._doMTouch(a,!0))},touchMove(i){let s=[],n=r,o=i.target,a=i.targetTouches;i.preventDefault();for(let t,i,r,h,l,c=0;c<a.length;++c)h=a[c],l=h.identifier,t=h.pageX-o.offsetLeft,i=h.pageY-o.offsetTop,l==n.touchZeroID&&(n._x=t,n._y=i),(r=n.ActiveTouches.get(l))&&(r.x=t/e.scale,r.y=i/e.scale,r._x=t,r._y=i,s.push(r));t.pauseInput||e.emit(["touchmove"],s)},touchEnd(i){let s,o,a,h,l,c,d=r,u=[],p=(i.targetTouches,i.changedTouches),g=i.target,m=n.now();for(i.preventDefault(),a=0;a<p.length;++a)l=p[a],c=l.identifier,s=l.pageX-g.offsetLeft,o=l.pageY-g.offsetTop,h=d.ActiveTouches.get(c),c==d.touchZeroID&&(d.elapsedTime=Math.max(0,m-d.downTime),n.setVec(d.state,!1,!0),d._x=s,d._y=o),h&&(h.elapsedTime=Math.max(0,m-h.downTime),d.ActiveTouches.delete(c),h._x=s,h._y=o,h.x=s/e.scale,h.y=o/e.scale,u.push(h));if(!t.pauseInput){e.emit(["touchend"],u);let t=d._doMTouch(u,!1);d._doMDrag(u,t),d._onMultiTouches(u,t)}},_onMultiTouches(t,i){let n=r;for(let r,o,a,h=0;h<t.length;++h)if(r=t[h],!i.get(r.id))if(o=s.vecAB(r.downAt,r),a=s.len2(o),a<400&&r.elapsedTime<200){e.emit(["single.tap"],r);for(let t,e=0,i=n.Buttons.length;e<i;++e)if(t=n.Buttons[e],t.m5.press&&n._test(t,r.x,r.y)){t.m5.press(t);break}}else n._swipeMotion(o,a,r.elapsedTime,r)},freeTouches(){n.setVec(this.state,!1,!0),this.touchZeroID=0,this.ActiveTouches.clear(),this.ActiveDrags.clear(),this.ActiveDragsID.clear()},reset(){n.setVec(this.state,!1,!0),this.freeTouches(),this.DragDrops.length=0,this.Buttons.length=0,this.Hotspots.length=0},_test(t,n,r){let o=e.Sprites,a=o.gposXY(t),h=o.toPolygon(t),l=s.translate(a,h.calcPoints);return i.hitTestPointInPolygon(n,r,l)},hitTest(t){return this._test(t,this.x,this.y)}};const o=[["mousemove",e.canvas,r.mouseMove],["mousedown",e.canvas,r.mouseDown],["mouseup",window,r.mouseUp],["touchmove",e.canvas,r.touchMove],["touchstart",e.canvas,r.touchStart],["touchend",window,r.touchEnd],["touchcancel",window,r.touchCancel]];return n.addEvent(o),r.dispose=function(){this.reset(),n.delEvent(o)},r}(this)),this.ptr},update(t){this.pauseInput||this.ptr.DragDrops.length>0&&this.ptr.update(t)},keybd(t,i,s){const o=this,a={press:i,release:s,isDown:!1,isUp:!0,ctrl:!1,alt:!1,shift:!1};function h(t){t.preventDefault(),a.code.includes(t.keyCode)&&(a.ctrl=t.ctrlKey,a.alt=t.altKey,a.shift=t.shiftKey,!o.pauseInput&&a.isUp&&a.press&&a.press(a.alt,a.ctrl,a.shift),a.isUp=!1,a.isDown=!0)}function l(t){t.preventDefault(),a.code.includes(t.keyCode)&&(o.pauseInput||a.isDown&&a.release&&a.release(),a.isUp=!0,a.isDown=!1,a.ctrl=!1,a.alt=!1,a.shift=!1)}return a.code=r.vec(t)?t:[t],e.touchDevice||n.addEvent([["keyup",window,l,!1],["keydown",window,h,!1]]),a.dispose=()=>{e.touchDevice||n.delEvent([["keyup",window,l,!1],["keydown",window,h,!1]])},a},reset(){this.pauseInput=!1,this.ctrlKey=!1,this.altKey=!1,this.shiftKey=!1,this.ptr.reset(),this.keyInputs.clear()},resize(){e.mouse=this.ptr,this.ptr.reset()},dbg(){console.log(`N# of touches= ${this.ptr.ActiveTouches.size}`),console.log(`N# of hotspots= ${this.ptr.Hotspots.length}`),console.log(`N# of buttons= ${this.ptr.Buttons.length}`),console.log(`N# of drags= ${this.ptr.DragDrops.length}`),console.log(`Mouse pointer = ${this.ptr}`)}}),e.touchDevice||n.addEvent([["keyup",window,o,!1],["keydown",window,a,!1]]),t}const l={LEFT:37,RIGHT:39,UP:38,DOWN:40,ZERO:48,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,ENTER:13,ESC:27,BACKSPACE:8,TAB:9,SHIFT:16,CTRL:17,ALT:18,SPACE:32,HOME:36,END:35,PGGUP:33,PGDOWN:34,isPaused:()=>a().pauseInput,resume(){a().pauseInput=!1},pause(){a().pauseInput=!0},dbg(){a().dbg()},resize(){a().resize()},reset(){a().reset()},setKeyOn(t){a().keyInputs.set(t,!0)},setKeyOff(t){a().keyInputs.set(t,!1)},keybd:(t,e,i)=>a().keybd(t,e,i),undoButton:t=>(n.disj(a().ptr.Buttons,t),t.m5.button=!1,t),makeButton:t=>(n.conj(a().ptr.Buttons,t),t.m5.button=!0,t),undoHotspot:t=>(n.disj(a().ptr.Hotspots,t),t.m5.hotspot=!1,t),makeHotspot:t=>(n.conj(a().ptr.Hotspots,t),t.m5.hotspot=!0,t),update(t){a().update(t)},makeDrag:t=>(n.conj(a().ptr.DragDrops,t),t.m5.drag=!0,t),undoDrag:t=>(n.disj(a().ptr.DragDrops,t),t.m5.drag=!1,t),keyUp(t){return!this.keyDown(t)},keyDown:t=>a().keyInputs.get(t),keyShift:()=>a().shiftKey,keyAlt:()=>a().altKey,keyCtrl:()=>a().ctrlKey,pointer:()=>a().pointer(),dispose(){o.forEach((t=>t.dispose()))},pop(){o.length>1&&(o.shift().dispose(),a().pauseInput=!1)},push(){o[0].pauseInput=!0,o.unshift(h())}};return e.canvas.style.touchAction="none",l.undoBtn=l.undoButton,l.mkBtn=l.makeButton,l.mkDrag=l.makeDrag,o.push(h()),e.Input=l}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Input"]=function(t){return t.Input?t.Input:e(t)}}(this),function(t){"use strict";function e(t){const e=Math.PI/8,i=3*e,s=5*e,n=7*e,{Sprites:r,Input:o,is:a,ute:h}=t,l=Math.sin,c=Math.cos,d=Math.abs,u=180/Math.PI;function p(r){function a(t){let e=t.changedTouches,i=t.target;e?(t=e[0],r.m5.touchId=e[0].identifier):r.m5.touchId=0,r.m5.startX=t.pageX-i.offsetLeft,r.m5.startY=t.pageY-i.offsetTop,r.m5.drag=!0,r.m5.static||(r.visible=!0,r.x=r.m5.startX,r.y=r.m5.startY),o.isPaused()||r.m5.onStart()}function p(t){r.m5.drag&&(r.m5.inner.position.set(0,0),r.m5.drag=!1,r.m5.static||(r.visible=!1),o.isPaused()||r.m5.onEnd())}function g(a){if(o.isPaused()||!r.visible||!r.m5.drag)return;let p,g=a.target;if(a.changedTouches){for(let t=0,e=a.changedTouches;t<e.length;++t)if(r.m5.touchId==e[t].identifier){p=[e[t].pageX-g.offsetLeft,e[t].pageY-g.offsetTop];break}}else p=[a.pageX-g.offsetLeft,a.pageY-g.offsetTop];let m=p?p[0]-r.m5.startX:0,f=p?p[1]-r.m5.startY:0,x=r.m5.range,y=0;if(p[0]=0,p[1]=0,h.feq0(m)&&h.feq0(f))return;let w,v=d(m),b=d(f);if(h.feq0(m))p[0]=0,f>0?(p[1]=f>x?x:f,y=270,w=t.DOWN):(p[1]=-(b>x?x:b),y=90,w=t.UP);else if(h.feq0(f))p[1]=0,m>0?(p[0]=v>x?x:v,y=0,w=t.RIGHT):(p[0]=-(v>x?x:v),y=180,w=t.LEFT);else{let r=Math.atan(d(f/m));y=r*u,p[0]=p[1]=0,m*m+f*f>=x*x?(p[0]=x*c(r),p[1]=x*l(r)):(p[0]=v>x?x:v,p[1]=b>x?x:b),f<0&&(p[1]=-d(p[1])),m<0&&(p[0]=-d(p[0])),m>0&&f<0||(m<0&&f<0?y=180-y:m<0&&f>0?y+=180:m>0&&f>0&&(y=360-y)),w=function(r,o){const a=Math.atan2(+o,+r);return a>-s&&a<-i?(console.log("calcDir=UP"),t.UP):a>i&&a<s?(console.log("calcDir=DOWN"),t.DOWN):a>-e&&a<0||a>0&&a<e?(console.log("calcDir=RIGHT"),t.RIGHT):a>n&&a<Math.PI||a>-Math.PI&&a<-n?(console.log("calcDir=LEFT"),t.LEFT):a>e&&a<i?(console.log("calcDir= SE "),t.SE):a>s&&a<n?(console.log("calcDir= SW "),t.SW):a>-i&&a<-e?(console.log("calcDir= NE "),t.NE):a>-n&&a<-s?(console.log("calcDir= NW "),t.NW):void h.assert(!1,"Failed Joystick calcDir")}(p[0],p[1])}r.m5.inner.position.set(p[0],p[1]),r.m5.onChange(w,y)}const m=[["mousemove",t.canvas,g],["mousedown",t.canvas,a],["mouseup",window,p],["touchend",window,p],["touchcancel",window,p],["touchmove",t.canvas,g],["touchstart",t.canvas,a]];return h.addEvent(m),r.m5.dispose=()=>{h.delEvent(m)},r}const g={assets:["boot/joystick.png","boot/joystick-handle.png"],joystick(t){let e=r.sprite("boot/joystick-handle.png"),i=r.sprite("boot/joystick.png"),s=new PIXI.Container,n=h.inject({oscale:.7,iscale:1,inner:e,outer:i,onEnd(){},onStart(){},prevDir:0,static:!1,onChange(t,e){}},t);return r.scaleXY(i,n.oscale,n.oscale),r.scaleXY(e,n.iscale,n.iscale),i.anchor.set(.5),e.anchor.set(.5),s.addChild(i),s.addChild(e),n.range=s.width/2.5,n.static||(s.visible=!1),s.m5=n,p(s)}};return t.Touch=g}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Touch"]=function(t){return t.Touch?t.Touch:e(t)}}(this),function(t){"use strict";function e(e){const i=t["io/czlab/mcfud/vec2"](),s=t["io/czlab/mcfud/math"](),{Scenes:n,Sprites:r,is:o,ute:a}=e,h=Math.abs,l=Math.cos,c=Math.sin,d=Math.floor,u=Math.PI/180;Math.PI;n.defScene("PhotoMat",{setup(t){t.cb?t.cb(this):(this.g.gfx=r.graphics(),this.g.gfx.beginFill(r.color(t.color)),this.g.gfx.drawRect(0,0,e.width,t.y1),this.g.gfx.drawRect(0,t.y2,e.width,e.height-t.y2),this.g.gfx.drawRect(0,0,t.x1,e.height),this.g.gfx.drawRect(t.x2,0,e.width-t.x2,e.height),this.g.gfx.endFill(),this.insert(this.g.gfx))}}),n.defScene("StarfieldBg",{setup(t){t.height||(t.height=e.height),t.width||(t.width=e.width),t.count||(t.count=100),t.minVel||(t.minVel=15),t.maxVel||(t.maxVel=30);const s=[],n=r.graphics();a.inject(this.g,{gfx:n,stars:s,lag:0,dynamic:!0,fps:1/t.fps,draw(){return n.clear(),s.forEach((t=>{n.beginFill(16777215),n.drawRect(t.x,t.y,t.size,t.size),n.endFill()})),this},moveStars(e){this.lag+=e,this.lag>=this.fps&&(this.lag=0,s.forEach((s=>{s.y+=e*s.vel,s.y>t.height&&(i.set(s,a.randInt(t.width),0),s.size=a.randInt(4),s.vel=a.rand()*(t.maxVel-t.minVel)+t.minVel)})),this.draw())}}),t.static&&(this.g.dynamic=!1);for(let e=0;e<t.count;++e)s[e]={x:a.rand()*t.width,y:a.rand()*t.height,size:3*a.rand()+1,vel:a.rand()*(t.maxVel-t.minVel)+t.minVel};this.g.draw()&&this.insert(n)},postUpdate(t){this.g.dynamic&&this.g.moveStars(t)}},{fps:90,count:100,minVel:15,maxVel:30});e.defMixin("2d",(function(t,...s){const{Sprites:n}=e,r=[],l=[],c=[],d={dispose(){r.forEach((t=>t.dispose())),l.forEach((t=>e.off(...t)))},boom(s){if(a.assert(s.A===t,"got hit by someone else???"),s.B&&s.B.m5.sensor)e.emit(["2d.sensor",s.B],s.A);else{let[n,r]=t.m5.vel;s.impact=null,i.sub$(t,s.overlapV),s.overlapN[1]<-.3&&(!t.m5.skipHit&&r<0&&i.setY(t.m5.vel,0),s.impact=h(r),e.emit(["bump.top",t],s)),s.overlapN[1]>.3&&(!t.m5.skipHit&&r>0&&i.setY(t.m5.vel,0),s.impact=h(r),e.emit(["bump.bottom",t],s)),s.overlapN[0]<-.3&&(!t.m5.skipHit&&n<0&&i.setX(t.m5.vel,0),s.impact=h(n),e.emit(["bump.left",t],s)),s.overlapN[0]>.3&&(!t.m5.skipHit&&n>0&&i.setX(t.m5.vel,0),s.impact=h(n),e.emit(["bump.right",t],s)),o.num(s.impact)?e.emit(["bump",t],s):s.impact=0}c.shift(s)},onTick(e){c.length=0,o.num(e)&&(i.add$(t.m5.vel,i.mul(t.m5.gravity,e)),i.add$(t.m5.vel,i.mul(t.m5.acc,e)),i.mul$(t.m5.vel,t.m5.friction)),t.parent.collideXY(n.move(t,e)),r.forEach((t=>t.onTick(e,c)))}};return l.push([["hit",t],"boom",d],[["post.remove",t],"dispose",d]),l.forEach((t=>e.on(...t))),s.forEach((e=>{let i,s=e[0];e[0]=t,i=s(...e),i.onTick&&r.push(i),a.assert(o.str(s.name))&&(d[s.name]=i)})),d})),e.defMixin("camera2d",(function(t,i,s,n){let r=0,h=0;const l=n?n.height:s,c=n?n.width:i,u=d(l/2),p=d(c/2),g=d(l/4),m=d(c/4),{Sprites:f}=e,x=[],y={dispose(){x.forEach((t=>e.off(...t)))},set x(e){r=e,t.x=-r},set y(e){h=e,t.y=-h},get x(){return r},get y(){return h},worldHeight:s,worldWidth:i,width:c,height:l,follow(t){const e=a.feq0(t.angle)?f.getBBox(t):f.boundingBox(t);(()=>{e.x1<this.x+d(p-m)&&(this.x=e.x1-m)})(),(()=>{e.x2>this.x+d(p+m)&&(this.x=e.x2-3*m)})(),(()=>{e.y1<this.y+d(u-g)&&(this.y=e.y1-g)})(),(()=>{e.y2>this.y+d(u+g)&&(this.y=e.y2-3*g)})(),this.x<0&&(this.x=0),this.y<0&&(this.y=0),this.x+c>i&&(this.x=i-c),this.y+l>s&&(this.y=s-l);let{x1:n,x2:r,y1:o,y2:h}=t.m5.getImageOffsets(),x=e.x2-r;x>i&&(t.x-=x-i),x=e.y2-h,x>s&&(t.y-=x-s),x=e.x1+n,x<0&&(t.x+=-x),x=e.y1+o,x<0&&(t.y+=-x)},centerOver:function(t,e){if(1!==arguments.length||o.num(t))o.num(t)&&(this.x=t-p),o.num(e)&&(this.y=e-u);else{let e=f.centerXY(t);this.x=e[0]-p,this.y=e[1]-u}}};return x.push([["post.remove",t],"dispose",y]),x.forEach((t=>e.on(...t))),y}));const p={PeriodicDischarge:class{constructor(t,e,i=16){this._interval=e,this._ctor=t,this._timer=0,this._size=i,this._pool=a.fill(i,t)}lifeCycle(t){this._timer+=t,this._timer>this._interval&&(this._timer=0,this.discharge())}discharge(){throw"PeriodicCharge: please implement action()"}reclaim(t){this._pool.length<this._size&&this._pool.push(t)}_take(){return this._pool.length>0?this._pool.pop():this._ctor()}},healthBar(t){let{scale:e,width:i,height:s,lives:o,borderWidth:a,line:h,fill:l}=t,c=4*e,u=4*e,p=[];a=(a||4)*e,o=o||3,l=r.color(l),h=r.color(h);for(let t=d(i/o),e=0;e<o;++e)p.push(r.rect(t,s-2*a,l));return{dec(){return this.lives>0&&(this.lives-=1,p[this.lives].visible=!1),this.lives>0},lives:p.length,sprite:n.layoutX(p,{bg:["#cccccc",0],borderWidth:a,border:h,padding:c,fit:u})}},gaugeUI(t){let{minDeg:e,maxDeg:i,line:n,gfx:o,scale:h,cx:d,cy:p,radius:g,alpha:m,fill:f,needle:x}=a.patch(t,{minDeg:90,maxDeg:360});const y=[0,45*u,90*u,135*u,180*u,225*u,270*u,315*u];function w(t,e,i,s){return[t+i*l(s),e+i*c(s)]}return x=r.color(x),n=r.color(n),f=r.color(f),g*=h,{gfx:o,draw(){o.clear(),o.lineStyle({width:g/8,color:n}),o.beginFill(f,m),o.drawCircle(d,p,g),o.endFill(),y.forEach((t=>function(t,e,i,s){let[r,a]=w(t,e,g-4*h,i),[l,c]=w(t,e,g-12*h,i);o.lineStyle({color:n,width:s,cap:PIXI.LINE_CAP.ROUND}),o.moveTo(r,a),o.lineTo(l,c),o.closePath()}(d,p,t,7*h))),function(t,e,i){let[s,r]=w(d,p,t-20*h,i),[a,l]=w(d,p,2*h,i+90*u),[c,g]=w(d,p,2*h,i-90*u);o.lineStyle({cap:PIXI.LINE_CAP.ROUND,width:4*h,color:x}),o.moveTo(a,l),o.lineTo(s,r),o.lineTo(c,g),o.closePath(),o.lineStyle({color:n}),o.beginFill(n),o.drawCircle(d,p,9*h),o.endFill()}(g*h,0,u*s.lerp(e,i,t.update()))}}},Patrol(t,s,n){const r=[],o={dispose(){r.forEach((t=>e.off(...t)))},goLeft(s){t.m5.heading=e.LEFT,t.m5.flip="x",i.setX(t.m5.vel,-s.impact)},goRight(s){t.m5.heading=e.RIGHT,t.m5.flip="x",i.setX(t.m5.vel,s.impact)},goUp(s){i.setY(t.m5.vel,-s.impact),t.m5.heading=e.UP,t.m5.flip="y"},goDown(s){i.setY(t.m5.vel,s.impact),t.m5.heading=e.DOWN,t.m5.flip="y"}};return r.push([["post.remove",t],"dispose",o]),s&&r.push([["bump.right",t],"goLeft",o],[["bump.left",t],"goRight",o]),n&&r.push([["bump.top",t],"goDown",o],[["bump.bottom",t],"goUp",o]),r.forEach((t=>e.on(...t))),o},Platformer(t){const{Input:s,Sprites:n}=e,r=[],o={jumpKey:s.UP,jumpSpeed:-300,_jumping:0,_ground:0,dispose(){r.forEach((t=>e.off(...t)))},onGround(){o._ground=.24},onTick(e,i){t.m5.skipHit||this._onTick(e,i),o._ground-=e},_onTick(n,r){let a=r[0],h=t.m5.speed,l=o.jumpSpeed/3,c=s.keyDown(s.RIGHT),d=s.keyDown(s.LEFT),u=s.keyDown(o.jumpKey);a&&(d||c||o._ground>0)&&(a.overlapN[1]>.85||a.overlapN[1]<-.85)&&(a=null),d&&!c?(t.m5.heading=e.LEFT,a&&o._ground>0?i.set(t.m5.vel,h*a.overlapN[0],-h*a.overlapN[1]):i.setX(t.m5.vel,-h)):c&&!d?(t.m5.heading=e.RIGHT,a&&o._ground>0?i.set(t.m5.vel,-h*a.overlapN[0],h*a.overlapN[1]):i.setX(t.m5.vel,h)):(i.setX(t.m5.vel,0),a&&o._ground>0&&i.setY(t.m5.vel,0)),o._ground>0&&!o._jumping&&u?(i.setY(t.m5.vel,o.jumpSpeed),o._jumping+=1,o._ground=-n):u&&o._jumping<2&&(o._jumping+=1,e.emit(["jump",t])),o._jumping&&!u&&(o._jumping=0,e.emit(["jumped",t]),t.m5.vel[1]<l&&(t.m5.vel[1]=l))}};return r.push([["bump.bottom",t],"onGround",o]),r.forEach((t=>e.on(...t))),o},MazeRunner(t,s){const{Sprites:n,Input:r}=e,h={dispose(){e.off(h)},onTick(n){let h,l,c,d,[u,p]=t.m5.vel,g=t.m5.speed,m=!a.feq0(u),f=!a.feq0(p);m&&f||!s||(f&&(o.obj(s)?t.m5.showFrame(s[p>0?e.DOWN:e.UP]):s&&(t.angle=p>0?180:0)),m&&(o.obj(s)?t.m5.showFrame(s[u>0?e.RIGHT:e.LEFT]):s&&(t.angle=u>0?90:-90))),e.u.touchOnly?(h=t.m5.heading===e.RIGHT,c=t.m5.heading===e.LEFT,d=t.m5.heading===e.UP,l=t.m5.heading===e.DOWN):(h=r.keyDown(r.RIGHT)&&e.RIGHT,l=r.keyDown(r.DOWN)&&e.DOWN,c=r.keyDown(r.LEFT)&&e.LEFT,d=r.keyDown(r.UP)&&e.UP),(c||d)&&(g*=-1),c&&h?i.setX(t.m5.vel,0):(c||h)&&(t.m5.heading=c||h,i.setX(t.m5.vel,g)),d&&l?i.setY(t.m5.vel,0):(d||l)&&(t.m5.heading=d||l,i.setY(t.m5.vel,g))}};return t.m5.heading=e.UP,h}};return e["2d"]=p}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/2d"]=t=>t["2d"]?t["2d"]:e(t)}(this),function(t){"use strict";function e(e,i,s){const n=t["io/czlab/mcfud/math"](),r=t["io/czlab/mcfud/vec2"](),{ute:o,is:a}=e,h=Math.floor,l=5*Math.PI,c=Math.PI/2;Math.PI;function d(t,s,n=60,r=!1,h={}){return o.inject({sprite:t,easing:s,on:!1,curf:0,loop:r,frames:n,onFrame(t,e){},_run(){this.on=!0,this.curf=0,i.push(this)},onTick(){this.on&&(this.curf<this.frames?(this.onFrame(!1,this.easing(this.curf/this.frames)),this.curf+=1):(this.onFrame(!0),this.loop?(a.num(this.loop)&&--this.loop,this.onLoopReset(),this.curf=0):(this.on=!1,this.onComplete&&o.delay(0,(()=>this.onComplete())),this.dispose())))},dispose(){o.disj(i,this),e.emit(["tween.disposed"],this)}},h)}function u(t,e,i,s){return d(t,e,i,s,{start(t,e,i,s){this._x=a.num(e)?[t,e]:null,this._y=a.num(s)?[i,s]:null,this._run()},onLoopReset(){if(this._x){let[t,e]=this._x;this._x[0]=e,this._x[1]=t}if(this._y){let[t,e]=this._y;this._y[0]=e,this._y[1]=t}},onFrame(t,e){this._x&&(this.sprite.x=t?this._x[1]:n.lerp(this._x[0],this._x[1],e)),this._y&&(this.sprite.y=t?this._y[1]:n.lerp(this._y[0],this._y[1],e))}})}const p={EXPO_IN:t=>0===t?0:Math.pow(1024,t-1),EXPO_OUT:t=>1===t?1:1-Math.pow(2,-10*t),EXPO_INOUT:t=>0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1))),LINEAR:t=>t,SMOOTH:t=>3*t*t-2*t*t*t,SMOOTH_QUAD(t){let e=p.SMOOTH(t);return e*e},SMOOTH_CUBIC(t){let e=p.SMOOTH(t);return e*e*e},EASE_IN_CUBIC:t=>t*t*t,EASE_OUT_CUBIC(t){let e=1-t;return 1-e*e*e},EASE_INOUT_CUBIC(t){if(t<.5)return 4*t*t*t;{let e=-2*t+2;return 1-e*e*e/2}},EASE_IN_QUAD:t=>t*t,EASE_OUT_QUAD:t=>1-(1-t)*(1-t),EASE_INOUT_QUAD(t){if(t<.5)return 2*t*t;{let e=-2*t+2;return 1-e*e/2}},EASE_IN_SINE:t=>1-Math.cos(t*c),EASE_OUT_SINE:t=>Math.sin(t*c),EASE_INOUT_SINE:t=>.5-Math.cos(t*Math.PI)/2,SPLINE:(t,e,i,s,n)=>(2*i+(s-e)*t+(2*e-5*i+4*s-n)*t*t+(3*i-e-3*s+n)*t*t*t)/2,CUBIC_BEZIER:(t,e,i,s,n)=>e*t*t*t+3*i*t*t*(1-t)+3*s*t*(1-t)*(1-t)+n*(1-t)*(1-t)*(1-t),ELASTIC_IN:t=>0===t?0:1===t?1:-Math.pow(2,10*(t-1))*Math.sin((t-1.1)*l),ELASTIC_OUT:t=>0===t?0:1===t?1:1+Math.pow(2,-10*t)*Math.sin((t-.1)*l),ELASTIC_INOUT(t){switch(t){case 0:return 0;case 1:return 1;default:return(t*=2)<1?-.5*Math.pow(2,10*(t-1))*Math.sin((t-1.1)*l):1+.5*Math.pow(2,-10*(t-1))*Math.sin((t-1.1)*l)}},BOUNCE_IN:t=>1-p.BOUNCE_OUT(1-t),BOUNCE_OUT:t=>t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375,BOUNCE_INOUT:t=>t<.5?.5*p.BOUNCE_IN(2*t):.5*p.BOUNCE_OUT(2*t-1)+.5,tweenAlpha(t,e,i,s=60,r=!1){const o=function(t,e,i,s){return d(t,e,i,s,{start(t,e){this._a=[t,e],this._run()},onLoopReset(){let[t,e]=this._a;this._a[0]=e,this._a[1]=t},onFrame(t,e){this.sprite.alpha=t?this._a[1]:n.lerp(this._a[0],this._a[1],e)}})}(t,e,s,r);let h=t.alpha,l=i;return a.vec(i)&&(h=i[0],l=i[1]),o.start(h,l),o},tweenAngle(t,e,i,s=60,r=!1){const o=function(t,e,i,s){return d(t,e,i,s,{start(t,e){this._a=[t,e],this._run()},onLoopReset(){let[t,e]=this._a;this._a[0]=e,this._a[1]=t},onFrame(t,e){this.sprite.rotation=t?this._a[1]:n.lerp(this._a[0],this._a[1],e)}})}(t,e,s,r);let h=t.rotation,l=i;return a.vec(i)&&(h=i[0],l=i[1]),o.start(h,l),o},tweenScale(t,e,i,s,r=60,o=!1){const h=function(t,e,i,s){return d(t,e,i,s,{start(t,e,i,s){this._x=a.num(e)?[t,e]:null,this._y=a.num(s)?[i,s]:null,this._run()},onLoopReset(){if(this._x){let[t,e]=this._x;this._x[0]=e,this._x[1]=t}if(this._y){let[t,e]=this._y;this._y[0]=e,this._y[1]=t}},onFrame(t,e){this._x&&(this.sprite.scale.x=t?this._x[1]:n.lerp(this._x[0],this._x[1],e)),this._y&&(this.sprite.scale.y=t?this._y[1]:n.lerp(this._y[0],this._y[1],e))}})}(t,e,r,o);let l=t.scale.x,c=t.scale.y,u=i,p=s;return a.vec(i)&&(l=i[0],u=i[1]),a.vec(s)&&(c=s[0],p=s[1]),a.num(u)||(l=u=null),a.num(p)||(c=p=null),h.start(l,u,c,p),h},tweenXY(t,e,i,s,n=60,r=!1){const o=u(t,e,n,r);let h=t.x,l=t.y,c=i,d=s;return a.vec(i)&&(h=i[0],c=i[1]),a.vec(s)&&(l=s[0],d=s[1]),a.num(c)||(h=c=null),a.num(d)||(l=d=null),o.start(h,c,l,d),o},fadeOut(t,e=60){return this.tweenAlpha(t,this.EASE_OUT_SINE,0,e)},fadeIn(t,e=60){return this.tweenAlpha(t,this.EASE_OUT_SINE,1,e)},pulse(t,e=0,i=60,s=!0){return this.tweenAlpha(t,this.SMOOTH,e,i,s)},slide(t,e,i,s,n=60){return this.tweenXY(t,e,i,s,n)},throb(t,e=.9,i=.9,s=60,n=!0){return this.tweenScale(t,this.SMOOTH_QUAD,e,i,s,n)},scale(t,e=.5,i=.5,s=60){return this.tweenScale(t,this.SMOOTH,e,i,s)},strobe(t,e=1.3,i=10,s=20,n=10,r=!0){return this.tweenScale(t,(t=>this.SPLINE(t,i,0,1,s)),e,e,n,r)},wobble(t,i,s=1.2,n=1.2,r=10,a=!0){let{x1:h,x2:l,y1:c,y2:d}=i;return function(...t){const i={children:t.slice(),onTweenEnd(t){for(let e,i=0;i<this.children.length;++i)if(e=this.children[i],e===t){this.children.splice(i,1);break}0===this.children.length&&(this.onComplete&&o.delay(0,(()=>this.onComplete())),this.dispose())},size(){return this.children.length},dispose(){e.off(["tween.disposed"],"onTweenEnd",this),this.children.forEach((t=>t.dispose())),this.children.length=0}};return e.on(["tween.disposed"],"onTweenEnd",i),i}(this.tweenScale(t,(t=>this.SPLINE(t,o.or(h,10),0,1,o.or(l,10))),s,null,r,a),this.tweenScale(t,(t=>this.SPLINE(t,o.or(c,-10),0,1,o.or(d,-10))),null,n,r,a))},followCurve(t,e,i,s=60){let n=u(t,e,s),o=this;return n.start=function(t){this._p=t,this._run()},n.onFrame=function(e,i){let s=this._p;e||r.set(t,o.CUBIC_BEZIER(i,s[0][0],s[1][0],s[2][0],s[3][0]),o.CUBIC_BEZIER(i,s[0][1],s[1][1],s[2][1],s[3][1]))},n.start(i),n},walkPath(t,e,i,s=300){let n=(s,r)=>{let a=this.tweenXY(t,e,[i[s][0],i[s+1][0]],[i[s][1],i[s+1][1]],r);return a.onComplete=()=>{++s<i.length-1&&o.delay(0,(()=>n(s,r)))},a};return n(0,h(s/i.length))},walkCurve(t,e,i,s=300){let n=(s,r)=>{let a=this.followCurve(t,e,i[s],r);return a.onComplete=()=>{++s<i.length&&o.delay(0,(()=>n(s,r)))},a};return n(0,h(s/i.length))},remove(t){t&&t.dispose()},update(t){o.rseq(i,(e=>e.onTick(t))),o.rseq(s,(e=>e.onTick(t)))},createParticles(t,i,n,a,h,l,c,d=!0,u=20){function p(d){let u=o.randInt2(l.size,c.size),p=n();s.push(p),a.addChild(p),p.totalFrames&&p.gotoAndStop(o.randInt2(0,p.totalFrames-1)),e.Sprites.sizeXY(p,u,u),r.set(p,t,i),e.Sprites.centerAnchor(p),p.m5.scaleSpeed=o.randFloat(l.scale,c.scale),p.m5.alphaSpeed=o.randFloat(l.alpha,c.alpha),p.m5.angVel=o.randFloat(l.rotate,c.rotate);let g=o.randFloat(l.speed,c.speed);r.set(p.m5.vel,g*Math.cos(d),g*Math.sin(d)),p.onTick=function(){r.add$(p.m5.vel,h),r.add$(p,p.m5.vel),p.scale.x-p.m5.scaleSpeed>0&&(p.scale.x-=p.m5.scaleSpeed),p.scale.y-p.m5.scaleSpeed>0&&(p.scale.y-=p.m5.scaleSpeed),p.rotation+=p.m5.angVel,p.alpha-=p.m5.alphaSpeed,p.alpha<=0&&(o.disj(s,p),e.Sprites.remove(p))}}l=o.patch(l,{angle:0,size:4,speed:.3,scale:.01,alpha:.02,rotate:.01}),c=o.patch(c,{angle:6.28,size:16,speed:3,scale:.05,alpha:.02,rotate:.03}),o.assert(u>1),h[0]=0;for(let t=(c.angle-l.angle)/(u-1),e=l.angle,i=0;i<u;++i)p(d?o.randFloat(l.angle,c.angle):e),e+=t},shake(t,e=16,i=!1,n=!0){let r={},a=1,l=t.x,c=t.y,d=t.rotation,u=e,p=h(e/10);let g=1;r.onTick=()=>i?void(a<10?(t.rotation=d,e-=p,t.rotation=e*g,++a,g*=-1):n?(e=u,a=1):o.disj(s,r)):void(a<10?(t.x=l,t.y=c,e-=p,t.x+=o.randInt2(-e,e),t.y+=o.randInt2(-e,e),++a):n?(e=u,a=1):o.disj(s,r)),s.push(r)}};return e.FX=p}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/FX"]=function(t){return t.FX?t.FX:e(t,[],[])}}(this),function(t){"use strict";function e(e){const i=[e.UP,e.LEFT,e.RIGHT,e.DOWN],s=t["io/czlab/mcfud/vec2"](),{ute:n,is:r}=e,o=Math.abs,a=Math.ceil,h=Math.floor;function l(t,i,s){return e.getIndex(t,i,s.tiled.tileW,s.tiled.tileH,s.tiled.tilesInX)}function c(t,i){return s.vecAB(e.Sprites.centerXY(t),e.Sprites.centerXY(i))}function d(t){const e=t.image,i=e&&e.split("/");t.image=i&&i.length&&i[i.length-1]}function u(t,e){let i=-1;if(t>0)for(i=0;e[i+1]&&t>=e[i+1][0];)++i;return i>=0?e[i]:[]}function p(t,e,i){let s=[];return t.forEach((t=>{s.push([t.firstgid,t]),t.spacing||(t.spacing=0),d(t);let r={};(t.tiles||[]).forEach((e=>{let s=n.selectNotKeys(e,"properties");s=n.inject(s,g(e)),s.gid=t.firstgid+e.id,r[e.id]=s,i[s.gid]=s})),e[t.name]=r})),s.sort(((t,e)=>t[0]>e[0]?1:t[0]<e[0]?-1:0))}function g(t){return(t.properties||[]).reduce(((t,e)=>(t[e.name]=e.value,t)),{})}function m(t,i,s,o){let a=r.str(i)?function(t){let i=e.resource(t,!0).data,s=i&&(i.tiledversion||i.version);return s&&n.cmpVerStrs(s,"1.4.2")>=0?i:n.assert(!1,`${t} needs update`)}(i):i,l={},c={};n.assert(r.obj(a),"bad tiled map"),a=JSON.parse(JSON.stringify(a)),n.inject(t.tiled,{tileW:a.tilewidth,tileH:a.tileheight,tilesInX:a.width,tilesInY:a.height,tiledMap:a,saved_tileW:a.tilewidth,saved_tileH:a.tileheight,tiledWidth:a.tilewidth*a.width,tiledHeight:a.tileheight*a.height},g(a));let m=o||t.getScaleFactor(),x=n.evenN(m*a.tileheight),y=n.evenN(m*a.tilewidth);t.tiled.new_tileW=y,t.tiled.new_tileH=x,o&&(t.tiled.scale=o);const w={imagelayer(t){d(t)},tilelayer(e){r.vec(e.data[0])&&(e.width=e.data[0].length,e.height=e.data.length,e.data=e.data.flat()),e.width||(e.width=t.tiled.tilesInX),e.height||(e.height=t.tiled.tilesInY);let i,n=g(e);if(!1!==e.visible)for(let i,r=0;r<e.data.length;++r){if(0==(i=e.data[r]))continue;!1===e.collision||!1===n.collision||!0!==e.collision&&!0!==n.collision||(i>0&&(t.tiled.collision[r]=i),e.collision=!0);let o=r%e.width,a=h(r/e.width),l=c[i],d=l&&l.Class,p=d&&s[d],g=u(i,t.tiled.tileGidList)[1],m=f(t,i,o,a,n.width,n.height);m&&(m.tiled.layer=e,m.tiled.index=r,m.m5.static=!0),p&&(m=p.c(t,m,g,l)),m&&(l&&l.sensor&&(m.m5.sensor=!0),t.insert(m,!!p))}else(i=n.Class)&&s[i](t,e)},objectgroup(e){e.sprites=[],e.objects.forEach((i=>{n.assert(r.num(i.x),"wanted xy position");let o,a,l=g(i),d=n.nor(i.gid,-1);n.inject(i,l),d>0&&(a=c[d]);let p=n.nor(a&&a.Class,i.Class),m=p&&s[p],w=t.tiled.saved_tileW,v=t.tiled.saved_tileH,b=h((i.x+w/2)/w),T=h((i.y-v/2)/v),S=u(d,t.tiled.tileGidList)[1];i.column=b,i.row=T,o=d<=0?{width:y,height:x}:f(t,d,b,T,i.width,i.height,p),m&&(o=m.c(t,o,S,a,i)),o&&(!1===i.visible&&(o.visible=!1),i.uuid=o.m5.uuid,e.sprites.push(o),t.insert(o,!0),a&&a.sensor&&(o.m5.sensor=!0))}))}};s=n.nor(s,{}),n.inject(t.tiled,{objFactory:s,tileSets:l,tileProps:c,collision:n.fill(a.width*a.height,0),imagelayer:[],objectgroup:[],tilelayer:[],tileGidList:p(a.tilesets,l,c)}),["imagelayer","tilelayer","objectgroup"].forEach((e=>{a.layers.filter((t=>t.type==e)).forEach((i=>{w[e](i),t.tiled[e].push(i)}))})),t.tiled.tileW=y,t.tiled.tileH=x,t.tiled.tiledWidth=y*a.width,t.tiled.tiledHeight=x*a.height,t.parent instanceof e.Scenes.SceneWrapper&&(t.tiled.tiledHeight<e.height&&(t.parent.y=h((e.height-t.tiled.tiledHeight)/2)),t.tiled.tiledWidth<e.width&&(t.parent.x=h((e.width-t.tiled.tiledWidth)/2)))}function f(t,i,s,o,a,l,c){let d,p=u(i,t.tiled.tileGidList)[1],g=(n.assert(p,"Bad GID, no tileset"),p.columns),m=i-p.firstgid,f=t.tiled.tileProps[i],x=t.tiled.scale||t.getScaleFactor();d=(c=n.nor(c,f&&f.Class))&&t.tiled.objFactory[c],n.assertNot(m<0,`Bad tile id: ${m}`),r.num(g)||(g=h(p.imagewidth/(p.tilewidth+p.spacing)));let y=m%g,w=h(m/g),v=y*p.tilewidth,b=w*p.tileheight;p.spacing>0&&(v+=p.spacing*y,b+=p.spacing*w);let T=d&&d.s(t)||e.Sprites.frame(p.image,a||p.tilewidth,l||p.tileheight,v,b);return T&&(T.tiled={id:m,gid:i},a==t.tiled.saved_tileW?T.width=t.tiled.new_tileW:(T.scale.x=x,T.width=n.evenN(T.width)),l==t.tiled.saved_tileH?T.height=t.tiled.new_tileH:(T.scale.y=x,T.height=n.evenN(T.height)),T.x=s*t.tiled.new_tileW,T.y=o*t.tiled.new_tileH),T}const x=e.Sprites.extend({width:0,height:0,parent:null,x:0,y:0,rotation:0,tiled:{},anchor:{x:0,y:0},getGlobalPosition(){return{x:this.x+this.parent.x,y:this.y+this.parent.y}}});class y extends e.Scenes.Scene{constructor(t,e,i){super(t,e,i),this.tiled={}}reloadMap(t){this.tiled={},this.m5.options.tiled=t,m(this,t.name,t.factory,t.scale)}runOnce(){const t=this.m5.options.tiled;m(this,t.name,t.factory,t.scale),super.runOnce()}removeTile(t,i){let{x:s,y:n}=i;i.anchor.x<.3&&(n=i.y+h(i.height/2),s=i.x+h(i.width/2));let r=h(s/this.tiled.tileW),o=h(n/this.tiled.tileH),a=this.getTileLayer(t),l=r+o*this.tiled.tilesInX;a.data[l]=0,a.collision&&(this.tiled.collision[l]=0),e.Sprites.remove(i)}getTileLayer(t,e){let i=n.some(this.tiled.tilelayer,(e=>{if(e.name==t)return e}));if(!i&&e)throw`There is no layer with name: ${t}`;return i}getObjectGroup(t,e){let i=n.some(this.tiled.objectgroup,(e=>{if(e.name==t)return e}));if(!i&&e)throw`There is no group with name: ${t}`;return i}setTile(t,e,i,s){let n=this.getTSInfo(s),r=(n.firstgid,this.getTileLayer(t)),o=i+this.tiled.tilesInX*e;r.collision&&(this.tiled.collision[o]=s);let a=f(this,s,i,e,n.tilewidth,n.tileheight);return a&&(a.tiled.index=o,a.tiled.layer=r),a}getTile(t){let{x:e,y:i}=t;return t.anchor.x<.3&&(i+=h(t.height/2),e+=h(t.width/2)),this.getTileXY(e,i)}getTileXY(t,e){let i=h(t/this.tiled.tileW),s=h(e/this.tiled.tileH);return n.assert(i>=0&&i<this.tiled.tilesInX,`bad tile col:${i}`),n.assert(s>=0&&s<this.tiled.tilesInY,`bad tile row:${s}`),[i,s]}getNamedItem(t){let e=[];return this.tiled.objectgroup.forEach((i=>{i.objects.forEach((i=>{t==n.get(i,"name")&&e.push(i)}))})),e}getScaleFactor(){let t,i,s=1;return"max"==e.u.scaleToWindow&&(e.width>e.height?(i=e.height/(this.tiled.saved_tileH*this.tiled.tilesInY),s=i):(t=e.width/(this.tiled.saved_tileW*this.tiled.tilesInX),s=t)),s}getTileIndex(t){let[i,s]=e.Sprites.centerXY(t);return l(i,s,this)}getTSInfo(t){return u(t,this.tiled.tileGidList)[1]}getTileProps(t){return this.tiled.tileProps[t]}_getContactObj(t,e,i){let s=x;return s.height=this.tiled.tileH,s.width=this.tiled.tileW,s.x=e*s.width,s.y=i*s.height,s.tiled.gid=t,s.tiled.row=i,s.tiled.col=e,s.m5.sensor=!1,s}collideXY(t){let i=e.Sprites,s=this.tiled.tileW,o=this.tiled.tileH,l=this.tiled.collision,c=n.feq0(t.angle)?i.getBBox(t):i.boundingBox(t),d=Math.max(0,h(c.x1/s)),u=Math.max(0,h(c.y1/o)),p=Math.min(this.tiled.tilesInX-1,a(c.x2/s)),g=Math.min(this.tiled.tilesInY-1,a(c.y2/o));for(let s,o,a,h,c=u;c<=g;++c)for(let u=d;u<=p;++u)a=c*this.tiled.tilesInX+u,o=l[a],r.num(o)||n.assert(r.num(o),"bad gid"),0!==o&&(h=this._getContactObj(o,u,c),s=this.getTileProps(o),s&&(h.m5.sensor=!!s.sensor),h.parent=this,i.hit(t,h)&&h.m5.sensor&&e.emit(["2d.sensor",t],h));return super.collideXY(t)}}class w{constructor(t,e){this.straightCost=t,this.diagonalCost=e}manhattan(t,e){return o(t.row-e.row)*this.straightCost+o(t.col-e.col)*this.straightCost}euclidean(t,e){let i=e.col-t.col,s=e.row-t.row;return h(n.sqrt(i*i+s*s)*this.straightCost)}diagonal(t,e){let i=o(e.col-t.col),s=o(e.row-t.row);return h(i>s?this.diagonalCost*s+this.straightCost*(i-s):this.diagonalCost*i+this.straightCost*(s-i))}}const v={TiledScene:y,neighborCells(t,e,i){let s=e.tiled.tilesInX,n=[t-s-1,t-s,t-s+1,t-1],r=[t+1,t+s-1,t+s,t+s+1];return i||n.push(t),n.concat(r)},updateMap(t,e,i){let s=n.fill(t.length,0),o=t=>{let e=this.getTileIndex(t,i);n.assert(e>=0&&e<s.length,"tiled index outofbound"),t.tiled.index=e,s[e]=t.tiled.gid};return r.vec(e)?e.forEach(o):o(e),s},shortestPath(t,e,i,s,n=[],r="manhattan",o=!0){let a=s.tiled.tilesInX,l=i.map(((t,e)=>({f:0,g:0,h:0,parent:null,index:e,col:e%a,row:h(e/a)}))),c=l[e],d=l[t],u=d,p=[u],g=[],m=[],f=t=>(o?this.neighborCells(t,s,!0):this.crossCells(t,s)).map((t=>l[t])).filter((e=>{if(e){let s=t%a==0,r=(t+1)%a==0,o=e.col%(a-1)==0&&0!==e.col,h=e.col%a==0,l=n.some((t=>i[e.index]===t));return s?!o:r?!h:!l}}));for(;u!==c;){let t=f(u.index);for(let e,i,s,n,o,a=0;a<t.length;++a){o=t[a],n=14,u.row!==o.row&&u.col!==o.col||(n=10),i=u.g+n,e=i+new w(10,14)[r](o,c);let h=p.some((t=>o===t)),l=g.some((t=>o===t));h||l?o.f>e&&(o.f=e,o.g=i,o.h=s,o.parent=u):(o.f=e,o.g=i,o.h=s,o.parent=u,p.push(o))}if(g.push(u),0===p.length)return m;p=p.sort(((t,e)=>t.f-e.f)),u=p.shift()}if(0!==p.length){let t=c;for(m.push(t);t!==d;)t=t.parent,m.unshift(t)}return m},lineOfSight(t,i,n,r,o=0,a=32,d=[]){let u,p,g,m,f,x=c(t,i),y=s.len(x),w=h(y/a),v=[];for(let i,s=1;s<=w;++s)i=e.Sprites.centerXY(t),u=a*s,m=x[0]/y,f=x[1]/y,p=h(i[0]+m*u),g=h(i[1]+f*u),v.push({x:p,y:g,index:l(p,g,r)});let b=180*Math.atan2(x[1],x[0])/Math.PI;return v.every((t=>n[t.index]===o))&&(0===d.length||d.some((t=>t===b)))},crossCells(t,e){const i=e.tiled.tilesInX;return[t-i,t-1,t+1,t+i]},getCrossTiles(t,e,i){return this.crossCells(t,i).map((t=>e[t]))},getDiagonalCells(t,e){const i=r.num(e)?e:e.tiled.tilesInX;return[t-i-1,t-i+1,t+i-1,t+i+1]},getDiagonalTiles(t,e,i){return this.getDiagonalCells(t,i).map((t=>e[t]))},validDirections(t,s,n,r){const o=this.getTileIndex(t,r);return this.getCrossTiles(o,s,r).map(((t,s)=>t===n?i[s]:e.NONE)).filter((t=>t!==e.NONE))},canChangeDirection(t=[]){let i=t.find((t=>t===e.UP)),s=t.find((t=>t===e.DOWN)),n=t.find((t=>t===e.LEFT)),r=t.find((t=>t===e.RIGHT));return 0===t.length||1===t.length||(i||s)&&(n||r)},randomDirection:(t=[])=>0===t.length?e.NONE:1===t.length?t[0]:t[n.randInt2(0,t.length-1)],closestDirection(t,i){const s=c(t,i);return o(s[0])<o(s[1])?s[1]<=0?e.UP:e.DOWN:s[0]<=0?e.LEFT:e.RIGHT}};return e.Tiles=v}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Tiles"]=function(t){return t.Tiles?t.Tiles:e(t)}}(this);