!function(t,e){"use strict";const i=["jpg","png","jpeg","gif"],s=["ttf","otf","ttc","woff"],n=["mp3","wav","ogg"],r=1/15;function o(o,a,l,h){const{EventBus:d,dom:c,is:u,u:p}=t["io/czlab/mcfud/core"](),m=t["io/czlab/mcfud/vec2"](),g=t["io/czlab/mcfud/math"](),f=d(),y=Math.floor,x=console;let v=!1;class w extends PIXI.Container{constructor(){super(),this.m5={stage:!0}}onResize(t,e){this.children.forEach((i=>{i instanceof t.Scenes.SceneWrapper&&(i=i.children[0]),i.onCanvasResize(e)})),t.Input.resize()}}p.patch(o,{assetFiles:[],logos:[],aniFps:12,fps:60});const b=()=>t.innerHeight,I=()=>t.innerWidth;function T(t){const e=new F.Scenes.Scene("loader",{setup(){t.init.call(this)}},{});return F.stage.addChild(e),e.runOnce(),e}function S(t,e,i,s){const{Sound:r}=t;let o,a=0;function h(){l.forEach((t=>c.css(t,"display","none"))),e&&t.delBgTask(e),p.delay(0,(()=>{t.Scenes.remove(i),s?p.error("Cannot load game!"):t.u.start(t)}))}function d(t){0==--a&&h()}s||p.doseq(t.assets,((t,e)=>{o=p.fileExt(e),p.has(n,o)&&(a+=1,r.decodeData(t.name,t.url,t.xhr.response,d))})),0==a&&h()}function P(t){let e=p.map(t.u.assetFiles,(e=>t.assetPath(e))),i=p.findFiles(e,s);const{PXLR:r,PXLoader:o}=t;let h,d,m,g;if(i.forEach((t=>{g=c.newElm("style"),m=c.newElm("span"),h=t.split("/").pop().split(".")[0],d=`@font-face {font-family: '${h}'; src: url('${t}');}`,a.push(h),c.conj(g,c.newTxt(d)),c.conj(document.head,g),m.innerHTML="?",c.css(m,"fontFamily",h),c.conj(document.body,m),c.css(m,{display:"block",opacity:"0"}),l.push(m)})),n.forEach((t=>{r.setExtensionLoadType(t,r.LOAD_TYPE.XHR),r.setExtensionXhrType(t,r.XHR_RESPONSE_TYPE.BUFFER)})),o.reset(),e.length>0){let i=t.u.load;i||(i=function(t){const{Sprites:e}=t;return{init(){let i=e.sprite("boot/ZotohLab_x1240.png"),s=e.sprite("boot/preloader_bar.png"),[n,r]=t.scaleXY([i.width,i.height],[t.width,t.height]),o=t.getScaleFactor(),a=n>r?r:n;a*=.2,e.scaleXY(s,a,a),e.scaleXY(i,a,a),e.pinCenter(this,i),e.pinBelow(i,s,4*o),e.hide(s),this.g.pbar=s,this.g.pbar_width=s.width,this.insert(i),this.insert(s)},update(t,i){!this.g.pbar.visible&&e.show(this.g.pbar),this.g.pbar.width=this.g.pbar_width*(i/100)}}}(t));let s=0,n=[],r=[],a=T(i);o.add(e),o.onError.add(((t,e,i)=>{++s,x.log(`${t}`)})),o.onProgress.add(((t,e)=>{x.log(`loading ${e.url}`),n.unshift(e.url),r.unshift(t.progress)})),o.load((()=>{0==s&&x.log("asset loaded!"),n.unshift("$")})),t.addBgTask({update(){let e=n.pop(),o=r.pop();u.num(o)&&e&&"$"!=e&&i.update.call(a,e,o),"$"==e&&S(t,this,a,s>0)}})}else S(t);return t.start()}const E={width:0,height:0},_={width:1,height:1};function X(t){const e=c.newElm("style");c.conj(document.body,F.canvas),c.conj(e,c.newTxt("body, * {padding: 0; margin: 0; height:100%; overflow:hidden}")),c.conj(document.head,e);c.css(F.canvas,{outline:"none"}),c.attrs(F.canvas,"tabindex","0"),c.css(document.body,{background:"black"})}const C=p.jsMap();function D(t){F._curFPS=F.calcFPS(t),h.forEach((e=>e.update&&e.update(t))),v||F.stageCS((e=>e.update&&e.update(t)))}const M=e=>t.requestAnimationFrame(e);class O{constructor(t){this.uid=t}playSound(){}uuid(){return this.uid}pokeMove(){this.onPoke()}pokeWait(){this.onWait()}stateValue(){p.assert(!1,"implement stateValue!")}}const F={_offsetX:0,_offsetY:0,_scaleX:1,_scaleY:1,_selectedCellX:0,_selectedCellY:0,_startPanX:0,_startPanY:0,_curFPS:60,Bot:class extends O{constructor(t="p2"){super(t)}onPoke(){}onWait(){}},Local:class extends O{constructor(t="p1"){super(t)}onPoke(){F.Input.resume()}onWait(){F.Input.pause()}},Mediator:class{constructor(){this.players=[],this.state,this.pcur,this.end,this.pwin,this._pcnt=0}cur(){return this.pcur}add(t){return t.pnum=++this._pcnt,t.owner=this,this.players.push(t),this}winner(){return this.pwin}isGameOver(){return this.end}gameState(t){return t&&(this.state=t),this.state}gameOver(t){return F.Input.resume(),this.pwin=t,this.end=!0}start(t){p.assert(t,"bad player to start with"),this.end=!1,this.pcur=t,this._turn()}other(){return this.pcur===this.players[0]?this.players[1]:this.pcur===this.players[1]?this.players[0]:void 0}_turn(){this.players.forEach((t=>{t!==this.pcur&&t.pokeWait()})),this.pcur.pokeMove()}redoTurn(){this.pcur.pokeMove()}postMove(t,e){p.assert(!1,"implement postMove!")}updateState(t,e){p.assert(!1,"implement updateState!")}updateSound(t){}updateMove(t,e){this.end||(this.updateState(t,e),this.updateSound(t),p.delay(0,(()=>this.postMove(t,e))))}takeTurn(){this.end||(this.pcur===this.players[0]?this.pcur=this.players[1]:this.pcur===this.players[1]&&(this.pcur=this.players[0]),this._turn())}},frame:1/o.fps,EVERY:1,SOME:2,CENTER:3,TOP:4,LEFT:5,RIGHT:6,BOTTOM:7,UP:8,DOWN:9,NW:10,NE:11,SW:12,SE:13,NONE:100,PI_45:Math.PI/4,PI_90:Math.PI/2,PI_180:Math.PI,PI_270:1.5*Math.PI,PI_360:2*Math.PI,v2:m,math:g,ute:p,is:u,dom:c,u:o,Game:{mode:1},MODE_ONE:1,MODE_TWO:2,MODE_NET:3,CON:console,noop:()=>{},PXContainer:PIXI.Container,PXGraphics:PIXI.Graphics,PXTexture:PIXI.Texture,PXFilters:PIXI.filters,PXLR:PIXI.LoaderResource,PXLoader:PIXI.Loader.shared,PXObservablePoint:PIXI.ObservablePoint,get mouse(){return F.Input.pointer()},playSfx(t){return this.sound(t).play()},accel:(t,e,i)=>t+e*i,on:(...t)=>f.sub(...t),emit:(...t)=>f.pub(...t),off:(...t)=>f.unsub(...t),frameRate(){return this.frame},sideRight:t=>t===F.RIGHT||t===F.NE||t===F.SE,sideLeft:t=>t===F.LEFT||t===F.NW||t===F.SW,sideTop:t=>t===F.UP||t===F.TOP||t===F.NW||t===F.NE,sideBottom:t=>t===F.DOWN||t===F.BOTTOM||t===F.SW||t===F.SE,overlap:(t,e)=>!(t.x2<e.x1||e.x2<t.x1||t.y2<e.y1||e.y2<t.y1),overlapX:(t,e)=>t.x2>e.x1&&e.x2>t.x1,overlapY:(t,e)=>t.y2>e.y1&&e.y2>t.y1,hasClass(t,e){if(e)return t.classList.contains(e)},toggleClass:(t,e)=>(e&&t.classList.toggle(e),t),addClass:(t,e)=>(p.hasClass(t,e)||t.classList.add(e),t),removeClass:(t,e)=>(p.hasClass(t,e)&&t.classList.remove(e),t),wrapv:(t,e,i)=>t<e?i:t>i?e:t,mixin(t,e){if(p.has(C,t))throw`MixinError: "${t}" already defined.`;p.assert(u.fun(e),"mixin must be a function"),p.assoc(C,t,e)},addMixin:(t,e,...i)=>function(t,e,i,...s){return p.assert(!p.has(t,e),`Fatal: mixin ${e} unavailable.`),t[e]=i(t,...s),t}(t,e,C.get(e),...i),get assets(){return PIXI.Loader.shared.resources},get designSize(){return this.u.arena},get width(){return this.canvas.width},get height(){return this.canvas.height},stageCS(t){this.inModal?t(p.last(this.stage.children)):this.stage.children.forEach((e=>{e instanceof F.Scenes.SceneWrapper&&(e=e.children[0]),e instanceof PIXI.SimpleRope||t(e)}))},scroll(e,i){t.scrollTo(e||0,i||1)},portrait:()=>F.height>F.width,screenCenter:()=>p.v2(g.ndiv(F.width,2),g.ndiv(F.height,2)),scaleXY:(t,e)=>[e[0]/t[0],e[1]/t[1]],makeAnchor(t,e){return new F.PXObservablePoint(F.noop,this,t,e)},mockStage(t=0,e=0,i,s){let n=u.obj(t)?t:{x:t,y:e,width:p.nor(i,F.width),height:p.nor(s,F.height)};return n.getGlobalPosition=()=>({x:this.x,y:this.y}),n.anchor=F.makeAnchor(0,0),n.m5={stage:!0},n},getIndex(t,e,i,s,n){if(t<0||e<0)throw`IndexError: ${t},${e}, wanted +ve values`;return g.ndiv(t,i)+g.ndiv(e,s)*n},tcached(t){return p.inst(this.PXTexture,t)?t:u.str(t)?PIXI.utils.TextureCache[t]||PIXI.utils.TextureCache[this.assetPath(t)]:e},clickPlayMsg(){return(this.touchDevice?"Tap":"Click")+" to Play!"},splitXY:(t,e)=>[t%e,g.ndiv(t,e)],rect:(t,e,i,s)=>new F.PXRectangle(t,e,i,s),scaleSZ:(t,e)=>({width:e.width/t.width,height:e.height/t.height}),id(t){return this.image(t)},image(t){return this.tcached(t)||p.assert(!1,`${t} not loaded.`)},xml(t){return(this.assets[t]||p.assert(!1,`${t} not loaded.`)).data},json(t){return(this.assets[t]||p.assert(!1,`${t} not loaded.`)).data},assetPath(t){if(t.includes("/"))return t;let e="data",r=p.fileExt(t);return p.has(i,r)?e="images":"fnt"==r||p.has(s,r)?e="fonts":p.has(n,r)&&(e="audio"),`${e}/${t}`},contentScaleFactor(){return E.height=F.height,E.width=F.width,"max"!==o.scaleToWindow?_:this.scaleSZ(this.designSize,E)},getScaleFactor(t){if(t||"max"==o.scaleToWindow){E.height=F.height,E.width=F.width;let t=this.scaleSZ(this.designSize,E);return"x"==o.scaleFit?t.width:"y"==o.scaleFit?t.height:Math.min(t.width,t.height)}return 1},resource(t,i){return(t?this.assets[t]||this.assets[this.assetPath(t)]:null)||(i?p.assert(!1,`no such resource ${t}.`):e)},fpsList:e,fpsSum:0,calcFPS(t){let e,i=0;return t>0&&(e=g.ndiv(1,t),this.fpsList||(this.fpsList=p.fill(60,e),this.fpsSum=60*e),this.fpsSum-=this.fpsList.pop(),this.fpsList.unshift(e),this.fpsSum+=e,i=g.ndiv(this.fpsSum,60)),i},degToRad:t=>t*(Math.PI/180),radToDeg:t=>t*(180/Math.PI),addBgTask(t){h.push(t)},delBgTask(t){t&&(t.dispose&&t.dispose(),p.disj(h,t))},resume(){v=!1},pause(){v=!0},start(){let t=0,e=p.now(),i=function(){let s=p.now(),n=(s-e)/1e3,o=F.frameRate();for(n>r&&(n=r),t+=n;t>=o;t-=o)D(n);F.ctx.render(F.stage),e=s,M(i)};return M(i)},takeScreenshot(){F.ctx.extract.canvas(F.stage).toBlob((t=>{const e=document.createElement("a");document.body.append(e),e.download="screenshot",e.href=URL.createObjectURL(t),e.click(),e.remove()}),"image/png")},worldToScreen(t,e){return[y((t-this._offsetX)*this._scaleX),y((e-this._offsetY)*this._scaleY)]},screenToWorld(t,e){return[t/this._scaleX+this._offsetX,e/this._scaleY+this._offsetY]}};return function(e){let i=e.stage=new w,s=o.arena,n=!1;return p.assert(s,"design resolution req'd."),"max"!=o.scaleToWindow&&!0!==o.scaleToWindow||(n=!0,s={width:I(),height:b()},1==o.arena.scale&&(n=!1,o.arena=s,o.scaleToWindow="win")),o.logos||(o.logos=new Array),e.touchDevice=!!("ontouchstart"in document),e.ctx=PIXI.autoDetectRenderer(p.inject(s,{antialias:!0})),e.canvas=e.ctx.view,e.canvas.id="mojo",e.maxed=n,e.scale=1,e.scaledBgColor="#5A0101",["Sprites","Input","Scenes","Sound","FX","Ute2D","Tiles","Touch"].forEach((i=>{x.log(`installing module ${i}...`);let s=t[`io/czlab/mojoh5/${i}`](e);s.assets&&s.assets.forEach((t=>e.u.assetFiles.unshift(t)))})),h.push(e.FX,e.Input),X(),p.has(o,"border")&&c.css(e.canvas,"border",o.border),p.has(o,"bgColor")&&(e.ctx.backgroundColor=e.Sprites.color(o.bgColor)),!0===o.resize&&(p.addEvent("resize",t,p.debounce((()=>{const[t,i]=[e.width,e.height];e.ctx.resize(I(),b()),e.emit(["canvas.resize"],[t,i])}),o.debounceRate||150)),e.on(["canvas.resize"],(t=>i.onResize(e,t)))),e.touchDevice&&e.scroll(),e.canvas.focus(),function(t){const{PXLoader:e}=t;t.u.load||(t.u.logos=["boot/preloader_bar.png","boot/ZotohLab_x1240.png"]);let i=0,s=t.u.logos.map((e=>t.assetPath(e)));return 0==s.length?P(t):(e.reset(),e.add(s),e.onError.add(((t,e,s)=>{++i,x.log(`${t}`)})),e.load((()=>{0==i?(p.delay(0,(()=>P(t))),x.log("logo files loaded.")):x.log("logo files not loaded!")}))),t}(e)}(F)}if("object"==typeof module&&module.exports)throw"Panic: browser only!";t.MojoH5=function(t){return o(t,[],[],[])}}(this),function(t,e){"use strict";const i={blue:"#319bd5",green:"#78c03f",yellow:"#f9ef50",red:"#eb2224",orange:"#f48917",grey:"#848685",cyan:"#1ee5e6",lime:"#e5e61e",magenta:"#e61ee5",purple:"#a6499a"},s={aqua:"#00FFFF",black:"#000000",blue:"#0000FF",brown:"#A52A2A",crimson:"#DC143C",cyan:"#00FFFF",fuchsia:"#FF00FF",gray:"#808080",green:"#008000",grey:"#808080",lavender:"#E6E6FA",lime:"#00FF00",magenta:"#FF00FF",maroon:"#800000",navy:"#000080",olive:"#808000",orange:"#FFA500",purple:"#800080",red:"#FF0000",silver:"#C0C0C0",teal:"#008080",turquoise:"#40E0D0",wheat:"#F5DEB3",white:"#FFFFFF",yellow:"#FFFF00"};function n(n){const r=t["io/czlab/mcfud/geo2d"](),o=t["io/czlab/mcfud/vec2"](),a=t["io/czlab/mcfud/math"](),{ute:l,is:h,dom:d}=n,c=2*Math.PI,u=Math.floor;function p(t,e,i,s){0==(s=s||t.getLocalBounds(null,!0)).width&&(s.width=1),0==s.height&&(s.height=1);let r=PIXI.Matrix.TEMP_MATRIX,o=PIXI.RenderTexture.create({width:0|s.width,height:0|s.height,scaleMode:e,resolution:i});return r.tx=-s.x,r.ty=-s.y,n.ctx.render(t,o,!1,r,!!t.parent),o}var m,g,f;function y(t,e){let i,s;var r;return l.inst(n.PXGraphics,t)&&(t=p(t)),l.inst(n.PXTexture,t)?s=t:h.vec(t)?(r=t,l.assert(h.vec(r),"bad arg to animFromVec"),h.str(r[0])&&(r=n.tcached(r[0])?r.map((t=>n.tcached(t))):r.map((t=>n.assetPath(t)))),i=l.inst(n.PXTexture,r[0])?new n.PXASprite(r):n.PXASprite.fromImages(r)):h.str(t)&&(s=n.tcached(t)||n.PXTexture.from(n.assetPath(t))),s&&(i=e(s)),l.assert(i,`SpriteError: ${t} not found`)&&i}function x(t,e,i,s,n,r){let o=e,a=t,l=[];for(let e,h,d,c=0;c<i;++c){d=[];for(let t=0;t<s;++t)h=o+r,e=a+n,d.push({x1:a,x2:e,y1:o,y2:h}),a=e;o=h,a=t,l.push(d)}return l}function v(t,e,i=null){let s,r;return e&&e.m5&&e.m5.stage?r={x1:0,y1:0,x2:n.width,y2:n.height}:(s=e.parent,r=t.getAABB(e)),i&&s===i&&(r.x1+=i.x,r.x2+=i.x,r.y1+=i.y,r.y2+=i.y),[r,a.ndiv(r.x2-r.x1,2),a.ndiv(r.y2-r.y1,2),a.ndiv(r.x1+r.x2,2),a.ndiv(r.y1+r.y2,2)]}function w(t,e,i){if(e.m5.static)o.sub$(t.m5.vel,o.mul(i.overlapN,2*o.dot(t.m5.vel,i.overlapN)));else{let s=o.mul$(o.sub(e.m5.vel,t.m5.vel),i.overlapN),n=-2*(s[0]+s[1])/(t.m5.invMass+e.m5.invMass);o.sub$(t.m5.vel,o.mul$(o.div(i.overlapN,t.m5.mass),n)),o.add$(e.m5.vel,o.mul$(o.div(i.overlapN,e.m5.mass),n))}}function b(t,e,i){let s,n=t.toBody(e),o=t.toBody(i);return s=e.m5.circle?i.m5.circle?r.hitCircleCircle(n,o):r.hitCirclePolygon(n,o):i.m5.circle?r.hitPolygonCircle(n,o):r.hitPolygonPolygon(n,o),s&&(s.A=e,s.B=i),s}m=new PIXI.Container,(g=new PIXI.Graphics).clear(),g.beginFill(0),g.drawCircle(0,0,4),g.endFill(),f=new PIXI.Sprite(p(g)),["m5","tiled","collideXY","getGuid","getBBox","getSpatial"].forEach((t=>{[[m,"Container"],[g,"Graphics"],[f,"Sprite"]].forEach((e=>{l.assertNot(l.has(e[0],t),`PIXI ${e[1]} has ${t} property!`)}))})),l.inject(n,{PXMatrix:PIXI.Matrix.TEMP_MATRIX,PXRTexture:PIXI.RenderTexture,PXRect:PIXI.Rectangle,PXBText:PIXI.BitmapText,PXSprite:PIXI.Sprite,PXGraphics:PIXI.Graphics,PXText:PIXI.Text,PXTSprite:PIXI.TilingSprite,PXASprite:PIXI.AnimatedSprite,PXPContainer:PIXI.ParticleContainer});o.vec();const I={SomeColors:{},BtnColors:{},assets:["boot/tap-touch.png","boot/unscii.fnt","boot/splash.jpg","boot/trail.png","boot/star.png","boot/doki.fnt","boot/BIG_SHOUT_BOB.fnt"],assertCenter:t=>l.assert(t.anchor&&l.feq(t.anchor.x,.5)&&l.feq(t.anchor.y,.5),"not center'ed"),empty:t=>0==t.children.length,btnPress(t,e,i,s,r){let o=this;return function(t){t.tint=o.color(e),s&&n.sound(s).play(),l.delay(343,(()=>{t.tint=o.color(i),r(t)}))}},oneOffClick(t,e){let i=function(){n.Input.off(["single.tap"],i),t&&n.sound(t).play(),e()};return n.Input.on(["single.tap"],i),i},sizeXY:(t,e,i)=>(h.num(i)&&(t.height=i),h.num(e)&&(t.width=e),t),asCircle:t=>(t.m5.circle=!0,t),scaleXY:(t,e,i)=>(h.num(e)&&(t.scale.x=e),h.num(i)&&(t.scale.y=i),t),scaleBy:(t,e,i)=>(h.num(e)&&(t.scale.x*=e),h.num(i)&&(t.scale.y*=i),t),isVX:t=>!l.feq0(t.m5.vel[0]),isVY:t=>!l.feq0(t.m5.vel[1]),halfSize:t=>({width:a.ndiv(t.width,2),height:a.ndiv(t.height,2)}),anchorXY:(t,e,i)=>(l.assert(t.anchor,"sprite has no anchor object"),t.anchor.x=e,t.anchor.y=l.nor(i,e),t),centerAnchor:t=>(t.anchor&&t.anchor.set(.5,.5),t),topLeftAnchor:t=>(t.anchor&&t.anchor.set(0,0),t),topLeftOffsetXY(t){return this.isTopLeft(t)?o.vec():o.vec(-u(t.width*(t.anchor?t.anchor.x:0)),-u(t.height*(t.anchor?t.anchor.y:0)))},centerOffsetXY(t){return this.isCenter(t)?o.vec():o.vec(a.ndiv(t.width,2)-u((t.anchor?t.anchor.x:0)*t.width),a.ndiv(t.height,2)-u((t.anchor?t.anchor.y:0)*t.height))},makeSteerable(t){let e=a.ndiv(t.width,2),i=a.ndiv(t.height,2);return t.m5.steer=[0,0],t.m5.steerInfo={wanderAngle:l.rand()*Math.PI*2,arrivalThreshold:400,wanderDistance:10,wanderRadius:5,wanderRange:1,avoidDistance:400,inSightDistance:200,tooCloseDistance:60,maxForce:5,pathIndex:0},t.m5.radius=Math.sqrt(e*e+i+i),t},updateSteer:(t,e=!0)=>(t.m5.steer&&(o.clamp$(t.m5.steer,0,t.m5.steerInfo.maxForce),o.div$(t.m5.steer,t.m5.mass),o.add$(t.m5.vel,t.m5.steer),e&&o.mul$(t.m5.steer,0)),t),clrSpatial:t=>(t&&t.m5&&t.m5.sgrid&&(t.m5.sgrid.x1=e,t.m5.sgrid.x2=e,t.m5.sgrid.y1=e,t.m5.sgrid.y2=e),t),lift(t){if(!t.m5){let e=this;t.g={},t.m5={uuid:l.nextId(),circle:!1,stage:!1,drag:!1,dead:!1,angVel:0,friction:o.vec(1,1),gravity:o.vec(),vel:o.vec(),acc:o.vec(),static:!1,sensor:!1,sgrid:{},mass:1,type:0,cmask:0,speed:0,heading:n.RIGHT,get invMass(){return l.feq0(t.m5.mass)?0:1/t.m5.mass}},t.m5.resize=function(i,s,n,r){e.resize(t,i,s,n,r)},t.m5.getImageOffsets=function(){return{x1:0,x2:0,y1:0,y2:0}},t.m5.getContactPoints=function(){return function(t,e,i){let s=[o.vec(e,i),o.vec(e,0),o.vec(0,0),o.vec(0,i)];return t||(t={x:0,y:0}),s.forEach((s=>{s[0]-=u(e*t.x),s[1]-=u(i*t.y)})),s}(t.anchor,t.width,t.height)},t.getGuid=function(){return t.m5.uuid},t.getSpatial=function(){return t.m5.sgrid},t.getBBox=function(){return l.feq0(t.angle)?e.getAABB(t):e.boundingBox(t)}}return t},clamp2Pi:t=>(t.rotation>c&&(t.rotation-=c),t.rotation<0&&(t.rotation+=c),t),getHeading:t=>[Math.cos(t.rotation),Math.sin(t.rotation)],setOrient:(t,e,i=!1)=>(i?t.angle=e:t.rotation=e,t),toPolygon:t=>new r.Polygon(t.m5.getContactPoints()).setOrient(t.rotation),toCircle(t){return this.assertCenter(t)&&new r.Circle(a.ndiv(t.width,2)).setOrient(t.rotation)},toBody(t){let e=t.x,i=t.y,s=t.m5.circle?this.toCircle(t):this.toPolygon(t);return r.bodyWrap(s,e,i)},gposXY(t){const{x:e,y:i}=t.getGlobalPosition();return o.vec(e,i)},isTopLeft:t=>!t.anchor||l.feq0(t.anchor.x)&&l.feq0(t.anchor.y),isCenter:t=>!!t.anchor&&(l.feq(t.anchor.x,.5)&&l.feq(t.anchor.y,.5)),centerXY(t){let e;if(this.isCenter(t))e=o.vec(t.x,t.y);else{let[i,s]=this.centerOffsetXY(t);e=o.vec(t.x+i,t.y+s)}return e},setScaleModeNearest:(t,e)=>(t.texture.baseTexture.scaleMode=e?PIXI.SCALE_MODES.NEAREST:PIXI.SCALE_MODES.LINEAR,t),angle(t,e){return o.angle(this.centerXY(t),this.centerXY(e))},die:t=>(t&&(t.m5.dead=!0),t),undie:t=>(t&&(t.m5.dead=!1),t),move:(t,e)=>(e?(o.add$(t.m5.vel,o.mul(t.m5.gravity,e)),o.add$(t.m5.vel,o.mul(t.m5.acc,e)),o.mul$(t.m5.vel,t.m5.friction)):e=1,void 0!==t.m5.maxSpeed&&o.clamp$(t.m5.vel,0,t.m5.maxSpeed),o.add$(t,o.mul(t.m5.vel,e))),leftSide(t){let e=t.x,i=t.width,s=t.anchor?t.anchor.x:0;return s>.7?e-=i:s>0&&(e-=a.ndiv(i,2)),e},rightSide(t){return this.leftSide(t)+t.width},topSide(t){let e=t.y,i=t.height,s=t.anchor?t.anchor.y:0;return s>.7?e-=i:s>0&&(e-=a.ndiv(i,2)),e},bottomSide(t){return this.topSide(t)+t.height},getAABB(t){if(void 0!==t.x1&&void 0!==t.y2)return t;l.assert(t.m5,"bad sprite for getAABB");let{x1:e,y1:i,x2:s,y2:n}=t.m5.getImageOffsets(),r=this.leftSide(t),o=this.topSide(t),a=r+t.width,h=o+t.height;return r+=e,o+=i,a-=s,h-=n,{x1:r,y1:o,x2:a,y2:h}},bbox4:(t,e,i,s)=>l.assert(i<=s,"bad bbox")&&{x1:t,x2:e,y1:i,y2:s},bboxCenter(t){if(h.num(t.x1))return o.vec(a.ndiv(t.x1+t.x2,2),a.ndiv(t.y1+t.y2,2))},bboxFrame(t,e=16,i="#dedede"){let s,{x1:n,x2:r,y1:o,y2:l}=t,h=r-n,d=l-o,c=this.graphics();return c.lineStyle(e,this.color(i)),c.drawRoundedRect(0,0,h+e,d+e,a.ndiv(e,4)),s=this.sprite(c),s.x=n-e,s.y=o-e,s},bboxSize:t=>o.vec(t.x2-t.x1,t.y2-t.y1),pointInBBox:(t,e,i)=>t>i.x1&&t<i.x2&&e>i.y1&&e<i.y2,boundingBox(t){let e,i,s=[],n=[],r=a.ndiv(t.width,2),o=a.ndiv(t.height,2),h=Math.tanh(o/r),d=Math.sqrt(r*r+o*o);return l.feq0(t.rotation)||l.assert(this.isCenter(t),"wanted center anchor"),i=c-h+t.rotation,n.push(d*Math.sin(i)),s.push(d*Math.cos(i)),i=h+t.rotation,n.push(d*Math.sin(i)),s.push(d*Math.cos(i)),i=Math.PI-h+t.rotation,n.push(d*Math.sin(i)),s.push(d*Math.cos(i)),i=Math.PI+h+t.rotation,n.push(d*Math.sin(i)),s.push(d*Math.cos(i)),e=this.centerXY(t),n.sort(((t,e)=>t-e)),s.sort(((t,e)=>t-e)),{x1:u(s[0]+e[0]),x2:u(s[3]+e[0]),y1:u(n[0]+e[1]),y2:u(n[3]+e[1])}},hitTestPoint(t,e,i){let s=this.toBody(i);return i.m5.circle?r.hitTestPointCircle(t,e,s):r.hitTestPointPolygon(t,e,s)},distance(t,e){return o.dist(this.centerXY(t),this.centerXY(e))},scaleContent(...t){1==t.length&&h.vec(t[0])&&(t=t[0]);let e=n.getScaleFactor();t.forEach((t=>{t.scale.x=e,t.scale.y=e}))},scaleToCanvas:t=>(t.height=n.height,t.width=n.width,t),uuid:(t,e)=>(t.m5.uuid=e,t),opacity:(t,e)=>(t.alpha=e,t),tint:(t,e)=>(t.tint=e,t),hide:t=>(t.visible=!1,t),show:t=>(t.visible=!0,t),pset:(t,e,i)=>(t.g[e]=i,t),pget:(t,e)=>t.g[e],container(t){let e=new n.PXContainer;return e=this.lift(e),t&&t(e),e},group(...t){let e=this.container();return t.forEach((t=>e.addChild(t))),e},sprite(t,e=!1,i=0,s=0){let r=y(t,(t=>new n.PXSprite(t)));return r=this.lift(r),o.set(r,i,s),e&&this.centerAnchor(r),l.inst(n.PXASprite,r)?function(t){let e=0,i={};function s(){e&&(e=clearInterval(e))}function r(){i.cnt<i.total?(t.gotoAndStop(t.currentFrame+1),i.cnt+=1):t.loop?(t.gotoAndStop(i.start),i.cnt=1):(s(),t.onComplete&&t.onComplete())}return l.inject(t.m5,{stopFrames(){s(),t.gotoAndStop(t.currentFrame)},showFrame(e){s(),t.gotoAndStop(e)},playFrames(o){s(),i.start=0,i.end=t.totalFrames-1,h.vec(o)&&o.length>1&&(i.start=o[0],i.end=o[1]),i.total=i.end-i.start+1,t.gotoAndStop(i.start),i.cnt=1,e=setInterval(r,1e3/n.aniFps)}}),t}(r):r},tilingSprite(t,e,i){let s=y(t,(t=>new n.PXTSprite(t,e||t.width,i||t.height)));return this.lift(s)},repeatSprite(t,e=!0,i=!0,s,r){let a,l=()=>{let e=this.lift(y(t,(t=>new n.PXSprite(t)))),i=n.getScaleFactor();return i=1,e.width*=1,e.height*=1,e},h=[],d=0,c=0,u=0,p=0;if(e){for(;u<s;)h.push(a=l()),o.set(a,d,c),u+=a.width,d+=a.width,u>=s&&p<r&&i&&(p+=a.height,c+=a.height,d=0,u=0);i=!1}if(i){for(;p<r;)h.push(a=l()),o.set(a,d,c),p+=a.height,c+=a.height,p>=r&&u<s&&e&&(u+=a.width,d+=a.width,d=c,u=p);e=!1}return h},animation(t,e,i,s=0){let r=n.tcached(t);if(!r)throw`SpriteError: ${t} not loaded.`;let l=a.ndiv(r.width,e),h=[],d=l*a.ndiv(r.height,i);for(let t,n,r=0;r<d;++r)t=r%l*e,n=a.ndiv(r,l)*i,s>0&&(t+=s+s*r%l,n+=s+s*a.ndiv(r,l)),h.push(o.vec(t,n));return this.sprite(((t,e,i,s)=>s.map((s=>new n.PXTexture(t.baseTexture,new n.PXRect(s[0],s[1],e,i)))))(r,e,i,h))},frame(t,e,i,s,r){const o=n.tcached(t);return this.sprite(new n.PXTexture(o.baseTexture,new n.PXRect(s,r,e,i)))},frameSelect(t,e,i,s){const r=n.tcached(t);return s.map((t=>new n.PXTexture(r.baseTexture,new n.PXRect(t[0],t[1],e,i))))},frames(t,e,i,s=0,r=0,o=0,l=0){let h=n.tcached(t),d=e+s,c=i+r,u=[],p=a.ndiv(h.height,c),m=a.ndiv(h.width+s,d);for(let t,s=0;s<p;++s){t=l+i*s;for(let s,r=0;r<m;++r)s=o+e*r,u.push(new n.PXTexture(h.baseTexture,new n.PXRect(s,t,e,i)))}return u},frameImages:(...t)=>(1==t.length&&h.vec(t[0])&&(t=t[0]),t.map((t=>n.tcached(t)))),spriteFrom(...t){return this.sprite(this.frameImages(...t))},text(t,e,i=0,s=0){return o.set(this.lift(new n.PXText(t,e)),i,s)},bitmapText(t,e,i){let s;return h.str(e)?(s={fontName:e},h.num(i)&&(s.fontSize=i)):s=e,s.fill&&(s.tint=this.color(s.fill)),s.fontName||(s.fontName="unscii"),s.align||(s.align="center"),this.lift(new n.PXBText(t,s))},triangle(t,e,i,s=16777215,r=16777215,l=0,d=0,c=0){let u=this.graphics(),p=1,m=a.ndiv(t,2),g=this.color(r),f=i<.5?0:i>.5?t:m,y=[{x:0,y:0},{x:f,y:-e},{x:t,y:0},{x:0,y:0}];!1!==s&&(h.vec(s)&&(p=s[1],s=s[0]),u.beginFill(this.color(s),p)),l>0&&u.lineStyle(l,g,1),u.drawPolygon(...y),!1!==s&&u.endFill();let x=new n.PXSprite(this.genTexture(u));return x=this.lift(x),x.m5.getContactPoints=e<0?()=>[[f,-e],[t,0],[0,0]]:()=>[[t,e],[f,0],[0,e]],o.set(x,d,c)},rect(t,e,i=16777215,s=16777215,n=0){return this.rectEx(this.rectTexture(t,e,i,s,n))},rectTexture(t,e,i=16777215,s=16777215,n=0){let r,o=this.graphics();return!1!==i&&(h.vec(i)?(r=i[1],i=i[0]):r=1,o.beginFill(this.color(i),r)),n>0&&o.lineStyle(n,this.color(s)),o.drawRect(0,0,t,e),!1!==i&&o.endFill(),this.genTexture(o)},rectEx(t){return this.lift(new n.PXSprite(t))},drawBody(t,...e){let i=this.graphics();return t.apply(this,[i].concat(e)),this.lift(new n.PXSprite(this.genTexture(i)))},circle(t,e=16777215,i=16777215,s=0){return this.circleEx(this.circleTexture(t,e,i,s))},circleTexture(t,e=16777215,i=16777215,s=0){let n,r=this.graphics();return!1!==e&&(h.vec(e)?(n=e[1],e=e[0]):n=1,r.beginFill(this.color(e),n)),s>0&&r.lineStyle(s,this.color(i)),r.drawCircle(0,0,t),!1!==e&&r.endFill(),this.genTexture(r)},circleEx(t){let e=new n.PXSprite(t);return e=this.lift(e),(e.m5.circle=!0)&&this.centerAnchor(e)},line(t,e,i,s){let n=this.graphics(),r=o.clone(i),a=o.clone(s),h=this.color(t);function d(){n.clear(),n.lineStyle(e,h,1),n.moveTo(r[0],r[1]),n.lineTo(a[0],a[1])}d();let c=this.lift(n);return c.m5.ptA=function(t,e){return void 0!==t&&(r[0]=t,r[1]=l.nor(e,t),d()),r},c.m5.ptB=function(t,e){return void 0!==t&&(a[0]=t,a[1]=l.nor(e,t),d()),a},c},isMoving:t=>!l.feq0(t.m5.vel[0])||!l.feq0(t.m5.vel[1]),makeCells(t,e,i,s,n,r){let o=a.ndiv(i-t,n);return x(t,e,a.ndiv(s-t,r),o,n,r)},gridBox(t=.9,e=.9,i){let s=l.nor(i,n),r=u(s.height*e),o=u(s.width*t),h=a.ndiv(s.width-o,2),d=a.ndiv(s.height-r,2);return{x1:h,y1:d,x2:h+o,y2:d+r}},gridSQ(t,e=.6,i){let s=e*(n.height<n.width?n.height:n.width),r=a.ndiv(s,t),o=r;l.isEven(r)||--r,o=r,s=t*r;let h=a.ndiv(n.height-s,2),d=a.ndiv(n.width-s,2),c=d,u=h;return i&&(i.height=s,i.width=s,void 0!==i.x&&(c=i.x),void 0!==i.y&&(u=i.y),i.x=d,i.y=h,i.x1=d,i.y1=h,i.x2=d+s,i.y2=h+s),x(c,u,t,t,r,o)},divXY([t,e],i=.9,s=.9,r){let o,l,h,d,c=u(n.height*s),p=u(n.width*i),m=a.ndiv(p,t),g=a.ndiv(c,e);return c=e*g,p=t*m,h=a.ndiv(n.height-c,2),d=a.ndiv(n.width-p,2),o=d,l=h,r&&(r.height=c,r.width=p,void 0!==r.x&&(o=r.x),void 0!==r.y&&(l=r.y),r.x=d,r.y=h,r.x1=d,r.y1=h,r.x2=d+p,r.y2=h+c),x(o,l,e,t,m,g)},gridXY([t,e],i=.9,s=.9,r){let o,h,d,c,p=u(n.height*s),m=u(n.width*i),g=a.ndiv(m,t),f=a.ndiv(p,e),y=g>f?f:g;return l.isEven(y)||y--,p=e*y,m=t*y,d=a.ndiv(n.height-p,2),c=a.ndiv(n.width-m,2),o=c,h=d,r&&(r.height=p,r.width=m,void 0!==r.x&&(o=r.x),void 0!==r.y&&(h=r.y),r.x=c,r.y=d,r.x1=c,r.y1=d,r.x2=c+m,r.y2=d+p),x(o,h,e,t,y,y)},gridBBox(t,e,i){let s=i[0].length,n=i[0][0],r=i[i.length-1][s-1];return{x1:t+n.x1,x2:t+r.x2,y1:e+n.y1,y2:e+r.y2}},graphics(t){let e=new n.PXGraphics;return(e.m5={uuid:`${t||l.nextId()}`})&&e},drawGridBox(t,e=1,i="white",s){return s||(s=this.graphics()),s.lineStyle(e,this.color(i)),s.drawRect(t.x1,t.y1,t.x2-t.x1,t.y2-t.y1),s},drawGridBoxEx(t,e=1,i="white",s=1,n){return n||(n=this.graphics()),n.lineStyle(e,this.color(i)),n.drawRoundedRect(t.x1,t.y1,t.x2-t.x1,t.y2-t.y1,s),n},drawGridLines(t,e,i,s,n,r){let o=i.length,a=i[0].length;r||(r=this.graphics()),r.lineStyle(s,this.color(n));for(let s,n=1;n<o;++n)s=i[n],r.moveTo(t+s[0].x1,e+s[0].y1),r.lineTo(t+s[a-1].x2,e+s[a-1].y1);for(let s,n=1;n<a;++n)s=i[0],r.moveTo(t+s[n].x1,e+s[n].y1),s=i[o-1],r.lineTo(t+s[n].x1,e+s[n].y2);return r},add:(t,...e)=>(e.forEach((e=>e&&t.addChild(e))),t),remove(...t){1==t.length&&h.vec(t[0])&&(t=t[0]),l.doseqEx(t,(t=>{t.parent&&(l.inst(n.Scenes.Scene,t.parent)?t.parent.remove(t):t.parent.removeChild(t)),n.emit(["post.remove",t]),n.off(t),t.m5.dispose&&t.m5.dispose()}))},centerObj:t=>(t.x=n.width/2,t.y=n.height/2,t.anchor.x<.3?(t.x-=t.width/2,t.y-=t.height/2):t.anchor.x<.7||l.assert(!1,"bad anchor to center"),t),fillMax:t=>(t.anchor&&l.assert(t.anchor.x<.3,"wanted top left anchor"),t.height=n.height,t.width=n.width,t.x=0,t.y=0,t),colorToRgbA(t){if(!t||!h.str(t)||0==t.length)return;let e=t.toLowerCase(),i=s[e];if(i&&(t=i),"#"==t[0])return t.length<7&&(t=`#${t[1]}${t[1]}${t[2]}${t[2]}${t[3]}${t[3]}${t.length>4?t[4]+t[4]:""}`),[parseInt(t.substr(1,2),16),parseInt(t.substr(3,2),16),parseInt(t.substr(5,2),16),t.length>7?parseInt(t.substr(7,2),16)/255:1];if("transparent"==e)return[0,0,0,0];if(0==e.indexOf("rgb"))return e.indexOf("rgba")<0&&(e+=",1"),e.match(/[\.\d]+/g).map((t=>+t));throw`Error: Bad color: ${t}`},byteToHex:t=>("0"+t.toString(16)).slice(-2),colorToHex(t){const e=this.colorToRgbA(t);return"0x"+[0,1,2].map((t=>this.byteToHex(e[t]))).join("")},color3(t,e,i){return parseInt(["0x",this.byteToHex(t),this.byteToHex(e),this.byteToHex(i)].join(""))},color(t){return isNaN(t)?parseInt(this.colorToHex(t)):t},rgba(t){return l.assert(h.vec(t),"wanted rgba array"),parseInt("0x"+[0,1,2].map((e=>this.byteToHex(t[e]))).join(""))},hsla(t,e,i,s){function n(t){return Math.min(1,Math.max(0,t))}function r(t){return 6*(t=t<0?t+1:t>1?t-1:t)<1?a+(o-a)*t*6:2*t<1?o:3*t<2?a+(o-a)*(2/3-t)*6:a}t=t%360/360,e=n(e),i=n(i),s=n(s);let o=i<=.5?i*(e+1):i+e-i*e,a=2*i-o;return this.rgba([255*r(t+1/3),255*r(t),255*r(t-1/3),s])},resize(t,e,i,s,n){t&&l.doseqEx(t.children,(e=>e.m5&&e.m5.resize&&e.m5.resize(t.x,t.y,t.width,t.height)))},pinAbove(t,e,i=10,s=.5){let[n,r,a,l,h]=v(this,t),[d,c,u,p,m]=v(this,e,t),g=n.y1-i-(d.y2-d.y1),f=s<.3?n.x1:s<.7?l-c:n.x2-(d.x2-d.x1);e.y=!e.anchor||e.anchor.y<.3?g:e.anchor.y<.7?g+u:g+(d.y2-d.y1),e.x=!e.anchor||e.anchor.x<.3?f:e.anchor.x<.7?f+c:f+(d.x2-d.x1),e.parent===t&&o.sub$(e,t)},pinBelow(t,e,i=10,s=.5){let[n,r,a,l,h]=v(this,t),[d,c,u,p,m]=v(this,e,t),g=n.y2+i,f=s<.3?n.x1:s<.7?l-c:n.x2-(d.x2-d.x1);e.y=!e.anchor||e.anchor.y<.3?g:e.anchor.y<.7?g+u:g+(d.y2-d.y1),e.x=!e.anchor||e.anchor.x<.3?f:e.anchor.x<.7?f+c:f+(d.x2-d.x1),e.parent===t&&o.sub$(e,t)},pinCenter(t,e){let[i,s,n,r,a]=v(this,t),[l,h,d,c,u]=v(this,e,t),p=r-h,m=a-d;e.y=!e.anchor||e.anchor.y<.3?m:e.anchor.y<.7?m+d:m+(l.y2-l.y1),e.x=!e.anchor||e.anchor.x<.3?p:e.anchor.x<.7?p+h:p+(l.x2-l.x1),(t.m5.stage||e.parent===t)&&o.sub$(e,t)},pinLeft(t,e,i=10,s=.5){let[n,r,a,l,h]=v(this,t),[d,c,u,p,m]=v(this,e,t),g=n.x1-i-(d.x2-d.x1),f=s<.3?n.y1:s<.7?h-u:n.y2-(d.y2-d.y1);e.y=!e.anchor||e.anchor.y<.3?f:e.anchor.y<.7?f+u:f+(d.y2-d.y1),e.x=!e.anchor||e.anchor.x<.3?g:e.anchor.x<.7?g+c:g+(d.x2-d.x1),e.parent===t&&o.sub$(e,t)},pinRight(t,e,i=10,s=.5){let[n,r,a,l,h]=v(this,t),[d,c,u,p,m]=v(this,e,t),g=n.x2+i,f=s<.3?n.y1:s<.7?h-u:n.y2-(d.y2-d.y1);e.y=!e.anchor||e.anchor.y<.3?f:e.anchor.y<.7?f+u:f+(d.y2-d.y1),e.x=!e.anchor||e.anchor.x<.3?g:e.anchor.x<.7?g+c:g+(d.x2-d.x1),e.parent===t&&o.sub$(e,t)},setMass(t,e){t.m5.mass=e},genTexture:(t,e,i,s)=>p(t,e,i,s),bounceOff:t=>w(t.A,t.B,t),hit(t,e){const i=b(this,t,e);return i&&(n.emit(["hit",t],i),n.emit(["hit",e],i.swap())),i},collide(t,e,i=!0){const s=function(t,e,i,s=!0){let n=b(t,e,i);if(n){if(i.m5.static)o.sub$(e,n.overlapV);else{let t=o.div(n.overlapV,2);o.sub$(e,t),o.add$(i,t)}s&&w(e,i,n)}return n}(this,t,e,i);return s&&function(t){const e=new Set;return t.overlapN[1]<-.3&&e.add(n.TOP),t.overlapN[1]>.3&&e.add(n.BOTTOM),t.overlapN[0]<-.3&&e.add(n.LEFT),t.overlapN[0]>.3&&e.add(n.RIGHT),e.add(t),e}(s)},hitTest(t,e){return b(this,t,e)},clamp(t,e,i=!1,s){let r,o,a,d,c,u;h.vec(e)&&(r=e[1].left,o=e[1].right,a=e[1].top,d=e[1].bottom,e=e[0]),o=!1!==o,r=!1!==r,a=!1!==a,d=!1!==d,e instanceof n.Scenes.Scene?u=n.mockStage():e.m5&&e.m5.stage?u=e:void 0!==e.x2&&void 0!==e.y2?(u=e,c=!0):(e.isSprite?l.assert(t.parent===e):l.assert(!1,"Error: clamp() using bad container"),l.assert(l.feq0(e.rotation),"Error: clamp() container can't rotate"),l.assert(l.feq0(e.anchor.x),"Error: clamp() container anchor.x !==0"),l.assert(l.feq0(e.anchor.y),"Error: clamp() container anchor.y !==0"),u=e);let p=c?[0,0]:this.topLeftOffsetXY(u),m=new Set,g=!1,f=!1,y=this.getAABB(t),x=c?u.x1:u.x+p[0],v=x+(c?u.x2-u.x1:u.width),w=c?u.y1:u.y+p[1],b=w+(c?u.y2-u.y1:u.height);return r&&y.x1<x&&(t.x+=x-y.x1,g=!0,m.add(n.LEFT)),o&&y.x2>v&&(t.x-=y.x2-v,g=!0,m.add(n.RIGHT)),a&&y.y1<w&&(t.y+=w-y.y1,f=!0,m.add(n.TOP)),d&&y.y2>b&&(t.y-=y.y2-b,f=!0,m.add(n.BOTTOM)),m.size>0?(g&&(t.m5.vel[0]/=t.m5.mass,i&&(t.m5.vel[0]*=-1)),f&&(t.m5.vel[1]/=t.m5.mass,i&&(t.m5.vel[1]*=-1)),s&&s(m)):m=null,m},dbgShowDir(t){let e="?";switch(t){case n.NE:e="top-right";break;case n.NW:e="top-left";break;case n.TOP:case n.UP:e="top";break;case n.LEFT:e="left";break;case n.RIGHT:e="right";break;case n.BOTTOM:case n.DOWN:e="bottom";break;case n.SE:e="bottom-right";break;case n.SW:e="bottom-left"}return e},dbgShowCol(t){let e=[];if(h.set(t))for(let i of t.values())e.push(this.dbgShowDir(i));return e.join(",")}};return I.bmpText=I.bitmapText,l.doseq(s,((t,e)=>{I.SomeColors[e]=I.color(t)})),l.doseq(i,((t,e)=>{I.BtnColors[e]=I.color(t)})),n.Sprites=I}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Sprites"]=function(t){return t.Sprites?t.Sprites:n(t)}}(this),function(t,e){"use strict";function i(e,i){const s=t["io/czlab/mcfud/spatial"](),n=t["io/czlab/mcfud/math"](),{ute:r,is:o}=e,a=(Math.floor,t=>t.startsWith("scene::")?t:`scene::${t}`);function l(t){t&&(t.dispose&&t.dispose(),t.parent.removeChild(t))}class h extends e.PXContainer{constructor(t){super(),this.addChild(t),this.name=t.name,this.m5={stage:!0}}dispose(){l(this.children[0])}update(t){this.children[0].update(t)}}class d extends e.PXContainer{constructor(t,e,i){let n;super(),this.name=a(t),this.g={},this.m5={index:{},queue:[],garbo:[],sid:t,options:i,stage:!0,sgrid:s.spatialGrid(i.sgridX||320,i.sgridY||320)},o.fun(e)?n=e:o.obj(e)&&(n=r.dissoc(e,"setup"),r.inject(this,e)),n&&(this.m5.setup=n.bind(this))}_hitObjects(t,i,s,n=1){for(let r,o,a=0;a<s.length&&(o=s[a],!(i!==o&&!o.m5.dead&&i.m5.cmask&o.m5.type&&(r=e.Sprites.hitTest(i,o),r&&(e.emit(["hit",i],r),r.B.m5.static||e.emit(["hit",r.B],r.swap()),t.engrid(i),0==--n))));++a);}collideXY(t){this._hitObjects(this.m5.sgrid,t,this.m5.sgrid.search(t))}onCanvasResize([t,i]){e.Sprites.resize({x:0,y:0,width:t,height:i,children:this.children})}future(t,i){this.m5.queue.push([t,n.ndiv(e._curFPS*i,1e3)||1])}futureX(t,e){this.m5.queue.push([t,e||1])}getChildById(t){return t&&this.m5.index[t]}remove(t){o.str(t)&&(t=this.getChildById(t)),t&&(this.removeChild(t),t.m5._engrid&&this.m5.sgrid.degrid(t),t.m5.drag&&e.Input.undoDrag(t),t.m5.button&&e.Input.undoButton(t),t.m5.hotspot&&e.Input.undoHotspot(t),e.off(t),r.dissoc(this.m5.index,t.m5.uuid))}degrid(t){return t&&t.m5._engrid&&this.m5.sgrid.degrid(t),t}engrid(t){return t&&t.m5._engrid&&this.m5.sgrid.engrid(t),t}insert(t,e=!1){return this.insertAt(t,null,e)}insertAt(t,e,i=!1){return t=this._addit(t,e),i&&(t instanceof PIXI.TilingSprite||(t.m5._engrid=!0,t.visible&&this.m5.sgrid.engrid(t))),t}_addit(t,e){let i=this,s=t=>{t.m5&&(t.m5.root=i),t.children.forEach((t=>s(t)))};return o.num(e)&&e>=0&&e<this.children.length?this.addChildAt(t,e):this.addChild(t),s(t),this.m5.index[t.m5.uuid]=t}dispose(){this.m5.dead=!0,e.off(this),function t(i){i&&(e.Input.undoXXX(i),i.children.forEach((e=>t(e))))}(this),this.removeChildren(),e.modalScene===this&&(e.modalScene=undefined,e.Input.restore(),e.CON.log("removed the current modal scene"))}_tick(t,i){t.forEach((t=>{t.visible&&t.m5&&t.m5.tick&&(t.m5.tick(i),"x"==t.m5.flip&&(t.scale.x*=-1),"y"==t.m5.flip&&(t.scale.y*=-1),t.m5.flip=!1,e.emit(["post.tick",t],i),t.m5._engrid&&this.m5.sgrid.engrid(t)),t.children.length>0&&this._tick(t.children,i)}))}searchSGrid(t,e=!1){return this.m5.sgrid.search(t,e)}queueForRemoval(t){return this.m5.garbo.push(t),t}update(t){if(this.m5.dead)return;let e,i=this.m5.queue.filter((t=>(t[1]-=1,t[1]<=0)));for(;i.length>0;)r.disj(this.m5.queue,e=i.shift()),e[0]();this.preUpdate&&this.preUpdate(t),this._tick(this.children,t),this.postUpdate&&this.postUpdate(t),this.m5.garbo.forEach((t=>this.remove(t))),this.m5.garbo.length=0}runOnce(){this.m5.setup&&(this.m5.setup(this.m5.options),delete this.m5.setup)}}function c(t,i,s){let{Sprites:a}=e,l=e.getScaleFactor();if(0==t.length)return;let h,d,c,u=(i=r.patch(i,{bg:0,padding:10,fit:20,borderWidth:4,border:a.SomeColors.white})).borderWidth*l,p=i.group||a.container(),m=i.padding*l,g=2*(i.fit*l);!function(t,i,s,n,o){let a,l=0,h=-1;i.forEach(((i,s)=>{n==e.DOWN?i.width>h&&(l=s,h=i.width):i.height>h&&(l=s,h=i.height),o||t.addChild(i),r.assert(r.feq0(i.anchor.x)&&r.feq0(i.anchor.y),"wanted topleft anchor")})),a=i[l];for(let t,r=l-1;r>=0;--r)t=i[r],e.Sprites[n==e.DOWN?"pinAbove":"pinLeft"](a,t,s),a=t;a=i[l];for(let t,r=l+1;r<i.length;++r)t=i[r],e.Sprites[n==e.DOWN?"pinBelow":"pinRight"](a,t,s),a=t}(p,t,m,s,i.skipAdd),d=p.width,c=p.height,h=r.tail(t);{let t=a.rect(d+g,c+g,i.bg,i.border,u);p.addChildAt(t,0),o.vec(i.bg)||(t.alpha=0==i.opacity?0:i.opacity||.5,"transparent"==i.bg&&(t.alpha=0))}c=p.height,d=p.width;let[f,y]=[n.ndiv(d,2),n.ndiv(c,2)];if(s==e.DOWN){t.forEach((t=>t.x=f-n.ndiv(t.width,2)));let e=c-(h.y+h.height);e=n.ndiv(e,2),t.forEach((t=>t.y+=e))}else{t.forEach((t=>t.y=y-n.ndiv(t.height,2)));let e=d-(h.x+h.width);e=n.ndiv(e,2),t.forEach((t=>t.x+=e))}return c=p.height,d=p.width,p.x=r.nor(i.x,n.ndiv(e.width-d,2)),p.y=r.nor(i.y,n.ndiv(e.height-c,2)),p}function u(t,i,s){let n,r,{Sprites:o,Input:a}=e,l=o.color(i.selectedColor),h=o.color(i.disabledColor);return t.forEach((t=>{t.m5.uuid==i.defaultChoice?(r=t,t.tint=l):t.tint=h,t.m5.button&&(t.m5.press=t=>{t!==r&&(r.tint=h,t.tint=l,r=t,i.onClick&&i.onClick(t))})})),r||(r=t[0],r.tint=l),n=c(t,i,s),n.getSelectedChoice=()=>r.m5.uuid,n}const p={Scene:d,SceneWrapper:h,layoutX:(t,i)=>c(t,i,e.RIGHT),layoutY:(t,i)=>c(t,i,e.DOWN),choiceMenuX:(t,i)=>u(t,i,e.RIGHT),choiceMenuY:(t,i)=>u(t,i,e.DOWN),scene(t,e,s){o.fun(e)&&(e={setup:e}),i[t]=[e,s]},replace(t,i,s){const n=a(o.str(t)?t:t.name),r=e.stage.getChildByName(n);if(!r)throw`Fatal: no such scene: ${n}`;return this.run(i,e.stage.getChildIndex(r),s)},remove(...t){1==t.length&&o.vec(t[0])&&(t=t[0]),t.forEach((t=>l(o.str(t)?e.stage.getChildByName(a(t)):t)))},removeAll(){for(;e.stage.children.length>0;)l(e.stage.children[e.stage.children.length-1]);e.mouse.reset(),e.Input.reset()},find:t=>e.stage.getChildByName(a(t)),runEx(t,e,i){this.removeAll(),this.run(t,e,i)},runSeq(...t){t.forEach((t=>{r.assert(o.vec(t),"Expecting array"),this.run(t[0],t[1],t[2])}))},modal(t,i){return e.Input.save(),e.modalScene=this.run(t,null,i)},run(t,s,n){let a,c,u,p=i[t];if(e.modalScene)throw"Fatal: modal scene is running";if(!p)throw`Fatal: unknown scene: ${t}`;if(o.obj(s)&&(n=s,s=r.dissoc(n,"slot")),n=r.inject({},p[1],n),u=r.inject({},p[0]),r.nichts(s)&&(s=n.slot||-1),n.tiled?(r.assert(n.tiled.name,"no tmx file!"),c=new e.Tiles.TiledScene(t,u,n)):c=new d(t,u,n),a=c,n.centerStage&&(a=new h(c)),s>=0&&s<e.stage.children.length){let t=e.stage.getChildAt(s);e.stage.addChildAt(a,s),l(t)}else e.stage.addChild(a);return c.runOnce(),c},topMost(){let t=r.last(e.stage.children);return t instanceof h&&(t=t.children[0]),r.assert(t instanceof d,"top is not a scene!"),t}};return e.Scenes=p}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Scenes"]=function(t){return t.Scenes?t.Scenes:i(t,{})}}(this),function(t,e){"use strict";function i(e,i,s){const n=t["io/czlab/mcfud/math"](),r=t["io/czlab/mcfud/vec2"](),{ute:o,is:a}=e,l=(Math.floor,5*Math.PI),h=Math.PI/2,d=2*Math.PI;function c(t,s,n=60,r=!1,l={}){return o.inject({duration:n,sprite:t,easing:s,loop:r,cur:0,on:0,onFrame(t,e){},_run(){this.cur=0,this.on=1,i.push(this)},onTick(){this.on&&(this.cur<this.duration?(this.onFrame(!1,this.easing(this.cur/this.duration)),this.cur+=1):(this.onFrame(!0),this.loop?(a.num(this.loop)&&--this.loop,this.onLoopReset(),this.cur=0):(this.on=0,this.onComplete&&o.delay(0,(()=>this.onComplete())),this.dispose())))},dispose(){o.disj(i,this),e.emit(["tween.disposed"],this)}},l)}function u(t,e,i,s){return c(t,e,i,s,{start(t,e,i,s){this._x=a.num(e)?[t,e]:null,this._y=a.num(s)?[i,s]:null,this._run()},onLoopReset(){this._x&&o.swap(this._x,0,1),this._y&&o.swap(this._y,0,1)},onFrame(t,e){this._x&&(this.sprite.x=t?this._x[1]:n.lerp(this._x[0],this._x[1],e)),this._y&&(this.sprite.y=t?this._y[1]:n.lerp(this._y[0],this._y[1],e))}})}const p={EXPO_IN:t=>0==t?0:Math.pow(1024,t-1),EXPO_OUT:t=>1==t?1:1-Math.pow(2,-10*t),EXPO_INOUT:t=>0==t?0:1==t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1))),LINEAR:t=>t,SMOOTH:t=>3*t*t-2*t*t*t,SMOOTH_QUAD(t){let e=p.SMOOTH(t);return e*e},SMOOTH_CUBIC(t){let e=p.SMOOTH(t);return e*e*e},EASE_IN_CUBIC:t=>t*t*t,EASE_OUT_CUBIC(t){let e=1-t;return 1-e*e*e},EASE_INOUT_CUBIC(t){if(t<.5)return 4*t*t*t;{let e=-2*t+2;return 1-e*e*e/2}},EASE_IN_QUAD:t=>t*t,EASE_OUT_QUAD:t=>1-(1-t)*(1-t),EASE_INOUT_QUAD(t){if(t<.5)return 2*t*t;{let e=-2*t+2;return 1-e*e/2}},EASE_IN_SINE:t=>1-Math.cos(t*h),EASE_OUT_SINE:t=>Math.sin(t*h),EASE_INOUT_SINE:t=>.5-Math.cos(t*Math.PI)/2,SPLINE:(t,e,i,s,n)=>(2*i+(s-e)*t+(2*e-5*i+4*s-n)*t*t+(3*i-e-3*s+n)*t*t*t)/2,CUBIC_BEZIER:(t,e,i,s,n)=>e*t*t*t+3*i*t*t*(1-t)+3*s*t*(1-t)*(1-t)+n*(1-t)*(1-t)*(1-t),ELASTIC_IN:t=>0==t?0:1==t?1:-Math.pow(2,10*(t-1))*Math.sin((t-1.1)*l),ELASTIC_OUT:t=>0==t?0:1==t?1:1+Math.pow(2,-10*t)*Math.sin((t-.1)*l),ELASTIC_INOUT(t){switch(t){case 0:return 0;case 1:return 1;default:return(t*=2)<1?-.5*Math.pow(2,10*(t-1))*Math.sin((t-1.1)*l):1+.5*Math.pow(2,-10*(t-1))*Math.sin((t-1.1)*l)}},BOUNCE_IN:t=>1-p.BOUNCE_OUT(1-t),BOUNCE_OUT:t=>t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375,BOUNCE_INOUT:t=>t<.5?.5*p.BOUNCE_IN(2*t):.5*p.BOUNCE_OUT(2*t-1)+.5,tweenAlpha(t,e,i,s=60,r=!1){const l=function(t,e,i,s){return c(t,e,i,s,{start(t,e){this._a=[t,e],this._run()},onLoopReset(){o.swap(this._a,0,1)},onFrame(t,e){this.sprite.alpha=t?this._a[1]:n.lerp(this._a[0],this._a[1],e)}})}(t,e,s,r);let h=t.alpha,d=i;return a.vec(i)&&(h=i[0],d=i[1]),l.start(h,d),l},tweenAngle(t,e,i,s=60,r=!1){const l=function(t,e,i,s){return c(t,e,i,s,{start(t,e){this._a=[t,e],this._run()},onLoopReset(){o.swap(this._a,0,1)},onFrame(t,e){this.sprite.rotation=t?this._a[1]:n.lerp(this._a[0],this._a[1],e)}})}(t,e,s,r);let h=t.rotation,d=i;return a.vec(i)&&(h=i[0],d=i[1]),l.start(h,d),l},tweenScale(t,e,i,s,r=60,l=!1){const h=function(t,e,i,s){return c(t,e,i,s,{start(t,e,i,s){this._x=a.num(e)?[t,e]:null,this._y=a.num(s)?[i,s]:null,this._run()},onLoopReset(){this._x&&o.swap(this._x,0,1),this._y&&o.swap(this._y,0,1)},onFrame(t,e){this._x&&(this.sprite.scale.x=t?this._x[1]:n.lerp(this._x[0],this._x[1],e)),this._y&&(this.sprite.scale.y=t?this._y[1]:n.lerp(this._y[0],this._y[1],e))}})}(t,e,r,l);let d=t.scale.x,u=t.scale.y,p=i,m=s;return a.vec(i)&&(d=i[0],p=i[1]),a.vec(s)&&(u=s[0],m=s[1]),a.num(p)||(d=p=null),a.num(m)||(u=m=null),h.start(d,p,u,m),h},tweenXY(t,e,i,s,n=60,r=!1){const o=u(t,e,n,r);let l=t.x,h=t.y,d=i,c=s;return a.vec(i)&&(l=i[0],d=i[1]),a.vec(s)&&(h=s[0],c=s[1]),a.num(d)||(l=d=null),a.num(c)||(h=c=null),o.start(l,d,h,c),o},fadeOut(t,e=60){return this.tweenAlpha(t,this.EASE_OUT_SINE,0,e)},fadeIn(t,e=60){return this.tweenAlpha(t,this.EASE_OUT_SINE,1,e)},pulse(t,e=0,i=60,s=!0){return this.tweenAlpha(t,this.SMOOTH,e,i,s)},slide(t,e,i,s,n=60){return this.tweenXY(t,e,i,s,n)},throb(t,e=.9,i=.9,s=60,n=!0){return this.tweenScale(t,this.SMOOTH_QUAD,e,i,s,n)},scale(t,e=.5,i=.5,s=60){return this.tweenScale(t,this.SMOOTH,e,i,s)},strobe(t,e=1.3,i=10,s=20,n=10,r=!0){return this.tweenScale(t,(t=>this.SPLINE(t,i,0,1,s)),e,e,n,r)},wobble(t,i,s=1.2,n=1.2,r=10,a=!0){let{x1:l,x2:h,y1:d,y2:c}=i;return function(...t){const i={children:t.slice(),onTweenEnd(t){for(let e,i=0;i<this.children.length;++i)if(e=this.children[i],e===t){this.children.splice(i,1);break}0==this.children.length&&(this.dispose(),this.onComplete&&o.delay(0,(()=>this.onComplete())))},size(){return this.children.length},dispose(){e.off(["tween.disposed"],"onTweenEnd",this),this.children.forEach((t=>t.dispose())),this.children.length=0}};return e.on(["tween.disposed"],"onTweenEnd",i),i}(this.tweenScale(t,(t=>this.SPLINE(t,o.or(l,10),0,1,o.or(h,10))),s,null,r,a),this.tweenScale(t,(t=>this.SPLINE(t,o.or(d,-10),0,1,o.or(c,-10))),null,n,r,a))},followCurve(t,e,i,s=60){let n=u(t,e,s);return n.start=function(){this._run()},n.onFrame=function(e,s){e||r.set(t,p.CUBIC_BEZIER(s,i[0][0],i[1][0],i[2][0],i[3][0]),p.CUBIC_BEZIER(s,i[0][1],i[1][1],i[2][1],i[3][1]))},n.start(),n},walkPath:(t,e,i,s=300)=>function s(n,r){let a=p.tweenXY(t,e,[i[n][0],i[n+1][0]],[i[n][1],i[n+1][1]],r);return a.onComplete=()=>{++n<i.length-1&&o.delay(0,(()=>s(n,r)))},a}(0,n.ndiv(s,i.length)),walkCurve:(t,e,i,s=300)=>function s(n,r){let a=p.followCurve(t,e,i[n],r);return a.onComplete=()=>{++n<i.length&&o.delay(0,(()=>s(n,r)))},a}(0,n.ndiv(s,i.length)),remove(t){t&&t.dispose()},update(t){o.rseq(i,(e=>e.onTick(t))),o.rseq(s,(e=>e.onTick(t)))},createParticles(t,i,n,a,l,h,d,c=!0,u=20){function p(c){let u=o.randInt2(h.size,d.size),p=n();s.push(p),a.addChild(p),p.totalFrames&&p.gotoAndStop(o.randInt2(0,p.totalFrames-1)),e.Sprites.sizeXY(p,u,u),r.set(p,t,i),e.Sprites.centerAnchor(p),p.m5.scaleSpeed=o.randFloat2(h.scale,d.scale),p.m5.alphaSpeed=o.randFloat2(h.alpha,d.alpha),p.m5.angVel=o.randFloat2(h.rotate,d.rotate);let m=o.randFloat2(h.speed,d.speed);r.set(p.m5.vel,m*Math.cos(c),m*Math.sin(c)),p.onTick=function(){r.add$(p.m5.vel,l),r.add$(p,p.m5.vel),p.scale.x-p.m5.scaleSpeed>0&&(p.scale.x-=p.m5.scaleSpeed),p.scale.y-p.m5.scaleSpeed>0&&(p.scale.y-=p.m5.scaleSpeed),p.rotation+=p.m5.angVel,p.alpha-=p.m5.alphaSpeed,p.alpha<=0&&(o.disj(s,p),e.Sprites.remove(p))}}h=o.patch(h,{angle:0,size:4,speed:.3,scale:.01,alpha:.02,rotate:.01}),d=o.patch(d,{angle:6.28,size:16,speed:3,scale:.05,alpha:.02,rotate:.03}),o.assert(u>1),l[0]=0;for(let t=(d.angle-h.angle)/(u-1),e=h.angle,i=0;i<u;++i)p(c?o.randFloat2(h.angle,d.angle):e),e+=t},shake(t,e=16,i=!1,r=!0){let a={},l=1,h=t.x,d=t.y,c=t.rotation,u=e,p=n.ndiv(e,10);let m=1;a.onTick=()=>i?void(l<10?(t.rotation=c,e-=p,t.rotation=e*m,++l,m*=-1):r?(e=u,l=1):o.disj(s,a)):void(l<10?(t.x=h,t.y=d,e-=p,t.x+=o.randInt2(-e,e),t.y+=o.randInt2(-e,e),++l):r?(e=u,l=1):o.disj(s,a)),s.push(a)},StarWarp:function(t){const i=e.tcached("boot/star.png");let s=0,n=0,r=0;const a=o.fill(1e3,(s=>((s={x:0,y:0,z:0,sprite:e.Sprites.sprite(i)}).sprite.anchor.x=.5,s.sprite.anchor.y=.7,l(s,2e3*o.rand()),t.addChild(s.sprite),s)));function l(t,e){const i=o.rand()*d,n=50*o.rand()+1;t.z=o.nor(e,s+1e3*o.rand()+2e3),t.x=Math.cos(i)*n,t.y=Math.sin(i)*n}let h=o.now();return{dispose(){a.forEach((t=>e.Sprites.remove(t.sprite)))},update(t){let i,d=e.width/2,c=e.height/2;n+=(r-n)/20,s+=10*t*(n+.025),a.forEach((t=>{t.z<s&&l(t),i=t.z-s,t.sprite.x=t.x*(20/i)*e.width+d,t.sprite.y=t.y*(20/i)*e.width+c;const r=t.sprite.x-d,o=t.sprite.y-c,a=Math.sqrt(r*r+o*o),h=Math.max(0,(2e3-i)/2e3);t.sprite.scale.x=.05*h,t.sprite.scale.y=.05*h+h*n*5*a/e.width,t.sprite.rotation=Math.atan2(o,r)+Math.PI/2}));let u=o.now();u-h>5e3&&(h=u,r=r>0?0:1)}}}};return e.FX=p}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/FX"]=function(t){return t.FX?t.FX:i(t,[],[])}}(this),function(t,e){"use strict";function i(i){const s=t["io/czlab/mcfud/geo2d"](),n=t["io/czlab/mcfud/vec2"](),r=t["io/czlab/mcfud/math"](),{Scenes:o,Sprites:a,FX:l,Input:h,is:d,ute:c}=i,u=Math.abs,p=Math.cos,m=Math.sin,g=Math.floor,f=Math.PI/180;Math.PI;o.scene("Splash",{setup(t){let e,{title:s,titleFont:r,titleColor:h,titleSize:d}=t,{action:u,clickSnd:p}=t,{bg:m,playMsg:g,playMsgFont:f,playMsgColor:y,playMsgSize:x,playMsgColor2:v}=t,w=i.getScaleFactor();f=f||"Doki Lowercase",r=r||"Big Shout Bob",g=g||i.clickPlayMsg(),y=c.nor(y,a.color("white")),v=c.nor(v,a.color("#ffc901")),h=c.nor(h,a.color("#ffc901")),d=c.nor(d,96*w),x=c.nor(x,64*w),this.insert(a.fillMax(a.sprite(m||"boot/splash.jpg"))),e=this.insert(a.container());{let t=a.bmpText(s,r,d);h&&a.tint(t,h),n.set(t,i.width/2,.3*i.height),e.addChild(a.anchorXY(t,.5))}{let t=a.bmpText(g,f,x),s=l.throb(t,.747,.747);a.oneOffClick(p,(()=>{a.tint(t,v),l.remove(s),l.tweenAlpha(e,l.EASE_OUT_SINE,0,90).onComplete=()=>{o.runEx(u.name,u.cfg)}})),n.set(t,i.width/2,.5*i.height),e.addChild(a.anchorXY(t,.5))}}}),o.scene("EndGame",{setup(t){let{fontName:e,fontSize:s,msg:n,replay:r,quit:l}=t,{winner:d,snd:u}=t;u=d?u||"game_win.mp3":u||"game_over.mp3",c.assert(s,"expected fontSize"),e=e||"Doki Lowercase";let p={fontName:e,fontSize:s},m=()=>a.opacity(a.bmpText("I",p),0),g=a.bmpText("Game Over",p),f=a.bmpText(n||"",p),y=h.mkBtn(a.bmpText("Play Again?",p)),x=a.bmpText(" or ",p),v=h.mkBtn(a.bmpText("Quit",p));y.m5.press=()=>o.runEx(r.name,r.cfg),v.m5.press=()=>o.runEx(l.name,l.cfg),i.sound(u).play(),this.insert(o.layoutY([g,f,m(),m(),m(),y,x,v],t))}}),o.scene("PhotoMat",{setup(t){if(t.cb)t.cb(this);else{let s=t.image?i.tcached(t.image):e;this.g.gfx=a.graphics(),s?this.g.gfx.beginTextureFill({texture:s}):this.g.gfx.beginFill(a.color(t.color)),this.g.gfx.drawRect(0,0,i.width,t.y1),this.g.gfx.drawRect(0,t.y2,i.width,i.height-t.y2),this.g.gfx.drawRect(0,0,t.x1,i.height),this.g.gfx.drawRect(t.x2,0,i.width-t.x2,i.height),this.g.gfx.endFill(),this.insert(this.g.gfx)}}}),o.scene("HotKeys",{setup(t){let e,i,s,n,r,o,{char_fire:l,char_down:u,char_up:p,char_left:m,char_right:g}=t,{fontName:f,fontSize:y,cb:x,radius:v,alpha:w,color:b}=t,I=t.buttons?"makeButton":"makeHotspot";c.assert(d.num(y),"expected fontsize"),c.assert(d.num(v),"expected radius"),c.assert(d.fun(x),"expected callback"),f=f||"Doki Lowercase",w=w||.2,b=c.nor(b,"grey"),u=u||"-",p=p||"+",m=m||"<",g=g||">",l=l||"^",n=a.opacity(a.circle(v,b),w),n.addChild(a.anchorXY(a.bmpText(u,f,y),.5)),s=a.opacity(a.circle(v,b),w),s.addChild(a.anchorXY(a.bmpText(p,f,y),.5)),r=a.opacity(a.circle(v,b),w),r.addChild(a.anchorXY(a.bmpText(m,f,y),.5)),o=a.opacity(a.circle(v,b),w),o.addChild(a.anchorXY(a.bmpText(g,f,y),.5)),t.fire&&(i=a.opacity(a.circle(v,b),w),i.addChild(a.anchorXY(a.bmpText(l,f,y),.5))),e=x(i?{left:r,right:o,down:n,up:s,fire:i}:{left:r,right:o,down:n,up:s}),e.right&&(this.insert(h[I](e.right)),e.right.m5.hotspot&&(e.right.m5.touch=(t,e)=>e?h.setKeyOn(h.RIGHT):h.setKeyOff(h.RIGHT))),e.left&&(this.insert(h[I](e.left)),e.left.m5.hotspot&&(e.left.m5.touch=(t,e)=>e?h.setKeyOn(h.LEFT):h.setKeyOff(h.LEFT))),e.up&&(this.insert(h[I](e.up)),e.up.m5.hotspot&&(e.up.m5.touch=(t,e)=>e?h.setKeyOn(h.UP):h.setKeyOff(h.UP))),e.down&&(this.insert(h[I](e.down)),e.down.m5.hotspot&&(e.down.m5.touch=(t,e)=>e?h.setKeyOn(h.DOWN):h.setKeyOff(h.DOWN))),e.fire&&(this.insert(h[I](e.fire)),e.fire.m5.hotspot&&(e.fire.m5.touch=(t,e)=>e?h.setKeyOn(h.SPACE):h.setKeyOff(h.SPACE))),t.extra&&t.extra(this)}}),o.scene("AudioIcon",{setup(t){let{xOffset:e,yOffset:s,xScale:r,yScale:o}=t,{cb:l,iconOn:d,iconOff:u}=t,{Sound:p}=i,m=i.getScaleFactor(),g=h.mkBtn(a.spriteFrom(d||"audioOn.png",u||"audioOff.png"));r=c.nor(r,2*m),o=c.nor(o,2*m),e=c.nor(e,-10*m),s=c.nor(s,0),a.scaleXY(a.opacity(g,.343),r,o),n.set(g,i.width-g.width+e,0+s),g.m5.showFrame(p.sfx()?0:1),g.m5.press=()=>{p.sfx()?(p.mute(),g.m5.showFrame(1)):(p.unmute(),g.m5.showFrame(0))},this.insert(g)}}),o.scene("StarfieldBg",{setup(t){c.patch(t,{height:i.height,width:i.width,count:100,minVel:15,maxVel:30});const e=[],s=a.graphics();c.inject(this.g,{gfx:s,stars:e,lag:0,dynamic:!0,fps:1/t.fps,draw(){return s.clear(),e.forEach((t=>{s.beginFill(16777215),s.drawRect(t.x,t.y,t.size,t.size),s.endFill()})),this},moveStars(i){this.lag+=i,this.lag>=this.fps&&(this.lag=0,e.forEach((e=>{e.y+=i*e.vel,e.y>t.height&&(n.set(e,c.randInt(t.width),0),e.size=c.randInt(4),e.vel=c.rand()*(t.maxVel-t.minVel)+t.minVel)})),this.draw())}}),t.static&&(this.g.dynamic=!1);for(let i=0;i<t.count;++i)e[i]={x:c.rand()*t.width,y:c.rand()*t.height,size:3*c.rand()+1,vel:c.rand()*(t.maxVel-t.minVel)+t.minVel};this.g.draw()&&this.insert(s)},postUpdate(t){this.g.dynamic&&this.g.moveStars(t)}},{fps:90,count:100,minVel:15,maxVel:30});const y={Periodic:class{constructor(t,e,i=16){this._interval=e,this._ctor=t,this._timer=0,this._size=i,this._pool=c.fill(i,t)}lifeCycle(t){this._timer+=t,this._timer>this._interval&&(this._timer=0,this.discharge())}discharge(){throw"Periodic: please implement action()"}reclaim(t){this._pool.length<this._size&&this._pool.push(t)}_take(){return this._pool.length>0?this._pool.pop():this._ctor()}},Meander:function(t){const s=[],r={dispose(){i.off(r)},boom(r){if(c.assert(r.A===t,"got hit by someone else???"),r.B&&r.B.m5.sensor)i.emit(["bump.sensor",r.B],r.A);else{let[s,o]=t.m5.vel;r.impact=e,n.sub$(t,r.overlapV),r.overlapN[1]<-.3&&(!t.m5.skipHit&&o<0&&n.setY(t.m5.vel,0),r.impact=u(o),i.emit(["bump.top",t],r)),r.overlapN[1]>.3&&(!t.m5.skipHit&&o>0&&n.setY(t.m5.vel,0),r.impact=u(o),i.emit(["bump.bottom",t],r)),r.overlapN[0]<-.3&&(!t.m5.skipHit&&s<0&&n.setX(t.m5.vel,0),r.impact=u(s),i.emit(["bump.left",t],r)),r.overlapN[0]>.3&&(!t.m5.skipHit&&s>0&&n.setX(t.m5.vel,0),r.impact=u(s),i.emit(["bump.right",t],r)),r.impact===e?r.impact=0:i.emit(["bump.*",t],r)}s.push(r)}};return i.on(["hit",t],"boom",r),i.on(["post.remove",t],"dispose",r),function(e){return s.length=0,i.Sprites.move(t,e),t.parent.collideXY(t),s[0]}},Camera:function(t,e,s,n){const o=n?n.height:s,a=n?n.width:e,l=r.ndiv(o,2),h=r.ndiv(a,2),u=r.ndiv(o,4),p=r.ndiv(a,4);let m=0,f=0,y={dispose(){i.off(y)},set x(e){m=e,t.x=-m},set y(e){f=e,t.y=-f},get x(){return m},get y(){return f},worldHeight:s,worldWidth:e,width:a,height:o,follow(t){const n=c.feq0(t.angle)?i.Sprites.getAABB(t):i.Sprites.boundingBox(t);(()=>{n.x1<this.x+g(h-p)&&(this.x=n.x1-p)})(),(()=>{n.x2>this.x+g(h+p)&&(this.x=n.x2-3*p)})(),(()=>{n.y1<this.y+g(l-u)&&(this.y=n.y1-u)})(),(()=>{n.y2>this.y+g(l+u)&&(this.y=n.y2-3*u)})(),this.x<0&&(this.x=0),this.y<0&&(this.y=0),this.x+a>e&&(this.x=e-a),this.y+o>s&&(this.y=s-o);let{x1:r,x2:d,y1:m,y2:f}=t.m5.getImageOffsets(),y=n.x2-d;y>e&&(t.x-=y-e),y=n.y2-f,y>s&&(t.y-=y-s),y=n.x1+r,y<0&&(t.x+=-y),y=n.y1+m,y<0&&(t.y+=-y)},centerOver:function(t,e){if(1!=arguments.length||d.num(t))d.num(t)&&(this.x=t-h),d.num(e)&&(this.y=e-l);else{let e=i.Sprites.centerXY(t);this.x=e[0]-h,this.y=e[1]-l}}};return i.on(["post.remove",t],"dispose",y),y},Patrol:function(t,e,s){const r={dispose(){i.off(r)},goLeft(e){t.m5.heading=i.LEFT,t.m5.flip="x",n.setX(t.m5.vel,-e.impact)},goRight(e){t.m5.heading=i.RIGHT,t.m5.flip="x",n.setX(t.m5.vel,e.impact)},goUp(e){n.setY(t.m5.vel,-e.impact),t.m5.heading=i.UP,t.m5.flip="y"},goDown(e){n.setY(t.m5.vel,e.impact),t.m5.heading=i.DOWN,t.m5.flip="y"}};return e&&(i.on(["bump.right",t],"goLeft",r),i.on(["bump.left",t],"goRight",r)),s&&(i.on(["bump.top",t],"goDown",r),i.on(["bump.bottom",t],"goUp",r)),i.on(["post.remove",t],"dispose",r),r},Jitter:function(t,e,s){s=c.nor(s,i.Input.UP),e=c.nor(e,-300);let r=0,o=0,a=e/3;const l={dispose(){i.off(l)},onGround(){o=.24}};return i.on(["bump.bottom",t],"onGround",l),function(l,h){if(!t.m5.skipHit){let d=t.m5.speed,c=i.Input.keyDown(i.Input.RIGHT),u=i.Input.keyDown(i.Input.LEFT),p=i.Input.keyDown(s);h&&(u||c||o>0)&&(h.overlapN[1]>.85||h.overlapN[1]<-.85)&&(h=null),u&&!c?(t.m5.heading=i.LEFT,h&&o>0?n.set(t.m5.vel,d*h.overlapN[1],-d*h.overlapN[0]):n.setX(t.m5.vel,-d)):c&&!u?(t.m5.heading=i.RIGHT,h&&o>0?n.set(t.m5.vel,-d*h.overlapN[1],d*h.overlapN[0]):n.setX(t.m5.vel,d)):n.setX(t.m5.vel,0),o>0&&0==r&&p?(n.setY(t.m5.vel,e),r+=1,o=-l):p&&r<2&&(r+=1,i.emit(["jump",t])),r&&!p&&(r=0,i.emit(["jumped",t]),t.m5.vel[1]<a&&(t.m5.vel[1]=a)),o>0&&(t.m5.vel[1]=0)}o-=l}},MazeRunner:function(t,e){return function(s,r){let o,a,l,h,[u,p]=t.m5.vel,m=t.m5.speed,g=!c.feq0(u),f=!c.feq0(p);g&&f||!e||(f&&(d.obj(e)?t.m5.showFrame(e[p>0?i.DOWN:i.UP]):e&&(t.angle=p>0?180:0)),g&&(d.obj(e)?t.m5.showFrame(e[u>0?i.RIGHT:i.LEFT]):e&&(t.angle=u>0?90:-90))),i.u.touchOnly?(o=t.m5.heading==i.RIGHT,l=t.m5.heading==i.LEFT,h=t.m5.heading==i.UP,a=t.m5.heading==i.DOWN):(o=i.Input.keyDown(i.Input.RIGHT)&&i.RIGHT,a=i.Input.keyDown(i.Input.DOWN)&&i.DOWN,l=i.Input.keyDown(i.Input.LEFT)&&i.LEFT,h=i.Input.keyDown(i.Input.UP)&&i.UP),(l||h)&&(m*=-1),l&&o?n.setX(t.m5.vel,0):(l||o)&&(t.m5.heading=l||o,n.setX(t.m5.vel,m)),h&&a?n.setY(t.m5.vel,0):(h||a)&&(t.m5.heading=h||a,n.setY(t.m5.vel,m))}},seek(t,e){let i=n.unit$(n.sub(e,t));return i&&(n.mul$(i,t.m5.maxSpeed),n.sub$(i,t.m5.vel),n.add$(t.m5.steer,i)),t},flee(t,e,i){let s=n.sub(t,e),r=n.len2(s);void 0===i&&(i=t.m5.steerInfo.tooCloseDistance),r>i*i||(n.unit$(s)||(s=[.1,.1]),n.mul$(s,t.m5.maxSpeed),n.sub$(s,t.m5.vel),n.add$(t.m5.steer,s))},arrive(t,e,i){let s=1,r=n.dist(t,e),o=n.unit$(n.sub(e,t));void 0===i&&(i=t.m5.steerInfo.arrivalThreshold),r>i||(s=r/i),n.mul$(o,t.m5.maxSpeed*s),n.sub$(o,t.m5.vel),n.add$(t.m5.steer,o)},pursue(t,e){let i=n.dist(t,e)/t.m5.maxSpeed,s=n.add(e,n.mul(e.m5.vel,i));return this.seek(t,s)},evade(t,e){let i=n.dist(t,e)/t.m5.maxSpeed,s=n.sub(e,n.mul(e.m5.vel,i));return this.flee(t,s)},idle:t=>(n.mul$(t.m5.vel,0),n.mul$(t.m5.steer,0),t),wander(t){let e=n.mul$([1,1],t.m5.steerInfo.wanderRadius),i=n.len(e),s=n.mul$(n.unit(t.m5.vel),t.m5.steerInfo.wanderDistance);return e[0]=Math.cos(t.m5.steerInfo.wanderAngle)*i,e[1]=Math.sin(t.m5.steerInfo.wanderAngle)*i,t.m5.steerInfo.wanderAngle+=c.rand()*t.m5.steerInfo.wanderRange-.5*t.m5.steerInfo.wanderRange,n.add$(t.m5.steer,n.add$(s,e)),t},interpose(t,e,i){let s=n.div$(n.add(e,i),2),r=n.dist(t,s)/t.m5.maxSpeed,o=n.add(e,n.mul(e.m5.vel,r)),a=n.add(i,n.mul(i.m5.vel,r));return this.seek(t,n.div$(n.add$(o,a),2))},separation(t,e,i=300,s=100){let r=[0,0],o=0;e.forEach((e=>{e!==t&&n.dist(e,t)<i&&(n.add$(r,n.sub(e,t)),++o)})),o>0&&n.flip$(n.div$(r,o)),n.add$(t.m5.steer,n.mul$(n.unit$(r),s))},followLeader(t,e,i,s=400,r=300,o=100,a=1600,l=200){let h=n.mul$(n.unit(e.m5.vel),s),d=n.add(e,h);n.flip$(h);let c=n.add(e,h);return function(t,e,i,s){return n.dist(i,t)<s||n.dist(e,t)<s}(t,e,d,a)&&this.evade(t,e),this.arrive(t,c,l),this.separation(t,i,r,o)},queue(t,e,i=500,s=500){let r=function(){let r,o=n.mul$(n.unit(t.m5.vel),i),a=n.add(t,o);for(let i=0;i<e.length;++i)if(e[i]!==t&&n.dist(a,e[i])<s){r=e[i];break}return r}(),o=[0,0],a=n.mul(t.m5.vel,1);r&&(o=n.mul$(n.flip(t.m5.steer),.8),n.unit$(n.flip$(a)),n.add$(o,a),n.dist(t,r)<s&&n.mul$(t.m5.vel,.3)),n.add$(t.m5.steer,o)},flock(t,e){let i=0,s=[0,0],r=n.mul(t.m5.vel,1);e.forEach((e=>{e!==this&&function(e){return!(n.dist(t,e)>t.m5.steerInfo.inSightDistance||n.dot(n.sub(e,t),n.unit(t.m5.vel))<0)}(e)&&(n.add$(r,e.m5.vel),n.add$(s,e),n.dist(t,e)<t.m5.steerInfo.tooCloseDistance&&this.flee(t,e),++i)})),i>0&&(n.div$(r,i),n.div$(s,i),this.seek(t,s),n.add$(t.m5.steer,n.sub$(r,t.m5.vel)))},followPath(t,e,i,s=1){let r=e[t.m5.pathIndex];r&&(n.dist(t,r)<s&&(t.m5.pathIndex>=e.length-1?i&&(t.m5.pathIndex=0):t.m5.pathIndex+=1),t.m5.pathIndex>=e.length-1&&!i?this.arrive(t,r):this.seek(t,r))},avoid(t,e){let i,s=n.len(t.m5.vel)/t.m5.maxSpeed,r=n.add(t,n.mul$(n.unit(t.m5.vel),s)),o=n.add(t,n.mul$(n.unit(t.m5.vel),.5*t.m5.steerInfo.avoidDistance)),a=null;for(let i,s=0;s<e.length;++s)e[s]!==this&&(i=n.dist(e[s],r)<=e[s].m5.radius||n.dist(e[s],o)<=e[s].m5.radius,i&&(null===a||n.dist(t,e[s])<n.dist(t,a))&&(a=e[s]));a&&(i=n.mul$(n.unit$(n.sub(r,a)),100),n.add$(t.m5.steer,i))},lineOfSight(t,e,i){let n=a.centerXY(t),r=a.centerXY(e);for(let t,e,o=0;o<i.length;++o)if(e=i[o],t=e.m5.circle?s.hitTestLineCircle(n,r,e.x,e.y,e.width/2):s.hitTestLinePolygon(n,r,s.bodyWrap(a.toPolygon(e),e.x,e.y)),t[0])return!1;return!0},shoot(t,e,s,r,o,a){let l=r(),h=i.Sprites.topLeftOffsetXY(t);return n.add$(h,[o,a]),n.copy(l,n.add(t,h)),n.set(l.m5.vel,Math.cos(e)*s,Math.sin(e)*s),l},healthBar(t){let{scale:e,width:i,height:s,lives:n,borderWidth:l,line:h,fill:d}=t,c=4*e,u=4*e,p=[];l=(l||4)*e,n=n||3,d=a.color(d),h=a.color(h);for(let t=r.ndiv(i,n),e=0;e<n;++e)p.push(a.rect(t,s-2*l,d));return{dec(){return this.lives>0&&(this.lives-=1,p[this.lives].visible=!1),this.lives>0},lives:p.length,sprite:o.layoutX(p,{bg:["#cccccc",0],borderWidth:l,border:h,padding:c,fit:u})}},gaugeUI(t){let{minDeg:e,maxDeg:i,line:s,gfx:n,scale:o,cx:l,cy:h,radius:d,alpha:u,fill:g,needle:y}=c.patch(t,{minDeg:90,maxDeg:360});const x=[0,45*f,90*f,135*f,180*f,225*f,270*f,315*f];function v(t,e,i,s){return[t+i*p(s),e+i*m(s)]}return y=a.color(y),s=a.color(s),g=a.color(g),d*=o,{gfx:n,draw(){n.clear(),n.lineStyle({width:d/8,color:s}),n.beginFill(g,u),n.drawCircle(l,h,d),n.endFill(),x.forEach((t=>function(t,e,i,r){let[a,l]=v(t,e,d-4*o,i),[h,c]=v(t,e,d-12*o,i);n.lineStyle({color:s,width:r,cap:PIXI.LINE_CAP.ROUND}),n.moveTo(a,l),n.lineTo(h,c),n.closePath()}(l,h,t,7*o))),function(t,e,i){let[r,a]=v(l,h,t-20*o,i),[d,c]=v(l,h,2*o,i+90*f),[u,p]=v(l,h,2*o,i-90*f);n.lineStyle({cap:PIXI.LINE_CAP.ROUND,width:4*o,color:y}),n.moveTo(d,c),n.lineTo(r,a),n.lineTo(u,p),n.closePath(),n.lineStyle({color:s}),n.beginFill(s),n.drawCircle(l,h,9*o),n.endFill()}(d*o,0,f*r.lerp(e,i,t.update()))}}}};return i.Ute2D=y}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Ute2D"]=t=>t.Ute2D?t.Ute2D:i(t)}(this),function(t,e){"use strict";if(!t.AudioContext)throw"Fatal: no audio.";const i=console;Math.floor;function s(e,s){const{ute:n,is:r}=e,o=new Map;let a=1;function l(t,i,r){let l=0,h=1;const d={sids:new Map,buffer:undefined,loop:!1,src:r,name:i,get pan(){return l},set pan(t){l=t},get volume(){return h},set volume(t){h=t},play(){const i=n.now(),s=this.name;if(e.Sound.sfx()&&!function(t,e,i){let s;return o.has(t)&&o.get(t)>e?s=!0:i?o.set(t,e+i):o.delete(t),s}(s,i)){let e=a++,i=1e3*this.buffer.duration,s=t.ctx.createGain(),r=t.ctx.createStereoPanner(),o=t.ctx.createBufferSource();o.buffer=this.buffer,o.connect(s),s.connect(r),r.connect(t.ctx.destination),this.loop?o.loop=!0:n.delay(i,(()=>this.sids.delete(e))),r.pan.value=l,s.gain.value=h,o.start(0),this.sids.set(e,o)}return this},stop(){return this.sids.forEach((t=>t.stop(0))),this.sids.length=0,this}};return s[i]=d}const h={ctx:new t.AudioContext,_mute:0,init(){n.delay(0,(()=>{"suspended"==this.ctx.state&&this.ctx.resume()}))},sfx(){return 0===this._mute},mute(){return this._mute=1,this},unmute(){return this._mute=0,this},decodeData(t,e,s,n,r){let o=l(this,t,e);return this.ctx.decodeAudioData(s,(t=>{n(o.buffer=t),i.log(`decoded sound file:${e}`)}),(t=>{r&&r(e,t)})),o},decodeUrl(t,e,i,s){let n=new XMLHttpRequest,r=l(this,t,e);return n.open("GET",e,!0),n.responseType="arraybuffer",n.addEventListener("load",(()=>{this.decodeData(e,n.response,i,s)})),n.send(),r}};return e.sound=function(t){return s[e.assetPath(t)]||n.assert(!1,`Sound: ${t} not loaded.`)},e.Sound=h}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Sound"]=function(t){return t.Sound?t.Sound:s(t,{})}}(this),function(t,e){"use strict";function i(i){const s=t["io/czlab/mcfud/geo2d"](),n=t["io/czlab/mcfud/vec2"](),{ute:r,is:o}=i,a=[],l=()=>a[0];function h(t={}){function a(e){t===l()&&(t.keyInputs.set(e.keyCode,!1),t.shiftKey=e.shiftKey,t.ctrlKey=e.ctrlKey,t.altKey=e.altKey,e.preventDefault())}function h(e){t===l()&&(t.keyInputs.set(e.keyCode,!0),t.ctrlKey=!1,t.altKey=!1,t.shiftKey=!1,e.preventDefault())}return r.inject(t,{yid:`yid#${r.nextId()}`,keyInputs:r.jsMap(),pauseInput:!1,ctrlKey:!1,altKey:!1,shiftKey:!1,ptr:e,dispose(){this.ptr.dispose(),i.touchDevice||r.delEvent([["keyup",window,a,!1],["keydown",window,h,!1]])},pointer(){return this.ptr||(this.ptr=function(t){let o={ActiveDragsID:r.jsMap(),ActiveDrags:r.jsMap(),ActiveTouches:r.jsMap(),Hotspots:[],Buttons:[],DragDrops:[],state:[!1,!0],touchZeroID:0,_visible:!0,_x:0,_y:0,width:1,height:1,downTime:0,downAt:[0,0],elapsedTime:0,dragged:e,dragOffsetX:0,dragOffsetY:0,anchor:i.makeAnchor(.5,.5),get cursor(){return i.canvas.style.cursor},set cursor(t){i.canvas.style.cursor=t},get x(){return this._x/i.scale},get y(){return this._y/i.scale},get visible(){return this._visible},get isUp(){return this.state[1]},get isDown(){return this.state[0]},set visible(t){this.cursor=t?"auto":"none",this._visible=t},updateMultiDrags(t){let e=o;for(let t,i,s=0;s<e.ActiveTouches.length;++s){i=e.ActiveTouches[s];for(let s,o,a=e.DragDrops.length-1;a>=0;--a){if(o=e.DragDrops[a],s=e.ActiveDrags.get(o.m5.uuid),s){n.set(s.dragged,s.dragStartX+(i.x-s.dragPtrX),s.dragStartY+(i.y-s.dragPtrY));break}if(o.m5.drag&&e._test(o,i.x,i.y)){r.assoc(e.ActiveDrags,o.m5.uuid,s={dragStartX:o.x,dragStartY:o.y,dragPtrX:i.x,dragPtrY:i.y,dragged:o,id:i.id}),r.assoc(e.ActiveDragsID,i.id,s),t=o.parent.children,r.disj(t,o),t.push(o);break}}}},updateDrags(t){if(this.state[0])if(this.dragged)n.set(this.dragged,this.dragStartX+(this.x-this.dragPtrX),this.dragStartY+(this.y-this.dragPtrY));else for(let t,e,i=this.DragDrops.length-1;i>=0;--i)if(e=this.DragDrops[i],e.m5.drag&&this.hitTest(e)){this.dragStartX=e.x,this.dragStartY=e.y,this.dragPtrX=this.x,this.dragPtrY=this.y,this.dragged=e,t=e.parent.children,r.disj(t,e),t.push(e);break}this.state[1]&&(this.dragged&&this.dragged.m5.onDragDropped&&this.dragged.m5.onDragDropped(),this.dragged=e)},getGlobalPosition(){return{x:this.x,y:this.y}},_press(){if(t!==l())return;let e,i,s,n=this.Buttons.length;for(e=0;e<n;++e)if(i=this.Buttons[e],i.m5.gui&&i.m5.press&&this.hitTest(i)){i.m5.press(i),s=!0;break}if(!s)for(e=0;e<n;++e)if(i=this.Buttons[e],i.m5.press&&this.hitTest(i)){i.m5.press(i);break}},_doMDown(e){if(t!==l())return;let i,s=o;for(let t,n=0;n<s.Hotspots.length;++n)if(t=s.Hotspots[n],t.m5.touch&&s.hitTest(t)){t.m5.touch(t,e),i=!0;break}return i},mouseDown(e){if(t!==l())return;let s=o,n=r.now();0==e.button&&(e.preventDefault(),s._x=e.pageX-e.target.offsetLeft,s._y=e.pageY-e.target.offsetTop,r.setVec(s.state,!0,!1),s.downTime=n,s.downAt[0]=s._x,s.downAt[1]=s._y,i.Sound.init(),t.pauseInput||(i.emit([`${t.yid}/mousedown`]),s._doMDown(!0)))},mouseMove(e){if(t!==l())return;let s=o;s._x=e.pageX-e.target.offsetLeft,s._y=e.pageY-e.target.offsetTop,t.pauseInput||i.emit([`${t.yid}/mousemove`])},mouseUp(e){if(t!==l())return;let s=o,a=r.now();if(0==e.button&&(e.preventDefault(),s.elapsedTime=Math.max(0,a-s.downTime),s._x=e.pageX-e.target.offsetLeft,s._y=e.pageY-e.target.offsetTop,r.setVec(s.state,!1,!0),!t.pauseInput&&(i.emit([`${t.yid}/mouseup`]),!s._doMDown(!1)))){let e=n.vecAB(s.downAt,s),r=n.len2(e);r<400&&s.elapsedTime<200?(i.emit([`${t.yid}/single.tap`]),s._press()):s._swipeMotion(e,r,s.elapsedTime)}},_swipeMotion(e,s,r,o){if(t!==l())return;let a,h=n.unit$(n.normal(e));s>400&&r<1e3&&(Math.abs(h[0])>.8||Math.abs(h[1])>.8)&&(h[0]>.8&&(a="swipe.down"),h[0]<-.8&&(a="swipe.up"),h[1]>.8&&(a="swipe.left"),h[1]<-.8&&(a="swipe.right")),a&&i.emit([`${t.yid}/${a}`],o)},_doMTouch(e,i){if(t!==l())return;let s=o,n=r.jsMap();for(let t,r=0;r<e.length;++r){t=e[r];for(let e,r=0;r<s.Hotspots.length;++r)if(e=s.Hotspots[r],e.m5.touch&&s._test(e,t.x,t.y)){e.m5.touch(e,i),n.set(t.id,1);break}}return n},_doMDrag(e,i){if(t!==l())return;let s=o;for(let t,n,r=0;r<e.length;++r)n=e[r],i.get(n.id)||(t=s.ActiveDragsID.get(n.id),t&&(i.set(n.id,1),t.dragged.m5.onDragDropped&&t.dragged.m5.onDragDropped(),s.ActiveDragsID.delete(n.id),s.ActiveDrags.delete(t.dragged.m5.uuid)));return i},touchCancel(e){t===l()&&(console.warn("received touchCancel event!"),this.freeTouches())},touchStart(e){if(t!==l())return;let s=o,n=e.target,a=[],h=r.now(),d=e.targetTouches,c=s.ActiveTouches;e.preventDefault();for(let t,e,o,l,u,p=0;p<d.length;++p)u=d[p],l=u.identifier,e=u.pageX-n.offsetLeft,o=u.pageY-n.offsetTop,r.assoc(c,l,t={id:l,_x:e,_y:o,downTime:h,downAt:[e,o],x:e/i.scale,y:o/i.scale}),a.push(t),0===p&&(s.touchZeroID=l,s._x=e,s._y=o,s.downTime=h,s.downAt=[e,o],r.setVec(s.state,!0,!1));i.Sound.init(),t.pauseInput||(i.emit([`${t.yid}/touchstart`],a),s._doMTouch(a,!0))},touchMove(e){if(t!==l())return;let s=[],n=o,r=e.target,a=e.targetTouches;e.preventDefault();for(let t,e,o,l,h,d=0;d<a.length;++d)l=a[d],h=l.identifier,t=l.pageX-r.offsetLeft,e=l.pageY-r.offsetTop,h==n.touchZeroID&&(n._x=t,n._y=e),(o=n.ActiveTouches.get(h))&&(o.x=t/i.scale,o.y=e/i.scale,o._x=t,o._y=e,s.push(o));t.pauseInput||i.emit([`${t.yid}/touchmove`],s)},touchEnd(e){if(t!==l())return;let s,n,a,h,d,c,u=o,p=[],m=(e.targetTouches,e.changedTouches),g=e.target,f=r.now();for(e.preventDefault(),a=0;a<m.length;++a)d=m[a],c=d.identifier,s=d.pageX-g.offsetLeft,n=d.pageY-g.offsetTop,h=u.ActiveTouches.get(c),c==u.touchZeroID&&(u.elapsedTime=Math.max(0,f-u.downTime),r.setVec(u.state,!1,!0),u._x=s,u._y=n),h&&(h.elapsedTime=Math.max(0,f-h.downTime),u.ActiveTouches.delete(c),h._x=s,h._y=n,h.x=s/i.scale,h.y=n/i.scale,p.push(h));if(!t.pauseInput){i.emit([`${t.yid}/touchend`],p);let e=u._doMTouch(p,!1);u._doMDrag(p,e),u._onMultiTouches(p,e)}},_onMultiTouches(e,s){if(t!==l())return;let r=o;for(let o,a,l,h=0;h<e.length;++h)if(o=e[h],!s.get(o.id))if(a=n.vecAB(o.downAt,o),l=n.len2(a),l<400&&o.elapsedTime<200){i.emit([`${t.yid}/single.tap`],o);for(let t,e=0,i=r.Buttons.length;e<i;++e)if(t=r.Buttons[e],t.m5.press&&r._test(t,o.x,o.y)){t.m5.press(t);break}}else r._swipeMotion(a,l,o.elapsedTime,o)},freeTouches(){r.setVec(this.state,!1,!0),this.touchZeroID=0,this.ActiveTouches.clear(),this.ActiveDrags.clear(),this.ActiveDragsID.clear()},reset(){r.setVec(this.state,!1,!0),this.freeTouches(),this.DragDrops.length=0,this.Buttons.length=0,this.Hotspots.length=0},_test(t,e,r){let o=i.Sprites,a=o.gposXY(t),l=o.toPolygon(t),h=n.translate(a,l.calcPoints);return s.hitTestPointInPolygon(e,r,h)},hitTest(t){return this._test(t,this.x,this.y)},update(t){this.DragDrops.length>0&&(i.touchDevice?this.updateMultiDrags(t):this.updateDrags(t)),this.tail&&this.updateTrail()},updateTrail(){this.tailHistX.pop(),this.tailHistY.pop(),this.tailHistX.unshift(this.x),this.tailHistY.unshift(this.y),this.tailPoints.forEach(((t,e)=>{t.x=this.cubic(this.tailHistX,e/c*d),t.y=this.cubic(this.tailHistY,e/c*d)}))},cubic(t,e,i=1){function s(t,e){return t<0&&(t=0),t>e.length-1&&(t=e.length-1),e[t]}function n(t,e){return i*(s(t+1,e)-s(t-1,e))/2}const r=Math.floor(e),o=[n(r,t),n(r+1,t)],a=[s(r,t),s(r+1,t)],l=(e-=r)*e,h=e*l;return(2*h-3*l+1)*a[0]+(h-2*l+e)*o[0]+(-2*h+3*l)*a[1]+(h-l)*o[1]},disableTrail(){this.tail&&i.stage.removeChild(this.tail),this.tail=null,this.tailHistX=null,this.tailHistY=null,this.tailPoints=null},enableTrail(){const t=r.fill(c,(()=>new PIXI.Point(0,0))),e=i.tcached("boot/trail.png"),s=new PIXI.SimpleRope(e,t);s.blendmode=PIXI.BLEND_MODES.ADD,this.tail=s,this.tailPoints=t,this.tailHistX=r.fill(d,0),this.tailHistY=r.fill(d,0),i.stage.addChild(s)}};const a=[["mousemove",i.canvas,o.mouseMove],["mousedown",i.canvas,o.mouseDown],["mouseup",window,o.mouseUp]],h=[["touchmove",i.canvas,o.touchMove],["touchstart",i.canvas,o.touchStart],["touchend",window,o.touchEnd],["touchcancel",window,o.touchCancel]];return i.touchDevice?r.addEvent(h):r.addEvent(a),o.dispose=function(){this.reset(),i.touchDevice?r.delEvent(h):r.delEvent(a)},o}(this)),this.ptr},update(t){this.pauseInput||this.ptr.update(t)},keybd(e,s,n){const a=this,h={press:s,release:n,isDown:!1,isUp:!0,ctrl:!1,alt:!1,shift:!1};function d(e){t===l()&&(e.preventDefault(),h.code.includes(e.keyCode)&&(h.ctrl=e.ctrlKey,h.alt=e.altKey,h.shift=e.shiftKey,!a.pauseInput&&h.isUp&&h.press&&h.press(h.alt,h.ctrl,h.shift),h.isUp=!1,h.isDown=!0))}function c(e){t===l()&&(e.preventDefault(),h.code.includes(e.keyCode)&&(a.pauseInput||h.isDown&&h.release&&h.release(),h.isUp=!0,h.isDown=!1,h.ctrl=!1,h.alt=!1,h.shift=!1))}return h.code=o.vec(e)?e:[e],i.touchDevice||r.addEvent([["keyup",window,c,!1],["keydown",window,d,!1]]),h.dispose=()=>{i.touchDevice||r.delEvent([["keyup",window,c,!1],["keydown",window,d,!1]])},h},reset(){this.pauseInput=!1,this.ctrlKey=!1,this.altKey=!1,this.shiftKey=!1,this.ptr.reset(),this.keyInputs.clear()},resize(){i.mouse=this.ptr,this.ptr.reset()},dbg(){console.log(`N# of touches= ${this.ptr.ActiveTouches.size}`),console.log(`N# of hotspots= ${this.ptr.Hotspots.length}`),console.log(`N# of buttons= ${this.ptr.Buttons.length}`),console.log(`N# of drags= ${this.ptr.DragDrops.length}`),console.log(`Mouse pointer = ${this.ptr}`)}}),t.pointer(),i.touchDevice||r.addEvent([["keyup",window,a,!1],["keydown",window,h,!1]]),t}const d=20,c=100;const u={LEFT:37,RIGHT:39,UP:38,DOWN:40,ZERO:48,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,ENTER:13,ESC:27,BACKSPACE:8,TAB:9,SHIFT:16,CTRL:17,ALT:18,SPACE:32,HOME:36,END:35,PGGUP:33,PGDOWN:34,isPaused:()=>l().pauseInput,resume(){l().pauseInput=!1},pause(){l().pauseInput=!0},dbg(){l().dbg()},resize(){l().resize()},reset(){l().reset()},setKeyOn(t){l().keyInputs.set(t,!0)},setKeyOff(t){l().keyInputs.set(t,!1)},keybd:(t,e,i)=>l().keybd(t,e,i),undoButton:t=>(r.disj(l().ptr.Buttons,t),t.m5.button=!1,t),makeButton:(t,e=!1)=>(r.conj(l().ptr.Buttons,t),t.m5.button=!0,t.m5.gui=e,t),undoHotspot:t=>(r.disj(l().ptr.Hotspots,t),t.m5.hotspot=!1,t),makeHotspot:t=>(r.conj(l().ptr.Hotspots,t),t.m5.hotspot=!0,t),undoXXX(t){t&&t.m5&&(t.m5.drag&&this.undoDrag(t),t.m5.button&&this.undoButton(t),t.m5.hotspot&&this.undoHotspot(t))},update(t){l().update(t)},makeDrag:t=>(r.conj(l().ptr.DragDrops,t),t.m5.drag=!0,t),undoDrag:t=>(r.disj(l().ptr.DragDrops,t),t.m5.drag=!1,t),keyUp(t){return!this.keyDown(t)},keyDown:t=>l().keyInputs.get(t),keyShift:()=>l().shiftKey,keyAlt:()=>l().altKey,keyCtrl:()=>l().ctrlKey,pointer:()=>l().pointer(),dispose(){a.forEach((t=>t.dispose())),a.length=0},restore(){a.length>1&&(a.shift().dispose(),l().pauseInput=!1)},save(){a.unshift(h())},on:(...t)=>(r.assert(o.vec(t[0])&&o.str(t[0][0]),"bad arg for Input.on()"),t[0][0]=`${l().yid}/${t[0][0]}`,i.on(...t)),off:(...t)=>(r.assert(o.vec(t[0])&&o.str(t[0][0]),"bad arg for Input.off()"),t[0][0]=`${l().yid}/${t[0][0]}`,i.off(...t))};return i.canvas.style.touchAction="none",u.undoBtn=u.undoButton,u.mkBtn=u.makeButton,u.mkDrag=u.makeDrag,a.push(h()),i.Input=u}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Input"]=function(t){return t.Input?t.Input:i(t)}}(this),function(t,e){"use strict";function i(t){const e=Math.PI/8,i=3*e,s=5*e,n=7*e,{Sprites:r,Input:o,is:a,ute:l}=t,h=Math.sin,d=Math.cos,c=Math.abs,u=180/Math.PI;function p(r){function a(t){let e=t.changedTouches,i=t.target;e?(t=e[0],r.m5.touchId=e[0].identifier):r.m5.touchId=0,r.m5.startX=t.pageX-i.offsetLeft,r.m5.startY=t.pageY-i.offsetTop,r.m5.drag=!0,r.m5.static||(r.visible=!0,r.x=r.m5.startX,r.y=r.m5.startY),o.isPaused()||r.m5.onStart()}function p(t){r.m5.drag&&(r.m5.inner.position.set(0,0),r.m5.drag=!1,r.m5.static||(r.visible=!1),o.isPaused()||r.m5.onEnd())}function m(a){if(o.isPaused()||!r.visible||!r.m5.drag)return;let p,m=a.target;if(a.changedTouches){for(let t=0,e=a.changedTouches;t<e.length;++t)if(r.m5.touchId==e[t].identifier){p=[e[t].pageX-m.offsetLeft,e[t].pageY-m.offsetTop];break}}else p=[a.pageX-m.offsetLeft,a.pageY-m.offsetTop];let g=p?p[0]-r.m5.startX:0,f=p?p[1]-r.m5.startY:0,y=r.m5.range,x=0;if(p[0]=0,p[1]=0,l.feq0(g)&&l.feq0(f))return;let v,w=c(g),b=c(f);if(l.feq0(g))p[0]=0,f>0?(p[1]=f>y?y:f,x=270,v=t.DOWN):(p[1]=-(b>y?y:b),x=90,v=t.UP);else if(l.feq0(f))p[1]=0,g>0?(p[0]=w>y?y:w,x=0,v=t.RIGHT):(p[0]=-(w>y?y:w),x=180,v=t.LEFT);else{let r=Math.atan(c(f/g));x=r*u,p[0]=p[1]=0,g*g+f*f>=y*y?(p[0]=y*d(r),p[1]=y*h(r)):(p[0]=w>y?y:w,p[1]=b>y?y:b),f<0&&(p[1]=-c(p[1])),g<0&&(p[0]=-c(p[0])),g>0&&f<0||(g<0&&f<0?x=180-x:g<0&&f>0?x+=180:g>0&&f>0&&(x=360-x)),v=function(r,o){const a=Math.atan2(+o,+r);return a>-s&&a<-i?(console.log("calcDir=UP"),t.UP):a>i&&a<s?(console.log("calcDir=DOWN"),t.DOWN):a>-e&&a<0||a>0&&a<e?(console.log("calcDir=RIGHT"),t.RIGHT):a>n&&a<Math.PI||a>-Math.PI&&a<-n?(console.log("calcDir=LEFT"),t.LEFT):a>e&&a<i?(console.log("calcDir= SE "),t.SE):a>s&&a<n?(console.log("calcDir= SW "),t.SW):a>-i&&a<-e?(console.log("calcDir= NE "),t.NE):a>-n&&a<-s?(console.log("calcDir= NW "),t.NW):void l.assert(!1,"Failed Joystick calcDir")}(p[0],p[1])}r.m5.inner.position.set(p[0],p[1]),r.m5.onChange(v,x)}const g=[["mousemove",t.canvas,m],["mousedown",t.canvas,a],["mouseup",window,p],["touchend",window,p],["touchcancel",window,p],["touchmove",t.canvas,m],["touchstart",t.canvas,a]];return l.addEvent(g),r.m5.dispose=()=>{l.delEvent(g)},r}const m={assets:["boot/joystick.png","boot/joystick-handle.png"],joystick(t){let e=r.sprite("boot/joystick-handle.png"),i=r.sprite("boot/joystick.png"),s=new PIXI.Container,n=l.inject({oscale:.7,iscale:1,inner:e,outer:i,onEnd(){},onStart(){},prevDir:0,static:!1,onChange(t,e){}},t);return r.scaleXY(i,n.oscale,n.oscale),r.scaleXY(e,n.iscale,n.iscale),i.anchor.set(.5),e.anchor.set(.5),s.addChild(i),s.addChild(e),n.range=s.width/2.5,n.static||(s.visible=!1),s.m5=n,p(s)}};return t.Touch=m}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Touch"]=function(t){return t.Touch?t.Touch:i(t)}}(this),function(t,e){"use strict";function i(e){const i=[e.UP,e.LEFT,e.RIGHT,e.DOWN],s=t["io/czlab/mcfud/vec2"](),n=t["io/czlab/mcfud/math"](),{ute:r,is:o}=e,a=Math.abs,l=Math.ceil,h=Math.floor;function d(t,i,s){return e.getIndex(t,i,s.tiled.tileW,s.tiled.tileH,s.tiled.tilesInX)}function c(t,i){return s.vecAB(e.Sprites.centerXY(t),e.Sprites.centerXY(i))}function u(t){const e=t.image,i=e&&e.split("/");t.image=i&&i.length&&i[i.length-1]}function p(t,e){let i=-1;if(t>0)for(i=0;e[i+1]&&t>=e[i+1][0];)++i;return i>=0?e[i]:[]}function m(t,e,i){let s=[];return t.forEach((t=>{s.push([t.firstgid,t]),t.spacing||(t.spacing=0),u(t);let n={};(t.tiles||[]).forEach((e=>{let s=r.selectNotKeys(e,"properties");s=r.inject(s,g(e)),s.gid=t.firstgid+e.id,n[e.id]=s,i[s.gid]=s})),e[t.name]=n})),s.sort(((t,e)=>t[0]>e[0]?1:t[0]<e[0]?-1:0))}function g(t){return(t.properties||[]).reduce(((t,e)=>(t[e.name]=e.value,t)),{})}function f(t,i,s,a){let l=o.str(i)?function(t){let i=e.resource(t,!0).data,s=i&&(i.tiledversion||i.version);return s&&r.cmpVerStrs(s,"1.4.2")>=0?i:r.assert(!1,`${t} needs update`)}(i):i,h={},d={};r.assert(o.obj(l),"bad tiled map"),l=JSON.parse(JSON.stringify(l)),r.inject(t.tiled,{tileW:l.tilewidth,tileH:l.tileheight,tilesInX:l.width,tilesInY:l.height,tiledMap:l,saved_tileW:l.tilewidth,saved_tileH:l.tileheight,tiledWidth:l.tilewidth*l.width,tiledHeight:l.tileheight*l.height},g(l));let c=a||t.getScaleFactor(),f=r.evenN(c*l.tileheight),x=r.evenN(c*l.tilewidth);t.tiled.new_tileW=x,t.tiled.new_tileH=f,a&&(t.tiled.scale=a);const v={imagelayer(t){u(t)},tilelayer(e){o.vec(e.data[0])&&(e.width=e.data[0].length,e.height=e.data.length,e.data=e.data.flat()),e.width||(e.width=t.tiled.tilesInX),e.height||(e.height=t.tiled.tilesInY);let i,r=g(e);if(!1!==e.visible)for(let i,o=0;o<e.data.length;++o){if(0==(i=e.data[o]))continue;!1===e.collision||!1===r.collision||!0!==e.collision&&!0!==r.collision||(i>0&&(t.tiled.collision[o]=i),e.collision=!0);let a=o%e.width,l=n.ndiv(o,e.width),h=d[i],c=h&&h.Class,u=c&&s[c],m=p(i,t.tiled.tileGidList)[1],g=y(t,i,a,l,r.width,r.height);g&&(g.tiled.layer=e,g.tiled.index=o,g.m5.static=!0),u&&(g=u.c(t,g,m,h)),g&&(h&&h.sensor&&(g.m5.sensor=!0),t.insert(g,!!u))}else(i=r.Class)&&s[i](t,e)},objectgroup(e){e.sprites=[],e.objects.forEach((i=>{r.assert(o.num(i.x),"wanted xy position");let a,l,h=g(i),c=r.nor(i.gid,-1);r.inject(i,h),c>0&&(l=d[c]);let u=r.nor(l&&l.Class,i.Class),m=u&&s[u],v=t.tiled.saved_tileW,w=t.tiled.saved_tileH,b=n.ndiv(i.x+v/2,v),I=n.ndiv(i.y-w/2,w),T=p(c,t.tiled.tileGidList)[1];i.column=b,i.row=I,a=c<=0?{width:x,height:f}:y(t,c,b,I,i.width,i.height,u),m&&(a=m.c(t,a,T,l,i)),a&&(!1===i.visible&&(a.visible=!1),i.uuid=a.m5.uuid,e.sprites.push(a),t.insert(a,!0),l&&l.sensor&&(a.m5.sensor=!0))}))}};s=r.nor(s,{}),r.inject(t.tiled,{objFactory:s,tileSets:h,tileProps:d,collision:r.fill(l.width*l.height,0),imagelayer:[],objectgroup:[],tilelayer:[],tileGidList:m(l.tilesets,h,d)}),["imagelayer","tilelayer","objectgroup"].forEach((e=>{l.layers.filter((t=>t.type==e)).forEach((i=>{v[e](i),t.tiled[e].push(i)}))})),t.tiled.tileW=x,t.tiled.tileH=f,t.tiled.tiledWidth=x*l.width,t.tiled.tiledHeight=f*l.height,t.parent instanceof e.Scenes.SceneWrapper&&(t.tiled.tiledHeight<e.height&&(t.parent.y=n.ndiv(e.height-t.tiled.tiledHeight,2)),t.tiled.tiledWidth<e.width&&(t.parent.x=n.ndiv(e.width-t.tiled.tiledWidth,2)))}function y(t,i,s,a,l,h,d){let c,u=p(i,t.tiled.tileGidList)[1],m=(r.assert(u,"Bad GID, no tileset"),u.columns),g=i-u.firstgid,f=t.tiled.tileProps[i],y=t.tiled.scale||t.getScaleFactor();c=(d=r.nor(d,f&&f.Class))&&t.tiled.objFactory[d],r.assertNot(g<0,`Bad tile id: ${g}`),o.num(m)||(m=n.ndiv(u.imagewidth,u.tilewidth+u.spacing));let x=g%m,v=n.ndiv(g,m),w=x*u.tilewidth,b=v*u.tileheight;u.spacing>0&&(w+=u.spacing*x,b+=u.spacing*v);let I=c&&c.s(t)||e.Sprites.frame(u.image,l||u.tilewidth,h||u.tileheight,w,b);return I&&(I.tiled={id:g,gid:i},l==t.tiled.saved_tileW?I.width=t.tiled.new_tileW:(I.scale.x=y,I.width=r.evenN(I.width)),h==t.tiled.saved_tileH?I.height=t.tiled.new_tileH:(I.scale.y=y,I.height=r.evenN(I.height)),I.x=s*t.tiled.new_tileW,I.y=a*t.tiled.new_tileH),I}const x=e.Sprites.lift({width:0,height:0,parent:null,x:0,y:0,rotation:0,tiled:{},anchor:{x:0,y:0},getGlobalPosition(){return{x:this.x+this.parent.x,y:this.y+this.parent.y}}});class v extends e.Scenes.Scene{constructor(t,e,i){super(t,e,i),this.tiled={}}reloadMap(t){this.tiled={},this.m5.options.tiled=t,f(this,t.name,t.factory,t.scale)}runOnce(){const t=this.m5.options.tiled;f(this,t.name,t.factory,t.scale),super.runOnce()}removeTile(t,i){let{x:s,y:r}=i;i.anchor.x<.3&&(r=i.y+n.ndiv(i.height,2),s=i.x+n.ndiv(i.width,2));let o=n.ndiv(s,this.tiled.tileW),a=n.ndiv(r,this.tiled.tileH),l=this.getTileLayer(t),h=o+a*this.tiled.tilesInX;l.data[h]=0,l.collision&&(this.tiled.collision[h]=0),e.Sprites.remove(i)}getTileLayer(t,e){let i=r.some(this.tiled.tilelayer,(e=>{if(e.name==t)return e}));if(!i&&e)throw`There is no layer with name: ${t}`;return i}getObjectGroup(t,e){let i=r.some(this.tiled.objectgroup,(e=>{if(e.name==t)return e}));if(!i&&e)throw`There is no group with name: ${t}`;return i}setTile(t,e,i,s){let n=this.getTSInfo(s),r=(n.firstgid,this.getTileLayer(t)),o=i+this.tiled.tilesInX*e;r.collision&&(this.tiled.collision[o]=s);let a=y(this,s,i,e,n.tilewidth,n.tileheight);return a&&(a.tiled.index=o,a.tiled.layer=r),a}getTile(t){let{x:e,y:i}=t;return t.anchor.x<.3&&(i+=n.ndiv(t.height,2),e+=n.ndiv(t.width,2)),this.getTileXY(e,i)}getTileXY(t,e){let i=n.ndiv(t,this.tiled.tileW),s=n.ndiv(e,this.tiled.tileH);return r.assert(i>=0&&i<this.tiled.tilesInX,`bad tile col:${i}`),r.assert(s>=0&&s<this.tiled.tilesInY,`bad tile row:${s}`),[i,s]}getNamedItem(t){let e=[];return this.tiled.objectgroup.forEach((i=>{i.objects.forEach((i=>{t==r.get(i,"name")&&e.push(i)}))})),e}getScaleFactor(){let t,i,s=1;return"max"==e.u.scaleToWindow&&(e.width>e.height?(i=e.height/(this.tiled.saved_tileH*this.tiled.tilesInY),s=i):(t=e.width/(this.tiled.saved_tileW*this.tiled.tilesInX),s=t)),s}getTileIndex(t){let[i,s]=e.Sprites.centerXY(t);return d(i,s,this)}getTSInfo(t){return p(t,this.tiled.tileGidList)[1]}getTileProps(t){return this.tiled.tileProps[t]}_getContactObj(t,e,i){let s=x;return s.height=this.tiled.tileH,s.width=this.tiled.tileW,s.x=e*s.width,s.y=i*s.height,s.tiled.gid=t,s.tiled.row=i,s.tiled.col=e,s.m5.sensor=!1,s}collideXY(t){let i=e.Sprites,s=this.tiled.tileW,a=this.tiled.tileH,h=this.tiled.collision,d=r.feq0(t.angle)?i.getAABB(t):i.boundingBox(t),c=Math.max(0,n.ndiv(d.x1,s)),u=Math.max(0,n.ndiv(d.y1,a)),p=Math.min(this.tiled.tilesInX-1,l(d.x2/s)),m=Math.min(this.tiled.tilesInY-1,l(d.y2/a));for(let s,n,a,l,d=u;d<=m;++d)for(let u=c;u<=p;++u)a=d*this.tiled.tilesInX+u,n=h[a],o.num(n)||r.assert(o.num(n),"bad gid"),0!==n&&(l=this._getContactObj(n,u,d),s=this.getTileProps(n),s&&(l.m5.sensor=!!s.sensor),l.parent=this,i.hit(t,l)&&l.m5.sensor&&e.emit(["2d.sensor",t],l));return super.collideXY(t)}}class w{constructor(t,e){this.straightCost=t,this.diagonalCost=e}manhattan(t,e){return a(t.row-e.row)*this.straightCost+a(t.col-e.col)*this.straightCost}euclidean(t,e){let i=e.col-t.col,s=e.row-t.row;return h(r.sqrt(i*i+s*s)*this.straightCost)}diagonal(t,e){let i=a(e.col-t.col),s=a(e.row-t.row);return h(i>s?this.diagonalCost*s+this.straightCost*(i-s):this.diagonalCost*i+this.straightCost*(s-i))}}const b={TiledScene:v,neighborCells(t,e,i){let s=e.tiled.tilesInX,n=[t-s-1,t-s,t-s+1,t-1],r=[t+1,t+s-1,t+s,t+s+1];return i||n.push(t),n.concat(r)},updateMap(t,e,i){let s=r.fill(t.length,0),n=t=>{let e=this.getTileIndex(t,i);r.assert(e>=0&&e<s.length,"tiled index outofbound"),t.tiled.index=e,s[e]=t.tiled.gid};return o.vec(e)?e.forEach(n):n(e),s},shortestPath(t,e,i,s,r=[],o="manhattan",a=!0){let l=s.tiled.tilesInX,h=i.map(((t,e)=>({f:0,g:0,h:0,parent:null,index:e,col:e%l,row:n.ndiv(e,l)}))),d=h[e],c=h[t],u=c,p=[u],m=[],g=[],f=t=>(a?this.neighborCells(t,s,!0):this.crossCells(t,s)).map((t=>h[t])).filter((e=>{if(e){let s=t%l==0,n=(t+1)%l==0,o=e.col%(l-1)==0&&0!=e.col,a=e.col%l==0,h=r.some((t=>i[e.index]==t));return s?!o:n?!a:!h}}));for(;u!==d;){let t=f(u.index);for(let e,i,s,n,r,a=0;a<t.length;++a){r=t[a],n=14,u.row!=r.row&&u.col!=r.col||(n=10),i=u.g+n,e=i+new w(10,14)[o](r,d);let l=p.some((t=>r===t)),h=m.some((t=>r===t));l||h?r.f>e&&(r.f=e,r.g=i,r.h=s,r.parent=u):(r.f=e,r.g=i,r.h=s,r.parent=u,p.push(r))}if(m.push(u),0==p.length)return g;p=p.sort(((t,e)=>t.f-e.f)),u=p.shift()}if(0!=p.length){let t=d;for(g.push(t);t!==c;)t=t.parent,g.unshift(t)}return g},lineOfSight(t,i,r,o,a=0,l=32,u=[]){let p,m,g,f,y,x=c(t,i),v=s.len(x),w=n.ndiv(v,l),b=[];for(let i,s=1;s<=w;++s)i=e.Sprites.centerXY(t),p=l*s,f=x[0]/v,y=x[1]/v,m=h(i[0]+f*p),g=h(i[1]+y*p),b.push({x:m,y:g,index:d(m,g,o)});let I=180*Math.atan2(x[1],x[0])/Math.PI;return b.every((t=>r[t.index]==a))&&(0==u.length||u.some((t=>t==I)))},crossCells(t,e){const i=e.tiled.tilesInX;return[t-i,t-1,t+1,t+i]},getCrossTiles(t,e,i){return this.crossCells(t,i).map((t=>e[t]))},getDiagonalCells(t,e){const i=o.num(e)?e:e.tiled.tilesInX;return[t-i-1,t-i+1,t+i-1,t+i+1]},getDiagonalTiles(t,e,i){return this.getDiagonalCells(t,i).map((t=>e[t]))},validDirections(t,s,n,r){const o=this.getTileIndex(t,r);return this.getCrossTiles(o,s,r).map(((t,s)=>t==n?i[s]:e.NONE)).filter((t=>t!==e.NONE))},canChangeDirection(t=[]){let i=t.find((t=>t===e.UP)),s=t.find((t=>t===e.DOWN)),n=t.find((t=>t===e.LEFT)),r=t.find((t=>t===e.RIGHT));return 0==t.length||1==t.length||(i||s)&&(n||r)},randomDirection:(t=[])=>0==t.length?e.NONE:1==t.length?t[0]:t[r.randInt2(0,t.length-1)],closestDirection(t,i){const s=c(t,i);return a(s[0])<a(s[1])?s[1]<=0?e.UP:e.DOWN:s[0]<=0?e.LEFT:e.RIGHT}};return e.Tiles=b}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Tiles"]=function(t){return t.Tiles?t.Tiles:i(t)}}(this);