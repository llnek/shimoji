!function(t,e){"use strict";const i=["mp3","wav","ogg"],s=["jpg","png","jpeg","gif"],n=["ttf","otf","ttc","woff"];function r(r,o,a,h){const{EventBus:l,dom:d,is:c,u:u}=t["io/czlab/mcfud/core"](),p=t["io/czlab/mcfud/vec2"](),g=t["io/czlab/mcfud/math"](),m=l(),f=Math.floor,y=console,x=1/15;let v=!1;class w extends PIXI.Container{constructor(){super(),this.m5={stage:!0}}onResize(t,e){this.children.forEach((i=>{i instanceof t.Scenes.SceneWrapper&&(i=i.children[0]),i.onCanvasResize(e)})),t.Input.resize()}}u.patch(r,{assetFiles:[],logos:[],aniFps:12,fps:60});const b=()=>t.innerWidth,I=()=>t.innerHeight;function T(t){const e=new O.Scenes.Scene("loader",{setup(){t.init.call(this)}},{});return O.stage.addChild(e).runOnce()}function S(t,e,s,n){const{Sound:r}=t;let o,h=0;function l(){a.forEach((t=>d.css(t,"display","none"))),e&&t.delBgTask(e),u.delay(50,(()=>{t.Scenes.remove(s),n?u.error("Cannot load game!"):t._runAppStart()}))}function c(t){0==--h&&l()}n||u.doseq(t.assets,((t,e)=>{o=u.fileExt(e),u.has(i,o)&&(++h,r.decodeData(t.name,t.url,t.xhr.response,c))})),0==h&&l()}function P(t){const{PXLR:e,PXLoader:s}=t;let r,h,l,p,g=u.map(t.u.assetFiles,(e=>t.assetPath(e)));if(u.findFiles(g,n).forEach((t=>{p=d.newElm("style"),l=d.newElm("span"),r=t.split("/").pop().split(".")[0],h=`@font-face {font-family: '${r}'; src: url('${t}');}`,o.push(r),d.conj(p,d.newTxt(h)),d.conj(document.head,p),l.innerHTML="?",d.css(l,"fontFamily",r),d.conj(document.body,l),d.css(l,{display:"block",opacity:"0"}),a.push(l)})),i.forEach((t=>{e.setExtensionLoadType(t,e.LOAD_TYPE.XHR),e.setExtensionXhrType(t,e.XHR_RESPONSE_TYPE.BUFFER)})),s.reset(),g.length>0){let e=t.u.load;e||(e=function(t){const{Sprites:e}=t;return{init(){let i=e.sprite("boot/ZotohLab_x1240.png"),s=e.sprite("boot/preloader_bar.png"),[n,r]=t.scaleXY([i.width,i.height],[t.width,t.height]),o=t.getScaleFactor(),a=n>r?r:n;a*=.2,e.scaleXY(s,a,a),e.scaleXY(i,a,a),e.pinCenter(this,i),e.pinBelow(i,s,4*o),e.hide(s),this.g.pbar=s,this.g.pbar_width=s.width,this.insert(i),this.insert(s)},update(t,i){!this.g.pbar.visible&&e.show(this.g.pbar),this.g.pbar.width=this.g.pbar_width*(i/100)}}}(t));let i=0,n=[],r=[],o=T(e);s.add(g),s.onError.add(((t,e,s)=>{++i,y.log(`${t}`)})),s.onProgress.add(((t,e)=>{y.log(`loading ${e.url}`),n.unshift(e.url),r.unshift(t.progress)})),s.load((()=>{0==i&&y.log("asset loaded!"),n.unshift("$")})),t.addBgTask({update(){let s=n.pop(),a=r.pop();c.num(a)&&s&&"$"!=s&&e.update.call(o,s,a),"$"==s&&S(t,this,o,i>0)}})}else S(t);return t.start()}const _={width:0,height:0},E={width:1,height:1};function X(t){let e=d.newElm("style");d.conj(document.body,O.canvas),d.conj(e,d.newTxt("body, * {padding: 0; margin: 0; height:100%; overflow:hidden}")),d.conj(document.head,e),d.css(O.canvas,{outline:"none"}),d.attrs(O.canvas,"tabindex","0"),d.css(document.body,{background:"black"})}function C(t){O._curFPS=O.calcFPS(t),h.forEach((e=>e.update&&e.update(t))),v||O.stageCS((e=>e.update&&e.update(t)))}const D=e=>t.requestAnimationFrame(e);class M{constructor(t){this.uid=t}playSound(){}pokeMove(){this.onPoke()}pokeWait(){this.onWait()}uuid(){return this.uid}stateValue(){u.assert(!1,"implement stateValue!")}}const O={_offsetX:0,_offsetY:0,_scaleX:1,_scaleY:1,_selectedCellX:0,_selectedCellY:0,_startPanX:0,_startPanY:0,_curFPS:60,Bot:class extends M{constructor(t="p2"){super(t)}onPoke(){}onWait(){}},Local:class extends M{constructor(t="p1"){super(t)}onPoke(){O.Input.resume()}onWait(){O.Input.pause()}},Mediator:class{constructor(){this.players=[],this._pcnt=0,this.state,this.pcur,this.end,this.pwin}cur(){return this.pcur}add(t){return t.pnum=++this._pcnt,t.owner=this,this.players.push(t),this}winner(){return this.pwin}isGameOver(){return this.end}gameState(t){return t&&(this.state=t),this.state}gameOver(t){return O.Input.resume(),this.pwin=t,this.end=!0}start(t){u.assert(t,"bad player to start with"),this.end=!1,this.pcur=t,this._turn()}other(){return this.pcur===this.players[0]?this.players[1]:this.pcur===this.players[1]?this.players[0]:void 0}_turn(){this.players.forEach((t=>{t!==this.pcur&&t.pokeWait()})),this.pcur.pokeMove()}redoTurn(){this.pcur.pokeMove()}postMove(t,e){u.assert(!1,"implement postMove!")}updateState(t,e){u.assert(!1,"implement updateState!")}updateSound(t){}updateMove(t,e){this.end||(this.updateState(t,e),this.updateSound(t),u.delay(0,(()=>this.postMove(t,e))))}takeTurn(){this.end||(this.pcur===this.players[0]?this.pcur=this.players[1]:this.pcur===this.players[1]&&(this.pcur=this.players[0]),this._turn())}},_frame:1/r.fps,EVERY:1,SOME:2,CENTER:3,TOP:4,LEFT:5,RIGHT:6,BOTTOM:7,UP:8,DOWN:9,NW:10,NE:11,SW:12,SE:13,NONE:100,PI_45:Math.PI/4,PI_90:Math.PI/2,PI_180:Math.PI,PI_270:1.5*Math.PI,PI_360:2*Math.PI,v2:p,math:g,ute:u,is:c,dom:d,u:r,Game:{mode:1},MODE_ONE:1,MODE_TWO:2,MODE_NET:3,CON:console,noop:()=>{},PXContainer:PIXI.Container,PXGraphics:PIXI.Graphics,PXTexture:PIXI.Texture,PXFilters:PIXI.filters,PXLR:PIXI.LoaderResource,PXLoader:PIXI.Loader.shared,PXObservablePoint:PIXI.ObservablePoint,get mouse(){return O.Input.pointer()},playSfx(t){return this.sound(t).play()},accel:(t,e,i)=>t+e*i,on:(...t)=>m.sub(...t),emit:(...t)=>m.pub(...t),off:(...t)=>m.unsub(...t),frameRate(){return this._frame},sideRight:t=>t==O.RIGHT||t==O.NE||t==O.SE,sideLeft:t=>t==O.LEFT||t==O.NW||t==O.SW,sideTop:t=>t==O.UP||t==O.TOP||t==O.NW||t==O.NE,sideBottom:t=>t==O.DOWN||t==O.BOTTOM||t==O.SW||t==O.SE,overlap:(t,e)=>!(t.x2<e.x1||e.x2<t.x1||t.y2<e.y1||e.y2<t.y1),overlapX:(t,e)=>t.x2>e.x1&&e.x2>t.x1,overlapY:(t,e)=>t.y2>e.y1&&e.y2>t.y1,hasClass(t,e){if(e)return t.classList.contains(e)},toggleClass:(t,e)=>(e&&t.classList.toggle(e),t),addClass:(t,e)=>(u.hasClass(t,e)||t.classList.add(e),t),removeClass:(t,e)=>(u.hasClass(t,e)&&t.classList.remove(e),t),wrapv:(t,e,i)=>t<e?i:t>i?e:t,get assets(){return PIXI.Loader.shared.resources},get designSize(){return this.u.arena},get width(){return this.canvas.width},get height(){return this.canvas.height},stageCS(t){this.inModal?t(u.last(this.stage.children)):this.stage.children.forEach((e=>{e instanceof O.Scenes.SceneWrapper&&(e=e.children[0]),e instanceof PIXI.SimpleRope||t(e)}))},scroll(e,i){t.scrollTo(e||0,i||1)},portrait:()=>O.height>O.width,screenCenter:()=>u.v2(g.ndiv(O.width,2),g.ndiv(O.height,2)),scaleXY:(t,e)=>[e[0]/t[0],e[1]/t[1]],makeAnchor(t,e){return new O.PXObservablePoint(O.noop,this,t,e)},mockStage(t=0,e=0,i,s){let n=c.obj(t)?t:{x:t,y:e,width:u.nor(i,O.width),height:u.nor(s,O.height)};return n.getGlobalPosition=()=>({x:this.x,y:this.y}),n.anchor=O.makeAnchor(0,0),n.m5={stage:!0},n},tcached(t){return u.inst(this.PXTexture,t)?t:c.str(t)?PIXI.utils.TextureCache[t]||PIXI.utils.TextureCache[this.assetPath(t)]:e},clickPlayMsg(){return(this.touchDevice?"Tap":"Click")+" to Play!"},splitXY:(t,e)=>[t%e,g.ndiv(t,e)],rect:(t,e,i,s)=>new O.PXRectangle(t,e,i,s),scaleSZ:(t,e)=>({width:e.width/t.width,height:e.height/t.height}),id(t){return this.image(t)},image(t){return this.tcached(t)||u.assert(!1,`${t} not loaded.`)},xml(t){return(this.assets[t]||u.assert(!1,`${t} not loaded.`)).data},json(t){return(this.assets[t]||u.assert(!1,`${t} not loaded.`)).data},assetPath(t){if(t.includes("/"))return t;let e="data",r=u.fileExt(t);return u.has(s,r)?e="images":"fnt"==r||u.has(n,r)?e="fonts":u.has(i,r)&&(e="audio"),`${e}/${t}`},contentScaleFactor(){return _.height=O.height,_.width=O.width,"max"!==r.scaleToWindow?E:this.scaleSZ(this.designSize,_)},getScaleFactor(t){if(t||"max"==r.scaleToWindow){_.height=O.height,_.width=O.width;let t=this.scaleSZ(this.designSize,_);return"x"==r.scaleFit||"X"==r.scaleFit?t.width:"y"==r.scaleFit||"Y"==r.scaleFit?t.height:Math.min(t.width,t.height)}return 1},resource(t,i){return(t?this.assets[t]||this.assets[this.assetPath(t)]:0)||(i?u.assert(!1,`no such resource ${t}.`):e)},_fpsList:e,_fpsSum:0,calcFPS(t){let e,i=0;return t>0&&(e=g.ndiv(1,t),this._fpsList||(this._fpsList=u.fill(60,e),this._fpsSum=60*e),this._fpsSum-=this._fpsList.pop(),this._fpsList.unshift(e),this._fpsSum+=e,i=g.ndiv(this._fpsSum,60)),i},degToRad:t=>t*(Math.PI/180),radToDeg:t=>t*(180/Math.PI),addBgTask(t){h.push(t)},delBgTask(t){t&&(u.disj(h,t),t.dispose&&t.dispose())},resume(){v=!1},pause(){v=!0},start(){let t=0,e=u.now(),i=function(){let s=u.now(),n=(s-e)/1e3,r=O.frameRate();for(n>x&&(n=x),t+=n;t>=r;t-=r)C(n);O.ctx.render(O.stage),e=s,D(i)};return D(i)},_runAppStart(){return O.Input.keybd(O.Input.Q,(()=>{this.takeScreenShot()})),O.u.start(this)},takeScreenShot(){O.ctx.extract.canvas(O.stage).toBlob((t=>{const e=document.createElement("a");document.body.append(e),e.download="screenshot",e.href=URL.createObjectURL(t),e.click(),e.remove()}),"image/png")},worldToScreen(t,e){return[f((t-this._offsetX)*this._scaleX),f((e-this._offsetY)*this._scaleY)]},screenToWorld(t,e){return[t/this._scaleX+this._offsetX,e/this._scaleY+this._offsetY]}};return function(e){let i=!1,s=r.arena,n=e.stage=new w;return u.assert(s,"design resolution req'd."),"max"!=r.scaleToWindow&&!0!==r.scaleToWindow||(i=!0,s={width:b(),height:I()},1==r.arena.scale&&(i=!1,r.arena=s,r.scaleToWindow="win")),r.logos||(r.logos=new Array),e.touchDevice=!!("ontouchstart"in document),e.ctx=PIXI.autoDetectRenderer(u.inject(s,{antialias:!0})),e.canvas=e.ctx.view,e.canvas.id="mojoh5",e.maxed=i,e.scale=1,e.scaledBgColor="#5A0101",["Sprites","Input","Scenes","Sound","FX","Ute2D","Tiles","Touch"].forEach((i=>{y.log(`installing module ${i}...`);let s=t[`io/czlab/mojoh5/${i}`](e);s.assets&&s.assets.forEach((t=>e.u.assetFiles.unshift(t)))})),h.push(e.FX,e.Input),X(),u.has(r,"border")&&d.css(e.canvas,"border",r.border),u.has(r,"bgColor")&&(e.ctx.backgroundColor=e.Sprites.color(r.bgColor)),!0===r.resize&&(u.addEvent("resize",t,u.debounce((()=>{const[t,i]=[e.width,e.height];e.ctx.resize(b(),I()),e.emit(["canvas.resize"],[t,i])}),r.debounceRate||150)),e.on(["canvas.resize"],(t=>n.onResize(e,t)))),e.touchDevice&&e.scroll(),e.canvas.focus(),function(t){const{PXLoader:e}=t;t.u.load||(t.u.logos=["boot/preloader_bar.png","boot/ZotohLab_x1240.png"]);let i=0,s=t.u.logos.map((e=>t.assetPath(e)));return 0==s.length?P(t):(e.reset(),e.add(s),e.onError.add(((t,e,s)=>{++i,y.log(`${t}`)})),e.load((()=>{0==i?(u.delay(50,(()=>P(t))),y.log("logo files loaded.")):y.log("logo files not loaded!")}))),t}(e)}(O)}if("object"==typeof module&&module.exports)throw"Panic: browser only!";t.MojoH5=function(t){return r(t,[],[],[])}}(this),function(t,e){"use strict";const i={blue:"#319bd5",green:"#78c03f",yellow:"#f9ef50",red:"#eb2224",orange:"#f48917",grey:"#848685",cyan:"#1ee5e6",lime:"#e5e61e",magenta:"#e61ee5",purple:"#a6499a"},s={aqua:"#00FFFF",black:"#000000",blue:"#0000FF",brown:"#A52A2A",crimson:"#DC143C",cyan:"#00FFFF",fuchsia:"#FF00FF",gray:"#808080",green:"#008000",grey:"#808080",lavender:"#E6E6FA",lime:"#00FF00",magenta:"#FF00FF",maroon:"#800000",navy:"#000080",olive:"#808000",orange:"#FFA500",purple:"#800080",red:"#FF0000",silver:"#C0C0C0",teal:"#008080",turquoise:"#40E0D0",wheat:"#F5DEB3",white:"#FFFFFF",yellow:"#FFFF00"};function n(n){const{v2:r,math:o,ute:a,is:h,dom:l}=n,d=t["io/czlab/mcfud/geo2d"](),c=2*Math.PI,u=Math.floor;function p(t,e,i,s){0==(s=s||t.getLocalBounds(null,!0)).width&&(s.width=1),0==s.height&&(s.height=1);let r=PIXI.Matrix.TEMP_MATRIX,o=PIXI.RenderTexture.create({width:0|s.width,height:0|s.height,scaleMode:e,resolution:i});return r.tx=-s.x,r.ty=-s.y,n.ctx.render(t,o,!1,r,!!t.parent),o}var g,m,f;function y(t,e){let i,s;return a.inst(n.PXGraphics,t)&&(t=p(t)),a.inst(n.PXTexture,t)?s=t:h.vec(t)?(h.str(t[0])&&(t=n.tcached(t[0])?t.map((t=>n.tcached(t))):t.map((t=>n.assetPath(t)))),i=a.inst(n.PXTexture,t[0])?new n.PXASprite(t):n.PXASprite.fromImages(t)):h.str(t)&&(s=n.tcached(t)||n.PXTexture.from(n.assetPath(t))),s&&(i=e(s)),a.assert(i,`SpriteError: ${t} not found`)&&i}function x(t,e,i,s,n,r){let o=e,a=t,h=[];for(let e,l,d,c=0;c<i;++c){d=[];for(let t=0;t<s;++t)l=o+r,e=a+n,d.push({x1:a,x2:e,y1:o,y2:l}),a=e;o=l,a=t,h.push(d)}return h}function v(t,e,i){let s,r;return e&&e.m5&&e.m5.stage?r={x1:0,y1:0,x2:n.width,y2:n.height}:(void 0!==e.angle&&a.assert(a.feq0(e.angle),"expected non rotated object"),s=e.parent,r=t.getAABB(e)),i&&s===i&&(r.x1+=i.x,r.x2+=i.x,r.y1+=i.y,r.y2+=i.y),[r,o.ndiv(r.x2-r.x1,2),o.ndiv(r.y2-r.y1,2),o.ndiv(r.x1+r.x2,2),o.ndiv(r.y1+r.y2,2)]}function w(t,e,i){if(e.m5.static)r.sub$(t.m5.vel,r.mul(i.overlapN,2*r.dot(t.m5.vel,i.overlapN)));else{let s=r.mul$(r.sub(e.m5.vel,t.m5.vel),i.overlapN),n=-2*(s[0]+s[1])/(t.m5.invMass+e.m5.invMass);r.sub$(t.m5.vel,r.mul$(r.div(i.overlapN,t.m5.mass),n)),r.add$(e.m5.vel,r.mul$(r.div(i.overlapN,e.m5.mass),n))}}function b(t,e,i){let s,n=t.toBody(e),r=t.toBody(i);return s=e.m5.circle?i.m5.circle?d.hitCircleCircle(n,r):d.hitCirclePolygon(n,r):i.m5.circle?d.hitPolygonCircle(n,r):d.hitPolygonPolygon(n,r),s&&(s.A=e,s.B=i),s}g=new PIXI.Container,(m=new PIXI.Graphics).clear(),m.beginFill(0),m.drawCircle(0,0,4),m.endFill(),f=new PIXI.Sprite(p(m)),["m5","tiled","remove","collideXY","onTick","getGuid","getBBox","getSpatial"].forEach((t=>{[[g,"Container"],[m,"Graphics"],[f,"Sprite"]].forEach((e=>{a.assertNot(a.has(e[0],t),`PIXI ${e[1]} has ${t} property!`)}))})),a.inject(n,{PXMatrix:PIXI.Matrix.TEMP_MATRIX,PXRTexture:PIXI.RenderTexture,PXRect:PIXI.Rectangle,PXBText:PIXI.BitmapText,PXSprite:PIXI.Sprite,PXGraphics:PIXI.Graphics,PXText:PIXI.Text,PXTSprite:PIXI.TilingSprite,PXASprite:PIXI.AnimatedSprite,PXPContainer:PIXI.ParticleContainer});const I={SomeColors:{},BtnColors:{},Geo:d,assets:["boot/unscii.fnt","boot/doki.fnt","boot/BIG_SHOUT_BOB.fnt","boot/splash.jpg","boot/trail.png","boot/star.png"],assertCenter:t=>a.assert(t.anchor&&a.feq(t.anchor.x,.5)&&a.feq(t.anchor.y,.5),"not center'ed"),empty:t=>0==t.children.length,btnPress(t,e,i,s,r){let o=this;return function(t){t.tint=o.color(e),s&&n.sound(s).play(),a.delay(343,(()=>{t.tint=o.color(i),r(t)}))}},oneOffClick(t,e){let i=function(){n.Input.off(["single.tap"],i),e&&n.sound(e).play(),t()};return n.Input.on(["single.tap"],i),i},sizeXY:(t,e,i)=>(h.num(i)&&(t.height=i),h.num(e)&&(t.width=e),t),asCircle:t=>(t.m5.circle=!0)&&t,scaleXY:(t,e,i)=>(h.num(e)&&(t.scale.x=e),h.num(i)&&(t.scale.y=i),t),scaleBy:(t,e,i)=>(h.num(e)&&(t.scale.x*=e),h.num(i)&&(t.scale.y*=i),t),isVX:t=>!a.feq0(t.m5.vel[0]),isVY:t=>!a.feq0(t.m5.vel[1]),halfSize:t=>({width:o.ndiv(t.width,2),height:o.ndiv(t.height,2)}),anchorXY:(t,e,i)=>(a.assert(t.anchor,"sprite has no anchor object"),t.anchor.y=a.nor(i,e),t.anchor.x=e,t),centerAnchor:t=>(t.anchor&&t.anchor.set(.5,.5),t),topLeftAnchor:t=>(t.anchor&&t.anchor.set(0,0),t),offsetXY:(t,e,i)=>(a.assert(t.anchor&&e>=0&&e<=1&&i>=0&&i<=1,"no anchor or bad target offset points"),[t.width*(e-t.anchor.x),t.height*(i-t.anchor.y)]),topLeftOffsetXY(t){return this.offsetXY(t,0,0)},centerOffsetXY(t){return this.offsetXY(t,.5,.5)},adjOffsetXY:(t,e,i)=>(a.assert(t.anchor&&e>=0&&e<=1&&i>=0&&i<=1,"no anchor or bad target offset points"),[t.width*(t.anchor.x-e),t.height*(t.anchor.y-i)]),makeSteerable(t){let e=o.ndiv(t.width,2),i=o.ndiv(t.height,2);return t.m5.steer=[0,0],t.m5.steerInfo={wanderAngle:a.rand()*Math.PI*2,arrivalThreshold:400,wanderDistance:10,wanderRadius:5,wanderRange:1,avoidDistance:400,inSightDistance:200,tooCloseDistance:60,maxForce:5,pathIndex:0},t.m5.radius=Math.sqrt(e*e+i+i),t},updateSteer:(t,e=!0)=>(t.m5.steer&&(r.clamp$(t.m5.steer,0,t.m5.steerInfo.maxForce),r.div$(t.m5.steer,t.m5.mass),r.add$(t.m5.vel,t.m5.steer),e&&r.mul$(t.m5.steer,0)),t),clrSpatial:t=>(t&&t.m5&&t.m5.sgrid&&(t.m5.sgrid.x1=e,t.m5.sgrid.x2=e,t.m5.sgrid.y1=e,t.m5.sgrid.y2=e),t),lift(t){if(!t.m5){let e=this;t.g={},t.m5={uuid:`s${a.nextId()}`,circle:!1,stage:!1,drag:!1,dead:!1,angVel:0,friction:r.vec(1,1),gravity:r.vec(),vel:r.vec(),acc:r.vec(),static:!1,sensor:!1,sgrid:{},mass:1,type:0,cmask:0,speed:0,heading:n.RIGHT,get invMass(){return a.feq0(t.m5.mass)?0:1/t.m5.mass}},t.m5.resize=function(i,s,n,r){e.resize(t,i,s,n,r)},t.m5.getImageOffsets=function(){return{x1:0,x2:0,y1:0,y2:0}},t.m5.getContactPoints=function(){return function(t,e,i){let s=[r.vec(e,i),r.vec(e,0),r.vec(0,0),r.vec(0,i)];return t&&s.forEach((s=>{s[0]-=u(e*t.x),s[1]-=u(i*t.y)})),s}(t.anchor,t.width,t.height)},t.getGuid=function(){return t.m5.uuid},t.getSpatial=function(){return t.m5.sgrid},t.getBBox=function(){return a.feq0(t.angle)?e.getAABB(t):e.boundingBox(t)}}return t},clamp2Pi:t=>(t.rotation>c&&(t.rotation-=c),t.rotation<0&&(t.rotation+=c),t),getHeading:t=>[Math.cos(t.rotation),Math.sin(t.rotation)],setOrient:(t,e,i=!1)=>(i?t.angle=e:t.rotation=e,t),toPolygon:t=>new d.Polygon(t.m5.getContactPoints()).setOrient(t.rotation),toCircle(t){return this.assertCenter(t)&&new d.Circle(o.ndiv(t.width,2)).setOrient(t.rotation)},toBody(t){let e=t.x,i=t.y,s=t.m5.circle?this.toCircle(t):this.toPolygon(t);return d.bodyWrap(s,e,i)},gposXY(t){const{x:e,y:i}=t.getGlobalPosition();return r.vec(e,i)},isTopLeft:t=>!t.anchor||a.feq0(t.anchor.x)&&a.feq0(t.anchor.y),isCenter:t=>!!t.anchor&&(a.feq(t.anchor.x,.5)&&a.feq(t.anchor.y,.5)),centerXY(t){return this.isCenter(t)?r.vec(t.x,t.y):r.add(this.centerOffsetXY(t),t)},setScaleModeNearest:(t,e)=>(t.texture.baseTexture.scaleMode=e?PIXI.SCALE_MODES.NEAREST:PIXI.SCALE_MODES.LINEAR,t),angle(t,e){return r.angle(this.centerXY(t),this.centerXY(e))},die:t=>(t&&(t.m5.dead=!0),t),undie:t=>(t&&(t.m5.dead=!1),t),move:(t,e)=>(e?(r.add$(t.m5.vel,r.mul(t.m5.gravity,e)),r.add$(t.m5.vel,r.mul(t.m5.acc,e)),r.mul$(t.m5.vel,t.m5.friction)):e=1,void 0!==t.m5.maxSpeed&&r.clamp$(t.m5.vel,0,t.m5.maxSpeed),r.add$(t,r.mul(t.m5.vel,e))),leftSide(t){let e=t.x,i=t.width,s=t.anchor?t.anchor.x:0;return s>.7?e-=i:s>0&&(e-=o.ndiv(i,2)),e},rightSide(t){return this.leftSide(t)+t.width},topSide(t){let e=t.y,i=t.height,s=t.anchor?t.anchor.y:0;return s>.7?e-=i:s>0&&(e-=o.ndiv(i,2)),e},bottomSide(t){return this.topSide(t)+t.height},getAABB(t){if(void 0!==t.x1&&void 0!==t.y2)return t;a.assert(t.m5,"bad sprite for getAABB");let{x1:e,y1:i,x2:s,y2:n}=t.m5.getImageOffsets(),r=this.leftSide(t),o=this.topSide(t);return{x1:r+e,y1:o+i,x2:r+t.width-s,y2:o+t.height-n}},bbox4:(t,e,i,s)=>a.assert(i<=s,"bad bbox")&&{x1:t,x2:e,y1:i,y2:s},bboxCenter(t){if(h.num(t.x1))return r.vec(o.ndiv(t.x1+t.x2,2),o.ndiv(t.y1+t.y2,2))},bboxFrame(t,e=16,i="#dedede"){let s,{x1:n,x2:r,y1:a,y2:h}=t,l=r-n,d=h-a,c=this.graphics();return c.lineStyle(e,this.color(i)),c.drawRoundedRect(0,0,l+e,d+e,o.ndiv(e,4)),s=this.sprite(c),s.x=n-e,s.y=a-e,s},bboxSize:t=>r.vec(t.x2-t.x1,t.y2-t.y1),pointInBBox:(t,e,i)=>t>i.x1&&t<i.x2&&e>i.y1&&e<i.y2,boundingBox(t){let e,i,s=[],n=[],r=o.ndiv(t.width,2),h=o.ndiv(t.height,2),l=Math.tanh(h/r),d=Math.sqrt(r*r+h*h);return a.feq0(t.rotation)||a.assert(this.isCenter(t),"expected rotated obj with center-anchor"),i=c-l+t.rotation,n.push(d*Math.sin(i)),s.push(d*Math.cos(i)),i=l+t.rotation,n.push(d*Math.sin(i)),s.push(d*Math.cos(i)),i=Math.PI-l+t.rotation,n.push(d*Math.sin(i)),s.push(d*Math.cos(i)),i=Math.PI+l+t.rotation,n.push(d*Math.sin(i)),s.push(d*Math.cos(i)),e=this.centerXY(t),n.sort(((t,e)=>t-e)),s.sort(((t,e)=>t-e)),{x1:u(s[0]+e[0]),x2:u(s[3]+e[0]),y1:u(n[0]+e[1]),y2:u(n[3]+e[1])}},hitTestPoint(t,e,i){let s=this.toBody(i);return i.m5.circle?d.hitTestPointCircle(t,e,s):d.hitTestPointPolygon(t,e,s)},distance(t,e){return r.dist(this.centerXY(t),this.centerXY(e))},scaleContent(...t){1==t.length&&h.vec(t[0])&&(t=t[0]);let e=n.getScaleFactor();t.forEach((t=>{t.scale.x*=e,t.scale.y*=e}))},scaleToCanvas:t=>(t.height=n.height,t.width=n.width,t),uuid:(t,e)=>(t.m5.uuid=e,t),opacity:(t,e)=>(t.alpha=e,t),tint:(t,e)=>(t.tint=e,t),hide:t=>(t.visible=!1,t),show:t=>(t.visible=!0,t),pset:(t,e,i)=>(t.g[e]=i,t),pget:(t,e)=>t.g[e],container(t){let e=new n.PXContainer;return e=this.lift(e),t&&t(e),e},group(...t){let e=this.container();return t.forEach((t=>e.addChild(t))),e},sprite(t,e=!1,i=0,s=0){let o=y(t,(t=>new n.PXSprite(t)));return o=this.lift(o),r.set(o,i,s),e&&this.centerAnchor(o),a.inst(n.PXASprite,o)?function(t){let e=0,i={};function s(){e&&(e=clearInterval(e))}function r(){i.cnt<i.total?(t.gotoAndStop(t.currentFrame+1),i.cnt+=1):t.loop?(t.gotoAndStop(i.start),i.cnt=1):(s(),t.onComplete&&t.onComplete())}return a.inject(t.m5,{stopFrames(){s(),t.gotoAndStop(t.currentFrame)},showFrame(e){s(),t.gotoAndStop(e)},playFrames(o){s(),i.start=0,i.end=t.totalFrames-1,h.vec(o)&&o.length>1&&(i.start=o[0],i.end=o[1]),i.total=i.end-i.start+1,t.gotoAndStop(i.start),i.cnt=1,e=setInterval(r,1e3/n.aniFps)}}),t}(o):o},tilingSprite(t,e,i){return this.lift(y(t,(t=>new n.PXTSprite(t,e||t.width,i||t.height))))},repeatSprite(t,e=!0,i=!0,s,o){let a,h=()=>{let e=this.lift(y(t,(t=>new n.PXSprite(t)))),i=n.getScaleFactor();return i=1,e.width*=1,e.height*=1,e},l=[],d=0,c=0,u=0,p=0;if(e){for(;u<s;)l.push(a=h()),r.set(a,d,c),u+=a.width,d+=a.width,u>=s&&p<o&&i&&(p+=a.height,c+=a.height,d=0,u=0);i=!1}if(i){for(;p<o;)l.push(a=h()),r.set(a,d,c),p+=a.height,c+=a.height,p>=o&&u<s&&e&&(u+=a.width,d+=a.width,d=c,u=p);e=!1}return l},animation(t,e,i,s=0){let a=n.tcached(t);if(!a)throw`SpriteError: ${t} not loaded.`;let h=o.ndiv(a.width,e),l=[],d=h*o.ndiv(a.height,i);for(let t,n,a=0;a<d;++a)t=a%h*e,n=o.ndiv(a,h)*i,s>0&&(t+=s+s*a%h,n+=s+s*o.ndiv(a,h)),l.push(r.vec(t,n));return this.sprite(l.map((t=>new n.PXTexture(a.baseTexture,new n.PXRect(t[0],t[1],e,i)))))},frame(t,e,i,s,r){return this.sprite(new n.PXTexture(n.tcached(t).baseTexture,new n.PXRect(s,r,e,i)))},frameSelect:(t,e,i,s)=>s.map((s=>new n.PXTexture(n.tcached(t).baseTexture,new n.PXRect(s[0],s[1],e,i)))),frames(t,e,i,s=0,r=0,a=0,h=0){let l=n.tcached(t),d=e+s,c=i+r,u=[],p=o.ndiv(l.height,c),g=o.ndiv(l.width+s,d);for(let t,s=0;s<p;++s){t=h+i*s;for(let s,r=0;r<g;++r)s=a+e*r,u.push(new n.PXTexture(l.baseTexture,new n.PXRect(s,t,e,i)))}return u},frameImages:(...t)=>(1==t.length&&h.vec(t[0])&&(t=t[0]),t.map((t=>n.tcached(t)))),spriteFrom(...t){return this.sprite(this.frameImages(...t))},text(t,e,i=0,s=0){return r.set(this.lift(new n.PXText(t,e)),i,s)},bitmapText(t,e,i){let s;return h.str(e)?(s={fontName:e},h.num(i)&&(s.fontSize=i)):s=e,s.fill&&(s.tint=this.color(s.fill)),s.fontName||(s.fontName="unscii"),s.align||(s.align="center"),this.lift(new n.PXBText(t,s))},triangle(t,e,i,s=16777215,a=16777215,l=0,d=0,c=0){let u=this.graphics(),p=1,g=o.ndiv(t,2),m=this.color(a),f=i<.5?0:i>.5?t:g,y=[{x:0,y:0},{x:f,y:-e},{x:t,y:0},{x:0,y:0}];!1!==s&&(h.vec(s)&&(p=s[1],s=s[0]),u.beginFill(this.color(s),p)),l>0&&u.lineStyle(l,m,1),u.drawPolygon(...y),!1!==s&&u.endFill();let x=new n.PXSprite(this.genTexture(u));return x=this.lift(x),x.m5.getContactPoints=e<0?()=>[[f,-e],[t,0],[0,0]]:()=>[[t,e],[f,0],[0,e]],r.set(x,d,c)},rect(t,e,i=16777215,s=16777215,n=0){return this.rectEx(this.rectTexture(t,e,i,s,n))},rectTexture(t,e,i=16777215,s=16777215,n=0){let r,o=this.graphics();return!1!==i&&(h.vec(i)?(r=i[1],i=i[0]):r=1,o.beginFill(this.color(i),r)),n>0&&o.lineStyle(n,this.color(s)),o.drawRect(0,0,t,e),!1!==i&&o.endFill(),this.genTexture(o)},rectEx(t){return this.lift(new n.PXSprite(t))},drawBody(t,...e){let i=this.graphics();return t.apply(this,[i].concat(e)),this.lift(new n.PXSprite(this.genTexture(i)))},circle(t,e=16777215,i=16777215,s=0){return this.circleEx(this.circleTexture(t,e,i,s))},circleTexture(t,e=16777215,i=16777215,s=0){let n,r=this.graphics();return!1!==e&&(h.vec(e)?(n=e[1],e=e[0]):n=1,r.beginFill(this.color(e),n)),s>0&&r.lineStyle(s,this.color(i)),r.drawCircle(0,0,t),!1!==e&&r.endFill(),this.genTexture(r)},circleEx(t){let e=new n.PXSprite(t);return e=this.lift(e),(e.m5.circle=!0)&&this.centerAnchor(e)},line(t,e,i,s){let n,o=r.clone(i),h=r.clone(s),l=this.graphics(),d=this.color(t);function c(){l.clear(),l.lineStyle(e,d,1),l.moveTo(o[0],o[1]),l.lineTo(h[0],h[1])}return c(),n=this.lift(l),n.m5.ptA=function(t,e){return void 0!==t&&(o[0]=t,o[1]=a.nor(e,t),c()),o},n.m5.ptB=function(t,e){return void 0!==t&&(h[0]=t,h[1]=a.nor(e,t),c()),h},n},isMoving:t=>!a.feq0(t.m5.vel[0])||!a.feq0(t.m5.vel[1]),makeCells(t,e,i,s,n,r){let a=o.ndiv(i-t,n);return x(t,e,o.ndiv(s-t,r),a,n,r)},gridBox(t=.9,e=.9,i){let s=a.nor(i,n),r=u(s.height*e),h=u(s.width*t),l=o.ndiv(s.width-h,2),d=o.ndiv(s.height-r,2);return{x1:l,y1:d,x2:l+h,y2:d+r}},gridSQ(t,e=.6,i){let s=e*(n.height<n.width?n.height:n.width),r=o.ndiv(s,t),h=r;a.isEven(r)||--r,h=r,s=t*r;let l=o.ndiv(n.height-s,2),d=o.ndiv(n.width-s,2),c=d,u=l;return i&&(i.height=s,i.width=s,void 0!==i.x&&(c=i.x),void 0!==i.y&&(u=i.y),i.x=d,i.y=l,i.x1=d,i.y1=l,i.x2=d+s,i.y2=l+s),x(c,u,t,t,r,h)},divXY([t,e],i=.9,s=.9,r){let a,h,l,d,c=u(n.height*s),p=u(n.width*i),g=o.ndiv(p,t),m=o.ndiv(c,e);return c=e*m,p=t*g,l=o.ndiv(n.height-c,2),d=o.ndiv(n.width-p,2),a=d,h=l,r&&(r.height=c,r.width=p,void 0!==r.x&&(a=r.x),void 0!==r.y&&(h=r.y),r.x=d,r.y=l,r.x1=d,r.y1=l,r.x2=d+p,r.y2=l+c),x(a,h,e,t,g,m)},gridXY([t,e],i=.9,s=.9,r){let h,l,d,c,p=u(n.height*s),g=u(n.width*i),m=o.ndiv(g,t),f=o.ndiv(p,e),y=m>f?f:m;return a.isEven(y)||y--,p=e*y,g=t*y,d=o.ndiv(n.height-p,2),c=o.ndiv(n.width-g,2),h=c,l=d,r&&(r.height=p,r.width=g,void 0!==r.x&&(h=r.x),void 0!==r.y&&(l=r.y),r.x=c,r.y=d,r.x1=c,r.y1=d,r.x2=c+g,r.y2=d+p),x(h,l,e,t,y,y)},gridBBox(t,e,i){let s=i[0].length,n=i[0][0],r=i[i.length-1][s-1];return{x1:t+n.x1,x2:t+r.x2,y1:e+n.y1,y2:e+r.y2}},graphics(t){let e=new n.PXGraphics;return(e.m5={uuid:`${t||a.nextId()}`})&&e},drawGridBox(t,e=1,i="white",s){return s||(s=this.graphics()),s.lineStyle(e,this.color(i)),s.drawRect(t.x1,t.y1,t.x2-t.x1,t.y2-t.y1),s},drawGridBoxEx(t,e=1,i="white",s=1,n){return n||(n=this.graphics()),n.lineStyle(e,this.color(i)),n.drawRoundedRect(t.x1,t.y1,t.x2-t.x1,t.y2-t.y1,s),n},drawGridLines(t,e,i,s,n,r){let o=i.length,a=i[0].length;r||(r=this.graphics()),h.obj(n)?(n.color=this.color(n.color||"white"),n.width=s,r.lineStyle(n)):r.lineStyle(s,this.color(n));for(let s,n=1;n<o;++n)s=i[n],r.moveTo(t+s[0].x1,e+s[0].y1),r.lineTo(t+s[a-1].x2,e+s[a-1].y1);for(let s,n=1;n<a;++n)s=i[0],r.moveTo(t+s[n].x1,e+s[n].y1),s=i[o-1],r.lineTo(t+s[n].x1,e+s[n].y2);return r},add:(t,...e)=>(e.forEach((e=>e&&t.addChild(e))),t),remove:(...t)=>(1==t.length&&h.vec(t[0])&&(t=t[0]),a.doseqEx(t,(t=>{t.parent&&(a.inst(n.Scenes.Scene,t.parent)?t.parent.remove(t):t.parent.removeChild(t)),n.emit(["post.remove",t]),n.off(t),t.m5.dispose&&t.m5.dispose()})),t[0]),centerObj:t=>(t.x=n.width/2,t.y=n.height/2,t.anchor.x<.3?(t.x-=t.width/2,t.y-=t.height/2):t.anchor.x<.7||a.assert(!1,"bad anchor to center"),t),fillMax:t=>(t.anchor&&a.assert(t.anchor.x<.3,"wanted top left anchor"),t.height=n.height,t.width=n.width,t.x=0,t.y=0,t),colorToRgbA(t){if(!t||!h.str(t)||0==t.length)return;let e=t.toLowerCase(),i=s[e];if(i&&(t=i),"#"==t[0])return t.length<7&&(t=`#${t[1]}${t[1]}${t[2]}${t[2]}${t[3]}${t[3]}${t.length>4?t[4]+t[4]:""}`),[parseInt(t.substr(1,2),16),parseInt(t.substr(3,2),16),parseInt(t.substr(5,2),16),t.length>7?parseInt(t.substr(7,2),16)/255:1];if("transparent"==e)return[0,0,0,0];if(0==e.indexOf("rgb"))return e.indexOf("rgba")<0&&(e+=",1"),e.match(/[\.\d]+/g).map((t=>+t));throw`Error: Bad color: ${t}`},byteToHex:t=>("0"+t.toString(16)).slice(-2),colorToHex(t){const e=this.colorToRgbA(t);return"0x"+[0,1,2].map((t=>this.byteToHex(e[t]))).join("")},color3(t,e,i){return parseInt(["0x",this.byteToHex(t),this.byteToHex(e),this.byteToHex(i)].join(""))},color(t){return isNaN(t)?parseInt(this.colorToHex(t)):t},rgba(t){return a.assert(h.vec(t),"wanted rgba array"),parseInt("0x"+[0,1,2].map((e=>this.byteToHex(t[e]))).join(""))},hsla(t,e,i,s){function n(t){return Math.min(1,Math.max(0,t))}function r(t){return 6*(t=t<0?t+1:t>1?t-1:t)<1?a+(o-a)*t*6:2*t<1?o:3*t<2?a+(o-a)*(2/3-t)*6:a}t=t%360/360,e=n(e),i=n(i),s=n(s);let o=i<=.5?i*(e+1):i+e-i*e,a=2*i-o;return this.rgba([255*r(t+1/3),255*r(t),255*r(t-1/3),s])},resize(t,e,i,s,n){t&&a.doseqEx(t.children,(e=>e.m5&&e.m5.resize&&e.m5.resize(t.x,t.y,t.width,t.height)))},pinAbove(t,e,i=10,s=.5){let[n,o,a,h,l]=v(this,t),[d,c,u,p,g]=v(this,e,t),m=n.y1-i-(d.y2-d.y1),f=s<.3?n.x1:s<.7?h-c:n.x2-(d.x2-d.x1);e.y=!e.anchor||e.anchor.y<.3?m:e.anchor.y<.7?m+u:m+(d.y2-d.y1),e.x=!e.anchor||e.anchor.x<.3?f:e.anchor.x<.7?f+c:f+(d.x2-d.x1),e.parent===t&&r.sub$(e,t)},pinBelow(t,e,i=10,s=.5){let[n,o,a,h,l]=v(this,t),[d,c,u,p,g]=v(this,e,t),m=n.y2+i,f=s<.3?n.x1:s<.7?h-c:n.x2-(d.x2-d.x1);e.y=!e.anchor||e.anchor.y<.3?m:e.anchor.y<.7?m+u:m+(d.y2-d.y1),e.x=!e.anchor||e.anchor.x<.3?f:e.anchor.x<.7?f+c:f+(d.x2-d.x1),e.parent===t&&r.sub$(e,t)},pinCenter(t,e){let[i,s,n,o,a]=v(this,t),[h,l,d,c,u]=v(this,e,t),p=o-l,g=a-d;e.y=!e.anchor||e.anchor.y<.3?g:e.anchor.y<.7?g+d:g+(h.y2-h.y1),e.x=!e.anchor||e.anchor.x<.3?p:e.anchor.x<.7?p+l:p+(h.x2-h.x1),(t.m5.stage||e.parent===t)&&r.sub$(e,t)},pinLeft(t,e,i=10,s=.5){let[n,o,a,h,l]=v(this,t),[d,c,u,p,g]=v(this,e,t),m=n.x1-i-(d.x2-d.x1),f=s<.3?n.y1:s<.7?l-u:n.y2-(d.y2-d.y1);e.y=!e.anchor||e.anchor.y<.3?f:e.anchor.y<.7?f+u:f+(d.y2-d.y1),e.x=!e.anchor||e.anchor.x<.3?m:e.anchor.x<.7?m+c:m+(d.x2-d.x1),e.parent===t&&r.sub$(e,t)},pinRight(t,e,i=10,s=.5){let[n,o,a,h,l]=v(this,t),[d,c,u,p,g]=v(this,e,t),m=n.x2+i,f=s<.3?n.y1:s<.7?l-u:n.y2-(d.y2-d.y1);e.y=!e.anchor||e.anchor.y<.3?f:e.anchor.y<.7?f+u:f+(d.y2-d.y1),e.x=!e.anchor||e.anchor.x<.3?m:e.anchor.x<.7?m+c:m+(d.x2-d.x1),e.parent===t&&r.sub$(e,t)},setMass(t,e){t.m5.mass=e},genTexture:(t,e,i,s)=>p(t,e,i,s),bounceOff:t=>w(t.A,t.B,t),hit(t,e){const i=b(this,t,e);return i&&(n.emit(["hit",t],i),n.emit(["hit",e],i.swap())),i},collide(t,e,i=!0){const s=function(t,e,i,s=!0){let n,o=b(t,e,i);return o&&(i.m5.static?r.sub$(e,o.overlapV):(n=r.div(o.overlapV,2),r.sub$(e,n),r.add$(i,n)),s&&w(e,i,o)),o}(this,t,e,i);return s&&function(t){const e=new Set;return t.overlapN[1]<-.3&&e.add(n.TOP),t.overlapN[1]>.3&&e.add(n.BOTTOM),t.overlapN[0]<-.3&&e.add(n.LEFT),t.overlapN[0]>.3&&e.add(n.RIGHT),e.add(t),e}(s)},hitTest(t,e){return b(this,t,e)},clamp(t,i,s=!1,r){let o,l,d,c,u,p;h.vec(i)&&(d=i[1].left,c=i[1].right,u=i[1].top,p=i[1].bottom,i=i[0]),c=!1!==c,d=!1!==d,u=!1!==u,p=!1!==p,i instanceof n.Scenes.Scene?l=n.mockStage():i.m5&&i.m5.stage?l=i:void 0!==i.x2&&void 0!==i.y2?(l=i,o=!0):(i.isSprite?a.assert(t.parent===i):a.assert(!1,"Error: clamp() using bad container"),a.assert(a.feq0(i.rotation),"Error: clamp() container can't rotate"),a.assert(a.feq0(i.anchor.x),"Error: clamp() container anchor.x !==0"),a.assert(a.feq0(i.anchor.y),"Error: clamp() container anchor.y !==0"),l=i);let g=o?[0,0]:this.topLeftOffsetXY(l),m=new Set,f=!1,y=!1,x=this.getAABB(t),v=o?l.x1:l.x+g[0],w=v+(o?l.x2-l.x1:l.width),b=o?l.y1:l.y+g[1],I=b+(o?l.y2-l.y1:l.height);return d&&x.x1<v&&(t.x+=v-x.x1,f=!0,m.add(n.LEFT)),c&&x.x2>w&&(t.x-=x.x2-w,f=!0,m.add(n.RIGHT)),u&&x.y1<b&&(t.y+=b-x.y1,y=!0,m.add(n.TOP)),p&&x.y2>I&&(t.y-=x.y2-I,y=!0,m.add(n.BOTTOM)),m.size>0?(f&&(t.m5.vel[0]/=t.m5.mass,s&&(t.m5.vel[0]*=-1)),y&&(t.m5.vel[1]/=t.m5.mass,s&&(t.m5.vel[1]*=-1)),r&&r(m)):m=e,m},dbgShowDir(t){let e="?";switch(t){case n.NE:e="top-right";break;case n.NW:e="top-left";break;case n.TOP:case n.UP:e="top";break;case n.LEFT:e="left";break;case n.RIGHT:e="right";break;case n.BOTTOM:case n.DOWN:e="bottom";break;case n.SE:e="bottom-right";break;case n.SW:e="bottom-left"}return e},dbgShowCol(t){let e=[];if(h.set(t))for(let i of t.values())e.push(this.dbgShowDir(i));return e.join(",")}};return I.bmpText=I.bitmapText,a.doseq(s,((t,e)=>{I.SomeColors[e]=I.color(t)})),a.doseq(i,((t,e)=>{I.BtnColors[e]=I.color(t)})),n.Sprites=I}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Sprites"]=function(t){return t.Sprites?t.Sprites:n(t)}}(this),function(t,e){"use strict";function i(e,i){const s=t["io/czlab/mcfud/spatial"](),{v2:n,math:r,ute:o,is:a}=e,h=(Math.floor,t=>t.startsWith("scene::")?t:`scene::${t}`);function l(t){t&&(t.dispose&&t.dispose(),t.parent.removeChild(t))}class d extends e.PXContainer{constructor(t){super(),this.addChild(t),this.name=t.name,this.m5={stage:!0}}dispose(){l(this.children[0])}update(t){this.children[0].update(t)}}class c extends e.PXContainer{constructor(t,e,i){let n;super(),this.name=h(t),this.g={},this.m5={index:{},queue:[],garbo:[],sid:t,options:i,stage:!0,sgrid:s.spatialGrid(i.sgridX||320,i.sgridY||320)},a.fun(e)?n=e:a.obj(e)&&(n=o.dissoc(e,"setup"),o.inject(this,e)),n&&(this.m5.setup=n.bind(this))}_hitObjects(t,i,s,n=1){for(let r,o,a=0;a<s.length&&(o=s[a],!(i!==o&&!o.m5.dead&&i.m5.cmask&o.m5.type&&(r=e.Sprites.hitTest(i,o),r&&(e.emit(["hit",i],r),r.B.m5.static||e.emit(["hit",r.B],r.swap()),t.engrid(i),0==--n))));++a);}collideXY(t){this._hitObjects(this.m5.sgrid,t,this.m5.sgrid.search(t))}onCanvasResize([t,i]){e.Sprites.resize({x:0,y:0,width:t,height:i,children:this.children})}future(t,i){this.m5.queue.push([t,r.ndiv(e._curFPS*i,1e3)||1])}futureX(t,e){this.m5.queue.push([t,e||1])}getChildById(t){return t&&this.m5.index[t]}remove(t){a.str(t)&&(t=this.getChildById(t)),t&&(this.removeChild(t),e.off(t),t.m5._engrid&&this.m5.sgrid.degrid(t),e.Input.undoXXX(t),o.dissoc(this.m5.index,t.m5.uuid))}degrid(t){return t&&t.m5._engrid&&this.m5.sgrid.degrid(t),t}engrid(t){return t&&t.m5._engrid&&this.m5.sgrid.engrid(t),t}insert(t,e=!1){return this.insertAt(t,null,e)}insertAt(t,e,i=!1){return t=this._addit(t,e),i&&(t instanceof PIXI.TilingSprite||(t.m5._engrid=!0,this.m5.sgrid.engrid(t))),t}_addit(t,e){return a.num(e)&&e>=0&&e<this.children.length?this.addChildAt(t,e):this.addChild(t),this.m5.index[t.m5.uuid]=t}dispose(){this.m5.dead=!0,e.off(this),function t(i){i&&(e.Input.undoXXX(i),i.children.forEach((e=>t(e))))}(this),this.removeChildren(),e.modalScene===this&&(e.modalScene=undefined,e.Input.restore(),e.CON.log("removed the current modal scene"))}_tick(t,i){t.forEach((t=>{t.visible&&t.m5&&t.m5.tick&&(t.m5.tick(i),"x"==t.m5.flip&&(t.scale.x*=-1),"y"==t.m5.flip&&(t.scale.y*=-1),t.m5.flip=!1,e.emit(["post.tick",t],i),t.m5._engrid&&this.m5.sgrid.engrid(t)),t.children.length>0&&this._tick(t.children,i)}))}searchSGrid(t,e=!1){return this.m5.sgrid.search(t,e)}queueForRemoval(t){return this.m5.garbo.push(t)&&t}update(t){this.m5.dead||(this.m5.queue.filter((t=>(t[1]-=1,t[1]<=0))).reverse().forEach((t=>{o.disj(this.m5.queue,t),t[0]()})),this.preUpdate&&this.preUpdate(t),this._tick(this.children,t),this.postUpdate&&this.postUpdate(t),this.m5.garbo.forEach((t=>this.remove(t))),this.m5.garbo.length=0)}runOnce(){return this.m5.setup&&(this.m5.setup(this.m5.options),delete this.m5.setup),this}}function u(t,i,s){if(0==t.length)return;let n,h,{Sprites:l}=e,d=e.getScaleFactor(),c=(i=o.patch(i,{bg:0,padding:10,fit:20,borderWidth:4,border:l.SomeColors.white})).borderWidth*d,u=i.group||l.container(),p=i.padding*d,g=0,m=-1,f=i.fit*d,y=2*f,x=t=>{g+=t.height,t.width>m&&(m=t.width)},v=t=>{g+=t.width,t.height>m&&(m=t.height)};t.forEach((t=>{o.assert(o.feq0(t.anchor.x)&&o.feq0(t.anchor.y),"wanted topleft anchor"),(s==e.DOWN?x:v)(t),i.skipAdd||u.addChild(t)})),m+=y,g+=p*(t.length-1)+y,s==e.DOWN?(n=m,h=g):(h=m,n=g);{let t=l.rect(n,h,i.bg,i.border,c);u.addChildAt(t,0),a.vec(i.bg)||(t.alpha=0==i.opacity?0:i.opacity||.5,"transparent"==i.bg&&(t.alpha=0))}let w,[b,I]=[r.ndiv(n,2),r.ndiv(h,2)],T=s==e.DOWN?"pinBelow":"pinRight";return t.forEach(((t,i)=>{s==e.DOWN?0==i&&(t.x=b-t.width/2,t.y=f):0==i&&(t.y=I-t.height/2,t.x=f),w&&e.Sprites[T](w,t,p),w=t})),u.x=o.nor(i.x,r.ndiv(e.width-n,2)),u.y=o.nor(i.y,r.ndiv(e.height-h,2)),u}function p(t,i,s){let n,r,{Sprites:a,Input:h}=e,l=a.color(o.nor(i.selectedColor,"green")),d=a.color(o.nor(i.disabledColor,"grey"));return t.forEach((t=>{t.m5.uuid==i.defaultChoice?(r=t,t.tint=l):t.tint=d,t.m5.button&&(t.m5.press=t=>{t!==r&&(r.tint=d,t.tint=l,r=t,i.onClick&&i.onClick(t))})})),r||(r=t[0],r.tint=l),n=u(t,i,s),n.getSelectedChoice=()=>r.m5.uuid,n}const g={Scene:c,SceneWrapper:d,layoutX:(t,i)=>u(t,i,e.RIGHT),layoutY:(t,i)=>u(t,i,e.DOWN),choiceMenuX:(t,i)=>p(t,i,e.RIGHT),choiceMenuY:(t,i)=>p(t,i,e.DOWN),scene(t,e,s){a.fun(e)&&(e={setup:e}),i[t]=[e,s]},replace(t,i,s){const n=h(a.str(t)?t:t.name),r=e.stage.getChildByName(n);if(!r)throw`Fatal: no such scene: ${n}`;return this.run(i,e.stage.getChildIndex(r),s)},remove(...t){1==t.length&&a.vec(t[0])&&(t=t[0]),t.forEach((t=>l(a.str(t)?e.stage.getChildByName(h(t)):t)))},removeAll(){for(;e.stage.children.length>0;)l(e.stage.children[e.stage.children.length-1]);e.mouse.reset(),e.Input.reset()},find:t=>e.stage.getChildByName(h(t)),runEx(t,e,i){this.removeAll(),this.run(t,e,i)},runSeq(...t){t.forEach((t=>{o.assert(a.vec(t),"Expecting array"),this.run(t[0],t[1],t[2])}))},modal(t,i){return e.Input.save(),e.modalScene=this.run(t,null,i)},run(t,s,n){let r,h,u,p=i[t];if(e.modalScene)throw"Fatal: modal scene is running";if(!p)throw`Fatal: unknown scene: ${t}`;if(a.obj(s)&&(n=s,s=o.dissoc(n,"slot")),n=o.inject({},p[1],n),u=o.inject({},p[0]),o.nichts(s)&&(s=n.slot||-1),n.tiled?(o.assert(n.tiled.name,"no tmx file!"),h=new e.Tiles.TiledScene(t,u,n)):h=new c(t,u,n),r=h,n.centerStage&&(r=new d(h)),s>=0&&s<e.stage.children.length){let t=e.stage.getChildAt(s);e.stage.addChildAt(r,s),l(t)}else e.stage.addChild(r);return h.runOnce(),h},topMost(){let t=o.last(e.stage.children);return t instanceof d&&(t=t.children[0]),o.assert(t instanceof c,"top is not a scene!"),t}};return e.Scenes=g}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Scenes"]=function(t){return t.Scenes?t.Scenes:i(t,{})}}(this),function(t,e){"use strict";function i(t,i,s){const{v2:n,math:r,ute:o,is:a,Sprites:h}=t,l=(Math.floor,5*Math.PI),d=Math.PI/2,c=2*Math.PI;function u(e,s,n=60,r=!1,h={}){return o.inject({duration:n,sprite:e,easing:s,loop:r,cur:0,on:0,onFrame(t,e){},_run(){this.cur=0,this.on=1,i.push(this)},onTick(){this.on&&(this.cur<this.duration?(this.onFrame(!1,this.easing(this.cur/this.duration)),this.cur+=1):(this.onFrame(!0),this.loop?(a.num(this.loop)&&--this.loop,this.onLoopReset(),this.cur=0):(this.on=0,this.dispose(),this.onComplete&&o.delay(0,(()=>this.onComplete())))))},dispose(){o.disj(i,this),t.emit(["tween.disposed"],this)}},h)}function p(t,i,s,n){return u(t,i,s,n,{start(t,i,s,n){this._x=a.num(i)?[t,i]:e,this._y=a.num(n)?[s,n]:e,this._run()},onLoopReset(){this._x&&o.swap(this._x,0,1),this._y&&o.swap(this._y,0,1)},onFrame(t,e){this._x&&(this.sprite.x=t?this._x[1]:r.lerp(this._x[0],this._x[1],e)),this._y&&(this.sprite.y=t?this._y[1]:r.lerp(this._y[0],this._y[1],e))}})}function g(...e){let i=[];e.forEach((t=>{i.push(t)}));const s={onTweenEnd(t){for(let e,s=0;s<i.length;++s)if(e=i[s],e===t){i.splice(s,1);break}0==i.length&&(this.dispose(),this.onComplete&&o.delay(0,(()=>this.onComplete())))},dispose(){t.off(["tween.disposed"],"onTweenEnd",s),i.length=0}};return t.on(["tween.disposed"],"onTweenEnd",s),s}const m={EXPO_IN:t=>0==t?0:Math.pow(1024,t-1),EXPO_OUT:t=>1==t?1:1-Math.pow(2,-10*t),EXPO_INOUT:t=>0==t?0:1==t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1))),LINEAR:t=>t,SMOOTH:t=>3*t*t-2*t*t*t,SMOOTH_QUAD(t){let e=m.SMOOTH(t);return e*e},SMOOTH_CUBIC(t){let e=m.SMOOTH(t);return e*e*e},EASE_IN_CUBIC:t=>t*t*t,EASE_OUT_CUBIC(t){let e=1-t;return 1-e*e*e},EASE_INOUT_CUBIC(t){if(t<.5)return 4*t*t*t;{let e=-2*t+2;return 1-e*e*e/2}},EASE_IN_QUAD:t=>t*t,EASE_OUT_QUAD:t=>1-(1-t)*(1-t),EASE_INOUT_QUAD(t){if(t<.5)return 2*t*t;{let e=-2*t+2;return 1-e*e/2}},EASE_IN_SINE:t=>1-Math.cos(t*d),EASE_OUT_SINE:t=>Math.sin(t*d),EASE_INOUT_SINE:t=>.5-Math.cos(t*Math.PI)/2,SPLINE(t,e,i,s,n){let r=t*t,o=r*t;return.5*(e*(2*r-o-t)+i*(3*o-5*r+2)+s*(-3*o+4*r+t)+n*(o-r))},CUBIC_BEZIER(t,e,i,s,n){let r=t*t,o=1-t,a=o*o;return a*o*e+3*a*t*i+3*o*r*s+r*t*n},ELASTIC_IN:t=>0==t?0:1==t?1:-Math.pow(2,10*(t-1))*Math.sin((t-1.1)*l),ELASTIC_OUT:t=>0==t?0:1==t?1:1+Math.pow(2,-10*t)*Math.sin((t-.1)*l),ELASTIC_INOUT(t){switch(t){case 0:return 0;case 1:return 1;default:return(t*=2)<1?-.5*Math.pow(2,10*(t-1))*Math.sin((t-1.1)*l):1+.5*Math.pow(2,-10*(t-1))*Math.sin((t-1.1)*l)}},BOUNCE_IN:t=>1-m.BOUNCE_OUT(1-t),BOUNCE_OUT:t=>t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375,BOUNCE_INOUT:t=>t<.5?.5*m.BOUNCE_IN(2*t):.5*m.BOUNCE_OUT(2*t-1)+.5,tweenAlpha(t,e,i,s=60,n=!1){const h=function(t,e,i,s){return u(t,e,i,s,{start(t,e){this._a=[t,e],this._run()},onLoopReset(){o.swap(this._a,0,1)},onFrame(t,e){this.sprite.alpha=t?this._a[1]:r.lerp(this._a[0],this._a[1],e)}})}(t,e,s,n);let l=t.alpha,d=i;return a.vec(i)&&(l=i[0],d=i[1]),h.start(l,d),h},tweenAngle(t,e,i,s=60,n=!1){const h=function(t,e,i,s){return u(t,e,i,s,{start(t,e){this._a=[t,e],this._run()},onLoopReset(){o.swap(this._a,0,1)},onFrame(t,e){this.sprite.rotation=t?this._a[1]:r.lerp(this._a[0],this._a[1],e)}})}(t,e,s,n);let l=t.rotation,d=i;return a.vec(i)&&(l=i[0],d=i[1]),h.start(l,d),h},tweenScale(t,i,s,n,h=60,l=!1){const d=function(t,i,s,n){return u(t,i,s,n,{start(t,i,s,n){this._x=a.num(i)?[t,i]:e,this._y=a.num(n)?[s,n]:e,this._run()},onLoopReset(){this._x&&o.swap(this._x,0,1),this._y&&o.swap(this._y,0,1)},onFrame(t,e){this._x&&(this.sprite.scale.x=t?this._x[1]:r.lerp(this._x[0],this._x[1],e)),this._y&&(this.sprite.scale.y=t?this._y[1]:r.lerp(this._y[0],this._y[1],e))}})}(t,i,h,l);let c=t.scale.x,p=t.scale.y,g=s,m=n;return a.vec(s)&&(c=s[0],g=s[1]),a.vec(n)&&(p=n[0],m=n[1]),a.num(g)||(c=g=e),a.num(m)||(p=m=e),d.start(c,g,p,m),d},tweenXY(t,i,s,n,r=60,o=!1){const h=p(t,i,r,o);let l=t.x,d=t.y,c=s,u=n;return a.vec(s)&&(l=s[0],c=s[1]),a.vec(n)&&(d=n[0],u=n[1]),a.num(c)||(l=c=e),a.num(u)||(d=u=e),h.start(l,c,d,u),h},fadeOut(t,e=60){return this.tweenAlpha(t,this.EASE_OUT_SINE,0,e)},fadeIn(t,e=60){return this.tweenAlpha(t,this.EASE_OUT_SINE,1,e)},pulse(t,e=0,i=60,s=!0){return this.tweenAlpha(t,this.SMOOTH,e,i,s)},slide(t,e,i,s,n=60){return this.tweenXY(t,e,i,s,n)},throb(t,e=.9,i=.9,s=60,n=!0){return this.tweenScale(t,this.SMOOTH_QUAD,e,i,s,n)},scale(t,e=.5,i=.5,s=60){return this.tweenScale(t,this.SMOOTH,e,i,s)},strobe(t,e=1.3,i=10,s=20,n=10,r=!0){return this.tweenScale(t,(t=>this.SPLINE(t,i,0,1,s)),e,e,n,r)},jiggle(t,i,s=1.4,n=1.2,r=10,a=!0){let{x1:h,x2:l,y1:d,y2:c}=i;return g(this.tweenScale(t,(t=>this.SPLINE(t,o.or(h,10),0,1,o.or(l,10))),s,e,r,a),this.tweenScale(t,(t=>this.SPLINE(t,o.or(d,-10),0,1,o.or(c,-10))),e,n,r,a))},bezier(t,e,i,s,r=60){let o=p(t,this.SMOOTH,r);return o.start=function(){this._run()},o.onFrame=function(r,o){r||n.set(t,m.CUBIC_BEZIER(o,t.x,e[0],i[0],s[0]),m.CUBIC_BEZIER(o,t.y,e[1],i[1],s[1]))},o.start(),o},remove(t){t&&t.dispose()},update(t){o.rseq(i,(e=>e.onTick(t))),o.rseq(s,(e=>e.onTick(t)))},particles(t,e,i,r,a=24,l={},d={},c=[0,.3],u=!0){function p(a){let u,p=r(),g=o.randInt2(l.size,d.size);s.push(p),t.addChild(p),p.totalFrames&&p.gotoAndStop(o.randInt2(0,p.totalFrames-1)),h.sizeXY(h.anchorXY(p,.5),g,g),n.set(p,e,i),p.g.scaleSpeed=o.randFloat2(l.scale,d.scale),p.galphaSpeed=o.randFloat2(l.alpha,d.alpha),p.g.angVel=o.randFloat2(l.rotate,d.rotate),u=o.randFloat2(l.speed,d.speed),n.set(p.m5.vel,u*Math.cos(a),u*Math.sin(a)),p.onTick=function(){n.add$(p.m5.vel,c),n.add$(p,p.m5.vel),p.scale.x-p.g.scaleSpeed>0&&(p.scale.x-=p.g.scaleSpeed),p.scale.y-p.g.scaleSpeed>0&&(p.scale.y-=p.g.scaleSpeed),p.rotation+=p.m5.angVel,p.alpha-=p.g.alphaSpeed,p.alpha<=0&&o.disj(s,h.remove(p))}}l=o.patch(l,{angle:0,size:4,speed:.3,scale:.01,alpha:.02,rotate:.01});for(let t=((d=o.patch(d,{angle:6.28,size:16,speed:3,scale:.05,alpha:.02,rotate:.03})).angle-l.angle)/(a-1),e=l.angle,i=0;i<a;++i)p(u?o.randFloat2(l.angle,d.angle):e),e+=t},shake(t,e=16,i=!1,n=!0){let a={},h=1,l=t.x,d=t.y,c=1,u=t.rotation,p=e,g=r.ndiv(e,8);return a.onTick=()=>i?void(h<8?(t.rotation=u,e-=g,t.rotation=e*c,++h,c*=-1):n?(e=p,h=1):o.disj(s,a)):void(h<8?(t.x=l,t.y=d,e-=g,t.x+=o.randInt2(-e,e),t.y+=o.randInt2(-e,e),++h):n?(e=p,h=1):o.disj(s,a)),s.push(a)&&t},StarWarp:function(e,i){i=i||{};let s=2e3,n=0,r=0,a=0,l=o.now(),u=i.color||"yellow",p=i.items||1e3,g=t.tcached("boot/star.png");const m=o.fill(p,(t=>((t=h.sprite(g)).g.d3=[0,0,0],o.rand()<.3&&(t.tint=h.color(u)),h.anchorXY(t,.5,.69),e.addChild(t),f(t,o.rand()*s))));function f(t,e){let i=o.rand()*c,r=50*o.rand()+1;return t.g.d3[0]=Math.cos(i)*r,t.g.d3[1]=Math.sin(i)*r,t.g.d3[2]=isNaN(e)?n+s*(1+.5*o.rand()):e,t}return{dispose(){m.forEach((t=>h.remove(t)))},update(e){let i,c,u=t.width/2,p=t.height/2;r+=(a-r)/20,n+=10*e*(r+.025),m.forEach(((e,i)=>{e.g.d3[2]<n&&f(e),i=20*t.width/c,c=e.g.d3[2]-n,e.x=e.g.d3[0]*i+u,e.y=e.g.d3[1]*i+p;let o=e.x-u,a=e.y-p,l=Math.sqrt(o*o+a*a),g=Math.max(0,1-c/s);e.rotation=Math.atan2(a,o)+d,h.scaleXY(e,.05*g,g*(.05+6*r*l/t.width))})),i=o.now(),i-l>5e3&&(l=i,a=a>0?0:1)}}},SeqTweens:function(...t){let e=[];t.forEach((t=>{e.push(t),o.disj(i,t)}));const s={onDone(){this.dispose(),this.onComplete&&o.delay(0,(()=>this.onComplete()))},dispose(){e.length=0}};return function t(n){n?(i.push(n),n.onComplete=()=>t(e.shift())):s.onDone()}(e.shift()),s},BatchTweens:g};return t.FX=m}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/FX"]=function(t){return t.FX?t.FX:i(t,[],[])}}(this),function(t,e){"use strict";function i(t){const{Scenes:i,Sprites:s,FX:n,Input:r,v2:o,math:a,is:h,ute:l}=t,d=Math.abs,c=Math.cos,u=Math.sin,p=Math.floor,{Geo:g}=s,m=Math.PI/180;Math.PI;i.scene("Splash",{setup(e){let r,{title:a,titleFont:h,titleColor:d,titleSize:c}=e,{footerMsgSize:u,action:p,clickSnd:g}=e,{bg:m,playMsg:f,playMsgFont:y,playMsgColor:x,playMsgSize:v,playMsgColor2:w}=e,b=t.getScaleFactor();y=y||"Doki Lowercase",u=u||16*b,h=h||"Big Shout Bob",f=f||t.clickPlayMsg(),x=l.nor(x,s.color("white")),w=l.nor(w,s.color("#ffc901")),d=l.nor(d,s.color("#ffc901")),c=l.nor(c,96*b),v=l.nor(v,64*b),this.insert(s.fillMax(s.sprite(m||"boot/splash.jpg"))),r=this.insert(s.container());{let e=s.bmpText(a,h,c);d&&s.tint(e,d),o.set(e,t.width/2,.3*t.height),r.addChild(s.anchorXY(e,.5))}{let e,a=s.bmpText(f,y,v),h=n.throb(a,.747,.747);s.oneOffClick((()=>{s.tint(a,w),n.remove(h),e=n.tweenAlpha(r,n.EASE_OUT_SINE,0,90),e.onComplete=()=>i.runEx(p.name,p.cfg)}),g),o.set(a,t.width/2,.5*t.height),r.addChild(s.anchorXY(a,.5))}{let t=s.bmpText("(c) www.cherimoia.com 2022.","unscii",u);s.pinBelow(this,t,1.5*-t.height,0),this.insert(t),t=s.bmpText("Powered by MojoH5 2d game engine.","unscii",u),s.pinBelow(this,t,1.5*-t.height,1),this.insert(t)}}}),i.scene("EndGame",{setup(e){let{winner:n,snd:o}=e,{fontName:a,fontSize:h,msg:d,replay:c,quit:u}=e;o=n?o||"game_win.mp3":o||"game_over.mp3",l.assert(h,"expected fontSize"),a=a||"Doki Lowercase";let p={fontName:a,fontSize:h},g=()=>s.opacity(s.bmpText("I",p),0),m=s.bmpText("Game Over",p),f=s.bmpText(d||"",p),y=r.mkBtn(s.bmpText("Play Again?",p)),x=s.bmpText(" or ",p),v=r.mkBtn(s.bmpText("Quit",p));y.m5.press=()=>i.runEx(c.name,c.cfg),v.m5.press=()=>i.runEx(u.name,u.cfg),t.sound(o).play(),this.insert(i.layoutY([m,f,g(),g(),g(),y,x,v],e))}}),i.scene("PhotoMat",{setup(i){if(i.cb)i.cb(this);else{let n=i.image?t.tcached(i.image):e;this.g.gfx=s.graphics(),n?this.g.gfx.beginTextureFill({texture:n}):this.g.gfx.beginFill(s.color(i.color)),this.g.gfx.drawRect(0,0,t.width,i.y1),this.g.gfx.drawRect(0,i.y2,t.width,t.height-i.y2),this.g.gfx.drawRect(0,0,i.x1,t.height),this.g.gfx.drawRect(i.x2,0,t.width-i.x2,t.height),this.g.gfx.endFill(),this.insert(this.g.gfx)}}}),i.scene("HotKeys",{setup(t){let e,i,n,o,a,d,c=t.buttons?"makeButton":"makeHotspot",{fontName:u,fontSize:p,cb:g,radius:m,alpha:f,color:y}=t,{char_fire:x,char_down:v,char_up:w,char_left:b,char_right:I}=t;l.assert(h.num(p),"expected fontsize"),l.assert(h.num(m),"expected radius"),l.assert(h.fun(g),"expected callback"),u=u||"Doki Lowercase",f=f||.2,y=l.nor(y,"grey"),v=v||"-",w=w||"+",b=b||"<",I=I||">",x=x||"^",o=s.opacity(s.circle(m,y),f),o.addChild(s.anchorXY(s.bmpText(v,u,p),.5)),n=s.opacity(s.circle(m,y),f),n.addChild(s.anchorXY(s.bmpText(w,u,p),.5)),a=s.opacity(s.circle(m,y),f),a.addChild(s.anchorXY(s.bmpText(b,u,p),.5)),d=s.opacity(s.circle(m,y),f),d.addChild(s.anchorXY(s.bmpText(I,u,p),.5)),t.fire&&(i=s.opacity(s.circle(m,y),f),i.addChild(s.anchorXY(s.bmpText(x,u,p),.5))),e=g(i?{left:a,right:d,down:o,up:n,fire:i}:{left:a,right:d,down:o,up:n}),e.right&&(this.insert(r[c](e.right)),e.right.m5.hotspot&&(e.right.m5.touch=(t,e)=>e?r.setKeyOn(r.RIGHT):r.setKeyOff(r.RIGHT))),e.left&&(this.insert(r[c](e.left)),e.left.m5.hotspot&&(e.left.m5.touch=(t,e)=>e?r.setKeyOn(r.LEFT):r.setKeyOff(r.LEFT))),e.up&&(this.insert(r[c](e.up)),e.up.m5.hotspot&&(e.up.m5.touch=(t,e)=>e?r.setKeyOn(r.UP):r.setKeyOff(r.UP))),e.down&&(this.insert(r[c](e.down)),e.down.m5.hotspot&&(e.down.m5.touch=(t,e)=>e?r.setKeyOn(r.DOWN):r.setKeyOff(r.DOWN))),e.fire&&(this.insert(r[c](e.fire)),e.fire.m5.hotspot&&(e.fire.m5.touch=(t,e)=>e?r.setKeyOn(r.SPACE):r.setKeyOff(r.SPACE))),t.extra&&t.extra(this)}}),i.scene("AudioIcon",{setup(e){let{Sound:i}=t,{cb:n,iconOn:a,iconOff:h}=e,{xOffset:d,yOffset:c,xScale:u,yScale:p}=e,g=t.getScaleFactor(),m=r.mkBtn(s.spriteFrom(a||"audioOn.png",h||"audioOff.png"));u=l.nor(u,2*g),p=l.nor(p,2*g),d=l.nor(d,-10*g),c=l.nor(c,0),s.scaleXY(s.opacity(m,.343),u,p),o.set(m,t.width-m.width+d,0+c),m.m5.showFrame(i.sfx()?0:1),m.m5.press=()=>{i.sfx()?(i.mute(),m.m5.showFrame(1)):(i.unmute(),m.m5.showFrame(0))},this.insert(m)}}),i.scene("StarfieldBg",{setup(e){l.patch(e,{height:t.height,width:t.width,count:100,minVel:15,maxVel:30});const i=[],n=s.graphics();l.inject(this.g,{gfx:n,stars:i,lag:0,dynamic:!0,fps:1/e.fps,draw(){return n.clear(),i.forEach((t=>{n.beginFill(l.rand()<.3?s.SomeColors.yellow:s.SomeColors.white),n.drawRect(t.x,t.y,t.size,t.size),n.endFill()})),this},moveStars(t){this.lag+=t,this.lag>=this.fps&&(this.lag=0,i.forEach((i=>{i.y+=t*i.vel,i.y>e.height&&(o.set(i,l.randInt(e.width),0),i.size=l.randInt(4),i.vel=l.rand()*(e.maxVel-e.minVel)+e.minVel)})),this.draw())}}),e.static&&(this.g.dynamic=!1);for(let t=0;t<e.count;++t)i[t]={x:l.rand()*e.width,y:l.rand()*e.height,size:3*l.rand()+1,vel:l.rand()*(e.maxVel-e.minVel)+e.minVel};this.g.draw()&&this.insert(n)},postUpdate(t){this.g.dynamic&&this.g.moveStars(t)}},{fps:90,count:100,minVel:15,maxVel:30});const f={Periodic:class{constructor(t,e,i=16){this._interval=e,this._ctor=t,this._timer=0,this._size=i,this._pool=l.fill(i,t)}lifeCycle(t){this._timer+=t,this._timer>this._interval&&(this._timer=0,this.discharge())}discharge(){throw"Periodic: please implement action()"}reclaim(t){this._pool.length<this._size&&this._pool.push(t)}_take(){return this._pool.length>0?this._pool.pop():this._ctor()}},Meander:function(i){const s=[],n={dispose(){t.off(n)},boom(n){if(l.assert(n.A===i,"got hit by someone else???"),n.B&&n.B.m5.sensor)t.emit(["bump.sensor",n.B],n.A);else{let[s,r]=i.m5.vel;n.impact=e,o.sub$(i,n.overlapV),n.overlapN[1]<-.3&&(!i.m5.skipHit&&r<0&&o.setY(i.m5.vel,0),n.impact=d(r),t.emit(["bump.top",i],n)),n.overlapN[1]>.3&&(!i.m5.skipHit&&r>0&&o.setY(i.m5.vel,0),n.impact=d(r),t.emit(["bump.bottom",i],n)),n.overlapN[0]<-.3&&(!i.m5.skipHit&&s<0&&o.setX(i.m5.vel,0),n.impact=d(s),t.emit(["bump.left",i],n)),n.overlapN[0]>.3&&(!i.m5.skipHit&&s>0&&o.setX(i.m5.vel,0),n.impact=d(s),t.emit(["bump.right",i],n)),n.impact===e?n.impact=0:t.emit(["bump.*",i],n)}s.push(n)}};return t.on(["hit",i],"boom",n),t.on(["post.remove",i],"dispose",n),function(e){return s.length=0,t.Sprites.move(i,e),i.parent.collideXY(i),s[0]}},Camera:function(e,i,s,n){const r=n?n.height:s,o=n?n.width:i,d=a.ndiv(r,2),c=a.ndiv(o,2),u=a.ndiv(r,4),g=a.ndiv(o,4);let m=0,f=0,y={dispose(){t.off(y)},set x(t){m=t,e.x=-m},set y(t){f=t,e.y=-f},get x(){return m},get y(){return f},worldHeight:s,worldWidth:i,width:o,height:r,follow(e){const n=l.feq0(e.angle)?t.Sprites.getAABB(e):t.Sprites.boundingBox(e);(()=>{n.x1<this.x+p(c-g)&&(this.x=n.x1-g)})(),(()=>{n.x2>this.x+p(c+g)&&(this.x=n.x2-3*g)})(),(()=>{n.y1<this.y+p(d-u)&&(this.y=n.y1-u)})(),(()=>{n.y2>this.y+p(d+u)&&(this.y=n.y2-3*u)})(),this.x<0&&(this.x=0),this.y<0&&(this.y=0),this.x+o>i&&(this.x=i-o),this.y+r>s&&(this.y=s-r);let{x1:a,x2:h,y1:m,y2:f}=e.m5.getImageOffsets(),y=n.x2-h;y>i&&(e.x-=y-i),y=n.y2-f,y>s&&(e.y-=y-s),y=n.x1+a,y<0&&(e.x+=-y),y=n.y1+m,y<0&&(e.y+=-y)},centerOver:function(e,i){if(1!=arguments.length||h.num(e))h.num(e)&&(this.x=e-c),h.num(i)&&(this.y=i-d);else{let i=t.Sprites.centerXY(e);this.x=i[0]-c,this.y=i[1]-d}}};return t.on(["post.remove",e],"dispose",y),y},Patrol:function(e,i,s){const n={dispose(){t.off(n)},goLeft(i){e.m5.heading=t.LEFT,e.m5.flip="x",o.setX(e.m5.vel,-i.impact)},goRight(i){e.m5.heading=t.RIGHT,e.m5.flip="x",o.setX(e.m5.vel,i.impact)},goUp(i){o.setY(e.m5.vel,-i.impact),e.m5.heading=t.UP,e.m5.flip="y"},goDown(i){o.setY(e.m5.vel,i.impact),e.m5.heading=t.DOWN,e.m5.flip="y"}};return i&&(t.on(["bump.right",e],"goLeft",n),t.on(["bump.left",e],"goRight",n)),s&&(t.on(["bump.top",e],"goDown",n),t.on(["bump.bottom",e],"goUp",n)),t.on(["post.remove",e],"dispose",n),n},Jitter:function(i,s,n){n=l.nor(n,t.Input.UP),s=l.nor(s,-300);let r=0,a=0,h=s/3;const d={onGround(){a=.24},dispose(){t.off(d)}};return t.on(["bump.bottom",i],"onGround",d),function(l,d){if(!i.m5.skipHit){let c=i.m5.speed,u=t.Input.keyDown(t.Input.RIGHT),p=t.Input.keyDown(t.Input.LEFT),g=t.Input.keyDown(n);d&&(p||u||a>0)&&(d.overlapN[1]>.85||d.overlapN[1]<-.85)&&(d=e),p&&!u?(i.m5.heading=t.LEFT,d&&a>0?o.set(i.m5.vel,c*d.overlapN[1],-c*d.overlapN[0]):o.setX(i.m5.vel,-c)):u&&!p?(i.m5.heading=t.RIGHT,d&&a>0?o.set(i.m5.vel,-c*d.overlapN[1],c*d.overlapN[0]):o.setX(i.m5.vel,c)):o.setX(i.m5.vel,0),a>0&&0==r&&g?(o.setY(i.m5.vel,s),r+=1,a=-l):g&&r<2&&(r+=1,t.emit(["jump",i])),r&&!g&&(r=0,t.emit(["jumped",i]),i.m5.vel[1]<h&&(i.m5.vel[1]=h)),a>0&&(i.m5.vel[1]=0)}a-=l}},MazeRunner:function(e,i){return function(s,n){let r,a,d,c,[u,p]=e.m5.vel,g=e.m5.speed,m=!l.feq0(u),f=!l.feq0(p);m&&f||!i||(f&&(h.obj(i)?e.m5.showFrame(i[p>0?t.DOWN:t.UP]):i&&(e.angle=p>0?180:0)),m&&(h.obj(i)?e.m5.showFrame(i[u>0?t.RIGHT:t.LEFT]):i&&(e.angle=u>0?90:-90))),t.u.touchOnly?(r=e.m5.heading==t.RIGHT,d=e.m5.heading==t.LEFT,c=e.m5.heading==t.UP,a=e.m5.heading==t.DOWN):(r=t.Input.keyDown(t.Input.RIGHT)&&t.RIGHT,a=t.Input.keyDown(t.Input.DOWN)&&t.DOWN,d=t.Input.keyDown(t.Input.LEFT)&&t.LEFT,c=t.Input.keyDown(t.Input.UP)&&t.UP),(d||c)&&(g*=-1),d&&r?o.setX(e.m5.vel,0):(d||r)&&(e.m5.heading=d||r,o.setX(e.m5.vel,g)),c&&a?o.setY(e.m5.vel,0):(c||a)&&(e.m5.heading=c||a,o.setY(e.m5.vel,g))}},seek(t,e){let i=o.unit$(o.sub(e,t));return i&&(o.mul$(i,t.m5.maxSpeed),o.sub$(i,t.m5.vel),o.add$(t.m5.steer,i)),t},flee(t,e,i){let s=o.sub(t,e),n=o.len2(s);void 0===i&&(i=t.m5.steerInfo.tooCloseDistance),n>i*i||(o.unit$(s)||(s=[.1,.1]),o.mul$(s,t.m5.maxSpeed),o.sub$(s,t.m5.vel),o.add$(t.m5.steer,s))},arrive(t,e,i){let s=1,n=o.dist(t,e),r=o.unit$(o.sub(e,t));void 0===i&&(i=t.m5.steerInfo.arrivalThreshold),n>i||(s=n/i),o.mul$(r,t.m5.maxSpeed*s),o.sub$(r,t.m5.vel),o.add$(t.m5.steer,r)},pursue(t,e){let i=o.dist(t,e)/t.m5.maxSpeed,s=o.add(e,o.mul(e.m5.vel,i));return this.seek(t,s)},evade(t,e){let i=o.dist(t,e)/t.m5.maxSpeed,s=o.sub(e,o.mul(e.m5.vel,i));return this.flee(t,s)},idle:t=>(o.mul$(t.m5.vel,0),o.mul$(t.m5.steer,0),t),wander(t){let e=o.mul$([1,1],t.m5.steerInfo.wanderRadius),i=o.len(e),s=o.mul$(o.unit(t.m5.vel),t.m5.steerInfo.wanderDistance);return e[0]=Math.cos(t.m5.steerInfo.wanderAngle)*i,e[1]=Math.sin(t.m5.steerInfo.wanderAngle)*i,t.m5.steerInfo.wanderAngle+=l.rand()*t.m5.steerInfo.wanderRange-.5*t.m5.steerInfo.wanderRange,o.add$(t.m5.steer,o.add$(s,e)),t},interpose(t,e,i){let s=o.div$(o.add(e,i),2),n=o.dist(t,s)/t.m5.maxSpeed,r=o.add(e,o.mul(e.m5.vel,n)),a=o.add(i,o.mul(i.m5.vel,n));return this.seek(t,o.div$(o.add$(r,a),2))},separation(t,e,i=300,s=100){let n=[0,0],r=0;e.forEach((e=>{e!==t&&o.dist(e,t)<i&&(o.add$(n,o.sub(e,t)),++r)})),r>0&&o.flip$(o.div$(n,r)),o.add$(t.m5.steer,o.mul$(o.unit$(n),s))},followLeader(t,e,i,s=400,n=300,r=100,a=1600,h=200){let l,d=o.mul$(o.unit(e.m5.vel),s),c=o.add(e,d);return o.flip$(d),l=o.add(e,d),function(t,e,i,s){return o.dist(i,t)<s||o.dist(e,t)<s}(t,e,c,a)&&this.evade(t,e),this.arrive(t,l,h),this.separation(t,i,n,r)},queue(t,e,i=500,s=500){let n=function(){let n,r=o.mul$(o.unit(t.m5.vel),i),a=o.add(t,r);for(let i=0;i<e.length;++i)if(e[i]!==t&&o.dist(a,e[i])<s){n=e[i];break}return n}(),r=[0,0],a=o.mul(t.m5.vel,1);n&&(r=o.mul$(o.flip(t.m5.steer),.8),o.unit$(o.flip$(a)),o.add$(r,a),o.dist(t,n)<s&&o.mul$(t.m5.vel,.3)),o.add$(t.m5.steer,r)},flock(t,e){let i=0,s=[0,0],n=o.mul(t.m5.vel,1);e.forEach((e=>{e!==this&&function(e){return!(o.dist(t,e)>t.m5.steerInfo.inSightDistance||o.dot(o.sub(e,t),o.unit(t.m5.vel))<0)}(e)&&(o.add$(n,e.m5.vel),o.add$(s,e),o.dist(t,e)<t.m5.steerInfo.tooCloseDistance&&this.flee(t,e),++i)})),i>0&&(o.div$(n,i),o.div$(s,i),this.seek(t,s),o.add$(t.m5.steer,o.sub$(n,t.m5.vel)))},followPath(t,e,i,s=1){let n=e[t.m5.pathIndex];n&&(o.dist(t,n)<s&&(t.m5.pathIndex>=e.length-1?i&&(t.m5.pathIndex=0):t.m5.pathIndex+=1),t.m5.pathIndex>=e.length-1&&!i?this.arrive(t,n):this.seek(t,n))},avoid(t,e){let i,s=o.len(t.m5.vel)/t.m5.maxSpeed,n=o.add(t,o.mul$(o.unit(t.m5.vel),s)),r=o.add(t,o.mul$(o.unit(t.m5.vel),.5*t.m5.steerInfo.avoidDistance)),a=null;for(let i,s=0;s<e.length;++s)e[s]!==this&&(i=o.dist(e[s],n)<=e[s].m5.radius||o.dist(e[s],r)<=e[s].m5.radius,i&&(null===a||o.dist(t,e[s])<o.dist(t,a))&&(a=e[s]));a&&(i=o.mul$(o.unit$(o.sub(n,a)),100),o.add$(t.m5.steer,i))},lineOfSight(t,e,i){let n=s.centerXY(t),r=s.centerXY(e);for(let t,e,o=0;o<i.length;++o)if(e=i[o],t=e.m5.circle?g.hitTestLineCircle(n,r,e.x,e.y,e.width/2):g.hitTestLinePolygon(n,r,g.bodyWrap(s.toPolygon(e),e.x,e.y)),t[0])return!1;return!0},shoot(e,i,s,n,r,a){let h=n(),l=t.Sprites.topLeftOffsetXY(e);return o.add$(l,[r,a]),o.copy(h,o.add(e,l)),o.set(h.m5.vel,Math.cos(i)*s,Math.sin(i)*s),h},healthBar(t){let{scale:e,width:n,height:r,lives:o,borderWidth:h,line:l,fill:d}=t,c=4*e,u=4*e,p=[];h=(h||4)*e,o=o||3,d=s.color(d),l=s.color(l);for(let t=a.ndiv(n,o),e=0;e<o;++e)p.push(s.rect(t,r-2*h,d));return{dec(){return this.lives>0&&(this.lives-=1,p[this.lives].visible=!1),this.lives>0},lives:p.length,sprite:i.layoutX(p,{bg:["#cccccc",0],borderWidth:h,border:l,padding:c,fit:u})}},gaugeUI(t){let{minDeg:e,maxDeg:i,line:n,gfx:r,scale:o,cx:h,cy:d,radius:p,alpha:g,fill:f,needle:y}=l.patch(t,{minDeg:90,maxDeg:360});const x=[0,45*m,90*m,135*m,180*m,225*m,270*m,315*m];function v(t,e,i,s){return[t+i*c(s),e+i*u(s)]}return y=s.color(y),n=s.color(n),f=s.color(f),p*=o,{gfx:r,draw(){r.clear(),r.lineStyle({width:p/8,color:n}),r.beginFill(f,g),r.drawCircle(h,d,p),r.endFill(),x.forEach((t=>function(t,e,i,s){let[a,h]=v(t,e,p-4*o,i),[l,d]=v(t,e,p-12*o,i);r.lineStyle({color:n,width:s,cap:PIXI.LINE_CAP.ROUND}),r.moveTo(a,h),r.lineTo(l,d),r.closePath()}(h,d,t,7*o))),function(t,e,i){let[s,a]=v(h,d,t-20*o,i),[l,c]=v(h,d,2*o,i+90*m),[u,p]=v(h,d,2*o,i-90*m);r.lineStyle({cap:PIXI.LINE_CAP.ROUND,width:4*o,color:y}),r.moveTo(l,c),r.lineTo(s,a),r.lineTo(u,p),r.closePath(),r.lineStyle({color:n}),r.beginFill(n),r.drawCircle(h,d,9*o),r.endFill()}(p*o,0,m*a.lerp(e,i,t.update()))}}}};return t.Ute2D=f}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Ute2D"]=t=>t.Ute2D?t.Ute2D:i(t)}(this),function(t,e){"use strict";if(!t.AudioContext)throw"Fatal: no audio.";function i(e,i){const{ute:s,is:n}=e,r=(Math.floor,new Map);let o=1;function a(t,n,a){let h=0,l=1;const d={sids:new Map,buffer:undefined,loop:!1,src:a,name:n,get pan(){return h},set pan(t){h=t},get vol(){return l},set vol(t){l=t},play(){const i=s.now(),n=this.name;if(e.Sound.sfx()&&!function(t,e,i){let s;return r.has(t)&&r.get(t)>e?s=!0:i?r.set(t,e+i):r.delete(t),s}(n,i)){let e=o++,i=1e3*this.buffer.duration,n=t.ctx.createGain(),r=t.ctx.createStereoPanner(),a=t.ctx.createBufferSource();a.buffer=this.buffer,a.connect(n),n.connect(r),r.connect(t.ctx.destination),this.loop?a.loop=!0:s.delay(i,(()=>this.sids.delete(e))),r.pan.value=h,n.gain.value=l,a.start(0),this.sids.set(e,a)}return this},stop(){return this.sids.forEach((t=>t.stop(0))),this.sids.length=0,this}};return i[n]=d}const h={ctx:new t.AudioContext,_mute:0,init(){s.delay(0,(()=>{"suspended"==this.ctx.state&&this.ctx.resume()}))},sfx(){return 0==this._mute},mute(){return(this._mute=1)&&this},unmute(){return(this._mute=0)||this},decodeData(t,i,s,n,r){let o=a(this,t,i);return this.ctx.decodeAudioData(s,(t=>{n(o.buffer=t),e.CON.log(`decoded sound file:${i}`)}),(t=>{r&&r(i,t)})),o},decodeUrl(t,e,i,s){let n=new XMLHttpRequest,r=a(this,t,e);return n.open("GET",e,!0),n.responseType="arraybuffer",n.addEventListener("load",(()=>{this.decodeData(e,n.response,i,s)})),n.send(),r}};return e.sound=function(t){return i[e.assetPath(t)]||s.assert(!1,`Sound: ${t} not loaded.`)},e.Sound=h}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Sound"]=function(t){return t.Sound?t.Sound:i(t,{})}}(this),function(t,e){"use strict";function i(t){const{math:i,v2:s,ute:n,is:r,Sprites:o}=t,a=[],{Geo:h}=o,l=["ctrlKey","altKey","shiftKey"],d=()=>a[0];function c(i={}){function o(t){if(i===d()){let e=i.keyInputs.get(t.keyCode);e||(e={},i.keyInputs.set(t.keyCode,e)),e.state=!1,n.copyKeys(e,t,l),t.preventDefault()}}function a(t){if(i===d()){let e=i.keyInputs.get(t.keyCode);e||(e={},i.keyInputs.set(t.keyCode,e)),e.state=!0,n.copyKeys(e,t,l),t.preventDefault()}}return n.inject(i,{yid:`yid#${n.nextId()}`,keyInputs:n.jsMap(),pauseInput:!1,ptr:e,dispose(){this.ptr.dispose(),t.touchDevice||n.delEvent([["keyup",window,o,!1],["keydown",window,a,!1]])},pointer(){return this.ptr||(this.ptr=function(i){let r={ActiveDragsID:n.jsMap(),ActiveDrags:n.jsMap(),ActiveTouches:n.jsMap(),Hotspots:[],Buttons:[],DragDrops:[],state:[!1,!0],touchZeroID:0,_visible:!0,_x:0,_y:0,width:1,height:1,downTime:0,downAt:[0,0],elapsedTime:0,dragged:e,dragOffsetX:0,dragOffsetY:0,anchor:t.makeAnchor(.5,.5),get cursor(){return t.canvas.style.cursor},set cursor(e){t.canvas.style.cursor=e},get x(){return this._x/t.scale},get y(){return this._y/t.scale},get visible(){return this._visible},get isUp(){return this.state[1]},get isDown(){return this.state[0]},set visible(t){this.cursor=t?"auto":"none",this._visible=t},updateMultiDrags(t){let e=r;for(let t,i,r=0;r<e.ActiveTouches.length;++r){i=e.ActiveTouches[r];for(let r,o,a=e.DragDrops.length-1;a>=0;--a){if(o=e.DragDrops[a],r=e.ActiveDrags.get(o.m5.uuid),r){s.set(r.dragged,r.dragStartX+(i.x-r.dragPtrX),r.dragStartY+(i.y-r.dragPtrY));break}if(o.m5.drag&&e._test(o,i.x,i.y)){n.assoc(e.ActiveDrags,o.m5.uuid,r={dragStartX:o.x,dragStartY:o.y,dragPtrX:i.x,dragPtrY:i.y,dragged:o,id:i.id}),n.assoc(e.ActiveDragsID,i.id,r),t=o.parent.children,n.disj(t,o),t.push(o);break}}}},updateDrags(t){if(this.state[0])if(this.dragged)s.set(this.dragged,this.dragStartX+(this.x-this.dragPtrX),this.dragStartY+(this.y-this.dragPtrY));else for(let t,e,i=this.DragDrops.length-1;i>=0;--i)if(e=this.DragDrops[i],e.m5.drag&&this.hitTest(e)){this.dragStartX=e.x,this.dragStartY=e.y,this.dragPtrX=this.x,this.dragPtrY=this.y,this.dragged=e,t=e.parent.children,n.disj(t,e),t.push(e);break}this.state[1]&&(this.dragged&&this.dragged.m5.onDragDropped&&this.dragged.m5.onDragDropped(),this.dragged=e)},getGlobalPosition(){return{x:this.x,y:this.y}},_press(){if(i!==d())return;let t,e,s,n=this.Buttons.length;for(t=0;t<n;++t)if(e=this.Buttons[t],e.m5.gui&&e.m5.press&&this.hitTest(e)){e.m5.press(e),s=!0;break}if(!s)for(t=0;t<n;++t)if(e=this.Buttons[t],e.m5.press&&this.hitTest(e)){e.m5.press(e);break}},_doMDown(t){if(i!==d())return;let e,s=r;for(let i,n=0;n<s.Hotspots.length;++n)if(i=s.Hotspots[n],i.m5.touch&&s.hitTest(i)){i.m5.touch(i,t),e=!0;break}return e},mouseDown(e){if(i!==d())return;let s=r,o=n.now();0==e.button&&(e.preventDefault(),s._x=e.pageX-e.target.offsetLeft,s._y=e.pageY-e.target.offsetTop,n.setVec(s.state,!0,!1),s.downTime=o,s.downAt[0]=s._x,s.downAt[1]=s._y,t.Sound.init(),i.pauseInput||(t.emit([`${i.yid}/mousedown`]),s._doMDown(!0)))},mouseMove(e){if(i!==d())return;let s=r;s._x=e.pageX-e.target.offsetLeft,s._y=e.pageY-e.target.offsetTop,i.pauseInput||t.emit([`${i.yid}/mousemove`])},mouseUp(e){if(i!==d())return;let o=r,a=n.now();if(0==e.button&&(e.preventDefault(),o.elapsedTime=Math.max(0,a-o.downTime),o._x=e.pageX-e.target.offsetLeft,o._y=e.pageY-e.target.offsetTop,n.setVec(o.state,!1,!0),!i.pauseInput&&(t.emit([`${i.yid}/mouseup`]),!o._doMDown(!1)))){let e=s.vecAB(o.downAt,o),n=s.len2(e);n<400&&o.elapsedTime<200?(t.emit([`${i.yid}/single.tap`]),o._press()):o._swipeMotion(e,n,o.elapsedTime)}},_swipeMotion(e,n,r,o){if(i!==d())return;let a,h=s.unit$(s.normal(e));n>400&&r<1e3&&(Math.abs(h[0])>.8||Math.abs(h[1])>.8)&&(h[0]>.8&&(a="swipe.down"),h[0]<-.8&&(a="swipe.up"),h[1]>.8&&(a="swipe.left"),h[1]<-.8&&(a="swipe.right")),a&&t.emit([`${i.yid}/${a}`],o)},_doMTouch(t,e){if(i!==d())return;let s=r,o=n.jsMap();for(let i,n=0;n<t.length;++n){i=t[n];for(let t,n=0;n<s.Hotspots.length;++n)if(t=s.Hotspots[n],t.m5.touch&&s._test(t,i.x,i.y)){t.m5.touch(t,e),o.set(i.id,1);break}}return o},_doMDrag(t,e){if(i!==d())return;let s=r;for(let i,n,r=0;r<t.length;++r)n=t[r],e.get(n.id)||(i=s.ActiveDragsID.get(n.id),i&&(e.set(n.id,1),i.dragged.m5.onDragDropped&&i.dragged.m5.onDragDropped(),s.ActiveDragsID.delete(n.id),s.ActiveDrags.delete(i.dragged.m5.uuid)));return e},touchCancel(t){i===d()&&(console.warn("received touchCancel event!"),this.freeTouches())},touchStart(e){if(i!==d())return;let s=r,o=e.target,a=[],h=n.now(),l=e.targetTouches,c=s.ActiveTouches;e.preventDefault();for(let e,i,r,d,u,p=0;p<l.length;++p)u=l[p],d=u.identifier,i=u.pageX-o.offsetLeft,r=u.pageY-o.offsetTop,n.assoc(c,d,e={id:d,_x:i,_y:r,downTime:h,downAt:[i,r],x:i/t.scale,y:r/t.scale}),a.push(e),0==p&&(s.touchZeroID=d,s._x=i,s._y=r,s.downTime=h,s.downAt=[i,r],n.setVec(s.state,!0,!1));t.Sound.init(),i.pauseInput||(t.emit([`${i.yid}/touchstart`],a),s._doMTouch(a,!0))},touchMove(e){if(i!==d())return;let s=[],n=r,o=e.target,a=e.targetTouches;e.preventDefault();for(let e,i,r,h,l,d=0;d<a.length;++d)h=a[d],l=h.identifier,e=h.pageX-o.offsetLeft,i=h.pageY-o.offsetTop,l==n.touchZeroID&&(n._x=e,n._y=i),(r=n.ActiveTouches.get(l))&&(r.x=e/t.scale,r.y=i/t.scale,r._x=e,r._y=i,s.push(r));i.pauseInput||t.emit([`${i.yid}/touchmove`],s)},touchEnd(e){if(i!==d())return;let s,o,a,h,l,c,u=r,p=[],g=(e.targetTouches,e.changedTouches),m=e.target,f=n.now();for(e.preventDefault(),a=0;a<g.length;++a)l=g[a],c=l.identifier,s=l.pageX-m.offsetLeft,o=l.pageY-m.offsetTop,h=u.ActiveTouches.get(c),c==u.touchZeroID&&(u.elapsedTime=Math.max(0,f-u.downTime),n.setVec(u.state,!1,!0),u._x=s,u._y=o),h&&(h.elapsedTime=Math.max(0,f-h.downTime),u.ActiveTouches.delete(c),h._x=s,h._y=o,h.x=s/t.scale,h.y=o/t.scale,p.push(h));if(!i.pauseInput){t.emit([`${i.yid}/touchend`],p);let e=u._doMTouch(p,!1);u._doMDrag(p,e),u._onMultiTouches(p,e)}},_onMultiTouches(e,n){if(i!==d())return;let o=r;for(let r,a,h,l=0;l<e.length;++l)if(r=e[l],!n.get(r.id))if(a=s.vecAB(r.downAt,r),h=s.len2(a),h<400&&r.elapsedTime<200){t.emit([`${i.yid}/single.tap`],r);for(let t,e=0,i=o.Buttons.length;e<i;++e)if(t=o.Buttons[e],t.m5.press&&o._test(t,r.x,r.y)){t.m5.press(t);break}}else o._swipeMotion(a,h,r.elapsedTime,r)},freeTouches(){n.setVec(this.state,!1,!0),this.touchZeroID=0,this.ActiveTouches.clear(),this.ActiveDrags.clear(),this.ActiveDragsID.clear()},reset(){n.setVec(this.state,!1,!0),this.freeTouches(),this.DragDrops.length=0,this.Buttons.length=0,this.Hotspots.length=0},_test(e,i,n){let r=t.Sprites,o=r.gposXY(e),a=r.toPolygon(e),l=s.translate(o,a.calcPoints);return h.hitTestPointInPolygon(i,n,l)},hitTest(t){return this._test(t,this.x,this.y)},update(e){this.DragDrops.length>0&&(t.touchDevice?this.updateMultiDrags(e):this.updateDrags(e)),this.tail&&this.updateTrail()},updateTrail(){this.tailHistX.pop(),this.tailHistY.pop(),this.tailHistX.unshift(this.x),this.tailHistY.unshift(this.y),this.tailPoints.forEach(((t,e)=>{t.x=this.cubic(this.tailHistX,e/p*u),t.y=this.cubic(this.tailHistY,e/p*u)}))},cubic(t,e,i=1){function s(t,e){return t<0&&(t=0),t>e.length-1&&(t=e.length-1),e[t]}function n(t,e){return i*(s(t+1,e)-s(t-1,e))/2}const r=Math.floor(e),o=[n(r,t),n(r+1,t)],a=[s(r,t),s(r+1,t)],h=(e-=r)*e,l=e*h;return(2*l-3*h+1)*a[0]+(l-2*h+e)*o[0]+(-2*l+3*h)*a[1]+(l-h)*o[1]},disableTrail(){this.tail&&t.stage.removeChild(this.tail),this.tail=null,this.tailHistX=null,this.tailHistY=null,this.tailPoints=null},enableTrail(){const e=n.fill(p,(()=>new PIXI.Point(0,0))),i=t.tcached("boot/trail.png"),s=new PIXI.SimpleRope(i,e);s.blendmode=PIXI.BLEND_MODES.ADD,this.tail=s,this.tailPoints=e,this.tailHistX=n.fill(u,0),this.tailHistY=n.fill(u,0),t.stage.addChild(s)}};const o=[["mousemove",t.canvas,r.mouseMove],["mousedown",t.canvas,r.mouseDown],["mouseup",window,r.mouseUp]],a=[["touchmove",t.canvas,r.touchMove],["touchstart",t.canvas,r.touchStart],["touchend",window,r.touchEnd],["touchcancel",window,r.touchCancel]];return t.touchDevice?n.addEvent(a):n.addEvent(o),r.dispose=function(){this.reset(),t.touchDevice?n.delEvent(a):n.delEvent(o)},r}(this)),this.ptr},update(t){this.pauseInput||this.ptr.update(t)},keybd(e,s,o){let a={press:s,release:o},h=this,l=!0,c=!1,u=r.vec(e)?e:[e];function p(t){i===d()&&(u.includes(t.keyCode)&&(!h.pauseInput&&l&&a.press&&a.press(t.altKey,t.ctrlKey,t.shiftKey),l=!1,c=!0),t.preventDefault())}function g(t){i===d()&&(u.includes(t.keyCode)&&(!h.pauseInput&&c&&a.release&&a.release(t.altKey,t.ctrlKey,t.shiftKey),l=!0,c=!1),t.preventDefault())}return t.touchDevice||n.addEvent([["keyup",window,g,!1],["keydown",window,p,!1]]),a.dispose=()=>{t.touchDevice||n.delEvent([["keyup",window,g,!1],["keydown",window,p,!1]])},a},reset(){this.pauseInput=!1,this.keyInputs.clear(),this.ptr.reset()},resize(){t.mouse=this.ptr,this.ptr.reset()},dbg(){console.log(`N# of touches= ${this.ptr.ActiveTouches.size}`),console.log(`N# of hotspots= ${this.ptr.Hotspots.length}`),console.log(`N# of buttons= ${this.ptr.Buttons.length}`),console.log(`N# of drags= ${this.ptr.DragDrops.length}`),console.log(`Mouse pointer = ${this.ptr}`)}}),i.pointer(),t.touchDevice||n.addEvent([["keyup",window,o,!1],["keydown",window,a,!1]]),i}const u=20,p=100;const g={LEFT:37,RIGHT:39,UP:38,DOWN:40,ZERO:48,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,ENTER:13,ESC:27,BACKSPACE:8,TAB:9,SHIFT:16,CTRL:17,ALT:18,SPACE:32,HOME:36,END:35,PGGUP:33,PGDOWN:34,isPaused:()=>d().pauseInput,resume(){d().pauseInput=!1},pause(){d().pauseInput=!0},dbg(){d().dbg()},_cur:()=>d(),resize(){d().resize()},reset(){d().reset()},setKeyOn(t){let e=d().keyInputs.get(t);e||(e={},d().keyInputs.set(t,e)),e.state=!0},setKeyOff(t){let e=d().keyInputs.get(t);e||(e={},d().keyInputs.set(t,e)),e.state=!1},keybd:(t,e,i)=>d().keybd(t,e,i),undoButton:t=>(n.disj(d().ptr.Buttons,t),t.m5.button=!1,t),makeButton:(t,e=!1)=>(n.conj(d().ptr.Buttons,t),t.m5.button=!0,t.m5.gui=e,t),undoHotspot:t=>(n.disj(d().ptr.Hotspots,t),t.m5.hotspot=!1,t),makeHotspot:t=>(n.conj(d().ptr.Hotspots,t),t.m5.hotspot=!0,t),undoXXX(t){t&&t.m5&&(t.m5.drag&&this.undoDrag(t),t.m5.button&&this.undoButton(t),t.m5.hotspot&&this.undoHotspot(t))},update(t){d().update(t)},makeDrag:t=>(n.conj(d().ptr.DragDrops,t),t.m5.drag=!0,t),undoDrag:t=>(n.disj(d().ptr.DragDrops,t),t.m5.drag=!1,t),keyUp(t){return!this.keyDown(t)},keyDown(t){let i=d().keyInputs.get(t);return i&&i.state?i:e},pointer:()=>d().pointer(),dispose(){a.forEach((t=>t.dispose())),a.length=0},restore(){a.length>1&&(a.shift().dispose(),d().pauseInput=!1)},save(){a.unshift(c())},on:(...e)=>(n.assert(r.vec(e[0])&&r.str(e[0][0]),"bad arg for Input.on()"),e[0][0]=`${d().yid}/${e[0][0]}`,t.on(...e)),off:(...e)=>(n.assert(r.vec(e[0])&&r.str(e[0][0]),"bad arg for Input.off()"),e[0][0]=`${d().yid}/${e[0][0]}`,t.off(...e))};return t.canvas.style.touchAction="none",g.undoBtn=g.undoButton,g.mkBtn=g.makeButton,g.mkDrag=g.makeDrag,a.push(c()),t.Input=g}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Input"]=function(t){return t.Input?t.Input:i(t)}}(this),function(t,e){"use strict";function i(t){const e=Math.PI/8,i=3*e,s=5*e,n=7*e,{Sprites:r,Input:o,is:a,ute:h}=t,l=Math.sin,d=Math.cos,c=Math.abs,u=180/Math.PI;function p(r){function a(t){let e=t.target,i=t.changedTouches;i?(t=i[0],r.m5.touchId=i[0].identifier):r.m5.touchId=0,r.m5.startX=t.pageX-e.offsetLeft,r.m5.startY=t.pageY-e.offsetTop,r.m5.drag=!0,r.m5.static||(r.visible=!0,r.x=r.m5.startX,r.y=r.m5.startY),o.isPaused()||r.m5.onStart()}function p(t){r.m5.drag&&(r.m5.inner.position.set(0,0),r.m5.drag=!1,r.m5.static||(r.visible=!1),o.isPaused()||r.m5.onEnd())}function g(a){if(o.isPaused()||!r.visible||!r.m5.drag)return;let p,g=a.target;if(a.changedTouches){for(let t=0,e=a.changedTouches;t<e.length;++t)if(r.m5.touchId==e[t].identifier){p=[e[t].pageX-g.offsetLeft,e[t].pageY-g.offsetTop];break}}else p=[a.pageX-g.offsetLeft,a.pageY-g.offsetTop];let m,f,y,x=0,v=p?p[0]-r.m5.startX:0,w=p?p[1]-r.m5.startY:0,b=r.m5.range;if(p[0]=0,p[1]=0,!h.feq0(v)||!h.feq0(w)){if(f=c(v),y=c(w),h.feq0(v))p[0]=0,w>0?(p[1]=w>b?b:w,x=270,m=t.DOWN):(p[1]=-(y>b?b:y),x=90,m=t.UP);else if(h.feq0(w))p[1]=0,v>0?(p[0]=f>b?b:f,x=0,m=t.RIGHT):(p[0]=-(f>b?b:f),x=180,m=t.LEFT);else{let r=Math.atan(c(w/v));x=r*u,p[0]=p[1]=0,v*v+w*w>=b*b?(p[0]=b*d(r),p[1]=b*l(r)):(p[0]=f>b?b:f,p[1]=y>b?b:y),w<0&&(p[1]=-c(p[1])),v<0&&(p[0]=-c(p[0])),v>0&&w<0||(v<0&&w<0?x=180-x:v<0&&w>0?x+=180:v>0&&w>0&&(x=360-x)),m=function(r,o){const a=Math.atan2(+o,+r);return a>-s&&a<-i?(t.CON.log("calcDir=UP"),t.UP):a>i&&a<s?(t.CON.log("calcDir=DOWN"),t.DOWN):a>-e&&a<0||a>0&&a<e?(t.CON.log("calcDir=RIGHT"),t.RIGHT):a>n&&a<Math.PI||a>-Math.PI&&a<-n?(t.CON.log("calcDir=LEFT"),t.LEFT):a>e&&a<i?(t.CON.log("calcDir= SE "),t.SE):a>s&&a<n?(t.CON.log("calcDir= SW "),t.SW):a>-i&&a<-e?(t.CON.log("calcDir= NE "),t.NE):a>-n&&a<-s?(t.CON.log("calcDir= NW "),t.NW):void h.assert(!1,"Failed Joystick calcDir")}(p[0],p[1])}r.m5.inner.position.set(p[0],p[1]),r.m5.onChange(m,x)}}const m=[["mousemove",t.canvas,g],["mousedown",t.canvas,a],["mouseup",window,p],["touchend",window,p],["touchcancel",window,p],["touchmove",t.canvas,g],["touchstart",t.canvas,a]];return h.addEvent(m),r.m5.dispose=()=>{h.delEvent(m)},r}const g={assets:["boot/joystick.png","boot/joystick-handle.png"],joystick(t){let e=r.sprite("boot/joystick-handle.png"),i=r.sprite("boot/joystick.png"),s=new PIXI.Container,n=h.inject({oscale:.7,iscale:1,inner:e,outer:i,onEnd(){},onStart(){},prevDir:0,static:!1,onChange(t,e){}},t);return r.scaleXY(i,n.oscale,n.oscale),r.scaleXY(e,n.iscale,n.iscale),i.anchor.set(.5),e.anchor.set(.5),s.addChild(i),s.addChild(e),n.range=s.width/2.5,n.static||(s.visible=!1),s.m5=n,p(s)}};return t.Touch=g}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Touch"]=function(t){return t.Touch?t.Touch:i(t)}}(this),function(t,e){"use strict";function i(t){const e=[t.UP,t.LEFT,t.RIGHT,t.DOWN],{ute:i,is:s,v2:n,math:r}=t,o=Math.abs,a=Math.ceil,h=Math.floor;function l(t,e,i){return function(t,e,i,s,n){if(t<0||e<0)throw`IndexError: ${t},${e}, wanted +ve values`;return r.ndiv(t,i)+r.ndiv(e,s)*n}(t,e,i.tiled.tileW,i.tiled.tileH,i.tiled.tilesInX)}function d(e,i){return n.vecAB(t.Sprites.centerXY(e),t.Sprites.centerXY(i))}function c(t){let e=t.image,i=e&&e.split("/");t.image=i&&i.length&&i[i.length-1]}function u(t,e){let i=-1;if(t>0)for(i=0;e[i+1]&&t>=e[i+1][0];)++i;return i>=0?e[i]:[]}function p(t,e,s){let n=[];return t.forEach((t=>{n.push([t.firstgid,t]),t.spacing||(t.spacing=0),c(t);let r={};(t.tiles||[]).forEach((e=>{let n=i.selectNotKeys(e,"properties");n=i.inject(n,g(e)),n.gid=t.firstgid+e.id,r[e.id]=n,s[n.gid]=n})),e[t.name]=r})),n.sort(((t,e)=>t[0]>e[0]?1:t[0]<e[0]?-1:0))}function g(t){return(t.properties||[]).reduce(((t,e)=>(t[e.name]=e.value,t)),{})}function m(e,n,o,a){let h={},l={},d=s.str(n)?function(e){let s=t.resource(e,!0).data,n=s&&(s.tiledversion||s.version);return n&&i.cmpVerStrs(n,"1.4.2")>=0?s:i.assert(!1,`${e} needs update`)}(n):n;i.assert(s.obj(d),"bad tiled map"),d=JSON.parse(JSON.stringify(d)),i.inject(e.tiled,{tileW:d.tilewidth,tileH:d.tileheight,tilesInX:d.width,tilesInY:d.height,tiledMap:d,saved_tileW:d.tilewidth,saved_tileH:d.tileheight,tiledWidth:d.tilewidth*d.width,tiledHeight:d.tileheight*d.height},g(d));let m=a||e.getScaleFactor(),y=i.evenN(m*d.tileheight),x=i.evenN(m*d.tilewidth);e.tiled.new_tileW=x,e.tiled.new_tileH=y,a&&(e.tiled.scale=a);const v={imagelayer(t){c(t)},tilelayer(t){s.vec(t.data[0])&&(t.width=t.data[0].length,t.height=t.data.length,t.data=t.data.flat()),t.width||(t.width=e.tiled.tilesInX),t.height||(t.height=e.tiled.tilesInY);let i,n=g(t);if(!1!==t.visible)for(let i,s=0;s<t.data.length;++s){if(0==(i=t.data[s]))continue;!1===t.collision||!1===n.collision||!0!==t.collision&&!0!==n.collision||(i>0&&(e.tiled.collision[s]=i),t.collision=!0);let a=s%t.width,h=r.ndiv(s,t.width),d=l[i],c=d&&d.Class,p=c&&o[c],g=u(i,e.tiled.tileGidList)[1],m=f(e,i,a,h,n.width,n.height);m&&(m.tiled.layer=t,m.tiled.index=s,m.m5.static=!0),p&&(m=p.c(e,m,g,d)),m&&(e.insert(m,!!p),d&&d.sensor&&(m.m5.sensor=!0))}else(i=n.Class)&&o[i](e,t)},objectgroup(t){t.sprites=[],t.objects.forEach((n=>{i.assert(s.num(n.x),"wanted xy position");let a,h,d=g(n),c=i.nor(n.gid,-1);i.inject(n,d),c>0&&(h=l[c]);let p=i.nor(h&&h.Class,n.Class),m=p&&o[p],v=e.tiled.saved_tileW,w=e.tiled.saved_tileH,b=r.ndiv(n.x+v/2,v),I=r.ndiv(n.y-w/2,w),T=u(c,e.tiled.tileGidList)[1];n.column=b,n.row=I,a=c<=0?{width:x,height:y}:f(e,c,b,I,n.width,n.height,p),m&&(a=m.c(e,a,T,h,n)),a&&(!1===n.visible&&(a.visible=!1),n.uuid=a.m5.uuid,t.sprites.push(a),e.insert(a,!0),h&&h.sensor&&(a.m5.sensor=!0))}))}};o=i.nor(o,{}),i.inject(e.tiled,{objFactory:o,tileSets:h,tileProps:l,collision:i.fill(d.width*d.height,0),imagelayer:[],objectgroup:[],tilelayer:[],tileGidList:p(d.tilesets,h,l)}),["imagelayer","tilelayer","objectgroup"].forEach((t=>{d.layers.filter((e=>e.type==t)).forEach((i=>{v[t](i),e.tiled[t].push(i)}))})),e.tiled.tileW=x,e.tiled.tileH=y,e.tiled.tiledWidth=x*d.width,e.tiled.tiledHeight=y*d.height,e.parent instanceof t.Scenes.SceneWrapper&&(e.tiled.tiledHeight<t.height&&(e.parent.y=r.ndiv(t.height-e.tiled.tiledHeight,2)),e.tiled.tiledWidth<t.width&&(e.parent.x=r.ndiv(t.width-e.tiled.tiledWidth,2)))}function f(e,n,o,a,h,l,d){let c,p=u(n,e.tiled.tileGidList)[1],g=(i.assert(p,"Bad GID, no tileset"),p.columns),m=n-p.firstgid,f=e.tiled.tileProps[n],y=e.tiled.scale||e.getScaleFactor();c=(d=i.nor(d,f&&f.Class))&&e.tiled.objFactory[d],i.assertNot(m<0,`Bad tile id: ${m}`),s.num(g)||(g=r.ndiv(p.imagewidth,p.tilewidth+p.spacing));let x=m%g,v=r.ndiv(m,g),w=x*p.tilewidth,b=v*p.tileheight;p.spacing>0&&(w+=p.spacing*x,b+=p.spacing*v);let I=c&&c.s(e)||t.Sprites.frame(p.image,h||p.tilewidth,l||p.tileheight,w,b);return I&&(I.tiled={id:m,gid:n},h==e.tiled.saved_tileW?I.width=e.tiled.new_tileW:(I.scale.x=y,I.width=i.evenN(I.width)),l==e.tiled.saved_tileH?I.height=e.tiled.new_tileH:(I.scale.y=y,I.height=i.evenN(I.height)),I.x=o*e.tiled.new_tileW,I.y=a*e.tiled.new_tileH),I}const y=t.Sprites.lift({width:0,height:0,parent:null,x:0,y:0,rotation:0,tiled:{},anchor:{x:0,y:0},getGlobalPosition(){return{x:this.x+this.parent.x,y:this.y+this.parent.y}}});class x extends t.Scenes.Scene{constructor(t,e,i){super(t,e,i),this.tiled={}}reloadMap(t){this.tiled={},this.m5.options.tiled=t,m(this,t.name,t.factory,t.scale)}runOnce(){const t=this.m5.options.tiled;m(this,t.name,t.factory,t.scale),super.runOnce()}removeTile(e,i){let{x:s,y:n}=i;i.anchor.x<.3&&(n=i.y+r.ndiv(i.height,2),s=i.x+r.ndiv(i.width,2));let o=r.ndiv(s,this.tiled.tileW),a=r.ndiv(n,this.tiled.tileH),h=this.getTileLayer(e),l=o+a*this.tiled.tilesInX;h.data[l]=0,h.collision&&(this.tiled.collision[l]=0),t.Sprites.remove(i)}getTileLayer(t,e){let s=i.some(this.tiled.tilelayer,(e=>{if(e.name==t)return e}));if(!s&&e)throw`There is no layer with name: ${t}`;return s}getObjectGroup(t,e){let s=i.some(this.tiled.objectgroup,(e=>{if(e.name==t)return e}));if(!s&&e)throw`There is no group with name: ${t}`;return s}setTile(t,e,i,s){let n,r=this.getTSInfo(s),o=(r.firstgid,this.getTileLayer(t)),a=i+this.tiled.tilesInX*e;return o.collision&&(this.tiled.collision[a]=s),n=f(this,s,i,e,r.tilewidth,r.tileheight),n&&(n.tiled.index=a,n.tiled.layer=o),n}getTile(t){let{x:e,y:i}=t;return t.anchor.x<.3&&(i+=r.ndiv(t.height,2),e+=r.ndiv(t.width,2)),this.getTileXY(e,i)}getTileXY(t,e){let s=r.ndiv(t,this.tiled.tileW),n=r.ndiv(e,this.tiled.tileH);return i.assert(s>=0&&s<this.tiled.tilesInX,`bad tile col:${s}`),i.assert(n>=0&&n<this.tiled.tilesInY,`bad tile row:${n}`),[s,n]}getNamedItem(t){let e=[];return this.tiled.objectgroup.forEach((s=>{s.objects.forEach((s=>{t==i.get(s,"name")&&e.push(s)}))})),e}getScaleFactor(){let e,i,s=1;return"max"==t.u.scaleToWindow&&(t.width>t.height?(i=t.height/(this.tiled.saved_tileH*this.tiled.tilesInY),s=i):(e=t.width/(this.tiled.saved_tileW*this.tiled.tilesInX),s=e)),s}getTileIndex(e){let[i,s]=t.Sprites.centerXY(e);return l(i,s,this)}getTSInfo(t){return u(t,this.tiled.tileGidList)[1]}getTileProps(t){return this.tiled.tileProps[t]}_getContactObj(t,e,i){let s=y;return s.height=this.tiled.tileH,s.width=this.tiled.tileW,s.x=e*s.width,s.y=i*s.height,s.tiled.gid=t,s.tiled.row=i,s.tiled.col=e,s.m5.sensor=!1,s}collideXY(e){let n=t.Sprites,o=this.tiled.tileW,h=this.tiled.tileH,l=this.tiled.collision,d=i.feq0(e.angle)?n.getAABB(e):n.boundingBox(e),c=Math.max(0,r.ndiv(d.x1,o)),u=Math.max(0,r.ndiv(d.y1,h)),p=Math.min(this.tiled.tilesInX-1,a(d.x2/o)),g=Math.min(this.tiled.tilesInY-1,a(d.y2/h));for(let r,o,a,h,d=u;d<=g;++d)for(let u=c;u<=p;++u)a=d*this.tiled.tilesInX+u,o=l[a],s.num(o)||i.assert(s.num(o),"bad gid"),0!=o&&(h=this._getContactObj(o,u,d),r=this.getTileProps(o),r&&(h.m5.sensor=!!r.sensor),h.parent=this,n.hit(e,h)&&h.m5.sensor&&t.emit(["bump.sensor",e],h));return super.collideXY(e)}}class v{constructor(t,e){this.straightCost=t,this.diagonalCost=e}manhattan(t,e){return o(t.row-e.row)*this.straightCost+o(t.col-e.col)*this.straightCost}euclidean(t,e){let s=e.col-t.col,n=e.row-t.row;return h(i.sqrt(s*s+n*n)*this.straightCost)}diagonal(t,e){let i=o(e.col-t.col),s=o(e.row-t.row);return h(i>s?this.diagonalCost*s+this.straightCost*(i-s):this.diagonalCost*i+this.straightCost*(s-i))}}const w={TiledScene:x,neighborCells(t,e,i){let s=e.tiled.tilesInX,n=[t-s-1,t-s,t-s+1,t-1],r=[t+1,t+s-1,t+s,t+s+1];return i||n.push(t),n.concat(r)},updateMap(t,e,n){let r=i.fill(t.length,0),o=t=>{let e=this.getTileIndex(t,n);i.assert(e>=0&&e<r.length,"tiled index outofbound"),t.tiled.index=e,r[e]=t.tiled.gid};return s.vec(e)?e.forEach(o):o(e),r},shortestPath(t,e,i,s,n=[],o="manhattan",a=!0){let h=s.tiled.tilesInX,l=i.map(((t,e)=>({f:0,g:0,h:0,parent:null,index:e,col:e%h,row:r.ndiv(e,h)}))),d=l[e],c=l[t],u=c,p=[u],g=[],m=[],f=t=>(a?this.neighborCells(t,s,!0):this.crossCells(t,s)).map((t=>l[t])).filter((e=>{if(e){let s=t%h==0,r=(t+1)%h==0,o=e.col%(h-1)==0&&0!=e.col,a=e.col%h==0,l=n.some((t=>i[e.index]==t));return s?!o:r?!a:!l}}));for(;u!==d;){let t=f(u.index);for(let e,i,s,n,r,a=0;a<t.length;++a){r=t[a],n=14,u.row!=r.row&&u.col!=r.col||(n=10),i=u.g+n,e=i+new v(10,14)[o](r,d);let h=p.some((t=>r===t)),l=g.some((t=>r===t));h||l?r.f>e&&(r.f=e,r.g=i,r.h=s,r.parent=u):(r.f=e,r.g=i,r.h=s,r.parent=u,p.push(r))}if(g.push(u),0==p.length)return m;p=p.sort(((t,e)=>t.f-e.f)),u=p.shift()}if(0!=p.length){let t=d;for(m.push(t);t!==c;)t=t.parent,m.unshift(t)}return m},lineOfSight(e,i,s,o,a=0,c=32,u=[]){let p,g,m,f,y,x,v=d(e,i),w=n.len(v),b=r.ndiv(w,c),I=[];for(let i,s=1;s<=b;++s)i=t.Sprites.centerXY(e),g=c*s,y=v[0]/w,x=v[1]/w,m=h(i[0]+y*g),f=h(i[1]+x*g),I.push({x:m,y:f,index:l(m,f,o)});return p=180*Math.atan2(v[1],v[0])/Math.PI,I.every((t=>s[t.index]==a))&&(0==u.length||u.some((t=>t==p)))},crossCells(t,e){const i=e.tiled.tilesInX;return[t-i,t-1,t+1,t+i]},getCrossTiles(t,e,i){return this.crossCells(t,i).map((t=>e[t]))},getDiagonalCells(t,e){const i=s.num(e)?e:e.tiled.tilesInX;return[t-i-1,t-i+1,t+i-1,t+i+1]},getDiagonalTiles(t,e,i){return this.getDiagonalCells(t,i).map((t=>e[t]))},validDirections(i,s,n,r){const o=this.getTileIndex(i,r);return this.getCrossTiles(o,s,r).map(((i,s)=>i==n?e[s]:t.NONE)).filter((e=>e!==t.NONE))},canChangeDirection(e=[]){let i=e.find((e=>e===t.UP)),s=e.find((e=>e===t.DOWN)),n=e.find((e=>e===t.LEFT)),r=e.find((e=>e===t.RIGHT));return 0==e.length||1==e.length||(i||s)&&(n||r)},randomDirection:(e=[])=>0==e.length?t.NONE:1==e.length?e[0]:e[i.randInt2(0,e.length-1)],closestDirection(e,i){const s=d(e,i);return o(s[0])<o(s[1])?s[1]<=0?t.UP:t.DOWN:s[0]<=0?t.LEFT:t.RIGHT}};return t.Tiles=w}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Tiles"]=function(t){return t.Tiles?t.Tiles:i(t)}}(this);