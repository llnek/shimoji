!function(t,e){"use strict";const i=["jpg","png","jpeg","gif"],s=["ttf","otf","ttc","woff"],n=["mp3","wav","ogg"],r=1/15;function o(o,a,l,h){const{EventBus:c,dom:d,is:u,u:p}=t["io/czlab/mcfud/core"](),m=t["io/czlab/mcfud/vec2"](),g=t["io/czlab/mcfud/math"](),f=c(),x=Math.floor,y=console;let v=!1;class w extends PIXI.Container{constructor(){super(),this.m5={stage:!0}}onResize(t,e){this.children.forEach((i=>{i instanceof t.Scenes.SceneWrapper&&(i=i.children[0]),i.onCanvasResize(e)})),t.Input.resize()}}p.patch(o,{assetFiles:[],logos:[],aniFps:12,fps:60});const b=()=>t.innerHeight,T=()=>t.innerWidth;function I(t){const e=new F.Scenes.Scene("loader",{setup(){t.init.call(this)}},{});return F.stage.addChild(e),e.runOnce(),e}function S(t,e,i,s){const{Sound:r}=t;let o,a=0;function h(){l.forEach((t=>d.css(t,"display","none"))),e&&t.delBgTask(e),p.delay(0,(()=>{t.Scenes.remove(i),s?p.error("Cannot load game!"):t.u.start(t)}))}function c(t){0==--a&&h()}s||p.doseq(t.assets,((t,e)=>{o=p.fileExt(e),p.has(n,o)&&(a+=1,r.decodeData(t.name,t.url,t.xhr.response,c))})),0==a&&h()}function _(t){let e=p.map(t.u.assetFiles,(e=>t.assetPath(e))),i=p.findFiles(e,s);const{PXLR:r,PXLoader:o}=t;let h,c,m,g;if(i.forEach((t=>{g=d.newElm("style"),m=d.newElm("span"),h=t.split("/").pop().split(".")[0],c=`@font-face {font-family: '${h}'; src: url('${t}');}`,a.push(h),d.conj(g,d.newTxt(c)),d.conj(document.head,g),m.innerHTML="?",d.css(m,"fontFamily",h),d.conj(document.body,m),d.css(m,{display:"block",opacity:"0"}),l.push(m)})),n.forEach((t=>{r.setExtensionLoadType(t,r.LOAD_TYPE.XHR),r.setExtensionXhrType(t,r.XHR_RESPONSE_TYPE.BUFFER)})),o.reset(),e.length>0){let i=t.u.load;i||(i=function(t){const{Sprites:e}=t;return{init(){let i=e.sprite("boot/ZotohLab_x1240.png"),s=e.sprite("boot/preloader_bar.png"),[n,r]=t.scaleXY([i.width,i.height],[t.width,t.height]),o=t.getScaleFactor(),a=n>r?r:n;a*=.2,e.scaleXY(s,a,a),e.scaleXY(i,a,a),e.pinCenter(this,i),e.pinBelow(i,s,4*o),e.hide(s),this.g.pbar=s,this.g.pbar_width=s.width,this.insert(i),this.insert(s)},update(t,i){!this.g.pbar.visible&&e.show(this.g.pbar),this.g.pbar.width=this.g.pbar_width*(i/100)}}}(t));let s=0,n=[],r=[],a=I(i);o.add(e),o.onError.add(((t,e,i)=>{++s,y.log(`${t}`)})),o.onProgress.add(((t,e)=>{y.log(`loading ${e.url}`),n.unshift(e.url),r.unshift(t.progress)})),o.load((()=>{0==s&&y.log("asset loaded!"),n.unshift("$")})),t.addBgTask({update(){let e=n.pop(),o=r.pop();u.num(o)&&e&&"$"!=e&&i.update.call(a,e,o),"$"==e&&S(t,this,a,s>0)}})}else S(t);return t.start()}const P={width:0,height:0},E={width:1,height:1};function C(t){const e=d.newElm("style");d.conj(document.body,F.canvas),d.conj(e,d.newTxt("body, * {padding: 0; margin: 0; height:100%; overflow:hidden}")),d.conj(document.head,e);d.css(F.canvas,{outline:"none"}),d.attrs(F.canvas,"tabindex","0")}const X=p.jsMap();function D(t){F._curFPS=F.calcFPS(t),h.forEach((e=>e.update&&e.update(t))),v||F.stageCS((e=>e.update&&e.update(t)))}const M=e=>t.requestAnimationFrame(e);class O{constructor(t){this.uid=t}playSound(){}uuid(){return this.uid}pokeMove(){this.onPoke()}pokeWait(){this.onWait()}stateValue(){p.assert(!1,"implement stateValue!")}}const F={_offsetX:0,_offsetY:0,_scaleX:1,_scaleY:1,_selectedCellX:0,_selectedCellY:0,_startPanX:0,_startPanY:0,_curFPS:60,Bot:class extends O{constructor(t="p2"){super(t)}onPoke(){}onWait(){}},Local:class extends O{constructor(t="p1"){super(t)}onPoke(){F.Input.resume()}onWait(){F.Input.pause()}},Mediator:class{constructor(){this.players=[],this.state,this.pcur,this.end,this.pwin,this._pcnt=0}cur(){return this.pcur}add(t){return t.pnum=++this._pcnt,t.owner=this,this.players.push(t),this}winner(){return this.pwin}isGameOver(){return this.end}gameState(t){return t&&(this.state=t),this.state}gameOver(t){return F.Input.resume(),this.pwin=t,this.end=!0}start(t){p.assert(t,"bad player to start with"),this.end=!1,this.pcur=t,this._turn()}other(){return this.pcur===this.players[0]?this.players[1]:this.pcur===this.players[1]?this.players[0]:void 0}_turn(){this.players.forEach((t=>{t!==this.pcur&&t.pokeWait()})),this.pcur.pokeMove()}redoTurn(){this.pcur.pokeMove()}postMove(t,e){p.assert(!1,"implement postMove!")}updateState(t,e){p.assert(!1,"implement updateState!")}updateSound(t){}updateMove(t,e){this.end||(this.updateState(t,e),this.updateSound(t),p.delay(0,(()=>this.postMove(t,e))))}takeTurn(){this.end||(this.pcur===this.players[0]?this.pcur=this.players[1]:this.pcur===this.players[1]&&(this.pcur=this.players[0]),this._turn())}},EVERY:1,SOME:2,CENTER:3,TOP:4,LEFT:5,RIGHT:6,BOTTOM:7,UP:8,DOWN:9,NW:10,NE:11,SW:12,SE:13,NONE:100,PI_45:Math.PI/4,PI_90:Math.PI/2,PI_180:Math.PI,PI_270:1.5*Math.PI,PI_360:2*Math.PI,v2:m,math:g,ute:p,is:u,dom:d,u:o,Game:{mode:1},MODE_ONE:1,MODE_TWO:2,MODE_NET:3,CON:console,noop:()=>{},PXContainer:PIXI.Container,PXGraphics:PIXI.Graphics,PXTexture:PIXI.Texture,PXFilters:PIXI.filters,PXLR:PIXI.LoaderResource,PXLoader:PIXI.Loader.shared,PXObservablePoint:PIXI.ObservablePoint,accel:(t,e,i)=>t+e*i,on:(...t)=>f.sub(...t),emit:(...t)=>f.pub(...t),off:(...t)=>f.unsub(...t),sideRight:t=>t===F.RIGHT||t===F.NE||t===F.SE,sideLeft:t=>t===F.LEFT||t===F.NW||t===F.SW,sideTop:t=>t===F.UP||t===F.TOP||t===F.NW||t===F.NE,sideBottom:t=>t===F.DOWN||t===F.BOTTOM||t===F.SW||t===F.SE,overlap:(t,e)=>!(t.x2<e.x1||e.x2<t.x1||t.y2<e.y1||e.y2<t.y1),overlapX:(t,e)=>t.x2>e.x1&&e.x2>t.x1,overlapY:(t,e)=>t.y2>e.y1&&e.y2>t.y1,hasClass(t,e){if(e)return t.classList.contains(e)},toggleClass:(t,e)=>(e&&t.classList.toggle(e),t),addClass:(t,e)=>(p.hasClass(t,e)||t.classList.add(e),t),removeClass:(t,e)=>(p.hasClass(t,e)&&t.classList.remove(e),t),wrapv:(t,e,i)=>t<e?i:t>i?e:t,defMixin(t,e){if(p.has(X,t))throw`MixinError: "${t}" already defined.`;p.assert(u.fun(e),"mixin must be a function"),p.assoc(X,t,e)},addMixin:(t,e,...i)=>function(t,e,i,...s){return p.assert(!p.has(t,e),`Fatal: mixin ${e} unavailable.`),t[e]=i(t,...s),t}(t,e,X.get(e),...i),get assets(){return PIXI.Loader.shared.resources},get designSize(){return this.u.arena},get width(){return this.canvas.width},get height(){return this.canvas.height},stageCS(t){F.stage.children.forEach((e=>{e instanceof F.Scenes.SceneWrapper&&(e=e.children[0]),e instanceof PIXI.SimpleRope||t(e)}))},scroll(e,i){t.scrollTo(e||0,i||1)},portrait:()=>F.height>F.width,screenCenter:()=>p.v2(g.ndiv(F.width,2),g.ndiv(F.height,2)),scaleXY:(t,e)=>[e[0]/t[0],e[1]/t[1]],makeAnchor(t,e){return new F.PXObservablePoint(F.noop,this,t,e)},mockStage(t=0,e=0,i,s){let n=u.obj(t)?t:{x:t,y:e,width:p.nor(i,F.width),height:p.nor(s,F.height)};return n.getGlobalPosition=()=>({x:this.x,y:this.y}),n.anchor=F.makeAnchor(0,0),n.m5={stage:!0},n},getIndex(t,e,i,s,n){if(t<0||e<0)throw`IndexError: ${t},${e}, wanted +ve values`;return g.ndiv(t,i)+g.ndiv(e,s)*n},tcached(t){return p.inst(this.PXTexture,t)?t:u.str(t)?PIXI.utils.TextureCache[t]||PIXI.utils.TextureCache[this.assetPath(t)]:e},clickPlayMsg(){return(this.touchDevice?"Tap":"Click")+" to Play!"},splitXY:(t,e)=>[t%e,g.ndiv(t,e)],rect:(t,e,i,s)=>new F.PXRectangle(t,e,i,s),scaleSZ:(t,e)=>({width:e.width/t.width,height:e.height/t.height}),id(t){return this.image(t)},image(t){return this.tcached(t)||p.assert(!1,`${t} not loaded.`)},xml(t){return(this.assets[t]||p.assert(!1,`${t} not loaded.`)).data},json(t){return(this.assets[t]||p.assert(!1,`${t} not loaded.`)).data},assetPath(t){if(t.includes("/"))return t;let e="data",r=p.fileExt(t);return p.has(i,r)?e="images":"fnt"==r||p.has(s,r)?e="fonts":p.has(n,r)&&(e="audio"),`${e}/${t}`},contentScaleFactor(){return P.height=F.height,P.width=F.width,"max"!==o.scaleToWindow?E:this.scaleSZ(this.designSize,P)},getScaleFactor(t){if(t||"max"==o.scaleToWindow){P.height=F.height,P.width=F.width;let t=this.scaleSZ(this.designSize,P);return"x"==o.scaleFit?t.width:"y"==o.scaleFit?t.height:Math.min(t.width,t.height)}return 1},resource(t,i){return(t?this.assets[t]||this.assets[this.assetPath(t)]:null)||(i?p.assert(!1,`no such resource ${t}.`):e)},fpsList:e,fpsSum:0,calcFPS(t){let e,i=0;return t>0&&(e=g.ndiv(1,t),this.fpsList||(this.fpsList=p.fill(60,e),this.fpsSum=60*e),this.fpsSum-=this.fpsList.pop(),this.fpsList.unshift(e),this.fpsSum+=e,i=g.ndiv(this.fpsSum,60)),i},degToRad:t=>t*(Math.PI/180),radToDeg:t=>t*(180/Math.PI),addBgTask(t){h.push(t)},delBgTask(t){t&&(t.dispose&&t.dispose(),p.disj(h,t))},resume(){v=!1},pause(){v=!0},start(){let t=0,e=p.now(),i=F.frame,s=function(){let n=p.now(),o=(n-e)/1e3;for(o>r&&(o=r),t+=o;t>=i;t-=i)D(o);F.ctx.render(F.stage),e=n,M(s)};return M(s)},takeScreenshot(){F.ctx.extract.canvas(F.stage).toBlob((t=>{const e=document.createElement("a");document.body.append(e),e.download="screenshot",e.href=URL.createObjectURL(t),e.click(),e.remove()}),"image/png")},worldToScreen(t,e){return[x((t-this._offsetX)*this._scaleX),x((e-this._offsetY)*this._scaleY)]},screenToWorld(t,e){return[t/this._scaleX+this._offsetX,e/this._scaleY+this._offsetY]}};return function(e){let i=e.stage=new w,s=o.arena,n=!1;return p.assert(s,"design resolution req'd."),"max"!=o.scaleToWindow&&!0!==o.scaleToWindow||(n=!0,s={width:T(),height:b()},1==o.arena.scale&&(n=!1,o.arena=s,o.scaleToWindow="win")),o.logos||(o.logos=new Array),e.touchDevice=!!("ontouchstart"in document),e.ctx=PIXI.autoDetectRenderer(p.inject(s,{antialias:!0})),e.canvas=e.ctx.view,e.canvas.id="mojo",e.maxed=n,e.scale=1,e.frame=1/o.fps,e.scaledBgColor="#5A0101",["Sprites","Input","Scenes","Sound","FX","Arcade","Tiles","Touch"].forEach((i=>{y.log(`installing module ${i}...`);let s=t[`io/czlab/mojoh5/${i}`](e);s.assets&&s.assets.forEach((t=>e.u.assetFiles.unshift(t)))})),h.push(e.FX,e.Input),C(),p.has(o,"border")&&d.css(e.canvas,"border",o.border),p.has(o,"bgColor")&&(e.ctx.backgroundColor=e.Sprites.color(o.bgColor)),!0===o.resize&&(p.addEvent("resize",t,p.debounce((()=>{const[t,i]=[e.width,e.height];e.ctx.resize(T(),b()),e.emit(["canvas.resize"],[t,i])}),o.debounceRate||150)),e.on(["canvas.resize"],(t=>i.onResize(e,t)))),e.mouse=e.Input.pointer(),e.touchDevice&&e.scroll(),e.canvas.focus(),function(t){const{PXLoader:e}=t;t.u.load||(t.u.logos=["boot/preloader_bar.png","boot/ZotohLab_x1240.png"]);let i=0,s=t.u.logos.map((e=>t.assetPath(e)));return 0==s.length?_(t):(e.reset(),e.add(s),e.onError.add(((t,e,s)=>{++i,y.log(`${t}`)})),e.load((()=>{0==i?(p.delay(0,(()=>_(t))),y.log("logo files loaded.")):y.log("logo files not loaded!")}))),t}(e)}(F)}if("object"==typeof module&&module.exports)throw"Panic: browser only!";t.MojoH5=function(t){return o(t,[],[],[])}}(this),function(t,e){"use strict";function i(e){const{Stack:i,StdCompare:s}=t["io/czlab/mcfud/algo_basic"](),n=t["io/czlab/mcfud/math"](),{is:r,ute:o}=e;Math.floor;class a{constructor(t,e){o.assert(t<=e,"bad interval1D"),o.feq0(t)&&(t=0),o.feq0(e)&&(e=0),this.min=t,this.max=e}min(){return this.min}max(){return this.max}intersects(t){return!(this.max<t.min||t.max<this.min)}contains(t){return this.min<=t&&t<=this.max}length(){return this.max-this.min}static MinEndpointComparator(t,e){return t.min<e.min?-1:t.min>e.min?1:t.max<e.max?-1:t.max>e.max?1:0}static MaxEndpointComparator(t,e){return t.max<e.max?-1:t.max>e.max?1:t.min<e.min?-1:t.min>e.min?1:0}static LengthComparator(t,e){let i=t.length(),s=e.length();return i<s?-1:i>s?1:0}static test(){let t=[new a(15,33),new a(45,60),new a(20,70),new a(46,55)];console.log("Unsorted"),t.forEach((t=>console.log(`min=${t.min}, max=${t.max}`))),console.log("Sort by min endpoint"),t.sort(a.MinEndpointComparator),t.forEach((t=>console.log(`min=${t.min}, max=${t.max}`))),console.log("Sort by max endpoint"),t.sort(a.MaxEndpointComparator),t.forEach((t=>console.log(`min=${t.min}, max=${t.max}`))),console.log("Sort by length"),t.sort(a.LengthComparator),t.forEach((t=>console.log(`min=${t.min}, max=${t.max}`)))}}class l{static theta(t){return Math.atan2(t[1],t[0])}static angleTo(t,e){return Math.atan2(e[1]-t[1],e[0]-t[0])}static ccw(t,e,i){let s=(e[0]-t[0])*(i[1]-t[1])-(e[1]-t[1])*(i[0]-t[0]);return s<0?-1:s>0?1:0}static area2(t,e,i){return(e[0]-t[0])*(i[1]-t[1])-(e[1]-t[1])*(i[0]-t[0])}static distanceTo(t,e){let i=t[0]-e[0],s=t[1]-e[1];return Math.sqrt(i*i+s*s)}static distanceSquaredTo(t,e){let i=t[0]-e[0],s=t[1]-e[1];return i*i+s*s}static compareTo(t,e){return t[1]<e[1]?-1:t[1]>e[1]?1:t[0]<e[0]?-1:t[0]>e[0]?1:0}static XOrderComparator(t,e){return t[0]<e[0]?-1:t[0]>e[0]?1:0}static YOrderComparator(t,e){return t[1]<e[1]?-1:t[1]>e[1]?1:0}static ROrderComparator(t,e){let i=t[0]*t[0]+t[1]*t[1]-(e[0]*e[0]+e[1]*e[1]);return i<0?-1:i>0?1:0}static Atan2OrderComparator(t,e){let i=l.angleTo(t),s=l.angleTo(e);return i<s?-1:i>s?1:0}static PolarOrderComparator(t){return(e,i)=>{let s=e[0]-t[0],n=e[1]-t[1],r=i[0]-t[0],a=i[1]-t[1];return n>=0&&a<0?-1:a>=0&&n<0?1:o.feq0(n)&&o.feq0(a)?s>=0&&r<0?-1:r>=0&&s<0?1:0:-l.ccw(t,e,i)}}static DistanceToOrderComparator(t,e){let i=l.distanceSquaredTo(t),s=l.distanceSquaredTo(e);return i<s?-1:i>s?1:0}static equals(t,e){return e===t||!!e&&(t[0]==e[0]&&t[1]==e[1])}static farthestPair(t){let e,i=[0,0],s=[0,0],n=0,r=-1/0,o=l.calcConvexHull(t);if(!1===o||t.length<=1)return!1;if(e=o.length,o.unshift(null),2==e)i=o[1],s=o[2],n=l.distanceTo(i,s);else{let t,n=2;for(;l.area2(o[e],o[1],o[n+1])>l.area2(o[e],o[1],o[n]);)++n;t=n;for(let a,h=1;h<=n&&t<=e;++h)for(l.distanceSquaredTo(o[h],o[t])>r&&(r=l.distanceSquaredTo(o[h],o[t]),_V.copy(i,o[h]),_V.copy(s,o[t]));t<e&&l.area2(o[h],o[h+1],o[t+1])>l.area2(o[h],o[h+1],o[t]);)++t,a=l.distanceSquaredTo(o[h],o[t]),a>r&&(r=l.distanceSquaredTo(o[h],o[t]),_V.copy(i,o[h]),_V.copy(s,o[t]))}return{best1:i,best2:s,bestDistance:Math.sqrt(r)}}static closestPair(t){let e=[0,0],i=[0,0],s=1/0,r=t.slice();const a=t.length;r.sort(l.YOrderComparator),r.sort(l.XOrderComparator);for(let t=0;t<a-1;++t)if(l.equals(r[t],r[t+1]))return _V.copy(e,r[t]),_V.copy(i,r[t+1]),{bestDistance:0,best1:e,best2:i};let h=r.slice();return function t(r,o,a,h,c){if(c<=h)return 1/0;let d=h+n.ndiv(c-h,2),u=r[d],p=t(r,o,a,h,d),m=t(r,o,a,d+1,c),g=Math.min(p,m);!function(t,e,i,s,n){for(let s=i;s<=n;++s)_V.copy(e[s],t[s]);let r=i,o=s+1;for(let a=i;a<=n;++a)r>s?_V.copy(t[a],e[o++]):o>n?_V.copy(t[a],e[r++]):l.compareTo(e[o],e[r])<0?_V.copy(t[a],e[o++]):_V.copy(t[a],e[r++])}(o,a,h,d,c);let f=0;for(let t=h;t<=c;++t)Math.abs(o[t][0]-u[0])<g&&_V.copy(a[f++],o[t]);for(let t=0;t<f;++t)for(let n,r=t+1;r<f&&a[r][1]-a[t][1]<g;++r)n=l.distanceTo(a[t],a[r]),n<g&&(g=n,n<s&&(s=g,_V.copy(e,a[t]),_V.copy(i,a[r])));return g}(r,h,o.fill(a,(()=>[0,0])),0,a-1),{bestDistance:s,best1:e,best2:i}}static calcConvexHull(t){o.assert(t&&t.length>0,"invalid points");let e,s,n,r=t.length,a=o.deepCopyArray(t),h=new i;for(a.sort(l.compareTo),e=a[0],a.shift(),a.sort(l.PolarOrderComparator(e)),a.unshift(e),h.push(a[0]),s=1;s<r&&l.equals(a[0],a[s]);++s);if(s==r)return!1;for(n=s+1;n<r&&0==l.ccw(a[0],a[s],a[n]);++n);h.push(a[n-1]);for(let t,e=n;e<r;++e){for(t=h.pop();l.ccw(h.peek(),t,a[e])<=0;)t=h.pop();h.push(t),h.push(a[e])}let c=new i;for(let t=h.iterator();t.hasNext();)c.push(t.next());r=c.size(),t=[];for(let e=c.iterator();e.hasNext();)t.push(_V.clone(e.next()));if(r>2)for(let e=0;e<r;++e)if(l.ccw(t[e],t[(e+1)%r],t[(e+2)%r])<=0)return!1;return t}static test_convexHull(){let t="9230 13137 4096 24064 8192 26112 22016  9344 4440  8028 6505 31422 28462 32343 17152 19200 9561 11599\n               4096 20992 21538  2430 21903 23677 17152 16128 7168 25088 10162 18638 822 32301 16128 12032 18989  3797\n               8192 28160 16128 20224 14080 20224 26112  7296 20367 20436 7486   422 17835  2689 22016  3200 22016  5248\n               24650 16886 15104 20224 25866  4204 13056 15104 13662 10301 17152 20224 15104 12032 6144 20992 26112  3200\n               6144 29184 13056 12032 8128 20992 5076 19172 17152 17152 823 15895 25216  3200 6071 29161 5120 20992\n               10324 22176 29900  9390 27424  7945 4096 23040 12831 27971 29860 12437 28668  2061 1429 12561 29413   596\n               17152 18176 8192 27136 5120 29184 22016 11392 1444 10362 32011  3140 15731 32661 26112  4224 13120 20224\n               30950  2616 4096 22016 4096 25088 24064  3200 26112  5248 4862 30650 5570  8885 21784 18853 23164 32371\n               4160 29184 13056 13056 8192 29184 23040  7296 5120 25088 22016  7296 7168 29184 25216  7296 23040  3200\n               4718  4451 14080 16128 7168 20992 19546 17728 13056 16128 17947 17017 26112  6272 20658  1204 23553 13965\n               13056 14080 14080 12032 24064  7296 21377 26361 17088\n               12032 16128 16128 30875 28560 2542 26201 8192 25088 11444 16973".split(/\s+/).map((t=>+t)),e=[];for(let i=0;i<t.length;i+=2)e.push([t[i],t[i+1]]);e=[[5,15],[5,-20],[-60,10],[70,-10],[-60,-10],[70,10]];let i=l.calcConvexHull(e);!1===i||i.length!=e.length?console.log("not convex!"):i.forEach((t=>{console.log(`${t[0]}, ${t[1]}`)}))}static test_closestPair(){let t="954 11163 1125 11331 1296 11499 1467 11667 1657 11796 1847 11925 2037 12054 2238 12207 2439 12360\n               2640 12513 2878 12523 3116 12533 3354 12543 3518 12493 3682 12443 3846 12393\n               8463 7794 8022 7527 7581 7260 7140 6993 6731 6624 6322 6255 5913 5886\n               5521 5494 5129 5102 4737 4710 4599 5158".split(/\s+/).map((t=>+t)),e=[];for(let i=0;i<t.length;i+=2)e.push([t[i],t[i+1]]);let{bestDistance:i,best1:s,best2:n}=l.closestPair(e);console.log(`bestDist=${i}, p1=${s}, p2=${n}`)}static test_farthestPair(){let t="9230 13137 4096 24064 8192 26112 22016  9344 4440  8028 6505 31422 28462 32343 17152 19200 9561 11599 4096 20992 21538  2430\n               21903 23677 17152 16128 7168 25088 10162 18638 822 32301 16128 12032 18989  3797 8192 28160 16128 20224 14080 20224 26112  7296\n               20367 20436 7486   422 17835  2689 22016  3200 22016  5248 24650 16886 15104 20224 25866  4204 13056 15104 13662 10301 17152 20224\n               15104 12032 6144 20992 26112  3200 6144 29184 13056 12032 8128 20992 5076 19172 17152 17152 823 15895 25216  3200 6071 29161\n               5120 20992 10324 22176 29900  9390 27424  7945 4096 23040 12831 27971 29860 12437 28668  2061 1429 12561 29413   596 17152 18176\n               8192 27136 5120 29184 22016 11392 1444 10362 32011  3140 15731 32661 26112  4224 13120 20224 30950  2616 4096 22016\n               4096 25088 24064  3200 26112  5248 4862 30650 5570  8885 21784 18853 23164 32371 4160 29184 13056 13056 8192 29184 23040  7296\n               5120 25088 22016  7296 7168 29184 25216  7296 23040  3200 4718  4451 14080 16128 7168 20992 19546 17728 13056 16128 17947 17017\n               26112  6272 20658  1204 23553 13965 13056 14080 14080 12032 24064  7296 21377 26361 17088 12032 16128 16128\n               30875 28560 2542 26201 8192 25088 11444 16973".split(/\s+/).map((t=>+t)),e=[];for(let i=0;i<t.length;i+=2)e.push([t[i],t[i+1]]);let{bestDistance:i,best1:s,best2:n}=l.farthestPair(e);console.log(`bestDist=${i}, p1=${s}, p2=${n}`)}}const h={Point2D:l,Interval1D:a,Interval2D:class{constructor(t,e){this.x=t,this.y=e}intersects(t){return!!this.x.intersects(t.x)&&!!this.y.intersects(t.y)}contains(t){return x.contains(t[0])&&y.contains(t[1])}area(){return x.length()*y.length()}static test(){}}};return e.util=h}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/util"]=t=>t.util?t.util:i(t)}(this),function(t,e){"use strict";const i={blue:"#319bd5",green:"#78c03f",yellow:"#f9ef50",red:"#eb2224",orange:"#f48917",grey:"#848685",purple:"#a6499a"},s={aqua:"#00FFFF",black:"#000000",blue:"#0000FF",brown:"#A52A2A",crimson:"#DC143C",cyan:"#00FFFF",fuchsia:"#FF00FF",gray:"#808080",green:"#008000",grey:"#808080",lavender:"#E6E6FA",lime:"#00FF00",magenta:"#FF00FF",maroon:"#800000",navy:"#000080",olive:"#808000",orange:"#FFA500",purple:"#800080",red:"#FF0000",silver:"#C0C0C0",teal:"#008080",turquoise:"#40E0D0",wheat:"#F5DEB3",white:"#FFFFFF",yellow:"#FFFF00"};function n(e){const n=t["io/czlab/mcfud/geo2d"](),r=t["io/czlab/mcfud/vec2"](),o=t["io/czlab/mcfud/math"](),{ute:a,is:l,dom:h}=e,c=2*Math.PI,d=Math.floor;function u(t,i,s,n){0==(n=n||t.getLocalBounds(null,!0)).width&&(n.width=1),0==n.height&&(n.height=1);let r=PIXI.Matrix.TEMP_MATRIX,o=PIXI.RenderTexture.create({width:0|n.width,height:0|n.height,scaleMode:i,resolution:s});return r.tx=-n.x,r.ty=-n.y,e.ctx.render(t,o,!1,r,!!t.parent),o}var p,m,g;function f(t,i){let s,n;return a.inst(e.PXGraphics,t)&&(t=u(t)),a.inst(e.PXTexture,t)?n=t:l.vec(t)?s=function(t){return a.assert(l.vec(t),"bad arg to animFromVec"),l.str(t[0])&&(t=e.tcached(t[0])?t.map((t=>e.tcached(t))):t.map((t=>e.assetPath(t)))),a.inst(e.PXTexture,t[0])?new e.PXASprite(t):e.PXASprite.fromImages(t)}(t):l.str(t)&&(n=e.tcached(t)||e.PXTexture.from(e.assetPath(t))),n&&(s=i(n)),a.assert(s,`SpriteError: ${t} not found`)&&s}function x(t,e,i,s,n,r){let o=e,a=t,l=[];for(let e,h,c,d=0;d<i;++d){c=[];for(let t=0;t<s;++t)h=o+r,e=a+n,c.push({x1:a,x2:e,y1:o,y2:h}),a=e;o=h,a=t,l.push(c)}return l}function y(t,i,s=null){let n,r;return i.m5.stage?r={x1:0,y1:0,x2:e.width,y2:e.height}:(n=i.parent,r=t.getAABB(i)),s&&n===s&&(r.x1+=s.x,r.x2+=s.x,r.y1+=s.y,r.y2+=s.y),[r,o.ndiv(r.x2-r.x1,2),o.ndiv(r.y2-r.y1,2),o.ndiv(r.x1+r.x2,2),o.ndiv(r.y1+r.y2,2)]}function v(t,e,i){if(e.m5.static)r.sub$(t.m5.vel,r.mul(i.overlapN,2*r.dot(t.m5.vel,i.overlapN)));else{let s=r.mul$(r.sub(e.m5.vel,t.m5.vel),i.overlapN),n=-2*(s[0]+s[1])/(t.m5.invMass+e.m5.invMass);r.sub$(t.m5.vel,r.mul$(r.div(i.overlapN,t.m5.mass),n)),r.add$(e.m5.vel,r.mul$(r.div(i.overlapN,e.m5.mass),n))}}function w(t,e,i){let s,r=t.toBody(e),o=t.toBody(i);return s=e.m5.circle?i.m5.circle?n.hitCircleCircle(r,o):n.hitCirclePolygon(r,o):i.m5.circle?n.hitPolygonCircle(r,o):n.hitPolygonPolygon(r,o),s&&(s.A=e,s.B=i),s}p=new PIXI.Container,(m=new PIXI.Graphics).clear(),m.beginFill(0),m.drawCircle(0,0,4),m.endFill(),g=new PIXI.Sprite(u(m)),["m5","tiled","collideXY","getGuid","getBBox","getSpatial"].forEach((t=>{[[p,"Container"],[m,"Graphics"],[g,"Sprite"]].forEach((e=>{a.assertNot(a.has(e[0],t),`PIXI ${e[1]} has ${t} property!`)}))})),a.inject(e,{PXMatrix:PIXI.Matrix.TEMP_MATRIX,PXRTexture:PIXI.RenderTexture,PXRect:PIXI.Rectangle,PXBText:PIXI.BitmapText,PXSprite:PIXI.Sprite,PXGraphics:PIXI.Graphics,PXText:PIXI.Text,PXTSprite:PIXI.TilingSprite,PXASprite:PIXI.AnimatedSprite,PXPContainer:PIXI.ParticleContainer});r.vec();const b={SomeColors:{},BtnColors:{},assets:["boot/tap-touch.png","boot/unscii.fnt","boot/trail.png","boot/star.png","boot/doki.fnt","boot/BIG_SHOUT_BOB.fnt"],assertCenter:t=>a.assert(t.anchor&&a.feq(t.anchor.x,.5)&&a.feq(t.anchor.y,.5),"not center'ed"),empty:t=>0==t.children.length,sizeXY:(t,e,i)=>(l.num(i)&&(t.height=i),l.num(e)&&(t.width=e),t),asCircle:t=>(t.m5.circle=!0,t),scaleXY:(t,e,i)=>(l.num(e)&&(t.scale.x=e),l.num(i)&&(t.scale.y=i),t),scaleBy:(t,e,i)=>(l.num(e)&&(t.scale.x*=e),l.num(i)&&(t.scale.y*=i),t),isVX:t=>!a.feq0(t.m5.vel[0]),isVY:t=>!a.feq0(t.m5.vel[1]),halfSize:t=>({width:o.ndiv(t.width,2),height:o.ndiv(t.height,2)}),anchorXY:(t,e,i)=>(a.assert(t.anchor,"sprite has no anchor object"),t.anchor.x=e,t.anchor.y=a.nor(i,e),t),centerAnchor:t=>(t.anchor&&t.anchor.set(.5,.5),t),topLeftAnchor:t=>(t.anchor&&t.anchor.set(0,0),t),topLeftOffsetXY(t){return this.isTopLeft(t)?r.vec():r.vec(-d(t.width*(t.anchor?t.anchor.x:0)),-d(t.height*(t.anchor?t.anchor.y:0)))},centerOffsetXY(t){return this.isCenter(t)?r.vec():r.vec(o.ndiv(t.width,2)-d((t.anchor?t.anchor.x:0)*t.width),o.ndiv(t.height,2)-d((t.anchor?t.anchor.y:0)*t.height))},makeSteerable(t){let e=o.ndiv(t.width,2),i=o.ndiv(t.height,2);return t.m5.steer=[0,0],t.m5.steerInfo={wanderAngle:a.rand()*Math.PI*2,arrivalThreshold:400,wanderDistance:10,wanderRadius:5,wanderRange:1,avoidDistance:400,inSightDistance:200,tooCloseDistance:60,maxForce:5,pathIndex:0},t.m5.radius=Math.sqrt(e*e+i+i),t},updateSteer:(t,e=!0)=>(t.m5.steer&&(r.clamp$(t.m5.steer,0,t.m5.steerInfo.maxForce),r.div$(t.m5.steer,t.m5.mass),r.add$(t.m5.vel,t.m5.steer),e&&r.mul$(t.m5.steer,0)),t),extend(t){if(!t.m5){let i=this;t.g={},t.m5={uuid:a.nextId(),circle:!1,stage:!1,drag:!1,dead:!1,angVel:0,friction:r.vec(1,1),gravity:r.vec(),vel:r.vec(),acc:r.vec(),static:!1,sensor:!1,sgrid:{},mass:1,type:0,cmask:0,speed:0,heading:e.RIGHT,get invMass(){return a.feq0(t.m5.mass)?0:1/t.m5.mass}},t.m5.resize=function(e,s,n,r){i.resize(t,e,s,n,r)},t.m5.getImageOffsets=function(){return{x1:0,x2:0,y1:0,y2:0}},t.m5.getContactPoints=function(){return function(t,e,i){let s=[r.vec(e,i),r.vec(e,0),r.vec(0,0),r.vec(0,i)];return t||(t={x:0,y:0}),s.forEach((s=>{s[0]-=d(e*t.x),s[1]-=d(i*t.y)})),s}(t.anchor,t.width,t.height)},t.getGuid=function(){return t.m5.uuid},t.getSpatial=function(){return t.m5.sgrid},t.getBBox=function(){return a.feq0(t.angle)?i.getAABB(t):i.boundingBox(t)}}return t},toPolygon:t=>new n.Polygon(t.m5.getContactPoints()).setOrient(t.rotation),toCircle(t){return this.assertCenter(t)&&new n.Circle(o.ndiv(t.width,2)).setOrient(t.rotation)},toBody(t){let e=t.x,i=t.y,s=t.m5.circle?this.toCircle(t):this.toPolygon(t);return n.bodyWrap(s,e,i)},gposXY(t){const{x:e,y:i}=t.getGlobalPosition();return r.vec(e,i)},isTopLeft:t=>!t.anchor||a.feq0(t.anchor.x)&&a.feq0(t.anchor.y),isCenter:t=>!!t.anchor&&(a.feq(t.anchor.x,.5)&&a.feq(t.anchor.y,.5)),centerXY(t){let e;if(this.isCenter(t))e=r.vec(t.x,t.y);else{let[i,s]=this.centerOffsetXY(t);e=r.vec(t.x+i,t.y+s)}return e},setScaleModeNearest:(t,e)=>(t.texture.baseTexture.scaleMode=e?PIXI.SCALE_MODES.NEAREST:PIXI.SCALE_MODES.LINEAR,t),angle(t,e){return r.angle(this.centerXY(t),this.centerXY(e))},move:(t,e)=>(e=a.nor(e,1),void 0!==t.m5.maxSpeed&&r.clamp$(t.m5.vel,0,t.m5.maxSpeed),r.add$(t,r.mul(t.m5.vel,e))),leftSide(t){let e=t.x,i=t.width,s=t.anchor?t.anchor.x:0;return s>.7?e-=i:s>0&&(e-=o.ndiv(i,2)),e},rightSide(t){return this.leftSide(t)+t.width},topSide(t){let e=t.y,i=t.height,s=t.anchor?t.anchor.y:0;return s>.7?e-=i:s>0&&(e-=o.ndiv(i,2)),e},bottomSide(t){return this.topSide(t)+t.height},getAABB(t){let{x1:e,y1:i,x2:s,y2:n}=t.m5.getImageOffsets(),r=this.leftSide(t),o=this.topSide(t),a=r+t.width,l=o+t.height;return r+=e,o+=i,a-=s,l-=n,{x1:r,y1:o,x2:a,y2:l}},bbox4:(t,e,i,s)=>a.assert(i<=s,"bad bbox")&&{x1:t,x2:e,y1:i,y2:s},bboxCenter(t){if(l.num(t.x1))return r.vec(o.ndiv(t.x1+t.x2,2),o.ndiv(t.y1+t.y2,2))},bboxFrame(t,e=16,i="#dedede"){let s,{x1:n,x2:r,y1:a,y2:l}=t,h=r-n,c=l-a,d=this.graphics();return d.lineStyle(e,this.color(i)),d.drawRoundedRect(0,0,h+e,c+e,o.ndiv(e,4)),s=this.sprite(d),s.x=n-e,s.y=a-e,s},bboxSize:t=>r.vec(t.x2-t.x1,t.y2-t.y1),pointInBBox:(t,e,i)=>t>i.x1&&t<i.x2&&e>i.y1&&e<i.y2,boundingBox(t){let e,i,s=[],n=[],r=o.ndiv(t.width,2),l=o.ndiv(t.height,2),h=Math.tanh(l/r),u=Math.sqrt(r*r+l*l);return a.feq0(t.rotation)||a.assert(this.isCenter(t),"wanted center anchor"),i=c-h+t.rotation,n.push(u*Math.sin(i)),s.push(u*Math.cos(i)),i=h+t.rotation,n.push(u*Math.sin(i)),s.push(u*Math.cos(i)),i=Math.PI-h+t.rotation,n.push(u*Math.sin(i)),s.push(u*Math.cos(i)),i=Math.PI+h+t.rotation,n.push(u*Math.sin(i)),s.push(u*Math.cos(i)),e=this.centerXY(t),n.sort(((t,e)=>t-e)),s.sort(((t,e)=>t-e)),{x1:d(s[0]+e[0]),x2:d(s[3]+e[0]),y1:d(n[0]+e[1]),y2:d(n[3]+e[1])}},hitTestPoint(t,e,i){let s=this.toBody(i);return i.m5.circle?n.hitTestPointCircle(t,e,s):n.hitTestPointPolygon(t,e,s)},distance(t,e){return r.dist(this.centerXY(t),this.centerXY(e))},scaleContent(...t){1==t.length&&l.vec(t[0])&&(t=t[0]);let i=e.getScaleFactor();t.forEach((t=>{t.scale.x=i,t.scale.y=i}))},scaleToCanvas:t=>(t.height=e.height,t.width=e.width,t),uuid:(t,e)=>(t.m5.uuid=e,t),opacity:(t,e)=>(t.alpha=e,t),tint:(t,e)=>(t.tint=e,t),hide:t=>(t.visible=!1,t),show:t=>(t.visible=!0,t),pset:(t,e,i)=>(t.g[e]=i,t),pget:(t,e)=>t.g[e],container(t){let i=new e.PXContainer;return i=this.extend(i),t&&t(i),i},group(...t){let e=this.container();return t.forEach((t=>e.addChild(t))),e},sprite(t,i=!1,s=0,n=0){let o=f(t,(t=>new e.PXSprite(t)));return o=this.extend(o),r.set(o,s,n),i&&this.centerAnchor(o),a.inst(e.PXASprite,o)?function(t){let i=0,s={};function n(){i&&(i=clearInterval(i))}function r(){s.cnt<s.total?(t.gotoAndStop(t.currentFrame+1),s.cnt+=1):t.loop?(t.gotoAndStop(s.start),s.cnt=1):(n(),t.onComplete&&t.onComplete())}return a.inject(t.m5,{stopFrames(){n(),t.gotoAndStop(t.currentFrame)},showFrame(e){n(),t.gotoAndStop(e)},playFrames(o){n(),s.start=0,s.end=t.totalFrames-1,l.vec(o)&&o.length>1&&(s.start=o[0],s.end=o[1]),s.total=s.end-s.start+1,t.gotoAndStop(s.start),s.cnt=1,i=setInterval(r,1e3/e.aniFps)}}),t}(o):o},tilingSprite(t,i=!1,s=0,n=0){let o=f(t,(t=>new e.PXTSprite(t,t.width,t.height)));return o=this.extend(o),i&&this.centerAnchor(o),r.set(o,s,n)},repeatSprite(t,i=!0,s=!0,n,o){let a,l=()=>{let i=this.extend(f(t,(t=>new e.PXSprite(t)))),s=e.getScaleFactor();return s=1,i.width*=1,i.height*=1,i},h=[],c=0,d=0,u=0,p=0;if(i){for(;u<n;)h.push(a=l()),r.set(a,c,d),u+=a.width,c+=a.width,u>=n&&p<o&&s&&(p+=a.height,d+=a.height,c=0,u=0);s=!1}if(s){for(;p<o;)h.push(a=l()),r.set(a,c,d),p+=a.height,d+=a.height,p>=o&&u<n&&i&&(u+=a.width,c+=a.width,c=d,u=p);i=!1}return h},animation(t,i,s,n=0){let a=e.tcached(t);if(!a)throw`SpriteError: ${t} not loaded.`;let l=o.ndiv(a.width,i),h=[],c=l*o.ndiv(a.height,s);for(let t,e,a=0;a<c;++a)t=a%l*i,e=o.ndiv(a,l)*s,n>0&&(t+=n+n*a%l,e+=n+n*o.ndiv(a,l)),h.push(r.vec(t,e));return this.sprite(((t,i,s,n)=>n.map((n=>new e.PXTexture(t.baseTexture,new e.PXRect(n[0],n[1],i,s)))))(a,i,s,h))},frame(t,i,s,n,r){const o=e.tcached(t);return this.sprite(new e.PXTexture(o.baseTexture,new e.PXRect(n,r,i,s)))},frameSelect(t,i,s,n){const r=e.tcached(t);return n.map((t=>new e.PXTexture(r.baseTexture,new e.PXRect(t[0],t[1],i,s))))},frames(t,i,s,n=0,r=0,a=0,l=0){let h=e.tcached(t),c=i+n,d=s+r,u=[],p=o.ndiv(h.height,d),m=o.ndiv(h.width+n,c);for(let t,n=0;n<p;++n){t=l+s*n;for(let n,r=0;r<m;++r)n=a+i*r,u.push(new e.PXTexture(h.baseTexture,new e.PXRect(n,t,i,s)))}return u},frameImages:(...t)=>(1==t.length&&l.vec(t[0])&&(t=t[0]),t.map((t=>e.tcached(t)))),spriteFrom(...t){return this.sprite(this.frameImages(...t))},text(t,i,s=0,n=0){return r.set(this.extend(new e.PXText(t,i)),s,n)},bitmapText(t,i,s){let n;return l.str(i)?(n={fontName:i},l.num(s)&&(n.fontSize=s)):n=i,n.fill&&(n.tint=this.color(n.fill)),n.fontName||(n.fontName="unscii"),n.align||(n.align="center"),this.extend(new e.PXBText(t,n))},triangle(t,i,s,n=16777215,a=16777215,h=0,c=0,d=0){let u=this.graphics(),p=1,m=o.ndiv(t,2),g=this.color(a),f=s<.5?0:s>.5?t:m,x=[{x:0,y:0},{x:f,y:-i},{x:t,y:0},{x:0,y:0}];!1!==n&&(l.vec(n)&&(p=n[1],n=n[0]),u.beginFill(this.color(n),p)),h>0&&u.lineStyle(h,g,1),u.drawPolygon(...x),!1!==n&&u.endFill();let y=new e.PXSprite(this.genTexture(u));return y=this.extend(y),y.m5.getContactPoints=i<0?()=>[[f,-i],[t,0],[0,0]]:()=>[[t,i],[f,0],[0,i]],r.set(y,c,d)},rect(t,i,s=16777215,n=16777215,o=0,a=0,h=0){let c,d=this.graphics();!1!==s&&(l.vec(s)?(c=s[1],s=s[0]):c=1,d.beginFill(this.color(s),c)),o>0&&d.lineStyle(o,this.color(n)),d.drawRect(0,0,t,i),!1!==s&&d.endFill();let u=new e.PXSprite(this.genTexture(d));return u=this.extend(u),r.set(u,a,h)},drawBody(t,...i){let s=this.graphics();return t.apply(this,[s].concat(i)),this.extend(new e.PXSprite(this.genTexture(s)))},circle(t,i=16777215,s=16777215,n=0,o=0,a=0){let h,c=this.graphics();!1!==i&&(l.vec(i)?(h=i[1],i=i[0]):h=1,c.beginFill(this.color(i),h)),n>0&&c.lineStyle(n,this.color(s)),c.drawCircle(0,0,t),!1!==i&&c.endFill();let d=new e.PXSprite(this.genTexture(c));return d=this.extend(d),r.set(d,o,a),(d.m5.circle=!0)&&this.centerAnchor(d)},line(t,e,i,s){let n=this.graphics(),o=r.clone(i),l=r.clone(s),h=this.color(t);function c(){n.clear(),n.lineStyle(e,h,1),n.moveTo(o[0],o[1]),n.lineTo(l[0],l[1])}c();let d=this.extend(n);return d.m5.ptA=function(t,e){return void 0!==t&&(o[0]=t,o[1]=a.nor(e,t),c()),o},d.m5.ptB=function(t,e){return void 0!==t&&(l[0]=t,l[1]=a.nor(e,t),c()),l},d},isMoving:t=>!a.feq0(t.m5.vel[0])||!a.feq0(t.m5.vel[1]),makeCells(t,e,i,s,n,r){let a=o.ndiv(i-t,n);return x(t,e,o.ndiv(s-t,r),a,n,r)},gridBox(t=.9,i=.9,s){let n=a.nor(s,e),r=d(n.height*i),l=d(n.width*t),h=o.ndiv(n.width-l,2),c=o.ndiv(n.height-r,2);return{x1:h,y1:c,x2:h+l,y2:c+r}},gridSQ(t,i=.6,s){let n=i*(e.height<e.width?e.height:e.width),r=o.ndiv(n,t),l=r;a.isEven(r)||--r,l=r,n=t*r;let h=o.ndiv(e.height-n,2),c=o.ndiv(e.width-n,2),d=c,u=h;return s&&(s.height=n,s.width=n,void 0!==s.x&&(d=s.x),void 0!==s.y&&(u=s.y),s.x=c,s.y=h,s.x1=c,s.y1=h,s.x2=c+n,s.y2=h+n),x(d,u,t,t,r,l)},divXY([t,i],s=.9,n=.9,r){let a,l,h,c,u=d(e.height*n),p=d(e.width*s),m=o.ndiv(p,t),g=o.ndiv(u,i);return u=i*g,p=t*m,h=o.ndiv(e.height-u,2),c=o.ndiv(e.width-p,2),a=c,l=h,r&&(r.height=u,r.width=p,void 0!==r.x&&(a=r.x),void 0!==r.y&&(l=r.y),r.x=c,r.y=h,r.x1=c,r.y1=h,r.x2=c+p,r.y2=h+u),x(a,l,i,t,m,g)},gridXY([t,i],s=.9,n=.9,r){let l,h,c,u,p=d(e.height*n),m=d(e.width*s),g=o.ndiv(m,t),f=o.ndiv(p,i),y=g>f?f:g;return a.isEven(y)||y--,p=i*y,m=t*y,c=o.ndiv(e.height-p,2),u=o.ndiv(e.width-m,2),l=u,h=c,r&&(r.height=p,r.width=m,void 0!==r.x&&(l=r.x),void 0!==r.y&&(h=r.y),r.x=u,r.y=c,r.x1=u,r.y1=c,r.x2=u+m,r.y2=c+p),x(l,h,i,t,y,y)},gridBBox(t,e,i){let s=i[0].length,n=i[0][0],r=i[i.length-1][s-1];return{x1:t+n.x1,x2:t+r.x2,y1:e+n.y1,y2:e+r.y2}},graphics(t){let i=new e.PXGraphics;return(i.m5={uuid:`${t||a.nextId()}`})&&i},drawGridBox(t,e=1,i="white",s){return s||(s=this.graphics()),s.lineStyle(e,this.color(i)),s.drawRect(t.x1,t.y1,t.x2-t.x1,t.y2-t.y1),s},drawGridBoxEx(t,e=1,i="white",s=1,n){return n||(n=this.graphics()),n.lineStyle(e,this.color(i)),n.drawRoundedRect(t.x1,t.y1,t.x2-t.x1,t.y2-t.y1,s),n},drawGridLines(t,e,i,s,n,r){let o=i.length,a=i[0].length;r||(r=this.graphics()),r.lineStyle(s,this.color(n));for(let s,n=1;n<o;++n)s=i[n],r.moveTo(t+s[0].x1,e+s[0].y1),r.lineTo(t+s[a-1].x2,e+s[a-1].y1);for(let s,n=1;n<a;++n)s=i[0],r.moveTo(t+s[n].x1,e+s[n].y1),s=i[o-1],r.lineTo(t+s[n].x1,e+s[n].y2);return r},add:(t,...e)=>(e.forEach((e=>e&&t.addChild(e))),t),remove(...t){1==t.length&&l.vec(t[0])&&(t=t[0]),a.doseqEx(t,(t=>{t.parent&&(a.inst(e.Scenes.Scene,t.parent)?t.parent.remove(t):t.parent.removeChild(t)),e.off(t),t.m5.dispose&&t.m5.dispose(),e.emit(["post.remove",t])}))},centerObj:t=>(t.x=e.width/2,t.y=e.height/2,t.anchor.x<.3?(t.x-=t.width/2,t.y-=t.height/2):t.anchor<.7||a.assert(!1,"bad anchor to center"),t),fillMax:t=>(t.anchor&&a.assert(t.anchor.x<.3,"wanted top left anchor"),t.height=e.height,t.width=e.width,t.x=0,t.y=0,t),colorToRgbA(t){if(!t||!l.str(t)||0==t.length)return;let e=t.toLowerCase(),i=s[e];if(i&&(t=i),"#"==t[0])return t.length<7&&(t=`#${t[1]}${t[1]}${t[2]}${t[2]}${t[3]}${t[3]}${t.length>4?t[4]+t[4]:""}`),[parseInt(t.substr(1,2),16),parseInt(t.substr(3,2),16),parseInt(t.substr(5,2),16),t.length>7?parseInt(t.substr(7,2),16)/255:1];if("transparent"==e)return[0,0,0,0];if(0==e.indexOf("rgb"))return e.indexOf("rgba")<0&&(e+=",1"),e.match(/[\.\d]+/g).map((t=>+t));throw`Error: Bad color: ${t}`},byteToHex:t=>("0"+t.toString(16)).slice(-2),colorToHex(t){const e=this.colorToRgbA(t);return"0x"+[0,1,2].map((t=>this.byteToHex(e[t]))).join("")},color3(t,e,i){return parseInt(["0x",this.byteToHex(t),this.byteToHex(e),this.byteToHex(i)].join(""))},color(t){return isNaN(t)?parseInt(this.colorToHex(t)):t},rgba(t){return a.assert(l.vec(t),"wanted rgba array"),parseInt("0x"+[0,1,2].map((e=>this.byteToHex(t[e]))).join(""))},hsla(t,e,i,s){function n(t){return Math.min(1,Math.max(0,t))}function r(t){return 6*(t=t<0?t+1:t>1?t-1:t)<1?a+(o-a)*t*6:2*t<1?o:3*t<2?a+(o-a)*(2/3-t)*6:a}t=t%360/360,e=n(e),i=n(i),s=n(s);let o=i<=.5?i*(e+1):i+e-i*e,a=2*i-o;return this.rgba([255*r(t+1/3),255*r(t),255*r(t-1/3),s])},resize(t,e,i,s,n){t&&a.doseqEx(t.children,(e=>e.m5&&e.m5.resize&&e.m5.resize(t.x,t.y,t.width,t.height)))},pinAbove(t,e,i=10,s=.5){let[n,o,a,l,h]=y(this,t),[c,d,u,p,m]=y(this,e,t),g=n.y1-i-(c.y2-c.y1),f=s<.3?n.x1:s<.7?l-d:n.x2-(c.x2-c.x1);e.y=!e.anchor||e.anchor.y<.3?g:e.anchor.y<.7?g+u:g+(c.y2-c.y1),e.x=!e.anchor||e.anchor.x<.3?f:e.anchor.x<.7?f+d:f+(c.x2-c.x1),e.parent===t&&r.sub$(e,t)},pinBelow(t,e,i=10,s=.5){let[n,o,a,l,h]=y(this,t),[c,d,u,p,m]=y(this,e,t),g=n.y2+i,f=s<.3?n.x1:s<.7?l-d:n.x2-(c.x2-c.x1);e.y=!e.anchor||e.anchor.y<.3?g:e.anchor.y<.7?g+u:g+(c.y2-c.y1),e.x=!e.anchor||e.anchor.x<.3?f:e.anchor.x<.7?f+d:f+(c.x2-c.x1),e.parent===t&&r.sub$(e,t)},pinCenter(t,e){let[i,s,n,o,a]=y(this,t),[l,h,c,d,u]=y(this,e,t),p=o-h,m=a-c;e.y=!e.anchor||e.anchor.y<.3?m:e.anchor.y<.7?m+c:m+(l.y2-l.y1),e.x=!e.anchor||e.anchor.x<.3?p:e.anchor.x<.7?p+h:p+(l.x2-l.x1),(t.m5.stage||e.parent===t)&&r.sub$(e,t)},pinLeft(t,e,i=10,s=.5){let[n,o,a,l,h]=y(this,t),[c,d,u,p,m]=y(this,e,t),g=n.x1-i-(c.x2-c.x1),f=s<.3?n.y1:s<.7?h-u:n.y2-(c.y2-c.y1);e.y=!e.anchor||e.anchor.y<.3?f:e.anchor.y<.7?f+u:f+(c.y2-c.y1),e.x=!e.anchor||e.anchor.x<.3?g:e.anchor.x<.7?g+d:g+(c.x2-c.x1),e.parent===t&&r.sub$(e,t)},pinRight(t,e,i=10,s=.5){let[n,o,a,l,h]=y(this,t),[c,d,u,p,m]=y(this,e,t),g=n.x2+i,f=s<.3?n.y1:s<.7?h-u:n.y2-(c.y2-c.y1);e.y=!e.anchor||e.anchor.y<.3?f:e.anchor.y<.7?f+u:f+(c.y2-c.y1),e.x=!e.anchor||e.anchor.x<.3?g:e.anchor.x<.7?g+d:g+(c.x2-c.x1),e.parent===t&&r.sub$(e,t)},setMass(t,e){t.m5.mass=e},genTexture:(t,e,i,s)=>u(t,e,i,s),bounceOff:t=>v(t.A,t.B,t),hit(t,i){const s=w(this,t,i);return s&&(e.emit(["hit",t],s),e.emit(["hit",i],s.swap())),s},collide(t,i,s=!0){const n=function(t,e,i,s=!0){let n=w(t,e,i);if(n){if(i.m5.static)r.sub$(e,n.overlapV);else{let t=r.div(n.overlapV,2);r.sub$(e,t),r.add$(i,t)}s&&v(e,i,n)}return n}(this,t,i,s);return n&&function(t){const i=new Set;return t.overlapN[1]<-.3&&i.add(e.TOP),t.overlapN[1]>.3&&i.add(e.BOTTOM),t.overlapN[0]<-.3&&i.add(e.LEFT),t.overlapN[0]>.3&&i.add(e.RIGHT),i.add(t),i}(n)},hitTest(t,e){return w(this,t,e)},clamp(t,i,s=!1,n){let r,o,h,c,d,u;l.vec(i)&&(r=i[1].left,o=i[1].right,h=i[1].top,c=i[1].bottom,i=i[0]),o=!1!==o,r=!1!==r,h=!1!==h,c=!1!==c,i instanceof e.Scenes.Scene?u=e.mockStage():i.m5&&i.m5.stage?u=i:void 0!==i.x2&&void 0!==i.y2?(u=i,d=!0):(i.isSprite?a.assert(t.parent===i):a.assert(!1,"Error: clamp() using bad container"),a.assert(a.feq0(i.rotation),"Error: clamp() container can't rotate"),a.assert(a.feq0(i.anchor.x),"Error: clamp() container anchor.x !==0"),a.assert(a.feq0(i.anchor.y),"Error: clamp() container anchor.y !==0"),u=i);let p=d?[0,0]:this.topLeftOffsetXY(u),m=new Set,g=!1,f=!1,x=this.getAABB(t),y=d?u.x1:u.x+p[0],v=y+(d?u.x2-u.x1:u.width),w=d?u.y1:u.y+p[1],b=w+(d?u.y2-u.y1:u.height);return r&&x.x1<y&&(t.x+=y-x.x1,g=!0,m.add(e.LEFT)),o&&x.x2>v&&(t.x-=x.x2-v,g=!0,m.add(e.RIGHT)),h&&x.y1<w&&(t.y+=w-x.y1,f=!0,m.add(e.TOP)),c&&x.y2>b&&(t.y-=x.y2-b,f=!0,m.add(e.BOTTOM)),m.size>0?(g&&(t.m5.vel[0]/=t.m5.mass,s&&(t.m5.vel[0]*=-1)),f&&(t.m5.vel[1]/=t.m5.mass,s&&(t.m5.vel[1]*=-1)),n&&n(m)):m=null,m},dbgShowDir(t){let i="?";switch(t){case e.NE:i="top-right";break;case e.NW:i="top-left";break;case e.TOP:case e.UP:i="top";break;case e.LEFT:i="left";break;case e.RIGHT:i="right";break;case e.BOTTOM:case e.DOWN:i="bottom";break;case e.SE:i="bottom-right";break;case e.SW:i="bottom-left"}return i},dbgShowCol(t){let e=[];if(l.set(t))for(let i of t.values())e.push(this.dbgShowDir(i));return e.join(",")}};return b.bmpText=b.bitmapText,a.doseq(s,((t,e)=>{b.SomeColors[e]=b.color(t)})),a.doseq(i,((t,e)=>{b.BtnColors[e]=b.color(t)})),e.Sprites=b}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Sprites"]=function(t){return t.Sprites?t.Sprites:n(t)}}(this),function(t,e){"use strict";function i(e,i){const s=t["io/czlab/mcfud/spatial"](),n=t["io/czlab/mcfud/math"](),{ute:r,is:o}=e,a=(Math.floor,t=>t.startsWith("scene::")?t:`scene::${t}`);function l(t){t&&(t.dispose&&t.dispose(),t.parent.removeChild(t))}class h extends e.PXContainer{constructor(t){super(),this.addChild(t),this.name=t.name,this.m5={stage:!0}}dispose(){l(this.children[0])}update(t){this.children[0].update(t)}}class c extends e.PXContainer{constructor(t,e,i){let n;super(),this.name=a(t),this.g={},this.m5={index:{},queue:[],garbo:[],sid:t,options:i,stage:!0,sgrid:s.spatialGrid(i.sgridX||320,i.sgridY||320)},o.fun(e)?n=e:o.obj(e)&&(n=r.dissoc(e,"setup"),r.inject(this,e)),n&&(this.m5.setup=n.bind(this))}_hitObjects(t,i,s,n=3){for(let n,r,o=0;o<s.length&&(r=s[o],!(i!==r&&!r.m5.dead&&i.m5.cmask&r.m5.type&&(n=e.Sprites.hitTest(i,r),n&&(e.emit(["hit",i],n),n.B.m5.static||e.emit(["hit",n.B],n.swap()),t.engrid(i),0==--curCol))));++o);}collideXY(t){this._hitObjects(this.m5.sgrid,t,this.m5.sgrid.search(t))}onCanvasResize([t,i]){e.Sprites.resize({x:0,y:0,width:t,height:i,children:this.children})}future(t,i){this.m5.queue.push([t,n.ndiv(e._curFPS*i,1e3)||1])}futureX(t,e){this.m5.queue.push([t,e||1])}getChildById(t){return t&&this.m5.index[t]}remove(t){o.str(t)&&(t=this.getChildById(t)),t&&(this.removeChild(t),t.m5._engrid&&this.m5.sgrid.degrid(t),t.m5.drag&&e.Input.undoDrag(t),t.m5.button&&e.Input.undoButton(t),e.off(t),r.dissoc(this.m5.index,t.m5.uuid))}degrid(t){return t&&t.m5._engrid&&this.m5.sgrid.degrid(t),t}engrid(t){return t&&t.m5._engrid&&this.m5.sgrid.engrid(t),t}insert(t,e=!1){return this.insertAt(t,null,e)}insertAt(t,e,i=!1){return t=this._addit(t,e),i&&(t instanceof PIXI.TilingSprite||(t.m5._engrid=!0,t.visible&&this.m5.sgrid.engrid(t))),t}_addit(t,e){let i=this,s=t=>{t.m5&&(t.m5.root=i),t.children.forEach((t=>s(t)))};return o.num(e)&&e>=0&&e<this.children.length?this.addChildAt(t,e):this.addChild(t),s(t),this.m5.index[t.m5.uuid]=t}dispose(){const t=e.Input;e.off(this),function e(i){i&&(i.m5&&(i.m5.drag&&t.undoDrag(i),i.m5.button&&t.undoButton(i)),i.children.length>0&&i.children.forEach((t=>e(t))))}(this),this.m5.dead=!0,this.removeChildren()}_tick(t,i){t.forEach((t=>{t.visible&&t.m5&&t.m5.tick&&(t.m5.tick(i),"x"==t.m5.flip&&(t.scale.x*=-1),"y"==t.m5.flip&&(t.scale.y*=-1),t.m5.flip=!1,e.emit(["post.tick",t],i),t.m5._engrid&&this.m5.sgrid.engrid(t)),t.children.length>0&&this._tick(t.children,i)}))}searchSGrid(t,e=!1){return this.m5.sgrid.search(t,e)}queueForRemoval(t){return this.m5.garbo.push(t),t}update(t){if(this.m5.dead)return;let e,i=this.m5.queue.filter((t=>(t[1]-=1,t[1]<=0)));for(;i.length>0;)r.disj(this.m5.queue,e=i.shift()),e[0]();this.preUpdate&&this.preUpdate(t),this._tick(this.children,t),this.postUpdate&&this.postUpdate(t),this.m5.garbo.forEach((t=>this.remove(t))),this.m5.garbo.length=0}runOnce(){this.m5.setup&&(this.m5.setup(this.m5.options),delete this.m5.setup)}}function d(t,i,s){let{Sprites:a}=e,l=e.getScaleFactor();if(0==t.length)return;let h,c,d,u=(i=r.patch(i,{bg:0,padding:10,fit:20,borderWidth:4,border:a.SomeColors.white})).borderWidth*l,p=i.group||a.container(),m=i.padding*l,g=2*(i.fit*l);!function(t,i,s,n,o){let a,l=0,h=-1;i.forEach(((i,s)=>{n==e.DOWN?i.width>h&&(l=s,h=i.width):i.height>h&&(l=s,h=i.height),o||t.addChild(i),r.assert(r.feq0(i.anchor.x)&&r.feq0(i.anchor.y),"wanted topleft anchor")})),a=i[l];for(let t,r=l-1;r>=0;--r)t=i[r],e.Sprites[n==e.DOWN?"pinAbove":"pinLeft"](a,t,s),a=t;a=i[l];for(let t,r=l+1;r<i.length;++r)t=i[r],e.Sprites[n==e.DOWN?"pinBelow":"pinRight"](a,t,s),a=t}(p,t,m,s,i.skipAdd),c=p.width,d=p.height,h=r.tail(t);{let t=a.rect(c+g,d+g,i.bg,i.border,u);p.addChildAt(t,0),o.vec(i.bg)||(t.alpha=0==i.opacity?0:i.opacity||.5,"transparent"==i.bg&&(t.alpha=0))}d=p.height,c=p.width;let[f,x]=[n.ndiv(c,2),n.ndiv(d,2)];if(s==e.DOWN){t.forEach((t=>t.x=f-n.ndiv(t.width,2)));let e=d-(h.y+h.height);e=n.ndiv(e,2),t.forEach((t=>t.y+=e))}else{t.forEach((t=>t.y=x-n.ndiv(t.height,2)));let e=c-(h.x+h.width);e=n.ndiv(e,2),t.forEach((t=>t.x+=e))}return d=p.height,c=p.width,p.x=r.nor(i.x,n.ndiv(e.width-c,2)),p.y=r.nor(i.y,n.ndiv(e.height-d,2)),p}function u(t,i,s){let n,r,{Sprites:o,Input:a}=e,l=o.color(i.selectedColor),h=o.color(i.disabledColor);return t.forEach((t=>{t.m5.uuid==i.defaultChoice?(r=t,t.tint=l):t.tint=h,t.m5.button&&(t.m5.press=t=>{t!==r&&(r.tint=h,t.tint=l,r=t,i.onClick&&i.onClick(t))})})),r||(r=t[0],r.tint=l),n=d(t,i,s),n.getSelectedChoice=()=>r.m5.uuid,n}const p={Scene:c,SceneWrapper:h,layoutX:(t,i)=>d(t,i,e.RIGHT),layoutY:(t,i)=>d(t,i,e.DOWN),choiceMenuX:(t,i)=>u(t,i,e.RIGHT),choiceMenuY:(t,i)=>u(t,i,e.DOWN),scene(t,e,s){o.fun(e)&&(e={setup:e}),i[t]=[e,s]},replace(t,i,s){const n=a(o.str(t)?t:t.name),r=e.stage.getChildByName(n);if(!r)throw`Fatal: no such scene: ${n}`;return this.run(i,e.stage.getChildIndex(r),s)},remove(...t){1==t.length&&o.vec(t[0])&&(t=t[0]),t.forEach((t=>l(o.str(t)?e.stage.getChildByName(a(t)):t)))},removeAll(){for(;e.stage.children.length>0;)l(e.stage.children[e.stage.children.length-1]);e.mouse.reset(),e.Input.reset()},find:t=>e.stage.getChildByName(a(t)),runEx(t,e,i){this.removeAll(),this.run(t,e,i)},runSeq(...t){t.forEach((t=>{r.assert(o.vec(t),"Expecting array"),this.run(t[0],t[1],t[2])}))},run(t,s,n){let a,d,u,p=i[t];if(!p)throw`Fatal: unknown scene: ${t}`;if(o.obj(s)&&(n=s,s=r.dissoc(n,"slot")),n=r.inject({},p[1],n),u=r.inject({},p[0]),o.undef(s)&&(s=n.slot||-1),n.tiled?(r.assert(n.tiled.name,"no tmx file!"),d=new e.Tiles.TiledScene(t,u,n)):d=new c(t,u,n),a=d,n.centerStage&&(a=new h(d)),s>=0&&s<e.stage.children.length){let t=e.stage.getChildAt(s);e.stage.addChildAt(a,s),l(t)}else e.stage.addChild(a);return d.runOnce(),d},topMost(){let t=r.last(e.stage.children);return t instanceof h&&(t=t.children[0]),r.assert(t instanceof c,"top is not a scene!"),t}};return e.Scenes=p}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Scenes"]=function(t){return t.Scenes?t.Scenes:i(t,{})}}(this),function(t,e){"use strict";if(!t.AudioContext)throw"Fatal: no audio.";const i=console;Math.floor;function s(e,s){const{ute:n,is:r}=e,o=new Map;let a=1;function l(t,i,r){let l=0,h=1;const c={sids:new Map,buffer:undefined,loop:!1,src:r,name:i,get pan(){return l},set pan(t){l=t},get volume(){return h},set volume(t){h=t},play(){const i=n.now(),s=this.name;if(e.Sound.sfx()&&!function(t,e,i){let s;return o.has(t)&&o.get(t)>e?s=!0:i?o.set(t,e+i):o.delete(t),s}(s,i)){let e=a++,i=1e3*this.buffer.duration,s=t.ctx.createGain(),r=t.ctx.createStereoPanner(),o=t.ctx.createBufferSource();o.buffer=this.buffer,o.connect(s),s.connect(r),r.connect(t.ctx.destination),this.loop?o.loop=!0:n.delay(i,(()=>this.sids.delete(e))),r.pan.value=l,s.gain.value=h,o.start(0),this.sids.set(e,o)}return this},stop(){return this.sids.forEach((t=>t.stop(0))),this.sids.length=0,this}};return s[i]=c}const h={ctx:new t.AudioContext,_mute:0,init(){n.delay(0,(()=>{"suspended"==this.ctx.state&&this.ctx.resume()}))},sfx(){return 0===this._mute},mute(){return this._mute=1,this},unmute(){return this._mute=0,this},decodeData(t,e,s,n,r){let o=l(this,t,e);return this.ctx.decodeAudioData(s,(t=>{n(o.buffer=t),i.log(`decoded sound file:${e}`)}),(t=>{r&&r(e,t)})),o},decodeUrl(t,e,i,s){let n=new XMLHttpRequest,r=l(this,t,e);return n.open("GET",e,!0),n.responseType="arraybuffer",n.addEventListener("load",(()=>{this.decodeData(e,n.response,i,s)})),n.send(),r}};return e.sound=function(t){return s[e.assetPath(t)]||n.assert(!1,`Sound: ${t} not loaded.`)},e.Sound=h}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Sound"]=function(t){return t.Sound?t.Sound:s(t,{})}}(this),function(t,e){"use strict";function i(i){const s=t["io/czlab/mcfud/geo2d"](),n=t["io/czlab/mcfud/vec2"](),{ute:r,is:o}=i,a=[],l=()=>a[0];function h(t={}){function a(e){t.keyInputs.set(e.keyCode,!1),t.shiftKey=e.shiftKey,t.ctrlKey=e.ctrlKey,t.altKey=e.altKey,e.preventDefault()}function l(e){t.keyInputs.set(e.keyCode,!0),t.ctrlKey=!1,t.altKey=!1,t.shiftKey=!1,e.preventDefault()}return r.inject(t,{keyInputs:r.jsMap(),pauseInput:!1,ctrlKey:!1,altKey:!1,shiftKey:!1,ptr:e,dispose(){this.ptr.dispose(),i.touchDevice||r.delEvent([["keyup",window,a,!1],["keydown",window,l,!1]])},pointer(){return this.ptr||(this.ptr=function(t){let o={ActiveDragsID:r.jsMap(),ActiveDrags:r.jsMap(),ActiveTouches:r.jsMap(),Hotspots:[],Buttons:[],DragDrops:[],state:[!1,!0],touchZeroID:0,_visible:!0,_x:0,_y:0,width:1,height:1,downTime:0,downAt:[0,0],elapsedTime:0,dragged:e,dragOffsetX:0,dragOffsetY:0,anchor:i.makeAnchor(.5,.5),get cursor(){return i.canvas.style.cursor},set cursor(t){i.canvas.style.cursor=t},get x(){return this._x/i.scale},get y(){return this._y/i.scale},get visible(){return this._visible},get isUp(){return this.state[1]},get isDown(){return this.state[0]},set visible(t){this.cursor=t?"auto":"none",this._visible=t},updateMultiDrags(t){let e=o;for(let t,i,s=0;s<e.ActiveTouches.length;++s){i=e.ActiveTouches[s];for(let s,o,a=e.DragDrops.length-1;a>=0;--a){if(o=e.DragDrops[a],s=e.ActiveDrags.get(o.m5.uuid),s){n.set(s.dragged,s.dragStartX+(i.x-s.dragPtrX),s.dragStartY+(i.y-s.dragPtrY));break}if(o.m5.drag&&e._test(o,i.x,i.y)){r.assoc(e.ActiveDrags,o.m5.uuid,s={dragStartX:o.x,dragStartY:o.y,dragPtrX:i.x,dragPtrY:i.y,dragged:o,id:i.id}),r.assoc(e.ActiveDragsID,i.id,s),t=o.parent.children,r.disj(t,o),t.push(o);break}}}},updateDrags(t){if(this.state[0])if(this.dragged)n.set(this.dragged,this.dragStartX+(this.x-this.dragPtrX),this.dragStartY+(this.y-this.dragPtrY));else for(let t,e,i=this.DragDrops.length-1;i>=0;--i)if(e=this.DragDrops[i],e.m5.drag&&this.hitTest(e)){this.dragStartX=e.x,this.dragStartY=e.y,this.dragPtrX=this.x,this.dragPtrY=this.y,this.dragged=e,t=e.parent.children,r.disj(t,e),t.push(e);break}this.state[1]&&(this.dragged&&this.dragged.m5.onDragDropped&&this.dragged.m5.onDragDropped(),this.dragged=e)},getGlobalPosition(){return{x:this.x,y:this.y}},_press(){let t,e=0,i=_Z.topMost(),s=this.Buttons.length;for(;e<s;++e)if(t=this.Buttons[e],(t.m5.gui||t.m5.root===i)&&t.m5.press&&this.hitTest(t)){t.m5.press(t);break}},_press(){for(let e,i=0,s=this.Buttons.length;i<s;++i)if(e=this.Buttons[i],(!t.pauseInput||e.m5.gui)&&e.m5.press&&this.hitTest(e)){e.m5.press(e);break}},_doMDown(t){let e,i=o;for(let s,n=0;n<i.Hotspots.length;++n)if(s=i.Hotspots[n],s.m5.touch&&i.hitTest(s)){s.m5.touch(s,t),e=!0;break}return e},mouseDown(e){let s=o,n=r.now();0==e.button&&(e.preventDefault(),s._x=e.pageX-e.target.offsetLeft,s._y=e.pageY-e.target.offsetTop,r.setVec(s.state,!0,!1),s.downTime=n,s.downAt[0]=s._x,s.downAt[1]=s._y,i.Sound.init(),t.pauseInput||(i.emit(["mousedown"]),s._doMDown(!0)))},mouseMove(e){let s=o;s._x=e.pageX-e.target.offsetLeft,s._y=e.pageY-e.target.offsetTop,t.pauseInput||i.emit(["mousemove"])},mouseUp(e){let s=o,a=r.now();if(0==e.button&&(e.preventDefault(),s.elapsedTime=Math.max(0,a-s.downTime),s._x=e.pageX-e.target.offsetLeft,s._y=e.pageY-e.target.offsetTop,r.setVec(s.state,!1,!0),!t.pauseInput&&(i.emit(["mouseup"]),!s._doMDown(!1)))){let t=n.vecAB(s.downAt,s),e=n.len2(t);e<400&&s.elapsedTime<200?(i.emit(["single.tap"]),s._press()):s._swipeMotion(t,e,s.elapsedTime)}},_swipeMotion(t,e,s,r){let o,a=n.unit$(n.normal(t));e>400&&s<1e3&&(Math.abs(a[0])>.8||Math.abs(a[1])>.8)&&(a[0]>.8&&(o="swipe.down"),a[0]<-.8&&(o="swipe.up"),a[1]>.8&&(o="swipe.left"),a[1]<-.8&&(o="swipe.right")),o&&i.emit([o],r)},_doMTouch(t,e){let i=o,s=r.jsMap();for(let n,r=0;r<t.length;++r){n=t[r];for(let t,r=0;r<i.Hotspots.length;++r)if(t=i.Hotspots[r],t.m5.touch&&i._test(t,n.x,n.y)){t.m5.touch(t,e),s.set(n.id,1);break}}return s},_doMDrag(t,e){let i=o;for(let s,n,r=0;r<t.length;++r)n=t[r],e.get(n.id)||(s=i.ActiveDragsID.get(n.id),s&&(e.set(n.id,1),s.dragged.m5.onDragDropped&&s.dragged.m5.onDragDropped(),i.ActiveDragsID.delete(n.id),i.ActiveDrags.delete(s.dragged.m5.uuid)));return e},touchCancel(t){console.warn("received touchCancel event!"),this.freeTouches()},touchStart(e){let s=o,n=e.target,a=[],l=r.now(),h=e.targetTouches,c=s.ActiveTouches;e.preventDefault();for(let t,e,o,d,u,p=0;p<h.length;++p)u=h[p],d=u.identifier,e=u.pageX-n.offsetLeft,o=u.pageY-n.offsetTop,r.assoc(c,d,t={id:d,_x:e,_y:o,downTime:l,downAt:[e,o],x:e/i.scale,y:o/i.scale}),a.push(t),0===p&&(s.touchZeroID=d,s._x=e,s._y=o,s.downTime=l,s.downAt=[e,o],r.setVec(s.state,!0,!1));i.Sound.init(),t.pauseInput||(i.emit(["touchstart"],a),s._doMTouch(a,!0))},touchMove(e){let s=[],n=o,r=e.target,a=e.targetTouches;e.preventDefault();for(let t,e,o,l,h,c=0;c<a.length;++c)l=a[c],h=l.identifier,t=l.pageX-r.offsetLeft,e=l.pageY-r.offsetTop,h==n.touchZeroID&&(n._x=t,n._y=e),(o=n.ActiveTouches.get(h))&&(o.x=t/i.scale,o.y=e/i.scale,o._x=t,o._y=e,s.push(o));t.pauseInput||i.emit(["touchmove"],s)},touchEnd(e){let s,n,a,l,h,c,d=o,u=[],p=(e.targetTouches,e.changedTouches),m=e.target,g=r.now();for(e.preventDefault(),a=0;a<p.length;++a)h=p[a],c=h.identifier,s=h.pageX-m.offsetLeft,n=h.pageY-m.offsetTop,l=d.ActiveTouches.get(c),c==d.touchZeroID&&(d.elapsedTime=Math.max(0,g-d.downTime),r.setVec(d.state,!1,!0),d._x=s,d._y=n),l&&(l.elapsedTime=Math.max(0,g-l.downTime),d.ActiveTouches.delete(c),l._x=s,l._y=n,l.x=s/i.scale,l.y=n/i.scale,u.push(l));if(!t.pauseInput){i.emit(["touchend"],u);let t=d._doMTouch(u,!1);d._doMDrag(u,t),d._onMultiTouches(u,t)}},_onMultiTouches(t,e){let s=o;for(let r,o,a,l=0;l<t.length;++l)if(r=t[l],!e.get(r.id))if(o=n.vecAB(r.downAt,r),a=n.len2(o),a<400&&r.elapsedTime<200){i.emit(["single.tap"],r);for(let t,e=0,i=s.Buttons.length;e<i;++e)if(t=s.Buttons[e],t.m5.press&&s._test(t,r.x,r.y)){t.m5.press(t);break}}else s._swipeMotion(o,a,r.elapsedTime,r)},freeTouches(){r.setVec(this.state,!1,!0),this.touchZeroID=0,this.ActiveTouches.clear(),this.ActiveDrags.clear(),this.ActiveDragsID.clear()},reset(){r.setVec(this.state,!1,!0),this.freeTouches(),this.DragDrops.length=0,this.Buttons.length=0,this.Hotspots.length=0},_test(t,e,r){let o=i.Sprites,a=o.gposXY(t),l=o.toPolygon(t),h=n.translate(a,l.calcPoints);return s.hitTestPointInPolygon(e,r,h)},hitTest(t){return this._test(t,this.x,this.y)},update(t){this.DragDrops.length>0&&(i.touchDevice?this.updateMultiDrags(t):this.updateDrags(t)),this.tail&&this.updateTrail()},updateTrail(){this.tailHistX.pop(),this.tailHistY.pop(),this.tailHistX.unshift(this.x),this.tailHistY.unshift(this.y),this.tailPoints.forEach(((t,e)=>{t.x=this.cubic(this.tailHistX,e/d*c),t.y=this.cubic(this.tailHistY,e/d*c)}))},cubic(t,e,i=1){function s(t,e){return t<0&&(t=0),t>e.length-1&&(t=e.length-1),e[t]}function n(t,e){return i*(s(t+1,e)-s(t-1,e))/2}const r=Math.floor(e),o=[n(r,t),n(r+1,t)],a=[s(r,t),s(r+1,t)],l=(e-=r)*e,h=e*l;return(2*h-3*l+1)*a[0]+(h-2*l+e)*o[0]+(-2*h+3*l)*a[1]+(h-l)*o[1]},disableTrail(){this.tail&&i.stage.removeChild(this.tail),this.tail=null,this.tailHistX=null,this.tailHistY=null,this.tailPoints=null},enableTrail(){const t=r.fill(d,(()=>new PIXI.Point(0,0))),e=i.tcached("boot/trail.png"),s=new PIXI.SimpleRope(e,t);s.blendmode=PIXI.BLEND_MODES.ADD,this.tail=s,this.tailPoints=t,this.tailHistX=r.fill(c,0),this.tailHistY=r.fill(c,0),i.stage.addChild(s)}};const a=[["mousemove",i.canvas,o.mouseMove],["mousedown",i.canvas,o.mouseDown],["mouseup",window,o.mouseUp]],l=[["touchmove",i.canvas,o.touchMove],["touchstart",i.canvas,o.touchStart],["touchend",window,o.touchEnd],["touchcancel",window,o.touchCancel]];return i.touchDevice?r.addEvent(l):r.addEvent(a),o.dispose=function(){this.reset(),i.touchDevice?r.delEvent(l):r.delEvent(a)},o}(this)),this.ptr},update(t){this.pauseInput||this.ptr.update(t)},keybd(t,e,s){const n=this,a={press:e,release:s,isDown:!1,isUp:!0,ctrl:!1,alt:!1,shift:!1};function l(t){t.preventDefault(),a.code.includes(t.keyCode)&&(a.ctrl=t.ctrlKey,a.alt=t.altKey,a.shift=t.shiftKey,!n.pauseInput&&a.isUp&&a.press&&a.press(a.alt,a.ctrl,a.shift),a.isUp=!1,a.isDown=!0)}function h(t){t.preventDefault(),a.code.includes(t.keyCode)&&(n.pauseInput||a.isDown&&a.release&&a.release(),a.isUp=!0,a.isDown=!1,a.ctrl=!1,a.alt=!1,a.shift=!1)}return a.code=o.vec(t)?t:[t],i.touchDevice||r.addEvent([["keyup",window,h,!1],["keydown",window,l,!1]]),a.dispose=()=>{i.touchDevice||r.delEvent([["keyup",window,h,!1],["keydown",window,l,!1]])},a},reset(){this.pauseInput=!1,this.ctrlKey=!1,this.altKey=!1,this.shiftKey=!1,this.ptr.reset(),this.keyInputs.clear()},resize(){i.mouse=this.ptr,this.ptr.reset()},dbg(){console.log(`N# of touches= ${this.ptr.ActiveTouches.size}`),console.log(`N# of hotspots= ${this.ptr.Hotspots.length}`),console.log(`N# of buttons= ${this.ptr.Buttons.length}`),console.log(`N# of drags= ${this.ptr.DragDrops.length}`),console.log(`Mouse pointer = ${this.ptr}`)}}),i.touchDevice||r.addEvent([["keyup",window,a,!1],["keydown",window,l,!1]]),t}const c=20,d=100;const u={LEFT:37,RIGHT:39,UP:38,DOWN:40,ZERO:48,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,ENTER:13,ESC:27,BACKSPACE:8,TAB:9,SHIFT:16,CTRL:17,ALT:18,SPACE:32,HOME:36,END:35,PGGUP:33,PGDOWN:34,isPaused:()=>l().pauseInput,resume(){l().pauseInput=!1},pause(){l().pauseInput=!0},dbg(){l().dbg()},resize(){l().resize()},reset(){l().reset()},setKeyOn(t){l().keyInputs.set(t,!0)},setKeyOff(t){l().keyInputs.set(t,!1)},keybd:(t,e,i)=>l().keybd(t,e,i),undoButton:t=>(r.disj(l().ptr.Buttons,t),t.m5.button=!1,t),makeButton:(t,e=!1)=>(r.conj(l().ptr.Buttons,t),t.m5.button=!0,t.m5.gui=e,t),undoHotspot:t=>(r.disj(l().ptr.Hotspots,t),t.m5.hotspot=!1,t),makeHotspot:t=>(r.conj(l().ptr.Hotspots,t),t.m5.hotspot=!0,t),update(t){l().update(t)},makeDrag:t=>(r.conj(l().ptr.DragDrops,t),t.m5.drag=!0,t),undoDrag:t=>(r.disj(l().ptr.DragDrops,t),t.m5.drag=!1,t),keyUp(t){return!this.keyDown(t)},keyDown:t=>l().keyInputs.get(t),keyShift:()=>l().shiftKey,keyAlt:()=>l().altKey,keyCtrl:()=>l().ctrlKey,pointer:()=>l().pointer(),dispose(){a.forEach((t=>t.dispose()))},pop(){a.length>1&&(a.shift().dispose(),l().pauseInput=!1)},push(){a[0].pauseInput=!0,a.unshift(h())}};return i.canvas.style.touchAction="none",u.undoBtn=u.undoButton,u.mkBtn=u.makeButton,u.mkDrag=u.makeDrag,a.push(h()),i.Input=u}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Input"]=function(t){return t.Input?t.Input:i(t)}}(this),function(t,e){"use strict";function i(t){const e=Math.PI/8,i=3*e,s=5*e,n=7*e,{Sprites:r,Input:o,is:a,ute:l}=t,h=Math.sin,c=Math.cos,d=Math.abs,u=180/Math.PI;function p(r){function a(t){let e=t.changedTouches,i=t.target;e?(t=e[0],r.m5.touchId=e[0].identifier):r.m5.touchId=0,r.m5.startX=t.pageX-i.offsetLeft,r.m5.startY=t.pageY-i.offsetTop,r.m5.drag=!0,r.m5.static||(r.visible=!0,r.x=r.m5.startX,r.y=r.m5.startY),o.isPaused()||r.m5.onStart()}function p(t){r.m5.drag&&(r.m5.inner.position.set(0,0),r.m5.drag=!1,r.m5.static||(r.visible=!1),o.isPaused()||r.m5.onEnd())}function m(a){if(o.isPaused()||!r.visible||!r.m5.drag)return;let p,m=a.target;if(a.changedTouches){for(let t=0,e=a.changedTouches;t<e.length;++t)if(r.m5.touchId==e[t].identifier){p=[e[t].pageX-m.offsetLeft,e[t].pageY-m.offsetTop];break}}else p=[a.pageX-m.offsetLeft,a.pageY-m.offsetTop];let g=p?p[0]-r.m5.startX:0,f=p?p[1]-r.m5.startY:0,x=r.m5.range,y=0;if(p[0]=0,p[1]=0,l.feq0(g)&&l.feq0(f))return;let v,w=d(g),b=d(f);if(l.feq0(g))p[0]=0,f>0?(p[1]=f>x?x:f,y=270,v=t.DOWN):(p[1]=-(b>x?x:b),y=90,v=t.UP);else if(l.feq0(f))p[1]=0,g>0?(p[0]=w>x?x:w,y=0,v=t.RIGHT):(p[0]=-(w>x?x:w),y=180,v=t.LEFT);else{let r=Math.atan(d(f/g));y=r*u,p[0]=p[1]=0,g*g+f*f>=x*x?(p[0]=x*c(r),p[1]=x*h(r)):(p[0]=w>x?x:w,p[1]=b>x?x:b),f<0&&(p[1]=-d(p[1])),g<0&&(p[0]=-d(p[0])),g>0&&f<0||(g<0&&f<0?y=180-y:g<0&&f>0?y+=180:g>0&&f>0&&(y=360-y)),v=function(r,o){const a=Math.atan2(+o,+r);return a>-s&&a<-i?(console.log("calcDir=UP"),t.UP):a>i&&a<s?(console.log("calcDir=DOWN"),t.DOWN):a>-e&&a<0||a>0&&a<e?(console.log("calcDir=RIGHT"),t.RIGHT):a>n&&a<Math.PI||a>-Math.PI&&a<-n?(console.log("calcDir=LEFT"),t.LEFT):a>e&&a<i?(console.log("calcDir= SE "),t.SE):a>s&&a<n?(console.log("calcDir= SW "),t.SW):a>-i&&a<-e?(console.log("calcDir= NE "),t.NE):a>-n&&a<-s?(console.log("calcDir= NW "),t.NW):void l.assert(!1,"Failed Joystick calcDir")}(p[0],p[1])}r.m5.inner.position.set(p[0],p[1]),r.m5.onChange(v,y)}const g=[["mousemove",t.canvas,m],["mousedown",t.canvas,a],["mouseup",window,p],["touchend",window,p],["touchcancel",window,p],["touchmove",t.canvas,m],["touchstart",t.canvas,a]];return l.addEvent(g),r.m5.dispose=()=>{l.delEvent(g)},r}const m={assets:["boot/joystick.png","boot/joystick-handle.png"],joystick(t){let e=r.sprite("boot/joystick-handle.png"),i=r.sprite("boot/joystick.png"),s=new PIXI.Container,n=l.inject({oscale:.7,iscale:1,inner:e,outer:i,onEnd(){},onStart(){},prevDir:0,static:!1,onChange(t,e){}},t);return r.scaleXY(i,n.oscale,n.oscale),r.scaleXY(e,n.iscale,n.iscale),i.anchor.set(.5),e.anchor.set(.5),s.addChild(i),s.addChild(e),n.range=s.width/2.5,n.static||(s.visible=!1),s.m5=n,p(s)}};return t.Touch=m}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Touch"]=function(t){return t.Touch?t.Touch:i(t)}}(this),function(t,e){"use strict";function i(e){const i=t["io/czlab/mcfud/geo2d"](),s=t["io/czlab/mcfud/vec2"](),n=t["io/czlab/mcfud/math"](),{Scenes:r,Sprites:o,Input:a,is:l,ute:h}=e,c=Math.abs,d=Math.cos,u=Math.sin,p=Math.floor,m=Math.PI/180;Math.PI;r.scene("PhotoMat",{setup(t){if(t.cb)t.cb(this);else{let i=t.image?e.tcached(t.image):undefined;this.g.gfx=o.graphics(),i?this.g.gfx.beginTextureFill({texture:i}):this.g.gfx.beginFill(o.color(t.color)),this.g.gfx.drawRect(0,0,e.width,t.y1),this.g.gfx.drawRect(0,t.y2,e.width,e.height-t.y2),this.g.gfx.drawRect(0,0,t.x1,e.height),this.g.gfx.drawRect(t.x2,0,e.width-t.x2,e.height),this.g.gfx.endFill(),this.insert(this.g.gfx)}}}),r.scene("AudioIcon",{setup(t){let{xOffset:i,yOffset:n,xScale:r,yScale:l}=t,{cb:c,iconOn:d,iconOff:u}=t,{Sound:p}=e,m=e.getScaleFactor(),g=a.mkBtn(o.spriteFrom(d||"audioOn.png",u||"audioOff.png"));r=h.nor(r,2*m),l=h.nor(l,2*m),i=h.nor(i,-10*m),n=h.nor(n,0),o.scaleXY(o.opacity(g,.343),r,l),s.set(g,e.width-g.width+i,0+n),g.m5.showFrame(p.sfx()?0:1),g.m5.press=()=>{p.sfx()?(p.mute(),g.m5.showFrame(1)):(p.unmute(),g.m5.showFrame(0))},this.insert(g)}}),r.scene("StarfieldBg",{setup(t){h.patch(t,{height:e.height,width:e.width,count:100,minVel:15,maxVel:30});const i=[],n=o.graphics();h.inject(this.g,{gfx:n,stars:i,lag:0,dynamic:!0,fps:1/t.fps,draw(){return n.clear(),i.forEach((t=>{n.beginFill(16777215),n.drawRect(t.x,t.y,t.size,t.size),n.endFill()})),this},moveStars(e){this.lag+=e,this.lag>=this.fps&&(this.lag=0,i.forEach((i=>{i.y+=e*i.vel,i.y>t.height&&(s.set(i,h.randInt(t.width),0),i.size=h.randInt(4),i.vel=h.rand()*(t.maxVel-t.minVel)+t.minVel)})),this.draw())}}),t.static&&(this.g.dynamic=!1);for(let e=0;e<t.count;++e)i[e]={x:h.rand()*t.width,y:h.rand()*t.height,size:3*h.rand()+1,vel:h.rand()*(t.maxVel-t.minVel)+t.minVel};this.g.draw()&&this.insert(n)},postUpdate(t){this.g.dynamic&&this.g.moveStars(t)}},{fps:90,count:100,minVel:15,maxVel:30});e.defMixin("arcade",(function(t,...i){const{Sprites:n}=e,r=[],o=[],a=[],d={dispose(){r.forEach((t=>t.dispose())),o.forEach((t=>e.off(...t)))},boom(i){if(h.assert(i.A===t,"got hit by someone else???"),i.B&&i.B.m5.sensor)e.emit(["2d.sensor",i.B],i.A);else{let[n,r]=t.m5.vel;i.impact=null,s.sub$(t,i.overlapV),i.overlapN[1]<-.3&&(!t.m5.skipHit&&r<0&&s.setY(t.m5.vel,0),i.impact=c(r),e.emit(["bump.top",t],i)),i.overlapN[1]>.3&&(!t.m5.skipHit&&r>0&&s.setY(t.m5.vel,0),i.impact=c(r),e.emit(["bump.bottom",t],i)),i.overlapN[0]<-.3&&(!t.m5.skipHit&&n<0&&s.setX(t.m5.vel,0),i.impact=c(n),e.emit(["bump.left",t],i)),i.overlapN[0]>.3&&(!t.m5.skipHit&&n>0&&s.setX(t.m5.vel,0),i.impact=c(n),e.emit(["bump.right",t],i)),l.num(i.impact)?e.emit(["bump",t],i):i.impact=0}a.shift(i)},onTick(e){a.length=0,l.num(e)&&(s.add$(t.m5.vel,s.mul(t.m5.gravity,e)),s.add$(t.m5.vel,s.mul(t.m5.acc,e)),s.mul$(t.m5.vel,t.m5.friction)),t.parent.collideXY(n.move(t,e)),r.forEach((t=>t.onTick(e,a)))}};return o.push([["hit",t],"boom",d],[["post.remove",t],"dispose",d]),o.forEach((t=>e.on(...t))),i.forEach((e=>{let i,s=e[0];e[0]=t,i=s(...e),i.onTick&&r.push(i),h.assert(l.str(s.name))&&(d[s.name]=i)})),d})),e.defMixin("camera2d",(function(t,i,s,r){let o=0,a=0;const c=r?r.height:s,d=r?r.width:i,u=n.ndiv(c,2),m=n.ndiv(d,2),g=n.ndiv(c,4),f=n.ndiv(d,4),{Sprites:x}=e,y=[],v={dispose(){y.forEach((t=>e.off(...t)))},set x(e){o=e,t.x=-o},set y(e){a=e,t.y=-a},get x(){return o},get y(){return a},worldHeight:s,worldWidth:i,width:d,height:c,follow(t){const e=h.feq0(t.angle)?x.getAABB(t):x.boundingBox(t);(()=>{e.x1<this.x+p(m-f)&&(this.x=e.x1-f)})(),(()=>{e.x2>this.x+p(m+f)&&(this.x=e.x2-3*f)})(),(()=>{e.y1<this.y+p(u-g)&&(this.y=e.y1-g)})(),(()=>{e.y2>this.y+p(u+g)&&(this.y=e.y2-3*g)})(),this.x<0&&(this.x=0),this.y<0&&(this.y=0),this.x+d>i&&(this.x=i-d),this.y+c>s&&(this.y=s-c);let{x1:n,x2:r,y1:o,y2:a}=t.m5.getImageOffsets(),l=e.x2-r;l>i&&(t.x-=l-i),l=e.y2-a,l>s&&(t.y-=l-s),l=e.x1+n,l<0&&(t.x+=-l),l=e.y1+o,l<0&&(t.y+=-l)},centerOver:function(t,e){if(1!=arguments.length||l.num(t))l.num(t)&&(this.x=t-m),l.num(e)&&(this.y=e-u);else{let e=x.centerXY(t);this.x=e[0]-m,this.y=e[1]-u}}};return y.push([["post.remove",t],"dispose",v]),y.forEach((t=>e.on(...t))),v}));const g={PeriodicDischarge:class{constructor(t,e,i=16){this._interval=e,this._ctor=t,this._timer=0,this._size=i,this._pool=h.fill(i,t)}lifeCycle(t){this._timer+=t,this._timer>this._interval&&(this._timer=0,this.discharge())}discharge(){throw"PeriodicCharge: please implement action()"}reclaim(t){this._pool.length<this._size&&this._pool.push(t)}_take(){return this._pool.length>0?this._pool.pop():this._ctor()}},seek(t,e){let i=s.unit$(s.sub(e,t));return i&&(s.mul$(i,t.m5.maxSpeed),s.sub$(i,t.m5.vel),s.add$(t.m5.steer,i)),t},flee(t,e,i){let n=s.sub(t,e),r=s.len2(n);void 0===i&&(i=t.m5.steerInfo.tooCloseDistance),r>i*i||(s.unit$(n)||(n=[.1,.1]),s.mul$(n,t.m5.maxSpeed),s.sub$(n,t.m5.vel),s.add$(t.m5.steer,n))},arrive(t,e,i){let n=1,r=s.dist(t,e),o=s.unit$(s.sub(e,t));void 0===i&&(i=t.m5.steerInfo.arrivalThreshold),r>i||(n=r/i),s.mul$(o,t.m5.maxSpeed*n),s.sub$(o,t.m5.vel),s.add$(t.m5.steer,o)},pursue(t,e){let i=s.dist(t,e)/t.m5.maxSpeed,n=s.add(e,s.mul(e.m5.vel,i));return this.seek(t,n)},evade(t,e){let i=s.dist(t,e)/t.m5.maxSpeed,n=s.sub(e,s.mul(e.m5.vel,i));return this.flee(t,n)},idle:t=>(s.mul$(t.m5.vel,0),s.mul$(t.m5.steer,0),t),wander(t){let e=s.mul$([1,1],t.m5.steerInfo.wanderRadius),i=s.len(e),n=s.mul$(s.unit(t.m5.vel),t.m5.steerInfo.wanderDistance);return e[0]=Math.cos(t.m5.steerInfo.wanderAngle)*i,e[1]=Math.sin(t.m5.steerInfo.wanderAngle)*i,t.m5.steerInfo.wanderAngle+=h.rand()*t.m5.steerInfo.wanderRange-.5*t.m5.steerInfo.wanderRange,s.add$(t.m5.steer,s.add$(n,e)),t},interpose(t,e,i){let n=s.div$(s.add(e,i),2),r=s.dist(t,n)/t.m5.maxSpeed,o=s.add(e,s.mul(e.m5.vel,r)),a=s.add(i,s.mul(i.m5.vel,r));return this.seek(t,s.div$(s.add$(o,a),2))},separation(t,e,i=300,n=100){let r=[0,0],o=0;e.forEach((e=>{e!==t&&s.dist(e,t)<i&&(s.add$(r,s.sub(e,t)),++o)})),o>0&&s.flip$(s.div$(r,o)),s.add$(t.m5.steer,s.mul$(s.unit$(r),n))},followLeader(t,e,i,n=400,r=300,o=100,a=1600,l=200){let h=s.mul$(s.unit(e.m5.vel),n),c=s.add(e,h);s.flip$(h);let d=s.add(e,h);return function(t,e,i,n){return s.dist(i,t)<n||s.dist(e,t)<n}(t,e,c,a)&&this.evade(t,e),this.arrive(t,d,l),this.separation(t,i,r,o)},queue(t,e,i=500,n=500){let r=function(){let r,o=s.mul$(s.unit(t.m5.vel),i),a=s.add(t,o);for(let i=0;i<e.length;++i)if(e[i]!==t&&s.dist(a,e[i])<n){r=e[i];break}return r}(),o=[0,0],a=s.mul(t.m5.vel,1);r&&(o=s.mul$(s.flip(t.m5.steer),.8),s.unit$(s.flip$(a)),s.add$(o,a),s.dist(t,r)<n&&s.mul$(t.m5.vel,.3)),s.add$(t.m5.steer,o)},flock(t,e){let i=0,n=[0,0],r=s.mul(t.m5.vel,1);e.forEach((e=>{e!==this&&function(e){return!(s.dist(t,e)>t.m5.steerInfo.inSightDistance||s.dot(s.sub(e,t),s.unit(t.m5.vel))<0)}(e)&&(s.add$(r,e.m5.vel),s.add$(n,e),s.dist(t,e)<t.m5.steerInfo.tooCloseDistance&&this.flee(t,e),++i)})),i>0&&(s.div$(r,i),s.div$(n,i),this.seek(t,n),s.add$(t.m5.steer,s.sub$(r,t.m5.vel)))},followPath(t,e,i,n=1){let r=e[t.m5.pathIndex];r&&(s.dist(t,r)<n&&(t.m5.pathIndex>=e.length-1?i&&(t.m5.pathIndex=0):t.m5.pathIndex+=1),t.m5.pathIndex>=e.length-1&&!i?this.arrive(t,r):this.seek(t,r))},avoid(t,e){let i,n=s.len(t.m5.vel)/t.m5.maxSpeed,r=s.add(t,s.mul$(s.unit(t.m5.vel),n)),o=s.add(t,s.mul$(s.unit(t.m5.vel),.5*t.m5.steerInfo.avoidDistance)),a=null;for(let i,n=0;n<e.length;++n)e[n]!==this&&(i=s.dist(e[n],r)<=e[n].m5.radius||s.dist(e[n],o)<=e[n].m5.radius,i&&(null===a||s.dist(t,e[n])<s.dist(t,a))&&(a=e[n]));a&&(i=s.mul$(s.unit$(s.sub(r,a)),100),s.add$(t.m5.steer,i))},lineOfSight(t,e,s){let n=o.centerXY(t),r=o.centerXY(e);for(let t,e,a=0;a<s.length;++a)if(e=s[a],t=e.m5.circle?i.hitTestLineCircle(n,r,e.x,e.y,e.width/2):i.hitTestLinePolygon(n,r,i.bodyWrap(o.toPolygon(e),e.x,e.y)),t[0])return!1;return!0},shoot(t,i,n,r,o,a){let l=r(),h=e.Sprites.topLeftOffsetXY(t);return s.add$(h,[o,a]),s.copy(l,s.add(t,h)),s.set(l.m5.vel,Math.cos(i)*n,Math.sin(i)*n),l},healthBar(t){let{scale:e,width:i,height:s,lives:a,borderWidth:l,line:h,fill:c}=t,d=4*e,u=4*e,p=[];l=(l||4)*e,a=a||3,c=o.color(c),h=o.color(h);for(let t=n.ndiv(i,a),e=0;e<a;++e)p.push(o.rect(t,s-2*l,c));return{dec(){return this.lives>0&&(this.lives-=1,p[this.lives].visible=!1),this.lives>0},lives:p.length,sprite:r.layoutX(p,{bg:["#cccccc",0],borderWidth:l,border:h,padding:d,fit:u})}},gaugeUI(t){let{minDeg:e,maxDeg:i,line:s,gfx:r,scale:a,cx:l,cy:c,radius:p,alpha:g,fill:f,needle:x}=h.patch(t,{minDeg:90,maxDeg:360});const y=[0,45*m,90*m,135*m,180*m,225*m,270*m,315*m];function v(t,e,i,s){return[t+i*d(s),e+i*u(s)]}return x=o.color(x),s=o.color(s),f=o.color(f),p*=a,{gfx:r,draw(){r.clear(),r.lineStyle({width:p/8,color:s}),r.beginFill(f,g),r.drawCircle(l,c,p),r.endFill(),y.forEach((t=>function(t,e,i,n){let[o,l]=v(t,e,p-4*a,i),[h,c]=v(t,e,p-12*a,i);r.lineStyle({color:s,width:n,cap:PIXI.LINE_CAP.ROUND}),r.moveTo(o,l),r.lineTo(h,c),r.closePath()}(l,c,t,7*a))),function(t,e,i){let[n,o]=v(l,c,t-20*a,i),[h,d]=v(l,c,2*a,i+90*m),[u,p]=v(l,c,2*a,i-90*m);r.lineStyle({cap:PIXI.LINE_CAP.ROUND,width:4*a,color:x}),r.moveTo(h,d),r.lineTo(n,o),r.lineTo(u,p),r.closePath(),r.lineStyle({color:s}),r.beginFill(s),r.drawCircle(l,c,9*a),r.endFill()}(p*a,0,m*n.lerp(e,i,t.update()))}}},Patrol(t,i,n){const r=[],o={dispose(){r.forEach((t=>e.off(...t)))},goLeft(i){t.m5.heading=e.LEFT,t.m5.flip="x",s.setX(t.m5.vel,-i.impact)},goRight(i){t.m5.heading=e.RIGHT,t.m5.flip="x",s.setX(t.m5.vel,i.impact)},goUp(i){s.setY(t.m5.vel,-i.impact),t.m5.heading=e.UP,t.m5.flip="y"},goDown(i){s.setY(t.m5.vel,i.impact),t.m5.heading=e.DOWN,t.m5.flip="y"}};return r.push([["post.remove",t],"dispose",o]),i&&r.push([["bump.right",t],"goLeft",o],[["bump.left",t],"goRight",o]),n&&r.push([["bump.top",t],"goDown",o],[["bump.bottom",t],"goUp",o]),r.forEach((t=>e.on(...t))),o},Platformer(t){const{Input:i,Sprites:n}=e,r=[],o={jumpKey:i.UP,jumpSpeed:-300,_jumping:0,_ground:0,dispose(){r.forEach((t=>e.off(...t)))},onGround(){o._ground=.24},onTick(e,i){t.m5.skipHit||this._onTick(e,i),o._ground-=e},_onTick(n,r){let a=r[0],l=t.m5.speed,h=o.jumpSpeed/3,c=i.keyDown(i.RIGHT),d=i.keyDown(i.LEFT),u=i.keyDown(o.jumpKey);a&&(d||c||o._ground>0)&&(a.overlapN[1]>.85||a.overlapN[1]<-.85)&&(a=null),d&&!c?(t.m5.heading=e.LEFT,a&&o._ground>0?s.set(t.m5.vel,l*a.overlapN[0],-l*a.overlapN[1]):s.setX(t.m5.vel,-l)):c&&!d?(t.m5.heading=e.RIGHT,a&&o._ground>0?s.set(t.m5.vel,-l*a.overlapN[0],l*a.overlapN[1]):s.setX(t.m5.vel,l)):(s.setX(t.m5.vel,0),a&&o._ground>0&&s.setY(t.m5.vel,0)),o._ground>0&&!o._jumping&&u?(s.setY(t.m5.vel,o.jumpSpeed),o._jumping+=1,o._ground=-n):u&&o._jumping<2&&(o._jumping+=1,e.emit(["jump",t])),o._jumping&&!u&&(o._jumping=0,e.emit(["jumped",t]),t.m5.vel[1]<h&&(t.m5.vel[1]=h))}};return r.push([["bump.bottom",t],"onGround",o]),r.forEach((t=>e.on(...t))),o},MazeRunner(t,i){const{Sprites:n,Input:r}=e,o={dispose(){e.off(o)},onTick(n){let o,a,c,d,[u,p]=t.m5.vel,m=t.m5.speed,g=!h.feq0(u),f=!h.feq0(p);g&&f||!i||(f&&(l.obj(i)?t.m5.showFrame(i[p>0?e.DOWN:e.UP]):i&&(t.angle=p>0?180:0)),g&&(l.obj(i)?t.m5.showFrame(i[u>0?e.RIGHT:e.LEFT]):i&&(t.angle=u>0?90:-90))),e.u.touchOnly?(o=t.m5.heading===e.RIGHT,c=t.m5.heading===e.LEFT,d=t.m5.heading===e.UP,a=t.m5.heading===e.DOWN):(o=r.keyDown(r.RIGHT)&&e.RIGHT,a=r.keyDown(r.DOWN)&&e.DOWN,c=r.keyDown(r.LEFT)&&e.LEFT,d=r.keyDown(r.UP)&&e.UP),(c||d)&&(m*=-1),c&&o?s.setX(t.m5.vel,0):(c||o)&&(t.m5.heading=c||o,s.setX(t.m5.vel,m)),d&&a?s.setY(t.m5.vel,0):(d||a)&&(t.m5.heading=d||a,s.setY(t.m5.vel,m))}};return t.m5.heading=e.UP,o}};return e.Arcade=g}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Arcade"]=t=>t.Arcade?t.Arcade:i(t)}(this),function(t,e){"use strict";function i(e,i,s){const n=t["io/czlab/mcfud/math"](),r=t["io/czlab/mcfud/vec2"](),{ute:o,is:a}=e,l=(Math.floor,5*Math.PI),h=Math.PI/2,c=2*Math.PI;function d(t,s,n=60,r=!1,l={}){return o.inject({duration:n,sprite:t,easing:s,loop:r,cur:0,on:0,onFrame(t,e){},_run(){this.cur=0,this.on=1,i.push(this)},onTick(){this.on&&(this.cur<this.duration?(this.onFrame(!1,this.easing(this.cur/this.duration)),this.cur+=1):(this.onFrame(!0),this.loop?(a.num(this.loop)&&--this.loop,this.onLoopReset(),this.cur=0):(this.on=0,this.onComplete&&o.delay(0,(()=>this.onComplete())),this.dispose())))},dispose(){o.disj(i,this),e.emit(["tween.disposed"],this)}},l)}function u(t,e,i,s){return d(t,e,i,s,{start(t,e,i,s){this._x=a.num(e)?[t,e]:null,this._y=a.num(s)?[i,s]:null,this._run()},onLoopReset(){this._x&&o.swap(this._x,0,1),this._y&&o.swap(this._y,0,1)},onFrame(t,e){this._x&&(this.sprite.x=t?this._x[1]:n.lerp(this._x[0],this._x[1],e)),this._y&&(this.sprite.y=t?this._y[1]:n.lerp(this._y[0],this._y[1],e))}})}const p={EXPO_IN:t=>0==t?0:Math.pow(1024,t-1),EXPO_OUT:t=>1==t?1:1-Math.pow(2,-10*t),EXPO_INOUT:t=>0==t?0:1==t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1))),LINEAR:t=>t,SMOOTH:t=>3*t*t-2*t*t*t,SMOOTH_QUAD(t){let e=p.SMOOTH(t);return e*e},SMOOTH_CUBIC(t){let e=p.SMOOTH(t);return e*e*e},EASE_IN_CUBIC:t=>t*t*t,EASE_OUT_CUBIC(t){let e=1-t;return 1-e*e*e},EASE_INOUT_CUBIC(t){if(t<.5)return 4*t*t*t;{let e=-2*t+2;return 1-e*e*e/2}},EASE_IN_QUAD:t=>t*t,EASE_OUT_QUAD:t=>1-(1-t)*(1-t),EASE_INOUT_QUAD(t){if(t<.5)return 2*t*t;{let e=-2*t+2;return 1-e*e/2}},EASE_IN_SINE:t=>1-Math.cos(t*h),EASE_OUT_SINE:t=>Math.sin(t*h),EASE_INOUT_SINE:t=>.5-Math.cos(t*Math.PI)/2,SPLINE:(t,e,i,s,n)=>(2*i+(s-e)*t+(2*e-5*i+4*s-n)*t*t+(3*i-e-3*s+n)*t*t*t)/2,CUBIC_BEZIER:(t,e,i,s,n)=>e*t*t*t+3*i*t*t*(1-t)+3*s*t*(1-t)*(1-t)+n*(1-t)*(1-t)*(1-t),ELASTIC_IN:t=>0==t?0:1==t?1:-Math.pow(2,10*(t-1))*Math.sin((t-1.1)*l),ELASTIC_OUT:t=>0==t?0:1==t?1:1+Math.pow(2,-10*t)*Math.sin((t-.1)*l),ELASTIC_INOUT(t){switch(t){case 0:return 0;case 1:return 1;default:return(t*=2)<1?-.5*Math.pow(2,10*(t-1))*Math.sin((t-1.1)*l):1+.5*Math.pow(2,-10*(t-1))*Math.sin((t-1.1)*l)}},BOUNCE_IN:t=>1-p.BOUNCE_OUT(1-t),BOUNCE_OUT:t=>t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375,BOUNCE_INOUT:t=>t<.5?.5*p.BOUNCE_IN(2*t):.5*p.BOUNCE_OUT(2*t-1)+.5,tweenAlpha(t,e,i,s=60,r=!1){const l=function(t,e,i,s){return d(t,e,i,s,{start(t,e){this._a=[t,e],this._run()},onLoopReset(){o.swap(this._a,0,1)},onFrame(t,e){this.sprite.alpha=t?this._a[1]:n.lerp(this._a[0],this._a[1],e)}})}(t,e,s,r);let h=t.alpha,c=i;return a.vec(i)&&(h=i[0],c=i[1]),l.start(h,c),l},tweenAngle(t,e,i,s=60,r=!1){const l=function(t,e,i,s){return d(t,e,i,s,{start(t,e){this._a=[t,e],this._run()},onLoopReset(){o.swap(this._a,0,1)},onFrame(t,e){this.sprite.rotation=t?this._a[1]:n.lerp(this._a[0],this._a[1],e)}})}(t,e,s,r);let h=t.rotation,c=i;return a.vec(i)&&(h=i[0],c=i[1]),l.start(h,c),l},tweenScale(t,e,i,s,r=60,l=!1){const h=function(t,e,i,s){return d(t,e,i,s,{start(t,e,i,s){this._x=a.num(e)?[t,e]:null,this._y=a.num(s)?[i,s]:null,this._run()},onLoopReset(){this._x&&o.swap(this._x,0,1),this._y&&o.swap(this._y,0,1)},onFrame(t,e){this._x&&(this.sprite.scale.x=t?this._x[1]:n.lerp(this._x[0],this._x[1],e)),this._y&&(this.sprite.scale.y=t?this._y[1]:n.lerp(this._y[0],this._y[1],e))}})}(t,e,r,l);let c=t.scale.x,u=t.scale.y,p=i,m=s;return a.vec(i)&&(c=i[0],p=i[1]),a.vec(s)&&(u=s[0],m=s[1]),a.num(p)||(c=p=null),a.num(m)||(u=m=null),h.start(c,p,u,m),h},tweenXY(t,e,i,s,n=60,r=!1){const o=u(t,e,n,r);let l=t.x,h=t.y,c=i,d=s;return a.vec(i)&&(l=i[0],c=i[1]),a.vec(s)&&(h=s[0],d=s[1]),a.num(c)||(l=c=null),a.num(d)||(h=d=null),o.start(l,c,h,d),o},fadeOut(t,e=60){return this.tweenAlpha(t,this.EASE_OUT_SINE,0,e)},fadeIn(t,e=60){return this.tweenAlpha(t,this.EASE_OUT_SINE,1,e)},pulse(t,e=0,i=60,s=!0){return this.tweenAlpha(t,this.SMOOTH,e,i,s)},slide(t,e,i,s,n=60){return this.tweenXY(t,e,i,s,n)},throb(t,e=.9,i=.9,s=60,n=!0){return this.tweenScale(t,this.SMOOTH_QUAD,e,i,s,n)},scale(t,e=.5,i=.5,s=60){return this.tweenScale(t,this.SMOOTH,e,i,s)},strobe(t,e=1.3,i=10,s=20,n=10,r=!0){return this.tweenScale(t,(t=>this.SPLINE(t,i,0,1,s)),e,e,n,r)},wobble(t,i,s=1.2,n=1.2,r=10,a=!0){let{x1:l,x2:h,y1:c,y2:d}=i;return function(...t){const i={children:t.slice(),onTweenEnd(t){for(let e,i=0;i<this.children.length;++i)if(e=this.children[i],e===t){this.children.splice(i,1);break}0==this.children.length&&(this.dispose(),this.onComplete&&o.delay(0,(()=>this.onComplete())))},size(){return this.children.length},dispose(){e.off(["tween.disposed"],"onTweenEnd",this),this.children.forEach((t=>t.dispose())),this.children.length=0}};return e.on(["tween.disposed"],"onTweenEnd",i),i}(this.tweenScale(t,(t=>this.SPLINE(t,o.or(l,10),0,1,o.or(h,10))),s,null,r,a),this.tweenScale(t,(t=>this.SPLINE(t,o.or(c,-10),0,1,o.or(d,-10))),null,n,r,a))},followCurve(t,e,i,s=60){let n=u(t,e,s);return n.start=function(){this._run()},n.onFrame=function(e,s){e||r.set(t,p.CUBIC_BEZIER(s,i[0][0],i[1][0],i[2][0],i[3][0]),p.CUBIC_BEZIER(s,i[0][1],i[1][1],i[2][1],i[3][1]))},n.start(),n},walkPath:(t,e,i,s=300)=>function s(n,r){let a=p.tweenXY(t,e,[i[n][0],i[n+1][0]],[i[n][1],i[n+1][1]],r);return a.onComplete=()=>{++n<i.length-1&&o.delay(0,(()=>s(n,r)))},a}(0,n.ndiv(s,i.length)),walkCurve:(t,e,i,s=300)=>function s(n,r){let a=p.followCurve(t,e,i[n],r);return a.onComplete=()=>{++n<i.length&&o.delay(0,(()=>s(n,r)))},a}(0,n.ndiv(s,i.length)),remove(t){t&&t.dispose()},update(t){o.rseq(i,(e=>e.onTick(t))),o.rseq(s,(e=>e.onTick(t)))},createParticles(t,i,n,a,l,h,c,d=!0,u=20){function p(d){let u=o.randInt2(h.size,c.size),p=n();s.push(p),a.addChild(p),p.totalFrames&&p.gotoAndStop(o.randInt2(0,p.totalFrames-1)),e.Sprites.sizeXY(p,u,u),r.set(p,t,i),e.Sprites.centerAnchor(p),p.m5.scaleSpeed=o.randFloat2(h.scale,c.scale),p.m5.alphaSpeed=o.randFloat2(h.alpha,c.alpha),p.m5.angVel=o.randFloat2(h.rotate,c.rotate);let m=o.randFloat2(h.speed,c.speed);r.set(p.m5.vel,m*Math.cos(d),m*Math.sin(d)),p.onTick=function(){r.add$(p.m5.vel,l),r.add$(p,p.m5.vel),p.scale.x-p.m5.scaleSpeed>0&&(p.scale.x-=p.m5.scaleSpeed),p.scale.y-p.m5.scaleSpeed>0&&(p.scale.y-=p.m5.scaleSpeed),p.rotation+=p.m5.angVel,p.alpha-=p.m5.alphaSpeed,p.alpha<=0&&(o.disj(s,p),e.Sprites.remove(p))}}h=o.patch(h,{angle:0,size:4,speed:.3,scale:.01,alpha:.02,rotate:.01}),c=o.patch(c,{angle:6.28,size:16,speed:3,scale:.05,alpha:.02,rotate:.03}),o.assert(u>1),l[0]=0;for(let t=(c.angle-h.angle)/(u-1),e=h.angle,i=0;i<u;++i)p(d?o.randFloat2(h.angle,c.angle):e),e+=t},shake(t,e=16,i=!1,r=!0){let a={},l=1,h=t.x,c=t.y,d=t.rotation,u=e,p=n.ndiv(e,10);let m=1;a.onTick=()=>i?void(l<10?(t.rotation=d,e-=p,t.rotation=e*m,++l,m*=-1):r?(e=u,l=1):o.disj(s,a)):void(l<10?(t.x=h,t.y=c,e-=p,t.x+=o.randInt2(-e,e),t.y+=o.randInt2(-e,e),++l):r?(e=u,l=1):o.disj(s,a)),s.push(a)},StarWarp:function(t){const i=e.tcached("boot/star.png");let s=0,n=0,r=0;const a=o.fill(1e3,(s=>((s={x:0,y:0,z:0,sprite:e.Sprites.sprite(i)}).sprite.anchor.x=.5,s.sprite.anchor.y=.7,l(s,2e3*o.rand()),t.addChild(s.sprite),s)));function l(t,e){const i=o.rand()*c,n=50*o.rand()+1;t.z=o.nor(e,s+1e3*o.rand()+2e3),t.x=Math.cos(i)*n,t.y=Math.sin(i)*n}let h=o.now();return{dispose(){a.forEach((t=>e.Sprites.remove(t.sprite)))},update(t){let i,c=e.width/2,d=e.height/2;n+=(r-n)/20,s+=10*t*(n+.025),a.forEach((t=>{t.z<s&&l(t),i=t.z-s,t.sprite.x=t.x*(20/i)*e.width+c,t.sprite.y=t.y*(20/i)*e.width+d;const r=t.sprite.x-c,o=t.sprite.y-d,a=Math.sqrt(r*r+o*o),h=Math.max(0,(2e3-i)/2e3);t.sprite.scale.x=.05*h,t.sprite.scale.y=.05*h+h*n*5*a/e.width,t.sprite.rotation=Math.atan2(o,r)+Math.PI/2}));let u=o.now();u-h>5e3&&(h=u,r=r>0?0:1)}}}};return e.FX=p}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/FX"]=function(t){return t.FX?t.FX:i(t,[],[])}}(this),function(t,e){"use strict";function i(e){const i=[e.UP,e.LEFT,e.RIGHT,e.DOWN],s=t["io/czlab/mcfud/vec2"](),n=t["io/czlab/mcfud/math"](),{ute:r,is:o}=e,a=Math.abs,l=Math.ceil,h=Math.floor;function c(t,i,s){return e.getIndex(t,i,s.tiled.tileW,s.tiled.tileH,s.tiled.tilesInX)}function d(t,i){return s.vecAB(e.Sprites.centerXY(t),e.Sprites.centerXY(i))}function u(t){const e=t.image,i=e&&e.split("/");t.image=i&&i.length&&i[i.length-1]}function p(t,e){let i=-1;if(t>0)for(i=0;e[i+1]&&t>=e[i+1][0];)++i;return i>=0?e[i]:[]}function m(t,e,i){let s=[];return t.forEach((t=>{s.push([t.firstgid,t]),t.spacing||(t.spacing=0),u(t);let n={};(t.tiles||[]).forEach((e=>{let s=r.selectNotKeys(e,"properties");s=r.inject(s,g(e)),s.gid=t.firstgid+e.id,n[e.id]=s,i[s.gid]=s})),e[t.name]=n})),s.sort(((t,e)=>t[0]>e[0]?1:t[0]<e[0]?-1:0))}function g(t){return(t.properties||[]).reduce(((t,e)=>(t[e.name]=e.value,t)),{})}function f(t,i,s,a){let l=o.str(i)?function(t){let i=e.resource(t,!0).data,s=i&&(i.tiledversion||i.version);return s&&r.cmpVerStrs(s,"1.4.2")>=0?i:r.assert(!1,`${t} needs update`)}(i):i,h={},c={};r.assert(o.obj(l),"bad tiled map"),l=JSON.parse(JSON.stringify(l)),r.inject(t.tiled,{tileW:l.tilewidth,tileH:l.tileheight,tilesInX:l.width,tilesInY:l.height,tiledMap:l,saved_tileW:l.tilewidth,saved_tileH:l.tileheight,tiledWidth:l.tilewidth*l.width,tiledHeight:l.tileheight*l.height},g(l));let d=a||t.getScaleFactor(),f=r.evenN(d*l.tileheight),y=r.evenN(d*l.tilewidth);t.tiled.new_tileW=y,t.tiled.new_tileH=f,a&&(t.tiled.scale=a);const v={imagelayer(t){u(t)},tilelayer(e){o.vec(e.data[0])&&(e.width=e.data[0].length,e.height=e.data.length,e.data=e.data.flat()),e.width||(e.width=t.tiled.tilesInX),e.height||(e.height=t.tiled.tilesInY);let i,r=g(e);if(!1!==e.visible)for(let i,o=0;o<e.data.length;++o){if(0==(i=e.data[o]))continue;!1===e.collision||!1===r.collision||!0!==e.collision&&!0!==r.collision||(i>0&&(t.tiled.collision[o]=i),e.collision=!0);let a=o%e.width,l=n.ndiv(o,e.width),h=c[i],d=h&&h.Class,u=d&&s[d],m=p(i,t.tiled.tileGidList)[1],g=x(t,i,a,l,r.width,r.height);g&&(g.tiled.layer=e,g.tiled.index=o,g.m5.static=!0),u&&(g=u.c(t,g,m,h)),g&&(h&&h.sensor&&(g.m5.sensor=!0),t.insert(g,!!u))}else(i=r.Class)&&s[i](t,e)},objectgroup(e){e.sprites=[],e.objects.forEach((i=>{r.assert(o.num(i.x),"wanted xy position");let a,l,h=g(i),d=r.nor(i.gid,-1);r.inject(i,h),d>0&&(l=c[d]);let u=r.nor(l&&l.Class,i.Class),m=u&&s[u],v=t.tiled.saved_tileW,w=t.tiled.saved_tileH,b=n.ndiv(i.x+v/2,v),T=n.ndiv(i.y-w/2,w),I=p(d,t.tiled.tileGidList)[1];i.column=b,i.row=T,a=d<=0?{width:y,height:f}:x(t,d,b,T,i.width,i.height,u),m&&(a=m.c(t,a,I,l,i)),a&&(!1===i.visible&&(a.visible=!1),i.uuid=a.m5.uuid,e.sprites.push(a),t.insert(a,!0),l&&l.sensor&&(a.m5.sensor=!0))}))}};s=r.nor(s,{}),r.inject(t.tiled,{objFactory:s,tileSets:h,tileProps:c,collision:r.fill(l.width*l.height,0),imagelayer:[],objectgroup:[],tilelayer:[],tileGidList:m(l.tilesets,h,c)}),["imagelayer","tilelayer","objectgroup"].forEach((e=>{l.layers.filter((t=>t.type==e)).forEach((i=>{v[e](i),t.tiled[e].push(i)}))})),t.tiled.tileW=y,t.tiled.tileH=f,t.tiled.tiledWidth=y*l.width,t.tiled.tiledHeight=f*l.height,t.parent instanceof e.Scenes.SceneWrapper&&(t.tiled.tiledHeight<e.height&&(t.parent.y=n.ndiv(e.height-t.tiled.tiledHeight,2)),t.tiled.tiledWidth<e.width&&(t.parent.x=n.ndiv(e.width-t.tiled.tiledWidth,2)))}function x(t,i,s,a,l,h,c){let d,u=p(i,t.tiled.tileGidList)[1],m=(r.assert(u,"Bad GID, no tileset"),u.columns),g=i-u.firstgid,f=t.tiled.tileProps[i],x=t.tiled.scale||t.getScaleFactor();d=(c=r.nor(c,f&&f.Class))&&t.tiled.objFactory[c],r.assertNot(g<0,`Bad tile id: ${g}`),o.num(m)||(m=n.ndiv(u.imagewidth,u.tilewidth+u.spacing));let y=g%m,v=n.ndiv(g,m),w=y*u.tilewidth,b=v*u.tileheight;u.spacing>0&&(w+=u.spacing*y,b+=u.spacing*v);let T=d&&d.s(t)||e.Sprites.frame(u.image,l||u.tilewidth,h||u.tileheight,w,b);return T&&(T.tiled={id:g,gid:i},l==t.tiled.saved_tileW?T.width=t.tiled.new_tileW:(T.scale.x=x,T.width=r.evenN(T.width)),h==t.tiled.saved_tileH?T.height=t.tiled.new_tileH:(T.scale.y=x,T.height=r.evenN(T.height)),T.x=s*t.tiled.new_tileW,T.y=a*t.tiled.new_tileH),T}const y=e.Sprites.extend({width:0,height:0,parent:null,x:0,y:0,rotation:0,tiled:{},anchor:{x:0,y:0},getGlobalPosition(){return{x:this.x+this.parent.x,y:this.y+this.parent.y}}});class v extends e.Scenes.Scene{constructor(t,e,i){super(t,e,i),this.tiled={}}reloadMap(t){this.tiled={},this.m5.options.tiled=t,f(this,t.name,t.factory,t.scale)}runOnce(){const t=this.m5.options.tiled;f(this,t.name,t.factory,t.scale),super.runOnce()}removeTile(t,i){let{x:s,y:r}=i;i.anchor.x<.3&&(r=i.y+n.ndiv(i.height,2),s=i.x+n.ndiv(i.width,2));let o=n.ndiv(s,this.tiled.tileW),a=n.ndiv(r,this.tiled.tileH),l=this.getTileLayer(t),h=o+a*this.tiled.tilesInX;l.data[h]=0,l.collision&&(this.tiled.collision[h]=0),e.Sprites.remove(i)}getTileLayer(t,e){let i=r.some(this.tiled.tilelayer,(e=>{if(e.name==t)return e}));if(!i&&e)throw`There is no layer with name: ${t}`;return i}getObjectGroup(t,e){let i=r.some(this.tiled.objectgroup,(e=>{if(e.name==t)return e}));if(!i&&e)throw`There is no group with name: ${t}`;return i}setTile(t,e,i,s){let n=this.getTSInfo(s),r=(n.firstgid,this.getTileLayer(t)),o=i+this.tiled.tilesInX*e;r.collision&&(this.tiled.collision[o]=s);let a=x(this,s,i,e,n.tilewidth,n.tileheight);return a&&(a.tiled.index=o,a.tiled.layer=r),a}getTile(t){let{x:e,y:i}=t;return t.anchor.x<.3&&(i+=n.ndiv(t.height,2),e+=n.ndiv(t.width,2)),this.getTileXY(e,i)}getTileXY(t,e){let i=n.ndiv(t,this.tiled.tileW),s=n.ndiv(e,this.tiled.tileH);return r.assert(i>=0&&i<this.tiled.tilesInX,`bad tile col:${i}`),r.assert(s>=0&&s<this.tiled.tilesInY,`bad tile row:${s}`),[i,s]}getNamedItem(t){let e=[];return this.tiled.objectgroup.forEach((i=>{i.objects.forEach((i=>{t==r.get(i,"name")&&e.push(i)}))})),e}getScaleFactor(){let t,i,s=1;return"max"==e.u.scaleToWindow&&(e.width>e.height?(i=e.height/(this.tiled.saved_tileH*this.tiled.tilesInY),s=i):(t=e.width/(this.tiled.saved_tileW*this.tiled.tilesInX),s=t)),s}getTileIndex(t){let[i,s]=e.Sprites.centerXY(t);return c(i,s,this)}getTSInfo(t){return p(t,this.tiled.tileGidList)[1]}getTileProps(t){return this.tiled.tileProps[t]}_getContactObj(t,e,i){let s=y;return s.height=this.tiled.tileH,s.width=this.tiled.tileW,s.x=e*s.width,s.y=i*s.height,s.tiled.gid=t,s.tiled.row=i,s.tiled.col=e,s.m5.sensor=!1,s}collideXY(t){let i=e.Sprites,s=this.tiled.tileW,a=this.tiled.tileH,h=this.tiled.collision,c=r.feq0(t.angle)?i.getAABB(t):i.boundingBox(t),d=Math.max(0,n.ndiv(c.x1,s)),u=Math.max(0,n.ndiv(c.y1,a)),p=Math.min(this.tiled.tilesInX-1,l(c.x2/s)),m=Math.min(this.tiled.tilesInY-1,l(c.y2/a));for(let s,n,a,l,c=u;c<=m;++c)for(let u=d;u<=p;++u)a=c*this.tiled.tilesInX+u,n=h[a],o.num(n)||r.assert(o.num(n),"bad gid"),0!==n&&(l=this._getContactObj(n,u,c),s=this.getTileProps(n),s&&(l.m5.sensor=!!s.sensor),l.parent=this,i.hit(t,l)&&l.m5.sensor&&e.emit(["2d.sensor",t],l));return super.collideXY(t)}}class w{constructor(t,e){this.straightCost=t,this.diagonalCost=e}manhattan(t,e){return a(t.row-e.row)*this.straightCost+a(t.col-e.col)*this.straightCost}euclidean(t,e){let i=e.col-t.col,s=e.row-t.row;return h(r.sqrt(i*i+s*s)*this.straightCost)}diagonal(t,e){let i=a(e.col-t.col),s=a(e.row-t.row);return h(i>s?this.diagonalCost*s+this.straightCost*(i-s):this.diagonalCost*i+this.straightCost*(s-i))}}const b={TiledScene:v,neighborCells(t,e,i){let s=e.tiled.tilesInX,n=[t-s-1,t-s,t-s+1,t-1],r=[t+1,t+s-1,t+s,t+s+1];return i||n.push(t),n.concat(r)},updateMap(t,e,i){let s=r.fill(t.length,0),n=t=>{let e=this.getTileIndex(t,i);r.assert(e>=0&&e<s.length,"tiled index outofbound"),t.tiled.index=e,s[e]=t.tiled.gid};return o.vec(e)?e.forEach(n):n(e),s},shortestPath(t,e,i,s,r=[],o="manhattan",a=!0){let l=s.tiled.tilesInX,h=i.map(((t,e)=>({f:0,g:0,h:0,parent:null,index:e,col:e%l,row:n.ndiv(e,l)}))),c=h[e],d=h[t],u=d,p=[u],m=[],g=[],f=t=>(a?this.neighborCells(t,s,!0):this.crossCells(t,s)).map((t=>h[t])).filter((e=>{if(e){let s=t%l==0,n=(t+1)%l==0,o=e.col%(l-1)==0&&0!=e.col,a=e.col%l==0,h=r.some((t=>i[e.index]==t));return s?!o:n?!a:!h}}));for(;u!==c;){let t=f(u.index);for(let e,i,s,n,r,a=0;a<t.length;++a){r=t[a],n=14,u.row!=r.row&&u.col!=r.col||(n=10),i=u.g+n,e=i+new w(10,14)[o](r,c);let l=p.some((t=>r===t)),h=m.some((t=>r===t));l||h?r.f>e&&(r.f=e,r.g=i,r.h=s,r.parent=u):(r.f=e,r.g=i,r.h=s,r.parent=u,p.push(r))}if(m.push(u),0==p.length)return g;p=p.sort(((t,e)=>t.f-e.f)),u=p.shift()}if(0!=p.length){let t=c;for(g.push(t);t!==d;)t=t.parent,g.unshift(t)}return g},lineOfSight(t,i,r,o,a=0,l=32,u=[]){let p,m,g,f,x,y=d(t,i),v=s.len(y),w=n.ndiv(v,l),b=[];for(let i,s=1;s<=w;++s)i=e.Sprites.centerXY(t),p=l*s,f=y[0]/v,x=y[1]/v,m=h(i[0]+f*p),g=h(i[1]+x*p),b.push({x:m,y:g,index:c(m,g,o)});let T=180*Math.atan2(y[1],y[0])/Math.PI;return b.every((t=>r[t.index]==a))&&(0==u.length||u.some((t=>t==T)))},crossCells(t,e){const i=e.tiled.tilesInX;return[t-i,t-1,t+1,t+i]},getCrossTiles(t,e,i){return this.crossCells(t,i).map((t=>e[t]))},getDiagonalCells(t,e){const i=o.num(e)?e:e.tiled.tilesInX;return[t-i-1,t-i+1,t+i-1,t+i+1]},getDiagonalTiles(t,e,i){return this.getDiagonalCells(t,i).map((t=>e[t]))},validDirections(t,s,n,r){const o=this.getTileIndex(t,r);return this.getCrossTiles(o,s,r).map(((t,s)=>t==n?i[s]:e.NONE)).filter((t=>t!==e.NONE))},canChangeDirection(t=[]){let i=t.find((t=>t===e.UP)),s=t.find((t=>t===e.DOWN)),n=t.find((t=>t===e.LEFT)),r=t.find((t=>t===e.RIGHT));return 0==t.length||1==t.length||(i||s)&&(n||r)},randomDirection:(t=[])=>0==t.length?e.NONE:1==t.length?t[0]:t[r.randInt2(0,t.length-1)],closestDirection(t,i){const s=d(t,i);return a(s[0])<a(s[1])?s[1]<=0?e.UP:e.DOWN:s[0]<=0?e.LEFT:e.RIGHT}};return e.Tiles=b}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Tiles"]=function(t){return t.Tiles?t.Tiles:i(t)}}(this);