!function(e){"use strict";const t=["ttf","otf","ttc","woff"],i=["mp3","wav","ogg"],r=["jpg","png","jpeg","gif"];function n(n,s,o){const{EventBus:a,dom:h,is:l,u:c}=e["io/czlab/mcfud/core"](),d=Math.floor,u=console;function p(){return e.innerWidth}function m(){return e.innerHeight}function g(e,t,i,r){const{Sprites:n}=e;if(r)r.perc.m5.content(`${Math.round(i)}%`),r.fg.width=r.width*(i/100),u.log(`file= ${t}, progr= ${i}`);else{const t=d(e.height/2),i=d(e.width/2),s=d(e.width/4),o=24,a=t-o/2,h=4210752,l=16747008;r={dispose(){n.remove(this.fg,this.bg,this.perc)},width:2*s,fg:n.rectangle(i,o,l),bg:n.rectangle(i,o,h),perc:n.text("0%",{fontSize:d(o/2),fill:"black",fontFamily:"sans-serif"})},n.add(e.stage,r.bg,r.fg,r.perc),n.setXY(r.bg,i-s,a),n.setXY(r.fg,i-s,a),n.setXY(r.perc,i-s+10,d(t-r.perc.height/2))}return r}function f(e){const[t,i]=[e.offsetHeight,e.offsetWidth],[r,n]=[m(),p()],s=Math.min(n/i,r/t),[o,a]=[t*s,i*s];if(h.css(e,{transformOrigin:"0 0",transform:`scale(${s})`}),i>t?a<n:!(o>r)){const t=d((n-a)/2);h.css(e,{marginTop:"0px",marginBottom:"0px",marginLeft:`${t}px`,marginRight:`${t}px`})}else{const t=d((r-o)/2);h.css(e,{marginLeft:"0px",marginRight:"0px",marginTop:`${t}px`,marginBottom:`${t}px`})}return h.css(e,{display:"block",paddingLeft:"0px",paddingRight:"0px",paddingTop:"0px",paddingBottom:"0px"}),h.css(document.body,"backgroundColor",T.scaledBgColor),s}function y(e,t,r){const{Sound:n}=e;function s(){o.forEach((e=>h.css(e,"display","none"))),e.delBgTask(t),r&&r.dispose&&r.dispose(),e.u.start(e)}let a,l=0;function d(){0==--l&&s()}c.doseq(e.assets,((e,t)=>{a=c.fileExt(t),c.has(i,a)&&(l+=1,n.decodeContent(e.name,e.url,e.xhr.response,d))})),0===l&&s()}c.patch(n,{fps:60});const x={width:0,height:0},w={width:1,height:1};function v(t){u.log(`installing module ${t}...`),e[`io/czlab/mojoh5/${t}`](T)}const T={EVERY:1,SOME:2,CENTER:3,TOP:4,LEFT:5,RIGHT:6,BOTTOM:7,UP:8,DOWN:9,TOP_LEFT:10,TOP_RIGHT:11,BOTTOM_LEFT:12,BOTTOM_RIGHT:13,NONE:100,u:c,is:l,dom:h,u:n,Game:{},CON:console,noop:()=>{},EventBus:a(),PXContainer:PIXI.Container,PXGraphics:PIXI.Graphics,PXTexture:PIXI.Texture,PXFilters:PIXI.filters,PXLR:PIXI.LoaderResource,PXLoader:PIXI.Loader.shared,PXObservablePoint:PIXI.ObservablePoint,sideRight:e=>e===T.RIGHT||e===T.TOP_RIGHT||e===T.BOTTOM_RIGHT,sideLeft:e=>e===T.LEFT||e===T.TOP_LEFT||e===T.BOTTOM_LEFT,sideTop:e=>e===T.TOP||e===T.TOP_LEFT||e===T.TOP_RIGHT,sideBottom:e=>e===T.BOTTOM||e===T.BOTTOM_LEFT||e===T.BOTTOM_RIGHT,hasClass:(e,t)=>new RegExp(`(\\s|^)${t}(\\s|$)`).test(e.className),addClass:(e,t)=>(c.hasClass(e,t)||(e.className+=`${t}`),e),removeClass:(e,t)=>(c.hasClass(e,t)&&(e.className=e.className.replace(new RegExp(`(\\s|^)${t}(\\s|$)`),"")),e),wrapv:(e,t,i)=>e<t?i:e>i?t:e,get assets(){return PIXI.Loader.shared.resources},get designSize(){return this.u.arena},get width(){return this.canvas.width},get height(){return this.canvas.height},stageCS(e){T.stage.children.forEach(e)},portrait:()=>T.height>T.width,screenCenter:()=>c.v2(d(T.width/2),d(T.height/2)),scaleXY:(e,t)=>[t[0]/e[0],t[1]/e[1]],makeAnchor(e,t){return new T.PXObservablePoint(T.noop,this,e,t)},mockStage:(e=0,t=0)=>({getGlobalPosition:()=>({x:e,y:t}),anchor:T.makeAnchor(0,0),m5:{stage:!0},x:e,y:t,width:T.width,height:T.height}),getIndex(e,t,i,r,n){if(e<0||t<0)throw`Error: ${e},${t}, values must be positive`;return d(e/i)+d(t/r)*n},textureFromImage:e=>T.PXTexture.fromImage(e),animFromVec(e){if(l.vec(e)){if(l.str(e[0]))return this.tcached(e[0])?this.PXASprite.fromFrames(e):this.PXASprite.fromImages(e.map((e=>this.assetPath(e))));if(c.inst(T.PXTexture,e[0]))return new this.PXASprite(e)}},tcached(e){if(c.inst(this.PXTexture,e))return e;if(l.str(e)){let t=this.PXLoader.resources[e]||this.PXLoader.resources[this.assetPath(e)];return t&&t.texture}},splitXY:(e,t)=>[e%t,d(e/t)],rect:(e,t,i,r)=>new T.PXRectangle(e,t,i,r),scaleSZ:(e,t)=>({width:d(t.width/e.width),height:d(t.height/e.height)}),id:e=>T.image(e),image(e){return this.tcached(e)||c.assert(!1,`${e} not loaded.`)},xml:e=>(T.assets[e]||c.assert(!1,`${e} not loaded.`)).data,json:e=>(T.assets[e]||c.assert(!1,`${e} not loaded.`)).data,assetPath(e){if(e.includes("/"))return e;let n="data",s=c.fileExt(e);return s&&(s=s.substring(1)),c.has(r,s)?n="images":c.has(t,s)?n="fonts":c.has(i,s)&&(n="audio"),`${n}/${e}`},contentScaleFactor:()=>(x.height=T.height,x.width=T.width,"max"!==n.scaleToWindow?w:T.scaleSZ(T.designSize,x)),resource(e,t){return(e?this.assets[e]||this.assets[T.assetPath(e)]:null)||(t?c.assert(!1,`Error: no such resource ${e}.`):void 0)}};return function(r){c.assert(n.arena,"design resolution req'd.");const{EventBus:a}=r,d=new r.PXContainer;let x=!1,w=n.arena;return r.stage=d,d.m5={stage:!0},"max"==n.scaleToWindow&&(x=!0,w={width:p(),height:m()}),r.ctx=PIXI.autoDetectRenderer(w),r.ctx.bgColor=16777215,r.canvas=r.ctx.view,r.canvas.id="mojo",r.maxed=x,c.seq("Sprites,Input,Touch,Scenes,Sound").forEach(v),c.seq("FX,2d,Tiles,GameLoop").forEach(v),void 0!==n.border&&h.css(r.canvas,"border",n.border),void 0!==n.bgColor&&(r.ctx.bgColor=r.Sprites.color(n.bgColor)),h.conj(document.body,r.canvas),r.scaledBgColor=n.scaledBgColor||"#323232",r.touchDevice=!!("ontouchstart"in document),a.sub(["canvas.resize"],(e=>d.children.forEach((t=>t.onCanvasResize(e))))),function(){const e=h.newElm("style");h.conj(e,h.newTxt("* {padding: 0; margin: 0}")),h.conj(document.head,e)}(),r.scale=!0===n.scaleToWindow?f(r.canvas):1,r.pointer=r.Input.pointer(r.canvas,r.scale),r.frame=1/n.fps,c.addEvent("resize",e,c.debounce((()=>{const[e,t]=[r.width,r.height];r.ctx.resize(p(),m()),a.pub(["canvas.resize"],[e,t])}),n.debounceRate||150)),function(e){let r=c.map(e.u.assetFiles||[],(t=>e.assetPath(t))),n=c.findFiles(r,t);const{PXLR:a,PXLoader:d}=e;let p,m,f,x;if(n.forEach((e=>{x=h.newElm("style"),f=h.newElm("span"),p=e.split("/").pop().split(".")[0],m=`@font-face {font-family: '${p}'; src: url('${e}');}`,u.log(`fontface = ${m}`),s.push(p),h.conj(x,h.newTxt(m)),h.conj(document.head,x),f.innerHTML="?",h.css(f,"fontFamily",p),h.conj(document.body,f),h.css(f,{display:"block",opacity:"0"}),o.push(f)})),i.forEach((e=>{a.setExtensionLoadType(e,a.LOAD_TYPE.XHR),a.setExtensionXhrType(e,a.XHR_RESPONSE_TYPE.BUFFER)})),d.reset(),r.length>0){let t,i=[],n=[],s=e.u.load||g;d.add(r),d.onProgress.add(((e,t)=>{i.unshift(t.url),n.unshift(e.progress)})),d.load((()=>u.log("files loaded!"))),e.addBgTask({update(){let r=i.pop(),o=n.pop();r&&l.num(o)&&(t=s(e,r,o,t)),100===o&&y(e,this,t)}})}else y(e);e.start()}(r),r}(T)}if("object"==typeof module&&module.exports)throw"Fatal: browser only!";e.MojoH5=function(e){return n(e,[],[])}}(this),function(e){"use strict";let t;if("object"==typeof module&&module.exports)throw"Fatal: browser only.";e["io/czlab/mojoh5/GameLoop"]=function(i){return t||(t=!0,function(t,i){const{u:r,is:n}=e["io/czlab/mcfud/core"]();e["io/czlab/mcfud/math"]();let s=!1;function o(e){i.forEach((t=>t.update&&t.update(e))),s||t.stageCS((t=>t.update&&t.update(e))),t.ctx.render(t.stage)}Date.now(),r.conj(i,t.FX,t.Sprites,t.Input);const a=1/15;function h(t){e.requestAnimationFrame(t)}r.inject(t,{delBgTask(e){e&&r.disj(i,e)},addBgTask(e){r.conj(i,e)},resume(){s=!1},pause(){s=!0},start(){let e=t.frame,i=r.now(),n=0,s=function(){let t=r.now(),l=(t-i)/1e3;for(l>a&&(l=a),n+=l;n>=e;n-=e)o(l);i=t,h(s)};h(s)}})}(i,[])),i}}(this),function(e){"use strict";const t={aqua:"#00FFFF",black:"#000000",blue:"#0000FF",brown:"#A52A2A",crimson:"#DC143C",cyan:"#00FFFF",fuchsia:"#FF00FF",gray:"#808080",green:"#008000",grey:"#808080",lavender:"#E6E6FA",lime:"#00FF00",magenta:"#FF00FF",maroon:"#800000",navy:"#000080",olive:"#808000",orange:"#FFA500",purple:"#800080",red:"#FF0000",silver:"#C0C0C0",teal:"#008080",turquoise:"#40E0D0",wheat:"#F5DEB3",white:"#FFFFFF",yellow:"#FFFF00"};function i(i,r){const n=e["io/czlab/mcfud/geo2d"](),s=e["io/czlab/mcfud/vec2"](),{u:o,is:h,dom:l,EventBus:c}=i,d=(Math.abs,Math.floor);o.inject(i,{PXMatrix:PIXI.Matrix.TEMP_MATRIX,PXRTexture:PIXI.RenderTexture,PXRect:PIXI.Rectangle,PXBText:PIXI.BitmapText,PXSprite:PIXI.Sprite,PXGraphics:PIXI.Graphics,PXText:PIXI.Text,PXTSprite:PIXI.TilingSprite,PXASprite:PIXI.AnimatedSprite,PXPContainer:PIXI.ParticleContainer});const u=o.jsMap();function p(e,t){let r,n;if(o.inst(i.PXTexture,e)?n=e:h.vec(e)?r=i.animFromVec(e):h.str(e)&&(n=i.tcached(e)||i.textureFromImage(e)),n&&(r=t(n)),!r)throw`Error: ${e} not found`;return o.assertNot(o.has(r,"m5")||o.has(r,"g"),"found m5,g properties")&&r}function m(e,t,i,r,n,s){const o=[];let a=t,h=e;for(let t,l,c,d=0;d<i;++d){c=[];for(let e=0;e<r;++e)l=a+s,t=h+n,c.push({x1:h,x2:t,y1:a,y2:l}),h=t;a=l,h=e,o.push(c)}return o}function f(e,t){let r=t.m5.stage?{x1:0,y1:0,x2:i.width,y2:i.height}:e.getBBox(t);return[r,d((r.x2-r.x1)/2),d((r.y2-r.y1)/2),d((r.x1+r.x2)/2),d((r.y1+r.y2)/2)]}const y={assertCenter:e=>o.assert(e.anchor.x>.3&&e.anchor.x<.7&&e.anchor.y>.3&&e.anchor.y<.7,"not center'ed"),empty:e=>0===e.children.length,setXY:(e,t,i)=>(e.x=t,e.y=o.or(i,t),e),setSize:(e,t,i)=>(e.width=t,e.height=o.or(i,t),e),setScale:(e,t,i)=>(e.scale.set(t,o.or(i,t)),e),setAnchor:(e,t,i)=>(e.anchor.set(t,o.or(i,t)),e),halfSize:e=>({width:d(e.width/2),height:d(e.height/2)}),centerAnchor:e=>(e.anchor.set(.5,.5),e),topLeftAnchor:e=>(e.anchor.set(0,0),e),topLeftOffsetXY:e=>s.vec(-d(e.width*e.anchor.x),-d(e.height*e.anchor.y)),centerOffsetXY:e=>s.vec(d(e.width/2)-d(e.anchor.x*e.width),d(e.height/2)-d(e.anchor.y*e.height)),extend(e){e.m5||(e.m5={}),e.g||(e.g={});let t=this;return o.inject(e.m5,{uuid:o.nextId(),static:!1,mass:1,invMass:1,gravity:s.vec(),friction:s.vec(),vel:s.vec(),acc:s.vec(),angVel:0,stage:!1,dead:!1,circular:!1,drag:!1,get csize(){return[e.width,e.height]},resize(i,r,n,s){t.resize(e,i,r,n,s)},addMixin(t,i){o.assert(!o.has(e,t),`Error: ${t} not available.`),(e[t]=o.inject({},i)).added(e)},getContactPoints:()=>function(e,t,i){let r,n=s.vec,a=d(t/2),h=d(i/2);switch(e){case"0,0":r=[n(0,i),n(t,i),n(t,0),n()];break;case"0.5,0":r=[n(-a,i),n(a,i),n(a,0),n(-a,0)];break;case"1,0":r=[n(-t,i),n(0,i),n(),n(-t,0)];break;case"0,0.5":r=[n(0,h),n(t,h),n(t,-h),n(0,-h)];break;case"0.5,0.5":r=[n(-a,h),n(a,h),n(a,-h),n(-a,-h)];break;case"1,0.5":r=[n(-t,h),n(0,h),n(0,-h),n(-t,-h)];break;case"0,1":r=[n(),n(t,0),n(t,-i),n(0,-i)];break;case"0.5,1":r=[n(-a,0),n(a,0),n(a,-i),n(-a,-i)];break;case"1,1":r=[n(-t,0),n(),n(0,-i),n(-t,-i)];break;default:o.assert(!1,"Error: bad anchor values: "+e)}return r}(function(e){return`${e.x},${e.y}`}(e.anchor),e.width,e.height)}),e},defMixin(e,t){if(o.has(u,e))throw`Error: mixin: "${e}" already defined.`;o.assert(h.fun(t),"mixin must be a function"),o.assoc(u,e,t)},addMixin:(e,...t)=>(t.forEach((t=>function(e,t,i){o.assert(!o.has(e,t),`Error: ${t} not available.`);const r=i(e);return e[t]=r,r.name=t,r.mixinName="."+t,e}(e,t,u.get(t)))),e),toPolygon(e){let t=e.m5.getContactPoints();return new n.Polygon(e.x,e.y).setOrient(e.rotation).set(t)},toCircle(e){this.assertCenter(e);let t=d(e.width/2);return new n.Circle(t).setPos(e.x,e.y).setOrient(e.rotation)},gposXY(e){const t=e.getGlobalPosition();return s.vec(t.x,t.y)},isTopLeft:e=>e.anchor.x<.3&&e.anchor.y<.3,isCenter:e=>e.anchor.x>.3&&e.anchor.x<.7&&e.anchor.y>.3&&e.anchor.y<.7,centerXY(e){let t,i=e.x,r=e.y;if(this.isCenter())t=s.vec(i,r);else{let n=this.centerOffsetXY(e);t=s.vec(i+n[0],r+n[1]),s.reclaim(n)}return t},setScaleModeNearest:(e,t)=>(e.texture.baseTexture.scaleMode=t?PIXI.SCALE_MODES.NEAREST:PIXI.SCALE_MODES.LINEAR,e),angle(e,t){let i=this.centerXY(t),r=this.centerXY(e),n=Math.atan2(i[1]-r[1],i[0]-r[0]);return s.reclaim(i,r),n},move:(e,t)=>(t=o.or(t,1),e.x+=e.m5.vel[0]*t,e.y+=e.m5.vel[1]*t,e),leftSide(e){const t=e.x,i=e.width,r=e.anchor.x;return r>.7?t-=i:r>0&&(t-=d(i/2)),t},rightSide(e){return this.leftSide(e)+e.width},topSide(e){let t=e.y,i=e.height,r=e.anchor.y;return r>.7?t-=i:r>0&&(t-=d(i/2)),t},bottomSide(e){return this.topSide(e)+e.height},getBBox(e){let t={x1:this.leftSide(e),x2:this.rightSide(e),y1:this.topSide(e),y2:this.bottomSide(e)};return o.assert(t.y1<=t.y2),t},bbox4:(e,t,i,r)=>(o.assert(i<=r),{x1:e,x2:t,y1:i,y2:r}),bboxCenter(e){if(h.num(e.x1))return s.vec(d((e.x1+e.x2)/2),d((e.y1+e.y2)/2))},bboxSize:e=>s.vec(e.x2-e.x1,e.y2-e.y1),pointInBBox:(e,t,i)=>e>i.x1&&e<i.x2&&t>i.y1&&t<i.y2,boundingBox(e){let t,i,r,n,o,a,h=[],l=[],c=d(e.width/2),u=d(e.height/2),p=Math.tanh(u/c),m=Math.sqrt(c*c+u*u);return i=2*Math.PI-p+e.rotation,l.push(m*Math.sin(i)),h.push(m*Math.cos(i)),i=p+e.rotation,l.push(m*Math.sin(i)),h.push(m*Math.cos(i)),i=Math.PI-p+e.rotation,l.push(m*Math.sin(i)),h.push(m*Math.cos(i)),i=Math.PI+p+e.rotation,l.push(m*Math.sin(i)),h.push(m*Math.cos(i)),t=this.centerXY(e),l.sort(((e,t)=>e-t)),h.sort(((e,t)=>e-t)),r=d(h[0]+t[0]),n=d(h[3]+t[0]),o=d(l[0]+t[1]),a=d(l[3]+t[1]),s.reclaim(t),{x1:r,x2:n,y1:o,y2:a}},hitTestPoint(e,t){return t.m5.circular?n.hitTestPointCircle(e,this.toCircle(t)):n.hitTestPointPolygon(e,this.toPolygon(t))},lineOfSight(e,t,i,r=32){let n=this.centerXY(e),o=this.centerXY(t),a=s.vecAB(n,o),h=s.len(a),l=s.div(a,h),c=s.vec(),d=!1;for(let e,t=h/r,s=1;s<=t&&!d;++s)e=r*s,c[0]=n[0]+l[0]*e,c[1]=n[1]+l[1]*e,d=i.some((e=>this.hitTestPoint(c,e)));return s.reclaim(l,a,c,n,o),!d},distance(e,t){let i=this.centerXY(t),r=this.centerXY(e),n=s.dist(r,i);return s.reclaim(r,i),n},update(e){o.rseq(r,(t=>t.m5.updateShake&&t.m5.updateShake(e)))},mkTexture(e){return this.tcached(e)},scaleContent(...e){1===e.length&&h.vec(e[0])&&(e=e[0]);let t=i.contentScaleFactor();e.forEach((e=>{e.scale.x=t.width,e.scale.y=t.height}))},uuid:(e,t)=>(e.m5.uuid=t,e),pset:(e,t,i)=>(e.g[t]=i,e),pget:(e,t)=>e.g[t],container(e){let t=new i.PXContainer;return o.assertNot(o.has(t,"m5")||o.has(t,"g"),"found m5+g properties"),t=this.extend(t),e&&e(t),t},sprite(e,t=0,r=0,n=!1){let s=p(e,(e=>new i.PXSprite(e)));return n&&s.anchor.set(.5,.5),s=this.setXY(this.extend(s),t,r),o.inst(i.PXASprite,s)?function(e){let t,i=[0,0,0,0];function r(){e.m5.animating&&(t=o.clear(t),o.setVec(i,0,0,0,0)),e.m5.animating=!1}function n(){i[2]<i[3]+1?(e.gotoAndStop(e.currentFrame+1),i[2]+=1):e.loop&&(e.gotoAndStop(start),i[2]=1)}return o.inject(e.m5,{showFrame(t){r(),e.gotoAndStop(t)},playFrames(s){r(),i[0]=0,i[1]=e.totalFrames-1,h.vec(s)&&s.length>1&&(i[0]=s[0],i[1]=s[1]),i[3]=i[1]-i[0],e.gotoAndStop(i[0]),i[2]=1,e.m5.animating||(e.m5.animating=!0,t=o.timer(n,1e3/12,!0))},stopFrames(){e.m5.showFrame(e.currentFrame)}}),e}(s):s},tilingSprite(e,t=0,r=0,n=!1){let s=p(e,(e=>new i.PXTSprite(e)));return n&&s.anchor.set(.5,.5),this.setXY(this.extend(s),t,r)},animation(e,t,r,n=0){let o=i.tcached(e);if(!o)throw`Error: ${e} not loaded.`;let a=d(o.width/t),h=a*d(o.height/r),l=[];for(let e,i,o=0;o<h;++o)e=o%a*t,i=d(o/a)*r,n>0&&(e+=n+n*o%a,i+=n+n*d(o/a)),l.push(s.vec(e,i));let c=(u=o,p=t,m=r,l.map((e=>new i.PXTexture(u.baseTexture,new i.PXRect(e[0],e[1],p,m)))));var u,p,m;return s.reclaim(...l),c},frame(e,t,r,n,s){const o=this.tcached(e);return new i.PXTexture(o.baseTexture,new i.PXRect(n,s,t,r))},frames(e,t,r,n=0,s=0,o=0,a=0){let h=i.tcached(e),l=t+n,c=r+s,u=[],p=d(h.height/c),m=d((h.width+n)/l);for(let e,n=0;n<p;++n){e=a+r*n;for(let n,s=0;s<m;++s)n=o+t*s,u.push(new i.PXTexture(h.baseTexture,new i.PXRect(n,e,t,r)))}return u},frameImages:(...e)=>(1===e.length&&h.vec(e[0])&&(e=e[0]),e.map((e=>i.tcached(e)))),spriteFrom(...e){return this.sprite(this.frameImages(e))},text(e,t,r=0,n=0){let s=new i.PXText(e,t);return this.setXY(this.extend(s),r,n)},bitmapText(e,t,r=0,n=0){let s=new i.PXBText(e,t);return this.setXY(this.extend(s),r,n)},rectangle(e,t,r=16724736,n=13260,s=0,o=0,a=0){let h=new i.PXGraphics,l={width:e,height:t,lineW:s,fill:this.color(r),stroke:this.color(n)},c=function(){return h.clear(),h.beginFill(l.fill),l.lineW>0&&h.lineStyle(l.lineW,l.stroke,1),h.drawRect(0,0,l.width,l.height),h.endFill(),h};c();let d=new i.PXSprite(this.genTexture(h));return d=this.setXY(this.extend(d),o,a),d.m5.fillStyle=function(e){return void 0!==e&&(l.fill=this.color(e),d.texture=c()&&this.genTexture(h)),l.fill},d.m5.strokeStyle=function(e){return void 0!==e&&(l.stroke=this.color(e),d.texture=c()&&this.genTexture(h)),l.stroke},d.m5.lineWidth=function(e){return void 0!==e&&(l.lineW=e,d.texture=c()&&this.genTexture(h)),l.lineW},d},drawBody(e,...t){let r=new i.PXGraphics;return e.apply(this,[r].concat(t)),this.extend(new i.PXSprite(this.genTexture(r)))},circle(e,t=16724736,r=13260,n=0,s=0,o=0){let a=new i.PXGraphics,h={radius:e,lineW:n,fill:this.color(t),stroke:this.color(r)},l=function(){return a.clear(),a.beginFill(h.fill),h.lineW>0&&a.lineStyle(grops.lineW,h.stroke,1),a.drawCircle(0,0,h.radius),a.endFill(),a};l();let c=new i.PXSprite(this.genTexture(a));return c=this.setXY(this.extend(c),s,o),c.anchor.set(.5),c.m5.circular=!0,c.m5.fillStyle=function(e){return void 0!==e&&(h.fill=this.color(e),c.texture=l()&&this.genTexture(a)),h.fill},c.m5.strokeStyle=function(e){return void 0!==e&&(h.stroke=this.color(e),c.texture=l()&&this.genTexture(a)),h.stroke},sprite},line(e,t,r,n){let a=new i.PXGraphics,h={A:s.clone(r),B:s.clone(n),lineW:t,stroke:this.color(e)};draw=function(){a.clear(),a.lineStyle(h.lineW,h.stroke,1),a.moveTo(h.A[0],h.A[1]),a.lineTo(h.B[0],h.B[1])},draw();let l=this.extend(a);return l.m5.ptA=function(e,t){return void 0!==e&&(h.A[0]=e,h.A[1]=o.or(t,e),draw()),h.A},l.m5.ptB=function(e,t){return void 0!==e&&(h.B[0]=e,h.B[1]=o.or(t,e),draw()),h.B},l.m5.lineWidth=function(e){return void 0!==e&&(h.lineW=e,draw()),h.lineW},l.m5.strokeStyle=function(e){return void 0!==e&&(h.stroke=this.color(e),draw()),h.stroke},l},moving:e=>!o.feq0(e.m5.vel[0])||!o.feq0(e.m5.vel[1]),makeCells(e,t,i,r,n,s){let o=d((i-e)/n);return m(e,t,d((r-e)/s),o,n,s)},gridSQ(e,t=.6){let r=t*(i.height<i.width?i.height:i.width),n=d(r/e),s=n,o=d((i.height-r)/2);return m(d((i.width-r)/2),o,e,e,n,s)},gridXY(e,t,r=.8){let n=d(i.height*r),s=d(i.width*r),o=d(s>n?n/t:s/e),a=d((i.height-o*t)/2);return m(d((i.width-o*e)/2),a,t,e,o,o)},drawGridBox(e,t,r){let n=new i.PXGraphics,s=e[0][0],o=e[0].length,a=e[e.length-1][o-1];return n.lineStyle(t,this.color(r)),n.drawRect(s.x1,s.y1,a.x2-s.x1,a.y2-s.y1),n},drawGridLines(e,t,r){let n=new i.PXGraphics,s=e.length,o=e[0].length;n.lineStyle(t,this.color(r));for(let t,i=1;i<s;++i)t=e[i],n.moveTo(t[0].x1,t[0].y1),n.lineTo(t[o-1].x2,t[o-1].y1);for(let t,i=1;i<o;++i)t=e[0],n.moveTo(t[i].x1,t[i].y1),t=e[s-1],n.lineTo(t[i].x1,t[i].y2);return n},grid(e,t,i,r,n,s,o,a,h){let l=e*t,c=d(i/2),u=d(r/2),p=this.container();for(let t,m,g,f=0;f<l;++f)m=f%e*i,g=d(f/e)*r,t=a(),p.addChild(t),t.x=m+s,t.y=g+o,n&&(t.x+=c-d(t.width/2),t.y+=u-d(t.height/2)),h&&h(t);return p},shoot(e,t,i,r,n,o,a,h){let l=this.topLeftOffsetXY(e),c=this.extend(o());return i.addChild(c),c.x=e.x+l[0]+a,c.y=e.y+l[1]+h,c.m5.vel[0]=Math.cos(t)*r,c.m5.vel[1]=Math.sin(t)*r,n.push(c),s.reclaim(l,g),e},shake(e,t=16,i=!1){let n=1,s=e.x,a=e.y,h=e.rotation,l=d(t/10);let c=1;o.has(r,e)||(r.push(e),e.updateShake=()=>i?(n<10&&(e.rotation=h,t-=l,e.rotation=t*c,++n,c*=-1),void(n>=10&&(e.rotation=h,o.disj(r,e)))):(n<10&&(e.x=s,e.y=a,t-=l,e.x+=o.randInt2(-t,t),e.y+=o.randInt2(-t,t),++n),void(n>=10&&(e.x=s,e.y=a,o.disj(r,e)))))},group(...e){return 1===e.length&&h.vec(e[0])&&(e=e[0]),this.container((t=>e.forEach((e=>t.addChild(e)))))},add:(e,...t)=>(t.forEach((t=>t&&e.addChild(t))),e),remove(...e){1===e.length&&h.vec(e[0])&&(e=e[0]),o.doseqEx(e,(e=>{e.parent&&e.parent.removeChild(e),e.m5.dispose&&e.m5.dispose(),c.pub(["post.remove",e])}))},colorToRgbA(e){if(!e||!h.str(e)||0===e.length)return;let i=e.toLowerCase(),r=t[i];return r&&(e=r),"#"===e[0]?(e.length<7&&(e=`#${e[1]}${e[1]}${e[2]}${e[2]}${e[3]}${e[3]}${e.length>4?e[4]+e[4]:""}`),[parseInt(e.substr(1,2),16),parseInt(e.substr(3,2),16),parseInt(e.substr(5,2),16),e.length>7?parseInt(e.substr(7,2),16)/255:1]):"transparent"==i?[0,0,0,0]:0===i.indexOf("rgb")?(i.indexOf("rgba")<0&&(i+=",1"),i.match(/[\.\d]+/g).map((e=>+e))):void 0},byteToHex:e=>("0"+e.toString(16)).slice(-2),colorToHex(e){const t=this.colorToRgbA(e);return"0x"+[0,1,2].map((e=>this.byteToHex(t[e]))).join("")},color(e){return isNaN(e)?parseInt(this.colorToHex(e)):e},resize(e,t,i,r,n){e&&o.doseqEx(e.children,(t=>t.m5&&t.m5.resize&&t.m5.resize(e.x,e.y,e.width,e.height)))},pinTop(e,t,i=10,r=.5){let[n,s,o,a,h]=f(this,e),[l,c,d,u,p]=f(this,t),m=n.y1-i-(l.y2-l.y1),g=r<.3?n.x1:r<.7?a-c:n.x2-(l.x2-l.x1);t.y=t.anchor.y<.3?m:t.anchor.y<.7?m+d:m+(l.y2-l.y1),t.x=t.anchor.x<.3?g:t.anchor.x<.7?g+c:g+(l.x2-l.x1)},pinBottom(e,t,i=10,r=.5){let[n,s,o,a,h]=f(this,e),[l,c,d,u,p]=f(this,t),m=n.y2+i,g=r<.3?n.x1:r<.7?a-c:n.x2-(l.x2-l.x1);t.y=t.anchor.y<.3?m:t.anchor.y<.7?m+d:m+(l.y2-l.y1),t.x=t.anchor.x<.3?g:t.anchor.x<.7?g+c:g+(l.x2-l.x1)},pinCenter(e,t){let[i,r,n,s,o]=f(this,e),[a,h,l,c,d]=f(this,t),u=s-h,p=o-l;t.y=t.anchor.y<.3?p:t.anchor.y<.7?p+l:p+(a.y2-a.y1),t.x=t.anchor.x<.3?u:t.anchor.x<.7?u+h:u+(a.x2-a.x1)},pinLeft(e,t,i=10,r=.5){let[n,s,o,h,l]=f(this,a),[c,d,u,p,m]=f(this,t),g=n.x1-i-(c.x2-c.x1),y=r<.3?n.y1:r<.7?l-u:n.y2-(c.y2-c.y1);t.y=t.anchor.y<.3?y:t.anchor.y<.7?y+u:y+(c.y2-c.y1),t.x=t.anchor.x<.3?g:t.anchor.x<.7?g+d:g+(c.x2-c.x1)},pinRight(e,t,i=10,r=.5){let[n,s,o,h,l]=f(this,a),[c,d,u,p,m]=f(this,t),g=n.x2+i,y=r<.3?n.y1:r<.7?l-u:n.y2-(c.y2-c.y1);t.y=t.anchor.y<.3?y:t.anchor.y<.7?y+u:y+(c.y2-c.y1),t.x=t.anchor.x<.3?g:t.anchor.x<.7?g+d:g+(c.x2-c.x1)},setMass(e,t){e.m5.mass=t,e.m5.invMass=o.feq0(t)?0:1/t},genTexture(e,t,r,n){0===(n=n||e.getLocalBounds(null,!0)).width&&(n.width=1),0===n.height&&(n.height=1);let s=i.PXRTexture.create({width:0|n.width,height:0|n.height,scaleMode:t,resolution:r});return i.PXMatrix.tx=-n.x,i.PXMatrix.ty=-n.y,i.ctx.render(e,s,!1,i.PXMatrix,!!e.parent),s}};return i.Sprites=y}if("object"==typeof module&&module.exports)throw"Fatal: browser only";e["io/czlab/mojoh5/Sprites"]=function(e){return e.Sprites?e.Sprites:i(e,[])}}(this),function(e){"use strict";if("object"==typeof module&&module.exports)throw"Fatal: browser only";e["io/czlab/mojoh5/Scenes"]=function(e){return e.Scenes?e.Scenes:function(e,t){const{u:i,is:r,EventBus:n}=e,s=Math.floor;function o(e){return e.startsWith("scene::")?e:`scene::${e}`}function a(e){e&&(e.dispose&&e.dispose(),e.parent.removeChild(e))}class h extends e.PXContainer{constructor(e,t,n){if(super(),this.name=o(e),this.____sid=e,r.fun(t))this.____setup=t;else if(r.obj(t)){let e=i.dissoc(t,"setup");e&&(t.____setup=e),i.inject(this,t)}this.m5={stage:!0},this.g={},this.____index={},this.____queue=[],this.____options=i.or(n,{})}onCanvasResize(t){e.Sprites.resize({x:0,y:0,width:t[0],height:t[1],children:this.children})}future(e,t,r=!0){r?this.____queue.push([e,t]):i.delay(t,e)}getChildById(e){return e&&this.____index[e]}remove(e){r.str(e)&&(e=this.getChildById(e)),e&&i.has(this.children,e)&&(this.removeChild(e),i.dissoc(this.____index,e.m5.uuid))}insert(e,t){return void 0!==t&&t>=0&&t<this.children.length?this.addChildAt(e,t):this.addChild(e),this.____index[e.m5.uuid]=e}dispose(){this.m5.dead=!0,function t(i){if(i.children.length>0&&i.children.forEach((e=>t(e))),i){const t=e.Input;i.m5.button&&t.undoButton(i),i.m5.drag&&t.undoDrag(i)}}(this),this.removeChildren()}_iterStep(e,t){e.forEach((e=>{e.m5&&e.m5.step&&(e.m5.step(t),n.pub(["post.step",e],t)),e.children.length>0&&this._iterStep(e.children,t)}))}_iterClean(e){e.forEach((e=>e.children.length>0&&this._iterClean(e.children)))}update(e){if(this.m5.dead)return;let t,r=this.____queue.filter((e=>(e[1]-=1,e[1]<=0)));for(;r.length>0;)i.disj(this.____queue,t),t=r.shift(),t[0]();n.pub(["pre.update",this],e),this._iterStep(this.children,e),n.pub(["post.update",this],e)}runOnce(){this.____setup&&(this.____setup(this.____options),delete this.____setup)}}const l={Scene:h,layoutX(t,r){const{Sprites:n}=e,o=e.contentScaleFactor();if(0===t.length)return;let a,h=(r=i.patch(r,{color:0,padding:10,fit:20,borderWidth:4,border:16777215})).borderWidth*o.width,l=r.group||n.group(),c=r.padding*o.width,d=r.fit*o.width*2;t.forEach(((e,t)=>{r.skipAdd||l.addChild(e),i.assert(e.anchor.x<.3&&e.anchor.y<.3,"wanted topleft anchor"),t>0&&n.pinRight(a,e,c),a=e}));let[u,p]=[l.width,l.height],m=i.tail(t);if("transparent"!=r.bg){let e=n.rectangle(u+d,p+d,r.bg,r.border,h);e.alpha=0===r.opacity?0:r.opacity||.5,l.addChildAt(e,0)}p=l.height,u=l.width;let[g,f]=[s(u/2),s(p/2)];t.forEach((e=>e.y=f-s(e.height/2)));let y=u-(m.x+m.width);return y=s(y/2),t.forEach((e=>e.x+=y)),l.x=i.or(r.x,s((e.width-u)/2)),l.y=i.or(r.y,s((e.height-p)/2)),l.m5.resize=function(t,n,o,a){let h=l.children.slice(),[c,d]=[l.x,l.y];l.removeChildren(),l.x=l.y=0,r.group=l,h.forEach((e=>{e.x=e.y=0,e.m5&&e.m5.resize&&e.m5.resize()}));let u=this.layoutX(h,r);i.assert(u===l),u.parent.m5&&u.parent.m5.stage?(u.x=c*s(e.width/o),u.y=d*s(e.height/a)):(u.x=c*s(u.parent.width/o),u.y=d*s(u.parent.height/a))},l},layoutY(t,r){const{Sprites:n}=e,o=e.contentScaleFactor();if(0===t.length)return;let a,h=(r=i.patch(r,{color:0,fit:20,padding:10,borderWidth:4,border:16777215})).borderWidth*o.width,l=r.group||n.group(),c=r.padding*o.width,d=r.fit*o.width*2;t.forEach(((e,t)=>{r.skipAdd||l.addChild(e),t>0&&n.pinBottom(a,e,c),a=e}));let[u,p]=[l.width,l.height],m=i.tail(t);if("transparent"!=r.bg){let e=n.rectangle(u+d,p+d,r.bg,r.border,h);e.alpha=0===r.opacity?0:r.opacity||.5,l.addChildAt(e,0)}u=l.width,p=l.height;let[g,f]=[s(u/2),s(p/2)];t.forEach((e=>e.x=g-s(e.width/2)));let y=p-(m.y+m.height);return y=s(y/2),t.forEach((e=>e.y+=y)),l.x=i.or(r.x,s((e.width-u)/2)),l.y=i.or(r.y,s((e.height-p)/2)),l.m5.resize=function(t,n,o,a){let h=l.children.slice(),[c,d]=[l.x,l.y];l.removeChildren(),l.x=l.y=0,r.group=l,h.forEach((e=>{e.x=e.y=0,e.m5&&e.m5.resize&&e.m5.resize()}));let u=this.layoutY(h,r);i.assert(u===l),u.parent.m5&&u.parent.m5.stage?(u.x=c*s(e.width/o),u.y=d*s(e.height/a)):(u.x=c*s(u.parent.width/o),u.y=d*s(u.parent.height/a))},l},defScene(e,i,r){t[e]=[i,r||{}]},replaceScene(t,i,r){const n=e.stage.getChildByName(o(t));if(!n)throw`Error: no such scene: ${t}`;return this.runScene(i,e.stage.getChildIndex(n),r)},removeScene(...t){1===t.length&&r.vec(t[0])&&(t=t[0]),t.forEach((t=>{r.str(t)?a(e.stage.getChildByName(o(t))):t&&a(t)}))},removeScenes(){for(;e.stage.children.length>0;)a(e.stage.children[e.stage.children.length-1])},findScene:t=>e.stage.getChildByName(o(t)),runScene(n,s,o){let l,c=t[n];if(!c)throw`Error: unknown scene: ${n}`;if(r.obj(s)&&(o=s,s=i.dissoc(o,"slot")),o=i.inject({},c[1],o),r.undef(s)&&(s=o.slot||-1),e.pointer.reset(),l=new h(n,c[0],o),s>=0&&s<e.stage.children.length){let t=e.stage.getChildAt(s);e.stage.addChildAt(l,s),a(t)}else e.stage.addChild(l);return l.runOnce(),l}};return e.Scenes=l}(e,{})}}(this),function(e){"use strict";if(!e.AudioContext)throw"Fatal: no audio.";const t=console;Math.floor;if("object"==typeof module&&module.exports)throw"Fatal: browser only";e["io/czlab/mojoh5/Sound"]=function(i){return i.Sound?i.Sound:function(i,r){const{u:n,is:s}=e["io/czlab/mcfud/core"]();function o(e,t,i){const s={soundNode:null,buffer:null,src:i,name:t,loop:!1,playing:!1,panValue:0,volumeValue:1,startTime:0,startOffset:0,playbackRate:1,echo:!1,delayValue:.3,feebackValue:.3,filterValue:0,reverb:!1,reverbImpulse:null,gainNode:e.ctx.createGain(),panNode:e.ctx.createStereoPanner(),delayNode:e.ctx.createDelay(),feedbackNode:e.ctx.createGain(),filterNode:e.ctx.createBiquadFilter(),convolverNode:e.ctx.createConvolver(),play(){this.startTime=e.ctx.currentTime,this.soundNode=e.ctx.createBufferSource(),this.soundNode.buffer=this.buffer,this.soundNode.playbackRate.value=this.playbackRate,this.soundNode.connect(this.gainNode),this.reverb?(this.gainNode.connect(this.convolverNode),this.convolverNode.connect(this.panNode),this.convolverNode.buffer=this.reverbImpulse):this.gainNode.connect(this.panNode),this.panNode.connect(e.ctx.destination),this.echo&&(this.feedbackNode.gain.value=this.feebackValue,this.delayNode.delayTime.value=this.delayValue,this.filterNode.frequency.value=this.filterValue,this.delayNode.connect(this.feedbackNode),this.filterValue>0?(this.feedbackNode.connect(this.filterNode),this.filterNode.connect(this.delayNode)):this.feedbackNode.connect(this.delayNode),this.gainNode.connect(this.delayNode),this.delayNode.connect(this.panNode)),this.soundNode.loop=this.loop,this.soundNode.start(0,this.startOffset%this.buffer.duration),this.playing=!0},_stop(){this.playing&&this.soundNode.stop(0)},pause(){this._stop(),this.playing&&(this.playing=!1,this.startOffset+=e.ctx.currentTime-this.startTime)},playFrom(e){this._stop(),this.startOffset=e,this.play()},restart(){this.playFrom(0)},setEcho(e,t,i){this.feebackValue=n.or(t,.3),this.delayValue=n.or(e,.3),this.filterValue=n.or(i,0),this.echo=!0},setReverb(t,i,r){let s=e.ctx.sampleRate,o=s*(t||2),a=e.ctx.createBuffer(2,o,s);this.reverb=!0,this.reverbImpulse=a;for(let e,t=i||2,s=a.getChannelData(0),h=a.getChannelData(1),l=r?o-1:0;;){if(r){if(l<0)break}else if(l>=o)break;e=Math.pow(1-l/o,t),s[l]=e*(2*n.rand()-1),h[l]=e*(2*n.rand()-1),r?--l:++l}},fade(t,i){this.playing&&(this.gainNode.gain.linearRampToValueAtTime(this.gainNode.gain.value,e.ctx.currentTime),this.gainNode.gain.linearRampToValueAtTime(t,e.ctx.currentTime+i))},fadeIn(e){this.gainNode.gain.value=0,this.fade(1,e)},fadeOut(e){this.fade(0,e)},get pan(){return this.panNode.pan.value},set pan(e){this.panNode.pan.value=e},get volume(){return this.volumeValue},set volume(e){this.gainNode.gain.value=e,this.volumeValue=e}};return r[t]=s}const a={ctx:new e.AudioContext,decodeContent(e,i,r,n,s){let a=o(this,e,i);return _A.ctx.decodeAudioData(r,(e=>{n(a.buffer=e),t.log(`decoded sound file:${i}`)}),(e=>{s&&s(i,e)})),a},decodeUrl(e,t,i,r){let n=new XMLHttpRequest,s=o(this,e,t);return n.open("GET",t,!0),n.responseType="arraybuffer",n.addEventListener("load",(()=>{this.decodeContent(t,n.response,i,r)})),n.send(),s}};return i.sound=function(e){return r[i.assetPath(e)]||n.assert(!1,`${e} not loaded.`)},i.Sound=a}(i,{})}}(this),function(e){"use strict";function t(t,i,r,n){const{u:s,is:o}=e["io/czlab/mcfud/core"](),a=s.jsMap(),{EventBus:h}=t;const l={keyLEFT:37,keyRIGHT:39,keyUP:38,keyDOWN:40,keyZERO:48,keyONE:49,keyTWO:50,keyTHREE:51,keyFOUR:52,keyFIVE:53,keySIX:54,keySEVEN:55,keyEIGHT:56,keyNINE:57,keyA:65,keyB:66,keyC:67,keyD:68,keyE:69,keyF:70,keyG:71,keyH:72,keyI:73,keyJ:74,keyK:75,keyL:76,keyM:77,keyN:78,keyO:79,keyP:80,keyQ:81,keyR:82,keyS:83,keyT:84,keyU:85,keyV:86,keyW:87,keyX:88,keyY:89,keyZ:90,keyENTER:13,keyESC:27,keyBACKSPACE:8,keyTAB:9,keySHIFT:16,keyCTRL:17,keyALT:18,keySPACE:32,keyHOME:36,keyEND:35,keyPGGUP:33,keyPGDOWN:34,ptr:null,resize(){this.ptr&&this.ptr.dispose(),t.pointer=this.pointer(t.canvas,t.scale)},reset(){a.clear()},keyboard(e){const t={isDown:!1,isUp:!0,code:e,_down(e){e.preventDefault(),e.keyCode===t.code&&(t.isUp&&t.press&&t.press(),t.isUp=!1,t.isDown=!0)},_up(e){e.preventDefault(),e.keyCode===t.code&&(t.isDown&&t.release&&t.release(),t.isUp=!0,t.isDown=!1)}};return s.addEvent([["keyup",window,t._up,!1],["keydown",window,t._down,!1]]),t},undoButton:e=>(e.m5.enabled=!1,e.m5.button=!1,s.disj(r,e),e),makeButton:e=>(e.m5.enabled=!0,e.m5.button=!0,s.conj(r,e),e),update(e){n.length>0&&function(e){if(e&&e.isDown)if(e.dragged)e.dragged.x=e.x-e.dragOffsetX,e.dragged.y=e.y-e.dragOffsetY;else for(let i,r=n.length-1;r>=0;--r)if(i=n[r],i.m5.drag&&e.hitTest(i)){let r=i.parent.children,o=t.Sprites.gposXY(i);e.dragOffsetX=e.x-o[0],e.dragOffsetY=e.y-o[1],e.dragged=i,s.disj(r,i),s.conj(r,i),s.disj(n,i),s.conj(n,i);break}e&&e.isUp&&(e.dragged=null)}(this.ptr)},makeDrag:e=>(s.conj(n,e),e.m5.drag=!0,e),undoDrag:e=>(s.disj(n,e),e.m5.drag=!1,e),keyUp(e){return!this.keyDown(e)},keyDown:e=>!0===a.get(e),pointer(){let e={state:[!1,!0,!1],_visible:!0,_x:0,_y:0,width:1,height:1,downTime:0,elapsedTime:0,dragged:null,dragOffsetX:0,dragOffsetY:0,anchor:t.makeAnchor(.5,.5),get cursor(){return t.canvas.style.cursor},set cursor(e){t.canvas.style.cursor=e},get x(){return this._x/t.scale},get y(){return this._y/t.scale},get visible(){return this._visible},set visible(e){this.cursor=e?"auto":"none",this._visible=e},getGlobalPosition(){return{x:this.x,y:this.y}},press(){for(let t,i=0,n=r.length;i<n;++i)if(t=r[i],t.m5.enabled&&t.m5.press&&e.hitTest(t)){t.m5.press(t);break}},tap(){e.press()},mouseDown(t){0===t.button&&(e._x=t.pageX-t.target.offsetLeft,e._y=t.pageY-t.target.offsetTop,e.downTime=s.now(),s.setVec(e.state,!0,!1,!0),t.preventDefault(),h.pub(["mousedown"]))},mouseMove(t){e._x=t.pageX-t.target.offsetLeft,e._y=t.pageY-t.target.offsetTop,h.pub(["mousemove"])},mouseUp(t){0===t.button&&(e.elapsedTime=Math.abs(e.downTime-s.now()),e._x=t.pageX-t.target.offsetLeft,e._y=t.pageY-t.target.offsetTop,s.setVec(e.state,!1,!0),e.state[2]&&(e.press(),e.state[2]=!1),t.preventDefault(),h.pub(["mouseup"]))},_copyTouch:(e,t)=>({offsetLeft:t.offsetLeft,offsetTop:t.offsetTop,clientX:e.clientX,clientY:e.clientY,pageX:e.pageX,pageY:e.pageY,identifier:e.identifier}),touchStart(t){let r=t.changedTouches,n=t.target,o=r[0].identifier||0;e._x=r[0].pageX-n.offsetLeft,e._y=r[0].pageY-n.offsetTop,e.downTime=s.now(),s.setVec(e.state,!0,!1,!0),t.preventDefault(),s.assoc(i,o,e._copyTouch(r[0],n)),h.pub(["touchstart"])},touchMove(t){let r=t.changedTouches,n=t.target,o=r[0].identifier||0;s.get(i,o);e._x=r[0].pageX-n.offsetLeft,e._y=r[0].pageY-n.offsetTop,t.preventDefault(),h.pub(["touchmove"])},touchEnd(t){let r=t.changedTouches,n=t.target,o=r[0].identifier||0,a=s.get(i,o);e._x=r[0].pageX-n.offsetLeft,e._y=r[0].pageY-n.offsetTop,s.setVec(e.state,!1,!0),e.elapsedTime=Math.abs(e.downTime-s.now()),e.state[2]&&(a&&e.elapsedTime<=200&&e.tap(),e.state[2]=!1),t.preventDefault(),h.pub(["touchend"])},touchCancel(e){let t=e.changedTouches,r=(e.target,t[0],touch.identifier||0),n=s.get(i,r);e.preventDefault(),n&&s.dissoc(i,r)},reset(){s.setVec(e.state,!1,!0,!1)},hitTest:i=>t["2d"].hitTestPointXY(e.x,e.y,i,!0),dispose(){s.delEvent([["mousemove",t.canvas,e.mouseMove],["mousedown",t.canvas,e.mouseDown],["mouseup",window,e.mouseUp],["touchmove",t.canvas,e.touchMove],["touchstart",t.canvas,e.touchStart],["touchend",window,e.touchEnd],["touchcancel",window,e.touchCancel]])}};return s.addEvent([["mousemove",t.canvas,e.mouseMove],["mousedown",t.canvas,e.mouseDown],["mouseup",window,e.mouseUp],["touchmove",t.canvas,e.touchMove],["touchstart",t.canvas,e.touchStart],["touchend",window,e.touchEnd],["touchcancel",window,e.touchCancel]]),t.canvas.style.touchAction="none",this.ptr=e}};return h.sub(["canvas.resize"],"resize",l),s.addEvent([["keyup",window,function(e){e.preventDefault(),a.set(e.keyCode,!1)},!1],["keydown",window,function(e){e.preventDefault(),a.set(e.keyCode,!0)},!1]]),t.Input=l}if("object"==typeof module&&module.exports)throw"Fatal: browser only";e["io/czlab/mojoh5/Input"]=function(e){return e.Input?e.Input:t(e,new Map,[],[])}}(this),function(e){"use strict";function t(e){const{is:t,u:i}=e,r=Math.PI/8;function n(e,t,i){const r=+t,n=+i;return Math.min(1,Math.sqrt(r*r+n*n)/e.m5.outerRadius)}function s(t){function s(e){let i=e.changedTouches,r=e.target;i?(t.m5.startX=i[0].pageX-r.offsetLeft,t.m5.startY=i[0].pageY-r.offsetTop,t.m5.touchId=i[0].identifier):(t.m5.startX=e.pageX-r.offsetLeft,t.m5.startY=e.pageY-r.offsetTop,t.m5.touchId=0),t.m5.drag=!0,t.m5.inner.alpha=1,t.m5.onStart()}function o(e){t.m5.drag&&(t.m5.inner.alpha=t.m5.innerAlphaStandby,t.m5.inner.position.set(0,0),t.m5.drag=!1,t.m5.onEnd())}function a(i){if(!t.m5.drag)return;let s=i.changedTouches,o=i.target,a=null,h=null;if(s){for(let e=0;e<s.length;++e)if(t.m5.touchId===s[e].identifier){a=s[e].pageX-o.offsetLeft,h=s[e].pageY-o.offsetTop;break}}else a=i.pageX-o.offsetLeft,h=i.pageY-o.offsetTop;if(null===a||null===h)return;let l=a-t.m5.startX,c=h-t.m5.startY,d=0,u=0;if(a=0,h=0,0===l&&0===c)return;d=l*l+c*c>=t.m5.outerRadius*t.m5.outerRadius?t.m5.outerRadius:t.m5.outerRadius-t.m5.innerRadius;let p=e.LEFT,m=Math.abs(l),g=Math.abs(c),f=0;if(0===l)c>0?(a=0,h=c>t.m5.outerRadius?t.m5.outerRadius:c,u=270,p=e.BOTTOM):(a=0,h=-(g>t.m5.outerRadius?t.m5.outerRadius:g),u=90,p=e.TOP),t.m5.inner.position.set(a,h),f=n(t,a,h),t.m5.onChange(p,u,f);else if(0===c)l>0?(a=m>t.m5.outerRadius?t.m5.outerRadius:m,h=0,u=0,p=e.LEFT):(a=-(m>t.m5.outerRadius?t.m5.outerRadius:m),h=0,u=180,p=e.RIGHT),t.m5.inner.position.set(a,h),f=n(t,a,h),t.m5.onChange(p,u,f);else{let i=Math.abs(c/l),s=Math.atan(i);u=180*s/Math.PI,a=h=0,l*l+c*c>=t.m5.outerRadius*t.m5.outerRadius?(a=t.m5.outerRadius*Math.cos(s),h=t.m5.outerRadius*Math.sin(s)):(a=m>t.m5.outerRadius?t.m5.outerRadius:m,h=g>t.m5.outerRadius?t.m5.outerRadius:g),c<0&&(h=-Math.abs(h)),l<0&&(a=-Math.abs(a)),l>0&&c<0||(l<0&&c<0?u=180-u:l<0&&c>0?u+=180:l>0&&c>0&&(u=360-u)),f=n(t,a,h),p=function(t,i){const n=Math.atan2(+i,+t);let s=e.TOP_RIGHT;return n>=-r&&n<0||n>=0&&n<r?s=e.RIGHT:n>=r&&n<3*r?s=e.BOTTOM_RIGHT:n>=3*r&&n<5*r?s=e.BOTTOM:n>=5*r&&n<7*r?s=e.BOTTOM_LEFT:n>=7*r&&n<Math.PI||n>=-Math.PI&&n<-7*r?s=e.LEFT:n>=-7*r&&n<-5*r?s=e.TOP_LEFT:n>=-5*r&&n<-3*r&&(s=e.TOP),s}(a,h),t.m5.inner.position.set(a,h),t.m5.onChange(p,u,f)}}i.addEvent([["mousemove",e.canvas,a],["mousedown",e.canvas,s],["mouseup",window,o],["touchend",window,o],["touchcancel",window,o],["touchmove",e.canvas,a],["touchstart",e.canvas,s]])}const o={joystick(t){let r=i.inject({outerScaleX:1,outerScaleY:1,outerRadius:0,innerRadius:0,innerScaleX:1,innerScaleY:1,innerAlphaStandby:.5,onStart(){},onEnd(){},onChange(e,t,i){}},t),n=r.outer=e.Sprites.sprite("joystick.png"),o=r.inner=e.Sprites.sprite("joystick-handle.png"),a=new PIXI.Container;return a.m5=r,n.alpha=.5,n.anchor.set(.5),o.anchor.set(.5),o.alpha=r.innerAlphaStandby,n.scale.set(r.outerScaleX,r.outerScaleY),o.scale.set(r.innerScaleX,r.innerScaleY),a.addChild(n),a.addChild(o),r.outerRadius=a.width/2.5,r.innerRadius=o.width/2,s(a),a}};return e.Touch=o}if("object"==typeof module&&module.exports)throw"Fatal: browser only";e["io/czlab/mojoh5/Touch"]=function(e){return e.Touch?e.Touch:t(e)}}(this),function(e){"use strict";function t(t){const{EventBus:i,is:r,u:n}=e["io/czlab/mcfud/core"](),s=e["io/czlab/mcfud/geo2d"](),o=e["io/czlab/mcfud/vec2"](),a=Math.abs,h=Math.floor;function l(e,i,r){let n,o,a,h=t.Sprites;return h.circular(e)?(n=h.toCircle(e,r),o=h.circular(i)?h.toCircle(i,r):h.toPolygon(i,r),a=h.circular(i)?s.hitCircleCircle(n,_b):s.hitCirclePolygon(n,_b)):(n=h.toPolygon(e,r),o=h.circular(i)?h.toCircle(i,r):h.toPolygon(i,r),a=h.circular(i)?s.hitPolygonCircle(n,o):s.hitPolygonPolygon(n,o)),a&&(a.A=e,a.B=i,e.m5.collisions.push(a),i.m5.collisions.push(a)),a}function c(e,t,i=!0,r=!1){let n=l(e,t,r);if(n){if(t.m5.static)e.x-=n.overlapV[0],e.y-=n.overlapV[1];else{let i=n.overlapV[0]/2,r=n.overlapV[1]/2;e.x-=i,e.y-=r,t.x+=i,t.y+=r}i&&function(e,t,i){if(t.m5.static){let t=o.mul(i.overlapN,2*o.dot(e.m5.vel,i.overlapN));o.sub$(e.m5.vel,t)}else{let r=-2*((t.m5.vel[0]-e.m5.vel[0])*i.overlapN[0]+(t.m5.vel[1]-e.m5.vel[1])*i.overlapN[1])/(e.m5.invMass+t.m5.invMass);e.m5.vel[0]-=r*i.overlapN[0]/e.m5.mass,e.m5.vel[1]-=r*i.overlapN[1]/e.m5.mass,t.m5.vel[0]+=r*i.overlapN[0]/t.m5.mass,t.m5.vel[1]+=r*i.overlapN[1]/t.m5.mass}}(e,t,n)}return n}function d(e){let i=new Set;return e.overlapN[1]<-.3&&i.add(t.TOP),e.overlapN[1]>.3&&i.add(t.BOTTOM),e.overlapN[0]<-.3&&i.add(t.LEFT),e.overlapN[0]>.3&&i.add(t.RIGHT),i}function u(e,t,i,r,n){let s,o=l(e,t,i);return o&&(r&&(e.x-=o.overlapV[0],e.y-=o.overlapV[1]),s=d(o),n&&n(s,t)),s}t.defMixin("2d",(function(e){const s=t.EventBus,o={},h=[[["hit",e],"boom",o],[["post.remove",e],"dispose",o]];return o.dispose=function(){h.forEach((e=>s.unsub.apply(s,e)))},o.boom=function(t){{let n=a(e.m5.vel[0]),s=a(e.m5.vel[1]);t.impact=null,e.x-=t.overlapV[0],e.y-=t.overlapV[1],t.overlapN[1]<-.3&&(!e.m5.skipCollide&&e.m5.vel[1]<0&&(e.m5.vel[1]=0),t.impact=s,i.pub(["bump.top",e],t)),t.overlapN[1]>.3&&(!e.m5.skipCollide&&e.m5.vel[1]>0&&(e.m5.vel[1]=0),t.impact=s,i.pub(["bump.bottom",e],t)),t.overlapN[0]<-.3&&(!e.m5.skipCollide&&e.m5.vel[0]<0&&(e.m5.vel[0]=0),t.impact=n,i.pub(["bump.left",e],t)),t.overlapN[0]>.3&&(!e.m5.skipCollide&&e.m5.vel[0]>0&&(e.m5.vel[0]=0),t.impact=n,i.pub(["bump.right",e],t)),r.num(t.impact)?i.pub(["bump",e],t):t.impact=0}},o.motion=function(t){for(let i=t;i>0;)t=n.min(1/30,i),e.m5.vel[0]+=e.m5.acc[0]*t+e.m5.gravity[0]*t,e.m5.vel[1]+=e.m5.acc[1]*t+e.m5.gravity[1]*t,e.x+=e.m5.vel[0]*t,e.y+=e.m5.vel[1]*t,e.m5.collide&&e.m5.collide(),i-=t},h.forEach((e=>s.sub.apply(s,e))),o})),t.defMixin("platformer",(function(e){const r={jumpSpeed:-300,jumping:!1,landed:0},n=[[["bump.bottom",e],"onLanded",r],[["post.remove",e],"dispose",r]];return r.dispose=function(){n.forEach((e=>i.unsub.apply(B,e)))},r.onLanded=function(){r.landed=.2},r.motion=function(n){const s=t.Input;let o,a=r.jumping/3,h=s.keyDown(s.keyRIGHT),l=s.keyDown(s.keyUP),c=s.keyDown(s.keyLEFT);c&&!h?(e.m5.direction=t.LEFT,o&&r.landed>0?(e.m5.vel[0]=e.m5.speed*o.overlapN[1],e.m5.vel[1]=-1*e.m5.speed*o.overlapN[0]):e.m5.vel[0]=-1*e.m5.speed):h&&!c?(e.m5.direction=t.RIGHT,o&&r.landed>0?(e.m5.vel[0]=-1*e.m5.speed*o.overlapN[1],e.m5.vel[1]=e.m5.speed*o.overlapN[0]):e.m5.vel[0]=e.m5.speed):(e.m5.vel[0]=0,o&&r.landed>0&&(e.m5.vel[1]=0)),r.landed>0&&l&&!r.jumping?(e.m5.vel[1]=r.jumpSpeed,r.landed=-n,r.jumping=!0):l&&(i.pub(["jump",e]),r.jumping=!0),r.jumping&&!l&&(r.jumping=!1,i.pub(["jumped",e]),e.m5.vel[1]<r.jumpSpeed/3&&(e.m5.vel[1]=a)),r.landed-=n},n.forEach((e=>i.sub.apply(B,e))),r})),t.defMixin("aiBounceX",(function(e){let r={dispose(){i.unsub(["post.remove",e],"dispose",r),i.unsub(["bump.right",e],"goLeft",r),i.unsub(["bump.left",e],"goRight",r)},goLeft(i){e.m5.vel[0]=-e.m5.speed,r.defaultDirection===t.RIGHT?e.m5.flip="x":e.m5.flip=!1},goRight(i){e.m5.vel[0]=e.m5.speed,r.defaultDirection===t.LEFT?e.m5.flip="x":e.m5.flip=!1}};return i.sub(["post.remove",e],"dispose",r),i.sub(["bump.right",e],"goLeft",r),i.sub(["bump.left",e],"goRight",r),r})),t.defMixin("aiBounceY",(function(e){let r={dispose(){i.unsub(["post.remove",e],"dispose",r),i.unsub(["bump.top",e],"goDown",r),i.unsub(["bump.bottom",e],"goUp",r)},goUp(i){e.m5.vel[0]=-i.overlapV[0],r.defaultDirection===t.DOWN?e.m5.flip="y":e.m5.flip=!1},goDown(i){e.m5.vel[0]=i.overlapV[0],r.defaultDirection===t.UP?e.m5.flip="y":e.m5.flip=!1}};return i.sub(["post.remove",e],"dispose",r),i.sub(["bump.top",e],"goDown",r),i.sub(["bump.bottom",e],"goUp",r),r}));const p=o.vec(),m={hitTestPointXY(e,t,i,r){return p[0]=e,p[1]=t,this.hitTestPoint(p,i,r)},hitTestPoint(e,i,r){let n;if(i.m5.circular){let s=t.Sprites.centerXY(i,r),a=o.vecAB(s,e),l=h(i.width/2);n=o.len2(a)<l*l}else{let s=t.Sprites.toPolygon(i,r),a=o.translate(s.pos,s.calcPoints);n=function(e,t,i){let r=i.length,n=!1;for(let s,o,a=0,h=r-1;a<r;)s=i[a],o=i[h],s[1]>t!=o[1]>t&&e<(o[0]-s[0])*(t-s[1])/(o[1]-s[1])+s[0]&&(n=!n),h=a,++a;return n}(e[0],e[1],a),o.reclaim(...a)}return n},hit(e,t,r){let n=l(e,t,r);return n&&(i.pub(["hit",e],n),i.pub(["hit",t],n)),n},collide(e,t,i=!0,n=!1){let s,o;if(r.vec(t))for(let r=t.length-1;r>=0;--r)c(e,t[r],i,n);else s=c(e,t,i,n),o=s&&d(s);return o},hitTest(e,t,i,n,s){let o;if(r.vec(t))for(let r=t.length-1;r>=0;--r)u(e,t[r],i,n,s);else o=u(e,t,i,n,s);return o},contain(e,i,r,o){let a;i instanceof t.Scenes.Scene?a=t.mockStage():(i.m5&&i.m5.stage||(i.isSprite?n.assert(sprite.parent===i):n.assert(!1,"Error: contain() using bad container"),n.assert(0===i.rotation,"Error: contain() container can't rotate"),n.assert(0===i.anchor.x,"Error: contain() container anchor.x !==0"),n.assert(0===i.anchor.y,"Error: contain() container anchor.y !==0")),a=i);let h=t.Sprites.anchorOffsetXY(a),l=new Set,c=!1,d=!1,u=s.getAABB(t.Sprites.circular(sprite)?t.Sprites.toCircle(sprite,!1):t.Sprites.toPolygon(sprite,!1)),p=a.x-h[0],m=a.y-h[1],g=p+a.width,f=m+a.height;return u.pos[0]+p<p&&(sprite.x+=p-u.pos[0]-p,c=!0,l.add(t.LEFT)),u.pos[1]+m<m&&(sprite.y+=m-u.pos[1]-m,d=!0,l.add(t.TOP)),u.pos[0]+u.width+p>g&&(sprite.x-=u.pos[0]+u.width+p-g,c=!0,l.add(t.RIGHT)),u.pos[1]+u.height+m>f&&(sprite.y-=u.pos[1]+u.height+m-f,d=!0,l.add(t.BOTTOM)),l.size>0?(c&&(sprite.m5.vel[0]/=sprite.m5.mass,r&&(sprite.m5.vel[0]*=-1)),d&&(sprite.m5.vel[1]/=sprite.m5.mass,r&&(sprite.m5.vel[1]*=-1)),o&&o(l)):l=null,l},worldCamera:(e,i,n,s)=>({width:s.width,height:s.height,_x:0,_y:0,get x(){return this._x},set x(t){this._x=t,e.x=-this._x},get y(){return this._y},set y(t){this._y=t,e.y=-this._y},get centerX(){return this.x+this.width/2},get centerY(){return this.y+this.height/2},get rightInnerBoundary(){return this.x+this.width/2+this.width/4},get leftInnerBoundary(){return this.x+this.width/2-this.width/4},get topInnerBoundary(){return this.y+this.height/2-this.height/4},get bottomInnerBoundary(){return this.y+this.height/2+this.height/4},follow(e){e.x<this.leftInnerBoundary&&(this.x=e.x-this.width/4),e.y<this.topInnerBoundary&&(this.y=e.y-this.height/4),e.x+e.width>this.rightInnerBoundary&&(this.x=e.x+e.width-this.width/4*3),e.y+e.height>this.bottomInnerBoundary&&(this.y=e.y+e.height-this.height/4*3),this.x<0&&(this.x=0),this.y<0&&(this.y=0),this.x+this.width>i&&(this.x=i-this.width),this.y+this.height>n&&(this.y=n-this.height)},centerOver(e,i){let n=this.width/2,s=this.height/2;if(2===arguments.length)r.num(e)&&(this.x=e-n),r.num(i)&&(this.y=i-s);else{let i=t.Sprites.halfSize(e);this.x=e.x+i.width-n,this.y=e.y+i.height-s}}})};return t["2d"]=m}if("object"==typeof module&&module.exports)throw"Fatal: browser only";e["io/czlab/mojoh5/2d"]=function(e){return e["2d"]?e["2d"]:t(e)}}(this),function(e){"use strict";function t(t,i,r){const{u:n,is:s}=e["io/czlab/mcfud/core"](),o=e["io/czlab/mcfud/math"](),a=(Math.PI,Math.PI/2),h=5*Math.PI;class l{constructor(e){this.bits=e}}class c{constructor(e,t){this.sprite=e,this.easing=t}onEnd(){}onFrame(e,t){}_stop(){this.on=!1}_s(e){n.assert(s.num(e)),this.step=function(){if(this.on)if(this.curf<e){let t=this.curf/e,i=this.easing(t);this.onFrame(!1,i),this.curf+=1}else this.onFrame(!0),this._e(),this.onEnd()},this.on=!0,this.curf=0,n.conj(i,this)}_e(){_T.remove(this),this.cb&&this.cb()}onComplete(e){this.cb=e}}const d={EXPO_IN:e=>0===e?0:Math.pow(1024,e-1),EXPO_OUT:e=>1===e?1:1-Math.pow(2,-10*e),EXPO_INOUT:e=>0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1))),LINEAR:e=>e,SMOOTH:e=>3*e*e-2*e*e*e,SMOOTH_QUAD(e){let t=this.SMOOTH(e);return t*t},SMOOTH_CUBIC(e){let t=this.SMOOTH(e);return t*t*t},EASE_IN_CUBIC:e=>e*e*e,EASE_OUT_CUBIC(e){let t=1-e;return 1-t*t*t},EASE_INOUT_CUBIC(e){if(e<.5)return 4*e*e*e;{let t=-2*e+2;return 1-t*t*t/2}},EASE_IN_QUAD:e=>e*e,EASE_OUT_QUAD:e=>1-(1-e)*(1-e),EASE_INOUT_QUAD(e){if(e<.5)return 2*e*e;{let t=-2*e+2;return 1-t*t/2}},EASE_IN_SINE:e=>1-Math.cos(e*a),EASE_OUT_SINE:e=>Math.sin(e*a),EASE_INOUT_SINE:e=>.5-Math.cos(e*Math.PI)/2,SPLINE:(e,t,i,r,n)=>(2*i+(r-t)*e+(2*t-5*i+4*r-n)*e*e+(3*i-t-3*r+n)*e*e*e)/2,CUBIC_BEZIER:(e,t,i,r,n)=>t*e*e*e+3*i*e*e*(1-e)+3*r*e*(1-e)*(1-e)+n*(1-e)*(1-e)*(1-e),ELASTIC_IN:e=>0===e?0:1===e?1:-Math.pow(2,10*(e-1))*Math.sin((e-1.1)*h),ELASTIC_OUT:e=>0===e?0:1===e?1:1+Math.pow(2,-10*e)*Math.sin((e-.1)*h),ELASTIC_INOUT(e){switch(e){case 0:return 0;case 1:return 1;default:return(e*=2)<1?-.5*Math.pow(2,10*(e-1))*Math.sin((e-1.1)*h):1+.5*Math.pow(2,-10*(e-1))*Math.sin((e-1.1)*h)}},BOUNCE_IN(e){return 1-this.BOUNCE_OUT(1-e)},BOUNCE_OUT:e=>e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375,BOUNCE_INOUT(e){return e<.5?.5*this.BOUNCE_IN(2*e):.5*this.BOUNCE_OUT(2*e-1)+.5},tweenAlpha(e,t,i,r=60,a=!1){const h=n.inject(new c(e,t),{start(e,t){return this._s(r),this._a=[e,t],this},onFrame(e,t){this.sprite.alpha=e?this._a[1]:o.lerp(this._a[0],this._a[1],t)},onEnd(){a&&n.delay(0,(()=>this.start(this._a[1],this._a[0])))}});let l=e.alpha,d=i;return s.vec(i)&&(l=i[0],d=i[1]),h.start(l,d)},tweenScale(e,t,i,r,a=60,h=!1){const l=n.inject(new c(e,t),{start(e,t,i,r){return this._s(a),this._x=[e,t],this._y=[i,r],this},onFrame(e,t){s.num(this._x[1],this._x[0])&&(this.sprite.scale.x=e?this._x[1]:o.lerp(this._x[0],this._x[1],t)),s.num(this._y[1],this._y[0])&&(this.sprite.scale.y=e?this._y[1]:o.lerp(this._y[0],this._y[1],t))},onEnd(){h&&n.delay(0,(()=>this.start(this._x[1],this._x[0],this._y[1],this._y[0])))}});let d=e.scale.x,u=e.scale.y,p=i,m=r;return s.vec(i)&&(d=i[0],p=i[1]),s.vec(r)&&(u=r[0],m=r[1]),l.start(d,p,u,m)},tweenXY(e,t,i,r,a=60,h=!1){const l=n.inject(new c(e,t),{start(e,t,i,r){return this._s(a),this._x=[e,t],this._y=[i,r],this},onFrame(e,t){s.num(this._x[0],this._x[1])&&(this.sprite.x=e?this._x[1]:o.lerp(this._x[0],this._x[1],t)),s.num(this._y[0],this._y[1])&&(this.sprite.y=e?this._y[1]:o.lerp(this._y[0],this._y[1],t))},onEnd(){h&&n.delay(0,(()=>this.start(this.ex,this.sx,this.ey,this.sy)))}});let d=e.x,u=e.y,p=i,m=r;return s.vec(i)&&(d=i[0],p=i[1]),s.vec(r)&&(u=r[0],m=r[1]),l.start(d,p,u,m)},fadeOut(e,t=60){return this.tweenAlpha(e,this.EASE_OUT_SINE,0,t)},fadeIn(e,t=60){return this.tweenAlpha(e,this.EASE_OUT_SINE,1,t)},pulse(e,t=0,i=60){return this.tweenAlpha(e,this.SMOOTH,t,i)},slide(e,t,i,r,n=60,s=!1){return this.tweenXY(e,t,i,r,n,s)},breathe(e,t=.8,i=.8,r=60,n=!0){return this.tweenScale(e,this.SMOOTH_QUAD,t,i,r,n)},scale(e,t=.5,i=.5,r=60){return this.tweenScale(e,this.SMOOTH,t,i,r)},strobe(e,t=1.3,i=10,r=20,n=10,s=!0){return this.tweenScale(e,(e=>this.SPLINE(e,i,0,1,r)),t,t,n,s)},wobble(e,t=1.2,i=1.2,r=10,s=.98,o,a=!0){let{x1:h,x2:l,y1:c,y2:d}=o,u=this.tweenScale(e,(e=>_T.SPLINE(e,n.or(h,10),0,1,n.or(l,10))),t,null,r,a),p=this.tweenScale(e,(e=>_T.SPLINE(e,n.or(c,-10),0,1,n.or(d,-10))),null,i,r,a),m=u.onFrame,g=p.onFrame;return u.onFrame=function(e,t){e&&this._x[1]>1&&(this._x[1]*=s,this._x[1]<=1&&(this._x[1]=1)),m.call(u,e,t)},p.onFrame=function(e,t){e&&this._y[1]>1&&(this._y[1]*=s,this._y[1]<=1&&(this._y[1]=1)),g.call(p,e,t)},new MutiTweens(u,p)},followCurve(e,t,i,r=60,s=!1){return n.inject(new c(e,this.SMOOTH),{start(e){return this._s(r),this._p=e,this},onFrame(t,i){let r=this._p;t||Sprites.setXY(e,this.CUBIC_BEZIER(i,r[0][0],r[1][0],r[2][0],r[3][0]),this.CUBIC_BEZIER(i,r[0][1],r[1][1],r[2][1],r[3][1]))},onEnd(){s&&n.delay(0,(()=>this.start(this._p.reverse())))}}).start(i)},walkPath:(e,t,i,r=300,s=!1)=>function r(o,a){let h=this.tweenXY(e,t,[i[o][0],i[o+1][0]],[i[o][1],i[o+1][1]],a);return h.onEnd=function(){++o<i.length-1?n.delay(0,(()=>r(o,a))):s&&(i.reverse(),n.delay(0,(()=>{Sprites.setXY(e,i[0][0],i[0][1]),r(0,a)})))},h}(0,MFL(r/i.length)),walkCurve(e,t,i,r=300,s=!1){let o=(r,a)=>{let h=this.followCurve(e,t,i[r],a);return h.onEnd=function(){++r<i.length?n.delay(0,(()=>o(r,a))):s&&(i.reverse().forEach((e=>e.reverse())),n.delay(0,(()=>{Sprites.setXY(sprite,i[0][0],i[0][1]),o(0,a)})))},h};return o(0,MFL(r/i.length))},remove(e){e._stop(),e instanceof class{constructor(...e){this.cnt=0;let t=()=>{++this.cnt===this.size()&&(this.cnt=0,this.cb&&this.cb())};this.children=e.map((e=>{let i=e._e;return e._e=function(){i.call(e),t()},e}))}onComplete(e){this.cb=e}size(){return this.children.length}dispose(){this.children.forEach((e=>t.FX.remove(e))),this.children.length=0}_stop(){this.children.forEach((e=>e._stop()))}}?e.dispose():n.disj(i,e)},update(e){n.rseq(i,(t=>t.step(e))),n.rseq(r,(e=>{e.bits.length>0?n.rseq(e.bits,(e=>e.m5.step())):n.disj(r,e)}))},createParticles(e,t,i,s,o,a,h,c=!0,d=20){a=n.patch(a,{angle:0,size:4,speed:.3,scale:.01,alpha:.02,rotate:.01}),h=n.patch(h,{angle:6.28,size:16,speed:3,scale:.05,alpha:.02,rotate:.03}),n.assert(d>1);let u=[];function p(r){let l=n.randInt2(a.size,h.size),c=i();u.push(c),s.addChild(c),c.totalFrames>0&&c.gotoAndStop(n.randInt2(0,c.totalFrames-1)),Sprites.setSize(c,l),Sprites.setXY(c,e,t),Sprites.centerAnchor(c),c.m5.scaleSpeed=n.randFloat(a.scale,h.scale),c.m5.alphaSpeed=n.randFloat(a.alpha,h.alpha),c.m5.angVel=n.randFloat(a.rotate,h.rotate);let d=n.randFloat(a.speed,h.speed);c.m5.vel[0]=d*Math.cos(r),c.m5.vel[1]=d*Math.sin(r),c.m5.step=function(){c.m5.vel[1]+=o[1],c.x+=c.m5.vel[0],c.y+=c.m5.vel[1],c.scale.x-c.m5.scaleSpeed>0&&(c.scale.x-=c.m5.scaleSpeed),c.scale.y-c.m5.scaleSpeed>0&&(c.scale.y-=c.m5.scaleSpeed),c.rotation+=c.m5.angVel,c.alpha-=c.m5.alphaSpeed,c.alpha<=0&&(n.disj(u,c),Sprites.remove(c))}}for(let e=(h.angle-a.angle)/(d-1),t=a.angle,i=0;i<d;++i)p(c?n.randFloat(a.angle,h.angle):t),t+=e;let m=new l(u);return n.conj(r,m),m}};return t.FX=d}if("object"==typeof module&&module.exports)throw"Fatal: browser only";e["io/czlab/mojoh5/FX"]=function(e){return e.FX?e.FX:t(e,[],[])}}(this),function(e){"use strict";function t(t){const i=[t.UP,t.LEFT,t.RIGHT,t.DOWN],{u:r,is:n}=e["io/czlab/mcfud/core"](),s=e["io/czlab/mcfud/vec2"](),o=Math.abs,a=Math.floor,h=[];function l(e){return(e.properties||h).reduce(((e,t)=>(e[t.name]=t.value,e)),{})}function c(e,i,r){return t.getIndex(e,i,r.tiled.tileW,r.tiled.tileH,r.tiled.tilesInX)}function d(e,i,r){return s.vecAB(t.Sprites.centerXY(e,r),t.Sprites.centerXY(i,r))}function u(e){const t=e.image,i=t&&t.split("/");return i&&i.length&&i[i.length-1]}function p(e,t){let i=0;for(;t[i+1]&&e>=t[i+1][0];)++i;return t[i]}function m(e,t){let i=[];return e.forEach((e=>{e.image=u(e),i.push([e.firstgid,e]),e.tiles.forEach((i=>{t[e.firstgid+i.id]=r.inject(l(i),{id:i.id})}))})),i.sort(((e,t)=>e[0]>t[0]?1:e[0]<t[0]?-1:0))}class g{constructor(e){this._grid=e;e[0].length;let t=e.length-1,i=e[0],n=e[1],s=(e[t],i[1].x1-i[0].x2),o=n[0].y1-i[0].y2;r.assert(s===o),this._gap=s}drawBox(e="white"){return t.Sprites.drawBody((t=>this._draw(t,e,!0)))}draw(e="white"){return t.Sprites.drawBody((t=>this._draw(t,e)))}_draw(e,t="white",i=!1){let r=this._grid[0].length,n=this._grid.length,s=r-1,o=n-1,a=this._grid[0],h=this._grid[o];a[0],h[s];e.lineStyle(this.gap,_S.color(t));for(let t,r=0;r<n;++r)t=this._grid[r],0===r&&(e.moveTo(t[r].x1,t[r].y1),e.lineTo(a[s].x2,a[s].y1)),r===o?(e.moveTo(t[0].x1,t[0].y2),e.lineTo(t[s].x2,t[s].y2)):i||(e.moveTo(t[0].x1,t[0].y2),e.lineTo(t[s].x2,t[s].y2));for(let t=0;t<r;++t)0===t&&(e.moveTo(a[t].x1,a[t].y1),e.lineTo(h[t].x1,h[t].y2)),t===s?(e.moveTo(a[t].x2,a[t].y1),e.lineTo(h[t].x2,h[t].y2)):i||(e.moveTo(a[t].x2,a[t].y1),e.lineTo(h[t].x2,h[t].y2))}cell(e,t){return this._grid[e][t]}get gap(){return this._gap}get data(){return this._grid}}class f{constructor(e,t){this.straightCost=e,this.diagonalCost=t}manhattan(e,t){return o(e.row-t.row)*this.straightCost+o(e.col-t.col)*this.straightCost}euclidean(e,t){let i=t.col-e.col,n=t.row-e.row;return a(r.sqrt(i*i+n*n)*this.straightCost)}diagonal(e,t){let i=o(t.col-e.col),r=o(t.row-e.row);return a(i>r?this.diagonalCost*r+this.straightCost*(i-r):this.diagonalCost*i+this.straightCost*(r-i))}}const y={getTileIndex:(e,t,i)=>c(e,t,i),mapGridPos(e,i,r=.8,s="center"){let o,h,l,c,d,u,p,m,f,y,x,w,v,T=[];switch(n.vec(e)?[f,y]=e:f=y=e,i<0&&(i=0),p=i*(f+1),m=i*(y+1),x=t.portrait()?a((r*t.width-p)/f):a(r*(t.height-m)/y),w=x*f+p,v=x*y+m,h=a((t.height-v)/2),s){case"right":o=t.width-w;break;case"left":o=0;break;default:o=a((t.width-w)/2)}o+=i,l=o,h+=i,c=h;for(let e,t=0;t<y;++t){e=[];for(let t=0;t<f;++t)u=c+x,d=l+x,e.push({x1:l,x2:d,y1:c,y2:u}),l=d+i;T.push(e),c=u+i,l=o}return new g(T)},getTile(e,i,r){const n=r.tiled;return t.Sprites.extend({gid:i[e],width:n.tileW,height:n.tileH,anchor:t.makeAnchor(0,0),x:e%n.tilesInX*n.tileW+r.x,y:a(e/n.tilesInX)*n.tileH+r.y,getGlobalPosition(){return{x:this.x,y:this.y}}})},neighborCells(e,t,i){let r=t.tiled.tilesInX,n=[e-r-1,e-r,e-r+1,e-1],s=[e+1,e+r-1,e+r,e+r+1];return i||n.push(e),n.concat(s)},hitTestTile(e,i,r,n,o=t.SOME){let a={};let h=o!==t.CENTER?function(e){let i,r=t.Sprites.getBBox(e);return(i=e.collisionArea)&&(r={x1:r.x1+i.x1,x2:r.x1+i.x2,y1:r.y1+i.y1,y2:r.y1+i.y2}),r.x2-=1,r.y2-=1,[s.vec(r.x1,r.y1),s.vec(r.x2,r.y1),s.vec(r.x2,r.y2),s.vec(r.x1,r.y2)]}(e):[t.Sprites.centerXY(e)],l=o===t.EVERY?"every":"some";return a.hit=h[l]((function(e){return a.index=c(e[0],e[1],n),a.gid=i[a.index],a.gid===r})),s.reclaim(...h),a},updateMap(e,i,s){let o=r.fill(e.length,0),a=e=>{let i=this.getTileIndex(t.Sprites.centerXY(e),s);r.assert(i>=0&&i<o.length,"tiled index outofbound"),e.tiled.____index=i,o[i]=e.tiled.____gid};return n.vec(i)?i.forEach(a):a(i),o},tiledWorld(e){function i(e){return t.Sprites.container((t=>{r.assertNot(r.has(t,"tiled")),t.tiled=r.inject({},e)}))}let s=t.resource(e,!0).data,o=i(function(t){if(!t)throw`Error: ${e} not cached`;let i=t.tiledversion||t.version;if(i&&r.cmpVerStrs(i,"1.4.2")<0)throw`Error: ${e}-${i} needs an update`;return l(t)}(s)),h={};r.patch(o.tiled,{tileLayers:{tilelayer:[],imagelayer:[],objectgroup:[]},tileProps:h,tileH:s.tileheight,tileW:s.tilewidth,tilesInX:s.width,tilesInY:s.height,tiledWidth:s.width*s.tilewidth,tiledHeight:s.height*s.tileheight,tileGidList:m(s.tilesets,h)}),o.tiled.getTSInfo=function(e){return p(e,o.tiled.tileGidList)[1]},o.tiled.getTileLayer=function(e,t){let i=r.some(o.tiled.tileLayers.tilelayer,(t=>{if(t.name===e)return t}));if(!i&&t)throw`There is no layer with name: ${e}`;return i},o.tiled.getScaleFactor=function(){let e,i=1;return"max"===t.u.scaleToWindow&&(t.width>t.height?(e=s.height*s.tileheight,i=t.height/e):(e=s.width*s.tilewidth,i=t.width/e)),i},o.tiled.getObjectGroup=function(e,t){let i=r.some(o.tiled.tileLayers.objectgroup,(t=>{if(t.name===e)return t}));if(!i&&t)throw`There is no layer with name: ${e}`;return i};let c={tilelayer(e){let s=n.vec(e.data[0])?e.data.flat():e.data,l=i(e);for(let i,c=0;c<s.length;++c){if(i=s[c],0===i)continue;let d=p(i,o.tiled.tileGidList)[1],u=d.columns,m=i-d.firstgid;r.assertNot(m<0,`Bad tile id: ${m}`),n.num(u)||(u=a(d.imagewidth/(d.tilewidth+d.spacing)));let g=c%e.width,f=a(c/e.width),y=m%u,x=a(m/u),w=y*d.tilewidth,v=x*d.tileheight;d.spacing>0&&(w+=d.spacing*y,v+=d.spacing*x);let T=t.Sprites.sprite(t.Sprites.frame(d.image,d.tilewidth,d.tileheight,w,v)),b=o.tiled.getScaleFactor(),_=h[i];r.assertNot(r.has(T,"tiled")),T.tiled={____gid:i,____index:c,id:m,ts:d,props:_},T.scale.x=b,T.scale.y=b,T.x=g*T.width,T.y=f*T.height,T.m5.resize=function(e,t,i,r){let n=o.tiled.getScaleFactor();T.scale.x=n,T.scale.y=n,T.x=g*T.width,T.y=f*T.height},l.addChild(T)}return l},objectgroup(e){let t=i(e);return e.objects.forEach((e=>{let t=l(e);r.dissoc(e,"properties"),r.inject(e,t)})),t},imagelayer:e=>(e.image=u(e),i(e))};for(let e,t,i=0;i<s.layers.length;++i)t=s.layers[i],e=c[t.type]&&c[t.type](t),e&&(r.inject(e.tiled,l(t)),r.dissoc(e.tiled,"properties"),e.tiled.name=t.name,e.name=t.name,e.visible=!!t.visible,e.alpha=t.opacity,o.addChild(e),o.tiled.tileLayers[t.type].push(e));return o},shortestPath(e,t,i,r,n=[],s="manhattan",o=!0){let h=r.tiled.tilesInX,l=i.map(((e,t)=>({f:0,g:0,h:0,parent:null,index:t,col:t%h,row:a(t/h)}))),c=l[t],d=l[e],u=d,p=[u],m=[],g=[];function y(e){return(o?this.neighborCells(e,r,!0):this.crossCells(e,r)).map((e=>l[e])).filter((t=>{if(t){let r=e%h==0,s=(e+1)%h==0,o=t.col%(h-1)==0&&0!==t.col,a=t.col%h==0,l=n.some((e=>i[t.index]===e));return r?!o:s?!a:!l}}))}for(;u!==c;){let e=y(u.index);for(let t,i,r,n,o,a=0;a<e.length;++a){o=e[a],n=14,u.row!==o.row&&u.col!==o.col||(n=10),i=u.g+n,t=i+new f(10,14)[s](o,c);let h=p.some((e=>o===e)),l=m.some((e=>o===e));h||l?o.f>t&&(o.f=t,o.g=i,o.h=r,o.parent=u):(o.f=t,o.g=i,o.h=r,o.parent=u,p.push(o))}if(m.push(u),0===p.length)return g;p=p.sort(((e,t)=>e.f-t.f)),u=p.shift()}if(0!==p.length){let e=c;for(g.push(e);e!==d;)e=e.parent,g.unshift(e)}return g},lineOfSight(e,i,r,n,o=0,h=32,l=[]){let u,p,m,g,f,y=d(e,i),x=s.len(y),w=a(x/h),v=[];for(let i,r=1;r<=w;++r)i=t.Sprites.centerXY(e),u=h*r,g=y[0]/x,f=y[1]/x,p=a(i[0]+g*u),m=a(i[1]+f*u),v.push({x:p,y:m,index:c(p,m,n)});let T=180*Math.atan2(y[1],y[0])/Math.PI;return v.every((e=>r[e.index]===o))&&(0===l.length||l.some((e=>e===T)))},crossCells(e,t){const i=t.tiled.tilesInX;return[e-i,e-1,e+1,e+i]},getCrossTiles(e,t,i){return this.crossCells(e,i).map((e=>t[e]))},getDiagonalCells(e,t){const i=t.tiled.tilesInX;return[e-i-1,e-i+1,e+i-1,e+i+1]},getDiagonalTiles(e,t,i){return this.getDiagonalCells(e,i).map((e=>t[e]))},validDirections(e,r,n,s){const o=this.getTileIndex(e,s);return this.getCrossTiles(o,r,s).map(((e,r)=>e===n?i[r]:t.NONE)).filter((e=>e!==t.NONE))},canChangeDirection(e=[]){let i=e.find((e=>e===t.UP)),r=e.find((e=>e===t.DOWN)),n=e.find((e=>e===t.LEFT)),s=e.find((e=>e===t.RIGHT));return 0===e.length||1===e.length||(i||r)&&(n||s)},randomDirection:(e=[])=>0===e.length?t.TRAPPED:1===e.length?e[0]:e[r.randInt2(0,e.length-1)],closestDirection(e,i){const r=d(e,i);return o(r[0])<o(r[1])?r[1]<=0?t.UP:t.DOWN:r[0]<=0?t.LEFT:t.RIGHT}};return t.Tiles=y}if("object"==typeof module&&module.exports)throw"Fatal: browser only";e["io/czlab/mojoh5/Tiles"]=function(e){return e.Tiles?e.Tiles:t(e)}}(this);