!function(t,e){"use strict";const i=["mp3","wav","ogg"],s=["ttf","otf","ttc","woff"],r=["jpg","png","jpeg","gif","webp"];function n(n,o){const{EventBus:a,dom:h,is:l,u:c}=t["io/czlab/mcfud/core"](),d=t["io/czlab/mcfud/vec2"](),u=t["io/czlab/mcfud/math"](),p=a(),g=Math.floor,m=console,f=1/15;let y=!1;class x extends PIXI.Container{constructor(){super(),this.m5={stage:!0}}onResize(t,e){this.children.forEach((i=>{i instanceof t.Scenes.SceneWrapper&&(i=i.children[0]),i.onCanvasResize(e[0],e[1])})),t.Input.resize()}}c.patch(n,{assetFiles:[],logos:[],aniFps:12,fps:60});const v=()=>t.innerWidth,w=()=>t.innerHeight;function b(t){const e=new X.Scenes.Scene("loader",{setup(){t.init.call(this)}},{});return X.stage.addChild(e).runOnce()}function I(t){t.length;function e(t){0}t.forEach((t=>{(async function(t){const e=await PIXI.DOMAdapter.get().fetch(t),i=await e.arrayBuffer(),s=t.lastIndexOf("/");return{name:s>0?t.substring(s+1):t,url:t,buffer:i}})(t).then((t=>{X.Sound.decodeData(t.name,t.url,t.buffer,e)}))}))}function T(t){let e,r,n,o=[],a=[],d=[];t.u.assetFiles.forEach(((e,r)=>{l.obj(e)?c.has(s,c.fileExt(e.url))&&d.push(e):(e=t.assetPath(e),r=c.fileExt(e),c.has(i,r)?a.push(e):o.push(e))})),d.forEach((t=>{n=h.newElm("style"),r=h.newElm("span"),e=`@font-face {font-family: '${t.family}'; src: url('${t.url}');}`,m.log(`loading fontface = ${e}`),h.conj(n,h.newTxt(e)),h.conj(document.head,n),r.innerHTML="?",h.css(r,"fontFamily",undefined),h.conj(document.body,r),h.css(r,{display:"block",opacity:"0"})}));let u,p=[],g=0,f=t.u.load;return f||(f=function(t){const{Sprites:e}=t;return{init(){let i=e.sprite("boot/ZotohLab_x1240.png"),s=e.sprite("boot/preloader_bar.png"),[r,n]=t.scaleXY([i.width,i.height],[t.width,t.height]),o=t.getScaleFactor(),a=r>n?n:r;a*=.2,e.scaleXY(s,a,a),e.scaleXY(i,a,a),e.pinCenter(this,i),e.pinBelow(i,s,4*o),e.hide(s),e.opacity(s,.3),this.insertEx([i,s]),this.g.pbar=s,this.g.pbar_width=s.width},update(t){m.log("progr= "+100*t),!this.g.pbar.visible&&e.show(this.g.pbar),this.g.pbar.width=this.g.pbar_width*t}}}(t)),u=b(f),PIXI.Assets.loader.load(o,(t=>{m.log(`percentage ${t}`),p.unshift(t)})).then((e=>{let i=0,s=o.length;for(const[s,r]of Object.entries(e))c.inst(PIXI.Texture,r)&&(r.source.scaleMode="linear"),t._cache[s]=r,++i,m.log(`loaded ${s}`);m.log(`loaded ${i} files, wanted ${s}... ${i==s?"Yippy":"Hmmmm"}...!`),p.unshift("$")})).catch((t=>{++g,m.error(`Failed to load all assets: ${t}`)})),t.addBgTask({update(){if(0==p.length);else{let e=p.pop();l.num(e)?e&&f.update.call(u,e):"$"==e?(0==g&&a.length>0&&I(a),c.delay(800,(()=>function(t,e,i,s){e&&t.delBgTask(e),c.delay(50,(()=>{t.Scenes.remove(i),s?c.error("Cannot load game!"):t._runAppStart()}))}(t,this,u,g>0)))):m.error("fatal error while loading assets")}}}),t.start()}const _={width:0,height:0},E={width:1,height:1};function C(t){let e=h.newElm("style");h.conj(document.body,X._canvasObj),h.conj(e,h.newTxt("body, * {padding: 0; margin: 0; height:100%; overflow:hidden}")),h.conj(document.head,e),h.css(X._canvasObj,{outline:"none"}),h.attrs(X._canvasObj,"tabindex","0"),h.css(document.body,{background:"black"})}function O(t){X._curFPS=X.calcFPS(t),o.forEach((e=>e.update?.(t))),!y&&X.stageCS((e=>e.update?.(t)))}const P=e=>t.requestAnimationFrame(e);class M{constructor(t){this.uid=t}playSound(){}pokeMove(){this.onPoke()}pokeWait(){this.onWait()}uuid(){return this.uid}stateValue(){c.assert(!1,"implement stateValue!")}}const X={_offsetX:0,_offsetY:0,_scaleX:1,_scaleY:1,_selectedCellX:0,_selectedCellY:0,_startPanX:0,_startPanY:0,_curFPS:60,Bot:class extends M{constructor(t="p2"){super(t)}onPoke(){}onWait(){}},Local:class extends M{constructor(t="p1"){super(t)}onPoke(){X.Input.resume()}onWait(){X.Input.pause()}},Mediator:class{constructor(){this.players=[],this._pcnt=0,this.state,this.pcur,this.end,this.pwin}cur(){return this.pcur}add(t){return t.pnum=++this._pcnt,t.owner=this,this.players.push(t),this}winner(){return this.pwin}isGameOver(){return this.end}gameState(t){return t&&(this.state=t),this.state}gameOver(t){return X.Input.resume(),this.pwin=t,this.end=!0}start(t){c.assert(t,"bad player to start with"),this.end=!1,this.pcur=t,this._turn()}other(){return this.pcur===this.players[0]?this.players[1]:this.pcur===this.players[1]?this.players[0]:void 0}_turn(){this.players.forEach((t=>{t!==this.pcur&&t.pokeWait()})),this.pcur.pokeMove()}redoTurn(){this.pcur.pokeMove()}postMove(t,e){c.assert(!1,"implement postMove!")}updateState(t,e){c.assert(!1,"implement updateState!")}updateSound(t){}updateMove(t,e){this.end||(this.updateState(t,e),this.updateSound(t),c.delay(0,(()=>this.postMove(t,e))))}takeTurn(){this.end||(this.pcur===this.players[0]?this.pcur=this.players[1]:this.pcur===this.players[1]&&(this.pcur=this.players[0]),this._turn())}},SSheetFrame:class{#t;#e;constructor(t,e){this.#t=t,this.#e=e}get frame(){return this.#e}get sheet(){return this.#t}toString(){return`${this.#t}::${this.#e}`}},UNSCII:"unscii",DOKI_LOWER:"Doki Lowercase",BIGSHOUTBOB:"Big Shout Bob",COPYRIGHT:"(c) www.zotohlab.com 2022-2024.",_frame:1/n.fps,EVERY:1,SOME:2,CENTER:3,TOP:4,LEFT:5,RIGHT:6,BOTTOM:7,UP:8,DOWN:9,NW:10,NE:11,SW:12,SE:13,NONE:100,PI_45:Math.PI/4,PI_90:Math.PI/2,PI_180:Math.PI,PI_270:1.5*Math.PI,PI_360:2*Math.PI,v2:d,math:u,ute:c,is:l,dom:h,u:n,Game:{mode:1},_cache:{},MODE_ONE:1,MODE_TWO:2,MODE_NET:3,CON:console,noop:()=>{},get mouse(){return X.Input.pointer()},playSfx(t){return this.sound(t).play()},accel:(t,e,i)=>t+e*i,on:(...t)=>p.sub(...t),emit:(...t)=>p.pub(...t),off:(...t)=>p.unsub(...t),ssf(t,e){return new this.SSheetFrame(t,e)},frameRate(){return this._frame},sideRight:t=>t==X.RIGHT||t==X.NE||t==X.SE,sideLeft:t=>t==X.LEFT||t==X.NW||t==X.SW,sideTop:t=>t==X.UP||t==X.TOP||t==X.NW||t==X.NE,sideBottom:t=>t==X.DOWN||t==X.BOTTOM||t==X.SW||t==X.SE,overlap:(t,e)=>!(t.x2<e.x1||e.x2<t.x1||t.y2<e.y1||e.y2<t.y1),overlapX:(t,e)=>t.x2>e.x1&&e.x2>t.x1,overlapY:(t,e)=>t.y2>e.y1&&e.y2>t.y1,hasClass(t,e){if(e)return t.classList.contains(e)},toggleClass:(t,e)=>(e&&t.classList.toggle(e),t),addClass:(t,e)=>(c.hasClass(t,e)||t.classList.add(e),t),removeClass:(t,e)=>(c.hasClass(t,e)&&t.classList.remove(e),t),wrapv:(t,e,i)=>t<e?i:t>i?e:t,get canvas(){return this._canvasObj},get assets(){return PIXI.Assets.cache._cache},get designSize(){return this.u.arena},get width(){return this.canvas.width},get height(){return this.canvas.height},stageCS(t){this.inModal?t(c.last(this.stage.children)):this.stage.children.forEach((e=>{e instanceof X.Scenes.SceneWrapper&&(e=e.children[0]),e&&t(e)}))},scroll(e,i){t.scrollTo(e||0,i||1)},portrait:()=>X.height>X.width,screenCenter:()=>c.v2(g(X.width/2),g(X.height/2)),scaleXY:(t,e)=>[e[0]/t[0],e[1]/t[1]],makeAnchor(t,e){return new PIXI.ObservablePoint(this,t,e)},mockStage(t=0,e=0,i,s){let r=l.obj(t)?t:{x:t,y:e,width:c.nor(i,X.width),height:c.nor(s,X.height)};return r.getGlobalPosition=()=>({x:this.x,y:this.y}),r.anchor=X.makeAnchor(0,0),r.m5={stage:!0},r},tcached(t){return c.inst(PIXI.Texture,t)?t:l.str(t)?this._cache[t]||PIXI.Assets.cache._cache.get(t):e},clickPlayMsg(){return(this.touchDevice?"Tap":"Click")+" to Play!"},splitXY:(t,e)=>[t%e,g(t/e)],rect:(t,e,i,s)=>new PIXI.Rectangle(t,e,i,s),scaleSZ:(t,e)=>({width:e.width/t.width,height:e.height/t.height}),KENLXXid(t){return this.image(t)},sheet(t,e){const i=this.resource(t);return c.assert(i,`unknown sheet: ${t}.`),c.assert(l.obj(i.data)&&l.obj(i.textures),`bad sheet: ${t}`),i.textures[e]},image(t){return this.resource(t)},xml(t){return this.resource(t)},json(t){return this.resource(t)},assetPath(t,e){if(l.str(t))if(t.includes("/"))e=t;else{let n="data",o=c.fileExt(t);c.has(r,o)?n="images":"fnt"==o||c.has(s,o)?n="fonts":c.has(i,o)&&(n="audio"),e=`${n}/${t}`}return e||""},contentScaleFactor(){return _.height=X.height,_.width=X.width,"max"!==n.scaleToWindow?E:this.scaleSZ(this.designSize,_)},getScaleFactor(t){if(t||"max"==n.scaleToWindow){_.height=X.height,_.width=X.width;let t=this.scaleSZ(this.designSize,_);return"x"==n.scaleFit||"X"==n.scaleFit?t.width:"y"==n.scaleFit||"Y"==n.scaleFit?t.height:Math.min(t.width,t.height)}return 1},resource(t,i){let s,r;return c.inst(this.SSheetFrame,t)?r=this.sheet(t.sheet,t.frame):t&&(s=this.assetPath(t),r=this.tcached(t)||this.tcached(s)||PIXI.Texture.from(s)),r||(i?c.assert(!1,`no such resource ${t}.`):e)},addChild:(t,e,...i)=>(t.addChild(e),i.forEach((e=>t.addChild(e))),e),_fpsList:e,_fpsSum:0,calcFPS(t){let e,i=0;return t>0&&(e=u.ndiv(1,t),this._fpsList||(this._fpsList=c.fill(60,e),this._fpsSum=60*e),this._fpsSum-=this._fpsList.pop(),this._fpsList.unshift(e),this._fpsSum+=e,i=u.ndiv(this._fpsSum,60)),i},degToRad:t=>t*(Math.PI/180),radToDeg:t=>t*(180/Math.PI),addBgTask(t){o.push(t)},delBgTask(t){t&&(c.disj(o,t),t.dispose&&t.dispose())},resume(){y=!1},pause(){y=!0},start(){let t=0,e=c.now(),i=function(){let s=c.now(),r=(s-e)/1e3,n=X.frameRate();for(r>f&&(r=f),t+=r;t>=n;t-=n)O(r);X.ctx.render(X.stage),e=s,P(i)};return P(i)},_runAppStart(){return X.Input.keybd(X.Input.Q,(()=>{this.takeScreenShot()})),X.u.start(this)},takeScreenShot(){X.ctx.extract.canvas(X.stage).toBlob((t=>{const e=document.createElement("a");document.body.append(e),e.download="screenshot",e.href=URL.createObjectURL(t),e.click(),e.remove()}),"image/png")},worldToScreen(t,e){return[g((t-this._offsetX)*this._scaleX),g((e-this._offsetY)*this._scaleY)]},screenToWorld(t,e){return[t/this._scaleX+this._offsetX,e/this._scaleY+this._offsetY]}};return function(i){let s=!1,r=n.arena;c.assert(r,"design resolution req'd."),"max"!=n.scaleToWindow&&!0!==n.scaleToWindow||(s=!0,r={width:v(),height:w()},1==n.arena.scale&&(s=!1,n.arena=r,n.scaleToWindow="win")),i.maxed=s,n.logos||(n.logos=new Array),(async()=>{i.ctx=await PIXI.autoDetectRenderer(c.inject(r,{webgpu:{antialias:!0},webgl:{antialias:!0}})),function(i,s){i.touchDevice=!!("ontouchstart"in document),i._canvasObj=i.ctx.canvas,i._canvasObj.id="mojoh5",i.scale=1,i.scaledBgColor="#5A0101",i.stage=new x,["Sprites","Input","Scenes","Sound","FX","Ute2D","Tiles","Touch"].forEach((e=>{m.log(`installing module ${e}...`);let s=t[`io/czlab/mojoh5/${e}`](i);s.assets&&s.assets.forEach((t=>i.u.assetFiles.unshift(t)))})),o.push(i.FX,i.Input),C(),c.has(s,"border")&&h.css(i.canvas,"border",s.border);c.has(s,"bgColor")&&(i.ctx.backgroundColor=i.Sprites.color(s.bgColor));i.prevHeight=i.height,i.prevWidth=i.width,m.log(`canvas size= w:${i.prevHeight},h=${i.height}`),!0===s.resize&&(c.addEvent("resize",t,c.debounce((t=>{const[e,s]=[i.prevWidth,i.prevHeight];i.ctx.resize(v(),w()),i.emit(["canvas.resize"],[e,s]),i.prevWidth=v(),i.prevHeight=w()}),s.debounceRate||150)),i.on(["canvas.resize"],(t=>S.onResize(i,t))));i.touchDevice&&i.scroll();i._canvasObj.focus(),function(t){t.u.load||(t.u.logos=["boot/preloader_bar.png","boot/ZotohLab_x1240.png"]);let i=t.u.logos.map((e=>t.assetPath(e)));PIXI.Assets.init(),(async()=>{let s=e;try{s=await PIXI.Assets.load(i)}catch(t){m.error(t)}s&&i.length==Object.keys(s).length?(c.delay(50,(()=>T(t))),m.log("logo files loaded.")):m.log("logo files not loaded!")})()}(i)}(i,n)})()}(X)}if("object"==typeof module&&module.exports)throw"Panic: browser only!";t.MojoH5=function(t){return n(t,[])},t.MojoH5Ldr=function(e){window.addEventListener("load",(()=>t.MojoH5(e)))}}(this),function(t,e){"use strict";const i={blue:"#319bd5",green:"#78c03f",yellow:"#f9ef50",red:"#eb2224",orange:"#f48917",grey:"#848685",cyan:"#1ee5e6",lime:"#e5e61e",magenta:"#e61ee5",purple:"#a6499a"},s={aqua:"#00FFFF",black:"#000000",blue:"#0000FF",brown:"#A52A2A",crimson:"#DC143C",cyan:"#00FFFF",fuchsia:"#FF00FF",gray:"#808080",green:"#008000",grey:"#808080",lavender:"#E6E6FA",lime:"#00FF00",magenta:"#FF00FF",maroon:"#800000",navy:"#000080",olive:"#808000",orange:"#FFA500",purple:"#800080",red:"#FF0000",silver:"#C0C0C0",teal:"#008080",turquoise:"#40E0D0",wheat:"#F5DEB3",white:"#FFFFFF",yellow:"#FFFF00"};function r(r){const{v2:n,math:o,ute:a,is:h,dom:l}=r,c=t["io/czlab/mcfud/geo2d"](),d=2*Math.PI,u=Math.floor;function p(t,e,i,s){return new PIXI.GenerateTextureSystem(r.ctx).generateTexture(t)}var g,m,f;function y(t,i){let s,n;return a.inst(PIXI.Graphics,t)&&(t=p(t)),a.inst(PIXI.Texture,t)?n=t:h.vec(t)?(h.str(t[0])&&(t=t.map((t=>r.resource(t)))),s=a.inst(PIXI.Texture,t[0])?new PIXI.AnimatedSprite(t,!1):e):h.str(t)&&(n=r.resource(t)),n&&(s=i(n)),a.assert(s,`SpriteError: ${t} not found`)&&s}function x(t,e,i,s,r,n){let o=e,a=t,h=[];for(let e,l,c,d=0;d<i;++d){c=[];for(let t=0;t<s;++t)l=o+n,e=a+r,c.push({x1:a,x2:e,y1:o,y2:l}),a=e;o=l,a=t,h.push(c)}return h}function v(t,e,i){let s,n;return e&&e.m5&&e.m5.stage?n={x1:0,y1:0,x2:r.width,y2:r.height}:(void 0!==e.angle&&a.assert(a.feq0(e.angle),"expected non rotated object!"),s=e.parent,n=t.getAABB(e)),i&&s===i&&(n.x1+=i.x,n.x2+=i.x,n.y1+=i.y,n.y2+=i.y),[n,o.ndiv(n.x2-n.x1,2),o.ndiv(n.y2-n.y1,2),o.ndiv(n.x1+n.x2,2),o.ndiv(n.y1+n.y2,2)]}function w(t,e,i){if(e.m5.static)n.sub$(t.m5.vel,n.mul(i.overlapN,2*n.dot(t.m5.vel,i.overlapN)));else{let s=n.mul$(n.sub(e.m5.vel,t.m5.vel),i.overlapN),r=-2*(s[0]+s[1])/(t.m5.invMass+e.m5.invMass);n.sub$(t.m5.vel,n.mul$(n.div(i.overlapN,t.m5.mass),r)),n.add$(e.m5.vel,n.mul$(n.div(i.overlapN,e.m5.mass),r))}}function b(t,e,i){let s,r=t.toBody(e),n=t.toBody(i);return s=e.m5.circle?i.m5.circle?c.hitCircleCircle(r,n):c.hitCirclePolygon(r,n):i.m5.circle?c.hitPolygonCircle(r,n):c.hitPolygonPolygon(r,n),s&&(s.A=e,s.B=i),s}g=new PIXI.Container,(m=new PIXI.Graphics).circle(0,0,4),m.fill({color:0}),f=new PIXI.Sprite(p(m)),["m5","tiled","remove","collideXY","setup","preTMX","postTMX","dispose","preDispose","onTick","getGuid","getBBox","getSpatial"].forEach((t=>{[[g,"Container"],[m,"Graphics"],[f,"Sprite"]].forEach((e=>{a.assertNot(a.has(e[0],t),`Uh Oh, PIXI ${e[1]} has our ${t} property!`)}))}));const I={SomeColors:{},BtnColors:{},Geo:c,assets:["boot/unscii.fnt","boot/doki.fnt","boot/BIG_SHOUT_BOB.fnt","boot/splash.jpg","boot/star.png"],assertCenter:t=>a.assert(t?.anchor&&a.feq(t.anchor.x,.5)&&a.feq(t.anchor.y,.5),"not center'ed"),empty:t=>t&&0==t.children.length,btnPress(t,e,i,s,n,o=343){const h=this;return function(t){t.tint=h.color(e),s&&r.sound(s).play(),a.delay(o,(()=>{t.tint=h.color(i),n(t)}))}},oneOffClick(t,e){const i=function(){r.Input.off(["single.tap"],i),e&&r.sound(e).play(),t()};return r.Input.on(["single.tap"],i),i},cancelOneOffClick:t=>(t&&r.Input.off(["single.tap"],t),e),sizeXY:(t,e,i)=>(h.num(i)&&(t.height=i),h.num(e)&&(t.width=e),t),asCircle:t=>(t.m5.circle=!0)&&t,scaleXY:(t,e,i)=>(h.num(e)&&(t.scale.x=e),h.num(i)&&(t.scale.y=i),t),scaleBy:(t,e,i)=>(h.num(e)&&(t.scale.x*=e),h.num(i)&&(t.scale.y*=i),t),isVX:t=>!a.feq0(t.m5.vel[0]),isVY:t=>!a.feq0(t.m5.vel[1]),halfSize:t=>({width:u(t.width/2),height:u(t.height/2)}),anchorXY:(t,e,i)=>(a.assert(t.anchor,"sprite has no anchor object"),t.anchor.y=i??e,t.anchor.x=e,t),centerAnchor(t){return this.anchorXY(t,.5,.5)},topLeftAnchor(t){return this.anchorXY(t,0,0)},offsetXY:(t,e,i)=>(a.assert(t.anchor&&e>=0&&e<=1&&i>=0&&i<=1,"no anchor or bad target offset points"),[t.width*(e-t.anchor.x),t.height*(i-t.anchor.y)]),topLeftOffsetXY(t){return this.offsetXY(t,0,0)},centerOffsetXY(t){return this.offsetXY(t,.5,.5)},adjOffsetXY:(t,e,i)=>(a.assert(t.anchor&&e>=0&&e<=1&&i>=0&&i<=1,"no anchor or bad target offset points"),[t.width*(t.anchor.x-e),t.height*(t.anchor.y-i)]),makeSteerable(t){t.width!=t.height&&r.CON.warn(`object ${t.m5?.uuid} is not a square, radius will be off....`);let{width:e,height:i}=this.halfSize(t);return t.m5.steer=[0,0],t.m5.steerInfo={wanderAngle:a.rand()*Math.PI*2,arrivalThreshold:400,wanderDistance:10,wanderRadius:5,wanderRange:1,avoidDistance:400,inSightDistance:200,tooCloseDistance:60,maxForce:5,pathIndex:0},t.m5.radius=Math.sqrt(e*e+i*i),t},updateSteer:(t,e=!0)=>(t.m5?.steer&&(n.clamp$(t.m5.steer,0,t.m5.steerInfo.maxForce),n.div$(t.m5.steer,t.m5.mass),n.add$(t.m5.vel,t.m5.steer),e&&n.mul$(t.m5.steer,0)),t),clrSpatial:t=>(t.m5?.sgrid&&(t.m5.sgrid.x1=e,t.m5.sgrid.x2=e,t.m5.sgrid.y1=e,t.m5.sgrid.y2=e),t),lift(t){if(!t.m5){const e=this;t.g={},t.m5={uuid:`s${a.nextId()}`,circle:!1,stage:!1,drag:!1,dead:!1,angVel:0,friction:n.vec(1,1),gravity:n.vec(),vel:n.vec(),acc:n.vec(),static:!1,sensor:!1,sgrid:{},mass:1,type:0,cmask:0,speed:0,heading:r.RIGHT,get invMass(){return a.feq0(t.m5.mass)?0:1/t.m5.mass}},t.m5.resize=function(i,s,r,n){e.resize(t,i,s,r,n)},t.m5.getImageOffsets=function(){return{x1:0,x2:0,y1:0,y2:0}},t.m5.getContactPoints=function(){return function(t,e,i){let s=[n.vec(e,i),n.vec(e,0),n.vec(0,0),n.vec(0,i)];return t&&s.forEach((s=>{s[0]-=u(e*t.x),s[1]-=u(i*t.y)})),s}(t.anchor,t.width,t.height)},t.getGuid=function(){return t.m5.uuid},t.getSpatial=function(){return t.m5.sgrid},t.getBBox=function(){return a.feq0(t.angle)?e.getAABB(t):e.boundingBox(t)}}return t},clamp2Pi(t){for(;t.rotation>d;)t.rotation-=d;for(;t.rotation<0;)t.rotation+=d;return t},getHeading:t=>[Math.cos(t.rotation),Math.sin(t.rotation)],setOrient:(t,e,i=!1)=>(i?t.angle=e:t.rotation=e,t),toPolygon:t=>new c.Polygon(t.m5.getContactPoints()).setOrient(t.rotation),toCircle(t){return this.assertCenter(t)&&new c.Circle(o.ndiv(t.width,2)).setOrient(t.rotation)},toBody(t){let e=t.x,i=t.y,s=t.m5.circle?this.toCircle(t):this.toPolygon(t);return c.bodyWrap(s,e,i)},gposXY(t){const{x:e,y:i}=t.getGlobalPosition();return n.vec(e,i)},isTopLeft:t=>!t.anchor||a.feq0(t.anchor.x)&&a.feq0(t.anchor.y),isCenter:t=>!!t.anchor&&(a.feq(t.anchor.x,.5)&&a.feq(t.anchor.y,.5)),centerXY(t){return this.isCenter(t)?n.vec(t.x,t.y):n.add(this.centerOffsetXY(t),t)},setScaleModeNearest:(t,e=!0)=>(t.texture.source.scaleMode=e?"nearest":"linear",t),angle(t,e){return n.angle(this.centerXY(t),this.centerXY(e))},die:t=>(t.m5.dead=!0,t),undie:t=>(t.m5.dead=!1,t),move:(t,e)=>(e?(n.add$(t.m5.vel,n.mul(t.m5.gravity,e)),n.add$(t.m5.vel,n.mul(t.m5.acc,e)),n.mul$(t.m5.vel,t.m5.friction)):e=1,void 0!==t.m5.maxSpeed&&n.clamp$(t.m5.vel,0,t.m5.maxSpeed),n.add$(t,n.mul(t.m5.vel,e))),leftSide(t){let e=t.x,i=t.width,s=t.anchor?t.anchor.x:0;return s>.7?e-=i:s>0&&(e-=o.ndiv(i,2)),e},rightSide(t){return this.leftSide(t)+t.width},topSide(t){let e=t.y,i=t.height,s=t.anchor?t.anchor.y:0;return s>.7?e-=i:s>0&&(e-=o.ndiv(i,2)),e},bottomSide(t){return this.topSide(t)+t.height},getAABB(t){if(void 0!==t.x1&&void 0!==t.y2)return t;a.assert(t.m5,"bad sprite for getAABB");let{x1:e,y1:i,x2:s,y2:r}=t.m5.getImageOffsets(),n=this.leftSide(t),o=this.topSide(t);return{x1:n+e,y1:o+i,x2:n+t.width-s,y2:o+t.height-r}},bbox4:(t,e,i,s)=>a.assert(i<=s,"bad bbox")&&{x1:t,x2:e,y1:i,y2:s},bboxCenter(t){if(h.num(t.x1))return n.vec(o.ndiv(t.x1+t.x2,2),o.ndiv(t.y1+t.y2,2))},bboxFrame(t,e=16,i="#dedede"){a.assert(void 0!==t.x1,"bad bounding box");let s,{x1:r,x2:n,y1:o,y2:h}=t,l=n-r,c=h-o,d=this.graphics();return d.roundRect(0,0,l+e,c+e,u(e/4)),d.stroke({width:e,color:this.color(i)}),s=this.sprite(d),s.x=r-e,s.y=o-e,s},bboxSize:t=>void 0!==t.x1?n.vec(t.x2-t.x1,t.y2-t.y1):a.assert(!1,"bad bounding box"),pointInBBox:(t,e,i)=>void 0!==i.x1&&t>i.x1&&t<i.x2&&e>i.y1&&e<i.y2,boundingBox(t){a.feq0(t.rotation)||a.assert(this.isCenter(t),"expected rotated obj with center-anchor");let e,i,s=[],r=[],n=u(t.width/2),o=u(t.height/2),h=Math.tanh(o/n),l=Math.sqrt(n*n+o*o);return i=d-h+t.rotation,r.push(l*Math.sin(i)),s.push(l*Math.cos(i)),i=h+t.rotation,r.push(l*Math.sin(i)),s.push(l*Math.cos(i)),i=Math.PI-h+t.rotation,r.push(l*Math.sin(i)),s.push(l*Math.cos(i)),i=Math.PI+h+t.rotation,r.push(l*Math.sin(i)),s.push(l*Math.cos(i)),e=this.centerXY(t),r.sort(((t,e)=>t-e)),s.sort(((t,e)=>t-e)),{x1:u(s[0]+e[0]),x2:u(s[3]+e[0]),y1:u(r[0]+e[1]),y2:u(r[3]+e[1])}},hitTestPoint(t,e,i){const s=this.toBody(i);return i.m5.circle?c.hitTestPointCircle(t,e,s):c.hitTestPointPolygon(t,e,s)},distance(t,e){return n.dist(this.centerXY(t),this.centerXY(e))},scaleContent(...t){1==t.length&&h.vec(t[0])&&(t=t[0]);const e=r.getScaleFactor();t.forEach((t=>{t.scale.x*=e,t.scale.y*=e}))},scaleToCanvas:t=>(t.height=r.height,t.width=r.width,t),uuid:(t,e)=>(t.m5.uuid=e,t),opacity:(t,e)=>(t.alpha=e,t),tint(t,e){return t.tint=this.color(e),t},hide:t=>(t.visible=!1,t),show:t=>(t.visible=!0,t),pset:(t,e,i)=>(t.g[e]=i,t),pget:(t,e)=>t.g[e],container(t){const e=this.lift(new PIXI.Container);return t&&t(e),e},group(...t){const e=this.container();return t.forEach((t=>e.addChild(t))),e},sprite(t,e=!1,i=0,s=0){const n=this.lift(y(t,(t=>new PIXI.Sprite(t))));return n.x=i,n.y=s,e&&this.centerAnchor(n),a.inst(PIXI.AnimatedSprite,n)?function(t){let e=0,i={};function s(){e&&(e=clearInterval(e))}function n(){i.cnt<i.total?(t.gotoAndStop(t.currentFrame+1),i.cnt+=1):t.loop?(t.gotoAndStop(i.start),i.cnt=1):(s(),t.onComplete?.())}return a.inject(t.m5,{stopFrames(){s(),t.gotoAndStop(t.currentFrame)},showFrame(e){s(),t.gotoAndStop(e)},playFrames(o){s(),i.start=0,i.end=t.totalFrames-1,h.vec(o)&&o.length>1&&(i.start=o[0],i.end=o[1]),i.total=i.end-i.start+1,t.gotoAndStop(i.start),i.cnt=1,e=setInterval(n,1e3/r.aniFps)}}),t}(n):n},spriteFrame(t,e,i=!1,s=0,n=0){return this.sprite(r.sheet(t,e),i,s,n)},tilingSprite(t,e,i){return this.lift(y(t,(t=>new PIXI.TilingSprite({texture:t,width:e||t.width,height:i||t.height}))))},repeatSprite(t,e=!0,i=!0,s,o){let a,h=this,l=[],c=0,d=0,u=0,p=0;function g(){const e=h.lift(y(t,(t=>new PIXI.Sprite(t))));let i=r.getScaleFactor();return i=1,e.width*=1,e.height*=1,e}if(e){for(;u<s;)l.push(a=g()),n.set(a,c,d),u+=a.width,c+=a.width,u>=s&&p<o&&i&&(p+=a.height,d+=a.height,c=0,u=0);i=!1}if(i){for(;p<o;)l.push(a=g()),n.set(a,c,d),p+=a.height,d+=a.height,p>=o&&u<s&&e&&(u+=a.width,c+=a.width,d=0,p=0);e=!1}return l},animation(t,e,i,s=0){let o=r.resource(t);if(!o)throw`SpriteError: ${t} not loaded.`;let a=u(o.width/e),h=[],l=a*u(o.height/i);for(let t,r,o=0;o<l;++o)t=o%a*e,r=u(o/a)*i,s>0&&(t+=s+s*o%a,r+=s+s*u(o/a)),h.push(n.vec(t,r));return this.sprite(h.map((t=>new PIXI.Texture({source:o.source,frame:new PIXI.Rectangle(t[0],t[1],e,i)}))))},frame(t,e,i,s,n){return this.sprite(new PIXI.Texture({source:r.resource(t).source,frame:new PIXI.Rectangle(s,n,e,i)}))},frameSelect:(t,e,i,s)=>s.map((s=>new PIXI.Texture({source:r.resource(t).source,frame:new PIXI.Rectangle(s[0],s[1],e,i)}))),frames(t,e,i,s=0,n=0,a=0,h=0){let l=e+s,c=i+n,d=[],p=r.resource(t),g=u(p.height/c),m=o.ndiv(p.width+s,l);for(let t,s=0;s<g;++s){t=h+i*s;for(let s,r=0;r<m;++r)s=a+e*r,d.push(new PIXI.Texture({source:p.source,frame:new PIXI.Rectangle(s,t,e,i)}))}return d},frameImages:(...t)=>(1==t.length&&h.vec(t[0])&&(t=t[0]),t.map((t=>r.resource(t)))),spriteFrom(...t){return this.sprite(this.frameImages(t))},text(t,e,i=0,s=0){return n.set(this.lift(new PIXI.Text(t,e)),i,s)},bitmapText(t,e,i){let s;return t=t||"",h.str(e)?(s={fontFamily:e},h.num(i)&&(s.fontSize=i)):s=e,s.fontFamily||(s.fontFamily=s.fontName?s.fontName:"unscii"),s.align||(s.align="center"),this.lift(new PIXI.BitmapText({text:t,style:s}))},triangle(t,e,i,s=16777215,r=16777215,o=0,a=0,l=0){let c=this.graphics(),d=1,p=u(t/2),g=this.color(r),m=i<.5?0:i>.5?t:p;!1!==s&&h.vec(s)&&(d=s[1],s=s[0]),c.poly([0,0,m,-e,t,0]),!1!==s&&c.fill({color:this.color(s),alpha:d}),o>0&&c.stroke({width:o,color:g,alpha:1});let f=this.sprite(c);return f.m5.getContactPoints=e<0?()=>[[m,-e],[t,0],[0,0]]:()=>[[t,e],[m,0],[0,e]],n.set(f,a,l)},rect(t,e,i=16777215,s=16777215,r=0){return this.sprite(this.rectTexture(t,e,i,s,r))},grect:(t,e,i,s,r)=>(t.rect(e,i,s,r),t),gcircle:(t,e,i,s)=>(t.circle(e,i,s),t),gfillEx:(t,e,i)=>(i||(i={}),i.texture=e,t.texture(i),t),gclear:t=>t.clear(),gpath:(t,e)=>(a.assert(h.vec(e),"expected path actions!"),e.forEach((e=>{h.vec(e)?t[e.shift()].apply(t,e):h.str(e)&&t[e]()})),t),gfill:(t,e)=>(a.assert(h.obj(e),"expected fill style object"),t.fill(e),t),gstroke:(t,e)=>(a.assert(h.obj(e),"expected stroke style object"),t.stroke(e),t),rectTexture(t,e,i=16777215,s=16777215,r=0){let n,o=this.graphics();return!1!==i&&(h.vec(i)?(n=i[1],i=i[0]):n=1),o.rect(0,0,t,e),!1!==i&&o.fill({color:this.color(i),alpha:n}),r>0&&o.stroke({width:r,color:this.color(s)}),this.genTexture(o)},drawBody(t,...e){const i=this.graphics();return t.apply(this,[i].concat(e)),this.lift(new PIXI.Sprite(this.genTexture(i)))},circle(t,e=16777215,i=16777215,s=0){return this.circleEx(this.circleTexture(t,e,i,s))},circleTexture(t,e=16777215,i=16777215,s=0){let r,n=this.graphics();return!1!==e&&(h.vec(e)?(r=e[1],e=e[0]):r=1),n.circle(0,0,t),!1!==e&&n.fill({color:this.color(e),alpha:r}),s>0&&n.stroke({width:s,color:this.color(i)}),this.genTexture(n)},circleEx(t){const e=this.lift(new PIXI.Sprite(t));return(e.m5.circle=!0)&&this.centerAnchor(e)},line(t,e,i,s,r=1){let o,h=n.clone(i),l=n.clone(s),c=this.graphics(),d=this.color(t);function u(){c.clear(),c.moveTo(h[0],h[1]),c.lineTo(l[0],l[1]),c.stroke({width:e,color:d,alpha:r})}return u(),o=this.lift(c),o.m5.ptA=function(t,e){return void 0!==t&&(h[0]=t,h[1]=a.nor(e,t),u()),h},o.m5.ptB=function(t,e){return void 0!==t&&(l[0]=t,l[1]=a.nor(e,t),u()),l},o},isMoving:t=>!a.feq0(t.m5.vel[0])||!a.feq0(t.m5.vel[1]),makeCells(t,e,i,s,r,n){let a=o.ndiv(i-t,r);return x(t,e,o.ndiv(s-t,n),a,r,n)},gridBox(t=.9,e=.9,i){let s=i??r,n=u(s.height*e),a=u(s.width*t),h=o.ndiv(s.width-a,2),l=o.ndiv(s.height-n,2);return{x1:h,y1:l,x2:h+a,y2:l+n}},gridSQ(t,e=.9,i){let s=e*(r.height<r.width?r.height:r.width),n=u(s/t),h=n;a.isEven(n)||--n,h=n,s=t*n;let l=o.ndiv(r.height-s,2),c=o.ndiv(r.width-s,2),d=c,p=l;return i&&(i.height=s,i.width=s,void 0!==i.x&&(d=i.x),void 0!==i.y&&(p=i.y),i.x=c,i.y=l,i.x1=c,i.y1=l,i.x2=c+s,i.y2=l+s),x(d,p,t,t,n,h)},divXY([t,e],i=.9,s=.9,n){let a,h,l,c,d=u(r.height*s),p=u(r.width*i),g=u(p/t),m=u(d/e);return d=e*m,p=t*g,l=o.ndiv(r.height-d,2),c=o.ndiv(r.width-p,2),a=c,h=l,n&&(n.height=d,n.width=p,void 0!==n.x&&(a=n.x),void 0!==n.y&&(h=n.y),n.x=c,n.y=l,n.x1=c,n.y1=l,n.x2=c+p,n.y2=l+d),x(a,h,e,t,g,m)},gridXY([t,e],i=.9,s=.9,n){let h,l,c,d,p=u(r.height*s),g=u(r.width*i),m=u(g/t),f=u(p/e),y=m>f?f:m;return a.isEven(y)||--y,p=e*y,g=t*y,c=o.ndiv(r.height-p,2),d=o.ndiv(r.width-g,2),h=d,l=c,n&&(n.height=p,n.width=g,void 0!==n.x&&(h=n.x),void 0!==n.y&&(l=n.y),n.x=d,n.y=c,n.x1=d,n.y1=c,n.x2=d+g,n.y2=c+p),x(h,l,e,t,y,y)},gridBBox(t,e,i){let s=i[0].length,r=i[0][0],n=i[i.length-1][s-1];return{x1:t+r.x1,x2:t+n.x2,y1:e+r.y1,y2:e+n.y2}},graphics(t){const e=new PIXI.Graphics;return(e.m5={uuid:`${t||a.nextId()}`})&&e},drawGridBox(t,e=1,i="white",s){return s||(s=this.graphics()),s.rect(t.x1,t.y1,t.x2-t.x1,t.y2-t.y1),s.stroke({width:e,color:this.color(i)}),s},drawGridBoxEx(t,e=1,i="white",s=1,r){return r||(r=this.graphics()),r.roundRect(t.x1,t.y1,t.x2-t.x1,t.y2-t.y1,s),r.stroke({width:e,color:this.color(i)}),r},drawGridLines(t,e,i,s,r,n){let o=i.length,a=i[0].length;n||(n=this.graphics());for(let s,r=1;r<o;++r)s=i[r],n.moveTo(t+s[0].x1,e+s[0].y1),n.lineTo(t+s[a-1].x2,e+s[a-1].y1);for(let s,r=1;r<a;++r)s=i[0],n.moveTo(t+s[r].x1,e+s[r].y1),s=i[o-1],n.lineTo(t+s[r].x1,e+s[r].y2);return h.obj(r)?(r.color=this.color(r.color||"white"),r.width=s,n.stroke(r)):n.stroke({width:s,color:this.color(r)}),n},add:(t,...e)=>(e.forEach((e=>e&&t.addChild(e))),t),remove:(...t)=>(1==t.length&&h.vec(t[0])&&(t=t[0]),a.doseqEx(t,(t=>{t.parent&&(a.inst(r.Scenes.Scene,t.parent)?t.parent.remove(t):t.parent.removeChild(t)),r.emit(["post.remove",t]),r.off(t),t.m5.dispose?.()})),t[0]),centerObj(t){let e=t.anchor,i=r.width/2,s=r.height/2,n=t.width/2,o=t.height/2;return t.x=i,t.y=s,e||(e={x:0,y:0}),e.x<.3&&(t.x=i-n),e.x>.7&&(t.x=i+n),e.y<.3&&(t.y=s-o),e.y>.7&&(t.y=s+o),t},fillMax(t){return(h.str(t)||a.inst(PIXI.Texture,t))&&(t=this.sprite(t)),a.assert(a.inst(PIXI.Container,t),"expected sprite"),t.height=r.height,t.width=r.width,this.centerObj(t)},colorToRgbA(t){a.assert(h.str(t)&&t.length>0,"bad color string value");let e,i=t.toLowerCase(),r=s[i];if("transparent"==i)return[0,0,0,0];if(r&&(t=r),"#"==t[0]){if((e=t.split("")).shift(),3==e.length&&e.push("F"),4==e.length&&(e=e.flatMap((t=>[t,t]))),6==e.length&&e.push("F","F"),8==e.length)return[parseInt(e[0]+e[1],16),parseInt(e[2]+e[3],16),parseInt(e[4]+e[5],16),parseInt(e[6]+e[7],16)/255]}else if(0==i.indexOf("rgb"))return i.indexOf("rgba")<0&&(i+=",1"),i.match(/[\.\d]+/g).map((t=>+t));throw`Error: Bad color string: ${t}`},byteToHex:t=>("0"+t.toString(16)).slice(-2),colorToHex(t){const e=this.colorToRgbA(t);return"0x"+[0,1,2].map((t=>this.byteToHex(e[t]))).join("")},color3(t,e,i){return parseInt(["0x",this.byteToHex(t),this.byteToHex(e),this.byteToHex(i)].join(""))},color(t){return isNaN(t)?parseInt(this.colorToHex(t)):t},rgba(t){return a.assert(h.vec(t),"wanted rgba array"),parseInt("0x"+[0,1,2].map((e=>this.byteToHex(t[e]))).join(""))},hsla(t,e,i,s){function r(t){return Math.min(1,Math.max(0,t))}function n(t){return 6*(t=t<0?t+1:t>1?t-1:t)<1?a+(o-a)*t*6:2*t<1?o:3*t<2?a+(o-a)*(2/3-t)*6:a}t=t%360/360,e=r(e),i=r(i),s=r(s);let o=i<=.5?i*(e+1):i+e-i*e,a=2*i-o;return this.rgba([255*n(t+1/3),255*n(t),255*n(t-1/3),s])},resize(t,e,i,s,r){t&&a.doseqEx(t.children,(e=>e.m5&&e.m5.resize?.(t.x,t.y,t.width,t.height)))},pinAbove(t,e,i=10,s=.5){let[r,o,a,h,l]=v(this,t),[c,d,u,p,g]=v(this,e,t),m=r.y1-i-(c.y2-c.y1),f=s<.3?r.x1:s<.7?h-d:r.x2-(c.x2-c.x1);e.y=!e.anchor||e.anchor.y<.3?m:e.anchor.y<.7?m+u:m+(c.y2-c.y1),e.x=!e.anchor||e.anchor.x<.3?f:e.anchor.x<.7?f+d:f+(c.x2-c.x1),e.parent===t&&n.sub$(e,t)},pinBelow(t,e,i=10,s=.5){let[r,o,a,h,l]=v(this,t),[c,d,u,p,g]=v(this,e,t),m=r.y2+i,f=s<.3?r.x1:s<.7?h-d:r.x2-(c.x2-c.x1);e.y=!e.anchor||e.anchor.y<.3?m:e.anchor.y<.7?m+u:m+(c.y2-c.y1),e.x=!e.anchor||e.anchor.x<.3?f:e.anchor.x<.7?f+d:f+(c.x2-c.x1),e.parent===t&&n.sub$(e,t)},pinCenter(t,e){let[i,s,r,o,a]=v(this,t),[h,l,c,d,u]=v(this,e,t),p=o-l,g=a-c;e.y=!e.anchor||e.anchor.y<.3?g:e.anchor.y<.7?g+c:g+(h.y2-h.y1),e.x=!e.anchor||e.anchor.x<.3?p:e.anchor.x<.7?p+l:p+(h.x2-h.x1),(t.m5.stage||e.parent===t)&&n.sub$(e,t)},pinLeft(t,e,i=10,s=.5){let[r,o,a,h,l]=v(this,t),[c,d,u,p,g]=v(this,e,t),m=r.x1-i-(c.x2-c.x1),f=s<.3?r.y1:s<.7?l-u:r.y2-(c.y2-c.y1);e.y=!e.anchor||e.anchor.y<.3?f:e.anchor.y<.7?f+u:f+(c.y2-c.y1),e.x=!e.anchor||e.anchor.x<.3?m:e.anchor.x<.7?m+d:m+(c.x2-c.x1),e.parent===t&&n.sub$(e,t)},pinRight(t,e,i=10,s=.5){let[r,o,a,h,l]=v(this,t),[c,d,u,p,g]=v(this,e,t),m=r.x2+i,f=s<.3?r.y1:s<.7?l-u:r.y2-(c.y2-c.y1);e.y=!e.anchor||e.anchor.y<.3?f:e.anchor.y<.7?f+u:f+(c.y2-c.y1),e.x=!e.anchor||e.anchor.x<.3?m:e.anchor.x<.7?m+d:m+(c.x2-c.x1),e.parent===t&&n.sub$(e,t)},setMass(t,e){t.m5.mass=e},genTexture:(t,e,i,s)=>p(t),bounceOff:t=>w(t.A,t.B,t),hit(t,e){const i=b(this,t,e);return i&&(r.emit(["hit",t],i),r.emit(["hit",e],i.swap())),i},collide(t,e,i=!0){const s=function(t,e,i,s=!0){let r,o=b(t,e,i);return o&&(i.m5.static?n.sub$(e,o.overlapV):(r=n.div(o.overlapV,2),n.sub$(e,r),n.add$(i,r)),s&&w(e,i,o)),o}(this,t,e,i);return s&&function(t){const e=new Set;return t.overlapN[1]<-.3&&e.add(r.TOP),t.overlapN[1]>.3&&e.add(r.BOTTOM),t.overlapN[0]<-.3&&e.add(r.LEFT),t.overlapN[0]>.3&&e.add(r.RIGHT),e.add(t),e}(s)},hitTest(t,e){return b(this,t,e)},clamp(t,i,s=!1,n){let o,l,c,d,u,p;h.vec(i)&&(c=i[1].left,d=i[1].right,u=i[1].top,p=i[1].bottom,i=i[0]),d=!1!==d,c=!1!==c,u=!1!==u,p=!1!==p,i instanceof r.Scenes.Scene?l=r.mockStage():i.m5&&i.m5.stage?l=i:void 0!==i.x2&&void 0!==i.y2?(l=i,o=!0):(i.isSprite?a.assert(t.parent===i):a.assert(!1,"Error: clamp() using bad container"),a.assert(a.feq0(i.rotation),"Error: clamp() container can't rotate"),a.assert(a.feq0(i.anchor.x),"Error: clamp() container anchor.x !==0"),a.assert(a.feq0(i.anchor.y),"Error: clamp() container anchor.y !==0"),l=i);let g=o?[0,0]:this.topLeftOffsetXY(l),m=new Set,f=!1,y=!1,x=this.getAABB(t),v=o?l.x1:l.x+g[0],w=v+(o?l.x2-l.x1:l.width),b=o?l.y1:l.y+g[1],I=b+(o?l.y2-l.y1:l.height);return c&&x.x1<v&&(t.x+=v-x.x1,f=!0,m.add(r.LEFT)),d&&x.x2>w&&(t.x-=x.x2-w,f=!0,m.add(r.RIGHT)),u&&x.y1<b&&(t.y+=b-x.y1,y=!0,m.add(r.TOP)),p&&x.y2>I&&(t.y-=x.y2-I,y=!0,m.add(r.BOTTOM)),m.size>0?(f&&(t.m5.vel[0]/=t.m5.mass,s&&(t.m5.vel[0]*=-1)),y&&(t.m5.vel[1]/=t.m5.mass,s&&(t.m5.vel[1]*=-1)),n&&n(m)):m=e,m},dbgShowDir(t){let e="?";switch(t){case r.NE:e="top-right";break;case r.NW:e="top-left";break;case r.TOP:case r.UP:e="top";break;case r.LEFT:e="left";break;case r.RIGHT:e="right";break;case r.BOTTOM:case r.DOWN:e="bottom";break;case r.SE:e="bottom-right";break;case r.SW:e="bottom-left"}return e},dbgShowCol(t){const e=[];if(h.set(t))for(let i of t.values())e.push(this.dbgShowDir(i));return e.join(",")}};return I.bmpText=I.bitmapText,a.doseq(s,((t,e)=>{I.SomeColors[e]=I.color(t)})),a.doseq(i,((t,e)=>{I.BtnColors[e]=I.color(t)})),r.Sprites=I}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Sprites"]=function(t){return t.Sprites?t.Sprites:r(t)}}(this),function(t,e){"use strict";function i(e,i){const s=t["io/czlab/mcfud/spatial"](),{v2:r,math:n,ute:o,is:a}=e,h=Math.floor,l=t=>t.startsWith("scene::")?t:`scene::${t}`;function c(t){t&&(t.dispose?.(),t.parent.removeChild(t))}class d extends PIXI.Container{constructor(t){super(),this.addChild(t),this.label=t.label,this.m5={stage:!0}}dispose(){c(this.children[0])}update(t){this.children[0].update(t)}}class u extends PIXI.Container{constructor(t,e,i){super(),this.label=l(t),this.g={},this.m5={index:{},queue:[],garbo:[],sid:t,options:i,stage:!0,sgrid:s.spatialGrid(i.sgridX||320,i.sgridY||320)},a.fun(e)?this.setup=e:a.obj(e)&&o.inject(this,e)}#i(t,i,s){let r,n,o,a=!1;for(o=0;!a&&o<s.length;++o)n=s[o],i!==n&&!n.m5.dead&&i.m5.cmask&n.m5.type&&(r=e.Sprites.hitTest(i,n),r&&(e.emit(["hit",i],r),r.B.m5.static||e.emit(["hit",r.B],r.swap()),t.engrid(i),a=!0));return a}collideXY(t){return this.#i(this.m5.sgrid,t,this.m5.sgrid.search(t))}onCanvasResize(t,i){return e.Sprites.resize({x:0,y:0,width:t,height:i,children:this.children}),this}future(t,i){return this.m5.queue.push([t,n.ndiv(e._curFPS*i,1e3)||1]),this}futureX(t,e){return this.m5.queue.push([t,e||1]),this}getChildById(t){return t&&this.m5.index[t]}remove(t){return a.str(t)&&(t=this.getChildById(t)),t&&(this.removeChild(t),e.off(t),t.m5._engrid&&this.m5.sgrid.degrid(t),e.Input.undoXXX(t),o.dissoc(this.m5.index,t.m5.uuid)),this}degrid(t){return t&&t.m5._engrid&&this.m5.sgrid.degrid(t),t}engrid(t){return t&&t.m5._engrid&&this.m5.sgrid.engrid(t),t}insertEx(t,e=!1){let i;return o.assert(a.vec(t),"wanted array of child sprites to be inserted!"),t.forEach((t=>{this.insertAt(t,null,e),i=t})),i}insert(t,e=!1){return this.insertAt(t,null,e)}insertAt(t,e,i=!1){return t=this.#s(t,e),i&&(t instanceof PIXI.TilingSprite||(t.m5._engrid=!0,this.m5.sgrid.engrid(t))),t}#s(t,e){return a.num(e)&&e>=0&&e<this.children.length?this.addChildAt(t,e):this.addChild(t),this.m5.index[t.m5.uuid]=t}preDispose(){return this}dispose(){return this.preDispose(),this.m5.dead=!0,e.off(this),function t(i){i&&(e.Input.undoXXX(i),i.children.forEach((e=>t(e))))}(this),this.removeChildren(),e.modalScene===this&&(e.modalScene=undefined,e.Input.restore(),e.CON.log("removed the current modal scene")),this}#r(t,i){t.forEach((t=>{t.visible&&t.m5&&t.m5.tick&&(t.m5.tick(i),"x"==t.m5.flip&&(t.scale.x*=-1),"y"==t.m5.flip&&(t.scale.y*=-1),t.m5.flip=!1,e.emit(["post.tick",t],i),t.m5._engrid&&this.m5.sgrid.engrid(t)),t.children.length>0&&this.#r(t.children,i)}))}searchSGrid(t,e=!1){return this.m5.sgrid.search(t,e)}queueForRemoval(t){return this.m5.garbo.push(t)&&t}update(t){return this.m5.dead||(this.m5.queue.filter((t=>(t[1]-=1,t[1]<=0))).reverse().forEach((t=>{o.disj(this.m5.queue,t),t[0]()})),this.preUpdate?.(t),this.#r(this.children,t),this.postUpdate?.(t),this.m5.garbo.forEach((t=>this.remove(t))),this.m5.garbo.length=0),this}runOnce(){return this.setup?.(this.m5.options),this}}function p(t,i,s){let{Sprites:r}=e,l=e.getScaleFactor();if(0==t.length)return;let c,d,u=(i=o.patch(i,{bg:0,padding:10,fit:20,borderWidth:4,border:r.SomeColors.white})).borderWidth*l,p=i.group||r.container(),g=i.padding*l,m=0,f=-1,y=i.fit*l,x=2*y,v=t=>{m+=t.height,t.width>f&&(f=t.width)},w=t=>{m+=t.width,t.height>f&&(f=t.height)};t.forEach((t=>{o.assert(o.feq0(t.anchor.x)&&o.feq0(t.anchor.y),"wanted topleft anchor"),(s==e.DOWN?v:w)(t),i.skipAdd||p.addChild(t)})),f+=x,m+=g*(t.length-1)+x,s==e.DOWN?(c=f,d=m):(d=f,c=m);{let t=r.rect(c,d,i.bg,i.border,u);p.addChildAt(t,0),a.vec(i.bg)||(t.alpha=0==i.opacity?0:i.opacity||.5,"transparent"==i.bg&&(t.alpha=0))}let b,[I,T]=[h(c/2),h(d/2)],S=s==e.DOWN?"pinBelow":"pinRight";return t.forEach(((t,i)=>{s==e.DOWN?0==i&&(t.x=I-t.width/2,t.y=y):0==i&&(t.y=T-t.height/2,t.x=y),b&&e.Sprites[S](b,t,g),b=t})),p.x=o.nor(i.x,n.ndiv(e.width-c,2)),p.y=o.nor(i.y,n.ndiv(e.height-d,2)),p}function g(t,i,s){let r,n,{Sprites:a,Input:h}=e,l=a.color(o.nor(i.selectedColor,"green")),c=a.color(o.nor(i.disabledColor,"grey"));return t.forEach((t=>{t.m5.uuid==i.defaultChoice?(n=t,t.tint=l):t.tint=c,t.m5.button&&(t.m5.press=t=>{t!==n&&(n.tint=c,t.tint=l,n=t,i.onClick?.(t))})})),n||(n=t[0],n.tint=l),r=p(t,i,s),r.getSelectedChoice=()=>n.m5.uuid,r}const m={Scene:u,SceneWrapper:d,layoutX:(t,i)=>p(t,i,e.RIGHT),layoutY:(t,i)=>p(t,i,e.DOWN),choiceMenuX:(t,i)=>g(t,i,e.RIGHT),choiceMenuY:(t,i)=>g(t,i,e.DOWN),scene(t,e,s){a.fun(e)&&(e={setup:e}),i[t]=[e,s]},replace(t,i,s){const r=l(a.str(t)?t:t.label),n=e.stage.getChildByName(r);if(!n)throw`Fatal: no such scene: ${r}`;return this.run(i,e.stage.getChildIndex(n),s)},remove(...t){1==t.length&&a.vec(t[0])&&(t=t[0]),t.forEach((t=>c(a.str(t)?e.stage.getChildByName(l(t)):t)))},removeAll(){for(;e.stage.children.length>0;)c(e.stage.children[e.stage.children.length-1]);e.mouse.reset(),e.Input.reset()},find:t=>e.stage.getChildByName(l(t)),runEx(t,e,i){return this.removeAll(),this.run(t,e,i)},runSeq(...t){t.forEach((t=>{o.assert(a.vec(t),"Expecting array"),this.run(t[0],t[1],t[2])}))},modal(t,i){return o.assert(!e.modalScene,"Another modal is already running!"),e.Input.save(),e.modalScene=this.run(t,null,i)},run(t,s,r){let n,h,l,p=i[t];if(e.modalScene)throw"Fatal: modal scene is running";if(!p)throw`Fatal: unknown scene: ${t}`;if(a.obj(s)&&(r=s,s=o.dissoc(r,"slot")),r=o.inject({},p[1],r),l=o.inject({},p[0]),o.nichts(s)&&(s=r.slot||-1),r.tiled?(o.assert(r.tiled.name,"no tmx file!"),h=new e.Tiles.TiledScene(t,l,r)):h=new u(t,l,r),n=h,r.centerStage&&(n=new d(h)),s>=0&&s<e.stage.children.length){let t=e.stage.getChildAt(s);e.stage.addChildAt(n,s),c(t)}else e.stage.addChild(n);return h.runOnce(),h},topMost(){let t=o.last(e.stage.children);return t instanceof d&&(t=t.children[0]),o.assert(t instanceof u,"top is not a scene!"),t}};return e.Scenes=m}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Scenes"]=function(t){return t.Scenes?t.Scenes:i(t,{})}}(this),function(t,e){"use strict";function i(t,i,s){const{v2:r,math:n,ute:o,is:a,Sprites:h}=t,l=Math.floor,c=5*Math.PI,d=Math.PI/2,u=2*Math.PI;function p(e,s,r=60,n=!1,h={}){return o.inject({duration:r,sprite:e,easing:s,loop:n,cur:0,on:0,dead:0,onFrame(t,e){},_run(){this.cur=0,this.on=1,this.dead=0,i.push(this)},onTick(){this.on&&(this.cur<this.duration?(this.onFrame(!1,this.easing(this.cur/this.duration)),this.cur+=1):(this.onFrame(!0),this.loop?(a.num(this.loop)&&--this.loop,this.onLoopReset(),this.cur=0):(this.on=0,this.dispose(),this.onComplete&&o.delay(0,(()=>this.onComplete())))))},dispose(){this.dead=1,t.emit(["tween.disposed"],this)}},h)}function g(t,i,s,r){return p(t,i,s,r,{start(t,i,s,r){this._x=a.num(i)?[t,i]:e,this._y=a.num(r)?[s,r]:e,this._run()},onLoopReset(){this._x&&o.swap(this._x,0,1),this._y&&o.swap(this._y,0,1)},onFrame(t,e){this._x&&(this.sprite.x=t?this._x[1]:n.lerp(this._x[0],this._x[1],e)),this._y&&(this.sprite.y=t?this._y[1]:n.lerp(this._y[0],this._y[1],e))}})}function m(...e){const i=e.slice(0),s={onTweenEnd(t){for(let e,s=0;s<i.length;++s)if(e=i[s],e===t){i.splice(s,1);break}0==i.length&&(this.dispose(),this.onComplete&&o.delay(0,(()=>this.onComplete())))},dispose(){t.off(["tween.disposed"],"onTweenEnd",s),i.length=0}};return t.on(["tween.disposed"],"onTweenEnd",s),s}const f={EXPO_IN:t=>0==t?0:Math.pow(1024,t-1),EXPO_OUT:t=>1==t?1:1-Math.pow(2,-10*t),EXPO_INOUT:t=>0==t?0:1==t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1))),LINEAR:t=>t,SMOOTH:t=>3*t*t-2*t*t*t,SMOOTH_QUAD(t){let e=f.SMOOTH(t);return e*e},SMOOTH_CUBIC(t){let e=f.SMOOTH(t);return e*e*e},EASE_IN_CUBIC:t=>t*t*t,EASE_OUT_CUBIC(t){let e=1-t;return 1-e*e*e},EASE_INOUT_CUBIC(t){if(t<.5)return 4*t*t*t;{let e=-2*t+2;return 1-e*e*e/2}},EASE_IN_QUAD:t=>t*t,EASE_OUT_QUAD:t=>1-(1-t)*(1-t),EASE_INOUT_QUAD(t){if(t<.5)return 2*t*t;{let e=-2*t+2;return 1-e*e/2}},EASE_IN_SINE:t=>1-Math.cos(t*d),EASE_OUT_SINE:t=>Math.sin(t*d),EASE_INOUT_SINE:t=>.5-Math.cos(t*Math.PI)/2,SPLINE(t,e,i,s,r){let n=t*t,o=n*t;return.5*(e*(2*n-o-t)+i*(3*o-5*n+2)+s*(-3*o+4*n+t)+r*(o-n))},CUBIC_BEZIER(t,e,i,s,r){let n=t*t,o=1-t,a=o*o;return a*o*e+3*a*t*i+3*o*n*s+n*t*r},ELASTIC_IN:t=>0==t?0:1==t?1:-Math.pow(2,10*(t-1))*Math.sin((t-1.1)*c),ELASTIC_OUT:t=>0==t?0:1==t?1:1+Math.pow(2,-10*t)*Math.sin((t-.1)*c),ELASTIC_INOUT(t){switch(t){case 0:return 0;case 1:return 1;default:return(t*=2)<1?-.5*Math.pow(2,10*(t-1))*Math.sin((t-1.1)*c):1+.5*Math.pow(2,-10*(t-1))*Math.sin((t-1.1)*c)}},BOUNCE_IN:t=>1-f.BOUNCE_OUT(1-t),BOUNCE_OUT:t=>t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375,BOUNCE_INOUT:t=>t<.5?.5*f.BOUNCE_IN(2*t):.5*f.BOUNCE_OUT(2*t-1)+.5,tweenAlpha(t,e,i,s=60,r=!1){const h=function(t,e,i,s){return p(t,e,i,s,{start(t,e){this._a=[t,e],this._run()},onLoopReset(){o.swap(this._a,0,1)},onFrame(t,e){this.sprite.alpha=t?this._a[1]:n.lerp(this._a[0],this._a[1],e)}})}(t,e,s,r);let l=t.alpha,c=i;return a.vec(i)&&(l=i[0],c=i[1]),h.start(l,c),h},tweenAngle(t,e,i,s=60,r=!1){const h=function(t,e,i,s){return p(t,e,i,s,{start(t,e){this._a=[t,e],this._run()},onLoopReset(){o.swap(this._a,0,1)},onFrame(t,e){this.sprite.rotation=t?this._a[1]:n.lerp(this._a[0],this._a[1],e)}})}(t,e,s,r);let l=t.rotation,c=i;return a.vec(i)&&(l=i[0],c=i[1]),h.start(l,c),h},tweenScale(t,i,s,r,h=60,l=!1){const c=function(t,i,s,r){return p(t,i,s,r,{start(t,i,s,r){this._x=a.num(i)?[t,i]:e,this._y=a.num(r)?[s,r]:e,this._run()},onLoopReset(){this._x&&o.swap(this._x,0,1),this._y&&o.swap(this._y,0,1)},onFrame(t,e){this._x&&(this.sprite.scale.x=t?this._x[1]:n.lerp(this._x[0],this._x[1],e)),this._y&&(this.sprite.scale.y=t?this._y[1]:n.lerp(this._y[0],this._y[1],e))}})}(t,i,h,l);let d=t.scale.x,u=t.scale.y,g=s,m=r;return a.vec(s)&&(d=s[0],g=s[1]),a.vec(r)&&(u=r[0],m=r[1]),a.num(g)||(d=g=e),a.num(m)||(u=m=e),c.start(d,g,u,m),c},tweenXY(t,i,s,r,n=60,o=!1){const h=g(t,i,n,o);let l=t.x,c=t.y,d=s,u=r;return a.vec(s)&&(l=s[0],d=s[1]),a.vec(r)&&(c=r[0],u=r[1]),a.num(d)||(l=d=e),a.num(u)||(c=u=e),h.start(l,d,c,u),h},fadeOut(t,e=60){return this.tweenAlpha(t,this.EASE_OUT_SINE,0,e)},fadeIn(t,e=60){return this.tweenAlpha(t,this.EASE_OUT_SINE,1,e)},pulse(t,e=0,i=60,s=!0){return this.tweenAlpha(t,this.SMOOTH,e,i,s)},slide(t,e,i,s,r=60){return this.tweenXY(t,e,i,s,r)},throb(t,e=.9,i=.9,s=60,r=!0){return this.tweenScale(t,this.SMOOTH_QUAD,e,i,s,r)},scale(t,e=.5,i=.5,s=60){return this.tweenScale(t,this.SMOOTH,e,i,s)},strobe(t,e=1.3,i=10,s=20,r=10,n=!0){return this.tweenScale(t,(t=>this.SPLINE(t,i,0,1,s)),e,e,r,n)},jiggle(t,i,s=1.4,r=1.2,n=10,a=!0){let{x1:h,x2:l,y1:c,y2:d}=i;return m(this.tweenScale(t,(t=>this.SPLINE(t,o.or(h,10),0,1,o.or(l,10))),s,e,n,a),this.tweenScale(t,(t=>this.SPLINE(t,o.or(c,-10),0,1,o.or(d,-10))),e,r,n,a))},bezier(t,e,i,s,n=60){let o=g(t,this.SMOOTH,n);return o.start=function(){this._run()},o.onFrame=function(n,o){n||r.set(t,f.CUBIC_BEZIER(o,t.x,e[0],i[0],s[0]),f.CUBIC_BEZIER(o,t.y,e[1],i[1],s[1]))},o.start(),o},remove(t){t?.dispose()},update(t){o.rseq(i,(e=>e.onTick(t))),o.rseq(s,(e=>e.onTick(t)));for(let t=i.length-1;t>=0;--t)i[t].dead&&i.splice(t,1);for(let t=s.length-1;t>=0;--t)s[t].m5.dead&&(h.remove(s[t])&&s.splice(t,1))},particles(t,e,i,n,a=24,l={},c={},d=[0,.3],u=!0){function p(a){let u,p=n(),g=o.randInt2(l.size,c.size);s.push(p),t.addChild(p),p.totalFrames&&p.gotoAndStop(o.randInt2(0,p.totalFrames-1)),h.sizeXY(h.centerAnchor(p),g,g),r.set(p,e,i),p.g.scaleSpeed=o.randFloat2(l.scale,c.scale),p.g.alphaSpeed=o.randFloat2(l.alpha,c.alpha),p.g.angVel=o.randFloat2(l.rotate,c.rotate),u=o.randFloat2(l.speed,c.speed),r.set(p.m5.vel,u*Math.cos(a),u*Math.sin(a)),p.onTick=function(){this.m5.dead||(r.add$(this.m5.vel,d),r.add$(this,this.m5.vel),this.scale.x-this.g.scaleSpeed>0&&(this.scale.x-=this.g.scaleSpeed),this.scale.y-this.g.scaleSpeed>0&&(this.scale.y-=this.g.scaleSpeed),this.rotation+=this.m5.angVel,this.alpha-=this.g.alphaSpeed,this.alpha<=0&&(this.m5.dead=!0))}}l=o.patch(l,{angle:0,size:4,speed:.3,scale:.01,alpha:.02,rotate:.01});for(let t=((c=o.patch(c,{angle:6.28,size:16,speed:3,scale:.05,alpha:.02,rotate:.03})).angle-l.angle)/(a-1),e=l.angle,i=0;i<a;++i)p(u?o.randFloat2(l.angle,c.angle):e),e+=t},shake(t,e=16,i=!1,r=!0){let n={},a=1,h=t.x,c=t.y,d=1,u=t.rotation,p=e,g=l(e/8);return n.onTick=()=>i?void(a<8?(t.rotation=u,e-=g,t.rotation=e*d,++a,d*=-1):r?(e=p,a=1):o.disj(s,n)):void(a<8?(t.x=h,t.y=c,e-=g,t.x+=o.randInt2(-e,e),t.y+=o.randInt2(-e,e),++a):r?(e=p,a=1):o.disj(s,n)),s.push(n)&&t},StarWarp:function(e,i){i=i||{};let s=2e3,r=0,n=0,a=0,l=o.now(),c=i.color??"yellow",p=i.items??1e3,g=t.resource("boot/star.png");const m=o.fill(p,(t=>((t=h.sprite(g)).g.d3=[0,0,0],o.rand()<.3&&(t.tint=h.color(c)),h.anchorXY(t,.5,.69),e.addChild(t),f(t,o.rand()*s))));function f(t,e){let i=o.rand()*u,n=50*o.rand()+1;return t.g.d3[0]=Math.cos(i)*n,t.g.d3[1]=Math.sin(i)*n,t.g.d3[2]=isNaN(e)?r+s*(1+.5*o.rand()):e,t}return{dispose(){m.forEach((t=>h.remove(t)))},update(e){let i,c,u=t.width/2,p=t.height/2;n+=(a-n)/20,r+=10*e*(n+.025),m.forEach(((e,i)=>{e.g.d3[2]<r&&f(e),i=20*t.width/c,c=e.g.d3[2]-r,e.x=e.g.d3[0]*i+u,e.y=e.g.d3[1]*i+p;let o=e.x-u,a=e.y-p,l=Math.sqrt(o*o+a*a),g=Math.max(0,1-c/s);e.rotation=Math.atan2(a,o)+d,h.scaleXY(e,.05*g,g*(.05+6*n*l/t.width))})),i=o.now(),i-l>5e3&&(l=i,a=a>0?0:1)}}},SeqTweens:function(...t){let e=[];t.forEach((t=>{e.push(t),o.disj(i,t)}));const s={onDone(){this.dispose(),this.onComplete&&o.delay(0,(()=>this.onComplete()))},dispose(){e.length=0}};return function t(r){r?(i.push(r),r.onComplete=()=>t(e.shift())):s.onDone()}(e.shift()),s},BatchTweens:m};return t.FX=f}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/FX"]=function(t){return t.FX?t.FX:i(t,[],[])}}(this),function(t,e){"use strict";function i(t){const{Scenes:i,Sprites:s,FX:r,Input:n,v2:o,math:a,is:h,ute:l}=t,c=Math.abs,d=Math.cos,u=Math.sin,p=Math.floor,{Geo:g}=s,m=Math.PI/180;Math.PI;i.scene("Splash",{setup(e){let a,h,c=t.getScaleFactor(),{title:d,titleFont:u,titleColor:p,titleSize:g}=e,{footerMsgSize:m,action:f,clickSnd:y}=e,{bg:x,playMsg:v,playMsgFont:w,playMsgColor:b,playMsgSize:I,playMsgColor2:T}=e;w=w||t.DOKI_LOWER,u=u||t.BIGSHOUTBOB,m=m||18*c,v=v||t.clickPlayMsg(),b=b??s.color("white"),T=T??s.color("#ffc901"),p=p??s.color("#ffc901"),g=g??96*c,I=I??64*c,this.insert(s.fillMax(x||"boot/splash.jpg")),a=this.insert(s.container()),h=s.bmpText(d,u,g),l.echt(p)&&s.tint(h,p),o.set(h,t.width/2,.3*t.height),a.addChild(s.centerAnchor(h));{h=s.bmpText(v,w,I);let e,l=r.throb(h,.747,.747);const c=()=>{s.tint(h,T),r.remove(l),e=r.tweenAlpha(a,r.EASE_OUT_SINE,0,90),e.onComplete=()=>i.runEx(f.name,f.cfg)};let d=s.oneOffClick(c,y);o.set(h,t.width/2,.65*t.height),a.addChild(s.centerAnchor(h)),t.touchDevice||(this.g.space=n.keybd(n.SPACE,(()=>{s.cancelOneOffClick(d),c(),t.sound(y).play()})))}{const e=s.bmpText("Powered by MojoH5 2d game engine.",t.UNSCII,m),i=s.bmpText(t.COPYRIGHT,t.UNSCII,m);s.pinBelow(this,i,1.5*-i.height,0),s.pinBelow(this,e,1.5*-e.height,1),this.insert(i),this.insert(e)}},preDispose(){this.g.space?.dispose()}}),i.scene("EndGame",{setup(e){let{winner:r,snd:o}=e,{fontName:a,fontSize:h,msg:c,replay:d,quit:u}=e;o||(o=r?"game_win.mp3":"game_over.mp3"),l.assert(h,"expected fontSize"),a=a||t.DOKI_LOWER;let p={fontName:a,fontSize:h},g=()=>s.opacity(s.bmpText("#",p),0),m=s.bmpText("Game Over",p),f=s.bmpText(c,p),y=n.mkBtn(s.bmpText("Play Again?",p)),x=s.bmpText(" or ",p),v=n.mkBtn(s.bmpText("Quit",p));y.m5.press=()=>i.runEx(d.name,d.cfg),v.m5.press=()=>i.runEx(u.name,u.cfg),t.sound(o).play(),this.insert(i.layoutY([m,f,g(),g(),g(),y,x,v],e))}}),i.scene("PhotoMat",{setup(i){let r=i.image?t.resource(i.image):e;this.g.gfx=s.graphics(),s.grect(this.g.gfx,0,0,t.width,i.y1),s.grect(this.g.gfx,0,i.y2,t.width,t.height-i.y2),s.grect(this.g.gfx,0,0,i.x1,t.height),s.grect(this.g.gfx,i.x2,0,t.width-i.x2,t.height),r?s.gfillEx(this.g.gfx,r,{}):s.gfill(this.g.gfx,{color:s.color(i.color)}),this.insert(this.g.gfx)}}),i.scene("HotKeys",{setup(e){let i,r,o=e.buttons?"makeButton":"makeHotspot",{fontName:a,fontSize:c,cb:d,radius:u,alpha:p,color:g}=e,{char_fire:m,char_down:f,char_up:y,char_left:x,char_right:v}=e;l.assert(h.num(c),"expected fontsize"),l.assert(h.num(u),"expected radius"),l.assert(h.fun(d),"expected callback"),a=a||t.DOKI_LOWER,p=p??.2,g=g??"grey",i=[["left",x||"<"],["right",v||">"],["up",y||"+"],["down",f||"-"],["fire",m||"^"]].reduce(((t,i,r)=>(("fire"!=i[0]||e.fire)&&(t[i[0]]=s.opacity(s.circle(u,g),p),t[i[0]].addChild(s.centerAnchor(s.bmpText(i[1],a,c)))),t)),{}),r=d(i),r.right&&(this.insert(n[o](r.right)),r.right.m5.hotspot&&(r.right.m5.touch=(t,e)=>e?n.setKeyOn(n.RIGHT):n.setKeyOff(n.RIGHT))),r.left&&(this.insert(n[o](r.left)),r.left.m5.hotspot&&(r.left.m5.touch=(t,e)=>e?n.setKeyOn(n.LEFT):n.setKeyOff(n.LEFT))),r.up&&(this.insert(n[o](r.up)),r.up.m5.hotspot&&(r.up.m5.touch=(t,e)=>e?n.setKeyOn(n.UP):n.setKeyOff(n.UP))),r.down&&(this.insert(n[o](r.down)),r.down.m5.hotspot&&(r.down.m5.touch=(t,e)=>e?n.setKeyOn(n.DOWN):n.setKeyOff(n.DOWN))),r.fire&&(this.insert(n[o](r.fire)),r.fire.m5.hotspot&&(r.fire.m5.touch=(t,e)=>e?n.setKeyOn(n.SPACE):n.setKeyOff(n.SPACE))),e.extra?.(this)}}),i.scene("AudioIcon",{setup(e){let{cb:i,iconOn:r,iconOff:a}=e,{xOffset:h,yOffset:l,xScale:c,yScale:d}=e,{Sound:u}=t,p=t.getScaleFactor(),g=n.mkBtn(s.spriteFrom(r||"audioOn.png",a||"audioOff.png"));c=c??2*p,d=d??2*p,l=l??0,h=h??-10*p,s.scaleXY(s.opacity(g,.343),c,d),o.set(g,t.width-g.width+h,0+l),g.m5.showFrame(u.sfx()?0:1),g.m5.press=()=>{u.sfx()?(u.mute(),g.m5.showFrame(1)):(u.unmute(),g.m5.showFrame(0))},this.insert(g)}}),i.scene("StarfieldBg",{setup(e){const i=[],r=s.graphics();l.patch(e,{height:t.height,width:t.width,count:100,minVel:15,maxVel:30}),l.inject(this.g,{gfx:r,stars:i,lag:0,dynamic:!0,fps:1/e.fps,draw(){return s.gclear(r),i.forEach((t=>{s.grect(r,t.x,t.y,t.size,t.size),s.gfill(r,{color:l.rand()<.3?s.SomeColors.yellow:s.SomeColors.white})})),this},moveStars(t){this.lag+=t,this.lag>=this.fps&&(this.lag=0,i.forEach((i=>{i.y+=t*i.vel,i.y>e.height&&(o.set(i,l.randInt(e.width),0),i.size=l.randInt(4),i.vel=l.rand()*(e.maxVel-e.minVel)+e.minVel)})),this.draw())}}),e.static&&(this.g.dynamic=!1);for(let t=0;t<e.count;++t)i[t]={x:l.rand()*e.width,y:l.rand()*e.height,size:3*l.rand()+1,vel:l.rand()*(e.maxVel-e.minVel)+e.minVel};this.g.draw()&&this.insert(r)},postUpdate(t){this.g.dynamic&&this.g.moveStars(t)}},{fps:90,count:100,minVel:15,maxVel:30});const f={Periodic:class{#n;#o;#a;#h;#l;constructor(t,e,i=16){this.#n=e,this.#o=t,this.#a=0,this.#h=i,this.#l=l.fill(i,t)}lifeCycle(t){this.#a+=t,this.#a>this.#n&&(this.#a=0,this.discharge())}discharge(){throw"Periodic: please implement action()"}reclaim(t){this.#l.length<this.#h&&this.#l.push(t)}take(){return this.#l.length>0?this.#l.pop():this.#o()}},Meander:function(i){function r(e,i,s,r){i.impact=c(s),t.emit([r,e],i)}const n=[],a={dispose(){t.off(a)},boom(s){if(l.assert(s.A===i,"got hit by someone else???"),s.B&&s.B.m5.sensor)t.emit(["bump.sensor",s.B],s.A);else{let[n,a]=i.m5.vel;s.impact=e,o.sub$(i,s.overlapV),s.overlapN[1]<-.3?(a<0&&(!i.m5.skipHit&&o.setY(i.m5.vel,0)),r(i,s,a,"bump.top")):s.overlapN[1]>.3&&(a>0&&(!i.m5.skipHit&&o.setY(i.m5.vel,0)),r(i,s,a,"bump.bottom")),s.overlapN[0]<-.3?(n<0&&(!i.m5.skipHit&&o.setX(i.m5.vel,0)),r(i,s,n,"bump.left")):s.overlapN[0]>.3&&(n>0&&(!i.m5.skipHit&&o.setX(i.m5.vel,0)),r(i,s,n,"bump.right")),s.impact===e?s.impact=0:t.emit(["bump.*",i],s)}n.push(s)}};return t.on(["hit",i],"boom",a),t.on(["post.remove",i],"dispose",a),function(t){return n.length=0,s.move(i,t)&&i.parent.collideXY(i),n.length>0?n[0]:e}},Camera:function(e,i,r,n){const o=n?.height??r,a=n?.width??i,c=p(o/2),d=p(a/2),u=p(o/4),g=p(a/4);let m=0,f=0,y={dispose(){t.off(y)},set x(t){m=t,e.x=-m},set y(t){f=t,e.y=-f},get x(){return m},get y(){return f},worldHeight:r,worldWidth:i,width:a,height:o,follow(t){const e=l.feq0(t.angle)?s.getAABB(t):s.boundingBox(t);e.x1<this.x+p(d-g)&&(this.x=e.x1-g),e.x2>this.x+p(d+g)&&(this.x=e.x2-3*g),e.y1<this.y+p(c-u)&&(this.y=e.y1-u),e.y2>this.y+p(c+u)&&(this.y=e.y2-3*u),this.x<0&&(this.x=0),this.y<0&&(this.y=0),this.x+a>i&&(this.x=i-a),this.y+o>r&&(this.y=r-o);let{x1:n,x2:h,y1:m,y2:f}=t.m5.getImageOffsets(),y=e.x2-h;return y>i&&(t.x-=y-i),y=e.y2-f,y>r&&(t.y-=y-r),y=e.x1+n,y<0&&(t.x+=-y),y=e.y1+m,y<0&&(t.y+=-y),t},centerOver:function(t,e){if(1!=arguments.length||h.num(t))h.num(t)&&(this.x=t-d),h.num(e)&&(this.y=e-c);else{const e=s.centerXY(t);this.x=e[0]-d,this.y=e[1]-c}return t}};return t.on(["post.remove",e],"dispose",y),y},Patrol:function(e,i,s){const r={dispose(){t.off(r)},goLeft(i){e.m5.heading=t.LEFT,e.m5.flip="x",o.setX(e.m5.vel,-i.impact)},goRight(i){e.m5.heading=t.RIGHT,e.m5.flip="x",o.setX(e.m5.vel,i.impact)},goUp(i){o.setY(e.m5.vel,-i.impact),e.m5.heading=t.UP,e.m5.flip="y"},goDown(i){o.setY(e.m5.vel,i.impact),e.m5.heading=t.DOWN,e.m5.flip="y"}};return i&&(t.on(["bump.right",e],"goLeft",r),t.on(["bump.left",e],"goRight",r)),s&&(t.on(["bump.top",e],"goDown",r),t.on(["bump.bottom",e],"goUp",r)),t.on(["post.remove",e],"dispose",r),r},Jitter:function(i,s,r){s=s??-300,r=r??n.UP;let a=0,h=0,l=s/3;const c={onGround(){h=.06666666666666667},dispose(){t.off(c)}};return t.on(["bump.bottom",i],"onGround",c),function(c,d){if(!i.m5.skipHit){let u=i.m5.speed,p=n.keyDown(n.RIGHT),g=n.keyDown(n.LEFT),m=n.keyDown(r);d&&(g||p||h>0)&&(d.overlapN[1]>.85||d.overlapN[1]<-.85)&&(d=e),g&&!p?(i.m5.heading=t.LEFT,d&&h>0?o.set(i.m5.vel,u*d.overlapN[1],-u*d.overlapN[0]):o.setX(i.m5.vel,-u)):p&&!g?(i.m5.heading=t.RIGHT,d&&h>0?o.set(i.m5.vel,-u*d.overlapN[1],u*d.overlapN[0]):o.setX(i.m5.vel,u)):o.setX(i.m5.vel,0),h>0&&0==a&&m?(o.setY(i.m5.vel,s),a+=1,h=-c):m&&a<2&&(a+=1,t.emit(["jump",i])),a&&!m&&(a=0,t.emit(["jumped",i]),i.m5.vel[1]<l&&(i.m5.vel[1]=l)),h>0&&(i.m5.vel[1]=0)}h-=c}},MazeRunner:function(e,i){return function(s,r){let[a,c]=e.m5.vel,d=e.m5.speed,u=!l.feq0(a),p=!l.feq0(c);u&&p||!i||(p&&(h.obj(i)?e.m5.showFrame(i[c>0?t.DOWN:t.UP]):i&&(e.angle=c>0?180:0)),u&&(h.obj(i)?e.m5.showFrame(i[a>0?t.RIGHT:t.LEFT]):i&&(e.angle=a>0?90:-90)));let g=t.u.touchOnly,m=g?e.m5.heading==t.RIGHT:n.keyDown(n.RIGHT)&&t.RIGHT,f=g?e.m5.heading==t.LEFT:n.keyDown(n.LEFT)&&t.LEFT,y=g?e.m5.heading==t.UP:n.keyDown(n.UP)&&t.UP,x=g?e.m5.heading==t.DOWN:n.keyDown(n.DOWN)&&t.DOWN;(f||y)&&(d*=-1),f&&m?o.setX(e.m5.vel,0):(f||m)&&(e.m5.heading=f||m,o.setX(e.m5.vel,d)),y&&x?o.setY(e.m5.vel,0):(y||x)&&(e.m5.heading=y||x,o.setY(e.m5.vel,d))}},seek(t,e){const i=o.unit$(o.sub(e,t));return i&&(o.mul$(i,t.m5.maxSpeed),o.sub$(i,t.m5.vel),o.add$(t.m5.steer,i)),t},flee(t,e,i){let s=o.sub(t,e),r=o.len2(s);return void 0===i&&(i=t.m5.steerInfo.tooCloseDistance),r>i*i||(o.unit$(s)||(s=[.1,.1]),o.mul$(s,t.m5.maxSpeed),o.sub$(s,t.m5.vel),o.add$(t.m5.steer,s)),t},arrive(t,e,i){let s=1,r=o.dist(t,e),n=o.unit$(o.sub(e,t));return void 0===i&&(i=t.m5.steerInfo.arrivalThreshold),r>i||(s=r/i),o.mul$(n,t.m5.maxSpeed*s),o.sub$(n,t.m5.vel),o.add$(t.m5.steer,n),t},pursue(t,e){return this.seek(t,o.add(e,o.mul(e.m5.vel,o.dist(t,e)/t.m5.maxSpeed)))},evade(t,e){return this.flee(t,o.sub(e,o.mul(e.m5.vel,o.dist(t,e)/t.m5.maxSpeed)))},idle:t=>(o.mul$(t.m5.vel,0),o.mul$(t.m5.steer,0),t),wander(t){let e=o.mul$([1,1],t.m5.steerInfo.wanderRadius),i=o.len(e),s=o.mul$(o.unit(t.m5.vel),t.m5.steerInfo.wanderDistance);return e[0]=Math.cos(t.m5.steerInfo.wanderAngle)*i,e[1]=Math.sin(t.m5.steerInfo.wanderAngle)*i,t.m5.steerInfo.wanderAngle+=l.rand()*t.m5.steerInfo.wanderRange-.5*t.m5.steerInfo.wanderRange,o.add$(t.m5.steer,o.add$(s,e)),t},interpose(t,e,i){let s=o.div$(o.add(e,i),2),r=o.dist(t,s)/t.m5.maxSpeed,n=o.add(e,o.mul(e.m5.vel,r)),a=o.add(i,o.mul(i.m5.vel,r));return this.seek(t,o.div$(o.add$(n,a),2))},separation(t,e,i=300,s=100){let r=[0,0],n=0;return e.forEach((e=>{e!==t&&o.dist(e,t)<i&&(o.add$(r,o.sub(e,t)),++n)})),n>0&&o.flip$(o.div$(r,n)),o.add$(t.m5.steer,o.mul$(o.unit$(r),s)),t},followLeader(t,e,i,s=400,r=300,n=100,a=1600,h=200){let l,c=o.mul$(o.unit(e.m5.vel),s),d=o.add(e,c);return o.flip$(c),l=o.add(e,c),function(t,e,i,s){return o.dist(i,t)<s||o.dist(e,t)<s}(t,e,d,a)&&this.evade(t,e),this.arrive(t,l,h),this.separation(t,i,r,n)},queue(t,e,i=500,s=500){let r=function(){let r,n=o.mul$(o.unit(t.m5.vel),i),a=o.add(t,n);for(let i=0;i<e.length;++i)if(e[i]!==t&&o.dist(a,e[i])<s){r=e[i];break}return r}(),n=[0,0],a=o.mul(t.m5.vel,1);return r&&(n=o.mul$(o.flip(t.m5.steer),.8),o.unit$(o.flip$(a)),o.add$(n,a),o.dist(t,r)<s&&o.mul$(t.m5.vel,.3)),o.add$(t.m5.steer,n),t},flock(t,e){let i=0,s=[0,0],r=o.mul(t.m5.vel,1);return e.forEach((e=>{e!==this&&function(e){return!(o.dist(t,e)>t.m5.steerInfo.inSightDistance||o.dot(o.sub(e,t),o.unit(t.m5.vel))<0)}(e)&&(o.add$(r,e.m5.vel),o.add$(s,e),o.dist(t,e)<t.m5.steerInfo.tooCloseDistance&&this.flee(t,e),++i)})),i>0&&(o.div$(r,i),o.div$(s,i),this.seek(t,s),o.add$(t.m5.steer,o.sub$(r,t.m5.vel))),t},followPath(t,e,i,s=1){let r=e[t.m5.pathIndex];if(r)return o.dist(t,r)<s&&(t.m5.pathIndex>=e.length-1?i&&(t.m5.pathIndex=0):t.m5.pathIndex+=1),t.m5.pathIndex>=e.length-1&&!i?this.arrive(t,r):this.seek(t,r),t},avoid(t,e){let i,s=null,r=o.len(t.m5.vel)/t.m5.maxSpeed,n=o.add(t,o.mul$(o.unit(t.m5.vel),r)),a=o.add(t,o.mul$(o.unit(t.m5.vel),.5*t.m5.steerInfo.avoidDistance));for(let i,r=0;r<e.length;++r)e[r]!==this&&(i=o.dist(e[r],n)<=e[r].m5.radius||o.dist(e[r],a)<=e[r].m5.radius,i&&(null===s||o.dist(t,e[r])<o.dist(t,s))&&(s=e[r]));return s&&(i=o.mul$(o.unit$(o.sub(n,s)),100),o.add$(t.m5.steer,i)),t},lineOfSight(t,e,i){let r=s.centerXY(t),n=s.centerXY(e);for(let t,e,o=0;o<i.length;++o)if(e=i[o],t=e.m5.circle?g.hitTestLineCircle(r,n,e.x,e.y,e.width/2):g.hitTestLinePolygon(r,n,g.bodyWrap(s.toPolygon(e),e.x,e.y)),t[0])return!1;return!0},shoot(t,e,i,r,n,a){const h=r(),l=s.topLeftOffsetXY(t);return o.add$(l,[n,a]),o.copy(h,o.add(t,l)),o.set(h.m5.vel,Math.cos(e)*i,Math.sin(e)*i),h},healthBar(t){let{scale:e,width:r,height:n,lives:o,borderWidth:a,line:h,fill:l}=t,c=4*e,d=4*e,u=[];a=(a||4)*e,o=o||3,l=s.color(l),h=s.color(h);for(let t=p(r/o),e=0;e<o;++e)u.push(s.rect(t,n-2*a,l));return{dec(){return this.lives>0&&(this.lives-=1,u[this.lives].visible=!1),this.lives>0},lives:u.length,sprite:i.layoutX(u,{bg:["#cccccc",0],borderWidth:a,border:h,padding:c,fit:d})}},gaugeUI(t){let{minDeg:e,maxDeg:i,line:r,gfx:n,scale:o,cx:h,cy:c,radius:p,alpha:g,fill:f,needle:y}=l.patch(t,{minDeg:90,maxDeg:360});const x=[0,45*m,90*m,135*m,180*m,225*m,270*m,315*m];function v(t,e,i,s){return[t+i*d(s),e+i*u(s)]}return y=s.color(y),r=s.color(r),f=s.color(f),p*=o,{gfx:n,draw(){s.gclear(n),s.gcircle(n,h,c,p),s.gfill(n,{color:f,alpha:g}),s.gstroke(n,{width:p/8,color:r}),x.forEach((t=>function(t,e,i,a){let[h,l]=v(t,e,p-4*o,i),[c,d]=v(t,e,p-12*o,i);s.gpath(n,[["moveTo",h,l],["lineTo",c,d],["closePath"]]),s.gstroke(n,{color:r,width:a,cap:"round"})}(h,c,t,7*o))),function(t,e,i){let[a,l]=v(h,c,t-20*o,i),[d,u]=v(h,c,2*o,i+90*m),[p,g]=v(h,c,2*o,i-90*m);s.gpath(n,[["moveTo",d,u],["lineTo",a,l],["lineTo",p,g],["closePath"]]),s.gstroke(n,{cap:"round",width:4*o,color:y}),s.gcircle(n,h,c,9*o),s.gfill(n,{color:r}),s.gstroke(n,{color:r})}(p*o,0,m*a.lerp(e,i,t.update()))}}}};return t.Ute2D=f}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Ute2D"]=t=>t.Ute2D?t.Ute2D:i(t)}(this),function(t,e){"use strict";if(!t.AudioContext)throw"Fatal: no audio.";function i(i,s){const{ute:r,is:n}=i,o=(Math.floor,new Map);let a=1;function h(t,n,h){let l=0,c=1;const d={sids:new Map,buffer:e,loop:!1,src:h,name:n,get pan(){return l},set pan(t){l=t},get vol(){return c},set vol(t){c=t},play(){const e=r.now(),s=this.name;if(i.Sound.sfx()&&!function(t,e,i){let s;return o.has(t)&&o.get(t)>e?s=!0:i?o.set(t,e+i):o.delete(t),s}(s,e)){let e=a++,i=1e3*this.buffer.duration,s=t.ctx.createGain(),n=t.ctx.createStereoPanner(),o=t.ctx.createBufferSource();o.buffer=this.buffer,o.connect(s),s.connect(n),n.connect(t.ctx.destination),this.loop?o.loop=!0:r.delay(i,(()=>this.sids.delete(e))),n.pan.value=l,s.gain.value=c,o.start(0),this.sids.set(e,o)}return this},stop(){return this.sids.forEach((t=>t.stop(0))),this.sids.length=0,this}};return s[n]=d}const l={ctx:new t.AudioContext,_mute:0,init(){r.delay(0,(()=>{"suspended"==this.ctx.state&&this.ctx.resume()}))},sfx(){return 0==this._mute},mute(){return(this._mute=1)&&this},unmute(){return(this._mute=0)||this},decodeData(t,e,s,r,n){let o=h(this,t,e);return this.ctx.decodeAudioData(s,(t=>{r(o.buffer=t),i.CON.log(`decoded sound file:${e}`)}),(t=>{n&&n(e,t)})),o},decodeUrl(t,e,i,s){let r=new XMLHttpRequest,n=h(this,t,e);return r.open("GET",e,!0),r.responseType="arraybuffer",r.addEventListener("load",(()=>{this.decodeData(e,r.response,i,s)})),r.send(),n}};return i.sound=function(t,n=!0){return s[t||i.assetPath(t)]||(n?r.assert(!1,`Sound: ${t} not loaded.`):e)},i.Sound=l}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Sound"]=function(t){return t.Sound?t.Sound:i(t,{})}}(this),function(t,e){"use strict";function i(t){const{math:i,v2:s,ute:r,is:n,Sprites:o}=t,{Geo:a}=o,h=[],l=["ctrlKey","altKey","shiftKey"],c=()=>h[0];function d(i={}){function o(t){if(i===c()){let e=i.keyInputs.get(t.keyCode);e||(e={},i.keyInputs.set(t.keyCode,e)),e.state=!1,r.copyKeys(e,t,l),t.preventDefault()}}function h(t){if(i===c()){let e=i.keyInputs.get(t.keyCode);e||(e={},i.keyInputs.set(t.keyCode,e)),e.state=!0,r.copyKeys(e,t,l),t.preventDefault()}}return r.inject(i,{yid:`yid#${r.nextId()}`,keyInputs:r.jsMap(),pauseInput:!1,ptr:e,dispose(){this.ptr.dispose(),t.touchDevice||r.delEvent([["keyup",globalThis,o,!1],["keydown",globalThis,h,!1]])},pointer(){return this.ptr||(this.ptr=function(i){let n={ActiveDragsID:r.jsMap(),ActiveDrags:r.jsMap(),ActiveTouches:r.jsMap(),Hotspots:[],Buttons:[],DragDrops:[],state:[!1,!0],touchZeroID:0,_visible:!0,_x:0,_y:0,width:1,height:1,downTime:0,downAt:[0,0],elapsedTime:0,dragged:e,dragOffsetX:0,dragOffsetY:0,anchor:t.makeAnchor(.5,.5),get cursor(){return t.canvas.style.cursor},set cursor(e){t.canvas.style.cursor=e},get x(){return this._x/t.scale},get y(){return this._y/t.scale},get visible(){return this._visible},get isUp(){return this.state[1]},get isDown(){return this.state[0]},set visible(t){this.cursor=t?"auto":"none",this._visible=t},updateMultiDrags(t){let e,i=n;i.ActiveTouches.forEach(((t,n)=>{for(let n,o,a=i.DragDrops.length-1;a>=0;--a){if(o=i.DragDrops[a],n=i.ActiveDrags.get(o.m5.uuid),n){s.set(n.dragged,n.dragStartX+(t.x-n.dragPtrX),n.dragStartY+(t.y-n.dragPtrY));break}if(o.m5.drag&&i._test(o,t.x,t.y)){r.assoc(i.ActiveDrags,o.m5.uuid,n={dragStartX:o.x,dragStartY:o.y,dragPtrX:t.x,dragPtrY:t.y,dragged:o,id:t.id}),r.assoc(i.ActiveDragsID,t.id,n),e=o.parent.children,r.disj(e,o),e.push(o);break}}}))},updateDrags(t){if(this.state[0])if(this.dragged)s.set(this.dragged,this.dragStartX+(this.x-this.dragPtrX),this.dragStartY+(this.y-this.dragPtrY));else for(let t,e,i=this.DragDrops.length-1;i>=0;--i)if(e=this.DragDrops[i],e.m5.drag&&this.hitTest(e)){this.dragStartX=e.x,this.dragStartY=e.y,this.dragPtrX=this.x,this.dragPtrY=this.y,this.dragged=e,t=e.parent,t.removeChild(e),t.addChild(e);break}this.state[1]&&(this.dragged&&this.dragged.m5.onDragDropped&&this.dragged.m5.onDragDropped(),this.dragged=e)},getGlobalPosition(){return{x:this.x,y:this.y}},_press(){if(i!==c())return;let t,e,s,r=this.Buttons.length;for(t=0;t<r;++t)if(e=this.Buttons[t],e.m5.gui&&e.m5.press&&this.hitTest(e)){e.m5.press(e),s=!0;break}if(!s)for(t=0;t<r;++t)if(e=this.Buttons[t],e.m5.press&&this.hitTest(e)){e.m5.press(e);break}},_doMDown(t){if(i!==c())return;let e,s=n;for(let i,r=0;r<s.Hotspots.length;++r)if(i=s.Hotspots[r],i.m5.touch&&s.hitTest(i)){i.m5.touch(i,t),e=!0;break}return e},mouseDown(e){if(i!==c())return;let s=n,o=r.now();0==e.button&&(e.preventDefault(),s._x=e.pageX-e.target.offsetLeft,s._y=e.pageY-e.target.offsetTop,r.setVec(s.state,!0,!1),s.downTime=o,s.downAt[0]=s._x,s.downAt[1]=s._y,t.Sound.init(),i.pauseInput||(t.emit([`${i.yid}/mousedown`]),s._doMDown(!0)))},mouseMove(e){if(i!==c())return;let s=n;s._x=e.pageX-e.target.offsetLeft,s._y=e.pageY-e.target.offsetTop,i.pauseInput||t.emit([`${i.yid}/mousemove`])},mouseUp(e){if(i!==c())return;let o=n,a=r.now();if(0==e.button&&(e.preventDefault(),o.elapsedTime=Math.max(0,a-o.downTime),o._x=e.pageX-e.target.offsetLeft,o._y=e.pageY-e.target.offsetTop,r.setVec(o.state,!1,!0),!i.pauseInput&&(t.emit([`${i.yid}/mouseup`]),!o._doMDown(!1)))){let e=s.vecAB(o.downAt,o),r=s.len2(e);r<400&&o.elapsedTime<200?(t.emit([`${i.yid}/single.tap`]),o._press()):o._swipeMotion(e,r,o.elapsedTime)}},_swipeMotion(e,r,n,o){if(i!==c())return;let a,h=s.unit$(s.normal(e));r>400&&n<1e3&&(Math.abs(h[0])>.8||Math.abs(h[1])>.8)&&(h[0]>.8&&(a="swipe.down"),h[0]<-.8&&(a="swipe.up"),h[1]>.8&&(a="swipe.left"),h[1]<-.8&&(a="swipe.right")),a&&t.emit([`${i.yid}/${a}`],o)},_doMTouch(t,e){if(i!==c())return;let s=n,o=r.jsMap();for(let i,r=0;r<t.length;++r){i=t[r];for(let t,r=0;r<s.Hotspots.length;++r)if(t=s.Hotspots[r],t.m5.touch&&s._test(t,i.x,i.y)){t.m5.touch(t,e),o.set(i.id,1);break}}return o},_doMDrag(t,e){if(i!==c())return;let s=n;for(let i,r,n=0;n<t.length;++n)r=t[n],e.get(r.id)||(i=s.ActiveDragsID.get(r.id),i&&(e.set(r.id,1),i.dragged.m5.onDragDropped&&i.dragged.m5.onDragDropped(),s.ActiveDragsID.delete(r.id),s.ActiveDrags.delete(i.dragged.m5.uuid)));return e},touchCancel(t){i===c()&&(console.warn("received touchCancel event!"),this.freeTouches())},touchStart(e){if(i!==c())return;let s=n,o=e.target,a=[],h=r.now(),l=e.targetTouches,d=s.ActiveTouches;e.preventDefault();for(let e,i,n,c,u,p=0;p<l.length;++p)u=l[p],c=u.identifier,i=u.pageX-o.offsetLeft,n=u.pageY-o.offsetTop,r.assoc(d,c,e={id:c,_x:i,_y:n,downTime:h,downAt:[i,n],x:i/t.scale,y:n/t.scale}),a.push(e),0==p&&(s.touchZeroID=c,s._x=i,s._y=n,s.downTime=h,s.downAt=[i,n],r.setVec(s.state,!0,!1));t.Sound.init(),i.pauseInput||(t.emit([`${i.yid}/touchstart`],a),s._doMTouch(a,!0))},touchMove(e){if(i!==c())return;let s=[],r=n,o=e.target,a=e.targetTouches;e.preventDefault();for(let e,i,n,h,l,c=0;c<a.length;++c)h=a[c],l=h.identifier,e=h.pageX-o.offsetLeft,i=h.pageY-o.offsetTop,l==r.touchZeroID&&(r._x=e,r._y=i),(n=r.ActiveTouches.get(l))&&(n.x=e/t.scale,n.y=i/t.scale,n._x=e,n._y=i,s.push(n));i.pauseInput||t.emit([`${i.yid}/touchmove`],s)},touchEnd(e){if(i!==c())return;let s,o,a,h,l,d,u=n,p=[],g=(e.targetTouches,e.changedTouches),m=e.target,f=r.now();for(e.preventDefault(),a=0;a<g.length;++a)l=g[a],d=l.identifier,s=l.pageX-m.offsetLeft,o=l.pageY-m.offsetTop,h=u.ActiveTouches.get(d),d==u.touchZeroID&&(u.elapsedTime=Math.max(0,f-u.downTime),r.setVec(u.state,!1,!0),u._x=s,u._y=o),h&&(h.elapsedTime=Math.max(0,f-h.downTime),u.ActiveTouches.delete(d),h._x=s,h._y=o,h.x=s/t.scale,h.y=o/t.scale,p.push(h));if(!i.pauseInput){t.emit([`${i.yid}/touchend`],p);let e=u._doMTouch(p,!1);u._doMDrag(p,e),u._onMultiTouches(p,e)}},_onMultiTouches(e,r){if(i!==c())return;let o=n;for(let n,a,h,l=0;l<e.length;++l)if(n=e[l],!r.get(n.id))if(a=s.vecAB(n.downAt,n),h=s.len2(a),h<400&&n.elapsedTime<200){t.emit([`${i.yid}/single.tap`],n);for(let t,e=0,i=o.Buttons.length;e<i;++e)if(t=o.Buttons[e],t.m5.press&&o._test(t,n.x,n.y)){t.m5.press(t);break}}else o._swipeMotion(a,h,n.elapsedTime,n)},freeTouches(){r.setVec(this.state,!1,!0),this.touchZeroID=0,this.ActiveTouches.clear(),this.ActiveDrags.clear(),this.ActiveDragsID.clear()},reset(){r.setVec(this.state,!1,!0),this.freeTouches(),this.DragDrops.length=0,this.Buttons.length=0,this.Hotspots.length=0},_test(e,i,r){let n=t.Sprites,o=n.gposXY(e),h=n.toPolygon(e),l=s.translate(o,h.calcPoints);return a.hitTestPointInPolygon(i,r,l)},hitTest(t){return this._test(t,this.x,this.y)},update(e){this.DragDrops.length>0&&(t.touchDevice?this.updateMultiDrags(e):this.updateDrags(e))}};const o=[["mousemove",t.canvas,n.mouseMove],["mousedown",t.canvas,n.mouseDown],["mouseup",globalThis,n.mouseUp]],h=[["touchmove",t.canvas,n.touchMove],["touchstart",t.canvas,n.touchStart],["touchend",globalThis,n.touchEnd],["touchcancel",globalThis,n.touchCancel]];return t.touchDevice?r.addEvent(h):r.addEvent(o),n.dispose=function(){this.reset(),t.touchDevice?r.delEvent(h):r.delEvent(o)},n}(this)),this.ptr},update(t){this.pauseInput||this.ptr.update(t)},keybd(e,s,o){let a={press:s,release:o},h=this,l=!0,d=!1,u=n.vec(e)?e:[e];function p(t){i===c()&&(u.includes(t.keyCode)&&(!h.pauseInput&&l&&a.press?.(t.altKey,t.ctrlKey,t.shiftKey),l=!1,d=!0),t.preventDefault())}function g(t){i===c()&&(u.includes(t.keyCode)&&(!h.pauseInput&&d&&a.release?.(t.altKey,t.ctrlKey,t.shiftKey),l=!0,d=!1),t.preventDefault())}return t.touchDevice||r.addEvent([["keyup",globalThis,g,!1],["keydown",globalThis,p,!1]]),a.dispose=()=>{t.touchDevice||r.delEvent([["keyup",globalThis,g,!1],["keydown",globalThis,p,!1]])},a},reset(){this.pauseInput=!1,this.keyInputs.clear(),this.ptr.reset()},resize(){t.mouse=this.ptr,this.ptr.reset()},dbg(){console.log(`N# of touches= ${this.ptr.ActiveTouches.size}`),console.log(`N# of hotspots= ${this.ptr.Hotspots.length}`),console.log(`N# of buttons= ${this.ptr.Buttons.length}`),console.log(`N# of drags= ${this.ptr.DragDrops.length}`),console.log(`Mouse pointer = ${this.ptr}`)}}),i.pointer(),t.touchDevice||r.addEvent([["keyup",globalThis,o,!1],["keydown",globalThis,h,!1]]),i}const u={LEFT:37,RIGHT:39,UP:38,DOWN:40,ZERO:48,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,ENTER:13,ESC:27,BACKSPACE:8,TAB:9,SHIFT:16,CTRL:17,ALT:18,SPACE:32,HOME:36,END:35,PGGUP:33,PGDOWN:34,isPaused:()=>c().pauseInput,resume(){c().pauseInput=!1},pause(){c().pauseInput=!0},dbg(){c().dbg()},_cur:()=>c(),resize(){c().resize()},reset(){c().reset()},setKeyOn(t){let e=c().keyInputs.get(t);e||(e={},c().keyInputs.set(t,e)),e.state=!0},setKeyOff(t){let e=c().keyInputs.get(t);e||(e={},c().keyInputs.set(t,e)),e.state=!1},keybd:(t,e,i)=>c().keybd(t,e,i),undoButton:t=>(r.disj(c().ptr.Buttons,t),t.m5.button=!1,t),makeButton:(t,e=!1)=>(r.conj(c().ptr.Buttons,t),t.m5.button=!0,t.m5.gui=e,t),undoHotspot:t=>(r.disj(c().ptr.Hotspots,t),t.m5.hotspot=!1,t),makeHotspot:t=>(r.conj(c().ptr.Hotspots,t),t.m5.hotspot=!0,t),undoXXX(t){t&&t.m5&&(t.m5.drag&&this.undoDrag(t),t.m5.button&&this.undoButton(t),t.m5.hotspot&&this.undoHotspot(t))},update(t){c().update(t)},makeDrag:t=>(r.conj(c().ptr.DragDrops,t),t.m5.drag=!0,t),undoDrag:t=>(r.disj(c().ptr.DragDrops,t),t.m5.drag=!1,t),keyUp(t){return!this.keyDown(t)},keyDown(t){let i=c().keyInputs.get(t);return i&&i.state?i:e},pointer:()=>c().pointer(),dispose(){h.forEach((t=>t.dispose())),h.length=0},restore(){h.length>1&&(h.shift().dispose(),c().pauseInput=!1)},save(){h.unshift(d())},on:(...e)=>(r.assert(n.vec(e[0])&&n.str(e[0][0]),"bad arg for Input.on()"),e[0][0]=`${c().yid}/${e[0][0]}`,t.on(...e)),off:(...e)=>(r.assert(n.vec(e[0])&&n.str(e[0][0]),"bad arg for Input.off()"),e[0][0]=`${c().yid}/${e[0][0]}`,t.off(...e))};return t.canvas.style.touchAction="none",u.undoBtn=u.undoButton,u.mkBtn=u.makeButton,u.mkDrag=u.makeDrag,h.push(d()),t.Input=u}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Input"]=function(t){return t.Input?t.Input:i(t)}}(this),function(t,e){"use strict";function i(t){const e=Math.PI/8,i=3*e,s=5*e,r=7*e,{Sprites:n,Input:o,is:a,ute:h}=t,l=Math.sin,c=Math.cos,d=Math.abs,u=180/Math.PI;function p(n){function a(t){let e=t.target,i=t.changedTouches;i?(t=i[0],n.m5.touchId=i[0].identifier):n.m5.touchId=0,n.m5.startX=t.pageX-e.offsetLeft,n.m5.startY=t.pageY-e.offsetTop,n.m5.drag=!0,n.m5.static||(n.visible=!0,n.x=n.m5.startX,n.y=n.m5.startY),o.isPaused()||n.m5.onStart()}function p(t){n.m5.drag&&(n.m5.hdle.position.set(0,0),n.m5.drag=!1,n.m5.static||(n.visible=!1),o.isPaused()||n.m5.onEnd())}function g(a){if(o.isPaused()||!n.visible||!n.m5.drag)return;let p,g=a.target;if(a.changedTouches){for(let t=0,e=a.changedTouches;t<e.length;++t)if(n.m5.touchId==e[t].identifier){p=[e[t].pageX-g.offsetLeft,e[t].pageY-g.offsetTop];break}}else p=[a.pageX-g.offsetLeft,a.pageY-g.offsetTop];let m,f,y,x=0,v=p?p[0]-n.m5.startX:0,w=p?p[1]-n.m5.startY:0,b=n.m5.range;if(p[0]=0,p[1]=0,!h.feq0(v)||!h.feq0(w)){if(f=d(v),y=d(w),h.feq0(v))p[0]=0,w>0?(p[1]=w>b?b:w,x=270,m=t.DOWN):(p[1]=-(y>b?b:y),x=90,m=t.UP);else if(h.feq0(w))p[1]=0,v>0?(p[0]=f>b?b:f,x=0,m=t.RIGHT):(p[0]=-(f>b?b:f),x=180,m=t.LEFT);else{let n=Math.atan(d(w/v));x=n*u,p[0]=p[1]=0,v*v+w*w>=b*b?(p[0]=b*c(n),p[1]=b*l(n)):(p[0]=f>b?b:f,p[1]=y>b?b:y),w<0&&(p[1]=-d(p[1])),v<0&&(p[0]=-d(p[0])),v>0&&w<0||(v<0&&w<0?x=180-x:v<0&&w>0?x+=180:v>0&&w>0&&(x=360-x)),m=function(n,o){const a=Math.atan2(+o,+n);return a>-s&&a<-i?t.UP:a>i&&a<s?t.DOWN:a>-e&&a<0||a>0&&a<e?t.RIGHT:a>r&&a<Math.PI||a>-Math.PI&&a<-r?t.LEFT:a>e&&a<i?t.SE:a>s&&a<r?t.SW:a>-i&&a<-e?t.NE:a>-r&&a<-s?t.NW:void h.assert(!1,"Failed Joystick calcDir")}(p[0],p[1])}n.m5.hdle.position.set(p[0],p[1]),n.m5.onChange(m,x)}}const m=[["mousemove",t.canvas,g],["mousedown",t.canvas,a],["mouseup",globalThis,p],["touchend",globalThis,p],["touchcancel",globalThis,p],["touchmove",t.canvas,g],["touchstart",t.canvas,a]];return h.addEvent(m),n.m5.dispose=()=>{h.delEvent(m)},n}const g={assets:["boot/joystick.png","boot/joystick-handle.png"],joystick(e){let i=n.sprite("boot/joystick-handle.png"),s=n.sprite("boot/joystick.png"),r=n.container(),o=t.getScaleFactor(),a=h.inject({oscale:.7*o,iscale:1*o,hdle:i,schtick:s,onEnd(){},onStart(){},prevDir:0,static:!1,onChange(t,e){}},e);return r.addChild(n.centerAnchor(n.scaleXY(s,a.oscale,a.oscale))),r.addChild(n.centerAnchor(n.scaleXY(i,a.iscale,a.iscale))),a.range=r.width/2.5,a.static||(r.visible=!1),h.inject(r.m5,a),p(r)}};return t.Touch=g}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Touch"]=function(t){return t.Touch?t.Touch:i(t)}}(this),function(t,e){"use strict";function i(t){const e=[t.UP,t.LEFT,t.RIGHT,t.DOWN],{ute:i,is:s,v2:r,math:n}=t,o=Math.abs,a=Math.ceil,h=Math.floor;function l(t,e,s){return r=t,n=e,o=s.tiled.tileW,a=s.tiled.tileH,l=s.tiled.tilesInX,r>=0&&n>=0?h(r/o)+h(n/a)*l:i.assert(!1,`IndexError: ${r},${n}, wanted +ve values`);var r,n,o,a,l}function c(e,i){return r.vecAB(t.Sprites.centerXY(e),t.Sprites.centerXY(i))}function d(t){const e=t.image?.split("/");t.image=e&&e.length&&e[e.length-1]}function u(t,e,s){const r=[];return t.forEach((t=>{r.push([t.firstgid,t]),t.spacing||(t.spacing=0),d(t);const n={};(t.tiles||[]).forEach((e=>{let r=i.selectNotKeys(e,"properties");r=i.inject(r,p(e)),r.gid=t.firstgid+e.id,n[e.id]=r,s[r.gid]=r})),e[t.name]=n})),r.sort(((t,e)=>t[0]>e[0]?1:t[0]<e[0]?-1:0))}function p(t){return(t.properties||[]).reduce(((t,e)=>(t[e.name]=e.value,t)),{})}function g(e,r,o){let a={},l={},c=s.str(r)?function(e){let s=t.resource(e,!0),r=s&&(s.tiledversion||s.version);return r&&i.cmpVerStrs(r,"1.4.2")>=0?s:i.assert(!1,`${e} needs update`)}(r):r;i.assert(s.obj(c),"bad tiled map"),c=JSON.parse(JSON.stringify(c)),i.inject(e.tiled,{tileW:c.tilewidth,tileH:c.tileheight,tilesInX:c.width,tilesInY:c.height,tiledMap:c,saved_tileW:c.tilewidth,saved_tileH:c.tileheight,tiledWidth:c.tilewidth*c.width,tiledHeight:c.tileheight*c.height},p(c));let g=e.getScaleFactor(),f=i.evenN(g*c.tileheight),y=i.evenN(g*c.tilewidth);e.tiled.new_tileW=y,e.tiled.new_tileH=f;const x={imagelayer(t){d(t)},tilelayer(t){s.vec(t.data[0])&&(t.width=t.data[0].length,t.height=t.data.length,t.data=t.data.flat()),t.width||(t.width=e.tiled.tilesInX),t.height||(t.height=e.tiled.tilesInY);let i,r=p(t);if(!1!==t.visible)for(let i,s=0;s<t.data.length;++s){if(0==(i=t.data[s]))continue;!1===t.collision||!1===r.collision||!0!==t.collision&&!0!==r.collision||(i>0&&(e.tiled.collision[s]=i),t.collision=!0);let n=s%t.width,a=h(s/t.width),c=l[i],d=c&&c.Class,u=d&&o[d],p=e.getTSInfo(i),g=m(e,i,n,a,r.width,r.height);g&&(g.tiled.layer=t,g.tiled.index=s,g.m5.static=!0),u&&(g=u.c(e,g,p,c)),g&&(e.insert(g,!!u),c&&c.sensor&&(g.m5.sensor=!0))}else(i=r.Class)&&o[i](e,t)},objectgroup(t){t.sprites=[],t.objects.forEach((r=>{i.assert(s.num(r.x),"wanted xy position");let a,h,c=p(r),d=r.gid??-1;i.inject(r,c),d>0&&(h=l[d]);let u=i.nor(h&&h.Class,r.Class),g=u&&o[u],x=e.tiled.saved_tileW,v=e.tiled.saved_tileH,w=n.ndiv(r.x+x/2,x),b=n.ndiv(r.y-v/2,v),I=e.getTSInfo(d);r.column=w,r.row=b,a=d<=0?{width:y,height:f}:m(e,d,w,b,r.width,r.height,u),g&&(a=g.c(e,a,I,h,r)),a&&(!1===r.visible&&(a.visible=!1),r.uuid=a.m5.uuid,t.sprites.push(a),e.insert(a,!0),h&&h.sensor&&(a.m5.sensor=!0))}))}};o=o??{},i.inject(e.tiled,{objFactory:o,tileSets:a,tileProps:l,collision:i.fill(c.width*c.height,0),imagelayer:[],objectgroup:[],tilelayer:[],tileGidList:u(c.tilesets,a,l)}),["imagelayer","tilelayer","objectgroup"].forEach((t=>{c.layers.filter((e=>e.type==t)).forEach((i=>{x[t](i),e.tiled[t].push(i)}))})),e.tiled.tileW=y,e.tiled.tileH=f,e.tiled.tiledWidth=y*c.width,e.tiled.tiledHeight=f*c.height,e.parent instanceof t.Scenes.SceneWrapper&&(e.tiled.tiledHeight<t.height&&(e.parent.y=n.ndiv(t.height-e.tiled.tiledHeight,2)),e.tiled.tiledWidth<t.width&&(e.parent.x=n.ndiv(t.width-e.tiled.tiledWidth,2)))}function m(e,r,o,a,l,c,d){let u,p=e.getTSInfo(r,!0),g=p.columns,m=r-p.firstgid,f=e.tiled.tileProps[r],y=e.getScaleFactor();u=(d=d??(f&&f.Class))&&e.tiled.objFactory[d],i.assertNot(m<0,`Bad tile id: ${m}`),s.num(g)||(g=n.ndiv(p.imagewidth,p.tilewidth+p.spacing));let x=m%g,v=h(m/g),w=x*p.tilewidth,b=v*p.tileheight;p.spacing>0&&(w+=p.spacing*x,b+=p.spacing*v);let I=u&&u.s(e)||t.Sprites.frame(p.image,l||p.tilewidth,c||p.tileheight,w,b);return I&&(I.tiled={id:m,gid:r},l==e.tiled.saved_tileW?I.width=e.tiled.new_tileW:(I.scale.x=y,I.width=i.evenN(I.width)),c==e.tiled.saved_tileH?I.height=e.tiled.new_tileH:(I.scale.y=y,I.height=i.evenN(I.height)),I.x=o*e.tiled.new_tileW,I.y=a*e.tiled.new_tileH),I}const f=t.Sprites.lift({width:0,height:0,parent:null,x:0,y:0,rotation:0,tiled:{},anchor:{x:0,y:0},getGlobalPosition(){return{x:this.x+this.parent.x,y:this.y+this.parent.y}}});class y extends t.Scenes.Scene{constructor(t,e,i){super(t,e,i),this.tiled={}}reloadMap(t){this.tiled={},this.m5.options.tiled=t,g(this,t.name,t.factory)}runOnce(){const t=this.m5.options.tiled;this.preTMX?.(t),g(this,t.name,t.factory),this.postTMX?.(t),super.runOnce()}removeTile(e,i){let{x:s,y:r}=i;i.anchor.x<.3&&(r=i.y+h(i.height/2),s=i.x+h(i.width/2));let n=h(s/this.tiled.tileW),o=h(r/this.tiled.tileH),a=this.getTileLayer(e),l=n+o*this.tiled.tilesInX;a.data[l]=0,a.collision&&(this.tiled.collision[l]=0),t.Sprites.remove(i)}getTileLayer(t,e){const s=i.some(this.tiled.tilelayer,(e=>{if(e.name==t)return e}));if(!s&&e)throw`There is no layer with name: ${t}`;return s}getObjectGroup(t,e){const s=i.some(this.tiled.objectgroup,(e=>{if(e.name==t)return e}));if(!s&&e)throw`There is no group with name: ${t}`;return s}setTile(t,e,i,s){let r,n=this.getTSInfo(s,!0),o=(n.firstgid,this.getTileLayer(t)),a=i+this.tiled.tilesInX*e;return o.collision&&(this.tiled.collision[a]=s),r=m(this,s,i,e,n.tilewidth,n.tileheight),r&&(r.tiled.index=a,r.tiled.layer=o),r}getTile(t){let{x:e,y:i}=t;return t.anchor.x<.3&&(i+=h(t.height/2),e+=h(t.width/2)),this.getTileXY(e,i)}getTileXY(t,e){let s=h(t/this.tiled.tileW),r=h(e/this.tiled.tileH);return i.assert(s>=0&&s<this.tiled.tilesInX,`bad tile col:${s}`),i.assert(r>=0&&r<this.tiled.tilesInY,`bad tile row:${r}`),[s,r]}getNamedItem(t){const e=[];return this.tiled.objectgroup.forEach((s=>{s.objects.forEach((s=>{t==i.get(s,"name")&&e.push(s)}))})),e}getScaleFactor(){let e=t.height/(this.tiled.saved_tileH*this.tiled.tilesInY),i=t.width/(this.tiled.saved_tileW*this.tiled.tilesInX),s=1;return"max"==t.u.scaleToWindow&&(s=i<e?i:e),s}getTileIndex(e){let[i,s]=t.Sprites.centerXY(e);return l(i,s,this)}getTSInfo(t,e){const s=function(t,e){let i=-1;if(t>0)for(i=0;e[i+1]&&t>=e[i+1][0];)++i;return i>=0?e[i]:[]}(t,this.tiled.tileGidList)[1];return!s&&e?i.assert(!1,`Bad GID ${t}, no tileset`):s}getTileProps(t){return this.tiled.tileProps[t]}_getContactObj(t,e,i){let s=f;return s.height=this.tiled.tileH,s.width=this.tiled.tileW,s.x=e*s.width,s.y=i*s.height,s.tiled.gid=t,s.tiled.row=i,s.tiled.col=e,s.m5.sensor=!1,s}collideXY(e){let r=t.Sprites,n=this.tiled.tileW,o=this.tiled.tileH,l=this.tiled.collision,c=i.feq0(e.angle)?r.getAABB(e):r.boundingBox(e),d=Math.max(0,h(c.x1/n)),u=Math.max(0,h(c.y1/o)),p=Math.min(this.tiled.tilesInX-1,a(c.x2/n)),g=Math.min(this.tiled.tilesInY-1,a(c.y2/o));for(let n,o,a,h,c=u;c<=g;++c)for(let u=d;u<=p;++u)a=c*this.tiled.tilesInX+u,o=l[a],i.assert(s.num(o),"bad gid"),0!=o&&(h=this._getContactObj(o,u,c),n=this.getTileProps(o),n&&(h.m5.sensor=!!n.sensor),h.parent=this,r.hit(e,h)&&h.m5.sensor&&t.emit(["bump.sensor",e],h));return super.collideXY(e)}}class x{constructor(t,e){this.straightCost=t,this.diagonalCost=e}manhattan(t,e){return o(t.row-e.row)*this.straightCost+o(t.col-e.col)*this.straightCost}euclidean(t,e){let s=e.col-t.col,r=e.row-t.row;return h(i.sqrt(s*s+r*r)*this.straightCost)}diagonal(t,e){let i=o(e.col-t.col),s=o(e.row-t.row);return h(i>s?this.diagonalCost*s+this.straightCost*(i-s):this.diagonalCost*i+this.straightCost*(s-i))}}const v={TiledScene:y,neighborCells(t,e,i){let s=e.tiled.tilesInX,r=[t-s-1,t-s,t-s+1,t-1],n=[t+1,t+s-1,t+s,t+s+1];return i||r.push(t),r.concat(n)},updateMap(t,e,r){let n=i.fill(t.length,0),o=t=>{let e=this.getTileIndex(t,r);i.assert(e>=0&&e<n.length,"tiled index outofbound"),t.tiled.index=e,n[e]=t.tiled.gid};return s.vec(e)?e.forEach(o):o(e),n},shortestPath(t,e,i,s,r=[],n="manhattan",o=!0){let a=s.tiled.tilesInX,l=i.map(((t,e)=>({f:0,g:0,h:0,parent:null,index:e,col:e%a,row:h(e/a)}))),c=l[e],d=l[t],u=d,p=[u],g=[],m=[],f=t=>(o?this.neighborCells(t,s,!0):this.crossCells(t,s)).map((t=>l[t])).filter((e=>{if(e){let s=t%a==0,n=(t+1)%a==0,o=e.col%(a-1)==0&&0!=e.col,h=e.col%a==0,l=r.some((t=>i[e.index]==t));return s?!o:n?!h:!l}}));for(;u!==c;){let t=f(u.index);for(let e,i,s,r,o,a=0;a<t.length;++a){o=t[a],r=14,u.row!=o.row&&u.col!=o.col||(r=10),i=u.g+r,e=i+new x(10,14)[n](o,c);let h=p.some((t=>o===t)),l=g.some((t=>o===t));h||l?o.f>e&&(o.f=e,o.g=i,o.h=s,o.parent=u):(o.f=e,o.g=i,o.h=s,o.parent=u,p.push(o))}if(g.push(u),0==p.length)return m;p=p.sort(((t,e)=>t.f-e.f)),u=p.shift()}if(0!=p.length){let t=c;for(m.push(t);t!==d;)t=t.parent,m.unshift(t)}return m},lineOfSight(e,i,s,n,o=0,a=32,d=[]){let u,p,g,m,f,y,x=c(e,i),v=r.len(x),w=h(v/a),b=[];for(let i,s=1;s<=w;++s)i=t.Sprites.centerXY(e),p=a*s,f=x[0]/v,y=x[1]/v,g=h(i[0]+f*p),m=h(i[1]+y*p),b.push({x:g,y:m,index:l(g,m,n)});return u=180*Math.atan2(x[1],x[0])/Math.PI,b.every((t=>s[t.index]==o))&&(0==d.length||d.some((t=>t==u)))},crossCells(t,e){const i=e.tiled.tilesInX;return[t-i,t-1,t+1,t+i]},getCrossTiles(t,e,i){return this.crossCells(t,i).map((t=>e[t]))},getDiagonalCells(t,e){const i=s.num(e)?e:e.tiled.tilesInX;return[t-i-1,t-i+1,t+i-1,t+i+1]},getDiagonalTiles(t,e,i){return this.getDiagonalCells(t,i).map((t=>e[t]))},validDirections(i,s,r,n){const o=this.getTileIndex(i,n);return this.getCrossTiles(o,s,n).map(((i,s)=>i==r?e[s]:t.NONE)).filter((e=>e!==t.NONE))},canChangeDirection(e=[]){let i=e.find((e=>e===t.UP)),s=e.find((e=>e===t.DOWN)),r=e.find((e=>e===t.LEFT)),n=e.find((e=>e===t.RIGHT));return 0==e.length||1==e.length||(i||s)&&(r||n)},randomDirection:(e=[])=>0==e.length?t.NONE:1==e.length?e[0]:e[i.randInt2(0,e.length-1)],closestDirection(e,i){const s=c(e,i);return o(s[0])<o(s[1])?s[1]<=0?t.UP:t.DOWN:s[0]<=0?t.LEFT:t.RIGHT}};return t.Tiles=v}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Tiles"]=function(t){return t.Tiles?t.Tiles:i(t)}}(this);