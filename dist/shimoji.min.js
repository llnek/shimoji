!function(t,e){"use strict";const i=["fnt"],s=["mp3","wav","ogg"],r=["ttf","otf","ttc","woff"],n=["jpg","png","jpeg","gif","webp"];function o(o,a){const{EventBus:h,dom:l,is:c,u:d}=t["io/czlab/mcfud/core"](),u=t["io/czlab/mcfud/vec2"](),p=t["io/czlab/mcfud/math"](),g=h(),m=Math.floor,f=1/15;let y=!1;class x extends PIXI.Container{constructor(){super(),this.m5={stage:!0}}onResize(t,e){this.children.forEach((i=>{i instanceof t.Scenes.SceneWrapper&&(i=i.children[0]),i.onCanvasResize(e[0],e[1])})),t.Input.resize()}}function w(){return window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth}function v(){return window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight}function b(t,e){let i=t.length;function s(){d.delay(0,(()=>e()))}function r(t){--i,0==i&&s()}return t.forEach((t=>{(async function(t){const e=await PIXI.DOMAdapter.get().fetch(t),i=await e.arrayBuffer(),s=t.lastIndexOf("/");return{name:s>0?t.substring(s+1):t,url:t,buffer:i}})(t).then((t=>{X.Sound.decodeData(t.name,t.url,t.buffer,r)}))})),0==i&&s(),i}function I(t){let e,i=[],n=0,o=t.u.load,a=[],h=[],u=[];t.u.assetFiles.forEach((e=>{c.obj(e)?d.has(r,d.fileExt(e.url))&&h.push(e):c.str(e)&&(e=t.assetPath(e),d.has(s,d.fileExt(e))?a.push(e):u.push(e))})),function(t){let e,i,s;t.forEach((t=>{s=l.newElm("style"),i=l.newElm("span"),e=`@font-face {font-family: '${t.family}'; src: url('${t.url}');}`,d.log(`loading fontface = ${e}`),l.conj(s,l.newTxt(e)),l.conj(document.head,s),i.innerHTML="?",l.css(i,"fontFamily",void 0),l.conj(document.body,i),l.css(i,{display:"block",opacity:"0"})}))}(h),o||(o=function(t){return{init(){let e=t.Sprites.sprite("boot/ZotohLab_x1240.png"),i=t.Sprites.sprite("boot/preloader_bar.png"),s=t.Sprites.sprite("boot/preloader_bar.png"),[r,n]=t.scaleXY([e.width,e.height],[t.width,t.height]),o=t.getScaleFactor(),a=r>n?n:r;a*=.2,t.Sprites.scaleXY(s,a,a),t.Sprites.scaleXY(i,a,a),t.Sprites.scaleXY(e,a,a),t.Sprites.pinCenter(this,e),t.Sprites.pinBelow(e,i,4*o),t.Sprites.pinBelow(e,s,4*o),t.Sprites.opacity(s,.3),this.insertEx([e,s,i]),this.g.pbar=i,this.g.pbar_width=i.width},update(t){this.g.pbar.width=this.g.pbar_width*t}}}(t));{const i=new t.Scenes.Scene("loader",{setup(){o.init.call(this)}},{});e=t.stage.addChild(i).runOnce()}return PIXI.Assets.load(u,(t=>{i.unshift(t)})).then((e=>{d.delay(0,(()=>function(e){function s(t){d.log(`loaded ${t}`)}b(a,(()=>{let r=0;for(const[i,n]of Object.entries(e))++r,s(i),t._cache[i]=n;a.forEach(s),d.log(`completed loading of ${r+a.length} files.`),i.unshift("$")}))}(e)))})).catch((t=>{++n,d.error(`Failed to load all assets: ${t}`)})),t.addBgTask({update(){if(0==i.length);else{let s=i.pop();c.num(s)?s&&o.update.call(e,s):"$"==s?d.delay(800,(()=>function(t,e,i,s){e&&t.delBgTask(e),d.delay(50,(()=>{t.Scenes.remove(i),s?d.error("Cannot load game!"):t._runAppStart()}))}(t,this,e,n>0))):d.error("Fatal error while loading assets")}}}),t.start()}d.patch(o,{assetFiles:[],logos:[],aniFps:12,fps:60});const T={width:0,height:0},_={width:1,height:1};function E(t){let e=l.newElm("style");l.conj(document.body,X._canvasObj),l.conj(e,l.newTxt("body, * {padding: 0; margin: 0; height:100%; overflow:hidden}")),l.conj(document.head,e),l.css(X._canvasObj,{outline:"none"}),l.attrs(X._canvasObj,"tabindex","0"),l.css(document.body,{background:"black"})}function C(t){X._curFPS=X.calcFPS(t),a.forEach((e=>e.update?.(t))),!y&&X.stageCS((e=>e.update?.(t)))}const P=e=>t.requestAnimationFrame(e);class M{constructor(t){this.uid=t}playSound(){}pokeMove(){this.onPoke()}pokeWait(){this.onWait()}uuid(){return this.uid}stateValue(){d.assert(!1,"implement stateValue!")}}const X={_offsetX:0,_offsetY:0,_scaleX:1,_scaleY:1,_selectedCellX:0,_selectedCellY:0,_startPanX:0,_startPanY:0,_curFPS:60,Bot:class extends M{constructor(t="p2"){super(t)}onPoke(){}onWait(){}},Local:class extends M{constructor(t="p1"){super(t)}onPoke(){X.Input.resume()}onWait(){X.Input.pause()}},Mediator:class{constructor(){this.players=[],this._pcnt=0,this.state,this.pcur,this.end,this.pwin}cur(){return this.pcur}add(t){return t.pnum=++this._pcnt,t.owner=this,this.players.push(t),this}winner(){return this.pwin}isGameOver(){return this.end}gameState(t){return t&&(this.state=t),this.state}gameOver(t){return X.Input.resume(),this.pwin=t,this.end=!0}start(t){d.assert(t,"bad player to start with"),this.end=!1,this.pcur=t,this._turn()}other(){return this.pcur===this.players[0]?this.players[1]:this.pcur===this.players[1]?this.players[0]:void 0}_turn(){this.players.forEach((t=>{t!==this.pcur&&t.pokeWait()})),this.pcur.pokeMove()}redoTurn(){this.pcur.pokeMove()}postMove(t,e){d.assert(!1,"implement postMove!")}updateState(t,e){d.assert(!1,"implement updateState!")}updateSound(t){}updateMove(t,e){this.end||(this.updateState(t,e),this.updateSound(t),d.delay(0,(()=>this.postMove(t,e))))}takeTurn(){this.end||(this.pcur===this.players[0]?this.pcur=this.players[1]:this.pcur===this.players[1]&&(this.pcur=this.players[0]),this._turn())}},SSheetFrame:class{#t;#e;constructor(t,e){this.#t=t,this.#e=e}get frame(){return this.#e}get sheet(){return this.#t}toString(){return`${this.#t}::${this.#e}`}},UNSCII:"unscii",DOKI_LOWER:"Doki Lowercase",BIGSHOUTBOB:"Big Shout Bob",COPYRIGHT:"(c) www.zotohlab.com 2022-2024.",_frame:1/o.fps,EVERY:1,SOME:2,CENTER:3,TOP:4,LEFT:5,RIGHT:6,BOTTOM:7,UP:8,DOWN:9,NW:10,NE:11,SW:12,SE:13,NONE:100,PI_45:Math.PI/4,PI_90:Math.PI/2,PI_180:Math.PI,PI_270:1.5*Math.PI,PI_360:2*Math.PI,v2:u,math:p,ute:d,is:c,dom:l,u:o,Game:{mode:1},_cache:{},MODE_ONE:1,MODE_TWO:2,MODE_NET:3,CON:console,noop:()=>{},warn(...t){console.warn(...t)},get mouse(){return X.Input.pointer()},playSfx(t){return this.sound(t).play()},accel:(t,e,i)=>t+e*i,on:(...t)=>g.sub(...t),emit:(...t)=>g.pub(...t),off:(...t)=>g.unsub(...t),ssf(t,e){return new this.SSheetFrame(t,e)},frameRate(){return this._frame},sideRight:t=>t==X.RIGHT||t==X.NE||t==X.SE,sideLeft:t=>t==X.LEFT||t==X.NW||t==X.SW,sideTop:t=>t==X.UP||t==X.TOP||t==X.NW||t==X.NE,sideBottom:t=>t==X.DOWN||t==X.BOTTOM||t==X.SW||t==X.SE,overlap:(t,e)=>!(t.x2<e.x1||e.x2<t.x1||t.y2<e.y1||e.y2<t.y1),overlapX:(t,e)=>t.x2>e.x1&&e.x2>t.x1,overlapY:(t,e)=>t.y2>e.y1&&e.y2>t.y1,hasClass(t,e){if(e)return t.classList.contains(e)},toggleClass:(t,e)=>(e&&t.classList.toggle(e),t),addClass:(t,e)=>(d.hasClass(t,e)||t.classList.add(e),t),removeClass:(t,e)=>(d.hasClass(t,e)&&t.classList.remove(e),t),wrapv:(t,e,i)=>t<e?i:t>i?e:t,get canvas(){return this._canvasObj},get assets(){return PIXI.Assets.cache._cache},get designSize(){return this.u.arena},get width(){return this.canvas.width},get height(){return this.canvas.height},stageCS(t){this.inModal?t(d.last(this.stage.children)):this.stage.children.forEach((e=>{e instanceof X.Scenes.SceneWrapper&&(e=e.children[0]),e&&t(e)}))},moveToTop(t){let e=t.parent;return e&&(e.removeChild(t),e.addChild(t)),t},scroll(e,i){t.scrollTo(e||0,i||1)},portrait:()=>X.height>X.width,screenCenter:()=>d.v2(m(X.width/2),m(X.height/2)),scaleXY:(t,e)=>[e[0]/t[0],e[1]/t[1]],makeAnchor(t,e){return new PIXI.ObservablePoint(this,t,e??t)},mockStage(t=0,e=0,i,s){let r=c.obj(t)?t:{x:t,y:e,width:i??X.width,height:s??X.height};return r.getGlobalPosition=()=>({x:this.x,y:this.y}),r.anchor=X.makeAnchor(0,0),r.m5={stage:!0},r},tcached(t){return d.inst(PIXI.Texture,t)?t:c.str(t)?this._cache[t]||PIXI.Assets.cache._cache.get(t):e},clickPlayMsg(){return(this.touchDevice?"Tap":"Click")+" to Play!"},splitXY:(t,e)=>[t%e,m(t/e)],rect:(t,e,i,s)=>new PIXI.Rectangle(t,e,i,s),scaleSZ:(t,e)=>({width:e.width/t.width,height:e.height/t.height}),sheet(t,e){const i=this.resource(t);return d.assert(i,`unknown sheet: ${t}.`),d.assert(c.obj(i.data)&&c.obj(i.textures),`bad sheet: ${t}`),i.textures[e]},image(t){return this.resource(t)},xml(t){return this.resource(t)},json(t){return this.resource(t)},assetPath(t,e){if(c.str(t))if(t.includes("/"))e=t;else{let o="data",a=d.fileExt(t);d.has(n,a)?o="images":d.has(i,a)||d.has(r,a)?o="fonts":d.has(s,a)&&(o="audio"),e=`${o}/${t}`}return e||""},contentScaleFactor(){return T.height=X.height,T.width=X.width,"max"!==o.scaleToWindow?_:this.scaleSZ(this.designSize,T)},getScaleFactor(t){if(t||"max"==o.scaleToWindow){T.height=X.height,T.width=X.width;let t=this.scaleSZ(this.designSize,T);return"x"==o.scaleFit||"X"==o.scaleFit?t.width:"y"==o.scaleFit||"Y"==o.scaleFit?t.height:Math.min(t.width,t.height)}return 1},resource(t,i){let s,r;return d.inst(this.SSheetFrame,t)?r=this.sheet(t.sheet,t.frame):t&&(s=this.assetPath(t),r=this.tcached(t)||this.tcached(s)||PIXI.Texture.from(s)),r||(i?d.assert(!1,`no such resource ${t}.`):e)},addChild:(t,e,...i)=>(t.addChild(e),i.forEach((e=>t.addChild(e))),e),_fpsList:e,_fpsSum:0,calcFPS(t){let e,i=0;return t>0&&(e=m(1/t),this._fpsList||(this._fpsList=d.fill(60,e),this._fpsSum=60*e),this._fpsSum-=this._fpsList.pop(),this._fpsList.unshift(e),this._fpsSum+=e,i=m(this._fpsSum/60)),i},degToRad:t=>t*(Math.PI/180),radToDeg:t=>t*(180/Math.PI),addBgTask(t){a.push(t)},delBgTask(t){t&&(d.disj(a,t),t.dispose&&t.dispose())},resume(){y=!1},pause(){y=!0},start(){let t=0,e=d.now(),i=function(){let s=d.now(),r=(s-e)/1e3,n=X.frameRate();for(r>f&&(r=f),t+=r;t>=n;t-=n)C(r);X.ctx.render(X.stage),e=s,P(i)};return P(i)},_runAppStart(){return X.Input.keybd(X.Input.Q,(()=>{this.takeScreenShot()})),X.u.start(this)},takeScreenShot(){X.ctx.extract.canvas(X.stage).toBlob((t=>{const e=document.createElement("a");document.body.append(e),e.download="screenshot",e.href=URL.createObjectURL(t),e.click(),e.remove()}),"image/png")},worldToScreen(t,e){return[m((t-this._offsetX)*this._scaleX),m((e-this._offsetY)*this._scaleY)]},screenToWorld(t,e){return[t/this._scaleX+this._offsetX,e/this._scaleY+this._offsetY]}};{let e,i=PIXI.isMobile.tablet,s=PIXI.isMobile.phone;e=PIXI.isMobile.windows.device?i?"tablet":s?"phone":"windows":PIXI.isMobile.apple.device?i?"ipad":s?"iphone":"apple":PIXI.isMobile.android.device?"android":i||s?"mobile":"desktop",d.log(`we are running on a ${e} device`),function(e){let i=!1,s=o.arena;d.assert(s,"design resolution req'd."),"max"!=o.scaleToWindow&&!0!==o.scaleToWindow||(i=!0,s={width:w(),height:v()},1==o.arena.scale&&(i=!1,o.arena=s,o.scaleToWindow="win")),e.maxed=i,o.logos||(o.logos=new Array),(async()=>{e.ctx=await PIXI.autoDetectRenderer(d.inject(s,{webgpu:{antialias:!0},webgl:{antialias:!0}})),function(e,i){e.touchDevice=!!("ontouchstart"in document),e._canvasObj=e.ctx.canvas,e._canvasObj.id="mojoh5",e.scale=1,e.scaledBgColor="#5A0101",e.stage=new x,["Sprites","Input","Scenes","Sound","FX","Ute2D","Tiles","Touch"].forEach((i=>{d.log(`installing module ${i}...`),t[`io/czlab/mojoh5/${i}`](e).assets?.forEach((t=>e.u.assetFiles.unshift(t)))})),a.push(e.FX),E(),d.has(i,"border")&&l.css(e.canvas,"border",i.border),d.has(i,"bgColor")&&(e.ctx.backgroundColor=e.Sprites.color(i.bgColor)),e.prevHeight=0,e.prevWidth=0,!0===i.resize&&(d.addEvent("resize",t,d.debounce((t=>{const[i,s]=[e.prevWidth,e.prevHeight];e.ctx.resize(w(),v()),e.emit(["canvas.resize"],[i,s]),e.prevWidth=w(),e.prevHeight=v()}),i.debounceRate||150)),e.on(["canvas.resize"],(t=>S.onResize(e,t)))),function(t){d.log(`browser window size= w:${w()},h=${v()}`),d.log(`canvas size= w:${t.canvas.width},h=${t.canvas.height}`),t._canvasObj.focus(),t.scroll(),t.prevHeight=v(),t.prevWidth=w(),t.u.load||(t.u.logos=["boot/preloader_bar.png","boot/ZotohLab_x1240.png"]);let e=t.u.logos.map((e=>t.assetPath(e)));PIXI.Assets.init(),(async(i,s)=>{try{i=await PIXI.Assets.load(e),s=Object.keys(i)}catch(t){d.error(t)}s&&e.length==s.length?(s.forEach((t=>d.log(`loaded logo file "${t}"`))),d.delay(50,(()=>I(t)))):d.log("logo files not loaded!")})()}(e)}(e,o)})()}(X)}}if("object"==typeof module&&module.exports)throw"Panic: browser only!";t.MojoH5=function(t){return o(t,[])},t.MojoH5Ldr=function(e){window.addEventListener("load",(()=>t.MojoH5(e)))}}(this),function(t,e){"use strict";const i={blue:"#319bd5",green:"#78c03f",yellow:"#f9ef50",red:"#eb2224",orange:"#f48917",grey:"#848685",cyan:"#1ee5e6",lime:"#e5e61e",magenta:"#e61ee5",purple:"#a6499a"},s={aqua:"#00FFFF",black:"#000000",blue:"#0000FF",brown:"#A52A2A",crimson:"#DC143C",cyan:"#00FFFF",fuchsia:"#FF00FF",gray:"#808080",green:"#008000",grey:"#808080",lavender:"#E6E6FA",lime:"#00FF00",magenta:"#FF00FF",maroon:"#800000",navy:"#000080",olive:"#808000",orange:"#FFA500",purple:"#800080",red:"#FF0000",silver:"#C0C0C0",teal:"#008080",turquoise:"#40E0D0",wheat:"#F5DEB3",white:"#FFFFFF",yellow:"#FFFF00"};function r(r){const{v2:n,math:o,ute:a,is:h,dom:l}=r,c=t["io/czlab/mcfud/geo2d"](),d=2*Math.PI,u=Math.floor;function p(t,e,i,s){return new PIXI.GenerateTextureSystem(r.ctx).generateTexture(t)}var g,m,f;function y(t,i){let s,n;return a.inst(PIXI.Graphics,t)&&(t=p(t)),a.inst(PIXI.Texture,t)?n=t:h.vec(t)?(h.str(t[0])&&(t=t.map((t=>r.resource(t)))),s=a.inst(PIXI.Texture,t[0])?new PIXI.AnimatedSprite(t,!1):e):h.str(t)&&(n=r.resource(t)),n&&(s=i(n)),a.assert(s,`SpriteError: ${t} not found`)&&s}function x(t,e,i,s,r,n){let o=e,a=t,h=[];for(let e,l,c,d=0;d<i;++d){c=[];for(let t=0;t<s;++t)l=o+n,e=a+r,c.push({x1:a,x2:e,y1:o,y2:l}),a=e;o=l,a=t,h.push(c)}return h}function w(t,e,i){let s,n;return e&&e.m5&&e.m5.stage?n={x1:0,y1:0,x2:r.width,y2:r.height}:(void 0!==e.angle&&a.assert(a.feq0(e.angle),"expected non rotated object!"),s=e.parent,n=t.getAABB(e)),i&&s===i&&(n.x1+=i.x,n.x2+=i.x,n.y1+=i.y,n.y2+=i.y),[n,o.ndiv(n.x2-n.x1,2),o.ndiv(n.y2-n.y1,2),o.ndiv(n.x1+n.x2,2),o.ndiv(n.y1+n.y2,2)]}function v(t,e,i){if(e.m5.static)n.sub$(t.m5.vel,n.mul(i.overlapN,2*n.dot(t.m5.vel,i.overlapN)));else{let s=n.mul$(n.sub(e.m5.vel,t.m5.vel),i.overlapN),r=-2*(s[0]+s[1])/(t.m5.invMass+e.m5.invMass);n.sub$(t.m5.vel,n.mul$(n.div(i.overlapN,t.m5.mass),r)),n.add$(e.m5.vel,n.mul$(n.div(i.overlapN,e.m5.mass),r))}}function S(t,e,i){let s,r=t.toBody(e),n=t.toBody(i);return s=e.m5.circle?i.m5.circle?c.hitCircleCircle(r,n):c.hitCirclePolygon(r,n):i.m5.circle?c.hitPolygonCircle(r,n):c.hitPolygonPolygon(r,n),s&&(s.A=e,s.B=i),s}g=new PIXI.Container,(m=new PIXI.Graphics).circle(0,0,4),m.fill({color:0}),f=new PIXI.Sprite(p(m)),["m5","tiled","remove","collideXY","setup","preTMX","postTMX","dispose","preDispose","onTick","getGuid","getBBox","getSpatial"].forEach((t=>{[[g,"Container"],[m,"Graphics"],[f,"Sprite"]].forEach((e=>{a.assertNot(a.has(e[0],t),`Uh Oh, PIXI ${e[1]} has our ${t} property!`)}))}));const b={SomeColors:{},BtnColors:{},Geo:c,assets:["boot/splash.jpg","boot/star.png","boot/audioOff.png","boot/audioOn.png","boot/unscii.fnt","boot/doki.fnt","boot/BIG_SHOUT_BOB.fnt"],assertCenter:t=>a.assert(t?.anchor&&a.feq(t.anchor.x,.5)&&a.feq(t.anchor.y,.5),"not center'ed"),empty:t=>t&&0==t.children.length,btnPress(t,e,i,s,n,o=343){const h=this;return function(t){t.tint=h.color(e),s&&r.sound(s).play(),a.delay(o,(()=>{t.tint=h.color(i),n(t)}))}},oneOffClick(t,e){const i=function(){r.Input.off(["single.tap"],i),e&&r.sound(e).play(),t()};return r.Input.on(["single.tap"],i),i},cancelOneOffClick:t=>(t&&r.Input.off(["single.tap"],t),e),sizeXY:(t,e,i)=>(h.num(i)&&(t.height=i),h.num(e)&&(t.width=e),t),asCircle:t=>(t.m5.circle=!0)&&t,scaleXY:(t,e,i)=>(h.num(e)&&(t.scale.x=e),h.num(i)&&(t.scale.y=i),t),scaleBy:(t,e,i)=>(h.num(e)&&(t.scale.x*=e),h.num(i)&&(t.scale.y*=i),t),isVX:t=>!a.feq0(t.m5.vel[0]),isVY:t=>!a.feq0(t.m5.vel[1]),halfSize:t=>({width:u(t.width/2),height:u(t.height/2)}),anchorXY:(t,e,i)=>(a.assert(t.anchor,"sprite has no anchor object"),t.anchor.y=i??e,t.anchor.x=e,t),centerAnchor(t){return this.anchorXY(t,.5,.5)},topLeftAnchor(t){return this.anchorXY(t,0,0)},offsetXY:(t,e,i)=>(a.assert(t.anchor&&e>=0&&e<=1&&i>=0&&i<=1,"no anchor or bad target offset points"),[t.width*(e-t.anchor.x),t.height*(i-t.anchor.y)]),topLeftOffsetXY(t){return this.offsetXY(t,0,0)},centerOffsetXY(t){return this.offsetXY(t,.5,.5)},adjOffsetXY:(t,e,i)=>(a.assert(t.anchor&&e>=0&&e<=1&&i>=0&&i<=1,"no anchor or bad target offset points"),[t.width*(t.anchor.x-e),t.height*(t.anchor.y-i)]),makeSteerable(t){t.width!=t.height&&r.warn(`object ${t.m5?.uuid} is not a square, radius will be off....`);let{width:e,height:i}=this.halfSize(t);return t.m5.steer=[0,0],t.m5.steerInfo={wanderAngle:a.rand()*Math.PI*2,arrivalThreshold:400,wanderDistance:10,wanderRadius:5,wanderRange:1,avoidDistance:400,inSightDistance:200,tooCloseDistance:60,maxForce:5,pathIndex:0},t.m5.radius=Math.sqrt(e*e+i*i),t},updateSteer:(t,e=!0)=>(t.m5?.steer&&(n.clamp$(t.m5.steer,0,t.m5.steerInfo.maxForce),n.div$(t.m5.steer,t.m5.mass),n.add$(t.m5.vel,t.m5.steer),e&&n.mul$(t.m5.steer,0)),t),clrSpatial:t=>(t.m5?.sgrid&&(t.m5.sgrid.x1=e,t.m5.sgrid.x2=e,t.m5.sgrid.y1=e,t.m5.sgrid.y2=e),t),lift(t){if(!t.m5){const e=this;t.g={},t.m5={uuid:`s${a.nextId()}`,circle:!1,stage:!1,drag:!1,dead:!1,angVel:0,friction:n.vec(1,1),gravity:n.vec(),vel:n.vec(),acc:n.vec(),static:!1,sensor:!1,sgrid:{},mass:1,type:0,cmask:0,speed:0,heading:r.RIGHT,get invMass(){return a.feq0(t.m5.mass)?0:1/t.m5.mass}},t.m5.resize=function(i,s,r,n){e.resize(t,i,s,r,n)},t.m5.getImageOffsets=function(){return{x1:0,x2:0,y1:0,y2:0}},t.m5.getContactPoints=function(){return function(t,e,i){let s=[n.vec(e,i),n.vec(e,0),n.vec(0,0),n.vec(0,i)];return t&&s.forEach((s=>{s[0]-=u(e*t.x),s[1]-=u(i*t.y)})),s}(t.anchor,t.width,t.height)},t.getGuid=function(){return t.m5.uuid},t.getSpatial=function(){return t.m5.sgrid},t.getBBox=function(){return a.feq0(t.angle)?e.getAABB(t):e.boundingBox(t)}}return t},clamp2Pi(t){for(;t.rotation>d;)t.rotation-=d;for(;t.rotation<0;)t.rotation+=d;return t},getHeading:t=>[Math.cos(t.rotation),Math.sin(t.rotation)],setOrient:(t,e,i=!1)=>(i?t.angle=e:t.rotation=e,t),toPolygon:t=>new c.Polygon(t.m5.getContactPoints()).setOrient(t.rotation),toCircle(t){return this.assertCenter(t)&&new c.Circle(u(t.width/2)).setOrient(t.rotation)},toBody(t){let e=t.x,i=t.y,s=t.m5.circle?this.toCircle(t):this.toPolygon(t);return c.bodyWrap(s,e,i)},gposXY(t){const{x:e,y:i}=t.getGlobalPosition();return n.vec(e,i)},isTopLeft:t=>!t.anchor||a.feq0(t.anchor.x)&&a.feq0(t.anchor.y),isCenter:t=>!!t.anchor&&(a.feq(t.anchor.x,.5)&&a.feq(t.anchor.y,.5)),centerXY(t){return this.isCenter(t)?n.vec(t.x,t.y):n.add(this.centerOffsetXY(t),t)},setScaleModeNearest:(t,e=!0)=>(t.texture.source.scaleMode=e?"nearest":"linear",t),angle(t,e){return n.angle(this.centerXY(t),this.centerXY(e))},die:t=>(t.m5.dead=!0)&&t,undie:t=>(t.m5.dead=!1)||t,move:(t,e)=>(e?(n.add$(t.m5.vel,n.mul(t.m5.gravity,e)),n.add$(t.m5.vel,n.mul(t.m5.acc,e)),n.mul$(t.m5.vel,t.m5.friction)):e=1,void 0!==t.m5.maxSpeed&&n.clamp$(t.m5.vel,0,t.m5.maxSpeed),n.add$(t,n.mul(t.m5.vel,e))),leftSide(t){let e=t.x,i=t.width,s=t.anchor?t.anchor.x:0;return s>.7?e-=i:s>0&&(e-=u(i/2)),e},rightSide(t){return this.leftSide(t)+t.width},topSide(t){let e=t.y,i=t.height,s=t.anchor?t.anchor.y:0;return s>.7?e-=i:s>0&&(e-=u(i/2)),e},bottomSide(t){return this.topSide(t)+t.height},getAABB(t){if(void 0!==t.x1&&void 0!==t.y2)return t;a.assert(t.m5,"bad sprite for getAABB");let{x1:e,y1:i,x2:s,y2:r}=t.m5.getImageOffsets(),n=this.leftSide(t),o=this.topSide(t);return{x1:n+e,y1:o+i,x2:n+t.width-s,y2:o+t.height-r}},bbox4:(t,e,i,s)=>a.assert(i<=s,"bad bbox")&&{x1:t,x2:e,y1:i,y2:s},bboxCenter(t){if(h.num(t.x1))return n.vec(o.ndiv(t.x1+t.x2,2),o.ndiv(t.y1+t.y2,2))},bboxFrame(t,e=16,i="#dedede"){a.assert(void 0!==t.x1,"bad bounding box");let s,{x1:r,x2:n,y1:o,y2:h}=t,l=n-r,c=h-o,d=this.graphics();return d.roundRect(0,0,l+e,c+e,u(e/4)),d.stroke({width:e,color:this.color(i)}),s=this.sprite(d),s.x=r-e,s.y=o-e,s},bboxSize:t=>void 0!==t.x1?n.vec(t.x2-t.x1,t.y2-t.y1):a.assert(!1,"bad bounding box"),pointInBBox:(t,e,i)=>void 0!==i.x1&&t>i.x1&&t<i.x2&&e>i.y1&&e<i.y2,boundingBox(t){a.feq0(t.rotation)||a.assert(this.isCenter(t),"expected rotated obj with center-anchor");let e,i,s=[],r=[],n=u(t.width/2),o=u(t.height/2),h=Math.tanh(o/n),l=Math.sqrt(n*n+o*o);return i=d-h+t.rotation,r.push(l*Math.sin(i)),s.push(l*Math.cos(i)),i=h+t.rotation,r.push(l*Math.sin(i)),s.push(l*Math.cos(i)),i=Math.PI-h+t.rotation,r.push(l*Math.sin(i)),s.push(l*Math.cos(i)),i=Math.PI+h+t.rotation,r.push(l*Math.sin(i)),s.push(l*Math.cos(i)),e=this.centerXY(t),r.sort(((t,e)=>t-e)),s.sort(((t,e)=>t-e)),{x1:u(s[0]+e[0]),x2:u(s[3]+e[0]),y1:u(r[0]+e[1]),y2:u(r[3]+e[1])}},hitTestPoint(t,e,i){const s=this.toBody(i);return i.m5.circle?c.hitTestPointCircle(t,e,s):c.hitTestPointPolygon(t,e,s)},distance(t,e){return n.dist(this.centerXY(t),this.centerXY(e))},scaleContent(...t){1==t.length&&h.vec(t[0])&&(t=t[0]);const e=r.getScaleFactor();t.forEach((t=>{t.scale.x*=e,t.scale.y*=e}))},scaleToCanvas:t=>(t.height=r.height,t.width=r.width,t),uuid:(t,e)=>(t.m5.uuid=e,t),opacity:(t,e)=>(t.alpha=e,t),tint(t,e){return t.tint=this.color(e),t},hide:t=>(t.visible=!1)||t,show:t=>(t.visible=!0)&&t,pset:(t,e,i)=>(t.g[e]=i,t),pget:(t,e)=>t.g[e],container(t){const e=this.lift(new PIXI.Container);return t&&t(e),e},group(...t){const e=this.container();return t.forEach((t=>e.addChild(t))),e},sprite(t,e=!1,i=0,s=0){const n=this.lift(y(t,(t=>new PIXI.Sprite(t))));return n.x=i,n.y=s,e&&this.centerAnchor(n),a.inst(PIXI.AnimatedSprite,n)?function(t){let e=0,i={};function s(){e&&(e=clearInterval(e))}function n(){i.cnt<i.total?(t.gotoAndStop(t.currentFrame+1),i.cnt+=1):t.loop?(t.gotoAndStop(i.start),i.cnt=1):(s(),t.onComplete?.())}return a.inject(t.m5,{stopFrames(){s(),t.gotoAndStop(t.currentFrame)},showFrame(e){s(),t.gotoAndStop(e)},playFrames(o){s(),i.start=0,i.end=t.totalFrames-1,h.vec(o)&&o.length>1&&(i.start=o[0],i.end=o[1]),i.total=i.end-i.start+1,t.gotoAndStop(i.start),i.cnt=1,e=setInterval(n,1e3/r.aniFps)}}),t}(n):n},spriteFrame(t,e,i=!1,s=0,n=0){return this.sprite(r.sheet(t,e),i,s,n)},tilingSprite(t,e,i){return this.lift(y(t,(t=>new PIXI.TilingSprite({texture:t,width:e||t.width,height:i||t.height}))))},repeatSprite(t,e=!0,i=!0,s,o){let a,h=this,l=[],c=0,d=0,u=0,p=0;function g(){const e=h.lift(y(t,(t=>new PIXI.Sprite(t))));let i=r.getScaleFactor();return i=1,e.width*=1,e.height*=1,e}if(e){for(;u<s;)l.push(a=g()),n.set(a,c,d),u+=a.width,c+=a.width,u>=s&&p<o&&i&&(p+=a.height,d+=a.height,c=0,u=0);i=!1}if(i){for(;p<o;)l.push(a=g()),n.set(a,c,d),p+=a.height,d+=a.height,p>=o&&u<s&&e&&(u+=a.width,c+=a.width,d=0,p=0);e=!1}return l},animation(t,e,i,s=0){let o=r.resource(t);if(!o)throw`SpriteError: ${t} not loaded.`;let a=u(o.width/e),h=[],l=a*u(o.height/i);for(let t,r,o=0;o<l;++o)t=o%a*e,r=u(o/a)*i,s>0&&(t+=s+s*o%a,r+=s+s*u(o/a)),h.push(n.vec(t,r));return this.sprite(h.map((t=>new PIXI.Texture({source:o.source,frame:new PIXI.Rectangle(t[0],t[1],e,i)}))))},frame(t,e,i,s,n){return this.sprite(new PIXI.Texture({source:r.resource(t).source,frame:new PIXI.Rectangle(s,n,e,i)}))},frameSelect:(t,e,i,s)=>s.map((s=>new PIXI.Texture({source:r.resource(t).source,frame:new PIXI.Rectangle(s[0],s[1],e,i)}))),frames(t,e,i,s=0,n=0,a=0,h=0){let l=e+s,c=i+n,d=r.resource(t),p=u(d.height/c),g=[],m=o.ndiv(d.width+s,l);for(let t,s=0;s<p;++s){t=h+i*s;for(let s,r=0;r<m;++r)s=a+e*r,g.push(new PIXI.Texture({source:d.source,frame:new PIXI.Rectangle(s,t,e,i)}))}return g},frameImages:(...t)=>(1==t.length&&h.vec(t[0])&&(t=t[0]),t.map((t=>r.resource(t)))),spriteFrom(...t){return this.sprite(this.frameImages(...t))},text(t,e,i=0,s=0){return n.set(this.lift(new PIXI.Text(t||"",e)),i,s)},bitmapText(t,e,i){let s;return h.str(e)?(s={fontFamily:e},h.num(i)&&(s.fontSize=i)):s=e,s.fontFamily||(s.fontFamily=s.fontName?s.fontName:"unscii"),s.align||(s.align="center"),this.lift(new PIXI.BitmapText({text:t||"",style:s}))},triangle(t,e,i,s=16777215,r=16777215,o=0,a=0,l=0){let c=this.graphics(),d=1,p=u(t/2),g=this.color(r),m=i<.5?0:i>.5?t:p;!1!==s&&h.vec(s)&&(d=s[1],s=s[0]),c.poly([0,0,m,-e,t,0]),!1!==s&&c.fill({color:this.color(s),alpha:d}),o>0&&c.stroke({width:o,color:g,alpha:1});let f=this.sprite(c);return f.m5.getContactPoints=e<0?()=>[[m,-e],[t,0],[0,0]]:()=>[[t,e],[m,0],[0,e]],n.set(f,a,l)},rect(t,e,i=16777215,s=16777215,r=0){return this.sprite(this.rectTexture(t,e,i,s,r))},grect:(t,e,i,s,r)=>(t.rect(e,i,s,r),t),gcircle:(t,e,i,s)=>(t.circle(e,i,s),t),gfillEx:(t,e,i)=>(i||(i={}),i.texture=e,t.texture(i),t),gclear:t=>t.clear(),gpath:(t,e)=>(a.assert(h.vec(e),"expected path actions!"),e.forEach((e=>{h.vec(e)?t[e.shift()].apply(t,e):h.str(e)&&t[e]()})),t),gfill:(t,e)=>(a.assert(h.obj(e),"expected fill style object"),t.fill(e),t),gstroke:(t,e)=>(a.assert(h.obj(e),"expected stroke style object"),t.stroke(e),t),rectTexture(t,e,i=16777215,s=16777215,r=0){let n,o=this.graphics();return!1!==i&&(h.vec(i)?(n=i[1],i=i[0]):n=1),o.rect(0,0,t,e),!1!==i&&o.fill({color:this.color(i),alpha:n}),r>0&&o.stroke({width:r,color:this.color(s)}),this.genTexture(o)},drawBody(t,...e){const i=this.graphics();return t.apply(this,[i].concat(e)),this.lift(new PIXI.Sprite(this.genTexture(i)))},circle(t,e=16777215,i=16777215,s=0){return this.circleEx(this.circleTexture(t,e,i,s))},circleTexture(t,e=16777215,i=16777215,s=0){let r,n=this.graphics();return!1!==e&&(h.vec(e)?(r=e[1],e=e[0]):r=1),n.circle(0,0,t),!1!==e&&n.fill({color:this.color(e),alpha:r}),s>0&&n.stroke({width:s,color:this.color(i)}),this.genTexture(n)},circleEx(t){const e=this.lift(new PIXI.Sprite(t));return(e.m5.circle=!0)&&this.centerAnchor(e)},line(t,e,i,s,r=1){let o,a=n.clone(i),h=n.clone(s),l=this.graphics(),c=this.color(t);function d(){l.clear(),l.moveTo(a[0],a[1]),l.lineTo(h[0],h[1]),l.stroke({width:e,color:c,alpha:r})}return d(),o=this.lift(l),o.m5.ptA=function(t,e){return void 0!==t&&(a[0]=t,a[1]=e??t,d()),a},o.m5.ptB=function(t,e){return void 0!==t&&(h[0]=t,h[1]=e??t,d()),h},o},isMoving:t=>!a.feq0(t.m5.vel[0])||!a.feq0(t.m5.vel[1]),makeCells(t,e,i,s,r,n){let a=o.ndiv(i-t,r);return x(t,e,o.ndiv(s-t,n),a,r,n)},gridBox(t=.9,e=.9,i){let s=i??r,n=u(s.height*e),a=u(s.width*t),h=o.ndiv(s.width-a,2),l=o.ndiv(s.height-n,2);return{x1:h,y1:l,x2:h+a,y2:l+n}},gridSQ(t,e=.9,i){let s=e*(r.height<r.width?r.height:r.width),n=u(s/t),h=n;a.isEven(n)||--n,h=n,s=t*n;let l=o.ndiv(r.height-s,2),c=o.ndiv(r.width-s,2),d=c,p=l;return i&&(i.height=s,i.width=s,void 0!==i.x&&(d=i.x),void 0!==i.y&&(p=i.y),i.x=c,i.y=l,i.x1=c,i.y1=l,i.x2=c+s,i.y2=l+s),x(d,p,t,t,n,h)},divXY([t,e],i=.9,s=.9,n){let a,h,l,c,d=u(r.height*s),p=u(r.width*i),g=u(p/t),m=u(d/e);return d=e*m,p=t*g,l=o.ndiv(r.height-d,2),c=o.ndiv(r.width-p,2),a=c,h=l,n&&(n.height=d,n.width=p,void 0!==n.x&&(a=n.x),void 0!==n.y&&(h=n.y),n.x=c,n.y=l,n.x1=c,n.y1=l,n.x2=c+p,n.y2=l+d),x(a,h,e,t,g,m)},gridXY([t,e],i=.9,s=.9,n){let h,l,c,d,p=u(r.height*s),g=u(r.width*i),m=u(g/t),f=u(p/e),y=m>f?f:m;return a.isEven(y)||--y,p=e*y,g=t*y,c=o.ndiv(r.height-p,2),d=o.ndiv(r.width-g,2),h=d,l=c,n&&(n.height=p,n.width=g,void 0!==n.x&&(h=n.x),void 0!==n.y&&(l=n.y),n.x=d,n.y=c,n.x1=d,n.y1=c,n.x2=d+g,n.y2=c+p),x(h,l,e,t,y,y)},gridBBox(t,e,i){let s=i[0].length,r=i[0][0],n=i[i.length-1][s-1];return{x1:t+r.x1,x2:t+n.x2,y1:e+r.y1,y2:e+n.y2}},graphics(t){const e=new PIXI.Graphics;return(e.m5={uuid:`${t||a.nextId()}`})&&e},drawGridBox(t,e=1,i="white",s){return s||(s=this.graphics()),s.rect(t.x1,t.y1,t.x2-t.x1,t.y2-t.y1),s.stroke({width:e,color:this.color(i)}),s},drawGridBoxEx(t,e=1,i="white",s=1,r){return r||(r=this.graphics()),r.roundRect(t.x1,t.y1,t.x2-t.x1,t.y2-t.y1,s),r.stroke({width:e,color:this.color(i)}),r},drawGridLines(t,e,i,s,r,n){let o=i.length,a=i[0].length;n||(n=this.graphics());for(let s,r=1;r<o;++r)s=i[r],n.moveTo(t+s[0].x1,e+s[0].y1),n.lineTo(t+s[a-1].x2,e+s[a-1].y1);for(let s,r=1;r<a;++r)s=i[0],n.moveTo(t+s[r].x1,e+s[r].y1),s=i[o-1],n.lineTo(t+s[r].x1,e+s[r].y2);return h.obj(r)?(r.color=this.color(r.color||"white"),r.width=s,n.stroke(r)):n.stroke({width:s,color:this.color(r)}),n},add:(t,...e)=>(e.forEach((e=>e&&t.addChild(e))),t),remove:(...t)=>(1==t.length&&h.vec(t[0])&&(t=t[0]),a.doseqEx(t,(t=>{t.parent&&(a.inst(r.Scenes.Scene,t.parent)?t.parent.remove(t):t.parent.removeChild(t)),r.emit(["post.remove",t]),r.off(t),t.m5.dispose?.()})),t[0]),centerObj(t){let e=t.anchor,i=r.width/2,s=r.height/2,n=t.width/2,o=t.height/2;return t.x=i,t.y=s,e||(e={x:0,y:0}),e.x<.3&&(t.x=i-n),e.x>.7&&(t.x=i+n),e.y<.3&&(t.y=s-o),e.y>.7&&(t.y=s+o),t},fillMax(t){return(h.str(t)||a.inst(PIXI.Texture,t))&&(t=this.sprite(t)),a.assert(a.inst(PIXI.Container,t),"expected sprite"),t.height=r.height,t.width=r.width,this.centerObj(t)},colorToRgbA(t){a.assert(h.str(t)&&t.length>0,"bad color string value");let e,i=t.toLowerCase(),r=s[i];if("transparent"==i)return[0,0,0,0];if(r&&(t=r),"#"==t[0]){if((e=t.split("")).shift(),3==e.length&&e.push("F"),4==e.length&&(e=e.flatMap((t=>[t,t]))),6==e.length&&e.push("F","F"),8==e.length)return[parseInt(e[0]+e[1],16),parseInt(e[2]+e[3],16),parseInt(e[4]+e[5],16),parseInt(e[6]+e[7],16)/255]}else if(0==i.indexOf("rgb"))return i.indexOf("rgba")<0&&(i+=",1"),i.match(/[\.\d]+/g).map((t=>+t));throw`Error: Bad color string: ${t}`},byteToHex:t=>("0"+t.toString(16)).slice(-2),colorToHex(t){const e=this.colorToRgbA(t);return"0x"+[0,1,2].map((t=>this.byteToHex(e[t]))).join("")},color3(t,e,i){return parseInt(["0x",this.byteToHex(t),this.byteToHex(e),this.byteToHex(i)].join(""))},color(t){return isNaN(t)?parseInt(this.colorToHex(t)):t},rgba(t){return a.assert(h.vec(t),"wanted rgba array"),parseInt("0x"+[0,1,2].map((e=>this.byteToHex(t[e]))).join(""))},hsla(t,e,i,s){function r(t){return Math.min(1,Math.max(0,t))}function n(t){return 6*(t=t<0?t+1:t>1?t-1:t)<1?a+(o-a)*t*6:2*t<1?o:3*t<2?a+(o-a)*(2/3-t)*6:a}t=t%360/360,e=r(e),i=r(i),s=r(s);let o=i<=.5?i*(e+1):i+e-i*e,a=2*i-o;return this.rgba([255*n(t+1/3),255*n(t),255*n(t-1/3),s])},resize(t,e,i,s,r){t&&a.doseqEx(t.children,(e=>e.m5&&e.m5.resize?.(t.x,t.y,t.width,t.height)))},pinAbove(t,e,i=10,s=.5){let[r,o,a,h,l]=w(this,t),[c,d,u,p,g]=w(this,e,t),m=r.y1-i-(c.y2-c.y1),f=s<.3?r.x1:s<.7?h-d:r.x2-(c.x2-c.x1);e.y=!e.anchor||e.anchor.y<.3?m:e.anchor.y<.7?m+u:m+(c.y2-c.y1),e.x=!e.anchor||e.anchor.x<.3?f:e.anchor.x<.7?f+d:f+(c.x2-c.x1),e.parent===t&&n.sub$(e,t)},pinBelow(t,e,i=10,s=.5){let[r,o,a,h,l]=w(this,t),[c,d,u,p,g]=w(this,e,t),m=r.y2+i,f=s<.3?r.x1:s<.7?h-d:r.x2-(c.x2-c.x1);e.y=!e.anchor||e.anchor.y<.3?m:e.anchor.y<.7?m+u:m+(c.y2-c.y1),e.x=!e.anchor||e.anchor.x<.3?f:e.anchor.x<.7?f+d:f+(c.x2-c.x1),e.parent===t&&n.sub$(e,t)},pinCenter(t,e){let[i,s,r,o,a]=w(this,t),[h,l,c,d,u]=w(this,e,t),p=o-l,g=a-c;e.y=!e.anchor||e.anchor.y<.3?g:e.anchor.y<.7?g+c:g+(h.y2-h.y1),e.x=!e.anchor||e.anchor.x<.3?p:e.anchor.x<.7?p+l:p+(h.x2-h.x1),(t.m5.stage||e.parent===t)&&n.sub$(e,t)},pinLeft(t,e,i=10,s=.5){let[r,o,a,h,l]=w(this,t),[c,d,u,p,g]=w(this,e,t),m=r.x1-i-(c.x2-c.x1),f=s<.3?r.y1:s<.7?l-u:r.y2-(c.y2-c.y1);e.y=!e.anchor||e.anchor.y<.3?f:e.anchor.y<.7?f+u:f+(c.y2-c.y1),e.x=!e.anchor||e.anchor.x<.3?m:e.anchor.x<.7?m+d:m+(c.x2-c.x1),e.parent===t&&n.sub$(e,t)},pinRight(t,e,i=10,s=.5){let[r,o,a,h,l]=w(this,t),[c,d,u,p,g]=w(this,e,t),m=r.x2+i,f=s<.3?r.y1:s<.7?l-u:r.y2-(c.y2-c.y1);e.y=!e.anchor||e.anchor.y<.3?f:e.anchor.y<.7?f+u:f+(c.y2-c.y1),e.x=!e.anchor||e.anchor.x<.3?m:e.anchor.x<.7?m+d:m+(c.x2-c.x1),e.parent===t&&n.sub$(e,t)},setMass(t,e){t.m5.mass=e},genTexture:(t,e,i,s)=>p(t),bounceOff:t=>v(t.A,t.B,t),hit(t,e){const i=S(this,t,e);return i&&(r.emit(["hit",t],i),r.emit(["hit",e],i.swap())),i},collide(t,e,i=!0){const s=function(t,e,i,s=!0){let r,o=S(t,e,i);return o&&(i.m5.static?n.sub$(e,o.overlapV):(r=n.div(o.overlapV,2),n.sub$(e,r),n.add$(i,r)),s&&v(e,i,o)),o}(this,t,e,i);return s&&function(t){const e=new Set;return t.overlapN[1]<-.3&&e.add(r.TOP),t.overlapN[1]>.3&&e.add(r.BOTTOM),t.overlapN[0]<-.3&&e.add(r.LEFT),t.overlapN[0]>.3&&e.add(r.RIGHT),e.add(t),e}(s)},hitTest(t,e){return S(this,t,e)},clamp(t,i,s=!1,n){let o,l,c,d,u,p;h.vec(i)&&(c=i[1].left,d=i[1].right,u=i[1].top,p=i[1].bottom,i=i[0]),d=!1!==d,c=!1!==c,u=!1!==u,p=!1!==p,i instanceof r.Scenes.Scene?l=r.mockStage():i.m5&&i.m5.stage?l=i:void 0!==i.x2&&void 0!==i.y2?(l=i,o=!0):(i.isSprite?a.assert(t.parent===i):a.assert(!1,"Error: clamp() using bad container"),a.assert(a.feq0(i.rotation),"Error: clamp() container can't rotate"),a.assert(a.feq0(i.anchor.x),"Error: clamp() container anchor.x !==0"),a.assert(a.feq0(i.anchor.y),"Error: clamp() container anchor.y !==0"),l=i);let g=o?[0,0]:this.topLeftOffsetXY(l),m=new Set,f=!1,y=!1,x=this.getAABB(t),w=o?l.x1:l.x+g[0],v=w+(o?l.x2-l.x1:l.width),S=o?l.y1:l.y+g[1],b=S+(o?l.y2-l.y1:l.height);return c&&x.x1<w&&(t.x+=w-x.x1,f=!0,m.add(r.LEFT)),d&&x.x2>v&&(t.x-=x.x2-v,f=!0,m.add(r.RIGHT)),u&&x.y1<S&&(t.y+=S-x.y1,y=!0,m.add(r.TOP)),p&&x.y2>b&&(t.y-=x.y2-b,y=!0,m.add(r.BOTTOM)),m.size>0?(f&&(t.m5.vel[0]/=t.m5.mass,s&&(t.m5.vel[0]*=-1)),y&&(t.m5.vel[1]/=t.m5.mass,s&&(t.m5.vel[1]*=-1)),n&&n(m)):m=e,m},dbgShowDir(t){let e="?";switch(t){case r.NE:e="top-right";break;case r.NW:e="top-left";break;case r.TOP:case r.UP:e="top";break;case r.LEFT:e="left";break;case r.RIGHT:e="right";break;case r.BOTTOM:case r.DOWN:e="bottom";break;case r.SE:e="bottom-right";break;case r.SW:e="bottom-left"}return e},dbgShowCol(t){const e=[];if(h.set(t))for(let i of t.values())e.push(this.dbgShowDir(i));return e.join(",")}};return b.bmpText=b.bitmapText,a.doseq(s,((t,e)=>{b.SomeColors[e]=b.color(t)})),a.doseq(i,((t,e)=>{b.BtnColors[e]=b.color(t)})),r.Sprites=b}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Sprites"]=function(t){return t.Sprites?t.Sprites:r(t)}}(this),function(t,e){"use strict";function i(e,i){const s=t["io/czlab/mcfud/spatial"](),{v2:r,math:n,ute:o,is:a}=e,h=Math.floor,l=t=>t.startsWith("scene::")?t:`scene::${t}`;function c(t){t&&(t.dispose?.(),t.parent.removeChild(t))}class d extends PIXI.Container{constructor(t){super(),this.addChild(t),this.label=t.label,this.m5={stage:!0}}dispose(){c(this.children[0])}update(t){this.children[0].update(t)}}class u extends PIXI.Container{constructor(t,e,i){super(),this.label=l(t),this.g={},this.m5={index:{},queue:[],garbo:[],sid:t,options:i,stage:!0,sgrid:s.spatialGrid(i.sgridX||320,i.sgridY||320)},a.fun(e)?this.setup=e:a.obj(e)&&o.inject(this,e)}#i(t,i,s){let r,n,o,a=!1;for(o=0;!a&&o<s.length;++o)n=s[o],i!==n&&!n.m5.dead&&i.m5.cmask&n.m5.type&&(r=e.Sprites.hitTest(i,n))&&(e.emit(["hit",i],r),r.B.m5.static||e.emit(["hit",r.B],r.swap()),t.engrid(i),a=!0);return a}collideXY(t){return this.#i(this.m5.sgrid,t,this.m5.sgrid.search(t))}onCanvasResize(t,i){return e.Sprites.resize({x:0,y:0,width:t,height:i,children:this.children}),this}future(t,i){return this.m5.queue.push([t,n.ndiv(e._curFPS*i,1e3)||1]),this}futureX(t,e){return this.m5.queue.push([t,e||1]),this}getChildById(t){return t&&this.m5.index[t]}remove(t){return a.str(t)&&(t=this.getChildById(t)),t&&(this.removeChild(t),e.off(t),t.m5._engrid&&this.m5.sgrid.degrid(t),e.Input.undoXXX(t),o.dissoc(this.m5.index,t.m5.uuid)),this}degrid(t){return t&&t.m5._engrid&&this.m5.sgrid.degrid(t),t}engrid(t){return t&&t.m5._engrid&&this.m5.sgrid.engrid(t),t}insertEx(t,e=!1){let i;return o.assert(a.vec(t),"wanted array of child sprites to be inserted!"),t.forEach((t=>{this.insertAt(t,null,e),i=t})),i}insert(t,e=!1){return this.insertAt(t,null,e)}insertAt(t,e,i=!1){return t=this.#s(t,e),i&&(t instanceof PIXI.TilingSprite||(t.m5._engrid=!0,this.m5.sgrid.engrid(t))),t}#s(t,e){return a.num(e)&&e>=0&&e<this.children.length?this.addChildAt(t,e):this.addChild(t),this.m5.index[t.m5.uuid]=t}preDispose(){return this}dispose(){return this.preDispose(),this.m5.dead=!0,e.off(this),function t(i){i&&(e.Input.undoXXX(i),i.children.forEach((e=>t(e))))}(this),this.removeChildren(),e.modalScene===this&&(e.modalScene=undefined,e.Input.restore(),o.log("removed the current modal scene")),this}#r(t,i){t.forEach((t=>{t.visible&&t.m5&&t.m5.tick&&(t.m5.tick(i),"x"==t.m5.flip&&(t.scale.x*=-1),"y"==t.m5.flip&&(t.scale.y*=-1),t.m5.flip=!1,e.emit(["post.tick",t],i),t.m5._engrid&&this.m5.sgrid.engrid(t)),t.children.length>0&&this.#r(t.children,i)}))}searchSGrid(t,e=!1){return this.m5.sgrid.search(t,e)}queueForRemoval(t){return this.m5.garbo.push(t)&&t}update(t){return this.m5.dead||(this.m5.queue.filter((t=>(t[1]-=1,t[1]<=0))).reverse().forEach((t=>{o.disj(this.m5.queue,t),t[0]()})),this.preUpdate?.(t),this.#r(this.children,t),this.postUpdate?.(t),this.m5.garbo.forEach((t=>this.remove(t))),this.m5.garbo.length=0),this}runOnce(){return this.setup?.(this.m5.options),this}}function p(t,i,s){let{Sprites:r}=e,l=e.getScaleFactor();if(0==t.length)return;let c,d,u=(i=o.patch(i,{bg:0,padding:10,fit:20,borderWidth:4,border:r.SomeColors.white})).borderWidth*l,p=i.group||r.container(),g=i.padding*l,m=0,f=-1,y=i.fit*l,x=2*y,w=t=>{m+=t.height,t.width>f&&(f=t.width)},v=t=>{m+=t.width,t.height>f&&(f=t.height)};t.forEach((t=>{o.assert(o.feq0(t.anchor.x)&&o.feq0(t.anchor.y),"wanted topleft anchor"),(s==e.DOWN?w:v)(t),i.skipAdd||p.addChild(t)})),f+=x,m+=g*(t.length-1)+x,s==e.DOWN?(c=f,d=m):(d=f,c=m);{let t=r.rect(c,d,i.bg,i.border,u);p.addChildAt(t,0),a.vec(i.bg)||(t.alpha=0==i.opacity?0:i.opacity||.5,"transparent"==i.bg&&(t.alpha=0))}let S,[b,I]=[h(c/2),h(d/2)],T=s==e.DOWN?"pinBelow":"pinRight";return t.forEach(((t,i)=>{s==e.DOWN?0==i&&(t.x=b-t.width/2,t.y=y):0==i&&(t.y=I-t.height/2,t.x=y),S&&e.Sprites[T](S,t,g),S=t})),p.x=i.x??n.ndiv(e.width-c,2),p.y=i.y??n.ndiv(e.height-d,2),p}function g(t,i,s){let r,n,{Sprites:o,Input:a}=e,h=o.color(i.selectedColor??"green"),l=o.color(i.disabledColor??"grey");return t.forEach((t=>{t.m5.uuid==i.defaultChoice?(n=t,t.tint=h):t.tint=l,t.m5.button&&(t.m5.press=t=>{t!==n&&(n.tint=l,t.tint=h,n=t,i.onClick?.(t))})})),n||(n=t[0],n.tint=h),r=p(t,i,s),r.getSelectedChoice=()=>n.m5.uuid,r}const m={Scene:u,SceneWrapper:d,layoutX:(t,i)=>p(t,i,e.RIGHT),layoutY:(t,i)=>p(t,i,e.DOWN),choiceMenuX:(t,i)=>g(t,i,e.RIGHT),choiceMenuY:(t,i)=>g(t,i,e.DOWN),scene(t,e,s){a.fun(e)&&(e={setup:e}),i[t]=[e,s]},replace(t,i,s){const r=l(a.str(t)?t:t.label),n=e.stage.getChildByName(r);if(!n)throw`Fatal: no such scene: ${r}`;return this.run(i,e.stage.getChildIndex(n),s)},remove(...t){1==t.length&&a.vec(t[0])&&(t=t[0]),t.forEach((t=>c(a.str(t)?e.stage.getChildByName(l(t)):t)))},removeAll(){for(;e.stage.children.length>0;)c(e.stage.children[e.stage.children.length-1]);e.mouse.reset(),e.Input.reset()},find:t=>e.stage.getChildByName(l(t)),runEx(t,e,i){return this.removeAll(),this.run(t,e,i)},runSeq(...t){t.forEach((t=>{o.assert(a.vec(t),"Expecting array"),this.run(t[0],t[1],t[2])}))},modal(t,i){return o.assert(!e.modalScene,"Another modal is already running!"),e.Input.save(),e.modalScene=this.run(t,null,i)},run(t,s,r){let n,h,l,p=i[t];if(e.modalScene)throw"Fatal: modal scene is running";if(!p)throw`Fatal: unknown scene: ${t}`;if(a.obj(s)&&(r=s,s=o.dissoc(r,"slot")),r=o.inject({},p[1],r),l=o.inject({},p[0]),o.nichts(s)&&(s=r.slot||-1),r.tiled?(o.assert(r.tiled.name,"no tmx file!"),h=new e.Tiles.TiledScene(t,l,r)):h=new u(t,l,r),n=h,r.centerStage&&(n=new d(h)),s>=0&&s<e.stage.children.length){let t=e.stage.getChildAt(s);e.stage.addChildAt(n,s),c(t)}else e.stage.addChild(n);return h.runOnce(),h},topMost(){let t=o.last(e.stage.children);return t instanceof d&&(t=t.children[0]),o.assert(t instanceof u,"top is not a scene!"),t}};return e.Scenes=m}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Scenes"]=function(t){return t.Scenes?t.Scenes:i(t,{})}}(this),function(t,e){"use strict";function i(t,i,s){const r=Math.floor,n=5*Math.PI,o=Math.PI/2,a=2*Math.PI,{v2:h,math:l,ute:c,is:d}=t;function u(e,s,r=60,n=!1,o={}){return c.inject({duration:r,sprite:e,easing:s,loop:n,cur:0,on:0,dead:0,onFrame(t,e){},_run(){this.cur=0,this.on=1,this.dead=0,i.push(this)},onTick(){this.on&&(this.cur<this.duration?(this.onFrame(!1,this.easing(this.cur/this.duration)),this.cur+=1):(this.onFrame(!0),this.loop?(d.num(this.loop)&&--this.loop,this.onLoopReset(),this.cur=0):(this.on=0,this.dispose(),this.onComplete&&c.delay(0,(()=>this.onComplete())))))},dispose(){this.dead=1,t.emit(["tween.disposed"],this)}},o)}function p(t,i,s,r){return u(t,i,s,r,{start(t,i,s,r){this._x=d.num(i)?[t,i]:e,this._y=d.num(r)?[s,r]:e,this._run()},onLoopReset(){this._x&&c.swap(this._x,0,1),this._y&&c.swap(this._y,0,1)},onFrame(t,e){this._x&&(this.sprite.x=t?this._x[1]:l.lerp(this._x[0],this._x[1],e)),this._y&&(this.sprite.y=t?this._y[1]:l.lerp(this._y[0],this._y[1],e))}})}function g(...e){const i=e.slice(0),s={onTweenEnd(t){for(let e,s=0;s<i.length;++s)if(e=i[s],e===t){i.splice(s,1);break}0==i.length&&(this.dispose(),this.onComplete&&c.delay(0,(()=>this.onComplete())))},dispose(){t.off(["tween.disposed"],"onTweenEnd",s),i.length=0}};return t.on(["tween.disposed"],"onTweenEnd",s),s}const m={EXPO_IN:t=>0==t?0:Math.pow(1024,t-1),EXPO_OUT:t=>1==t?1:1-Math.pow(2,-10*t),EXPO_INOUT:t=>0==t?0:1==t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1))),LINEAR:t=>t,SMOOTH:t=>3*t*t-2*t*t*t,SMOOTH_QUAD(t){let e=m.SMOOTH(t);return e*e},SMOOTH_CUBIC(t){let e=m.SMOOTH(t);return e*e*e},EASE_IN_CUBIC:t=>t*t*t,EASE_OUT_CUBIC(t){let e=1-t;return 1-e*e*e},EASE_INOUT_CUBIC(t){if(t<.5)return 4*t*t*t;{let e=-2*t+2;return 1-e*e*e/2}},EASE_IN_QUAD:t=>t*t,EASE_OUT_QUAD:t=>1-(1-t)*(1-t),EASE_INOUT_QUAD(t){if(t<.5)return 2*t*t;{let e=-2*t+2;return 1-e*e/2}},EASE_IN_SINE:t=>1-Math.cos(t*o),EASE_OUT_SINE:t=>Math.sin(t*o),EASE_INOUT_SINE:t=>.5-Math.cos(t*Math.PI)/2,SPLINE(t,e,i,s,r){let n=t*t,o=n*t;return.5*(e*(2*n-o-t)+i*(3*o-5*n+2)+s*(-3*o+4*n+t)+r*(o-n))},CUBIC_BEZIER(t,e,i,s,r){let n=t*t,o=1-t,a=o*o;return a*o*e+3*a*t*i+3*o*n*s+n*t*r},ELASTIC_IN:t=>0==t?0:1==t?1:-Math.pow(2,10*(t-1))*Math.sin((t-1.1)*n),ELASTIC_OUT:t=>0==t?0:1==t?1:1+Math.pow(2,-10*t)*Math.sin((t-.1)*n),ELASTIC_INOUT(t){switch(t){case 0:return 0;case 1:return 1;default:return(t*=2)<1?-.5*Math.pow(2,10*(t-1))*Math.sin((t-1.1)*n):1+.5*Math.pow(2,-10*(t-1))*Math.sin((t-1.1)*n)}},BOUNCE_IN:t=>1-m.BOUNCE_OUT(1-t),BOUNCE_OUT:t=>t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375,BOUNCE_INOUT:t=>t<.5?.5*m.BOUNCE_IN(2*t):.5*m.BOUNCE_OUT(2*t-1)+.5,tweenAlpha(t,e,i,s=60,r=!1){const n=function(t,e,i,s){return u(t,e,i,s,{start(t,e){this._a=[t,e],this._run()},onLoopReset(){c.swap(this._a,0,1)},onFrame(t,e){this.sprite.alpha=t?this._a[1]:l.lerp(this._a[0],this._a[1],e)}})}(t,e,s,r);let o=t.alpha,a=i;return d.vec(i)&&(o=i[0],a=i[1]),n.start(o,a),n},tweenAngle(t,e,i,s=60,r=!1){const n=function(t,e,i,s){return u(t,e,i,s,{start(t,e){this._a=[t,e],this._run()},onLoopReset(){c.swap(this._a,0,1)},onFrame(t,e){this.sprite.rotation=t?this._a[1]:l.lerp(this._a[0],this._a[1],e)}})}(t,e,s,r);let o=t.rotation,a=i;return d.vec(i)&&(o=i[0],a=i[1]),n.start(o,a),n},tweenScale(t,i,s,r,n=60,o=!1){const a=function(t,i,s,r){return u(t,i,s,r,{start(t,i,s,r){this._x=d.num(i)?[t,i]:e,this._y=d.num(r)?[s,r]:e,this._run()},onLoopReset(){this._x&&c.swap(this._x,0,1),this._y&&c.swap(this._y,0,1)},onFrame(t,e){this._x&&(this.sprite.scale.x=t?this._x[1]:l.lerp(this._x[0],this._x[1],e)),this._y&&(this.sprite.scale.y=t?this._y[1]:l.lerp(this._y[0],this._y[1],e))}})}(t,i,n,o);let h=t.scale.x,p=t.scale.y,g=s,m=r;return d.vec(s)&&(h=s[0],g=s[1]),d.vec(r)&&(p=r[0],m=r[1]),d.num(g)||(h=g=e),d.num(m)||(p=m=e),a.start(h,g,p,m),a},tweenXY(t,i,s,r,n=60,o=!1){const a=p(t,i,n,o);let h=t.x,l=t.y,c=s,u=r;return d.vec(s)&&(h=s[0],c=s[1]),d.vec(r)&&(l=r[0],u=r[1]),d.num(c)||(h=c=e),d.num(u)||(l=u=e),a.start(h,c,l,u),a},fadeOut(t,e=60){return this.tweenAlpha(t,this.EASE_OUT_SINE,0,e)},fadeIn(t,e=60){return this.tweenAlpha(t,this.EASE_OUT_SINE,1,e)},pulse(t,e=0,i=60,s=!0){return this.tweenAlpha(t,this.SMOOTH,e,i,s)},slide(t,e,i,s,r=60){return this.tweenXY(t,e,i,s,r)},throb(t,e=.9,i=.9,s=60,r=!0){return this.tweenScale(t,this.SMOOTH_QUAD,e,i,s,r)},scale(t,e=.5,i=.5,s=60){return this.tweenScale(t,this.SMOOTH,e,i,s)},strobe(t,e=1.3,i=10,s=20,r=10,n=!0){return this.tweenScale(t,(t=>this.SPLINE(t,i,0,1,s)),e,e,r,n)},jiggle(t,i,s=1.4,r=1.2,n=10,o=!0){let{x1:a,x2:h,y1:l,y2:d}=i;return g(this.tweenScale(t,(t=>this.SPLINE(t,c.or(a,10),0,1,c.or(h,10))),s,e,n,o),this.tweenScale(t,(t=>this.SPLINE(t,c.or(l,-10),0,1,c.or(d,-10))),e,r,n,o))},bezier(t,e,i,s,r=60){let n=p(t,this.SMOOTH,r);return n.start=function(){this._run()},n.onFrame=function(r,n){r||h.set(t,m.CUBIC_BEZIER(n,t.x,e[0],i[0],s[0]),m.CUBIC_BEZIER(n,t.y,e[1],i[1],s[1]))},n.start(),n},remove(t){t?.dispose()},update(t){c.rseq(i,(e=>e.onTick(t))),c.rseq(s,(e=>e.onTick(t)));for(let t=i.length-1;t>=0;--t)i[t].dead&&i.splice(t,1);for(let t=s.length-1;t>=0;--t)s[t].m5.dead&&(_S.remove(s[t])&&s.splice(t,1))},particles(t,e,i,r,n=24,o={},a={},l=[0,.3],d=!0){function u(n){let d,u=r(),p=c.randInt2(o.size,a.size);s.push(u),t.addChild(u),u.totalFrames&&u.gotoAndStop(c.randInt2(0,u.totalFrames-1)),_S.sizeXY(_S.centerAnchor(u),p,p),h.set(u,e,i),u.g.scaleSpeed=c.randFloat2(o.scale,a.scale),u.g.alphaSpeed=c.randFloat2(o.alpha,a.alpha),u.g.angVel=c.randFloat2(o.rotate,a.rotate),d=c.randFloat2(o.speed,a.speed),h.set(u.m5.vel,d*Math.cos(n),d*Math.sin(n)),u.onTick=function(){this.m5.dead||(h.add$(this.m5.vel,l),h.add$(this,this.m5.vel),this.scale.x-this.g.scaleSpeed>0&&(this.scale.x-=this.g.scaleSpeed),this.scale.y-this.g.scaleSpeed>0&&(this.scale.y-=this.g.scaleSpeed),this.rotation+=this.m5.angVel,this.alpha-=this.g.alphaSpeed,this.alpha<=0&&(this.m5.dead=!0))}}o=c.patch(o,{angle:0,size:4,speed:.3,scale:.01,alpha:.02,rotate:.01});for(let t=((a=c.patch(a,{angle:6.28,size:16,speed:3,scale:.05,alpha:.02,rotate:.03})).angle-o.angle)/(n-1),e=o.angle,i=0;i<n;++i)u(d?c.randFloat2(o.angle,a.angle):e),e+=t},shake(t,e=16,i=!1,n=!0){let o={},a=1,h=t.x,l=t.y,d=1,u=t.rotation,p=e,g=r(e/8);return o.onTick=()=>i?void(a<8?(t.rotation=u,e-=g,t.rotation=e*d,++a,d*=-1):n?(e=p,a=1):c.disj(s,o)):void(a<8?(t.x=h,t.y=l,e-=g,t.x+=c.randInt2(-e,e),t.y+=c.randInt2(-e,e),++a):n?(e=p,a=1):c.disj(s,o)),s.push(o)&&t},StarWarp:function(e,i){i=i||{};let{Sprites:s}=t,r=2e3,n=0,h=0,l=0,d=c.now(),u=i.color??"yellow",p=i.items??1e3,g=t.resource("boot/star.png");const m=c.fill(p,(t=>((t=s.sprite(g)).g.d3=[0,0,0],c.rand()<.3&&(t.tint=s.color(u)),s.anchorXY(t,.5,.69),e.addChild(t),f(t,c.rand()*r))));function f(t,e){let i=c.rand()*a,s=50*c.rand()+1;return t.g.d3[0]=Math.cos(i)*s,t.g.d3[1]=Math.sin(i)*s,t.g.d3[2]=isNaN(e)?n+r*(1+.5*c.rand()):e,t}return{dispose(){m.forEach((t=>s.remove(t)))},update(e){let i,a,u=t.width/2,p=t.height/2;h+=(l-h)/20,n+=10*e*(h+.025),m.forEach(((e,i)=>{e.g.d3[2]<n&&f(e),i=20*t.width/a,a=e.g.d3[2]-n,e.x=e.g.d3[0]*i+u,e.y=e.g.d3[1]*i+p;let l=e.x-u,c=e.y-p,d=Math.sqrt(l*l+c*c),g=Math.max(0,1-a/r);e.rotation=Math.atan2(c,l)+o,s.scaleXY(e,.05*g,g*(.05+6*h*d/t.width))})),i=c.now(),i-d>5e3&&(d=i,l=l>0?0:1)}}},SeqTweens:function(...t){let e=[];t.forEach((t=>{e.push(t),c.disj(i,t)}));const s={onDone(){this.dispose(),this.onComplete&&c.delay(0,(()=>this.onComplete()))},dispose(){e.length=0}};return function t(r){r?(i.push(r),r.onComplete=()=>t(e.shift())):s.onDone()}(e.shift()),s},BatchTweens:g};return t.FX=m}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/FX"]=function(t){return t.FX?t.FX:i(t,[],[])}}(this),function(t,e){"use strict";function i(i){const s=t["io/czlab/mcfud/geo2d"](),{v2:r,math:n,is:o,ute:a}=i,h=Math.abs,l=Math.cos,c=Math.sin,d=Math.floor,u=Math.PI/180;Math.PI;i.Scenes.scene("Splash",{setup(t){let e,s,n,o=i.getScaleFactor(),{title:h,titleFont:l,titleColor:c,titleSize:d}=t,{footerMsgSize:u,action:p,clickSnd:g}=t,{bg:m,playMsg:f,playMsgFont:y,playMsgColor:x,playMsgSize:w,playMsgColor2:v}=t;y=y||i.DOKI_LOWER,l=l||i.BIGSHOUTBOB,u=(u||18)*o,f=f||i.clickPlayMsg(),x=x??i.Sprites.color("white"),v=v??i.Sprites.color("#ffc901"),c=c??i.Sprites.color("#ffc901"),d=(d||96)*o,w=(w||48)*o,this.insert(i.Sprites.fillMax(m||"boot/splash.jpg")),e=this.insert(i.Sprites.container()),n=i.Sprites.bmpText(h,l,d),a.echt(c)&&i.Sprites.tint(n,c),r.set(n,i.width/2,.45*i.height),e.addChild(i.Sprites.centerAnchor(n));{s=i.Sprites.bmpText(f,y,w);let t,r=i.FX.throb(s,.747,.747);const o=()=>{i.Sprites.tint(s,v),i.FX.remove(r),t=i.FX.tweenAlpha(e,i.FX.EASE_OUT_SINE,0,90),t.onComplete=()=>i.Scenes.runEx(p.name,p.cfg)};let a=i.Sprites.oneOffClick(o,g);i.Sprites.centerAnchor(s),i.Sprites.pinBelow(n,s),e.addChild(s),i.touchDevice||(this.g.space=i.Input.keybd(i.Input.SPACE,(()=>{i.Sprites.cancelOneOffClick(a),o(),i.sound(g).play()})))}{const t=i.Sprites.bmpText("Powered by MojoH5 2d game engine.",i.UNSCII,u),e=i.Sprites.bmpText(i.COPYRIGHT,i.UNSCII,u);i.Sprites.pinBelow(this,e,1.5*-e.height,0),i.Sprites.pinBelow(this,t,1.5*-t.height,1),this.insert(e),this.insert(t)}},preDispose(){this.g.space?.dispose()}}),i.Scenes.scene("EndGame",{setup(t){let{winner:e,snd:s}=t,{fontName:r,fontSize:n,msg:o,replay:a,quit:h}=t;s||(s=e?"game_win.mp3":"game_over.mp3"),n=(n||32)*i.getScaleFactor(),r=r||i.DOKI_LOWER;let l={fontName:r,fontSize:n},c=()=>i.Sprites.opacity(i.Sprites.bmpText("#",l),0),d=i.Sprites.bmpText("Game Over",l),u=i.Sprites.bmpText(o,l),p=i.Input.mkBtn(i.Sprites.bmpText("Play Again?",l)),g=i.Sprites.bmpText(" or ",l),m=i.Input.mkBtn(i.Sprites.bmpText("Quit",l));p.m5.press=()=>i.Scenes.runEx(a.name,a.cfg),m.m5.press=()=>i.Scenes.runEx(h.name,h.cfg),i.sound(s).play(),this.insert(i.Scenes.layoutY([d,u,c(),c(),c(),p,g,m],t))}}),i.Scenes.scene("PhotoMat",{setup(t){let s=t.image?i.resource(t.image):e;this.g.gfx=i.Sprites.graphics(),i.Sprites.grect(this.g.gfx,0,0,i.width,t.y1),i.Sprites.grect(this.g.gfx,0,t.y2,i.width,i.height-t.y2),i.Sprites.grect(this.g.gfx,0,0,t.x1,i.height),i.Sprites.grect(this.g.gfx,t.x2,0,i.width-t.x2,i.height),s?i.Sprites.gfillEx(this.g.gfx,s,{}):i.Sprites.gfill(this.g.gfx,{color:i.Sprites.color(t.color)}),this.insert(this.g.gfx)}}),i.Scenes.scene("HotKeys",{setup(t){let s,n,o,a,{Sprites:h,Input:l}=i,c=i.getScaleFactor(),d=1.2,u=i.width,p=i.height,g=t.buttons?"makeButton":"makeHotspot",{fontName:m,fontSize:f,cb:y,radius:x,alpha:w,color:v}=t,{char_fire:S,char_down:b,char_up:I,char_left:T,char_right:_}=t;function E(t,e,i){let s=h.opacity(h.circle(x,v),w);s.addChild(h.centerAnchor(h.tint(h.bmpText(i,m,f),"white"))),t[e]=s}function C(t,e){let i=t.m5.touch;return t.m5.touch=function(s,r){r?l.setKeyOn(e):l.setKeyOff(e),i&&i.call(t.m5,r)},t}m=m||i.DOKI_LOWER,f=(f||48)*c,x=(x||64)*c,w=w??.5,v=v??"grey",t.fontName=m,t.fontSize=f,t.radius=x,t.alpha=w,t.color=v,n=[e,e],o=[e,e],s={},(t.right??1)&&E(s,"right",_||">"),(t.left??1)&&E(s,"left",T||"<"),(t.up??1)&&E(s,"up",I||"+"),(t.down??1)&&E(s,"down",b||"-"),t.fire&&E(s,"fire",S||"^"),t.southpaw?(s.left&&(n[0]=s.left),s.right&&(n[0]?n[1]=s.right:n[0]=s.right),n[0]&&r.set(n[0],d*n[0].width,p-d*n[0].height),n[1]&&h.pinRight(n[0],n[1],n[0].width/3),s.up&&(o[0]=s.up),s.down&&(o[0]?o[1]=s.down:o[0]=s.down),o[0]&&r.set(o[0],u-d*o[0].width,p-d*o[0].height),o[1]&&h.pinLeft(o[0],o[1],o[0].width/3)):(s.right&&(n[0]=s.right),s.left&&(n[0]?n[1]=s.left:n[0]=s.left),n[0]&&r.set(n[0],u-d*n[0].width,p-d*n[0].height),n[1]&&h.pinLeft(n[0],n[1],n[0].width/3),s.up&&(o[0]=s.up),s.down&&(o[0]?o[1]=s.down:o[0]=s.down),o[0]&&r.set(o[0],d*o[0].width,p-d*o[0].height),o[1]&&h.pinRight(o[0],o[1],o[0].width/3)),s.fire&&(o[0]?h.pinAbove(o[0],s.fire,o[0].height/3):r.set(s.fire,d*s.fire.width,p-d*s.fire.height)),a=y?y(s):s,a.right&&(this.insert(l[g](a.right)),a.right.m5.hotspot&&C(a.right,l.RIGHT)),a.left&&(this.insert(l[g](a.left)),a.left.m5.hotspot&&C(a.left,l.LEFT)),a.up&&(this.insert(l[g](a.up)),a.up.m5.hotspot&&C(a.up,l.UP)),a.down&&(this.insert(l[g](a.down)),a.down.m5.hotspot&&C(a.down,l.DOWN)),a.fire&&(this.insert(l[g](a.fire)),a.fire.m5.hotspot&&C(a.fire,l.SPACE)),t.extra?.(this,t)}}),i.Scenes.scene("AudioIcon",{setup(t){let{cb:e,iconOn:s,iconOff:n}=t,{xOffset:o,yOffset:a,xScale:h,yScale:l}=t,{Sound:c}=i,d=i.getScaleFactor(),u=i.Input.mkBtn(i.Sprites.spriteFrom(s||"boot/audioOn.png",n||"boot/audioOff.png"));h=h??d,l=l??d,a=a??0,o=o??-10*d,i.Sprites.scaleXY(i.Sprites.opacity(u,.343),h,l),r.set(u,i.width-u.width+o,0+a),u.m5.showFrame(c.sfx()?0:1),u.m5.press=()=>{c.sfx()?(c.mute(),u.m5.showFrame(1)):(c.unmute(),u.m5.showFrame(0))},this.insert(u)}}),i.Scenes.scene("StarfieldBg",{setup(t){const e=[],s=i.Sprites.graphics();a.patch(t,{height:i.height,width:i.width,count:100,minVel:15,maxVel:30}),a.inject(this.g,{gfx:s,stars:e,lag:0,dynamic:!0,fps:1/t.fps,draw(){return i.Sprites.gclear(s),e.forEach((t=>{i.Sprites.grect(s,t.x,t.y,t.size,t.size),i.Sprites.gfill(s,{color:a.rand()<.3?i.Sprites.SomeColors.yellow:i.Sprites.SomeColors.white})})),this},moveStars(i){this.lag+=i,this.lag>=this.fps&&(this.lag=0,e.forEach((e=>{e.y+=i*e.vel,e.y>t.height&&(r.set(e,a.randInt(t.width),0),e.size=a.randInt(4),e.vel=a.rand()*(t.maxVel-t.minVel)+t.minVel)})),this.draw())}}),t.static&&(this.g.dynamic=!1);for(let i=0;i<t.count;++i)e[i]={x:a.rand()*t.width,y:a.rand()*t.height,size:3*a.rand()+1,vel:a.rand()*(t.maxVel-t.minVel)+t.minVel};this.g.draw()&&this.insert(s)},postUpdate(t){this.g.dynamic&&this.g.moveStars(t)}},{fps:90,count:100,minVel:15,maxVel:30});const p={Periodic:class{#n;#o;#a;#h;#l;constructor(t,e,i=16){this.#n=e,this.#o=t,this.#a=0,this.#h=i,this.#l=a.fill(i,t)}lifeCycle(t){this.#a+=t,this.#a>this.#n&&(this.#a=0,this.discharge())}discharge(){throw"Periodic: please implement action()"}reclaim(t){this.#l.length<this.#h&&this.#l.push(t)}take(){return this.#l.length>0?this.#l.pop():this.#o()}},Meander:function(t){function s(t,e,s,r){e.impact=h(s),i.emit([r,t],e)}const n=[],o={dispose(){i.off(o)},boom(o){if(a.assert(o.A===t,"got hit by someone else???"),o.B&&o.B.m5.sensor)i.emit(["bump.sensor",o.B],o.A);else{let[n,a]=t.m5.vel;o.impact=e,r.sub$(t,o.overlapV),o.overlapN[1]<-.3?(a<0&&(!t.m5.skipHit&&r.setY(t.m5.vel,0)),s(t,o,a,"bump.top")):o.overlapN[1]>.3&&(a>0&&(!t.m5.skipHit&&r.setY(t.m5.vel,0)),s(t,o,a,"bump.bottom")),o.overlapN[0]<-.3?(n<0&&(!t.m5.skipHit&&r.setX(t.m5.vel,0)),s(t,o,n,"bump.left")):o.overlapN[0]>.3&&(n>0&&(!t.m5.skipHit&&r.setX(t.m5.vel,0)),s(t,o,n,"bump.right")),o.impact===e?o.impact=0:i.emit(["bump.*",t],o)}n.push(o)}};return i.on(["hit",t],"boom",o),i.on(["post.remove",t],"dispose",o),function(s){return n.length=0,i.Sprites.move(t,s)&&t.parent.collideXY(t),n.length>0?n[0]:e}},Camera:function(t,e,s,r){const n=r?.height??s,h=r?.width??e,l=d(n/2),c=d(h/2),u=d(n/4),p=d(h/4);let g=0,m=0,f={dispose(){i.off(f)},set x(e){g=e,t.x=-g},set y(e){m=e,t.y=-m},get x(){return g},get y(){return m},worldHeight:s,worldWidth:e,width:h,height:n,follow(t){const r=a.feq0(t.angle)?i.Sprites.getAABB(t):i.Sprites.boundingBox(t);r.x1<this.x+d(c-p)&&(this.x=r.x1-p),r.x2>this.x+d(c+p)&&(this.x=r.x2-3*p),r.y1<this.y+d(l-u)&&(this.y=r.y1-u),r.y2>this.y+d(l+u)&&(this.y=r.y2-3*u),this.x<0&&(this.x=0),this.y<0&&(this.y=0),this.x+h>e&&(this.x=e-h),this.y+n>s&&(this.y=s-n);let{x1:o,x2:g,y1:m,y2:f}=t.m5.getImageOffsets(),y=r.x2-g;return y>e&&(t.x-=y-e),y=r.y2-f,y>s&&(t.y-=y-s),y=r.x1+o,y<0&&(t.x+=-y),y=r.y1+m,y<0&&(t.y+=-y),t},centerOver:function(t,e){if(1!=arguments.length||o.num(t))o.num(t)&&(this.x=t-c),o.num(e)&&(this.y=e-l);else{const e=i.Sprites.centerXY(t);this.x=e[0]-c,this.y=e[1]-l}return t}};return i.on(["post.remove",t],"dispose",f),f},Patrol:function(t,e,s){const n={dispose(){i.off(n)},goLeft(e){t.m5.heading=i.LEFT,t.m5.flip="x",r.setX(t.m5.vel,-e.impact)},goRight(e){t.m5.heading=i.RIGHT,t.m5.flip="x",r.setX(t.m5.vel,e.impact)},goUp(e){r.setY(t.m5.vel,-e.impact),t.m5.heading=i.UP,t.m5.flip="y"},goDown(e){r.setY(t.m5.vel,e.impact),t.m5.heading=i.DOWN,t.m5.flip="y"}};return e&&(i.on(["bump.right",t],"goLeft",n),i.on(["bump.left",t],"goRight",n)),s&&(i.on(["bump.top",t],"goDown",n),i.on(["bump.bottom",t],"goUp",n)),i.on(["post.remove",t],"dispose",n),n},Jitter:function(t,s,n){s=s??-300,n=n??i.Input.UP;let o=0,a=0,h=s/3;const l={onGround(){a=.06666666666666667},dispose(){i.off(l)}};return i.on(["bump.bottom",t],"onGround",l),function(l,c){if(!t.m5.skipHit){let d=t.m5.speed,u=i.Input.keyDown(i.Input.RIGHT),p=i.Input.keyDown(i.Input.LEFT),g=i.Input.keyDown(n);c&&(p||u||a>0)&&(c.overlapN[1]>.85||c.overlapN[1]<-.85)&&(c=e),p&&!u?(t.m5.heading=i.LEFT,c&&a>0?r.set(t.m5.vel,d*c.overlapN[1],-d*c.overlapN[0]):r.setX(t.m5.vel,-d)):u&&!p?(t.m5.heading=i.RIGHT,c&&a>0?r.set(t.m5.vel,-d*c.overlapN[1],d*c.overlapN[0]):r.setX(t.m5.vel,d)):r.setX(t.m5.vel,0),a>0&&0==o&&g?(r.setY(t.m5.vel,s),o+=1,a=-l):g&&o<2&&(o+=1,i.emit(["jump",t])),o&&!g&&(o=0,i.emit(["jumped",t]),t.m5.vel[1]<h&&(t.m5.vel[1]=h)),a>0&&(t.m5.vel[1]=0)}a-=l}},MazeRunner:function(t,e){return function(s,n){let[h,l]=t.m5.vel,c=t.m5.speed,d=!a.feq0(h),u=!a.feq0(l);d&&u||!e||(u&&(o.obj(e)?t.m5.showFrame(e[l>0?i.DOWN:i.UP]):e&&(t.angle=l>0?180:0)),d&&(o.obj(e)?t.m5.showFrame(e[h>0?i.RIGHT:i.LEFT]):e&&(t.angle=h>0?90:-90)));let p=i.u.touchOnly,g=p?t.m5.heading==i.RIGHT:i.Input.keyDown(i.Input.RIGHT)&&i.RIGHT,m=p?t.m5.heading==i.LEFT:i.Input.keyDown(i.Input.LEFT)&&i.LEFT,f=p?t.m5.heading==i.UP:i.Input.keyDown(i.Input.UP)&&i.UP,y=p?t.m5.heading==i.DOWN:i.Input.keyDown(i.Input.DOWN)&&i.DOWN;(m||f)&&(c*=-1),m&&g?r.setX(t.m5.vel,0):(m||g)&&(t.m5.heading=m||g,r.setX(t.m5.vel,c)),f&&y?r.setY(t.m5.vel,0):(f||y)&&(t.m5.heading=f||y,r.setY(t.m5.vel,c))}},seek(t,e){const i=r.unit$(r.sub(e,t));return i&&(r.mul$(i,t.m5.maxSpeed),r.sub$(i,t.m5.vel),r.add$(t.m5.steer,i)),t},flee(t,e,i){let s=r.sub(t,e),n=r.len2(s);return void 0===i&&(i=t.m5.steerInfo.tooCloseDistance),n>i*i||(r.unit$(s)||(s=[.1,.1]),r.mul$(s,t.m5.maxSpeed),r.sub$(s,t.m5.vel),r.add$(t.m5.steer,s)),t},arrive(t,e,i){let s=1,n=r.dist(t,e),o=r.unit$(r.sub(e,t));return void 0===i&&(i=t.m5.steerInfo.arrivalThreshold),n>i||(s=n/i),r.mul$(o,t.m5.maxSpeed*s),r.sub$(o,t.m5.vel),r.add$(t.m5.steer,o),t},pursue(t,e){return this.seek(t,r.add(e,r.mul(e.m5.vel,r.dist(t,e)/t.m5.maxSpeed)))},evade(t,e){return this.flee(t,r.sub(e,r.mul(e.m5.vel,r.dist(t,e)/t.m5.maxSpeed)))},idle:t=>(r.mul$(t.m5.vel,0),r.mul$(t.m5.steer,0),t),wander(t){let e=r.mul$([1,1],t.m5.steerInfo.wanderRadius),i=r.len(e),s=r.mul$(r.unit(t.m5.vel),t.m5.steerInfo.wanderDistance);return e[0]=Math.cos(t.m5.steerInfo.wanderAngle)*i,e[1]=Math.sin(t.m5.steerInfo.wanderAngle)*i,t.m5.steerInfo.wanderAngle+=a.rand()*t.m5.steerInfo.wanderRange-.5*t.m5.steerInfo.wanderRange,r.add$(t.m5.steer,r.add$(s,e)),t},interpose(t,e,i){let s=r.div$(r.add(e,i),2),n=r.dist(t,s)/t.m5.maxSpeed,o=r.add(e,r.mul(e.m5.vel,n)),a=r.add(i,r.mul(i.m5.vel,n));return this.seek(t,r.div$(r.add$(o,a),2))},separation(t,e,i=300,s=100){let n=[0,0],o=0;return e.forEach((e=>{e!==t&&r.dist(e,t)<i&&(r.add$(n,r.sub(e,t)),++o)})),o>0&&r.flip$(r.div$(n,o)),r.add$(t.m5.steer,r.mul$(r.unit$(n),s)),t},followLeader(t,e,i,s=400,n=300,o=100,a=1600,h=200){let l,c=r.mul$(r.unit(e.m5.vel),s),d=r.add(e,c);return r.flip$(c),l=r.add(e,c),function(t,e,i,s){return r.dist(i,t)<s||r.dist(e,t)<s}(t,e,d,a)&&this.evade(t,e),this.arrive(t,l,h),this.separation(t,i,n,o)},queue(t,e,i=500,s=500){let n=function(){let n,o=r.mul$(r.unit(t.m5.vel),i),a=r.add(t,o);for(let i=0;i<e.length;++i)if(e[i]!==t&&r.dist(a,e[i])<s){n=e[i];break}return n}(),o=[0,0],a=r.mul(t.m5.vel,1);return n&&(o=r.mul$(r.flip(t.m5.steer),.8),r.unit$(r.flip$(a)),r.add$(o,a),r.dist(t,n)<s&&r.mul$(t.m5.vel,.3)),r.add$(t.m5.steer,o),t},flock(t,e){let i=0,s=[0,0],n=r.mul(t.m5.vel,1);return e.forEach((e=>{e!==this&&function(e){return!(r.dist(t,e)>t.m5.steerInfo.inSightDistance||r.dot(r.sub(e,t),r.unit(t.m5.vel))<0)}(e)&&(r.add$(n,e.m5.vel),r.add$(s,e),r.dist(t,e)<t.m5.steerInfo.tooCloseDistance&&this.flee(t,e),++i)})),i>0&&(r.div$(n,i),r.div$(s,i),this.seek(t,s),r.add$(t.m5.steer,r.sub$(n,t.m5.vel))),t},followPath(t,e,i,s=1){let n=e[t.m5.pathIndex];if(n)return r.dist(t,n)<s&&(t.m5.pathIndex>=e.length-1?i&&(t.m5.pathIndex=0):t.m5.pathIndex+=1),t.m5.pathIndex>=e.length-1&&!i?this.arrive(t,n):this.seek(t,n),t},avoid(t,e){let i,s=null,n=r.len(t.m5.vel)/t.m5.maxSpeed,o=r.add(t,r.mul$(r.unit(t.m5.vel),n)),a=r.add(t,r.mul$(r.unit(t.m5.vel),.5*t.m5.steerInfo.avoidDistance));for(let i,n=0;n<e.length;++n)e[n]!==this&&(i=r.dist(e[n],o)<=e[n].m5.radius||r.dist(e[n],a)<=e[n].m5.radius,i&&(null===s||r.dist(t,e[n])<r.dist(t,s))&&(s=e[n]));return s&&(i=r.mul$(r.unit$(r.sub(o,s)),100),r.add$(t.m5.steer,i)),t},lineOfSight(t,e,r){let n=i.Sprites.centerXY(t),o=i.Sprites.centerXY(e);for(let t,e,a=0;a<r.length;++a)if(e=r[a],t=e.m5.circle?s.hitTestLineCircle(n,o,e.x,e.y,e.width/2):s.hitTestLinePolygon(n,o,s.bodyWrap(i.Sprites.toPolygon(e),e.x,e.y)),t[0])return!1;return!0},shoot(t,e,s,n,o,a){const h=n(),l=i.Sprites.topLeftOffsetXY(t);return r.add$(l,[o,a]),r.copy(h,r.add(t,l)),r.set(h.m5.vel,Math.cos(e)*s,Math.sin(e)*s),h},healthBar(t){let{scale:e,width:s,height:r,lives:n,borderWidth:o,line:a,fill:h}=t,l=4*e,c=4*e,u=[];o=(o||4)*e,n=n||3,h=i.Sprites.color(h),a=i.Sprites.color(a);for(let t=d(s/n),e=0;e<n;++e)u.push(i.Sprites.rect(t,r-2*o,h));return{dec(){return this.lives>0&&(this.lives-=1,u[this.lives].visible=!1),this.lives>0},lives:u.length,sprite:i.Scenes.layoutX(u,{bg:["#cccccc",0],borderWidth:o,border:a,padding:l,fit:c})}},gaugeUI(t){let{minDeg:e,maxDeg:s,line:r,gfx:o,scale:h,cx:d,cy:p,radius:g,alpha:m,fill:f,needle:y}=a.patch(t,{minDeg:90,maxDeg:360});const x=[0,45*u,90*u,135*u,180*u,225*u,270*u,315*u];function w(t,e,i,s){return[t+i*l(s),e+i*c(s)]}return y=i.Sprites.color(y),r=i.Sprites.color(r),f=i.Sprites.color(f),g*=h,{gfx:o,draw(){i.Sprites.gclear(o),i.Sprites.gcircle(o,d,p,g),i.Sprites.gfill(o,{color:f,alpha:m}),i.Sprites.gstroke(o,{width:g/8,color:r}),x.forEach((t=>function(t,e,s,n){let[a,l]=w(t,e,g-4*h,s),[c,d]=w(t,e,g-12*h,s);i.Sprites.gpath(o,[["moveTo",a,l],["lineTo",c,d],["closePath"]]),i.Sprites.gstroke(o,{color:r,width:n,cap:"round"})}(d,p,t,7*h))),function(t,e,s){let[n,a]=w(d,p,t-20*h,s),[l,c]=w(d,p,2*h,s+90*u),[g,m]=w(d,p,2*h,s-90*u);i.Sprites.gpath(o,[["moveTo",l,c],["lineTo",n,a],["lineTo",g,m],["closePath"]]),i.Sprites.gstroke(o,{cap:"round",width:4*h,color:y}),i.Sprites.gcircle(o,d,p,9*h),i.Sprites.gfill(o,{color:r}),i.Sprites.gstroke(o,{color:r})}(g*h,0,u*n.lerp(e,s,t.update()))}}}};return i.Ute2D=p}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Ute2D"]=t=>t.Ute2D?t.Ute2D:i(t)}(this),function(t,e){"use strict";if(!t.AudioContext)throw"Fatal: no audio.";function i(i,s){const{ute:r,is:n}=i,o=(Math.floor,new Map);let a=1;function h(t,n,h){let l=0,c=1;const d={sids:r.jsMap(),buffer:e,loop:!1,src:h,name:n,get pan(){return l},set pan(t){l=t},get vol(){return c},set vol(t){c=t},play(){const e=r.now(),s=this.name;if(i.Sound.sfx()&&!function(t,e,i){let s;return o.has(t)&&o.get(t)>e?s=!0:i?o.set(t,e+i):o.delete(t),s}(s,e)){let e=a++,i=1e3*this.buffer.duration,s=t.ctx.createGain(),n=t.ctx.createStereoPanner(),o=t.ctx.createBufferSource();o.buffer=this.buffer,o.connect(s),s.connect(n),n.connect(t.ctx.destination),this.loop?o.loop=!0:r.delay(i,(()=>this.sids.delete(e))),n.pan.value=l,s.gain.value=c,o.start(0),this.sids.set(e,o)}return this},stop(){return this.sids.forEach((t=>t.stop(0))),this.sids.length=0,this}};return s[n]=d}const l={ctx:new t.AudioContext,_mute:0,init(){r.delay(0,(()=>{"suspended"==this.ctx.state&&this.ctx.resume()}))},sfx(){return 0==this._mute},mute(){return(this._mute=1)&&this},unmute(){return(this._mute=0)||this},decodeData(t,e,i,s,r){let n=h(this,t,e);return this.ctx.decodeAudioData(i,(t=>{s(n.buffer=t)}),(t=>{r&&r(e,t)})),n},decodeUrl(t,e,i,s){let r=new XMLHttpRequest,n=h(this,t,e);return r.open("GET",e,!0),r.responseType="arraybuffer",r.addEventListener("load",(()=>{this.decodeData(e,r.response,i,s)})),r.send(),n}};return i.sound=function(t,n=!0){return s[t||i.assetPath(t)]||(n?r.assert(!1,`Sound: ${t} not loaded.`):e)},i.Sound=l}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Sound"]=function(t){return t.Sound?t.Sound:i(t,{})}}(this),function(t,e){"use strict";function i(i){const s=t["io/czlab/mcfud/geo2d"](),{math:r,v2:n,ute:o,is:a}=i,h=["ctrlKey","altKey","shiftKey"],l=[],c=()=>l[0];function d(t){function r(e,i,s){t===c()&&((i=t.keyInputs.get(e.keyCode))||t.keyInputs.set(e.keyCode,i={}),i.state=s,o.copyKeys(i,e,h),e.preventDefault())}const l=["keyup",globalThis,function(t,e){r(t,e,!1)},!1],d=["keydown",globalThis,function(t,e){r(t,e,!0)},!1];return i.touchDevice||o.addEvent([l,d]),o.inject(t,{yid:`yid#${o.nextId()}`,keyInputs:o.jsMap(),pauseInput:!1,ptr:e,dispose(){this.ptr.dispose(),i.touchDevice||o.delEvent([l,d])},pointer(){return this.ptr||(this.ptr=function(t){let r={Actives:{DragsID:o.jsMap(),Touches:o.jsMap(),reset(){this.DragsID.clear(),this.Touches.clear()}},Hotspots:[],Buttons:[],DragDrops:[],state:[!1,!0],touchZeroID:e,_visible:!0,_x:0,_y:0,width:1,height:1,downTime:0,downAt:[0,0],elapsedTime:0,dragged:e,dragOffsetX:0,dragOffsetY:0,anchor:i.makeAnchor(.5,.5),get cursor(){return i.canvas.style.cursor},set cursor(t){i.canvas.style.cursor=t},get x(){return this._x/i.scale},get y(){return this._y/i.scale},get visible(){return this._visible},get isUp(){return this.state[1]},get isDown(){return this.state[0]},set visible(t){this.cursor=t?"auto":"none",this._visible=t},_testTouchDragStart(t,e){for(let s,r,n=0;n<t.length;++n)if(r=t[n],e.get(r.id)||this.Actives.DragsID.get(r.id))e.set(r.id,1);else for(let t,n=this.DragDrops.length-1;n>=0;--n)if((t=this.DragDrops[n])&&t.m5.drag&&this._test(t,r.x,r.y)){s={dragged:t,id:r.id,dragPtrX:r.x,dragPtrY:r.y,dragStartX:t.x,dragStartY:t.y},this.Actives.DragsID.set(r.id,s),this.touchZeroID==r.id&&this._resetClickTap(),i.moveToTop(t),e.set(r.id,1);break}},_testMouseDragStart(){for(let t,e=this.DragDrops.length-1;e>=0;--e)if((t=this.DragDrops[e])&&t.m5.drag&&this.hitTest(t)){this.dragStartX=t.x,this.dragStartY=t.y,this.dragPtrX=this.x,this.dragPtrY=this.y,this.dragged=t,i.moveToTop(t);break}return this.dragged},_maybeUpdateMouseDrag(){this.state[0]&&this.dragged&&n.set(this.dragged,this.dragStartX+(this.x-this.dragPtrX),this.dragStartY+(this.y-this.dragPtrY))},_maybeEndMouseDrag(t=0){return this.state[1]&&this.dragged&&(this.dragged.m5.onDragDropped?.(),this.dragged=e,t=!0),t},getGlobalPosition(){return{x:this.x,y:this.y}},_press(){if(t!==c())return;let e,i,s,r=this.Buttons.length;for(e=0;e<r;++e)if(i=this.Buttons[e],i.m5.gui&&i.m5.press&&this.hitTest(i)){i.m5.press(i),s=!0;break}if(!s)for(e=0;e<r;++e)if(i=this.Buttons[e],i.m5.press&&this.hitTest(i)){i.m5.press(i);break}},_doMDown(e){if(t!==c())return;let i,s=r;for(let t,r=0;r<s.Hotspots.length;++r)if((t=s.Hotspots[r])&&t.m5.touch&&s.hitTest(t)){t.m5.touch(t,e),i=!0;break}return i},mouseDown(e){if(t!==c())return;let s=r,n=o.now();0==e.button&&(e.preventDefault(),s._x=e.pageX-e.target.offsetLeft,s._y=e.pageY-e.target.offsetTop,o.setVec(s.state,!0,!1),s.downTime=n,s.downAt[0]=s._x,s.downAt[1]=s._y,i.Sound.init(),t.pauseInput||(!s._testMouseDragStart()&&s._doMDown(!0),i.emit([`${t.yid}/mousedown`])))},mouseMove(e){if(t!==c())return;let s=r;s._x=e.pageX-e.target.offsetLeft,s._y=e.pageY-e.target.offsetTop,t.pauseInput||(s._maybeUpdateMouseDrag(),i.emit([`${t.yid}/mousemove`]))},mouseUp(e){if(t!==c())return;let s=r,a=o.now();if(0==e.button&&(e.preventDefault(),s.elapsedTime=Math.max(0,a-s.downTime),s._x=e.pageX-e.target.offsetLeft,s._y=e.pageY-e.target.offsetTop,o.setVec(s.state,!1,!0),!t.pauseInput)){if(s._maybeEndMouseDrag());else if(!s._doMDown(!1)){let e=n.vecAB(s.downAt,s),r=n.len2(e);r<400&&s.elapsedTime<200?(s._press(),i.emit([`${t.yid}/single.tap`])):s._swipeMotion(e,r,s.elapsedTime)}i.emit([`${t.yid}/mouseup`])}},_swipeMotion(e,s,r,o){if(t!==c())return;let a,h=n.unit$(n.normal(e));s>400&&r<1e3&&(Math.abs(h[0])>.8||Math.abs(h[1])>.8)&&(h[0]>.8&&(a="swipe.down"),h[0]<-.8&&(a="swipe.up"),h[1]>.8&&(a="swipe.left"),h[1]<-.8&&(a="swipe.right")),a&&i.emit([`${t.yid}/${a}`],o)},_doMTouch(e,i,s){if(t===c())for(let t,r=0;r<e.length;++r)if(t=e[r],!i.get(t.id))for(let e,r=0;r<this.Hotspots.length;++r)if((e=this.Hotspots[r])&&e.m5.touch&&this._test(e,t.x,t.y)){e.m5.touch(e,s),i.set(t.id,1);break}},touchCancel(e){if(o.log("received touchCancel event!"),t!==c())return;let i,s,n=r,a=e.changedTouches;for(s=0;s<a.length;++s)i=a[s],n.Actives.Touches.delete(i.id),n.Actives.DragsID.delete(i.id);0==n.Actives.Touches.size&&(n.Actives.DragsID.clear(),n._freeTouches())},touchStart(s){if(t!==c())return;let n=s.target,a=[],h=r,l=o.now(),d=o.jsMap(),u=s.targetTouches;s.preventDefault();for(let t,s,r,c,d,p,g=0;g<u.length;++g)p=u[g],d=p.identifier,r=p.pageX-n.offsetLeft,c=p.pageY-n.offsetTop,t={id:d,_x:r,_y:c,downTime:l,downAt:[r,c],x:r/i.scale,y:c/i.scale},s={id:d,_x:r,_y:c,downTime:l,downAt:[r,c],x:t.x,y:t.y},h.Actives.Touches.set(d,s),a.push(t),h.touchZeroID===e&&0==g&&(h.touchZeroID=d,h._x=r,h._y=c,h.downTime=l,h.downAt=[r,c],o.setVec(h.state,!0,!1));i.Sound.init(),t.pauseInput||(h._testTouchDragStart(a,d),h._doMTouch(a,d,!0),i.emit([`${t.yid}/touchstart`],a))},touchMove(e){if(t!==c())return;let s=r,o=[],a=e.target,h=e.changedTouches;e.preventDefault();for(let t,e,r,l,c,d,u,p,g=0;g<h.length;++g)u=h[g],p=u.identifier,(t=s.Actives.Touches.get(p))?(c=u.pageX-a.offsetLeft,d=u.pageY-a.offsetTop,r=c/i.scale,l=d/i.scale,p==s.touchZeroID&&(s._x=c,s._y=d),t.x=r,t.y=l,t._x=c,t._y=d,(t=s.Actives.DragsID.get(p))&&(t.x=r,t.y=l,t._x=c,t._y=d,e=t.dragged,n.set(e,t.dragStartX+(r-t.dragPtrX),t.dragStartY+(l-t.dragPtrY))),o.push({id:p,x:r,y:l,_x:c,_y:d})):i.warn(`move-no activetouch with id=${p}`);!t.pauseInput&&i.emit([`${t.yid}/touchmove`],o)},touchEnd(e){if(t!==c())return;let s,n,a,h,l,d,u=r,p=[],g=o.jsMap(),m=e.changedTouches,f=e.target,y=o.now();for(e.preventDefault(),a=0;a<m.length;++a)l=m[a],d=l.identifier,s=l.pageX-f.offsetLeft,n=l.pageY-f.offsetTop,d==u.touchZeroID&&(u.elapsedTime=Math.max(0,y-u.downTime),o.setVec(u.state,!1,!0),u._x=s,u._y=n),(h=u.Actives.Touches.get(d))?(h.elapsedTime=Math.max(0,y-h.downTime),h.x=s/i.scale,h.y=n/i.scale,h._x=s,h._y=n,p.push(o.clone(h))):i.warn(`end-no activetouch with id=${d}`);for(t.pauseInput||(u._maybeEndTouchDrag(p,g),u._doMTouch(p,g,!1),u._onEndMultiTouches(p,g),i.emit([`${t.yid}/touchend`],p)),a=0;a<m.length;++a)u.Actives.Touches.delete(m[a].identifier);0==u.Actives.Touches.size&&u._freeTouches()},_maybeEndTouchDrag(t,e){let i=this._x,s=this._y;for(let i,s,r,o=0;o<t.length;++o)r=t[o],(s=this.Actives.DragsID.get(r.id))&&(this.Actives.DragsID.delete(r.id),i=s.dragged,e.set(r.id,1),this._x=r._x,this._y=r._y,n.set(i,s.dragStartX+(r.x-s.dragPtrX),s.dragStartY+(r.y-s.dragPtrY)),i.m5.onDragDropped?.());this._x=i,this._y=s},_onEndMultiTouches(e,s){if(t===c())for(let r,o,a,h=0;h<e.length;++h)if(r=e[h],!s.get(r.id))if(o=n.vecAB(r.downAt,r),a=n.len2(o),a<400&&r.elapsedTime<200){for(let t,e=0,i=this.Buttons.length;e<i;++e)if((t=this.Buttons[e])&&t.m5.press&&this._test(t,r.x,r.y)){t.m5.press(t);break}this._x=r.downAt[0],this._y=r.downAt[1],i.emit([`${t.yid}/single.tap`],r)}else this._swipeMotion(o,a,r.elapsedTime,r)},_resetClickTap(){o.setVec(this.state,!1,!0),this.touchZeroID=e},_freeTouches(){this._resetClickTap(),this.Actives.reset()},reset(){this._freeTouches(),this.DragDrops.length=0,this.Buttons.length=0,this.Hotspots.length=0},_test(t,e,r){let o=i.Sprites,a=o.gposXY(t),h=o.toPolygon(t),l=n.translate(a,h.calcPoints);return s.hitTestPointInPolygon(e,r,l)},hitTest(t){return this._test(t,this.x,this.y)},update(t){}};const a=[["mousemove",i.canvas,r.mouseMove],["mousedown",i.canvas,r.mouseDown],["mouseup",globalThis,r.mouseUp]],h=[["touchmove",i.canvas,r.touchMove],["touchstart",i.canvas,r.touchStart],["touchend",globalThis,r.touchEnd],["touchcancel",globalThis,r.touchCancel]];return i.touchDevice?o.addEvent(h):o.addEvent(a),r.dispose=function(){this.reset(),i.touchDevice?o.delEvent(h):o.delEvent(a)},r}(this))},update(t){!this.pauseInput&&this.ptr.update(t)},keybd(e,s,r){const n={press:s,release:r};let h=!0,l=!1,d=this,u=a.vec(e)?e:[e];const p=["keyup",globalThis,function(e){t===c()&&(u.includes(e.keyCode)&&(!d.pauseInput&&l&&n.release?.(e.altKey,e.ctrlKey,e.shiftKey),h=!0,l=!1),e.preventDefault())},!1],g=["keydown",globalThis,function(e){t===c()&&(u.includes(e.keyCode)&&(!d.pauseInput&&h&&n.press?.(e.altKey,e.ctrlKey,e.shiftKey),h=!1,l=!0),e.preventDefault())},!1];return i.touchDevice||o.addEvent([p,g]),n.dispose=()=>{i.touchDevice||o.delEvent([p,g])},n},reset(){this.pauseInput=!1,this.ptr.reset(),this.keyInputs.clear()},resize(){(i.mouse=this.ptr).reset()},dbg(){o.log(`N# of hotspots= ${this.ptr.Hotspots.length}`),o.log(`N# of buttons= ${this.ptr.Buttons.length}`),o.log(`N# of drags= ${this.ptr.DragDrops.length}`),o.log(`Mouse pointer = ${this.ptr}`)}}),t.pointer()&&t}let u=!0;const p={LEFT:37,RIGHT:39,UP:38,DOWN:40,ZERO:48,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,ENTER:13,ESC:27,BACKSPACE:8,TAB:9,SHIFT:16,CTRL:17,ALT:18,SPACE:32,HOME:36,END:35,PGGUP:33,PGDOWN:34,isPaused:()=>c().pauseInput,resume(){c().pauseInput=!1},pause(){c().pauseInput=!0},dbg(){c().dbg()},_cur:()=>c(),setMultiTouch(t){u=t},resize(){c().resize()},reset(){c().reset()},setKeyOn(t){let e=c().keyInputs.get(t);e||c().keyInputs.set(t,e={}),e.state=!0},setKeyOff(t){let e=c().keyInputs.get(t);e||c().keyInputs.set(t,e={}),e.state=!1},keybd:(t,e,i)=>c().keybd(t,e,i),undoButton:t=>(o.disj(c().ptr.Buttons,t),t.m5.button=!1,t),makeButton:(t,e=!1)=>(o.conj(c().ptr.Buttons,t),t.m5.button=!0,t.m5.gui=e,t),undoHotspot:t=>(o.disj(c().ptr.Hotspots,t),t.m5.hotspot=!1,t),makeHotspot:t=>(o.conj(c().ptr.Hotspots,t),t.m5.hotspot=!0,t),undoXXX(t){t&&t.m5&&(t.m5.drag&&this.undoDrag(t),t.m5.button&&this.undoButton(t),t.m5.hotspot&&this.undoHotspot(t))},update(t){c().update(t)},makeDrag:t=>(o.conj(c().ptr.DragDrops,t),t.m5.drag=!0,t),undoDrag:t=>(o.disj(c().ptr.DragDrops,t),t.m5.drag=!1,t),keyUp(t){return!this.keyDown(t)},keyDown(t){let i=c().keyInputs.get(t);return i&&i.state?i:e},pointer:()=>c().pointer(),dispose(){l.forEach((t=>t.dispose())),l.length=0},restore(){l.length>1&&(l.shift().dispose(),c().pauseInput=!1)},save(){l.unshift(d({}))},on:(...t)=>(o.assert(a.vec(t[0])&&a.str(t[0][0]),"bad arg for Input.on()"),t[0][0]=`${c().yid}/${t[0][0]}`,i.on(...t)),off:(...t)=>(o.assert(a.vec(t[0])&&a.str(t[0][0]),"bad arg for Input.off()"),t[0][0]=`${c().yid}/${t[0][0]}`,i.off(...t))};return i.canvas.style.touchAction="none",p.undoBtn=p.undoButton,p.mkBtn=p.makeButton,p.mkDrag=p.makeDrag,l.push(d({})),i.Input=p}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Input"]=function(t){return t.Input?t.Input:i(t)}}(this),function(t,e){"use strict";function i(t){const e=Math.PI/8,i=3*e,s=5*e,r=7*e,{is:n,ute:o}=t,a=Math.sin,h=Math.cos,l=Math.abs,c=180/Math.PI;function d(n){let{Input:d}=t;function u(t){let e=t.target,i=t.changedTouches;i?(t=i[0],n.m5.touchId=i[0].identifier):n.m5.touchId=0,n.m5.startX=t.pageX-e.offsetLeft,n.m5.startY=t.pageY-e.offsetTop,n.m5.drag=!0,n.m5.static||(n.visible=!0,n.x=n.m5.startX,n.y=n.m5.startY),d.isPaused()||n.m5.onStart()}function p(t){n.m5.drag&&(n.m5.hdle.position.set(0,0),n.m5.drag=!1,n.m5.static||(n.visible=!1),d.isPaused()||n.m5.onEnd())}function g(u){if(d.isPaused()||!n.visible||!n.m5.drag)return;let p,g=u.target;if(u.changedTouches){for(let t=0,e=u.changedTouches;t<e.length;++t)if(n.m5.touchId==e[t].identifier){p=[e[t].pageX-g.offsetLeft,e[t].pageY-g.offsetTop];break}}else p=[u.pageX-g.offsetLeft,u.pageY-g.offsetTop];let m,f,y,x=0,w=p?p[0]-n.m5.startX:0,v=p?p[1]-n.m5.startY:0,S=n.m5.range;if(p[0]=0,p[1]=0,!o.feq0(w)||!o.feq0(v)){if(f=l(w),y=l(v),o.feq0(w))p[0]=0,v>0?(p[1]=v>S?S:v,x=270,m=t.DOWN):(p[1]=-(y>S?S:y),x=90,m=t.UP);else if(o.feq0(v))p[1]=0,w>0?(p[0]=f>S?S:f,x=0,m=t.RIGHT):(p[0]=-(f>S?S:f),x=180,m=t.LEFT);else{let n=Math.atan(l(v/w));x=n*c,p[0]=p[1]=0,w*w+v*v>=S*S?(p[0]=S*h(n),p[1]=S*a(n)):(p[0]=f>S?S:f,p[1]=y>S?S:y),v<0&&(p[1]=-l(p[1])),w<0&&(p[0]=-l(p[0])),w>0&&v<0||(w<0&&v<0?x=180-x:w<0&&v>0?x+=180:w>0&&v>0&&(x=360-x)),m=function(n,a){const h=Math.atan2(+a,+n);return h>-s&&h<-i?t.UP:h>i&&h<s?t.DOWN:h>-e&&h<0||h>0&&h<e?t.RIGHT:h>r&&h<Math.PI||h>-Math.PI&&h<-r?t.LEFT:h>e&&h<i?t.SE:h>s&&h<r?t.SW:h>-i&&h<-e?t.NE:h>-r&&h<-s?t.NW:void o.assert(!1,"Failed Joystick calcDir")}(p[0],p[1])}n.m5.hdle.position.set(p[0],p[1]),n.m5.onChange(m,x)}}const m=[["mousemove",t.canvas,g],["mousedown",t.canvas,u],["mouseup",globalThis,p],["touchend",globalThis,p],["touchcancel",globalThis,p],["touchmove",t.canvas,g],["touchstart",t.canvas,u]];return o.addEvent(m),n.m5.dispose=()=>{o.delEvent(m)},n}const u={assets:["boot/joystick.png","boot/joystick-handle.png"],joystick(e){let{Sprites:i}=t,s=i.sprite("boot/joystick-handle.png"),r=i.sprite("boot/joystick.png"),n=i.container(),a=t.getScaleFactor(),h=o.inject({oscale:.7*a,iscale:1*a,hdle:s,schtick:r,onEnd(){},onStart(){},prevDir:0,static:!1,onChange(t,e){}},e);return n.addChild(i.centerAnchor(i.scaleXY(r,h.oscale,h.oscale))),n.addChild(i.centerAnchor(i.scaleXY(s,h.iscale,h.iscale))),h.range=n.width/2.5,h.static||(n.visible=!1),o.inject(n.m5,h),d(n)}};return t.Touch=u}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Touch"]=function(t){return t.Touch?t.Touch:i(t)}}(this),function(t,e){"use strict";function i(t){const e=[t.UP,t.LEFT,t.RIGHT,t.DOWN],{ute:i,is:s,v2:r,math:n}=t,o=Math.abs,a=Math.ceil,h=Math.floor;function l(t,e,s){return r=t,n=e,o=s.tiled.tileW,a=s.tiled.tileH,l=s.tiled.tilesInX,r>=0&&n>=0?h(r/o)+h(n/a)*l:i.assert(!1,`IndexError: ${r},${n}, wanted +ve values`);var r,n,o,a,l}function c(e,i){return r.vecAB(t.Sprites.centerXY(e),t.Sprites.centerXY(i))}function d(t){const e=t.image?.split("/");t.image=e&&e.length&&e[e.length-1]}function u(t,e,s){const r=[];return t.forEach((t=>{r.push([t.firstgid,t]),t.spacing||(t.spacing=0),d(t);const n={};(t.tiles||[]).forEach((e=>{let r=i.selectNotKeys(e,"properties");r=i.inject(r,p(e)),r.gid=t.firstgid+e.id,n[e.id]=r,s[r.gid]=r})),e[t.name]=n})),r.sort(((t,e)=>t[0]>e[0]?1:t[0]<e[0]?-1:0))}function p(t){return(t.properties||[]).reduce(((t,e)=>(t[e.name]=e.value,t)),{})}function g(e,r,o){let a={},l={},c=s.str(r)?function(e){let s=t.resource(e,!0),r=s&&(s.tiledversion||s.version);return r&&i.cmpVerStrs(r,"1.4.2")>=0?s:i.assert(!1,`${e} needs update`)}(r):r;i.assert(s.obj(c),"bad tiled map"),c=JSON.parse(JSON.stringify(c)),i.inject(e.tiled,{tileW:c.tilewidth,tileH:c.tileheight,tilesInX:c.width,tilesInY:c.height,tiledMap:c,saved_tileW:c.tilewidth,saved_tileH:c.tileheight,tiledWidth:c.tilewidth*c.width,tiledHeight:c.tileheight*c.height},p(c));let g=e.getScaleFactor(),f=i.evenN(g*c.tileheight),y=i.evenN(g*c.tilewidth);e.tiled.new_tileW=y,e.tiled.new_tileH=f;const x={imagelayer(t){d(t)},tilelayer(t){s.vec(t.data[0])&&(t.width=t.data[0].length,t.height=t.data.length,t.data=t.data.flat()),t.width||(t.width=e.tiled.tilesInX),t.height||(t.height=e.tiled.tilesInY);let i,r=p(t);if(!1!==t.visible)for(let i,s=0;s<t.data.length;++s){if(0==(i=t.data[s]))continue;!1===t.collision||!1===r.collision||!0!==t.collision&&!0!==r.collision||(i>0&&(e.tiled.collision[s]=i),t.collision=!0);let n=s%t.width,a=h(s/t.width),c=l[i],d=c&&c.Class,u=d&&o[d],p=e.getTSInfo(i),g=m(e,i,n,a,r.width,r.height);g&&(g.tiled.layer=t,g.tiled.index=s,g.m5.static=!0),u&&(g=u.c(e,g,p,c)),g&&(e.insert(g,!!u),c&&c.sensor&&(g.m5.sensor=!0))}else(i=r.Class)&&o[i](e,t)},objectgroup(t){t.sprites=[],t.objects.forEach((r=>{i.assert(s.num(r.x),"wanted xy position");let a,h,c=p(r),d=r.gid??-1;i.inject(r,c),d>0&&(h=l[d]);let u=i.nor(h&&h.Class,r.Class),g=u&&o[u],x=e.tiled.saved_tileW,w=e.tiled.saved_tileH,v=n.ndiv(r.x+x/2,x),S=n.ndiv(r.y-w/2,w),b=e.getTSInfo(d);r.column=v,r.row=S,a=d<=0?{width:y,height:f}:m(e,d,v,S,r.width,r.height,u),g&&(a=g.c(e,a,b,h,r)),a&&(!1===r.visible&&(a.visible=!1),r.uuid=a.m5.uuid,t.sprites.push(a),e.insert(a,!0),h&&h.sensor&&(a.m5.sensor=!0))}))}};o=o??{},i.inject(e.tiled,{objFactory:o,tileSets:a,tileProps:l,collision:i.fill(c.width*c.height,0),imagelayer:[],objectgroup:[],tilelayer:[],tileGidList:u(c.tilesets,a,l)}),["imagelayer","tilelayer","objectgroup"].forEach((t=>{c.layers.filter((e=>e.type==t)).forEach((i=>{x[t](i),e.tiled[t].push(i)}))})),e.tiled.tileW=y,e.tiled.tileH=f,e.tiled.tiledWidth=y*c.width,e.tiled.tiledHeight=f*c.height,e.parent instanceof t.Scenes.SceneWrapper&&(e.tiled.tiledHeight<t.height&&(e.parent.y=n.ndiv(t.height-e.tiled.tiledHeight,2)),e.tiled.tiledWidth<t.width&&(e.parent.x=n.ndiv(t.width-e.tiled.tiledWidth,2)))}function m(e,r,o,a,l,c,d){let u,p=e.getTSInfo(r,!0),g=p.columns,m=r-p.firstgid,f=e.tiled.tileProps[r],y=e.getScaleFactor();u=(d=d??(f&&f.Class))&&e.tiled.objFactory[d],i.assertNot(m<0,`Bad tile id: ${m}`),s.num(g)||(g=n.ndiv(p.imagewidth,p.tilewidth+p.spacing));let x=m%g,w=h(m/g),v=x*p.tilewidth,S=w*p.tileheight;p.spacing>0&&(v+=p.spacing*x,S+=p.spacing*w);let b=u&&u.s(e)||t.Sprites.frame(p.image,l||p.tilewidth,c||p.tileheight,v,S);return b&&(b.tiled={id:m,gid:r},l==e.tiled.saved_tileW?b.width=e.tiled.new_tileW:(b.scale.x=y,b.width=i.evenN(b.width)),c==e.tiled.saved_tileH?b.height=e.tiled.new_tileH:(b.scale.y=y,b.height=i.evenN(b.height)),b.x=o*e.tiled.new_tileW,b.y=a*e.tiled.new_tileH),b}const f=t.Sprites.lift({width:0,height:0,parent:null,x:0,y:0,rotation:0,tiled:{},anchor:{x:0,y:0},getGlobalPosition(){return{x:this.x+this.parent.x,y:this.y+this.parent.y}}});class y extends t.Scenes.Scene{constructor(t,e,i){super(t,e,i),this.tiled={}}reloadMap(t){this.tiled={},this.m5.options.tiled=t,g(this,t.name,t.factory)}runOnce(){const t=this.m5.options.tiled;this.preTMX?.(t),g(this,t.name,t.factory),this.postTMX?.(t),super.runOnce()}removeTile(e,i){let{x:s,y:r}=i;i.anchor.x<.3&&(r=i.y+h(i.height/2),s=i.x+h(i.width/2));let n=h(s/this.tiled.tileW),o=h(r/this.tiled.tileH),a=this.getTileLayer(e),l=n+o*this.tiled.tilesInX;a.data[l]=0,a.collision&&(this.tiled.collision[l]=0),t.Sprites.remove(i)}getTileLayer(t,e){const s=i.some(this.tiled.tilelayer,(e=>{if(e.name==t)return e}));if(!s&&e)throw`There is no layer with name: ${t}`;return s}getObjectGroup(t,e){const s=i.some(this.tiled.objectgroup,(e=>{if(e.name==t)return e}));if(!s&&e)throw`There is no group with name: ${t}`;return s}setTile(t,e,i,s){let r,n=this.getTSInfo(s,!0),o=(n.firstgid,this.getTileLayer(t)),a=i+this.tiled.tilesInX*e;return o.collision&&(this.tiled.collision[a]=s),r=m(this,s,i,e,n.tilewidth,n.tileheight),r&&(r.tiled.index=a,r.tiled.layer=o),r}getTile(t){let{x:e,y:i}=t;return t.anchor.x<.3&&(i+=h(t.height/2),e+=h(t.width/2)),this.getTileXY(e,i)}getTileXY(t,e){let s=h(t/this.tiled.tileW),r=h(e/this.tiled.tileH);return i.assert(s>=0&&s<this.tiled.tilesInX,`bad tile col:${s}`),i.assert(r>=0&&r<this.tiled.tilesInY,`bad tile row:${r}`),[s,r]}getNamedItem(t){const e=[];return this.tiled.objectgroup.forEach((s=>{s.objects.forEach((s=>{t==i.get(s,"name")&&e.push(s)}))})),e}getScaleFactor(){let e=t.height/(this.tiled.saved_tileH*this.tiled.tilesInY),i=t.width/(this.tiled.saved_tileW*this.tiled.tilesInX),s=1;return"max"==t.u.scaleToWindow&&(s=i<e?i:e),s}getTileIndex(e){let[i,s]=t.Sprites.centerXY(e);return l(i,s,this)}getTSInfo(t,e){const s=function(t,e){let i=-1;if(t>0)for(i=0;e[i+1]&&t>=e[i+1][0];)++i;return i>=0?e[i]:[]}(t,this.tiled.tileGidList)[1];return!s&&e?i.assert(!1,`Bad GID ${t}, no tileset`):s}getTileProps(t){return this.tiled.tileProps[t]}_getContactObj(t,e,i){let s=f;return s.height=this.tiled.tileH,s.width=this.tiled.tileW,s.x=e*s.width,s.y=i*s.height,s.tiled.gid=t,s.tiled.row=i,s.tiled.col=e,s.m5.sensor=!1,s}collideXY(e){let r=t.Sprites,n=this.tiled.tileW,o=this.tiled.tileH,l=this.tiled.collision,c=i.feq0(e.angle)?r.getAABB(e):r.boundingBox(e),d=Math.max(0,h(c.x1/n)),u=Math.max(0,h(c.y1/o)),p=Math.min(this.tiled.tilesInX-1,a(c.x2/n)),g=Math.min(this.tiled.tilesInY-1,a(c.y2/o));for(let n,o,a,h,c=u;c<=g;++c)for(let u=d;u<=p;++u)a=c*this.tiled.tilesInX+u,o=l[a],i.assert(s.num(o),"bad gid"),0!=o&&(h=this._getContactObj(o,u,c),n=this.getTileProps(o),n&&(h.m5.sensor=!!n.sensor),h.parent=this,r.hit(e,h)&&h.m5.sensor&&t.emit(["bump.sensor",e],h));return super.collideXY(e)}}class x{constructor(t,e){this.straightCost=t,this.diagonalCost=e}manhattan(t,e){return o(t.row-e.row)*this.straightCost+o(t.col-e.col)*this.straightCost}euclidean(t,e){let s=e.col-t.col,r=e.row-t.row;return h(i.sqrt(s*s+r*r)*this.straightCost)}diagonal(t,e){let i=o(e.col-t.col),s=o(e.row-t.row);return h(i>s?this.diagonalCost*s+this.straightCost*(i-s):this.diagonalCost*i+this.straightCost*(s-i))}}const w={TiledScene:y,neighborCells(t,e,i){let s=e.tiled.tilesInX,r=[t-s-1,t-s,t-s+1,t-1],n=[t+1,t+s-1,t+s,t+s+1];return i||r.push(t),r.concat(n)},updateMap(t,e,r){let n=i.fill(t.length,0),o=t=>{let e=this.getTileIndex(t,r);i.assert(e>=0&&e<n.length,"tiled index outofbound"),t.tiled.index=e,n[e]=t.tiled.gid};return s.vec(e)?e.forEach(o):o(e),n},shortestPath(t,e,i,s,r=[],n="manhattan",o=!0){let a=s.tiled.tilesInX,l=i.map(((t,e)=>({f:0,g:0,h:0,parent:null,index:e,col:e%a,row:h(e/a)}))),c=l[e],d=l[t],u=d,p=[u],g=[],m=[],f=t=>(o?this.neighborCells(t,s,!0):this.crossCells(t,s)).map((t=>l[t])).filter((e=>{if(e){let s=t%a==0,n=(t+1)%a==0,o=e.col%(a-1)==0&&0!=e.col,h=e.col%a==0,l=r.some((t=>i[e.index]==t));return s?!o:n?!h:!l}}));for(;u!==c;){let t=f(u.index);for(let e,i,s,r,o,a=0;a<t.length;++a){o=t[a],r=14,u.row!=o.row&&u.col!=o.col||(r=10),i=u.g+r,e=i+new x(10,14)[n](o,c);let h=p.some((t=>o===t)),l=g.some((t=>o===t));h||l?o.f>e&&(o.f=e,o.g=i,o.h=s,o.parent=u):(o.f=e,o.g=i,o.h=s,o.parent=u,p.push(o))}if(g.push(u),0==p.length)return m;p=p.sort(((t,e)=>t.f-e.f)),u=p.shift()}if(0!=p.length){let t=c;for(m.push(t);t!==d;)t=t.parent,m.unshift(t)}return m},lineOfSight(e,i,s,n,o=0,a=32,d=[]){let u,p,g,m,f,y,x=c(e,i),w=r.len(x),v=h(w/a),S=[];for(let i,s=1;s<=v;++s)i=t.Sprites.centerXY(e),p=a*s,f=x[0]/w,y=x[1]/w,g=h(i[0]+f*p),m=h(i[1]+y*p),S.push({x:g,y:m,index:l(g,m,n)});return u=180*Math.atan2(x[1],x[0])/Math.PI,S.every((t=>s[t.index]==o))&&(0==d.length||d.some((t=>t==u)))},crossCells(t,e){const i=e.tiled.tilesInX;return[t-i,t-1,t+1,t+i]},getCrossTiles(t,e,i){return this.crossCells(t,i).map((t=>e[t]))},getDiagonalCells(t,e){const i=s.num(e)?e:e.tiled.tilesInX;return[t-i-1,t-i+1,t+i-1,t+i+1]},getDiagonalTiles(t,e,i){return this.getDiagonalCells(t,i).map((t=>e[t]))},validDirections(i,s,r,n){const o=this.getTileIndex(i,n);return this.getCrossTiles(o,s,n).map(((i,s)=>i==r?e[s]:t.NONE)).filter((e=>e!==t.NONE))},canChangeDirection(e=[]){let i=e.find((e=>e===t.UP)),s=e.find((e=>e===t.DOWN)),r=e.find((e=>e===t.LEFT)),n=e.find((e=>e===t.RIGHT));return 0==e.length||1==e.length||(i||s)&&(r||n)},randomDirection:(e=[])=>0==e.length?t.NONE:1==e.length?e[0]:e[i.randInt2(0,e.length-1)],closestDirection(e,i){const s=c(e,i);return o(s[0])<o(s[1])?s[1]<=0?t.UP:t.DOWN:s[0]<=0?t.LEFT:t.RIGHT}};return t.Tiles=w}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Tiles"]=function(t){return t.Tiles?t.Tiles:i(t)}}(this);